# Comparing `tmp/ieegprep-1.1.0.tar.gz` & `tmp/ieegprep-1.2.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "ieegprep-1.1.0.tar", last modified: Tue Apr 11 16:44:56 2023, max compression
+gzip compressed data, was "ieegprep-1.2.0.tar", last modified: Wed Apr 19 19:31:26 2023, max compression
```

## Comparing `ieegprep-1.1.0.tar` & `ieegprep-1.2.0.tar`

### file list

```diff
@@ -1,36 +1,36 @@
-drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-11 16:44:56.245226 ieegprep-1.1.0/
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    35149 2023-02-15 23:27:00.000000 ieegprep-1.1.0/LICENSE
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     5833 2023-04-11 16:44:56.245379 ieegprep-1.1.0/PKG-INFO
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     4639 2023-04-11 00:26:26.000000 ieegprep-1.1.0/README.md
-drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-11 16:44:56.221546 ieegprep-1.1.0/ieegprep/
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      573 2023-04-11 16:15:59.000000 ieegprep-1.1.0/ieegprep/__init__.py
-drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-11 16:44:56.231248 ieegprep-1.1.0/ieegprep/bids/
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      266 2023-04-06 20:04:42.000000 ieegprep-1.1.0/ieegprep/bids/__init__.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)   108220 2023-04-11 16:44:10.000000 ieegprep-1.1.0/ieegprep/bids/data_epoch.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    19133 2023-04-07 21:42:05.000000 ieegprep-1.1.0/ieegprep/bids/data_structure.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     9997 2023-02-15 23:39:13.000000 ieegprep-1.1.0/ieegprep/bids/rereferencing.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     4809 2023-02-15 23:38:50.000000 ieegprep-1.1.0/ieegprep/bids/sidecars.py
-drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-11 16:44:56.237280 ieegprep-1.1.0/ieegprep/fileio/
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    55051 2023-02-15 23:26:11.000000 ieegprep-1.1.0/ieegprep/fileio/BrainVisionReader.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    46835 2023-02-15 23:26:19.000000 ieegprep-1.1.0/ieegprep/fileio/EdfReader.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    12613 2023-02-15 23:26:38.000000 ieegprep-1.1.0/ieegprep/fileio/IeegDataReader.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     9918 2023-02-15 23:26:28.000000 ieegprep-1.1.0/ieegprep/fileio/Mef3Reader.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      116 2023-02-15 23:37:39.000000 ieegprep-1.1.0/ieegprep/fileio/__init__.py
-drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-11 16:44:56.239364 ieegprep-1.1.0/ieegprep/utils/
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     6124 2023-04-07 20:46:59.000000 ieegprep-1.1.0/ieegprep/utils/console.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     7710 2023-04-06 22:10:19.000000 ieegprep-1.1.0/ieegprep/utils/misc.py
--rwxrwxrwx   0 m218483  (1058270505) MFAD\Domain Users (1387956079)       22 2023-04-11 16:12:38.000000 ieegprep-1.1.0/ieegprep/version.py
-drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-11 16:44:56.226312 ieegprep-1.1.0/ieegprep.egg-info/
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     5833 2023-04-11 16:44:56.000000 ieegprep-1.1.0/ieegprep.egg-info/PKG-INFO
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      750 2023-04-11 16:44:56.000000 ieegprep-1.1.0/ieegprep.egg-info/SOURCES.txt
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        1 2023-04-11 16:44:56.000000 ieegprep-1.1.0/ieegprep.egg-info/dependency_links.txt
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)       68 2023-04-11 16:44:56.000000 ieegprep-1.1.0/ieegprep.egg-info/requires.txt
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        9 2023-04-11 16:44:56.000000 ieegprep-1.1.0/ieegprep.egg-info/top_level.txt
--rwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     1470 2023-04-10 20:34:54.000000 ieegprep-1.1.0/pyproject.toml
--rwxrwxrwx   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      177 2023-04-11 16:44:56.248271 ieegprep-1.1.0/setup.cfg
-drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-11 16:44:56.244599 ieegprep-1.1.0/tests/
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     1729 2023-04-10 22:59:47.000000 ieegprep-1.1.0/tests/test_epoch_by_channels_bv_perf.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    15723 2023-02-15 23:32:38.000000 ieegprep-1.1.0/tests/test_fileio_bv_data.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    11480 2023-02-15 23:32:41.000000 ieegprep-1.1.0/tests/test_fileio_bv_perf.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    14659 2023-02-15 23:32:56.000000 ieegprep-1.1.0/tests/test_fileio_edf_data.py
--rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    10758 2023-02-15 23:32:59.000000 ieegprep-1.1.0/tests/test_fileio_edf_perf.py
+drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-19 19:31:26.334349 ieegprep-1.2.0/
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    35149 2023-02-15 23:27:00.000000 ieegprep-1.2.0/LICENSE
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     5833 2023-04-19 19:31:26.334517 ieegprep-1.2.0/PKG-INFO
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     4639 2023-04-13 20:52:25.000000 ieegprep-1.2.0/README.md
+drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-19 19:31:26.307718 ieegprep-1.2.0/ieegprep/
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      573 2023-04-11 16:15:59.000000 ieegprep-1.2.0/ieegprep/__init__.py
+drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-19 19:31:26.318194 ieegprep-1.2.0/ieegprep/bids/
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      266 2023-04-06 20:04:42.000000 ieegprep-1.2.0/ieegprep/bids/__init__.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)   116163 2023-04-14 16:27:54.000000 ieegprep-1.2.0/ieegprep/bids/data_epoch.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    19133 2023-04-07 21:42:05.000000 ieegprep-1.2.0/ieegprep/bids/data_structure.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     9997 2023-02-15 23:39:13.000000 ieegprep-1.2.0/ieegprep/bids/rereferencing.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     4809 2023-02-15 23:38:50.000000 ieegprep-1.2.0/ieegprep/bids/sidecars.py
+drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-19 19:31:26.324376 ieegprep-1.2.0/ieegprep/fileio/
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    56517 2023-04-18 23:38:05.000000 ieegprep-1.2.0/ieegprep/fileio/BrainVisionReader.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    48803 2023-04-18 23:43:55.000000 ieegprep-1.2.0/ieegprep/fileio/EdfReader.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    12618 2023-04-13 20:51:23.000000 ieegprep-1.2.0/ieegprep/fileio/IeegDataReader.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     9858 2023-04-14 16:13:31.000000 ieegprep-1.2.0/ieegprep/fileio/Mef3Reader.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      116 2023-02-15 23:37:39.000000 ieegprep-1.2.0/ieegprep/fileio/__init__.py
+drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-19 19:31:26.327111 ieegprep-1.2.0/ieegprep/utils/
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     6124 2023-04-07 20:46:59.000000 ieegprep-1.2.0/ieegprep/utils/console.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     7710 2023-04-06 22:10:19.000000 ieegprep-1.2.0/ieegprep/utils/misc.py
+-rwxrwxrwx   0 m218483  (1058270505) MFAD\Domain Users (1387956079)       22 2023-04-19 19:23:57.000000 ieegprep-1.2.0/ieegprep/version.py
+drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-19 19:31:26.312408 ieegprep-1.2.0/ieegprep.egg-info/
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     5833 2023-04-19 19:31:26.000000 ieegprep-1.2.0/ieegprep.egg-info/PKG-INFO
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      750 2023-04-19 19:31:26.000000 ieegprep-1.2.0/ieegprep.egg-info/SOURCES.txt
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        1 2023-04-19 19:31:26.000000 ieegprep-1.2.0/ieegprep.egg-info/dependency_links.txt
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)       68 2023-04-19 19:31:26.000000 ieegprep-1.2.0/ieegprep.egg-info/requires.txt
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        9 2023-04-19 19:31:26.000000 ieegprep-1.2.0/ieegprep.egg-info/top_level.txt
+-rwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     1470 2023-04-10 20:34:54.000000 ieegprep-1.2.0/pyproject.toml
+-rwxrwxrwx   0 m218483  (1058270505) MFAD\Domain Users (1387956079)      177 2023-04-19 19:31:26.338072 ieegprep-1.2.0/setup.cfg
+drwxr-xr-x   0 m218483  (1058270505) MFAD\Domain Users (1387956079)        0 2023-04-19 19:31:26.333626 ieegprep-1.2.0/tests/
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)     1729 2023-04-10 22:59:47.000000 ieegprep-1.2.0/tests/test_epoch_by_channels_bv_perf.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    15733 2023-04-19 19:23:28.000000 ieegprep-1.2.0/tests/test_fileio_bv_data.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    11490 2023-04-19 19:23:30.000000 ieegprep-1.2.0/tests/test_fileio_bv_perf.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    14669 2023-04-19 19:23:32.000000 ieegprep-1.2.0/tests/test_fileio_edf_data.py
+-rw-r--r--   0 m218483  (1058270505) MFAD\Domain Users (1387956079)    10768 2023-04-19 19:23:35.000000 ieegprep-1.2.0/tests/test_fileio_edf_perf.py
```

### Comparing `ieegprep-1.1.0/LICENSE` & `ieegprep-1.2.0/LICENSE`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/PKG-INFO` & `ieegprep-1.2.0/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ieegprep
-Version: 1.1.0
+Version: 1.2.0
 Summary: A package to read and pre-process Intracranial Electroencephalography (iEEG) data that is structured according to the Brain Imaging Data Structure (BIDS)
 Author-email: Max van den Boom <m.a.vandenboom84@gmail.com>
 License: GPLv3
 Project-URL: homepage, https://github.com/MultimodalNeuroimagingLab/ieegprep
 Project-URL: documentation, https://github.com/MultimodalNeuroimagingLab/ieegprep
 Project-URL: repository, https://github.com/MultimodalNeuroimagingLab/ieegprep
 Keywords: intracranial,electroencephalography,ieeg,BIDS
```

### Comparing `ieegprep-1.1.0/README.md` & `ieegprep-1.2.0/README.md`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/ieegprep/__init__.py` & `ieegprep-1.2.0/ieegprep/__init__.py`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/ieegprep/bids/data_epoch.py` & `ieegprep-1.2.0/ieegprep/bids/data_epoch.py`

 * *Files 3% similar despite different names*

```diff
@@ -839,5926 +839,6423 @@
 00003460: 6720 2873 7472 293a 2020 2020 2020 2020  g (str):        
 00003470: 2020 436f 6e66 6967 7572 6520 7468 6520    Configure the 
 00003480: 6861 6e64 6c69 6e67 206f 6620 6f75 742d  handling of out-
 00003490: 6f66 2d62 6f75 6e64 2074 7269 616c 2065  of-bound trial e
 000034a0: 706f 6368 733b 0a20 2020 2020 2020 2020  pochs;.         
 000034b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000034c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000034d0: 2020 2020 2020 2027 6572 726f 7227 3a20         'error': 
-000034e0: 2864 6566 6175 6c74 2920 5468 726f 7720  (default) Throw 
-000034f0: 616e 2065 7272 6f72 2061 6e64 2072 6574  an error and ret
-00003500: 7572 6e20 7768 656e 2061 6e79 2065 706f  urn when any epo
-00003510: 6368 2069 7320 6f75 7420 6f66 2062 6f75  ch is out of bou
-00003520: 6e64 3b0a 2020 2020 2020 2020 2020 2020  nd;.            
+000034d0: 2020 2020 2020 2020 2765 7272 6f72 273a          'error':
+000034e0: 2028 6465 6661 756c 7429 2054 6872 6f77   (default) Throw
+000034f0: 2061 6e20 6572 726f 7220 616e 6420 7265   an error and re
+00003500: 7475 726e 2077 6865 6e20 616e 7920 6570  turn when any ep
+00003510: 6f63 6820 6973 206f 7574 206f 6620 626f  och is out of bo
+00003520: 756e 643b 0a20 2020 2020 2020 2020 2020  und;.           
 00003530: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003550: 2020 2020 2766 6972 7374 5f6c 6173 745f      'first_last_
-00003560: 6f6e 6c79 273a 2041 6c6c 6f77 7320 6f6e  only': Allows on
-00003570: 6c79 2074 6865 2066 6972 7374 2074 7269  ly the first tri
-00003580: 616c 2065 706f 6368 2074 6f20 7374 6172  al epoch to star
-00003590: 7420 6265 666f 7265 2074 6865 0a20 2020  t before the.   
+00003550: 2020 2020 2020 2766 6972 7374 5f6c 6173        'first_las
+00003560: 745f 6f6e 6c79 273a 2041 6c6c 6f77 7320  t_only': Allows 
+00003570: 6f6e 6c79 2074 6865 2066 6972 7374 2074  only the first t
+00003580: 7269 616c 2065 706f 6368 2074 6f20 7374  rial epoch to st
+00003590: 6172 7420 6265 666f 7265 2074 6865 0a20  art before the. 
 000035a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000035b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000035c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000035d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000035e0: 6461 7461 2d73 6574 2061 6e64 2074 6865  data-set and the
-000035f0: 206c 6173 7420 7472 6961 6c20 6570 6f63   last trial epoc
-00003600: 6820 746f 2065 6e64 2062 6579 6f6e 6420  h to end beyond 
-00003610: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+000035e0: 2020 2064 6174 612d 7365 7420 616e 6420     data-set and 
+000035f0: 7468 6520 6c61 7374 2074 7269 616c 2065  the last trial e
+00003600: 706f 6368 2074 6f20 656e 6420 6265 796f  poch to end beyo
+00003610: 6e64 2074 6865 0a20 2020 2020 2020 2020  nd the.         
 00003620: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003630: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003650: 2020 2020 2020 206c 656e 6774 6820 6f66         length of
-00003660: 2074 6865 2064 6174 612d 7365 742c 2074   the data-set, t
-00003670: 6865 2074 7269 616c 2065 706f 6368 7320  he trial epochs 
-00003680: 7769 6c6c 2062 6520 7061 6464 6564 0a20  will be padded. 
-00003690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003650: 2020 2020 2020 2020 2020 206c 656e 6774             lengt
+00003660: 6820 6f66 2074 6865 2064 6174 612d 7365  h of the data-se
+00003670: 742c 2074 6865 2074 7269 616c 2065 706f  t, the trial epo
+00003680: 6368 7320 7769 6c6c 2062 6520 7061 6464  chs will be padd
+00003690: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
 000036a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000036b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000036c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000036d0: 2020 7769 7468 204e 614e 2076 616c 7565    with NaN value
-000036e0: 732e 204e 6f74 6520 7468 6174 2074 6865  s. Note that the
-000036f0: 2066 6972 7374 2061 6e64 206c 6173 7420   first and last 
-00003700: 7472 6961 6c20 6172 650a 2020 2020 2020  trial are.      
+000036d0: 2020 2020 2020 2077 6974 6820 4e61 4e20         with NaN 
+000036e0: 7661 6c75 6573 2e20 4e6f 7465 2074 6861  values. Note tha
+000036f0: 7420 7468 6520 6669 7273 7420 616e 6420  t the first and 
+00003700: 6c61 7374 2074 7269 616c 2061 7265 0a20  last trial are. 
 00003710: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003720: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003740: 2020 2020 2020 2020 2020 2020 2064 6574               det
-00003750: 6572 6d69 6e65 6420 6279 2074 6865 2066  ermined by the f
-00003760: 6972 7374 2061 6e64 206c 6173 7420 656e  irst and last en
-00003770: 7472 7920 696e 2074 6865 2027 6f6e 7365  try in the 'onse
-00003780: 7473 270a 2020 2020 2020 2020 2020 2020  ts'.            
+00003740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003750: 2020 2064 6574 6572 6d69 6e65 6420 6279     determined by
+00003760: 2074 6865 2066 6972 7374 2061 6e64 206c   the first and l
+00003770: 6173 7420 656e 7472 7920 696e 2074 6865  ast entry in the
+00003780: 2027 6f6e 7365 7473 270a 2020 2020 2020   'onsets'.      
 00003790: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000037a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000037b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000037c0: 2020 2020 2020 2070 6172 616d 6574 6572         parameter
-000037d0: 2c20 7768 6963 6820 6973 206e 6f74 2073  , which is not s
-000037e0: 6f72 7465 6420 6279 2074 6869 7320 6675  orted by this fu
-000037f0: 6e63 7469 6f6e 3b0a 2020 2020 2020 2020  nction;.        
+000037c0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000037d0: 7261 6d65 7465 722c 2077 6869 6368 2069  rameter, which i
+000037e0: 7320 6e6f 7420 736f 7274 6564 2062 7920  s not sorted by 
+000037f0: 7468 6973 2066 756e 6374 696f 6e3b 0a20  this function;. 
 00003800: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003820: 2020 2020 2020 2020 2761 6c6c 6f77 273a          'allow':
-00003830: 2020 2020 2020 2020 2020 2041 6c6c 6f77             Allow
-00003840: 2074 7269 616c 2065 706f 6368 7320 746f   trial epochs to
-00003850: 2062 6520 6f75 742d 6f66 2d62 6f75 6e64   be out-of-bound
-00003860: 2c20 4e61 4e73 2076 616c 7565 7320 7769  , NaNs values wi
-00003870: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
+00003820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003830: 2761 6c6c 6f77 273a 2020 2020 2020 2020  'allow':        
+00003840: 2020 2041 6c6c 6f77 2074 7269 616c 2065     Allow trial e
+00003850: 706f 6368 7320 746f 2062 6520 6f75 742d  pochs to be out-
+00003860: 6f66 2d62 6f75 6e64 2c20 4e61 4e73 2076  of-bound, NaNs v
+00003870: 616c 7565 7320 7769 6c6c 0a20 2020 2020  alues will.     
 00003880: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003890: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000038a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038b0: 2020 2020 2020 6265 2075 7365 6420 666f        be used fo
-000038c0: 7220 7061 7274 206f 662c 206f 7220 7468  r part of, or th
-000038d0: 6520 656e 7469 7265 2c20 7468 6520 7472  e entire, the tr
-000038e0: 6961 6c20 6570 6f63 680a 2020 2020 2020  ial epoch.      
-000038f0: 2020 6d65 7472 6963 5f63 616c 6c62 6163    metric_callbac
-00003900: 6b73 2028 6675 6e63 206f 7220 7475 706c  ks (func or tupl
-00003910: 6529 3a20 2020 2020 4675 6e63 7469 6f6e  e):     Function
-00003920: 206f 7220 7475 706c 6520 6f66 2066 756e   or tuple of fun
-00003930: 6374 696f 6e73 2074 6861 7420 6172 6520  ctions that are 
-00003940: 6361 6c6c 6564 2074 6f20 6361 6c63 756c  called to calcul
-00003950: 6174 6520 6d65 7472 6963 7320 6261 7365  ate metrics base
-00003960: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000038b0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+000038c0: 6520 7573 6564 2066 6f72 2070 6172 7420  e used for part 
+000038d0: 6f66 2c20 6f72 2074 6865 2065 6e74 6972  of, or the entir
+000038e0: 652c 2074 6865 2074 7269 616c 2065 706f  e, the trial epo
+000038f0: 6368 0a20 2020 2020 2020 206d 6574 7269  ch.        metri
+00003900: 635f 6361 6c6c 6261 636b 7320 2866 756e  c_callbacks (fun
+00003910: 6320 6f72 2074 7570 6c65 293a 2020 2020  c or tuple):    
+00003920: 2046 756e 6374 696f 6e20 6f72 2074 7570   Function or tup
+00003930: 6c65 206f 6620 6675 6e63 7469 6f6e 7320  le of functions 
+00003940: 7468 6174 2061 7265 2063 616c 6c65 6420  that are called 
+00003950: 746f 2063 616c 6375 6c61 7465 206d 6574  to calculate met
+00003960: 7269 6373 2062 6173 6564 0a20 2020 2020  rics based.     
 00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003990: 6f6e 2073 7562 7365 7473 206f 6620 7468  on subsets of th
-000039a0: 6520 756e 2d61 7665 7261 6765 6420 6461  e un-averaged da
-000039b0: 7461 2e20 5468 6520 6675 6e63 7469 6f6e  ta. The function
-000039c0: 2873 2920 6172 6520 6361 6c6c 6564 2070  (s) are called p
-000039d0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+00003990: 2020 2020 2020 2020 206f 6e20 7375 6273           on subs
+000039a0: 6574 7320 6f66 2074 6865 2075 6e2d 6176  ets of the un-av
+000039b0: 6572 6167 6564 2064 6174 612e 2054 6865  eraged data. The
+000039c0: 2066 756e 6374 696f 6e28 7329 2061 7265   function(s) are
+000039d0: 2063 616c 6c65 6420 7065 720a 2020 2020   called per.    
 000039e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000039f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a00: 2077 6974 6820 7468 6520 666f 6c6c 6f77   with the follow
-00003a10: 696e 6720 696e 7075 7420 6172 6775 6d65  ing input argume
-00003a20: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00003a00: 2020 2020 2020 2020 2020 7769 7468 2074            with t
+00003a10: 6865 2066 6f6c 6c6f 7769 6e67 2069 6e70  he following inp
+00003a20: 7574 2061 7267 756d 656e 7473 3a0a 2020  ut arguments:.  
 00003a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a50: 2020 2020 2073 616d 706c 696e 675f 7261       sampling_ra
-00003a60: 7465 202d 2020 2020 5468 6520 7361 6d70  te -    The samp
-00003a70: 6c69 6e67 2072 6174 6520 6f66 2074 6865  ling rate of the
-00003a80: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+00003a50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003a60: 616d 706c 696e 675f 7261 7465 202d 2020  ampling_rate -  
+00003a70: 2020 5468 6520 7361 6d70 6c69 6e67 2072    The sampling r
+00003a80: 6174 6520 6f66 2074 6865 2064 6174 610a  ate of the data.
 00003a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ab0: 2020 2020 2020 6461 7461 202d 2020 2020        data -    
-00003ac0: 2020 2020 2020 2020 2041 2073 7562 7365           A subse
-00003ad0: 7420 6f66 2074 6865 2064 6174 6120 696e  t of the data in
-00003ae0: 2061 2032 6420 6172 7261 793a 2074 7269   a 2d array: tri
-00003af0: 616c 7320 7820 7361 6d70 6c65 730a 2020  als x samples.  
-00003b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ac0: 2064 6174 6120 2d20 2020 2020 2020 2020   data -         
+00003ad0: 2020 2020 4120 7375 6273 6574 206f 6620      A subset of 
+00003ae0: 7468 6520 6461 7461 2069 6e20 6120 3264  the data in a 2d
+00003af0: 2061 7272 6179 3a20 7472 6961 6c73 2078   array: trials x
+00003b00: 2073 616d 706c 6573 0a20 2020 2020 2020   samples.       
 00003b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b20: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-00003b30: 7365 6c69 6e65 202d 2020 2020 2020 2020  seline -        
-00003b40: 2054 6865 2063 6f72 7265 7370 6f6e 6469   The correspondi
-00003b50: 6e67 2062 6173 656c 696e 6520 7661 6c75  ng baseline valu
-00003b60: 6573 2066 6f72 2074 6865 2074 7269 616c  es for the trial
-00003b70: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00003b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b30: 2020 2020 2020 2020 2020 6261 7365 6c69            baseli
+00003b40: 6e65 202d 2020 2020 2020 2020 2054 6865  ne -         The
+00003b50: 2063 6f72 7265 7370 6f6e 6469 6e67 2062   corresponding b
+00003b60: 6173 656c 696e 6520 7661 6c75 6573 2066  aseline values f
+00003b70: 6f72 2074 6865 2074 7269 616c 730a 2020  or the trials.  
 00003b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ba0: 4966 2063 616c 6c62 6163 6b73 2061 7265  If callbacks are
-00003bb0: 2064 6566 696e 6564 2c20 6120 7468 6972   defined, a thir
-00003bc0: 6420 7661 7269 6162 6c65 2069 7320 7265  d variable is re
-00003bd0: 7475 726e 6564 2074 6861 7420 686f 6c64  turned that hold
-00003be0: 7320 7468 650a 2020 2020 2020 2020 2020  s the.          
-00003bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ba0: 2020 2020 2020 2020 2020 2020 4966 2063              If c
+00003bb0: 616c 6c62 6163 6b73 2061 7265 2064 6566  allbacks are def
+00003bc0: 696e 6564 2c20 6120 7468 6972 6420 7661  ined, a third va
+00003bd0: 7269 6162 6c65 2069 7320 7265 7475 726e  riable is return
+00003be0: 6564 2074 6861 7420 686f 6c64 7320 7468  ed that holds th
+00003bf0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
 00003c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c10: 2020 2020 7265 7475 726e 2076 616c 7565      return value
-00003c20: 7320 6f66 2074 6865 206d 6574 7269 6320  s of the metric 
-00003c30: 6361 6c6c 6261 636b 7320 696e 2074 6865  callbacks in the
-00003c40: 2066 6f72 6d61 743a 2063 6861 6e6e 656c   format: channel
-00003c50: 2078 2063 6f6e 6469 7469 6f6e 2078 206d   x condition x m
-00003c60: 6574 7269 630a 2020 2020 2020 2020 6869  etric.        hi
-00003c70: 6768 5f70 6173 7320 2862 6f6f 6c29 3a20  gh_pass (bool): 
-00003c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003c90: 2020 2020 5072 6570 726f 6365 7373 2077      Preprocess w
-00003ca0: 6974 6820 6869 6768 2d70 6173 7320 6669  ith high-pass fi
-00003cb0: 6c74 6572 696e 6720 2874 7275 6529 206f  ltering (true) o
-00003cc0: 7220 7769 7468 6f75 7420 6669 6c74 6572  r without filter
-00003cd0: 696e 6720 2866 616c 7365 290a 2020 2020  ing (false).    
-00003ce0: 2020 2020 6561 726c 795f 7265 7265 6620      early_reref 
-00003cf0: 284e 6f6e 6520 6f72 2052 6572 6566 5374  (None or RerefSt
-00003d00: 7275 6374 293a 2020 2020 5072 6570 726f  ruct):    Prepro
-00003d10: 6365 7373 2077 6974 6820 6561 726c 7920  cess with early 
-00003d20: 2862 6566 6f72 6520 6c69 6e65 2d6e 6f69  (before line-noi
-00003d30: 7365 2072 656d 6f76 616c 2920 7265 2d72  se removal) re-r
-00003d40: 6566 6572 656e 6369 6e67 2e20 4765 6e65  eferencing. Gene
-00003d50: 7261 7465 2061 0a20 2020 2020 2020 2020  rate a.         
-00003d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c20: 7265 7475 726e 2076 616c 7565 7320 6f66  return values of
+00003c30: 2074 6865 206d 6574 7269 6320 6361 6c6c   the metric call
+00003c40: 6261 636b 7320 696e 2074 6865 2066 6f72  backs in the for
+00003c50: 6d61 743a 2063 6861 6e6e 656c 2078 2063  mat: channel x c
+00003c60: 6f6e 6469 7469 6f6e 2078 206d 6574 7269  ondition x metri
+00003c70: 630a 2020 2020 2020 2020 6869 6768 5f70  c.        high_p
+00003c80: 6173 7320 2862 6f6f 6c29 3a20 2020 2020  ass (bool):     
+00003c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ca0: 5072 6570 726f 6365 7373 2077 6974 6820  Preprocess with 
+00003cb0: 6869 6768 2d70 6173 7320 6669 6c74 6572  high-pass filter
+00003cc0: 696e 6720 2874 7275 6529 206f 7220 7769  ing (true) or wi
+00003cd0: 7468 6f75 7420 6669 6c74 6572 696e 6720  thout filtering 
+00003ce0: 2866 616c 7365 290a 2020 2020 2020 2020  (false).        
+00003cf0: 6561 726c 795f 7265 7265 6620 284e 6f6e  early_reref (Non
+00003d00: 6520 6f72 2052 6572 6566 5374 7275 6374  e or RerefStruct
+00003d10: 293a 2020 2020 5072 6570 726f 6365 7373  ):    Preprocess
+00003d20: 2077 6974 6820 6561 726c 7920 2862 6566   with early (bef
+00003d30: 6f72 6520 6c69 6e65 2d6e 6f69 7365 2072  ore line-noise r
+00003d40: 656d 6f76 616c 2920 7265 2d72 6566 6572  emoval) re-refer
+00003d50: 656e 6369 6e67 2e20 4765 6e65 7261 7465  encing. Generate
+00003d60: 2061 0a20 2020 2020 2020 2020 2020 2020   a.             
 00003d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003d80: 2020 2020 2052 6572 6566 5374 7275 6374       RerefStruct
-00003d90: 2069 6e73 7461 6e63 6520 7573 696e 6720   instance using 
-00003da0: 6f6e 6520 6f66 2074 6865 2066 6163 746f  one of the facto
-00003db0: 7279 206d 6574 686f 6473 2028 652e 672e  ry methods (e.g.
-00003dc0: 2067 656e 6572 6174 655f 6361 7229 2061   generate_car) a
-00003dd0: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
+00003d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003d90: 2052 6572 6566 5374 7275 6374 2069 6e73   RerefStruct ins
+00003da0: 7461 6e63 6520 7573 696e 6720 6f6e 6520  tance using one 
+00003db0: 6f66 2074 6865 2066 6163 746f 7279 206d  of the factory m
+00003dc0: 6574 686f 6473 2028 652e 672e 2067 656e  ethods (e.g. gen
+00003dd0: 6572 6174 655f 6361 7229 2061 6e64 0a20  erate_car) and. 
 00003de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00003df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e00: 2070 6173 7320 6974 2068 6572 6520 746f   pass it here to
-00003e10: 2061 6c6c 6f77 2066 6f72 2072 652d 7265   allow for re-re
-00003e20: 6665 7265 6e63 696e 672e 2050 6173 7320  ferencing. Pass 
-00003e30: 4e6f 6e65 2074 6f20 736b 6970 2065 6172  None to skip ear
-00003e40: 6c79 2072 652d 7265 6665 7265 6e63 696e  ly re-referencin
-00003e50: 672e 0a20 2020 2020 2020 206c 696e 655f  g..        line_
-00003e60: 6e6f 6973 655f 7265 6d6f 7661 6c20 284e  noise_removal (N
-00003e70: 6f6e 6520 6f72 2069 6e74 293a 2020 2020  one or int):    
-00003e80: 2057 6865 7468 6572 2074 6f20 7072 6570   Whether to prep
-00003e90: 726f 6365 7373 2077 6974 6820 6c69 6e65  rocess with line
-00003ea0: 2d6e 6f69 7365 2072 656d 6f76 616c 2e20  -noise removal. 
-00003eb0: 4966 2061 6e20 696e 7465 6765 7220 2865  If an integer (e
-00003ec0: 2e67 2e20 3530 206f 7220 3630 2920 6973  .g. 50 or 60) is
-00003ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003e00: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+00003e10: 7320 6974 2068 6572 6520 746f 2061 6c6c  s it here to all
+00003e20: 6f77 2066 6f72 2072 652d 7265 6665 7265  ow for re-refere
+00003e30: 6e63 696e 672e 2050 6173 7320 4e6f 6e65  ncing. Pass None
+00003e40: 2074 6f20 736b 6970 2065 6172 6c79 2072   to skip early r
+00003e50: 652d 7265 6665 7265 6e63 696e 672e 0a20  e-referencing.. 
+00003e60: 2020 2020 2020 206c 696e 655f 6e6f 6973         line_nois
+00003e70: 655f 7265 6d6f 7661 6c20 284e 6f6e 6520  e_removal (None 
+00003e80: 6f72 2069 6e74 293a 2020 2020 2057 6865  or int):     Whe
+00003e90: 7468 6572 2074 6f20 7072 6570 726f 6365  ther to preproce
+00003ea0: 7373 2077 6974 6820 6c69 6e65 2d6e 6f69  ss with line-noi
+00003eb0: 7365 2072 656d 6f76 616c 2e20 4966 2061  se removal. If a
+00003ec0: 6e20 696e 7465 6765 7220 2865 2e67 2e20  n integer (e.g. 
+00003ed0: 3530 206f 7220 3630 2920 6973 0a20 2020  50 or 60) is.   
 00003ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ef0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00003f00: 6173 7365 642c 2074 6865 6e20 6120 6e6f  assed, then a no
-00003f10: 7463 6820 6669 6c74 6572 2077 696c 6c20  tch filter will 
-00003f20: 6265 2061 7070 6c69 6564 2061 726f 756e  be applied aroun
-00003f30: 6420 7468 6174 206e 756d 6265 722e 2050  d that number. P
-00003f40: 6173 7369 6e67 204e 6f6e 650a 2020 2020  assing None.    
-00003f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003f00: 2020 2020 2020 2020 2020 2070 6173 7365             passe
+00003f10: 642c 2074 6865 6e20 6120 6e6f 7463 6820  d, then a notch 
+00003f20: 6669 6c74 6572 2077 696c 6c20 6265 2061  filter will be a
+00003f30: 7070 6c69 6564 2061 726f 756e 6420 7468  pplied around th
+00003f40: 6174 206e 756d 6265 722e 2050 6173 7369  at number. Passi
+00003f50: 6e67 204e 6f6e 650a 2020 2020 2020 2020  ng None.        
 00003f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f70: 2020 2020 2020 2020 2020 7769 6c6c 2064            will d
-00003f80: 6973 6162 6c65 206c 696e 652d 6e6f 6973  isable line-nois
-00003f90: 6520 7265 6d6f 7661 6c2e 0a20 2020 2020  e removal..     
-00003fa0: 2020 206c 6174 655f 7265 7265 6620 284e     late_reref (N
-00003fb0: 6f6e 6520 6f72 2052 6572 6566 5374 7275  one or RerefStru
-00003fc0: 6374 293a 2020 2020 2050 7265 7072 6f63  ct):     Preproc
-00003fd0: 6573 7320 7769 7468 206c 6174 6520 2861  ess with late (a
-00003fe0: 6674 6572 206c 696e 652d 6e6f 6973 6520  fter line-noise 
-00003ff0: 7265 6d6f 7661 6c29 2072 652d 7265 6665  removal) re-refe
-00004000: 7265 6e63 696e 672e 2047 656e 6572 6174  rencing. Generat
-00004010: 6520 610a 2020 2020 2020 2020 2020 2020  e a.            
+00003f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003f80: 2020 2020 2020 7769 6c6c 2064 6973 6162        will disab
+00003f90: 6c65 206c 696e 652d 6e6f 6973 6520 7265  le line-noise re
+00003fa0: 6d6f 7661 6c2e 0a20 2020 2020 2020 206c  moval..        l
+00003fb0: 6174 655f 7265 7265 6620 284e 6f6e 6520  ate_reref (None 
+00003fc0: 6f72 2052 6572 6566 5374 7275 6374 293a  or RerefStruct):
+00003fd0: 2020 2020 2050 7265 7072 6f63 6573 7320       Preprocess 
+00003fe0: 7769 7468 206c 6174 6520 2861 6674 6572  with late (after
+00003ff0: 206c 696e 652d 6e6f 6973 6520 7265 6d6f   line-noise remo
+00004000: 7661 6c29 2072 652d 7265 6665 7265 6e63  val) re-referenc
+00004010: 696e 672e 2047 656e 6572 6174 6520 610a  ing. Generate a.
 00004020: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004040: 2020 5265 7265 6653 7472 7563 7420 696e    RerefStruct in
-00004050: 7374 616e 6365 2075 7369 6e67 206f 6e65  stance using one
-00004060: 206f 6620 7468 6520 6661 6374 6f72 7920   of the factory 
-00004070: 6d65 7468 6f64 7320 2865 2e67 2e20 6765  methods (e.g. ge
-00004080: 6e65 7261 7465 5f63 6172 2920 616e 640a  nerate_car) and.
-00004090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004040: 2020 2020 2020 2020 2020 2020 2020 5265                Re
+00004050: 7265 6653 7472 7563 7420 696e 7374 616e  refStruct instan
+00004060: 6365 2075 7369 6e67 206f 6e65 206f 6620  ce using one of 
+00004070: 7468 6520 6661 6374 6f72 7920 6d65 7468  the factory meth
+00004080: 6f64 7320 2865 2e67 2e20 6765 6e65 7261  ods (e.g. genera
+00004090: 7465 5f63 6172 2920 616e 640a 2020 2020  te_car) and.    
 000040a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040b0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-000040c0: 7373 2069 7420 6865 7265 2074 6f20 616c  ss it here to al
-000040d0: 6c6f 7720 666f 7220 7265 2d72 6566 6572  low for re-refer
-000040e0: 656e 6369 6e67 2e20 5061 7373 204e 6f6e  encing. Pass Non
-000040f0: 6520 746f 2073 6b69 7020 6c61 7465 2072  e to skip late r
-00004100: 652d 7265 6665 7265 6e63 696e 672e 0a20  e-referencing.. 
-00004110: 2020 2020 2020 2070 7265 7072 6f63 5f70         preproc_p
-00004120: 7269 6f72 6974 7920 2873 7472 293a 2020  riority (str):  
-00004130: 2020 2020 2020 2020 2020 2020 5365 7420              Set 
-00004140: 7468 6520 7072 6570 726f 6365 7373 696e  the preprocessin
-00004150: 6720 7072 696f 7269 7479 2c20 6361 6e20  g priority, can 
-00004160: 6265 2073 6574 2074 6f20 6569 7468 6572  be set to either
-00004170: 2027 6d65 6d27 2028 6465 6661 756c 7429   'mem' (default)
-00004180: 206f 7220 2773 7065 6564 270a 0a20 2020   or 'speed'..   
-00004190: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
-000041a0: 2020 7361 6d70 6c69 6e67 5f72 6174 6520    sampling_rate 
-000041b0: 2869 6e74 206f 7220 646f 7562 6c65 293a  (int or double):
-000041c0: 2020 2020 2020 2020 5468 6520 7361 6d70          The samp
-000041d0: 6c69 6e67 2072 6174 6520 6174 2077 6869  ling rate at whi
-000041e0: 6368 2074 6865 2064 6174 6120 7761 7320  ch the data was 
-000041f0: 6163 7175 6972 6564 0a20 2020 2020 2020  acquired.       
-00004200: 2064 6174 6120 286e 6461 7272 6179 293a   data (ndarray):
-00004210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004220: 2020 2020 2020 2041 2074 6872 6565 2d64         A three-d
-00004230: 696d 656e 7369 6f6e 616c 2061 7272 6179  imensional array
-00004240: 2077 6974 6820 7369 676e 616c 2061 7665   with signal ave
-00004250: 7261 6765 7320 7065 7220 6368 616e 6e65  rages per channe
-00004260: 6c20 616e 6420 636f 6e64 6974 696f 6e0a  l and condition.
-00004270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040c0: 2020 2020 2020 2020 2020 7061 7373 2069            pass i
+000040d0: 7420 6865 7265 2074 6f20 616c 6c6f 7720  t here to allow 
+000040e0: 666f 7220 7265 2d72 6566 6572 656e 6369  for re-referenci
+000040f0: 6e67 2e20 5061 7373 204e 6f6e 6520 746f  ng. Pass None to
+00004100: 2073 6b69 7020 6c61 7465 2072 652d 7265   skip late re-re
+00004110: 6665 7265 6e63 696e 672e 0a20 2020 2020  ferencing..     
+00004120: 2020 2070 7265 7072 6f63 5f70 7269 6f72     preproc_prior
+00004130: 6974 7920 2873 7472 293a 2020 2020 2020  ity (str):      
+00004140: 2020 2020 2020 2020 2053 6574 2074 6865           Set the
+00004150: 2070 7265 7072 6f63 6573 7369 6e67 2070   preprocessing p
+00004160: 7269 6f72 6974 792c 2063 616e 2062 6520  riority, can be 
+00004170: 7365 7420 746f 2065 6974 6865 7220 276d  set to either 'm
+00004180: 656d 2720 2864 6566 6175 6c74 2920 6f72  em' (default) or
+00004190: 2027 7370 6565 6427 0a0a 2020 2020 5265   'speed'..    Re
+000041a0: 7475 726e 733a 0a20 2020 2020 2020 2073  turns:.        s
+000041b0: 616d 706c 696e 675f 7261 7465 2028 696e  ampling_rate (in
+000041c0: 7420 6f72 2064 6f75 626c 6529 3a20 2020  t or double):   
+000041d0: 2020 2020 2054 6865 2073 616d 706c 696e       The samplin
+000041e0: 6720 7261 7465 2061 7420 7768 6963 6820  g rate at which 
+000041f0: 7468 6520 6461 7461 2077 6173 2061 6371  the data was acq
+00004200: 7569 7265 640a 2020 2020 2020 2020 6461  uired.        da
+00004210: 7461 2028 6e64 6172 7261 7929 3a20 2020  ta (ndarray):   
+00004220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004230: 2020 2020 4120 7468 7265 652d 6469 6d65      A three-dime
+00004240: 6e73 696f 6e61 6c20 6172 7261 7920 7769  nsional array wi
+00004250: 7468 2073 6967 6e61 6c20 6176 6572 6167  th signal averag
+00004260: 6573 2070 6572 2063 6861 6e6e 656c 2061  es per channel a
+00004270: 6e64 2063 6f6e 6469 7469 6f6e 0a20 2020  nd condition.   
 00004280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004290: 2020 2020 2020 2020 2020 2020 2020 2866                (f
-000042a0: 6f72 6d61 743a 2063 6861 6e6e 656c 2078  ormat: channel x
-000042b0: 2063 6f6e 6469 7469 6f6e 2078 2073 616d   condition x sam
-000042c0: 706c 6573 293b 206f 7220 4e6f 6e65 2077  ples); or None w
-000042d0: 6865 6e20 616e 2065 7272 6f72 206f 6363  hen an error occ
-000042e0: 7572 730a 2020 2020 2020 2020 6d65 7472  urs.        metr
-000042f0: 6963 7320 286e 6461 7272 6179 293a 2020  ics (ndarray):  
-00004300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004310: 2020 4966 206d 6574 7269 6320 6361 6c6c    If metric call
-00004320: 6261 636b 7320 6172 6520 7370 6563 6966  backs are specif
-00004330: 6965 642c 2077 696c 6c20 7265 7475 726e  ied, will return
-00004340: 2061 2074 6872 6565 2d64 696d 656e 7369   a three-dimensi
-00004350: 6f6e 616c 2061 7272 6179 0a20 2020 2020  onal array.     
-00004360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042a0: 2020 2020 2020 2020 2020 2028 666f 726d             (form
+000042b0: 6174 3a20 6368 616e 6e65 6c20 7820 636f  at: channel x co
+000042c0: 6e64 6974 696f 6e20 7820 7361 6d70 6c65  ndition x sample
+000042d0: 7329 3b20 6f72 204e 6f6e 6520 7768 656e  s); or None when
+000042e0: 2061 6e20 6572 726f 7220 6f63 6375 7273   an error occurs
+000042f0: 0a20 2020 2020 2020 206d 6574 7269 6373  .        metrics
+00004300: 2028 6e64 6172 7261 7929 3a20 2020 2020   (ndarray):     
+00004310: 2020 2020 2020 2020 2020 2020 2020 2049                 I
+00004320: 6620 6d65 7472 6963 2063 616c 6c62 6163  f metric callbac
+00004330: 6b73 2061 7265 2073 7065 6369 6669 6564  ks are specified
+00004340: 2c20 7769 6c6c 2072 6574 7572 6e20 6120  , will return a 
+00004350: 7468 7265 652d 6469 6d65 6e73 696f 6e61  three-dimensiona
+00004360: 6c20 6172 7261 790a 2020 2020 2020 2020  l array.        
 00004370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004380: 2020 2020 2020 2020 2077 6974 6820 7468           with th
-00004390: 6520 6d65 7472 6963 2063 616c 6c62 6163  e metric callbac
-000043a0: 6b20 7265 7375 6c74 7320 2866 6f72 6d61  k results (forma
-000043b0: 743a 2063 6861 6e6e 656c 2078 2063 6f6e  t: channel x con
-000043c0: 6469 7469 6f6e 2078 206d 6574 7269 6329  dition x metric)
-000043d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00004380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004390: 2020 2020 2020 7769 7468 2074 6865 206d        with the m
+000043a0: 6574 7269 6320 6361 6c6c 6261 636b 2072  etric callback r
+000043b0: 6573 756c 7473 2028 666f 726d 6174 3a20  esults (format: 
+000043c0: 6368 616e 6e65 6c20 7820 636f 6e64 6974  channel x condit
+000043d0: 696f 6e20 7820 6d65 7472 6963 292c 0a20  ion x metric),. 
 000043e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000043f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004400: 656c 7365 2077 6973 6520 4e6f 6e65 0a0a  else wise None..
-00004410: 2020 2020 4e6f 7465 3a20 7468 6973 2066      Note: this f
-00004420: 756e 6374 696f 6e20 696e 7075 7420 6172  unction input ar
-00004430: 6775 6d65 6e74 7320 6172 6520 696e 2073  guments are in s
-00004440: 6563 6f6e 6473 2072 656c 6174 6976 6520  econds relative 
-00004450: 746f 2074 7269 616c 206f 6e73 6574 7320  to trial onsets 
-00004460: 6265 6361 7573 6520 7468 6520 7361 6d70  because the samp
-00004470: 6c65 2072 6174 6520 7769 6c6c 0a20 2020  le rate will.   
-00004480: 2020 2020 2020 206f 6e6c 7920 6265 206b         only be k
-00004490: 6e6f 776e 2074 696c 6c20 6166 7465 7220  nown till after 
-000044a0: 7765 2072 6561 6420 7468 6520 6461 7461  we read the data
-000044b0: 0a20 2020 2022 2222 0a0a 2020 2020 230a  .    """..    #.
-000044c0: 2020 2020 2320 6368 6563 6b20 696e 7075      # check inpu
-000044d0: 740a 2020 2020 230a 2020 2020 7472 793a  t.    #.    try:
-000044e0: 0a20 2020 2020 2020 2064 6174 615f 7265  .        data_re
-000044f0: 6164 6572 2c20 6261 7365 6c69 6e65 5f6d  ader, baseline_m
-00004500: 6574 686f 642c 206f 7574 5f6f 665f 626f  ethod, out_of_bo
-00004510: 756e 645f 6d65 7468 6f64 203d 205f 5f70  und_method = __p
-00004520: 7265 7061 7265 5f69 6e70 7574 2864 6174  repare_input(dat
-00004530: 615f 7061 7468 2c0a 2020 2020 2020 2020  a_path,.        
-00004540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004400: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00004410: 6520 7769 7365 204e 6f6e 650a 0a20 2020  e wise None..   
+00004420: 204e 6f74 653a 2074 6869 7320 6675 6e63   Note: this func
+00004430: 7469 6f6e 2069 6e70 7574 2061 7267 756d  tion input argum
+00004440: 656e 7473 2061 7265 2069 6e20 7365 636f  ents are in seco
+00004450: 6e64 7320 7265 6c61 7469 7665 2074 6f20  nds relative to 
+00004460: 7472 6961 6c20 6f6e 7365 7473 2062 6563  trial onsets bec
+00004470: 6175 7365 2074 6865 2073 616d 706c 6520  ause the sample 
+00004480: 7261 7465 2077 696c 6c0a 2020 2020 2020  rate will.      
+00004490: 2020 2020 6f6e 6c79 2062 6520 6b6e 6f77      only be know
+000044a0: 6e20 7469 6c6c 2061 6674 6572 2077 6520  n till after we 
+000044b0: 7265 6164 2074 6865 2064 6174 610a 2020  read the data.  
+000044c0: 2020 2222 220a 0a20 2020 2023 0a20 2020    """..    #.   
+000044d0: 2023 2063 6865 636b 2069 6e70 7574 0a20   # check input. 
+000044e0: 2020 2023 0a20 2020 2074 7279 3a0a 2020     #.    try:.  
+000044f0: 2020 2020 2020 6461 7461 5f72 6561 6465        data_reade
+00004500: 722c 2062 6173 656c 696e 655f 6d65 7468  r, baseline_meth
+00004510: 6f64 2c20 6f75 745f 6f66 5f62 6f75 6e64  od, out_of_bound
+00004520: 5f6d 6574 686f 6420 3d20 5f5f 7072 6570  _method = __prep
+00004530: 6172 655f 696e 7075 7428 6461 7461 5f70  are_input(data_p
+00004540: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
 00004550: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004560: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004580: 2020 2020 7472 6961 6c5f 6570 6f63 682c      trial_epoch,
-00004590: 2062 6173 656c 696e 655f 6e6f 726d 2c20   baseline_norm, 
-000045a0: 6261 7365 6c69 6e65 5f65 706f 6368 2c0a  baseline_epoch,.
-000045b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004590: 2074 7269 616c 5f65 706f 6368 2c20 6261   trial_epoch, ba
+000045a0: 7365 6c69 6e65 5f6e 6f72 6d2c 2062 6173  seline_norm, bas
+000045b0: 656c 696e 655f 6570 6f63 682c 0a20 2020  eline_epoch,.   
 000045c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000045d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000045e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000045f0: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
-00004600: 6f66 5f62 6f75 6e64 5f68 616e 646c 696e  of_bound_handlin
-00004610: 672c 2070 7265 7072 6f63 5f70 7269 6f72  g, preproc_prior
-00004620: 6974 7929 0a20 2020 2020 2020 2023 2054  ity).        # T
-00004630: 4f44 4f3a 2063 6865 636b 2070 7265 7072  ODO: check prepr
-00004640: 6f63 6573 7369 6e67 2069 6e70 7574 0a0a  ocessing input..
-00004650: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-00004660: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-00004670: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
-00004680: 2827 4572 726f 7220 7072 6570 6172 696e  ('Error preparin
-00004690: 6720 696e 7075 743a 2027 202b 2073 7472  g input: ' + str
-000046a0: 2865 2929 0a20 2020 2020 2020 2072 6169  (e)).        rai
-000046b0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-000046c0: 2745 7272 6f72 2070 7265 7061 7269 6e67  'Error preparing
-000046d0: 2069 6e70 7574 2729 0a0a 0a20 2020 2023   input')...    #
-000046e0: 0a20 2020 2023 2072 6561 6420 616e 6420  .    # read and 
-000046f0: 7072 6f63 6573 7320 7468 6520 6461 7461  process the data
-00004700: 0a20 2020 2023 0a20 2020 2074 7279 3a0a  .    #.    try:.
-00004710: 0a20 2020 2020 2020 2023 2063 6865 636b  .        # check
-00004720: 2077 6865 7468 6572 2070 7265 7072 6f63   whether preproc
-00004730: 6573 7369 6e67 2069 7320 6e65 6564 6564  essing is needed
-00004740: 2028 6675 6c6c 2063 6861 6e6e 656c 206c   (full channel l
-00004750: 6f61 6469 6e67 290a 2020 2020 2020 2020  oading).        
-00004760: 6966 2068 6967 685f 7061 7373 206f 7220  if high_pass or 
-00004770: 6561 726c 795f 7265 7265 6620 6973 206e  early_reref is n
-00004780: 6f74 204e 6f6e 6520 6f72 206c 696e 655f  ot None or line_
-00004790: 6e6f 6973 655f 7265 6d6f 7661 6c20 6973  noise_removal is
-000047a0: 206e 6f74 204e 6f6e 6520 6f72 206c 6174   not None or lat
-000047b0: 655f 7265 7265 6620 6973 206e 6f74 204e  e_reref is not N
-000047c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000047d0: 2023 2072 6571 7569 7265 2070 7265 7072   # require prepr
-000047e0: 6f63 6573 7369 6e67 0a0a 2020 2020 2020  ocessing..      
-000047f0: 2020 2020 2020 2320 4c6f 6164 2064 6174        # Load dat
-00004800: 6120 6570 6f63 6820 6176 6572 6167 6573  a epoch averages
-00004810: 2062 7920 6974 6572 6174 696e 6720 6f76   by iterating ov
-00004820: 6572 2074 6865 2063 6861 6e6e 656c 730a  er the channels.
-00004830: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-00004840: 7465 3a20 2020 7769 7468 2070 7265 7072  te:   with prepr
-00004850: 6f63 6573 7369 6e67 2070 6572 2063 6861  ocessing per cha
-00004860: 6e6e 656c 206d 616e 6970 756c 6174 696f  nnel manipulatio
-00004870: 6e73 2061 7265 206e 6565 6465 6420 6265  ns are needed be
-00004880: 666f 7265 2065 706f 6368 2d69 6e67 2028  fore epoch-ing (
-00004890: 2c6d 6574 7269 6320 6361 6c63 756c 6174  ,metric calculat
-000048a0: 696f 6e29 2061 6e64 2061 7665 7261 6769  ion) and averagi
-000048b0: 6e67 0a20 2020 2020 2020 2020 2020 2073  ng.            s
-000048c0: 616d 706c 696e 675f 7261 7465 2c20 6461  ampling_rate, da
-000048d0: 7461 2c20 6d65 7472 6963 5f76 616c 7565  ta, metric_value
-000048e0: 7320 3d20 5f5f 6c6f 6164 5f64 6174 615f  s = __load_data_
-000048f0: 6570 6f63 6873 5f5f 6279 5f63 6861 6e6e  epochs__by_chann
-00004900: 656c 735f 5f77 6974 6850 7265 7028 5472  els__withPrep(Tr
-00004910: 7565 2c20 6461 7461 5f72 6561 6465 722c  ue, data_reader,
-00004920: 2072 6574 7269 6576 655f 6368 616e 6e65   retrieve_channe
-00004930: 6c73 2c20 636f 6e64 6974 696f 6e73 5f6f  ls, conditions_o
-00004940: 6e73 6574 732c 0a20 2020 2020 2020 2020  nsets,.         
-00004950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004600: 2020 2020 2020 2020 206f 7574 5f6f 665f           out_of_
+00004610: 626f 756e 645f 6861 6e64 6c69 6e67 2c20  bound_handling, 
+00004620: 7072 6570 726f 635f 7072 696f 7269 7479  preproc_priority
+00004630: 290a 2020 2020 2020 2020 2320 544f 444f  ).        # TODO
+00004640: 3a20 6368 6563 6b20 7072 6570 726f 6365  : check preproce
+00004650: 7373 696e 6720 696e 7075 740a 0a20 2020  ssing input..   
+00004660: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00004670: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+00004680: 6c6f 6767 696e 672e 6572 726f 7228 2745  logging.error('E
+00004690: 7272 6f72 2070 7265 7061 7269 6e67 2069  rror preparing i
+000046a0: 6e70 7574 3a20 2720 2b20 7374 7228 6529  nput: ' + str(e)
+000046b0: 290a 2020 2020 2020 2020 7261 6973 6520  ).        raise 
+000046c0: 5275 6e74 696d 6545 7272 6f72 2827 4572  RuntimeError('Er
+000046d0: 726f 7220 7072 6570 6172 696e 6720 696e  ror preparing in
+000046e0: 7075 7427 290a 0a0a 2020 2020 230a 2020  put')...    #.  
+000046f0: 2020 2320 7265 6164 2061 6e64 2070 726f    # read and pro
+00004700: 6365 7373 2074 6865 2064 6174 610a 2020  cess the data.  
+00004710: 2020 230a 2020 2020 7472 793a 0a0a 2020    #.    try:..  
+00004720: 2020 2020 2020 2320 6368 6563 6b20 7768        # check wh
+00004730: 6574 6865 7220 7072 6570 726f 6365 7373  ether preprocess
+00004740: 696e 6720 6973 206e 6565 6465 6420 2866  ing is needed (f
+00004750: 756c 6c20 6368 616e 6e65 6c20 6c6f 6164  ull channel load
+00004760: 696e 6729 0a20 2020 2020 2020 2069 6620  ing).        if 
+00004770: 6869 6768 5f70 6173 7320 6f72 2065 6172  high_pass or ear
+00004780: 6c79 5f72 6572 6566 2069 7320 6e6f 7420  ly_reref is not 
+00004790: 4e6f 6e65 206f 7220 6c69 6e65 5f6e 6f69  None or line_noi
+000047a0: 7365 5f72 656d 6f76 616c 2069 7320 6e6f  se_removal is no
+000047b0: 7420 4e6f 6e65 206f 7220 6c61 7465 5f72  t None or late_r
+000047c0: 6572 6566 2069 7320 6e6f 7420 4e6f 6e65  eref is not None
+000047d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000047e0: 7265 7175 6972 6520 7072 6570 726f 6365  require preproce
+000047f0: 7373 696e 670a 0a20 2020 2020 2020 2020  ssing..         
+00004800: 2020 2023 204c 6f61 6420 6461 7461 2065     # Load data e
+00004810: 706f 6368 2061 7665 7261 6765 7320 6279  poch averages by
+00004820: 2069 7465 7261 7469 6e67 206f 7665 7220   iterating over 
+00004830: 7468 6520 6368 616e 6e65 6c73 0a20 2020  the channels.   
+00004840: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
+00004850: 2020 2077 6974 6820 7072 6570 726f 6365     with preproce
+00004860: 7373 696e 6720 7065 7220 6368 616e 6e65  ssing per channe
+00004870: 6c20 6d61 6e69 7075 6c61 7469 6f6e 7320  l manipulations 
+00004880: 6172 6520 6e65 6564 6564 2062 6566 6f72  are needed befor
+00004890: 6520 6570 6f63 682d 696e 6720 282c 6d65  e epoch-ing (,me
+000048a0: 7472 6963 2063 616c 6375 6c61 7469 6f6e  tric calculation
+000048b0: 2920 616e 6420 6176 6572 6167 696e 670a  ) and averaging.
+000048c0: 2020 2020 2020 2020 2020 2020 7361 6d70              samp
+000048d0: 6c69 6e67 5f72 6174 652c 2064 6174 612c  ling_rate, data,
+000048e0: 206d 6574 7269 635f 7661 6c75 6573 203d   metric_values =
+000048f0: 205f 5f6c 6f61 645f 6461 7461 5f65 706f   __load_data_epo
+00004900: 6368 735f 5f62 795f 6368 616e 6e65 6c73  chs__by_channels
+00004910: 5f5f 7769 7468 5072 6570 2854 7275 652c  __withPrep(True,
+00004920: 2064 6174 615f 7265 6164 6572 2c20 7265   data_reader, re
+00004930: 7472 6965 7665 5f63 6861 6e6e 656c 732c  trieve_channels,
+00004940: 2063 6f6e 6469 7469 6f6e 735f 6f6e 7365   conditions_onse
+00004950: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
 00004960: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004970: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004980: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000049a0: 2020 7472 6961 6c5f 6570 6f63 683d 7472    trial_epoch=tr
-000049b0: 6961 6c5f 6570 6f63 682c 0a20 2020 2020  ial_epoch,.     
-000049c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000049a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000049b0: 7269 616c 5f65 706f 6368 3d74 7269 616c  rial_epoch=trial
+000049c0: 5f65 706f 6368 2c0a 2020 2020 2020 2020  _epoch,.        
 000049d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000049e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000049f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004a10: 2020 2020 2020 6261 7365 6c69 6e65 5f6d        baseline_m
-00004a20: 6574 686f 643d 6261 7365 6c69 6e65 5f6d  ethod=baseline_m
-00004a30: 6574 686f 642c 2062 6173 656c 696e 655f  ethod, baseline_
-00004a40: 6570 6f63 683d 6261 7365 6c69 6e65 5f65  epoch=baseline_e
-00004a50: 706f 6368 2c0a 2020 2020 2020 2020 2020  poch,.          
-00004a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a20: 2020 2062 6173 656c 696e 655f 6d65 7468     baseline_meth
+00004a30: 6f64 3d62 6173 656c 696e 655f 6d65 7468  od=baseline_meth
+00004a40: 6f64 2c20 6261 7365 6c69 6e65 5f65 706f  od, baseline_epo
+00004a50: 6368 3d62 6173 656c 696e 655f 6570 6f63  ch=baseline_epoc
+00004a60: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
 00004a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004ab0: 206f 7574 5f6f 665f 626f 756e 645f 6d65   out_of_bound_me
-00004ac0: 7468 6f64 3d6f 7574 5f6f 665f 626f 756e  thod=out_of_boun
-00004ad0: 645f 6d65 7468 6f64 2c0a 2020 2020 2020  d_method,.      
-00004ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ab0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00004ac0: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
+00004ad0: 643d 6f75 745f 6f66 5f62 6f75 6e64 5f6d  d=out_of_bound_m
+00004ae0: 6574 686f 642c 0a20 2020 2020 2020 2020  ethod,.         
 00004af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004b30: 2020 2020 206d 6574 7269 635f 6361 6c6c       metric_call
-00004b40: 6261 636b 733d 6d65 7472 6963 5f63 616c  backs=metric_cal
-00004b50: 6c62 6163 6b73 2c0a 2020 2020 2020 2020  lbacks,.        
-00004b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b40: 2020 6d65 7472 6963 5f63 616c 6c62 6163    metric_callbac
+00004b50: 6b73 3d6d 6574 7269 635f 6361 6c6c 6261  ks=metric_callba
+00004b60: 636b 732c 0a20 2020 2020 2020 2020 2020  cks,.           
 00004b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004bb0: 2020 2068 6967 685f 7061 7373 3d68 6967     high_pass=hig
-00004bc0: 685f 7061 7373 2c0a 2020 2020 2020 2020  h_pass,.        
-00004bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004bc0: 6869 6768 5f70 6173 733d 6869 6768 5f70  high_pass=high_p
+00004bd0: 6173 732c 0a20 2020 2020 2020 2020 2020  ass,.           
 00004be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004c20: 2020 2065 6172 6c79 5f72 6572 6566 3d65     early_reref=e
-00004c30: 6172 6c79 5f72 6572 6566 2c0a 2020 2020  arly_reref,.    
-00004c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c30: 6561 726c 795f 7265 7265 663d 6561 726c  early_reref=earl
+00004c40: 795f 7265 7265 662c 0a20 2020 2020 2020  y_reref,.       
 00004c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004c90: 2020 2020 2020 206c 696e 655f 6e6f 6973         line_nois
-00004ca0: 655f 7265 6d6f 7661 6c3d 6c69 6e65 5f6e  e_removal=line_n
-00004cb0: 6f69 7365 5f72 656d 6f76 616c 2c0a 2020  oise_removal,.  
-00004cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ca0: 2020 2020 6c69 6e65 5f6e 6f69 7365 5f72      line_noise_r
+00004cb0: 656d 6f76 616c 3d6c 696e 655f 6e6f 6973  emoval=line_nois
+00004cc0: 655f 7265 6d6f 7661 6c2c 0a20 2020 2020  e_removal,.     
 00004cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d10: 2020 2020 2020 2020 206c 6174 655f 7265           late_re
-00004d20: 7265 663d 6c61 7465 5f72 6572 6566 2c0a  ref=late_reref,.
-00004d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d20: 2020 2020 2020 6c61 7465 5f72 6572 6566        late_reref
+00004d30: 3d6c 6174 655f 7265 7265 662c 0a20 2020  =late_reref,.   
 00004d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00004d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004d80: 2020 2020 2020 2020 2020 2070 7269 6f72             prior
-00004d90: 6974 793d 7072 6570 726f 635f 7072 696f  ity=preproc_prio
-00004da0: 7269 7479 290a 0a20 2020 2020 2020 2065  rity)..        e
-00004db0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00004dc0: 2023 206e 6f20 7072 6570 726f 6365 7373   # no preprocess
-00004dd0: 696e 6720 7265 7175 6972 6564 0a0a 2020  ing required..  
-00004de0: 2020 2020 2020 2020 2020 6966 2064 6174            if dat
-00004df0: 615f 7265 6164 6572 2e64 6174 615f 666f  a_reader.data_fo
-00004e00: 726d 6174 2069 6e20 2827 6276 272c 2027  rmat in ('bv', '
-00004e10: 6564 6627 293a 0a20 2020 2020 2020 2020  edf'):.         
-00004e20: 2020 2020 2020 2023 2045 4446 206f 7220         # EDF or 
-00004e30: 4272 6169 6e56 6973 696f 6e20 666f 726d  BrainVision form
-00004e40: 6174 2c20 7573 6520 4d4e 4520 746f 2072  at, use MNE to r
-00004e50: 6561 640a 0a20 2020 2020 2020 2020 2020  ead..           
-00004e60: 2020 2020 2023 204c 6f61 6420 6461 7461       # Load data
-00004e70: 2065 706f 6368 2061 7665 7261 6765 7320   epoch averages 
-00004e80: 6279 2066 6972 7374 2069 7465 7261 7469  by first iterati
-00004e90: 6e67 206f 7665 7220 636f 6e64 6974 696f  ng over conditio
-00004ea0: 6e73 2c20 7468 656e 206f 7665 7220 7468  ns, then over th
-00004eb0: 6520 6368 616e 6e65 6c73 2061 6e64 2074  e channels and t
-00004ec0: 6865 6e20 7265 7472 6965 7665 0a20 2020  hen retrieve.   
-00004ed0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-00004ee0: 6e64 2061 7665 7261 6765 2028 6d65 7472  nd average (metr
-00004ef0: 6963 2920 6f76 6572 2074 6865 2065 706f  ic) over the epo
-00004f00: 6368 2d74 7269 616c 7320 7769 7468 696e  ch-trials within
-00004f10: 2074 6865 2063 6861 6e6e 656c 2d63 6f6e   the channel-con
-00004f20: 6469 7469 6f6e 2063 6f6d 6269 6e61 7469  dition combinati
-00004f30: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
-00004f40: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
-00004f50: 2020 2020 2023 204e 6f74 653a 2020 2020       # Note:    
-00004f60: 2054 6869 7320 6d65 7468 6f64 2069 7320   This method is 
-00004f70: 676f 6f64 2066 6f72 2045 4446 2061 6e64  good for EDF and
-00004f80: 2042 7261 696e 5669 7369 6f6e 2062 6563   BrainVision bec
-00004f90: 6175 7365 204d 4e45 2061 6c72 6561 6479  ause MNE already
-00004fa0: 206c 6f61 6473 2074 6865 2065 6e74 6972   loads the entir
-00004fb0: 6520 7365 7420 696e 0a20 2020 2020 2020  e set in.       
-00004fc0: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00004fd0: 2020 2020 206d 656d 6f72 792e 2053 6f20       memory. So 
-00004fe0: 7468 6572 6520 6973 206e 6f20 6d69 6e69  there is no mini
-00004ff0: 6d75 6d20 6f66 206c 6f61 6469 6e67 206f  mum of loading o
-00005000: 6620 6461 7461 2070 6f73 7369 626c 652e  f data possible.
-00005010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00005020: 2073 616d 706c 696e 675f 7261 7465 2c20   sampling_rate, 
-00005030: 6461 7461 2c20 6d65 7472 6963 5f76 616c  data, metric_val
-00005040: 7565 7320 3d20 5f5f 6c6f 6164 5f64 6174  ues = __load_dat
-00005050: 615f 6570 6f63 685f 6176 6572 6167 6573  a_epoch_averages
-00005060: 5f5f 6279 5f63 6861 6e6e 656c 5f63 6f6e  __by_channel_con
-00005070: 6469 7469 6f6e 5f74 7269 616c 2864 6174  dition_trial(dat
-00005080: 615f 7265 6164 6572 2c20 7265 7472 6965  a_reader, retrie
-00005090: 7665 5f63 6861 6e6e 656c 732c 2063 6f6e  ve_channels, con
-000050a0: 6469 7469 6f6e 735f 6f6e 7365 7473 2c0a  ditions_onsets,.
-000050b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d90: 2020 2020 2020 2020 7072 696f 7269 7479          priority
+00004da0: 3d70 7265 7072 6f63 5f70 7269 6f72 6974  =preproc_priorit
+00004db0: 7929 0a0a 2020 2020 2020 2020 656c 7365  y)..        else
+00004dc0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00004dd0: 6e6f 2070 7265 7072 6f63 6573 7369 6e67  no preprocessing
+00004de0: 2072 6571 7569 7265 640a 0a20 2020 2020   required..     
+00004df0: 2020 2020 2020 2069 6620 6461 7461 5f72         if data_r
+00004e00: 6561 6465 722e 6461 7461 5f66 6f72 6d61  eader.data_forma
+00004e10: 7420 696e 2028 2762 7627 2c20 2765 6466  t in ('bv', 'edf
+00004e20: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00004e30: 2020 2020 2320 4544 4620 6f72 2042 7261      # EDF or Bra
+00004e40: 696e 5669 7369 6f6e 2066 6f72 6d61 742c  inVision format,
+00004e50: 2075 7365 204d 4e45 2074 6f20 7265 6164   use MNE to read
+00004e60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00004e70: 2020 2320 4c6f 6164 2064 6174 6120 6570    # Load data ep
+00004e80: 6f63 6820 6176 6572 6167 6573 2062 7920  och averages by 
+00004e90: 6669 7273 7420 6974 6572 6174 696e 6720  first iterating 
+00004ea0: 6f76 6572 2063 6f6e 6469 7469 6f6e 732c  over conditions,
+00004eb0: 2074 6865 6e20 6f76 6572 2074 6865 2063   then over the c
+00004ec0: 6861 6e6e 656c 7320 616e 6420 7468 656e  hannels and then
+00004ed0: 2072 6574 7269 6576 650a 2020 2020 2020   retrieve.      
+00004ee0: 2020 2020 2020 2020 2020 2320 616e 6420            # and 
+00004ef0: 6176 6572 6167 6520 286d 6574 7269 6329  average (metric)
+00004f00: 206f 7665 7220 7468 6520 6570 6f63 682d   over the epoch-
+00004f10: 7472 6961 6c73 2077 6974 6869 6e20 7468  trials within th
+00004f20: 6520 6368 616e 6e65 6c2d 636f 6e64 6974  e channel-condit
+00004f30: 696f 6e20 636f 6d62 696e 6174 696f 6e0a  ion combination.
+00004f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f50: 230a 2020 2020 2020 2020 2020 2020 2020  #.              
+00004f60: 2020 2320 4e6f 7465 3a20 2020 2020 5468    # Note:     Th
+00004f70: 6973 206d 6574 686f 6420 6973 2067 6f6f  is method is goo
+00004f80: 6420 666f 7220 4544 4620 616e 6420 4272  d for EDF and Br
+00004f90: 6169 6e56 6973 696f 6e20 6265 6361 7573  ainVision becaus
+00004fa0: 6520 4d4e 4520 616c 7265 6164 7920 6c6f  e MNE already lo
+00004fb0: 6164 7320 7468 6520 656e 7469 7265 2073  ads the entire s
+00004fc0: 6574 2069 6e0a 2020 2020 2020 2020 2020  et in.          
+00004fd0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00004fe0: 2020 6d65 6d6f 7279 2e20 536f 2074 6865    memory. So the
+00004ff0: 7265 2069 7320 6e6f 206d 696e 696d 756d  re is no minimum
+00005000: 206f 6620 6c6f 6164 696e 6720 6f66 2064   of loading of d
+00005010: 6174 6120 706f 7373 6962 6c65 2e0a 2020  ata possible..  
+00005020: 2020 2020 2020 2020 2020 2020 2020 7361                sa
+00005030: 6d70 6c69 6e67 5f72 6174 652c 2064 6174  mpling_rate, dat
+00005040: 612c 206d 6574 7269 635f 7661 6c75 6573  a, metric_values
+00005050: 203d 205f 5f6c 6f61 645f 6461 7461 5f65   = __load_data_e
+00005060: 706f 6368 5f61 7665 7261 6765 735f 5f62  poch_averages__b
+00005070: 795f 6368 616e 6e65 6c5f 636f 6e64 6974  y_channel_condit
+00005080: 696f 6e5f 7472 6961 6c28 6461 7461 5f72  ion_trial(data_r
+00005090: 6561 6465 722c 2072 6574 7269 6576 655f  eader, retrieve_
+000050a0: 6368 616e 6e65 6c73 2c20 636f 6e64 6974  channels, condit
+000050b0: 696f 6e73 5f6f 6e73 6574 732c 0a20 2020  ions_onsets,.   
 000050c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000050d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000050e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000050f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005110: 2020 2020 2020 2020 2020 2020 7472 6961              tria
-00005120: 6c5f 6570 6f63 683d 7472 6961 6c5f 6570  l_epoch=trial_ep
-00005130: 6f63 682c 0a20 2020 2020 2020 2020 2020  och,.           
-00005140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005120: 2020 2020 2020 2020 2074 7269 616c 5f65           trial_e
+00005130: 706f 6368 3d74 7269 616c 5f65 706f 6368  poch=trial_epoch
+00005140: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 00005150: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005160: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005170: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005180: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000051a0: 2062 6173 656c 696e 655f 6d65 7468 6f64   baseline_method
-000051b0: 3d62 6173 656c 696e 655f 6d65 7468 6f64  =baseline_method
-000051c0: 2c20 6261 7365 6c69 6e65 5f65 706f 6368  , baseline_epoch
-000051d0: 3d62 6173 656c 696e 655f 6570 6f63 682c  =baseline_epoch,
-000051e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000051a0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+000051b0: 7365 6c69 6e65 5f6d 6574 686f 643d 6261  seline_method=ba
+000051c0: 7365 6c69 6e65 5f6d 6574 686f 642c 2062  seline_method, b
+000051d0: 6173 656c 696e 655f 6570 6f63 683d 6261  aseline_epoch=ba
+000051e0: 7365 6c69 6e65 5f65 706f 6368 2c0a 2020  seline_epoch,.  
 000051f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005200: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005210: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005220: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005240: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00005250: 5f6f 665f 626f 756e 645f 6d65 7468 6f64  _of_bound_method
-00005260: 3d6f 7574 5f6f 665f 626f 756e 645f 6d65  =out_of_bound_me
-00005270: 7468 6f64 2c20 6d65 7472 6963 5f63 616c  thod, metric_cal
-00005280: 6c62 6163 6b73 3d6d 6574 7269 635f 6361  lbacks=metric_ca
-00005290: 6c6c 6261 636b 7329 0a0a 2020 2020 2020  llbacks)..      
-000052a0: 2020 2020 2020 656c 6966 2064 6174 615f        elif data_
-000052b0: 7265 6164 6572 2e64 6174 615f 666f 726d  reader.data_form
-000052c0: 6174 203d 3d20 276d 6566 3327 3a0a 2020  at == 'mef3':.  
-000052d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000052e0: 4d45 4633 2066 6f72 6d61 740a 0a20 2020  MEF3 format..   
-000052f0: 2020 2020 2020 2020 2020 2020 2023 206c               # l
-00005300: 6f61 6420 7468 6520 6461 7461 2062 7920  oad the data by 
-00005310: 6669 7273 7420 6974 6572 6174 696e 6720  first iterating 
-00005320: 6f76 6572 2063 6f6e 6469 7469 6f6e 732c  over conditions,
-00005330: 2073 6563 6f6e 6420 6f76 6572 2074 7269   second over tri
-00005340: 616c 7320 7769 7468 696e 2074 6861 7420  als within that 
-00005350: 636f 6e64 6974 696f 6e20 616e 6420 7468  condition and th
-00005360: 656e 0a20 2020 2020 2020 2020 2020 2020  en.             
-00005370: 2020 2023 2072 6574 7269 6576 6520 7468     # retrieve th
-00005380: 6520 6570 6f63 682d 6461 7461 2066 6f72  e epoch-data for
-00005390: 2061 6c6c 2063 6861 6e6e 656c 7320 616e   all channels an
-000053a0: 6420 7461 6b65 2061 7665 7261 6765 2028  d take average (
-000053b0: 616e 6420 6d65 7472 6963 2920 666f 7220  and metric) for 
-000053c0: 6561 6368 2063 6861 6e6e 656c 2e0a 2020  each channel..  
-000053d0: 2020 2020 2020 2020 2020 2020 2020 230a                #.
-000053e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000053f0: 2320 466f 7220 4d45 4633 2074 6869 7320  # For MEF3 this 
-00005400: 6973 2074 6865 2066 6173 7465 7374 2073  is the fastest s
-00005410: 6f6c 7574 696f 6e20 7768 696c 6520 7573  olution while us
-00005420: 696e 6720 6120 736d 616c 6c20 616d 6f75  ing a small amou
-00005430: 6e74 206f 6620 6d65 6d6f 7279 2028 6265  nt of memory (be
-00005440: 6361 7573 6520 6f6e 6c79 2074 6865 2072  cause only the r
-00005450: 6571 7569 7265 6420 6461 7461 2069 7320  equired data is 
-00005460: 6c6f 6164 6564 290a 2020 2020 2020 2020  loaded).        
-00005470: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00005480: 2020 2020 2020 2020 2020 7361 6d70 6c69            sampli
-00005490: 6e67 5f72 6174 652c 2064 6174 612c 206d  ng_rate, data, m
-000054a0: 6574 7269 635f 7661 6c75 6573 203d 205f  etric_values = _
-000054b0: 5f6c 6f61 645f 6461 7461 5f65 706f 6368  _load_data_epoch
-000054c0: 5f61 7665 7261 6765 735f 5f62 795f 636f  _averages__by_co
-000054d0: 6e64 6974 696f 6e5f 7472 6961 6c28 6461  ndition_trial(da
-000054e0: 7461 5f72 6561 6465 722c 2072 6574 7269  ta_reader, retri
-000054f0: 6576 655f 6368 616e 6e65 6c73 2c20 636f  eve_channels, co
-00005500: 6e64 6974 696f 6e73 5f6f 6e73 6574 732c  nditions_onsets,
-00005510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005250: 2020 2020 2020 2020 2020 6f75 745f 6f66            out_of
+00005260: 5f62 6f75 6e64 5f6d 6574 686f 643d 6f75  _bound_method=ou
+00005270: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
+00005280: 642c 206d 6574 7269 635f 6361 6c6c 6261  d, metric_callba
+00005290: 636b 733d 6d65 7472 6963 5f63 616c 6c62  cks=metric_callb
+000052a0: 6163 6b73 290a 0a20 2020 2020 2020 2020  acks)..         
+000052b0: 2020 2065 6c69 6620 6461 7461 5f72 6561     elif data_rea
+000052c0: 6465 722e 6461 7461 5f66 6f72 6d61 7420  der.data_format 
+000052d0: 3d3d 2027 6d65 6633 273a 0a20 2020 2020  == 'mef3':.     
+000052e0: 2020 2020 2020 2020 2020 2023 204d 4546             # MEF
+000052f0: 3320 666f 726d 6174 0a0a 2020 2020 2020  3 format..      
+00005300: 2020 2020 2020 2020 2020 2320 6c6f 6164            # load
+00005310: 2074 6865 2064 6174 6120 6279 2066 6972   the data by fir
+00005320: 7374 2069 7465 7261 7469 6e67 206f 7665  st iterating ove
+00005330: 7220 636f 6e64 6974 696f 6e73 2c20 7365  r conditions, se
+00005340: 636f 6e64 206f 7665 7220 7472 6961 6c73  cond over trials
+00005350: 2077 6974 6869 6e20 7468 6174 2063 6f6e   within that con
+00005360: 6469 7469 6f6e 2061 6e64 2074 6865 6e0a  dition and then.
+00005370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005380: 2320 7265 7472 6965 7665 2074 6865 2065  # retrieve the e
+00005390: 706f 6368 2d64 6174 6120 666f 7220 616c  poch-data for al
+000053a0: 6c20 6368 616e 6e65 6c73 2061 6e64 2074  l channels and t
+000053b0: 616b 6520 6176 6572 6167 6520 2861 6e64  ake average (and
+000053c0: 206d 6574 7269 6329 2066 6f72 2065 6163   metric) for eac
+000053d0: 6820 6368 616e 6e65 6c2e 0a20 2020 2020  h channel..     
+000053e0: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+000053f0: 2020 2020 2020 2020 2020 2020 2023 2046               # F
+00005400: 6f72 204d 4546 3320 7468 6973 2069 7320  or MEF3 this is 
+00005410: 7468 6520 6661 7374 6573 7420 736f 6c75  the fastest solu
+00005420: 7469 6f6e 2077 6869 6c65 2075 7369 6e67  tion while using
+00005430: 2061 2073 6d61 6c6c 2061 6d6f 756e 7420   a small amount 
+00005440: 6f66 206d 656d 6f72 7920 2862 6563 6175  of memory (becau
+00005450: 7365 206f 6e6c 7920 7468 6520 7265 7175  se only the requ
+00005460: 6972 6564 2064 6174 6120 6973 206c 6f61  ired data is loa
+00005470: 6465 6429 0a20 2020 2020 2020 2020 2020  ded).           
+00005480: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
+00005490: 2020 2020 2020 2073 616d 706c 696e 675f         sampling_
+000054a0: 7261 7465 2c20 6461 7461 2c20 6d65 7472  rate, data, metr
+000054b0: 6963 5f76 616c 7565 7320 3d20 5f5f 6c6f  ic_values = __lo
+000054c0: 6164 5f64 6174 615f 6570 6f63 685f 6176  ad_data_epoch_av
+000054d0: 6572 6167 6573 5f5f 6279 5f63 6f6e 6469  erages__by_condi
+000054e0: 7469 6f6e 5f74 7269 616c 2864 6174 615f  tion_trial(data_
+000054f0: 7265 6164 6572 2c20 7265 7472 6965 7665  reader, retrieve
+00005500: 5f63 6861 6e6e 656c 732c 2063 6f6e 6469  _channels, condi
+00005510: 7469 6f6e 735f 6f6e 7365 7473 2c0a 2020  tions_onsets,.  
 00005520: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005530: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005540: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005550: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005570: 2020 2020 2074 7269 616c 5f65 706f 6368       trial_epoch
-00005580: 3d74 7269 616c 5f65 706f 6368 2c0a 2020  =trial_epoch,.  
-00005590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005580: 2020 7472 6961 6c5f 6570 6f63 683d 7472    trial_epoch=tr
+00005590: 6961 6c5f 6570 6f63 682c 0a20 2020 2020  ial_epoch,.     
 000055a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000055b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000055c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000055d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000055e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000055f0: 2020 6261 7365 6c69 6e65 5f6d 6574 686f    baseline_metho
-00005600: 643d 6261 7365 6c69 6e65 5f6d 6574 686f  d=baseline_metho
-00005610: 642c 2062 6173 656c 696e 655f 6570 6f63  d, baseline_epoc
-00005620: 683d 6261 7365 6c69 6e65 5f65 706f 6368  h=baseline_epoch
-00005630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000055f0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00005600: 6173 656c 696e 655f 6d65 7468 6f64 3d62  aseline_method=b
+00005610: 6173 656c 696e 655f 6d65 7468 6f64 2c20  aseline_method, 
+00005620: 6261 7365 6c69 6e65 5f65 706f 6368 3d62  baseline_epoch=b
+00005630: 6173 656c 696e 655f 6570 6f63 682c 0a20  aseline_epoch,. 
 00005640: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005650: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005660: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005670: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00005680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005690: 2020 2020 2020 6f75 745f 6f66 5f62 6f75        out_of_bou
-000056a0: 6e64 5f6d 6574 686f 643d 6f75 745f 6f66  nd_method=out_of
-000056b0: 5f62 6f75 6e64 5f6d 6574 686f 642c 206d  _bound_method, m
-000056c0: 6574 7269 635f 6361 6c6c 6261 636b 733d  etric_callbacks=
-000056d0: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
-000056e0: 290a 0a20 2020 2065 7863 6570 7420 4578  )..    except Ex
-000056f0: 6365 7074 696f 6e20 6173 2065 3a0a 2020  ception as e:.  
-00005700: 2020 2020 2020 6c6f 6767 696e 672e 6572        logging.er
-00005710: 726f 7228 2745 7272 6f72 206f 6e20 6c6f  ror('Error on lo
-00005720: 6164 696e 672c 2065 706f 6368 696e 6720  ading, epoching 
-00005730: 616e 6420 6176 6572 6167 696e 6720 6461  and averaging da
-00005740: 7461 3a20 2720 2b20 7374 7228 6529 290a  ta: ' + str(e)).
-00005750: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00005760: 6e74 696d 6545 7272 6f72 2827 4572 726f  ntimeError('Erro
-00005770: 7220 6f6e 206c 6f61 6469 6e67 2c20 6570  r on loading, ep
-00005780: 6f63 6869 6e67 2061 6e64 2061 7665 7261  oching and avera
-00005790: 6769 6e67 2064 6174 6127 290a 0a20 2020  ging data')..   
-000057a0: 2023 2063 6c6f 7365 2028 616e 6420 756e   # close (and un
-000057b0: 6c6f 6164 2920 7468 6520 6461 7461 2072  load) the data r
-000057c0: 6561 6465 720a 2020 2020 6461 7461 5f72  eader.    data_r
-000057d0: 6561 6465 722e 636c 6f73 6528 290a 0a20  eader.close().. 
-000057e0: 2020 2023 2072 6574 7572 6e20 7375 6363     # return succ
-000057f0: 6573 730a 2020 2020 7265 7475 726e 2073  ess.    return s
-00005800: 616d 706c 696e 675f 7261 7465 2c20 6461  ampling_rate, da
-00005810: 7461 2c20 6d65 7472 6963 5f76 616c 7565  ta, metric_value
-00005820: 730a 0a0a 0a23 0a23 2070 7269 7661 7465  s....#.# private
-00005830: 2066 756e 6374 696f 6e73 0a23 0a0a 6465   functions.#..de
-00005840: 6620 5f5f 7072 6570 6172 655f 696e 7075  f __prepare_inpu
-00005850: 7428 6461 7461 5f70 6174 682c 2074 7269  t(data_path, tri
-00005860: 616c 5f65 706f 6368 2c20 6261 7365 6c69  al_epoch, baseli
-00005870: 6e65 5f6e 6f72 6d2c 2062 6173 656c 696e  ne_norm, baselin
-00005880: 655f 6570 6f63 682c 206f 7574 5f6f 665f  e_epoch, out_of_
-00005890: 626f 756e 645f 6861 6e64 6c69 6e67 2c20  bound_handling, 
-000058a0: 7072 6570 726f 635f 7072 696f 7269 7479  preproc_priority
-000058b0: 293a 0a20 2020 2022 2222 0a20 2020 2043  ):.    """.    C
-000058c0: 6865 636b 2061 6e64 2070 7265 7061 7265  heck and prepare
-000058d0: 2074 6865 2069 6e70 7574 2066 6f72 206c   the input for l
-000058e0: 6f61 6469 6e67 2064 6174 610a 0a20 2020  oading data..   
-000058f0: 2070 7265 7072 6f63 5f70 7269 6f72 6974   preproc_priorit
-00005900: 7920 2873 7472 293a 2020 2020 2020 2020  y (str):        
-00005910: 2020 2020 2020 5365 7420 7468 6520 7072        Set the pr
-00005920: 6570 726f 6365 7373 696e 6720 7072 696f  eprocessing prio
-00005930: 7269 7479 2c20 6361 6e20 6265 2073 6574  rity, can be set
-00005940: 2074 6f20 6569 7468 6572 2027 6d65 6d27   to either 'mem'
-00005950: 2028 6465 6661 756c 7429 206f 7220 2773   (default) or 's
-00005960: 7065 6564 270a 2020 2020 2222 220a 0a20  peed'.    """.. 
-00005970: 2020 2023 2064 6174 612d 7365 7420 666f     # data-set fo
-00005980: 726d 6174 0a20 2020 2064 6174 615f 6578  rmat.    data_ex
-00005990: 7465 6e73 696f 6e20 3d20 6461 7461 5f70  tension = data_p
-000059a0: 6174 685b 6461 7461 5f70 6174 682e 7269  ath[data_path.ri
-000059b0: 6e64 6578 2822 2e22 293a 5d0a 2020 2020  ndex("."):].    
-000059c0: 6966 206e 6f74 2061 6e79 2864 6174 615f  if not any(data_
-000059d0: 6578 7465 6e73 696f 6e20 696e 2078 2066  extension in x f
-000059e0: 6f72 2078 2069 6e20 5641 4c49 445f 464f  or x in VALID_FO
-000059f0: 524d 4154 5f45 5854 454e 5349 4f4e 5329  RMAT_EXTENSIONS)
-00005a00: 3a0a 2020 2020 2020 2020 6c6f 6767 696e  :.        loggin
-00005a10: 672e 6572 726f 7228 2755 6e6b 6e6f 776e  g.error('Unknown
-00005a20: 2064 6174 6120 666f 726d 6174 2028 2720   data format (' 
-00005a30: 2b20 6461 7461 5f65 7874 656e 7369 6f6e  + data_extension
-00005a40: 202b 2027 2927 290a 2020 2020 2020 2020   + ')').        
-00005a50: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00005a60: 2827 556e 6b6e 6f77 6e20 6461 7461 2066  ('Unknown data f
-00005a70: 6f72 6d61 7420 2827 202b 2064 6174 615f  ormat (' + data_
-00005a80: 6578 7465 6e73 696f 6e20 2b20 2729 2729  extension + ')')
-00005a90: 0a0a 2020 2020 2320 6368 6563 6b20 7472  ..    # check tr
-00005aa0: 6961 6c20 6570 6f63 6820 696e 7075 740a  ial epoch input.
-00005ab0: 2020 2020 6966 2074 7269 616c 5f65 706f      if trial_epo
-00005ac0: 6368 5b31 5d20 3c20 7472 6961 6c5f 6570  ch[1] < trial_ep
-00005ad0: 6f63 685b 305d 3a0a 2020 2020 2020 2020  och[0]:.        
-00005ae0: 6c6f 6767 696e 672e 6572 726f 7228 2749  logging.error('I
-00005af0: 6e76 616c 6964 205c 2774 7269 616c 5f65  nvalid \'trial_e
-00005b00: 706f 6368 5c27 2070 6172 616d 6574 6572  poch\' parameter
-00005b10: 2c20 7468 6520 6769 7665 6e20 656e 642d  , the given end-
-00005b20: 706f 696e 7420 2861 7420 2720 2b20 7374  point (at ' + st
-00005b30: 7228 7472 6961 6c5f 6570 6f63 685b 315d  r(trial_epoch[1]
-00005b40: 2920 2b20 2729 206c 6965 7320 6265 666f  ) + ') lies befo
-00005b50: 7265 2074 6865 2073 7461 7274 2d70 6f69  re the start-poi
-00005b60: 6e74 2028 6174 2027 202b 2073 7472 2874  nt (at ' + str(t
-00005b70: 7269 616c 5f65 706f 6368 5b30 5d29 202b  rial_epoch[0]) +
-00005b80: 2027 2927 290a 2020 2020 2020 2020 7261   ')').        ra
-00005b90: 6973 6520 5661 6c75 6545 7272 6f72 2827  ise ValueError('
-00005ba0: 496e 7661 6c69 6420 5c27 7472 6961 6c5f  Invalid \'trial_
-00005bb0: 6570 6f63 685c 2720 7061 7261 6d65 7465  epoch\' paramete
-00005bc0: 7227 290a 0a20 2020 2023 2063 7265 6174  r')..    # creat
-00005bd0: 6520 616e 6420 696e 6974 6961 6c69 7a65  e and initialize
-00005be0: 2061 6e20 4945 4547 2064 6174 612d 7265   an IEEG data-re
-00005bf0: 6164 6572 2069 6e73 7461 6e63 6520 746f  ader instance to
-00005c00: 206d 616e 6167 6520 7468 6520 6461 7461   manage the data
-00005c10: 2e0a 2020 2020 7472 793a 0a20 2020 2020  ..    try:.     
-00005c20: 2020 2064 6174 615f 7265 6164 6572 203d     data_reader =
-00005c30: 2049 6565 6744 6174 6152 6561 6465 7228   IeegDataReader(
-00005c40: 6461 7461 5f70 6174 682c 2070 7265 7072  data_path, prepr
-00005c50: 6f63 5f70 7269 6f72 6974 7920 3d3d 2027  oc_priority == '
-00005c60: 7370 6565 6427 290a 2020 2020 6578 6365  speed').    exce
-00005c70: 7074 2056 616c 7565 4572 726f 723a 0a20  pt ValueError:. 
-00005c80: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00005c90: 7565 4572 726f 7228 2745 7272 6f72 2075  ueError('Error u
-00005ca0: 706f 6e20 636f 6e73 7472 7563 7469 6e67  pon constructing
-00005cb0: 2061 2064 6174 6120 7265 6164 6572 2729   a data reader')
-00005cc0: 0a20 2020 2065 7863 6570 7420 5275 6e74  .    except Runt
-00005cd0: 696d 6545 7272 6f72 3a0a 2020 2020 2020  imeError:.      
-00005ce0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-00005cf0: 7272 6f72 2827 4572 726f 7220 7570 6f6e  rror('Error upon
-00005d00: 2069 6e69 7469 616c 697a 696e 6720 6120   initializing a 
-00005d10: 6461 7461 2072 6561 6465 7227 290a 0a20  data reader').. 
-00005d20: 2020 2023 2062 6173 656c 696e 6520 6e6f     # baseline no
-00005d30: 726d 616c 697a 6174 696f 6e0a 2020 2020  rmalization.    
-00005d40: 6261 7365 6c69 6e65 5f6d 6574 686f 6420  baseline_method 
-00005d50: 3d20 300a 2020 2020 6966 2062 6173 656c  = 0.    if basel
-00005d60: 696e 655f 6e6f 726d 2069 7320 6e6f 7420  ine_norm is not 
-00005d70: 4e6f 6e65 2061 6e64 206c 656e 2862 6173  None and len(bas
-00005d80: 656c 696e 655f 6e6f 726d 2920 3e20 303a  eline_norm) > 0:
-00005d90: 0a20 2020 2020 2020 2069 6620 6261 7365  .        if base
-00005da0: 6c69 6e65 5f6e 6f72 6d2e 6c6f 7765 7228  line_norm.lower(
-00005db0: 2920 3d3d 2027 6d65 616e 2720 6f72 2062  ) == 'mean' or b
-00005dc0: 6173 656c 696e 655f 6e6f 726d 2e6c 6f77  aseline_norm.low
-00005dd0: 6572 2829 203d 3d20 2761 7665 7261 6765  er() == 'average
-00005de0: 273a 0a20 2020 2020 2020 2020 2020 2062  ':.            b
-00005df0: 6173 656c 696e 655f 6d65 7468 6f64 203d  aseline_method =
-00005e00: 2031 0a20 2020 2020 2020 2065 6c69 6620   1.        elif 
-00005e10: 6261 7365 6c69 6e65 5f6e 6f72 6d2e 6c6f  baseline_norm.lo
-00005e20: 7765 7228 2920 3d3d 2027 6d65 6469 616e  wer() == 'median
-00005e30: 273a 0a20 2020 2020 2020 2020 2020 2062  ':.            b
-00005e40: 6173 656c 696e 655f 6d65 7468 6f64 203d  aseline_method =
-00005e50: 2032 0a20 2020 2020 2020 2065 6c69 6620   2.        elif 
-00005e60: 6261 7365 6c69 6e65 5f6e 6f72 6d2e 6c6f  baseline_norm.lo
-00005e70: 7765 7228 2920 3d3d 2027 6e6f 6e65 273a  wer() == 'none':
-00005e80: 0a20 2020 2020 2020 2020 2020 2062 6173  .            bas
-00005e90: 656c 696e 655f 6d65 7468 6f64 203d 2030  eline_method = 0
-00005ea0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00005eb0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
-00005ec0: 6e67 2e65 7272 6f72 2827 556e 6b6e 6f77  ng.error('Unknow
-00005ed0: 6e20 6e6f 726d 616c 697a 6174 696f 6e20  n normalization 
-00005ee0: 6172 6775 6d65 6e74 2028 2720 2b20 6261  argument (' + ba
-00005ef0: 7365 6c69 6e65 5f6e 6f72 6d20 2b20 2729  seline_norm + ')
-00005f00: 2c20 7468 6973 2063 616e 206f 6e6c 7920  , this can only 
-00005f10: 6265 206f 6e65 206f 6620 7468 6520 666f  be one of the fo
-00005f20: 6c6c 6f77 696e 6720 6f70 7469 6f6e 733a  llowing options:
-00005f30: 204e 6f6e 652c 205c 276d 6561 6e5c 2720   None, \'mean\' 
-00005f40: 6f72 205c 276d 6564 6961 6e5c 2727 290a  or \'median\'').
-00005f50: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00005f60: 6520 5661 6c75 6545 7272 6f72 2827 556e  e ValueError('Un
-00005f70: 6b6e 6f77 6e20 6e6f 726d 616c 697a 6174  known normalizat
-00005f80: 696f 6e20 6172 6775 6d65 6e74 2729 0a0a  ion argument')..
-00005f90: 2020 2020 2020 2020 230a 2020 2020 2020          #.      
-00005fa0: 2020 6966 2062 6173 656c 696e 655f 6570    if baseline_ep
-00005fb0: 6f63 685b 315d 203c 2062 6173 656c 696e  och[1] < baselin
-00005fc0: 655f 6570 6f63 685b 305d 3a0a 2020 2020  e_epoch[0]:.    
-00005fd0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00005fe0: 6572 726f 7228 2749 6e76 616c 6964 205c  error('Invalid \
-00005ff0: 2762 6173 656c 696e 655f 6570 6f63 685c  'baseline_epoch\
-00006000: 2720 7061 7261 6d65 7465 722c 2074 6865  ' parameter, the
-00006010: 2067 6976 656e 2065 6e64 2d70 6f69 6e74   given end-point
-00006020: 2028 6174 2027 202b 2073 7472 2862 6173   (at ' + str(bas
-00006030: 656c 696e 655f 6570 6f63 685b 315d 2920  eline_epoch[1]) 
-00006040: 2b20 2729 206c 6965 7320 6265 666f 7265  + ') lies before
-00006050: 2074 6865 2073 7461 7274 2d70 6f69 6e74   the start-point
-00006060: 2028 6174 2027 202b 2073 7472 2862 6173   (at ' + str(bas
-00006070: 656c 696e 655f 6570 6f63 685b 305d 2920  eline_epoch[0]) 
-00006080: 2b20 2729 2729 0a20 2020 2020 2020 2020  + ')').         
-00006090: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000060a0: 726f 7228 2749 6e76 616c 6964 205c 2762  ror('Invalid \'b
-000060b0: 6173 656c 696e 655f 6570 6f63 685c 2720  aseline_epoch\' 
-000060c0: 7061 7261 6d65 7465 7227 290a 0a20 2020  parameter')..   
-000060d0: 2020 2020 2069 6620 6461 7461 5f72 6561       if data_rea
-000060e0: 6465 722e 6461 7461 5f66 6f72 6d61 7420  der.data_format 
-000060f0: 3d3d 2027 6d65 6633 273a 0a20 2020 2020  == 'mef3':.     
-00006100: 2020 2020 2020 2069 6620 6261 7365 6c69         if baseli
-00006110: 6e65 5f65 706f 6368 5b30 5d20 3c20 7472  ne_epoch[0] < tr
-00006120: 6961 6c5f 6570 6f63 685b 305d 3a0a 2020  ial_epoch[0]:.  
-00006130: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00006140: 6767 696e 672e 6572 726f 7228 2749 6e76  gging.error('Inv
-00006150: 616c 6964 205c 2762 6173 656c 696e 655f  alid \'baseline_
-00006160: 6570 6f63 685c 2720 7061 7261 6d65 7465  epoch\' paramete
-00006170: 722c 2074 6865 2067 6976 656e 2062 6173  r, the given bas
-00006180: 656c 696e 6520 7374 6172 742d 706f 696e  eline start-poin
-00006190: 7420 2861 7420 2720 2b20 7374 7228 6261  t (at ' + str(ba
-000061a0: 7365 6c69 6e65 5f65 706f 6368 5b30 5d29  seline_epoch[0])
-000061b0: 202b 2027 2920 6c69 6573 2062 6566 6f72   + ') lies befor
-000061c0: 6520 7468 6520 7472 6961 6c20 7374 6172  e the trial star
-000061d0: 742d 706f 696e 7420 2861 7420 2720 2b20  t-point (at ' + 
-000061e0: 7374 7228 7472 6961 6c5f 6570 6f63 685b  str(trial_epoch[
-000061f0: 305d 2920 2b20 2729 2729 0a20 2020 2020  0]) + ')').     
-00006200: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00006210: 2056 616c 7565 4572 726f 7228 2749 6e76   ValueError('Inv
-00006220: 616c 6964 205c 2762 6173 656c 696e 655f  alid \'baseline_
-00006230: 6570 6f63 685c 2720 7061 7261 6d65 7465  epoch\' paramete
-00006240: 7227 290a 2020 2020 2020 2020 2020 2020  r').            
-00006250: 6966 2062 6173 656c 696e 655f 6570 6f63  if baseline_epoc
-00006260: 685b 315d 203e 2074 7269 616c 5f65 706f  h[1] > trial_epo
-00006270: 6368 5b31 5d3a 0a20 2020 2020 2020 2020  ch[1]:.         
-00006280: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
-00006290: 7272 6f72 2827 496e 7661 6c69 6420 5c27  rror('Invalid \'
-000062a0: 6261 7365 6c69 6e65 5f65 706f 6368 5c27  baseline_epoch\'
-000062b0: 2070 6172 616d 6574 6572 2c20 7468 6520   parameter, the 
-000062c0: 6769 7665 6e20 6261 7365 6c69 6e65 2065  given baseline e
-000062d0: 6e64 2d70 6f69 6e74 2028 6174 2027 202b  nd-point (at ' +
-000062e0: 2073 7472 2862 6173 656c 696e 655f 6570   str(baseline_ep
-000062f0: 6f63 685b 315d 2920 2b20 2729 206c 6965  och[1]) + ') lie
-00006300: 7320 6166 7465 7220 7468 6520 7472 6961  s after the tria
-00006310: 6c20 656e 642d 706f 696e 7420 2861 7420  l end-point (at 
-00006320: 2720 2b20 7374 7228 7472 6961 6c5f 6570  ' + str(trial_ep
-00006330: 6f63 685b 315d 2920 2b20 2729 2729 0a20  och[1]) + ')'). 
-00006340: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00006350: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00006360: 2749 6e76 616c 6964 205c 2762 6173 656c  'Invalid \'basel
-00006370: 696e 655f 6570 6f63 685c 2720 7061 7261  ine_epoch\' para
-00006380: 6d65 7465 7227 290a 0a20 2020 2023 206f  meter')..    # o
-00006390: 7574 2d6f 662d 626f 756e 6420 6861 6e64  ut-of-bound hand
-000063a0: 6c69 6e67 0a20 2020 2069 6620 6f75 745f  ling.    if out_
-000063b0: 6f66 5f62 6f75 6e64 5f68 616e 646c 696e  of_bound_handlin
-000063c0: 672e 6c6f 7765 7228 2920 3d3d 2027 6669  g.lower() == 'fi
-000063d0: 7273 745f 6c61 7374 5f6f 6e6c 7927 3a0a  rst_last_only':.
-000063e0: 2020 2020 2020 2020 6f75 745f 6f66 5f62          out_of_b
-000063f0: 6f75 6e64 5f6d 6574 686f 6420 3d20 310a  ound_method = 1.
-00006400: 2020 2020 656c 6966 206f 7574 5f6f 665f      elif out_of_
-00006410: 626f 756e 645f 6861 6e64 6c69 6e67 2e6c  bound_handling.l
-00006420: 6f77 6572 2829 203d 3d20 2761 6c6c 6f77  ower() == 'allow
-00006430: 273a 0a20 2020 2020 2020 206f 7574 5f6f  ':.        out_o
-00006440: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
-00006450: 2032 0a20 2020 2065 6c69 6620 6f75 745f   2.    elif out_
-00006460: 6f66 5f62 6f75 6e64 5f68 616e 646c 696e  of_bound_handlin
-00006470: 672e 6c6f 7765 7228 2920 3d3d 2027 6572  g.lower() == 'er
-00006480: 726f 7227 3a0a 2020 2020 2020 2020 6f75  ror':.        ou
-00006490: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
-000064a0: 6420 3d20 300a 2020 2020 656c 7365 3a0a  d = 0.    else:.
-000064b0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-000064c0: 6572 726f 7228 2755 6e6b 6e6f 776e 206f  error('Unknown o
-000064d0: 7574 2d6f 662d 626f 756e 6420 6861 6e64  ut-of-bound hand
-000064e0: 6c69 6e67 2061 7267 756d 656e 7420 2827  ling argument ('
-000064f0: 202b 206f 7574 5f6f 665f 626f 756e 645f   + out_of_bound_
-00006500: 6861 6e64 6c69 6e67 202b 2027 292c 2074  handling + '), t
-00006510: 6869 7320 6361 6e20 6f6e 6c79 2062 6520  his can only be 
-00006520: 6f6e 6520 6f66 2074 6865 2066 6f6c 6c6f  one of the follo
-00006530: 7769 6e67 206f 7074 696f 6e73 3a20 5c27  wing options: \'
-00006540: 6572 726f 725c 272c 205c 2766 6972 7374  error\', \'first
-00006550: 5f6c 6173 745f 6f6e 6c79 5c27 206f 7220  _last_only\' or 
-00006560: 5c27 616c 6c6f 775c 2727 290a 2020 2020  \'allow\'').    
-00006570: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00006580: 7272 6f72 2827 556e 6b6e 6f77 6e20 6f75  rror('Unknown ou
-00006590: 742d 6f66 2d62 6f75 6e64 2068 616e 646c  t-of-bound handl
-000065a0: 696e 6720 6172 6775 6d65 6e74 2729 0a0a  ing argument')..
-000065b0: 2020 2020 7265 7475 726e 2064 6174 615f      return data_
-000065c0: 7265 6164 6572 2c20 6261 7365 6c69 6e65  reader, baseline
-000065d0: 5f6d 6574 686f 642c 206f 7574 5f6f 665f  _method, out_of_
-000065e0: 626f 756e 645f 6d65 7468 6f64 0a0a 0a64  bound_method...d
-000065f0: 6566 205f 5f65 706f 6368 5f64 6174 615f  ef __epoch_data_
-00006600: 5f66 726f 6d5f 6368 616e 6e65 6c5f 6461  _from_channel_da
-00006610: 7461 5f5f 6279 5f74 7269 616c 7328 7265  ta__by_trials(re
-00006620: 665f 6461 7461 2c20 6368 616e 6e65 6c5f  f_data, channel_
-00006630: 6964 782c 2063 6861 6e6e 656c 5f64 6174  idx, channel_dat
-00006640: 612c 2073 616d 706c 696e 675f 7261 7465  a, sampling_rate
-00006650: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00005690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000056a0: 2020 206f 7574 5f6f 665f 626f 756e 645f     out_of_bound_
+000056b0: 6d65 7468 6f64 3d6f 7574 5f6f 665f 626f  method=out_of_bo
+000056c0: 756e 645f 6d65 7468 6f64 2c20 6d65 7472  und_method, metr
+000056d0: 6963 5f63 616c 6c62 6163 6b73 3d6d 6574  ic_callbacks=met
+000056e0: 7269 635f 6361 6c6c 6261 636b 7329 0a0a  ric_callbacks)..
+000056f0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00005700: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00005710: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
+00005720: 2827 4572 726f 7220 6f6e 206c 6f61 6469  ('Error on loadi
+00005730: 6e67 2c20 6570 6f63 6869 6e67 2061 6e64  ng, epoching and
+00005740: 2061 7665 7261 6769 6e67 2064 6174 613a   averaging data:
+00005750: 2027 202b 2073 7472 2865 2929 0a20 2020   ' + str(e)).   
+00005760: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00005770: 6d65 4572 726f 7228 2745 7272 6f72 206f  meError('Error o
+00005780: 6e20 6c6f 6164 696e 672c 2065 706f 6368  n loading, epoch
+00005790: 696e 6720 616e 6420 6176 6572 6167 696e  ing and averagin
+000057a0: 6720 6461 7461 2729 0a0a 2020 2020 2320  g data')..    # 
+000057b0: 636c 6f73 6520 2861 6e64 2075 6e6c 6f61  close (and unloa
+000057c0: 6429 2074 6865 2064 6174 6120 7265 6164  d) the data read
+000057d0: 6572 0a20 2020 2064 6174 615f 7265 6164  er.    data_read
+000057e0: 6572 2e63 6c6f 7365 2829 0a0a 2020 2020  er.close()..    
+000057f0: 2320 7265 7475 726e 2073 7563 6365 7373  # return success
+00005800: 0a20 2020 2072 6574 7572 6e20 7361 6d70  .    return samp
+00005810: 6c69 6e67 5f72 6174 652c 2064 6174 612c  ling_rate, data,
+00005820: 206d 6574 7269 635f 7661 6c75 6573 0a0a   metric_values..
+00005830: 0a0a 230a 2320 7072 6976 6174 6520 6675  ..#.# private fu
+00005840: 6e63 7469 6f6e 730a 230a 0a64 6566 205f  nctions.#..def _
+00005850: 5f70 7265 7061 7265 5f69 6e70 7574 2864  _prepare_input(d
+00005860: 6174 615f 7061 7468 2c20 7472 6961 6c5f  ata_path, trial_
+00005870: 6570 6f63 682c 2062 6173 656c 696e 655f  epoch, baseline_
+00005880: 6e6f 726d 2c20 6261 7365 6c69 6e65 5f65  norm, baseline_e
+00005890: 706f 6368 2c20 6f75 745f 6f66 5f62 6f75  poch, out_of_bou
+000058a0: 6e64 5f68 616e 646c 696e 672c 2070 7265  nd_handling, pre
+000058b0: 7072 6f63 5f70 7269 6f72 6974 7929 3a0a  proc_priority):.
+000058c0: 2020 2020 2222 220a 2020 2020 4368 6563      """.    Chec
+000058d0: 6b20 616e 6420 7072 6570 6172 6520 7468  k and prepare th
+000058e0: 6520 696e 7075 7420 666f 7220 6c6f 6164  e input for load
+000058f0: 696e 6720 6461 7461 0a0a 2020 2020 7072  ing data..    pr
+00005900: 6570 726f 635f 7072 696f 7269 7479 2028  eproc_priority (
+00005910: 7374 7229 3a20 2020 2020 2020 2020 2020  str):           
+00005920: 2020 2053 6574 2074 6865 2070 7265 7072     Set the prepr
+00005930: 6f63 6573 7369 6e67 2070 7269 6f72 6974  ocessing priorit
+00005940: 792c 2063 616e 2062 6520 7365 7420 746f  y, can be set to
+00005950: 2065 6974 6865 7220 276d 656d 2720 2864   either 'mem' (d
+00005960: 6566 6175 6c74 2920 6f72 2027 7370 6565  efault) or 'spee
+00005970: 6427 0a20 2020 2022 2222 0a0a 2020 2020  d'.    """..    
+00005980: 2320 6461 7461 2d73 6574 2066 6f72 6d61  # data-set forma
+00005990: 740a 2020 2020 6461 7461 5f65 7874 656e  t.    data_exten
+000059a0: 7369 6f6e 203d 2064 6174 615f 7061 7468  sion = data_path
+000059b0: 5b64 6174 615f 7061 7468 2e72 696e 6465  [data_path.rinde
+000059c0: 7828 222e 2229 3a5d 0a20 2020 2069 6620  x("."):].    if 
+000059d0: 6e6f 7420 616e 7928 6461 7461 5f65 7874  not any(data_ext
+000059e0: 656e 7369 6f6e 2069 6e20 7820 666f 7220  ension in x for 
+000059f0: 7820 696e 2056 414c 4944 5f46 4f52 4d41  x in VALID_FORMA
+00005a00: 545f 4558 5445 4e53 494f 4e53 293a 0a20  T_EXTENSIONS):. 
+00005a10: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
+00005a20: 7272 6f72 2827 556e 6b6e 6f77 6e20 6461  rror('Unknown da
+00005a30: 7461 2066 6f72 6d61 7420 2827 202b 2064  ta format (' + d
+00005a40: 6174 615f 6578 7465 6e73 696f 6e20 2b20  ata_extension + 
+00005a50: 2729 2729 0a20 2020 2020 2020 2072 6169  ')').        rai
+00005a60: 7365 2056 616c 7565 4572 726f 7228 2755  se ValueError('U
+00005a70: 6e6b 6e6f 776e 2064 6174 6120 666f 726d  nknown data form
+00005a80: 6174 2028 2720 2b20 6461 7461 5f65 7874  at (' + data_ext
+00005a90: 656e 7369 6f6e 202b 2027 2927 290a 0a20  ension + ')').. 
+00005aa0: 2020 2023 2063 6865 636b 2074 7269 616c     # check trial
+00005ab0: 2065 706f 6368 2069 6e70 7574 0a20 2020   epoch input.   
+00005ac0: 2069 6620 7472 6961 6c5f 6570 6f63 685b   if trial_epoch[
+00005ad0: 315d 203c 2074 7269 616c 5f65 706f 6368  1] < trial_epoch
+00005ae0: 5b30 5d3a 0a20 2020 2020 2020 206c 6f67  [0]:.        log
+00005af0: 6769 6e67 2e65 7272 6f72 2827 496e 7661  ging.error('Inva
+00005b00: 6c69 6420 5c27 7472 6961 6c5f 6570 6f63  lid \'trial_epoc
+00005b10: 685c 2720 7061 7261 6d65 7465 722c 2074  h\' parameter, t
+00005b20: 6865 2067 6976 656e 2065 6e64 2d70 6f69  he given end-poi
+00005b30: 6e74 2028 6174 2027 202b 2073 7472 2874  nt (at ' + str(t
+00005b40: 7269 616c 5f65 706f 6368 5b31 5d29 202b  rial_epoch[1]) +
+00005b50: 2027 2920 6c69 6573 2062 6566 6f72 6520   ') lies before 
+00005b60: 7468 6520 7374 6172 742d 706f 696e 7420  the start-point 
+00005b70: 2861 7420 2720 2b20 7374 7228 7472 6961  (at ' + str(tria
+00005b80: 6c5f 6570 6f63 685b 305d 2920 2b20 2729  l_epoch[0]) + ')
+00005b90: 2729 0a20 2020 2020 2020 2072 6169 7365  ').        raise
+00005ba0: 2056 616c 7565 4572 726f 7228 2749 6e76   ValueError('Inv
+00005bb0: 616c 6964 205c 2774 7269 616c 5f65 706f  alid \'trial_epo
+00005bc0: 6368 5c27 2070 6172 616d 6574 6572 2729  ch\' parameter')
+00005bd0: 0a0a 2020 2020 2320 6372 6561 7465 2061  ..    # create a
+00005be0: 6e64 2069 6e69 7469 616c 697a 6520 616e  nd initialize an
+00005bf0: 2049 4545 4720 6461 7461 2d72 6561 6465   IEEG data-reade
+00005c00: 7220 696e 7374 616e 6365 2074 6f20 6d61  r instance to ma
+00005c10: 6e61 6765 2074 6865 2064 6174 612e 0a20  nage the data.. 
+00005c20: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00005c30: 6461 7461 5f72 6561 6465 7220 3d20 4965  data_reader = Ie
+00005c40: 6567 4461 7461 5265 6164 6572 2864 6174  egDataReader(dat
+00005c50: 615f 7061 7468 2c20 7072 6570 726f 635f  a_path, preproc_
+00005c60: 7072 696f 7269 7479 203d 3d20 2773 7065  priority == 'spe
+00005c70: 6564 2729 0a20 2020 2065 7863 6570 7420  ed').    except 
+00005c80: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
+00005c90: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00005ca0: 7272 6f72 2827 4572 726f 7220 7570 6f6e  rror('Error upon
+00005cb0: 2063 6f6e 7374 7275 6374 696e 6720 6120   constructing a 
+00005cc0: 6461 7461 2072 6561 6465 7227 290a 2020  data reader').  
+00005cd0: 2020 6578 6365 7074 2052 756e 7469 6d65    except Runtime
+00005ce0: 4572 726f 723a 0a20 2020 2020 2020 2072  Error:.        r
+00005cf0: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00005d00: 7228 2745 7272 6f72 2075 706f 6e20 696e  r('Error upon in
+00005d10: 6974 6961 6c69 7a69 6e67 2061 2064 6174  itializing a dat
+00005d20: 6120 7265 6164 6572 2729 0a0a 2020 2020  a reader')..    
+00005d30: 2320 6261 7365 6c69 6e65 206e 6f72 6d61  # baseline norma
+00005d40: 6c69 7a61 7469 6f6e 0a20 2020 2062 6173  lization.    bas
+00005d50: 656c 696e 655f 6d65 7468 6f64 203d 2030  eline_method = 0
+00005d60: 0a20 2020 2069 6620 6261 7365 6c69 6e65  .    if baseline
+00005d70: 5f6e 6f72 6d20 6973 206e 6f74 204e 6f6e  _norm is not Non
+00005d80: 6520 616e 6420 6c65 6e28 6261 7365 6c69  e and len(baseli
+00005d90: 6e65 5f6e 6f72 6d29 203e 2030 3a0a 2020  ne_norm) > 0:.  
+00005da0: 2020 2020 2020 6966 2062 6173 656c 696e        if baselin
+00005db0: 655f 6e6f 726d 2e6c 6f77 6572 2829 203d  e_norm.lower() =
+00005dc0: 3d20 276d 6561 6e27 206f 7220 6261 7365  = 'mean' or base
+00005dd0: 6c69 6e65 5f6e 6f72 6d2e 6c6f 7765 7228  line_norm.lower(
+00005de0: 2920 3d3d 2027 6176 6572 6167 6527 3a0a  ) == 'average':.
+00005df0: 2020 2020 2020 2020 2020 2020 6261 7365              base
+00005e00: 6c69 6e65 5f6d 6574 686f 6420 3d20 310a  line_method = 1.
+00005e10: 2020 2020 2020 2020 656c 6966 2062 6173          elif bas
+00005e20: 656c 696e 655f 6e6f 726d 2e6c 6f77 6572  eline_norm.lower
+00005e30: 2829 203d 3d20 276d 6564 6961 6e27 3a0a  () == 'median':.
+00005e40: 2020 2020 2020 2020 2020 2020 6261 7365              base
+00005e50: 6c69 6e65 5f6d 6574 686f 6420 3d20 320a  line_method = 2.
+00005e60: 2020 2020 2020 2020 656c 6966 2062 6173          elif bas
+00005e70: 656c 696e 655f 6e6f 726d 2e6c 6f77 6572  eline_norm.lower
+00005e80: 2829 203d 3d20 276e 6f6e 6527 3a0a 2020  () == 'none':.  
+00005e90: 2020 2020 2020 2020 2020 6261 7365 6c69            baseli
+00005ea0: 6e65 5f6d 6574 686f 6420 3d20 300a 2020  ne_method = 0.  
+00005eb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00005ec0: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
+00005ed0: 6572 726f 7228 2755 6e6b 6e6f 776e 206e  error('Unknown n
+00005ee0: 6f72 6d61 6c69 7a61 7469 6f6e 2061 7267  ormalization arg
+00005ef0: 756d 656e 7420 2827 202b 2062 6173 656c  ument (' + basel
+00005f00: 696e 655f 6e6f 726d 202b 2027 292c 2074  ine_norm + '), t
+00005f10: 6869 7320 6361 6e20 6f6e 6c79 2062 6520  his can only be 
+00005f20: 6f6e 6520 6f66 2074 6865 2066 6f6c 6c6f  one of the follo
+00005f30: 7769 6e67 206f 7074 696f 6e73 3a20 4e6f  wing options: No
+00005f40: 6e65 2c20 5c27 6d65 616e 5c27 206f 7220  ne, \'mean\' or 
+00005f50: 5c27 6d65 6469 616e 5c27 2729 0a20 2020  \'median\'').   
+00005f60: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00005f70: 616c 7565 4572 726f 7228 2755 6e6b 6e6f  alueError('Unkno
+00005f80: 776e 206e 6f72 6d61 6c69 7a61 7469 6f6e  wn normalization
+00005f90: 2061 7267 756d 656e 7427 290a 0a20 2020   argument')..   
+00005fa0: 2020 2020 2023 0a20 2020 2020 2020 2069       #.        i
+00005fb0: 6620 6261 7365 6c69 6e65 5f65 706f 6368  f baseline_epoch
+00005fc0: 5b31 5d20 3c20 6261 7365 6c69 6e65 5f65  [1] < baseline_e
+00005fd0: 706f 6368 5b30 5d3a 0a20 2020 2020 2020  poch[0]:.       
+00005fe0: 2020 2020 206c 6f67 6769 6e67 2e65 7272       logging.err
+00005ff0: 6f72 2827 496e 7661 6c69 6420 5c27 6261  or('Invalid \'ba
+00006000: 7365 6c69 6e65 5f65 706f 6368 5c27 2070  seline_epoch\' p
+00006010: 6172 616d 6574 6572 2c20 7468 6520 6769  arameter, the gi
+00006020: 7665 6e20 656e 642d 706f 696e 7420 2861  ven end-point (a
+00006030: 7420 2720 2b20 7374 7228 6261 7365 6c69  t ' + str(baseli
+00006040: 6e65 5f65 706f 6368 5b31 5d29 202b 2027  ne_epoch[1]) + '
+00006050: 2920 6c69 6573 2062 6566 6f72 6520 7468  ) lies before th
+00006060: 6520 7374 6172 742d 706f 696e 7420 2861  e start-point (a
+00006070: 7420 2720 2b20 7374 7228 6261 7365 6c69  t ' + str(baseli
+00006080: 6e65 5f65 706f 6368 5b30 5d29 202b 2027  ne_epoch[0]) + '
+00006090: 2927 290a 2020 2020 2020 2020 2020 2020  )').            
+000060a0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000060b0: 2827 496e 7661 6c69 6420 5c27 6261 7365  ('Invalid \'base
+000060c0: 6c69 6e65 5f65 706f 6368 5c27 2070 6172  line_epoch\' par
+000060d0: 616d 6574 6572 2729 0a0a 2020 2020 2020  ameter')..      
+000060e0: 2020 6966 2064 6174 615f 7265 6164 6572    if data_reader
+000060f0: 2e64 6174 615f 666f 726d 6174 203d 3d20  .data_format == 
+00006100: 276d 6566 3327 3a0a 2020 2020 2020 2020  'mef3':.        
+00006110: 2020 2020 6966 2062 6173 656c 696e 655f      if baseline_
+00006120: 6570 6f63 685b 305d 203c 2074 7269 616c  epoch[0] < trial
+00006130: 5f65 706f 6368 5b30 5d3a 0a20 2020 2020  _epoch[0]:.     
+00006140: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00006150: 6e67 2e65 7272 6f72 2827 496e 7661 6c69  ng.error('Invali
+00006160: 6420 5c27 6261 7365 6c69 6e65 5f65 706f  d \'baseline_epo
+00006170: 6368 5c27 2070 6172 616d 6574 6572 2c20  ch\' parameter, 
+00006180: 7468 6520 6769 7665 6e20 6261 7365 6c69  the given baseli
+00006190: 6e65 2073 7461 7274 2d70 6f69 6e74 2028  ne start-point (
+000061a0: 6174 2027 202b 2073 7472 2862 6173 656c  at ' + str(basel
+000061b0: 696e 655f 6570 6f63 685b 305d 2920 2b20  ine_epoch[0]) + 
+000061c0: 2729 206c 6965 7320 6265 666f 7265 2074  ') lies before t
+000061d0: 6865 2074 7269 616c 2073 7461 7274 2d70  he trial start-p
+000061e0: 6f69 6e74 2028 6174 2027 202b 2073 7472  oint (at ' + str
+000061f0: 2874 7269 616c 5f65 706f 6368 5b30 5d29  (trial_epoch[0])
+00006200: 202b 2027 2927 290a 2020 2020 2020 2020   + ')').        
+00006210: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00006220: 6c75 6545 7272 6f72 2827 496e 7661 6c69  lueError('Invali
+00006230: 6420 5c27 6261 7365 6c69 6e65 5f65 706f  d \'baseline_epo
+00006240: 6368 5c27 2070 6172 616d 6574 6572 2729  ch\' parameter')
+00006250: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00006260: 6261 7365 6c69 6e65 5f65 706f 6368 5b31  baseline_epoch[1
+00006270: 5d20 3e20 7472 6961 6c5f 6570 6f63 685b  ] > trial_epoch[
+00006280: 315d 3a0a 2020 2020 2020 2020 2020 2020  1]:.            
+00006290: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
+000062a0: 7228 2749 6e76 616c 6964 205c 2762 6173  r('Invalid \'bas
+000062b0: 656c 696e 655f 6570 6f63 685c 2720 7061  eline_epoch\' pa
+000062c0: 7261 6d65 7465 722c 2074 6865 2067 6976  rameter, the giv
+000062d0: 656e 2062 6173 656c 696e 6520 656e 642d  en baseline end-
+000062e0: 706f 696e 7420 2861 7420 2720 2b20 7374  point (at ' + st
+000062f0: 7228 6261 7365 6c69 6e65 5f65 706f 6368  r(baseline_epoch
+00006300: 5b31 5d29 202b 2027 2920 6c69 6573 2061  [1]) + ') lies a
+00006310: 6674 6572 2074 6865 2074 7269 616c 2065  fter the trial e
+00006320: 6e64 2d70 6f69 6e74 2028 6174 2027 202b  nd-point (at ' +
+00006330: 2073 7472 2874 7269 616c 5f65 706f 6368   str(trial_epoch
+00006340: 5b31 5d29 202b 2027 2927 290a 2020 2020  [1]) + ')').    
+00006350: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00006360: 6520 5661 6c75 6545 7272 6f72 2827 496e  e ValueError('In
+00006370: 7661 6c69 6420 5c27 6261 7365 6c69 6e65  valid \'baseline
+00006380: 5f65 706f 6368 5c27 2070 6172 616d 6574  _epoch\' paramet
+00006390: 6572 2729 0a0a 2020 2020 2320 6f75 742d  er')..    # out-
+000063a0: 6f66 2d62 6f75 6e64 2068 616e 646c 696e  of-bound handlin
+000063b0: 670a 2020 2020 6966 206f 7574 5f6f 665f  g.    if out_of_
+000063c0: 626f 756e 645f 6861 6e64 6c69 6e67 2e6c  bound_handling.l
+000063d0: 6f77 6572 2829 203d 3d20 2766 6972 7374  ower() == 'first
+000063e0: 5f6c 6173 745f 6f6e 6c79 273a 0a20 2020  _last_only':.   
+000063f0: 2020 2020 206f 7574 5f6f 665f 626f 756e       out_of_boun
+00006400: 645f 6d65 7468 6f64 203d 2031 0a20 2020  d_method = 1.   
+00006410: 2065 6c69 6620 6f75 745f 6f66 5f62 6f75   elif out_of_bou
+00006420: 6e64 5f68 616e 646c 696e 672e 6c6f 7765  nd_handling.lowe
+00006430: 7228 2920 3d3d 2027 616c 6c6f 7727 3a0a  r() == 'allow':.
+00006440: 2020 2020 2020 2020 6f75 745f 6f66 5f62          out_of_b
+00006450: 6f75 6e64 5f6d 6574 686f 6420 3d20 320a  ound_method = 2.
+00006460: 2020 2020 656c 6966 206f 7574 5f6f 665f      elif out_of_
+00006470: 626f 756e 645f 6861 6e64 6c69 6e67 2e6c  bound_handling.l
+00006480: 6f77 6572 2829 203d 3d20 2765 7272 6f72  ower() == 'error
+00006490: 273a 0a20 2020 2020 2020 206f 7574 5f6f  ':.        out_o
+000064a0: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
+000064b0: 2030 0a20 2020 2065 6c73 653a 0a20 2020   0.    else:.   
+000064c0: 2020 2020 206c 6f67 6769 6e67 2e65 7272       logging.err
+000064d0: 6f72 2827 556e 6b6e 6f77 6e20 6f75 742d  or('Unknown out-
+000064e0: 6f66 2d62 6f75 6e64 2068 616e 646c 696e  of-bound handlin
+000064f0: 6720 6172 6775 6d65 6e74 2028 2720 2b20  g argument (' + 
+00006500: 6f75 745f 6f66 5f62 6f75 6e64 5f68 616e  out_of_bound_han
+00006510: 646c 696e 6720 2b20 2729 2c20 7468 6973  dling + '), this
+00006520: 2063 616e 206f 6e6c 7920 6265 206f 6e65   can only be one
+00006530: 206f 6620 7468 6520 666f 6c6c 6f77 696e   of the followin
+00006540: 6720 6f70 7469 6f6e 733a 205c 2765 7272  g options: \'err
+00006550: 6f72 5c27 2c20 5c27 6669 7273 745f 6c61  or\', \'first_la
+00006560: 7374 5f6f 6e6c 795c 2720 6f72 205c 2761  st_only\' or \'a
+00006570: 6c6c 6f77 5c27 2729 0a20 2020 2020 2020  llow\'').       
+00006580: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00006590: 7228 2755 6e6b 6e6f 776e 206f 7574 2d6f  r('Unknown out-o
+000065a0: 662d 626f 756e 6420 6861 6e64 6c69 6e67  f-bound handling
+000065b0: 2061 7267 756d 656e 7427 290a 0a20 2020   argument')..   
+000065c0: 2072 6574 7572 6e20 6461 7461 5f72 6561   return data_rea
+000065d0: 6465 722c 2062 6173 656c 696e 655f 6d65  der, baseline_me
+000065e0: 7468 6f64 2c20 6f75 745f 6f66 5f62 6f75  thod, out_of_bou
+000065f0: 6e64 5f6d 6574 686f 640a 0a0a 6465 6620  nd_method...def 
+00006600: 5f5f 6570 6f63 685f 6461 7461 5f5f 6672  __epoch_data__fr
+00006610: 6f6d 5f63 6861 6e6e 656c 5f64 6174 615f  om_channel_data_
+00006620: 5f62 795f 7472 6961 6c73 2872 6566 5f64  _by_trials(ref_d
+00006630: 6174 612c 2063 6861 6e6e 656c 5f69 6478  ata, channel_idx
+00006640: 2c20 6368 616e 6e65 6c5f 6461 7461 2c20  , channel_data, 
+00006650: 7361 6d70 6c69 6e67 5f72 6174 652c 0a20  sampling_rate,. 
 00006660: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00006670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006680: 206f 6e73 6574 732c 2074 7269 616c 5f6e   onsets, trial_n
-00006690: 756d 5f73 616d 706c 6573 2c20 7472 6961  um_samples, tria
-000066a0: 6c5f 6570 6f63 682c 0a20 2020 2020 2020  l_epoch,.       
-000066b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006680: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+00006690: 7365 7473 2c20 7472 6961 6c5f 6e75 6d5f  sets, trial_num_
+000066a0: 7361 6d70 6c65 732c 2074 7269 616c 5f65  samples, trial_e
+000066b0: 706f 6368 2c0a 2020 2020 2020 2020 2020  poch,.          
 000066c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000066d0: 2020 2020 2020 2020 6261 7365 6c69 6e65          baseline
-000066e0: 5f6e 756d 5f73 616d 706c 6573 2c20 6261  _num_samples, ba
-000066f0: 7365 6c69 6e65 5f6d 6574 686f 642c 2062  seline_method, b
-00006700: 6173 656c 696e 655f 6570 6f63 682c 206f  aseline_epoch, o
-00006710: 7574 5f6f 665f 626f 756e 645f 6d65 7468  ut_of_bound_meth
-00006720: 6f64 293a 0a20 2020 2022 2222 0a20 2020  od):.    """.   
-00006730: 2045 706f 6368 2074 6865 2074 7269 616c   Epoch the trial
-00006740: 2d64 6174 6120 666f 7220 6120 7369 6e67  -data for a sing
-00006750: 6c65 2063 6861 6e6e 656c 2062 7920 6c6f  le channel by lo
-00006760: 6f70 696e 6720 6f76 6572 2074 6865 2074  oping over the t
-00006770: 7269 616c 2d6f 6e73 6574 730a 2020 2020  rial-onsets.    
-00006780: 2222 220a 0a20 2020 2023 206c 6f6f 7020  """..    # loop 
-00006790: 7468 726f 7567 6820 7468 6520 7472 6961  through the tria
-000067a0: 6c73 0a20 2020 2066 6f72 2074 7269 616c  ls.    for trial
-000067b0: 5f69 6478 2069 6e20 7261 6e67 6528 6c65  _idx in range(le
-000067c0: 6e28 6f6e 7365 7473 2929 3a0a 0a20 2020  n(onsets)):..   
-000067d0: 2020 2020 2023 2063 616c 6375 6c61 7465       # calculate
-000067e0: 2074 6865 2073 616d 706c 6520 696e 6469   the sample indi
-000067f0: 6365 730a 2020 2020 2020 2020 7472 6961  ces.        tria
-00006800: 6c5f 7361 6d70 6c65 5f73 7461 7274 203d  l_sample_start =
-00006810: 2069 6e74 2872 6f75 6e64 2828 6f6e 7365   int(round((onse
-00006820: 7473 5b74 7269 616c 5f69 6478 5d20 2b20  ts[trial_idx] + 
-00006830: 7472 6961 6c5f 6570 6f63 685b 305d 2920  trial_epoch[0]) 
-00006840: 2a20 7361 6d70 6c69 6e67 5f72 6174 6529  * sampling_rate)
-00006850: 290a 2020 2020 2020 2020 7472 6961 6c5f  ).        trial_
-00006860: 7361 6d70 6c65 5f65 6e64 203d 2074 7269  sample_end = tri
-00006870: 616c 5f73 616d 706c 655f 7374 6172 7420  al_sample_start 
-00006880: 2b20 7472 6961 6c5f 6e75 6d5f 7361 6d70  + trial_num_samp
-00006890: 6c65 730a 2020 2020 2020 2020 6261 7365  les.        base
-000068a0: 6c69 6e65 5f73 7461 7274 5f73 616d 706c  line_start_sampl
-000068b0: 6520 3d20 696e 7428 726f 756e 6428 286f  e = int(round((o
-000068c0: 6e73 6574 735b 7472 6961 6c5f 6964 785d  nsets[trial_idx]
-000068d0: 202b 2062 6173 656c 696e 655f 6570 6f63   + baseline_epoc
-000068e0: 685b 305d 2920 2a20 7361 6d70 6c69 6e67  h[0]) * sampling
-000068f0: 5f72 6174 6529 290a 2020 2020 2020 2020  _rate)).        
-00006900: 6261 7365 6c69 6e65 5f65 6e64 5f73 616d  baseline_end_sam
-00006910: 706c 6520 3d20 6261 7365 6c69 6e65 5f73  ple = baseline_s
-00006920: 7461 7274 5f73 616d 706c 6520 2b20 6261  tart_sample + ba
-00006930: 7365 6c69 6e65 5f6e 756d 5f73 616d 706c  seline_num_sampl
-00006940: 6573 0a20 2020 2020 2020 206c 6f63 616c  es.        local
-00006950: 5f73 7461 7274 203d 2030 0a20 2020 2020  _start = 0.     
-00006960: 2020 206c 6f63 616c 5f65 6e64 203d 2074     local_end = t
-00006970: 7269 616c 5f6e 756d 5f73 616d 706c 6573  rial_num_samples
-00006980: 0a0a 2020 2020 2020 2020 2320 6368 6563  ..        # chec
-00006990: 6b20 7768 6574 6865 7220 7468 6520 7472  k whether the tr
-000069a0: 6961 6c20 6570 6f63 6820 6973 2077 6974  ial epoch is wit
-000069b0: 6869 6e20 626f 756e 6473 0a20 2020 2020  hin bounds.     
-000069c0: 2020 2069 6620 7472 6961 6c5f 7361 6d70     if trial_samp
-000069d0: 6c65 5f65 6e64 203c 2030 3a0a 2020 2020  le_end < 0:.    
-000069e0: 2020 2020 2020 2020 6966 2028 6f75 745f          if (out_
-000069f0: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6420  of_bound_method 
-00006a00: 3d3d 2031 2061 6e64 2074 7269 616c 5f69  == 1 and trial_i
-00006a10: 6478 203d 3d20 3029 206f 7220 6f75 745f  dx == 0) or out_
-00006a20: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6420  of_bound_method 
-00006a30: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
-00006a40: 2020 2020 2020 6966 2063 6861 6e6e 656c        if channel
-00006a50: 5f69 6478 203d 3d20 303a 0a20 2020 2020  _idx == 0:.     
-00006a60: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00006a70: 6f67 6769 6e67 2e77 6172 6e69 6e67 2827  ogging.warning('
-00006a80: 4361 6e6e 6f74 2065 7874 7261 6374 2074  Cannot extract t
-00006a90: 6865 2074 7269 616c 2077 6974 6820 6f6e  he trial with on
-00006aa0: 7365 7420 2720 2b20 7374 7228 6f6e 7365  set ' + str(onse
-00006ab0: 7473 5b74 7269 616c 5f69 6478 5d29 202b  ts[trial_idx]) +
-00006ac0: 2027 2c20 7468 6520 656e 6420 6f66 2074   ', the end of t
-00006ad0: 6865 2074 7269 616c 2d65 706f 6368 206c  he trial-epoch l
-00006ae0: 6965 7320 6265 666f 7265 2074 6865 2073  ies before the s
-00006af0: 7461 7274 206f 6620 7468 6520 6461 7461  tart of the data
-00006b00: 2d73 6574 2e27 290a 2020 2020 2020 2020  -set.').        
-00006b10: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00006b20: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00006b30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00006b40: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
-00006b50: 2827 4361 6e6e 6f74 2065 7874 7261 6374  ('Cannot extract
-00006b60: 2074 6865 2074 7269 616c 2077 6974 6820   the trial with 
-00006b70: 6f6e 7365 7420 2720 2b20 7374 7228 6f6e  onset ' + str(on
-00006b80: 7365 7473 5b74 7269 616c 5f69 6478 5d29  sets[trial_idx])
-00006b90: 202b 2027 2c20 7468 6520 656e 6420 6f66   + ', the end of
-00006ba0: 2074 6865 2074 7269 616c 2d65 706f 6368   the trial-epoch
-00006bb0: 206c 6965 7320 6265 666f 7265 2074 6865   lies before the
-00006bc0: 2073 7461 7274 206f 6620 7468 6520 6461   start of the da
-00006bd0: 7461 2d73 6574 2e20 5573 6520 6120 6469  ta-set. Use a di
-00006be0: 6666 6572 656e 7420 6f75 745f 6f66 5f62  fferent out_of_b
-00006bf0: 6f75 6e64 5f68 616e 646c 696e 6720 6172  ound_handling ar
-00006c00: 6775 6d65 6e74 2074 6f20 616c 6c6f 7720  gument to allow 
-00006c10: 6f75 742d 6f66 2d62 6f75 6e64 2074 7269  out-of-bound tri
-00006c20: 616c 2065 706f 6368 7327 290a 2020 2020  al epochs').    
-00006c30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00006c40: 6520 5275 6e74 696d 6545 7272 6f72 2827  e RuntimeError('
-00006c50: 4361 6e6e 6f74 2065 7874 7261 6374 2074  Cannot extract t
-00006c60: 7269 616c 2729 0a20 2020 2020 2020 2069  rial').        i
-00006c70: 6620 7472 6961 6c5f 7361 6d70 6c65 5f73  f trial_sample_s
-00006c80: 7461 7274 203c 2030 3a0a 2020 2020 2020  tart < 0:.      
-00006c90: 2020 2020 2020 6966 2028 6f75 745f 6f66        if (out_of
-00006ca0: 5f62 6f75 6e64 5f6d 6574 686f 6420 3d3d  _bound_method ==
-00006cb0: 2031 2061 6e64 2074 7269 616c 5f69 6478   1 and trial_idx
-00006cc0: 203d 3d20 3029 206f 7220 6f75 745f 6f66   == 0) or out_of
-00006cd0: 5f62 6f75 6e64 5f6d 6574 686f 6420 3d3d  _bound_method ==
-00006ce0: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
-00006cf0: 2020 2020 6966 2063 6861 6e6e 656c 5f69      if channel_i
-00006d00: 6478 203d 3d20 303a 0a20 2020 2020 2020  dx == 0:.       
-00006d10: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00006d20: 6769 6e67 2e77 6172 6e69 6e67 2827 4361  ging.warning('Ca
-00006d30: 6e6e 6f74 2065 7874 7261 6374 2074 6865  nnot extract the
-00006d40: 2074 7269 616c 2077 6974 6820 6f6e 7365   trial with onse
-00006d50: 7420 2720 2b20 7374 7228 6f6e 7365 7473  t ' + str(onsets
-00006d60: 5b74 7269 616c 5f69 6478 5d29 202b 2027  [trial_idx]) + '
-00006d70: 2c20 7468 6520 7374 6172 7420 6f66 2074  , the start of t
-00006d80: 6865 2074 7269 616c 2d65 706f 6368 206c  he trial-epoch l
-00006d90: 6965 7320 6265 666f 7265 2074 6865 2073  ies before the s
-00006da0: 7461 7274 206f 6620 7468 6520 6461 7461  tart of the data
-00006db0: 2d73 6574 2e27 290a 2020 2020 2020 2020  -set.').        
-00006dc0: 2020 2020 2020 2020 6c6f 6361 6c5f 7374          local_st
-00006dd0: 6172 7420 3d20 7472 6961 6c5f 7361 6d70  art = trial_samp
-00006de0: 6c65 5f73 7461 7274 202a 202d 310a 2020  le_start * -1.  
-00006df0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00006e00: 6961 6c5f 7361 6d70 6c65 5f73 7461 7274  ial_sample_start
-00006e10: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-00006e20: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00006e30: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
-00006e40: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
-00006e50: 7261 6374 2074 6865 2074 7269 616c 2077  ract the trial w
-00006e60: 6974 6820 6f6e 7365 7420 2720 2b20 7374  ith onset ' + st
-00006e70: 7228 6f6e 7365 7473 5b74 7269 616c 5f69  r(onsets[trial_i
-00006e80: 6478 5d29 202b 2027 2c20 7468 6520 7374  dx]) + ', the st
-00006e90: 6172 7420 6f66 2074 6865 2074 7269 616c  art of the trial
-00006ea0: 2d65 706f 6368 206c 6965 7320 6265 666f  -epoch lies befo
-00006eb0: 7265 2074 6865 2073 7461 7274 206f 6620  re the start of 
-00006ec0: 7468 6520 6461 7461 2d73 6574 2e20 5573  the data-set. Us
-00006ed0: 6520 6120 6469 6666 6572 656e 7420 6f75  e a different ou
-00006ee0: 745f 6f66 5f62 6f75 6e64 5f68 616e 646c  t_of_bound_handl
-00006ef0: 696e 6720 6172 6775 6d65 6e74 2074 6f20  ing argument to 
-00006f00: 616c 6c6f 7720 6f75 742d 6f66 2d62 6f75  allow out-of-bou
-00006f10: 6e64 2074 7269 616c 2065 706f 6368 7327  nd trial epochs'
-00006f20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00006f30: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-00006f40: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
-00006f50: 7261 6374 2074 7269 616c 2729 0a20 2020  ract trial').   
-00006f60: 2020 2020 2069 6620 7472 6961 6c5f 7361       if trial_sa
-00006f70: 6d70 6c65 5f73 7461 7274 203e 2063 6861  mple_start > cha
-00006f80: 6e6e 656c 5f64 6174 612e 7369 7a65 3a0a  nnel_data.size:.
-00006f90: 2020 2020 2020 2020 2020 2020 6966 2028              if (
-00006fa0: 6f75 745f 6f66 5f62 6f75 6e64 5f6d 6574  out_of_bound_met
-00006fb0: 686f 6420 3d3d 2031 2061 6e64 2074 7269  hod == 1 and tri
-00006fc0: 616c 5f69 6478 203d 3d20 6c65 6e28 6f6e  al_idx == len(on
-00006fd0: 7365 7473 2920 2d20 3129 206f 7220 6f75  sets) - 1) or ou
-00006fe0: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
-00006ff0: 6420 3d3d 2032 3a0a 2020 2020 2020 2020  d == 2:.        
-00007000: 2020 2020 2020 2020 6966 2063 6861 6e6e          if chann
-00007010: 656c 5f69 6478 203d 3d20 303a 0a20 2020  el_idx == 0:.   
-00007020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007030: 206c 6f67 6769 6e67 2e77 6172 6e69 6e67   logging.warning
-00007040: 2827 4361 6e6e 6f74 2065 7874 7261 6374  ('Cannot extract
-00007050: 2074 6865 2074 7269 616c 2077 6974 6820   the trial with 
-00007060: 6f6e 7365 7420 2720 2b20 7374 7228 6f6e  onset ' + str(on
-00007070: 7365 7473 5b74 7269 616c 5f69 6478 5d29  sets[trial_idx])
-00007080: 202b 2027 2c20 7468 6520 7374 6172 7420   + ', the start 
-00007090: 6f66 2074 6865 2074 7269 616c 2d65 706f  of the trial-epo
-000070a0: 6368 206c 6965 7320 6166 7465 7220 7468  ch lies after th
-000070b0: 6520 656e 6420 6f66 2074 6865 2064 6174  e end of the dat
-000070c0: 612d 7365 742e 2729 0a20 2020 2020 2020  a-set.').       
-000070d0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-000070e0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-000070f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00007100: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
-00007110: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
-00007120: 7420 7468 6520 7472 6961 6c20 7769 7468  t the trial with
-00007130: 206f 6e73 6574 2027 202b 2073 7472 286f   onset ' + str(o
-00007140: 6e73 6574 735b 7472 6961 6c5f 6964 785d  nsets[trial_idx]
-00007150: 2920 2b20 272c 2074 6865 2073 7461 7274  ) + ', the start
-00007160: 206f 6620 7468 6520 7472 6961 6c2d 6570   of the trial-ep
-00007170: 6f63 6820 6c69 6573 2061 6674 6572 2074  och lies after t
-00007180: 6865 2065 6e64 206f 6620 7468 6520 6461  he end of the da
-00007190: 7461 2d73 6574 2e20 5573 6520 6120 6469  ta-set. Use a di
-000071a0: 6666 6572 656e 7420 6f75 745f 6f66 5f62  fferent out_of_b
-000071b0: 6f75 6e64 5f68 616e 646c 696e 6720 6172  ound_handling ar
-000071c0: 6775 6d65 6e74 2074 6f20 616c 6c6f 7720  gument to allow 
-000071d0: 6f75 742d 6f66 2d62 6f75 6e64 2074 7269  out-of-bound tri
-000071e0: 616c 2065 706f 6368 7327 290a 2020 2020  al epochs').    
-000071f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00007200: 6520 5275 6e74 696d 6545 7272 6f72 2827  e RuntimeError('
-00007210: 4361 6e6e 6f74 2065 7874 7261 6374 2074  Cannot extract t
-00007220: 7269 616c 2729 0a20 2020 2020 2020 2069  rial').        i
-00007230: 6620 7472 6961 6c5f 7361 6d70 6c65 5f65  f trial_sample_e
-00007240: 6e64 203e 2063 6861 6e6e 656c 5f64 6174  nd > channel_dat
-00007250: 612e 7369 7a65 3a0a 2020 2020 2020 2020  a.size:.        
-00007260: 2020 2020 6966 2028 6f75 745f 6f66 5f62      if (out_of_b
-00007270: 6f75 6e64 5f6d 6574 686f 6420 3d3d 2031  ound_method == 1
-00007280: 2061 6e64 2074 7269 616c 5f69 6478 203d   and trial_idx =
-00007290: 3d20 6c65 6e28 6f6e 7365 7473 2920 2d20  = len(onsets) - 
-000072a0: 3129 206f 7220 6f75 745f 6f66 5f62 6f75  1) or out_of_bou
-000072b0: 6e64 5f6d 6574 686f 6420 3d3d 2032 3a0a  nd_method == 2:.
-000072c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000072d0: 6966 2063 6861 6e6e 656c 5f69 6478 203d  if channel_idx =
-000072e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-000072f0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-00007300: 2e77 6172 6e69 6e67 2827 4361 6e6e 6f74  .warning('Cannot
-00007310: 2065 7874 7261 6374 2074 6865 2074 7269   extract the tri
-00007320: 616c 2077 6974 6820 6f6e 7365 7420 2720  al with onset ' 
-00007330: 2b20 7374 7228 6f6e 7365 7473 5b74 7269  + str(onsets[tri
-00007340: 616c 5f69 6478 5d29 202b 2027 2c20 7468  al_idx]) + ', th
-00007350: 6520 656e 6420 6f66 2074 6865 2074 7269  e end of the tri
-00007360: 616c 2d65 706f 6368 206c 6965 7320 6166  al-epoch lies af
-00007370: 7465 7220 7468 6520 656e 6420 6f66 2074  ter the end of t
-00007380: 6865 2064 6174 612d 7365 742e 2729 0a20  he data-set.'). 
-00007390: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000073a0: 6f63 616c 5f65 6e64 203d 2074 7269 616c  ocal_end = trial
-000073b0: 5f6e 756d 5f73 616d 706c 6573 202d 2028  _num_samples - (
-000073c0: 7472 6961 6c5f 7361 6d70 6c65 5f65 6e64  trial_sample_end
-000073d0: 202d 2063 6861 6e6e 656c 5f64 6174 612e   - channel_data.
-000073e0: 7369 7a65 290a 2020 2020 2020 2020 2020  size).          
-000073f0: 2020 2020 2020 7472 6961 6c5f 7361 6d70        trial_samp
-00007400: 6c65 5f65 6e64 203d 2063 6861 6e6e 656c  le_end = channel
-00007410: 5f64 6174 612e 7369 7a65 0a20 2020 2020  _data.size.     
-00007420: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00007430: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00007440: 6769 6e67 2e65 7272 6f72 2827 4361 6e6e  ging.error('Cann
-00007450: 6f74 2065 7874 7261 6374 2074 6865 2074  ot extract the t
-00007460: 7269 616c 2077 6974 6820 6f6e 7365 7420  rial with onset 
-00007470: 2720 2b20 7374 7228 6f6e 7365 7473 5b74  ' + str(onsets[t
-00007480: 7269 616c 5f69 6478 5d29 202b 2027 2c20  rial_idx]) + ', 
-00007490: 7468 6520 656e 6420 6f66 2074 6865 2074  the end of the t
-000074a0: 7269 616c 2d65 706f 6368 206c 6965 7320  rial-epoch lies 
-000074b0: 6166 7465 7220 7468 6520 656e 6420 6f66  after the end of
-000074c0: 2074 6865 2064 6174 612d 7365 742e 2055   the data-set. U
-000074d0: 7365 2061 2064 6966 6665 7265 6e74 206f  se a different o
-000074e0: 7574 5f6f 665f 626f 756e 645f 6861 6e64  ut_of_bound_hand
-000074f0: 6c69 6e67 2061 7267 756d 656e 7420 746f  ling argument to
-00007500: 2061 6c6c 6f77 206f 7574 2d6f 662d 626f   allow out-of-bo
-00007510: 756e 6420 7472 6961 6c20 6570 6f63 6873  und trial epochs
-00007520: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00007530: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-00007540: 4572 726f 7228 2743 616e 6e6f 7420 6578  Error('Cannot ex
-00007550: 7472 6163 7420 7472 6961 6c27 290a 0a20  tract trial').. 
-00007560: 2020 2020 2020 2023 2063 6865 636b 2077         # check w
-00007570: 6865 7468 6572 2074 6865 2062 6173 656c  hether the basel
-00007580: 696e 6520 6973 2077 6974 6869 6e20 626f  ine is within bo
-00007590: 756e 6473 0a20 2020 2020 2020 2069 6620  unds.        if 
-000075a0: 6261 7365 6c69 6e65 5f6d 6574 686f 6420  baseline_method 
-000075b0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-000075c0: 2069 6620 6261 7365 6c69 6e65 5f73 7461   if baseline_sta
-000075d0: 7274 5f73 616d 706c 6520 3c20 3020 6f72  rt_sample < 0 or
-000075e0: 2062 6173 656c 696e 655f 656e 645f 7361   baseline_end_sa
-000075f0: 6d70 6c65 203e 2063 6861 6e6e 656c 5f64  mple > channel_d
-00007600: 6174 612e 7369 7a65 3a0a 2020 2020 2020  ata.size:.      
-00007610: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-00007620: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
-00007630: 6578 7472 6163 7420 7468 6520 6261 7365  extract the base
-00007640: 6c69 6e65 2066 6f72 2074 6865 2074 7269  line for the tri
-00007650: 616c 2077 6974 6820 6f6e 7365 7420 2720  al with onset ' 
-00007660: 2b20 7374 7228 6f6e 7365 7473 5b74 7269  + str(onsets[tri
-00007670: 616c 5f69 6478 5d29 202b 2027 2c20 7468  al_idx]) + ', th
-00007680: 6520 7261 6e67 6520 666f 7220 7468 6520  e range for the 
-00007690: 6261 7365 6c69 6e65 206c 6965 7320 6f75  baseline lies ou
-000076a0: 7473 6964 6520 6f66 2074 6865 2064 6174  tside of the dat
-000076b0: 6127 290a 2020 2020 2020 2020 2020 2020  a').            
-000076c0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-000076d0: 6545 7272 6f72 2827 4361 6e6e 6f74 2065  eError('Cannot e
-000076e0: 7874 7261 6374 2074 6865 2062 6173 656c  xtract the basel
-000076f0: 696e 6527 290a 0a20 2020 2020 2020 2023  ine')..        #
-00007700: 2065 7874 7261 6374 2074 6865 2074 7269   extract the tri
-00007710: 616c 2064 6174 6120 616e 6420 7065 7266  al data and perf
-00007720: 6f72 6d20 6261 7365 6c69 6e65 206e 6f72  orm baseline nor
-00007730: 6d61 6c69 7a61 7469 6f6e 206f 6e20 7468  malization on th
-00007740: 6520 7472 6961 6c20 6966 206e 6565 6465  e trial if neede
-00007750: 640a 2020 2020 2020 2020 6966 2062 6173  d.        if bas
-00007760: 656c 696e 655f 6d65 7468 6f64 203d 3d20  eline_method == 
-00007770: 303a 0a0a 2020 2020 2020 2020 2020 2020  0:..            
-00007780: 2320 4e6f 7465 3a20 7369 6e63 6520 7765  # Note: since we
-00007790: 2061 7265 206e 6f74 206d 616e 6970 756c   are not manipul
-000077a0: 6174 696e 6720 7468 6520 6461 7461 2028  ating the data (
-000077b0: 7768 6963 6820 696e 2074 6865 206f 7468  which in the oth
-000077c0: 6572 2063 6173 6573 2063 6f6e 7665 7274  er cases convert
-000077d0: 7320 6120 7669 6577 2074 6f20 6461 7461  s a view to data
-000077e0: 292c 2061 6c77 6179 730a 2020 2020 2020  ), always.      
-000077f0: 2020 2020 2020 2320 2020 2020 2020 6d61        #       ma
-00007800: 6b65 2061 2063 6f70 792e 2045 7665 6e20  ke a copy. Even 
-00007810: 6966 2074 6865 2063 6861 6e6e 656c 2069  if the channel i
-00007820: 6e70 7574 2069 7320 6120 6461 7461 2061  nput is a data a
-00007830: 7272 6179 2028 616e 6420 6e6f 7420 6120  rray (and not a 
-00007840: 7669 6577 292c 2069 7420 6d69 6768 7420  view), it might 
-00007850: 6265 2070 6f73 7369 626c 6520 7468 6174  be possible that
-00007860: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00007870: 2020 2020 2065 706f 6368 7320 6f76 6572       epochs over
-00007880: 6c61 703b 2069 6e20 6164 6469 7469 6f6e  lap; in addition
-00007890: 2c20 6176 6f69 6469 6e67 2076 6965 7773  , avoiding views
-000078a0: 2065 6e73 7572 6573 2074 6865 7265 2061   ensures there a
-000078b0: 7265 206e 6f20 7265 6d61 696e 696e 6720  re no remaining 
-000078c0: 7265 6665 7265 6e63 6573 2074 6f20 7468  references to th
-000078d0: 6520 736f 7572 6365 0a20 2020 2020 2020  e source.       
-000078e0: 2020 2020 2023 2020 2020 2020 206e 756d       #       num
-000078f0: 7079 2d61 7272 6179 2c20 616c 6c6f 7769  py-array, allowi
-00007900: 6e67 2069 7420 746f 2062 6520 636c 6561  ng it to be clea
-00007910: 7265 6420 6672 6f6d 206d 656d 6f72 790a  red from memory.
-00007920: 2020 2020 2020 2020 2020 2020 7265 665f              ref_
-00007930: 6461 7461 5b63 6861 6e6e 656c 5f69 6478  data[channel_idx
-00007940: 2c20 7472 6961 6c5f 6964 782c 206c 6f63  , trial_idx, loc
-00007950: 616c 5f73 7461 7274 3a6c 6f63 616c 5f65  al_start:local_e
-00007960: 6e64 5d20 3d20 6368 616e 6e65 6c5f 6461  nd] = channel_da
-00007970: 7461 5b74 7269 616c 5f73 616d 706c 655f  ta[trial_sample_
-00007980: 7374 6172 743a 7472 6961 6c5f 7361 6d70  start:trial_samp
-00007990: 6c65 5f65 6e64 5d2e 636f 7079 2829 0a0a  le_end].copy()..
-000079a0: 2020 2020 2020 2020 656c 6966 2062 6173          elif bas
-000079b0: 656c 696e 655f 6d65 7468 6f64 203d 3d20  eline_method == 
-000079c0: 313a 0a20 2020 2020 2020 2020 2020 2062  1:.            b
-000079d0: 6173 656c 696e 655f 6d65 616e 203d 206e  aseline_mean = n
-000079e0: 702e 6e61 6e6d 6561 6e28 6368 616e 6e65  p.nanmean(channe
-000079f0: 6c5f 6461 7461 5b62 6173 656c 696e 655f  l_data[baseline_
-00007a00: 7374 6172 745f 7361 6d70 6c65 3a62 6173  start_sample:bas
-00007a10: 656c 696e 655f 656e 645f 7361 6d70 6c65  eline_end_sample
-00007a20: 5d29 0a20 2020 2020 2020 2020 2020 2072  ]).            r
-00007a30: 6566 5f64 6174 615b 6368 616e 6e65 6c5f  ef_data[channel_
-00007a40: 6964 782c 2074 7269 616c 5f69 6478 2c20  idx, trial_idx, 
-00007a50: 6c6f 6361 6c5f 7374 6172 743a 6c6f 6361  local_start:loca
-00007a60: 6c5f 656e 645d 203d 2063 6861 6e6e 656c  l_end] = channel
-00007a70: 5f64 6174 615b 7472 6961 6c5f 7361 6d70  _data[trial_samp
-00007a80: 6c65 5f73 7461 7274 3a74 7269 616c 5f73  le_start:trial_s
-00007a90: 616d 706c 655f 656e 645d 202d 2062 6173  ample_end] - bas
-00007aa0: 656c 696e 655f 6d65 616e 0a20 2020 2020  eline_mean.     
-00007ab0: 2020 2065 6c69 6620 6261 7365 6c69 6e65     elif baseline
-00007ac0: 5f6d 6574 686f 6420 3d3d 2032 3a0a 2020  _method == 2:.  
-00007ad0: 2020 2020 2020 2020 2020 6261 7365 6c69            baseli
-00007ae0: 6e65 5f6d 6564 6961 6e20 3d20 6e70 2e6e  ne_median = np.n
-00007af0: 616e 6d65 6469 616e 2863 6861 6e6e 656c  anmedian(channel
-00007b00: 5f64 6174 615b 6261 7365 6c69 6e65 5f73  _data[baseline_s
-00007b10: 7461 7274 5f73 616d 706c 653a 6261 7365  tart_sample:base
-00007b20: 6c69 6e65 5f65 6e64 5f73 616d 706c 655d  line_end_sample]
-00007b30: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00007b40: 665f 6461 7461 5b63 6861 6e6e 656c 5f69  f_data[channel_i
-00007b50: 6478 2c20 7472 6961 6c5f 6964 782c 206c  dx, trial_idx, l
-00007b60: 6f63 616c 5f73 7461 7274 3a6c 6f63 616c  ocal_start:local
-00007b70: 5f65 6e64 5d20 3d20 6368 616e 6e65 6c5f  _end] = channel_
-00007b80: 6461 7461 5b74 7269 616c 5f73 616d 706c  data[trial_sampl
-00007b90: 655f 7374 6172 743a 7472 6961 6c5f 7361  e_start:trial_sa
-00007ba0: 6d70 6c65 5f65 6e64 5d20 2d20 6261 7365  mple_end] - base
-00007bb0: 6c69 6e65 5f6d 6564 6961 6e0a 0a20 2020  line_median..   
-00007bc0: 2023 2072 6574 7572 6e20 7375 6363 6573   # return succes
-00007bd0: 730a 2020 2020 7265 7475 726e 2072 6566  s.    return ref
-00007be0: 5f64 6174 610a 0a0a 6465 6620 5f5f 6c6f  _data...def __lo
-00007bf0: 6164 5f64 6174 615f 6570 6f63 6873 5f5f  ad_data_epochs__
-00007c00: 6279 5f63 6861 6e6e 656c 7328 6461 7461  by_channels(data
-00007c10: 5f72 6561 6465 722c 2072 6574 7269 6576  _reader, retriev
-00007c20: 655f 6368 616e 6e65 6c73 2c0a 2020 2020  e_channels,.    
-00007c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000066d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000066e0: 2020 2020 2062 6173 656c 696e 655f 6e75       baseline_nu
+000066f0: 6d5f 7361 6d70 6c65 732c 2062 6173 656c  m_samples, basel
+00006700: 696e 655f 6d65 7468 6f64 2c20 6261 7365  ine_method, base
+00006710: 6c69 6e65 5f65 706f 6368 2c20 6f75 745f  line_epoch, out_
+00006720: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6429  of_bound_method)
+00006730: 3a0a 2020 2020 2222 220a 2020 2020 4570  :.    """.    Ep
+00006740: 6f63 6820 7468 6520 7472 6961 6c2d 6461  och the trial-da
+00006750: 7461 2066 6f72 2061 2073 696e 676c 6520  ta for a single 
+00006760: 6368 616e 6e65 6c20 6279 206c 6f6f 7069  channel by loopi
+00006770: 6e67 206f 7665 7220 7468 6520 7472 6961  ng over the tria
+00006780: 6c2d 6f6e 7365 7473 0a20 2020 2022 2222  l-onsets.    """
+00006790: 0a0a 2020 2020 2320 6c6f 6f70 2074 6872  ..    # loop thr
+000067a0: 6f75 6768 2074 6865 2074 7269 616c 730a  ough the trials.
+000067b0: 2020 2020 666f 7220 7472 6961 6c5f 6964      for trial_id
+000067c0: 7820 696e 2072 616e 6765 286c 656e 286f  x in range(len(o
+000067d0: 6e73 6574 7329 293a 0a0a 2020 2020 2020  nsets)):..      
+000067e0: 2020 2320 6361 6c63 756c 6174 6520 7468    # calculate th
+000067f0: 6520 7361 6d70 6c65 2069 6e64 6963 6573  e sample indices
+00006800: 0a20 2020 2020 2020 2074 7269 616c 5f73  .        trial_s
+00006810: 616d 706c 655f 7374 6172 7420 3d20 696e  ample_start = in
+00006820: 7428 726f 756e 6428 286f 6e73 6574 735b  t(round((onsets[
+00006830: 7472 6961 6c5f 6964 785d 202b 2074 7269  trial_idx] + tri
+00006840: 616c 5f65 706f 6368 5b30 5d29 202a 2073  al_epoch[0]) * s
+00006850: 616d 706c 696e 675f 7261 7465 2929 0a20  ampling_rate)). 
+00006860: 2020 2020 2020 2074 7269 616c 5f73 616d         trial_sam
+00006870: 706c 655f 656e 6420 3d20 7472 6961 6c5f  ple_end = trial_
+00006880: 7361 6d70 6c65 5f73 7461 7274 202b 2074  sample_start + t
+00006890: 7269 616c 5f6e 756d 5f73 616d 706c 6573  rial_num_samples
+000068a0: 0a20 2020 2020 2020 2062 6173 656c 696e  .        baselin
+000068b0: 655f 7374 6172 745f 7361 6d70 6c65 203d  e_start_sample =
+000068c0: 2069 6e74 2872 6f75 6e64 2828 6f6e 7365   int(round((onse
+000068d0: 7473 5b74 7269 616c 5f69 6478 5d20 2b20  ts[trial_idx] + 
+000068e0: 6261 7365 6c69 6e65 5f65 706f 6368 5b30  baseline_epoch[0
+000068f0: 5d29 202a 2073 616d 706c 696e 675f 7261  ]) * sampling_ra
+00006900: 7465 2929 0a20 2020 2020 2020 2062 6173  te)).        bas
+00006910: 656c 696e 655f 656e 645f 7361 6d70 6c65  eline_end_sample
+00006920: 203d 2062 6173 656c 696e 655f 7374 6172   = baseline_star
+00006930: 745f 7361 6d70 6c65 202b 2062 6173 656c  t_sample + basel
+00006940: 696e 655f 6e75 6d5f 7361 6d70 6c65 730a  ine_num_samples.
+00006950: 2020 2020 2020 2020 6c6f 6361 6c5f 7374          local_st
+00006960: 6172 7420 3d20 300a 2020 2020 2020 2020  art = 0.        
+00006970: 6c6f 6361 6c5f 656e 6420 3d20 7472 6961  local_end = tria
+00006980: 6c5f 6e75 6d5f 7361 6d70 6c65 730a 0a20  l_num_samples.. 
+00006990: 2020 2020 2020 2023 2063 6865 636b 2077         # check w
+000069a0: 6865 7468 6572 2074 6865 2074 7269 616c  hether the trial
+000069b0: 2065 706f 6368 2069 7320 7769 7468 696e   epoch is within
+000069c0: 2062 6f75 6e64 730a 2020 2020 2020 2020   bounds.        
+000069d0: 6966 2074 7269 616c 5f73 616d 706c 655f  if trial_sample_
+000069e0: 656e 6420 3c20 303a 0a20 2020 2020 2020  end < 0:.       
+000069f0: 2020 2020 2069 6620 286f 7574 5f6f 665f       if (out_of_
+00006a00: 626f 756e 645f 6d65 7468 6f64 203d 3d20  bound_method == 
+00006a10: 3120 616e 6420 7472 6961 6c5f 6964 7820  1 and trial_idx 
+00006a20: 3d3d 2030 2920 6f72 206f 7574 5f6f 665f  == 0) or out_of_
+00006a30: 626f 756e 645f 6d65 7468 6f64 203d 3d20  bound_method == 
+00006a40: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+00006a50: 2020 2069 6620 6368 616e 6e65 6c5f 6964     if channel_id
+00006a60: 7820 3d3d 2030 3a0a 2020 2020 2020 2020  x == 0:.        
+00006a70: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00006a80: 696e 672e 7761 726e 696e 6728 2743 616e  ing.warning('Can
+00006a90: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
+00006aa0: 7472 6961 6c20 7769 7468 206f 6e73 6574  trial with onset
+00006ab0: 2027 202b 2073 7472 286f 6e73 6574 735b   ' + str(onsets[
+00006ac0: 7472 6961 6c5f 6964 785d 2920 2b20 272c  trial_idx]) + ',
+00006ad0: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
+00006ae0: 7472 6961 6c2d 6570 6f63 6820 6c69 6573  trial-epoch lies
+00006af0: 2062 6566 6f72 6520 7468 6520 7374 6172   before the star
+00006b00: 7420 6f66 2074 6865 2064 6174 612d 7365  t of the data-se
+00006b10: 742e 2729 0a20 2020 2020 2020 2020 2020  t.').           
+00006b20: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00006b30: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00006b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b50: 6c6f 6767 696e 672e 6572 726f 7228 2743  logging.error('C
+00006b60: 616e 6e6f 7420 6578 7472 6163 7420 7468  annot extract th
+00006b70: 6520 7472 6961 6c20 7769 7468 206f 6e73  e trial with ons
+00006b80: 6574 2027 202b 2073 7472 286f 6e73 6574  et ' + str(onset
+00006b90: 735b 7472 6961 6c5f 6964 785d 2920 2b20  s[trial_idx]) + 
+00006ba0: 272c 2074 6865 2065 6e64 206f 6620 7468  ', the end of th
+00006bb0: 6520 7472 6961 6c2d 6570 6f63 6820 6c69  e trial-epoch li
+00006bc0: 6573 2062 6566 6f72 6520 7468 6520 7374  es before the st
+00006bd0: 6172 7420 6f66 2074 6865 2064 6174 612d  art of the data-
+00006be0: 7365 742e 2055 7365 2061 2064 6966 6665  set. Use a diffe
+00006bf0: 7265 6e74 206f 7574 5f6f 665f 626f 756e  rent out_of_boun
+00006c00: 645f 6861 6e64 6c69 6e67 2061 7267 756d  d_handling argum
+00006c10: 656e 7420 746f 2061 6c6c 6f77 206f 7574  ent to allow out
+00006c20: 2d6f 662d 626f 756e 6420 7472 6961 6c20  -of-bound trial 
+00006c30: 6570 6f63 6873 2729 0a20 2020 2020 2020  epochs').       
+00006c40: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+00006c50: 756e 7469 6d65 4572 726f 7228 2743 616e  untimeError('Can
+00006c60: 6e6f 7420 6578 7472 6163 7420 7472 6961  not extract tria
+00006c70: 6c27 290a 2020 2020 2020 2020 6966 2074  l').        if t
+00006c80: 7269 616c 5f73 616d 706c 655f 7374 6172  rial_sample_star
+00006c90: 7420 3c20 303a 0a20 2020 2020 2020 2020  t < 0:.         
+00006ca0: 2020 2069 6620 286f 7574 5f6f 665f 626f     if (out_of_bo
+00006cb0: 756e 645f 6d65 7468 6f64 203d 3d20 3120  und_method == 1 
+00006cc0: 616e 6420 7472 6961 6c5f 6964 7820 3d3d  and trial_idx ==
+00006cd0: 2030 2920 6f72 206f 7574 5f6f 665f 626f   0) or out_of_bo
+00006ce0: 756e 645f 6d65 7468 6f64 203d 3d20 323a  und_method == 2:
+00006cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006d00: 2069 6620 6368 616e 6e65 6c5f 6964 7820   if channel_idx 
+00006d10: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00006d20: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+00006d30: 672e 7761 726e 696e 6728 2743 616e 6e6f  g.warning('Canno
+00006d40: 7420 6578 7472 6163 7420 7468 6520 7472  t extract the tr
+00006d50: 6961 6c20 7769 7468 206f 6e73 6574 2027  ial with onset '
+00006d60: 202b 2073 7472 286f 6e73 6574 735b 7472   + str(onsets[tr
+00006d70: 6961 6c5f 6964 785d 2920 2b20 272c 2074  ial_idx]) + ', t
+00006d80: 6865 2073 7461 7274 206f 6620 7468 6520  he start of the 
+00006d90: 7472 6961 6c2d 6570 6f63 6820 6c69 6573  trial-epoch lies
+00006da0: 2062 6566 6f72 6520 7468 6520 7374 6172   before the star
+00006db0: 7420 6f66 2074 6865 2064 6174 612d 7365  t of the data-se
+00006dc0: 742e 2729 0a20 2020 2020 2020 2020 2020  t.').           
+00006dd0: 2020 2020 206c 6f63 616c 5f73 7461 7274       local_start
+00006de0: 203d 2074 7269 616c 5f73 616d 706c 655f   = trial_sample_
+00006df0: 7374 6172 7420 2a20 2d31 0a20 2020 2020  start * -1.     
+00006e00: 2020 2020 2020 2020 2020 2074 7269 616c             trial
+00006e10: 5f73 616d 706c 655f 7374 6172 7420 3d20  _sample_start = 
+00006e20: 300a 2020 2020 2020 2020 2020 2020 656c  0.            el
+00006e30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006e40: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
+00006e50: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
+00006e60: 7420 7468 6520 7472 6961 6c20 7769 7468  t the trial with
+00006e70: 206f 6e73 6574 2027 202b 2073 7472 286f   onset ' + str(o
+00006e80: 6e73 6574 735b 7472 6961 6c5f 6964 785d  nsets[trial_idx]
+00006e90: 2920 2b20 272c 2074 6865 2073 7461 7274  ) + ', the start
+00006ea0: 206f 6620 7468 6520 7472 6961 6c2d 6570   of the trial-ep
+00006eb0: 6f63 6820 6c69 6573 2062 6566 6f72 6520  och lies before 
+00006ec0: 7468 6520 7374 6172 7420 6f66 2074 6865  the start of the
+00006ed0: 2064 6174 612d 7365 742e 2055 7365 2061   data-set. Use a
+00006ee0: 2064 6966 6665 7265 6e74 206f 7574 5f6f   different out_o
+00006ef0: 665f 626f 756e 645f 6861 6e64 6c69 6e67  f_bound_handling
+00006f00: 2061 7267 756d 656e 7420 746f 2061 6c6c   argument to all
+00006f10: 6f77 206f 7574 2d6f 662d 626f 756e 6420  ow out-of-bound 
+00006f20: 7472 6961 6c20 6570 6f63 6873 2729 0a20  trial epochs'). 
+00006f30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00006f40: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00006f50: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
+00006f60: 7420 7472 6961 6c27 290a 2020 2020 2020  t trial').      
+00006f70: 2020 6966 2074 7269 616c 5f73 616d 706c    if trial_sampl
+00006f80: 655f 7374 6172 7420 3e20 6368 616e 6e65  e_start > channe
+00006f90: 6c5f 6461 7461 2e73 697a 653a 0a20 2020  l_data.size:.   
+00006fa0: 2020 2020 2020 2020 2069 6620 286f 7574           if (out
+00006fb0: 5f6f 665f 626f 756e 645f 6d65 7468 6f64  _of_bound_method
+00006fc0: 203d 3d20 3120 616e 6420 7472 6961 6c5f   == 1 and trial_
+00006fd0: 6964 7820 3d3d 206c 656e 286f 6e73 6574  idx == len(onset
+00006fe0: 7329 202d 2031 2920 6f72 206f 7574 5f6f  s) - 1) or out_o
+00006ff0: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
+00007000: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
+00007010: 2020 2020 2069 6620 6368 616e 6e65 6c5f       if channel_
+00007020: 6964 7820 3d3d 2030 3a0a 2020 2020 2020  idx == 0:.      
+00007030: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00007040: 6767 696e 672e 7761 726e 696e 6728 2743  gging.warning('C
+00007050: 616e 6e6f 7420 6578 7472 6163 7420 7468  annot extract th
+00007060: 6520 7472 6961 6c20 7769 7468 206f 6e73  e trial with ons
+00007070: 6574 2027 202b 2073 7472 286f 6e73 6574  et ' + str(onset
+00007080: 735b 7472 6961 6c5f 6964 785d 2920 2b20  s[trial_idx]) + 
+00007090: 272c 2074 6865 2073 7461 7274 206f 6620  ', the start of 
+000070a0: 7468 6520 7472 6961 6c2d 6570 6f63 6820  the trial-epoch 
+000070b0: 6c69 6573 2061 6674 6572 2074 6865 2065  lies after the e
+000070c0: 6e64 206f 6620 7468 6520 6461 7461 2d73  nd of the data-s
+000070d0: 6574 2e27 290a 2020 2020 2020 2020 2020  et.').          
+000070e0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+000070f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00007100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007110: 206c 6f67 6769 6e67 2e65 7272 6f72 2827   logging.error('
+00007120: 4361 6e6e 6f74 2065 7874 7261 6374 2074  Cannot extract t
+00007130: 6865 2074 7269 616c 2077 6974 6820 6f6e  he trial with on
+00007140: 7365 7420 2720 2b20 7374 7228 6f6e 7365  set ' + str(onse
+00007150: 7473 5b74 7269 616c 5f69 6478 5d29 202b  ts[trial_idx]) +
+00007160: 2027 2c20 7468 6520 7374 6172 7420 6f66   ', the start of
+00007170: 2074 6865 2074 7269 616c 2d65 706f 6368   the trial-epoch
+00007180: 206c 6965 7320 6166 7465 7220 7468 6520   lies after the 
+00007190: 656e 6420 6f66 2074 6865 2064 6174 612d  end of the data-
+000071a0: 7365 742e 2055 7365 2061 2064 6966 6665  set. Use a diffe
+000071b0: 7265 6e74 206f 7574 5f6f 665f 626f 756e  rent out_of_boun
+000071c0: 645f 6861 6e64 6c69 6e67 2061 7267 756d  d_handling argum
+000071d0: 656e 7420 746f 2061 6c6c 6f77 206f 7574  ent to allow out
+000071e0: 2d6f 662d 626f 756e 6420 7472 6961 6c20  -of-bound trial 
+000071f0: 6570 6f63 6873 2729 0a20 2020 2020 2020  epochs').       
+00007200: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+00007210: 756e 7469 6d65 4572 726f 7228 2743 616e  untimeError('Can
+00007220: 6e6f 7420 6578 7472 6163 7420 7472 6961  not extract tria
+00007230: 6c27 290a 2020 2020 2020 2020 6966 2074  l').        if t
+00007240: 7269 616c 5f73 616d 706c 655f 656e 6420  rial_sample_end 
+00007250: 3e20 6368 616e 6e65 6c5f 6461 7461 2e73  > channel_data.s
+00007260: 697a 653a 0a20 2020 2020 2020 2020 2020  ize:.           
+00007270: 2069 6620 286f 7574 5f6f 665f 626f 756e   if (out_of_boun
+00007280: 645f 6d65 7468 6f64 203d 3d20 3120 616e  d_method == 1 an
+00007290: 6420 7472 6961 6c5f 6964 7820 3d3d 206c  d trial_idx == l
+000072a0: 656e 286f 6e73 6574 7329 202d 2031 2920  en(onsets) - 1) 
+000072b0: 6f72 206f 7574 5f6f 665f 626f 756e 645f  or out_of_bound_
+000072c0: 6d65 7468 6f64 203d 3d20 323a 0a20 2020  method == 2:.   
+000072d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000072e0: 6368 616e 6e65 6c5f 6964 7820 3d3d 2030  channel_idx == 0
+000072f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007300: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
+00007310: 726e 696e 6728 2743 616e 6e6f 7420 6578  rning('Cannot ex
+00007320: 7472 6163 7420 7468 6520 7472 6961 6c20  tract the trial 
+00007330: 7769 7468 206f 6e73 6574 2027 202b 2073  with onset ' + s
+00007340: 7472 286f 6e73 6574 735b 7472 6961 6c5f  tr(onsets[trial_
+00007350: 6964 785d 2920 2b20 272c 2074 6865 2065  idx]) + ', the e
+00007360: 6e64 206f 6620 7468 6520 7472 6961 6c2d  nd of the trial-
+00007370: 6570 6f63 6820 6c69 6573 2061 6674 6572  epoch lies after
+00007380: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
+00007390: 6461 7461 2d73 6574 2e27 290a 2020 2020  data-set.').    
+000073a0: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+000073b0: 6c5f 656e 6420 3d20 7472 6961 6c5f 6e75  l_end = trial_nu
+000073c0: 6d5f 7361 6d70 6c65 7320 2d20 2874 7269  m_samples - (tri
+000073d0: 616c 5f73 616d 706c 655f 656e 6420 2d20  al_sample_end - 
+000073e0: 6368 616e 6e65 6c5f 6461 7461 2e73 697a  channel_data.siz
+000073f0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00007400: 2020 2074 7269 616c 5f73 616d 706c 655f     trial_sample_
+00007410: 656e 6420 3d20 6368 616e 6e65 6c5f 6461  end = channel_da
+00007420: 7461 2e73 697a 650a 2020 2020 2020 2020  ta.size.        
+00007430: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00007440: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+00007450: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
+00007460: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
+00007470: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
+00007480: 2073 7472 286f 6e73 6574 735b 7472 6961   str(onsets[tria
+00007490: 6c5f 6964 785d 2920 2b20 272c 2074 6865  l_idx]) + ', the
+000074a0: 2065 6e64 206f 6620 7468 6520 7472 6961   end of the tria
+000074b0: 6c2d 6570 6f63 6820 6c69 6573 2061 6674  l-epoch lies aft
+000074c0: 6572 2074 6865 2065 6e64 206f 6620 7468  er the end of th
+000074d0: 6520 6461 7461 2d73 6574 2e20 5573 6520  e data-set. Use 
+000074e0: 6120 6469 6666 6572 656e 7420 6f75 745f  a different out_
+000074f0: 6f66 5f62 6f75 6e64 5f68 616e 646c 696e  of_bound_handlin
+00007500: 6720 6172 6775 6d65 6e74 2074 6f20 616c  g argument to al
+00007510: 6c6f 7720 6f75 742d 6f66 2d62 6f75 6e64  low out-of-bound
+00007520: 2074 7269 616c 2065 706f 6368 7327 290a   trial epochs').
+00007530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007540: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
+00007550: 6f72 2827 4361 6e6e 6f74 2065 7874 7261  or('Cannot extra
+00007560: 6374 2074 7269 616c 2729 0a0a 2020 2020  ct trial')..    
+00007570: 2020 2020 2320 6368 6563 6b20 7768 6574      # check whet
+00007580: 6865 7220 7468 6520 6261 7365 6c69 6e65  her the baseline
+00007590: 2069 7320 7769 7468 696e 2062 6f75 6e64   is within bound
+000075a0: 730a 2020 2020 2020 2020 6966 2062 6173  s.        if bas
+000075b0: 656c 696e 655f 6d65 7468 6f64 203e 2030  eline_method > 0
+000075c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000075d0: 2062 6173 656c 696e 655f 7374 6172 745f   baseline_start_
+000075e0: 7361 6d70 6c65 203c 2030 206f 7220 6261  sample < 0 or ba
+000075f0: 7365 6c69 6e65 5f65 6e64 5f73 616d 706c  seline_end_sampl
+00007600: 6520 3e20 6368 616e 6e65 6c5f 6461 7461  e > channel_data
+00007610: 2e73 697a 653a 0a20 2020 2020 2020 2020  .size:.         
+00007620: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
+00007630: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
+00007640: 7261 6374 2074 6865 2062 6173 656c 696e  ract the baselin
+00007650: 6520 666f 7220 7468 6520 7472 6961 6c20  e for the trial 
+00007660: 7769 7468 206f 6e73 6574 2027 202b 2073  with onset ' + s
+00007670: 7472 286f 6e73 6574 735b 7472 6961 6c5f  tr(onsets[trial_
+00007680: 6964 785d 2920 2b20 272c 2074 6865 2072  idx]) + ', the r
+00007690: 616e 6765 2066 6f72 2074 6865 2062 6173  ange for the bas
+000076a0: 656c 696e 6520 6c69 6573 206f 7574 7369  eline lies outsi
+000076b0: 6465 206f 6620 7468 6520 6461 7461 2729  de of the data')
+000076c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000076d0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+000076e0: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+000076f0: 6163 7420 7468 6520 6261 7365 6c69 6e65  act the baseline
+00007700: 2729 0a0a 2020 2020 2020 2020 2320 6578  ')..        # ex
+00007710: 7472 6163 7420 7468 6520 7472 6961 6c20  tract the trial 
+00007720: 6461 7461 2061 6e64 2070 6572 666f 726d  data and perform
+00007730: 2062 6173 656c 696e 6520 6e6f 726d 616c   baseline normal
+00007740: 697a 6174 696f 6e20 6f6e 2074 6865 2074  ization on the t
+00007750: 7269 616c 2069 6620 6e65 6564 6564 0a20  rial if needed. 
+00007760: 2020 2020 2020 2069 6620 6261 7365 6c69         if baseli
+00007770: 6e65 5f6d 6574 686f 6420 3d3d 2030 3a0a  ne_method == 0:.
+00007780: 0a20 2020 2020 2020 2020 2020 2023 204e  .            # N
+00007790: 6f74 653a 2073 696e 6365 2077 6520 6172  ote: since we ar
+000077a0: 6520 6e6f 7420 6d61 6e69 7075 6c61 7469  e not manipulati
+000077b0: 6e67 2074 6865 2064 6174 6120 2877 6869  ng the data (whi
+000077c0: 6368 2069 6e20 7468 6520 6f74 6865 7220  ch in the other 
+000077d0: 6361 7365 7320 636f 6e76 6572 7473 2061  cases converts a
+000077e0: 2076 6965 7720 746f 2064 6174 6129 2c20   view to data), 
+000077f0: 616c 7761 7973 0a20 2020 2020 2020 2020  always.         
+00007800: 2020 2023 2020 2020 2020 206d 616b 6520     #       make 
+00007810: 6120 636f 7079 2e20 4576 656e 2069 6620  a copy. Even if 
+00007820: 7468 6520 6368 616e 6e65 6c20 696e 7075  the channel inpu
+00007830: 7420 6973 2061 2064 6174 6120 6172 7261  t is a data arra
+00007840: 7920 2861 6e64 206e 6f74 2061 2076 6965  y (and not a vie
+00007850: 7729 2c20 6974 206d 6967 6874 2062 6520  w), it might be 
+00007860: 706f 7373 6962 6c65 2074 6861 740a 2020  possible that.  
+00007870: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00007880: 2020 6570 6f63 6873 206f 7665 726c 6170    epochs overlap
+00007890: 3b20 696e 2061 6464 6974 696f 6e2c 2061  ; in addition, a
+000078a0: 766f 6964 696e 6720 7669 6577 7320 656e  voiding views en
+000078b0: 7375 7265 7320 7468 6572 6520 6172 6520  sures there are 
+000078c0: 6e6f 2072 656d 6169 6e69 6e67 2072 6566  no remaining ref
+000078d0: 6572 656e 6365 7320 746f 2074 6865 2073  erences to the s
+000078e0: 6f75 7263 650a 2020 2020 2020 2020 2020  ource.          
+000078f0: 2020 2320 2020 2020 2020 6e75 6d70 792d    #       numpy-
+00007900: 6172 7261 792c 2061 6c6c 6f77 696e 6720  array, allowing 
+00007910: 6974 2074 6f20 6265 2063 6c65 6172 6564  it to be cleared
+00007920: 2066 726f 6d20 6d65 6d6f 7279 0a20 2020   from memory.   
+00007930: 2020 2020 2020 2020 2072 6566 5f64 6174           ref_dat
+00007940: 615b 6368 616e 6e65 6c5f 6964 782c 2074  a[channel_idx, t
+00007950: 7269 616c 5f69 6478 2c20 6c6f 6361 6c5f  rial_idx, local_
+00007960: 7374 6172 743a 6c6f 6361 6c5f 656e 645d  start:local_end]
+00007970: 203d 2063 6861 6e6e 656c 5f64 6174 615b   = channel_data[
+00007980: 7472 6961 6c5f 7361 6d70 6c65 5f73 7461  trial_sample_sta
+00007990: 7274 3a74 7269 616c 5f73 616d 706c 655f  rt:trial_sample_
+000079a0: 656e 645d 2e63 6f70 7928 290a 0a20 2020  end].copy()..   
+000079b0: 2020 2020 2065 6c69 6620 6261 7365 6c69       elif baseli
+000079c0: 6e65 5f6d 6574 686f 6420 3d3d 2031 3a0a  ne_method == 1:.
+000079d0: 2020 2020 2020 2020 2020 2020 6261 7365              base
+000079e0: 6c69 6e65 5f6d 6561 6e20 3d20 6e70 2e6e  line_mean = np.n
+000079f0: 616e 6d65 616e 2863 6861 6e6e 656c 5f64  anmean(channel_d
+00007a00: 6174 615b 6261 7365 6c69 6e65 5f73 7461  ata[baseline_sta
+00007a10: 7274 5f73 616d 706c 653a 6261 7365 6c69  rt_sample:baseli
+00007a20: 6e65 5f65 6e64 5f73 616d 706c 655d 290a  ne_end_sample]).
+00007a30: 2020 2020 2020 2020 2020 2020 7265 665f              ref_
+00007a40: 6461 7461 5b63 6861 6e6e 656c 5f69 6478  data[channel_idx
+00007a50: 2c20 7472 6961 6c5f 6964 782c 206c 6f63  , trial_idx, loc
+00007a60: 616c 5f73 7461 7274 3a6c 6f63 616c 5f65  al_start:local_e
+00007a70: 6e64 5d20 3d20 6368 616e 6e65 6c5f 6461  nd] = channel_da
+00007a80: 7461 5b74 7269 616c 5f73 616d 706c 655f  ta[trial_sample_
+00007a90: 7374 6172 743a 7472 6961 6c5f 7361 6d70  start:trial_samp
+00007aa0: 6c65 5f65 6e64 5d20 2d20 6261 7365 6c69  le_end] - baseli
+00007ab0: 6e65 5f6d 6561 6e0a 2020 2020 2020 2020  ne_mean.        
+00007ac0: 656c 6966 2062 6173 656c 696e 655f 6d65  elif baseline_me
+00007ad0: 7468 6f64 203d 3d20 323a 0a20 2020 2020  thod == 2:.     
+00007ae0: 2020 2020 2020 2062 6173 656c 696e 655f         baseline_
+00007af0: 6d65 6469 616e 203d 206e 702e 6e61 6e6d  median = np.nanm
+00007b00: 6564 6961 6e28 6368 616e 6e65 6c5f 6461  edian(channel_da
+00007b10: 7461 5b62 6173 656c 696e 655f 7374 6172  ta[baseline_star
+00007b20: 745f 7361 6d70 6c65 3a62 6173 656c 696e  t_sample:baselin
+00007b30: 655f 656e 645f 7361 6d70 6c65 5d29 0a20  e_end_sample]). 
+00007b40: 2020 2020 2020 2020 2020 2072 6566 5f64             ref_d
+00007b50: 6174 615b 6368 616e 6e65 6c5f 6964 782c  ata[channel_idx,
+00007b60: 2074 7269 616c 5f69 6478 2c20 6c6f 6361   trial_idx, loca
+00007b70: 6c5f 7374 6172 743a 6c6f 6361 6c5f 656e  l_start:local_en
+00007b80: 645d 203d 2063 6861 6e6e 656c 5f64 6174  d] = channel_dat
+00007b90: 615b 7472 6961 6c5f 7361 6d70 6c65 5f73  a[trial_sample_s
+00007ba0: 7461 7274 3a74 7269 616c 5f73 616d 706c  tart:trial_sampl
+00007bb0: 655f 656e 645d 202d 2062 6173 656c 696e  e_end] - baselin
+00007bc0: 655f 6d65 6469 616e 0a0a 2020 2020 2320  e_median..    # 
+00007bd0: 7265 7475 726e 2073 7563 6365 7373 0a20  return success. 
+00007be0: 2020 2072 6574 7572 6e20 7265 665f 6461     return ref_da
+00007bf0: 7461 0a0a 0a64 6566 205f 5f6c 6f61 645f  ta...def __load_
+00007c00: 6461 7461 5f65 706f 6368 735f 5f62 795f  data_epochs__by_
+00007c10: 6368 616e 6e65 6c73 2864 6174 615f 7265  channels(data_re
+00007c20: 6164 6572 2c20 7265 7472 6965 7665 5f63  ader, retrieve_c
+00007c30: 6861 6e6e 656c 732c 0a20 2020 2020 2020  hannels,.       
 00007c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c50: 6f6e 7365 7473 2c20 7472 6961 6c5f 6570  onsets, trial_ep
-00007c60: 6f63 682c 0a20 2020 2020 2020 2020 2020  och,.           
-00007c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007c80: 2020 2020 2020 2020 2062 6173 656c 696e           baselin
-00007c90: 655f 6d65 7468 6f64 2c20 6261 7365 6c69  e_method, baseli
-00007ca0: 6e65 5f65 706f 6368 2c20 6f75 745f 6f66  ne_epoch, out_of
-00007cb0: 5f62 6f75 6e64 5f6d 6574 686f 6429 3a0a  _bound_method):.
-00007cc0: 2020 2020 2222 220a 2020 2020 4c6f 6164      """.    Load
-00007cd0: 2064 6174 6120 6570 6f63 6873 2074 6f20   data epochs to 
-00007ce0: 6120 6d61 7472 6978 2028 666f 726d 6174  a matrix (format
-00007cf0: 3a20 6368 616e 6e65 6c20 7820 7472 6961  : channel x tria
-00007d00: 6c73 2f65 706f 6368 7320 7820 7469 6d65  ls/epochs x time
-00007d10: 2920 6279 2069 7465 7261 7469 6e67 206f  ) by iterating o
-00007d20: 7665 7220 616e 6420 6c6f 6164 696e 6720  ver and loading 
-00007d30: 6461 7461 2070 6572 2063 6861 6e6e 656c  data per channel
-00007d40: 0a20 2020 2061 6e64 2072 6574 7269 6576  .    and retriev
-00007d50: 696e 6720 7468 6520 7472 6961 6c2d 6570  ing the trial-ep
-00007d60: 6f63 6873 0a0a 2020 2020 4e6f 7465 3a20  ochs..    Note: 
-00007d70: 2020 5369 6e63 6520 7468 6973 206d 6574    Since this met
-00007d80: 686f 6420 7265 7472 6965 7665 7320 7468  hod retrieves th
-00007d90: 6520 6461 7461 206f 6620 6120 7369 6e67  e data of a sing
-00007da0: 6c65 2063 6861 6e6e 656c 2062 6566 6f72  le channel befor
-00007db0: 6520 6578 7472 6163 7469 6e67 2074 6865  e extracting the
-00007dc0: 2065 706f 6368 732c 2069 7420 6973 2072   epochs, it is r
-00007dd0: 6561 736f 6e61 626c 7920 6d65 6d6f 7279  easonably memory
-00007de0: 0a20 2020 2020 2020 2020 2020 2065 6666  .            eff
-00007df0: 6963 6965 6e74 2e20 4974 2069 7320 7765  icient. It is we
-00007e00: 6c6c 2073 7569 7465 6420 666f 7220 4546  ll suited for EF
-00007e10: 4420 6f72 2042 7261 696e 5669 7369 6f6e  D or BrainVision
-00007e20: 2073 696e 6365 204d 4e45 206c 6f61 6473   since MNE loads
-00007e30: 2074 6865 2065 6e74 6972 6520 7365 7420   the entire set 
-00007e40: 696e 206d 656d 6f72 7920 616e 7977 6179  in memory anyway
-00007e50: 2e20 486f 7765 7665 722c 0a20 2020 2020  . However,.     
-00007e60: 2020 2020 2020 2077 6865 6e20 7468 6520         when the 
-00007e70: 4d45 4633 2066 6f72 6d61 7420 6973 2075  MEF3 format is u
-00007e80: 7365 642c 2065 706f 6368 696e 6720 6361  sed, epoching ca
-00007e90: 6e20 6265 2070 6572 666f 726d 6564 2065  n be performed e
-00007ea0: 7665 6e20 6d6f 7265 206d 656d 6f72 7920  ven more memory 
-00007eb0: 6566 6669 6369 656e 7420 7573 696e 670a  efficient using.
-00007ec0: 2020 2020 2020 2020 2020 2020 7468 6520              the 
-00007ed0: 275f 5f6c 6f61 645f 6461 7461 5f65 706f  '__load_data_epo
-00007ee0: 6368 735f 5f62 795f 7472 6961 6c27 206d  chs__by_trial' m
-00007ef0: 6574 686f 6420 2877 6869 6368 2073 686f  ethod (which sho
-00007f00: 756c 6420 6265 2065 7175 616c 6c79 2066  uld be equally f
-00007f10: 6173 7420 6f72 2065 7665 6e20 6661 7374  ast or even fast
-00007f20: 6572 290a 0a20 2020 2041 7267 733a 0a20  er)..    Args:. 
-00007f30: 2020 2020 2020 2064 6174 615f 7265 6164         data_read
-00007f40: 6572 2028 4965 6567 4461 7461 5265 6164  er (IeegDataRead
-00007f50: 6572 293a 2020 2020 2020 2041 6e20 696e  er):       An in
-00007f60: 7374 616e 6365 206f 6620 7468 6520 4965  stance of the Ie
-00007f70: 6567 4461 7461 5265 6164 6572 2074 6f20  egDataReader to 
-00007f80: 7265 7472 6965 7665 206d 6574 6164 6174  retrieve metadat
-00007f90: 6120 616e 6420 6368 616e 6e65 6c20 6461  a and channel da
-00007fa0: 7461 0a20 2020 2020 2020 2072 6574 7269  ta.        retri
-00007fb0: 6576 655f 6368 616e 6e65 6c73 2028 6c69  eve_channels (li
-00007fc0: 7374 206f 7220 7475 706c 6529 3a20 2054  st or tuple):  T
-00007fd0: 6865 2063 6861 6e6e 656c 7320 2862 7920  he channels (by 
-00007fe0: 6e61 6d65 2920 6f66 2077 6869 6368 2074  name) of which t
-00007ff0: 6865 2064 6174 6120 7368 6f75 6c64 2062  he data should b
-00008000: 6520 7265 7472 6965 7665 642c 2074 6865  e retrieved, the
-00008010: 206f 7574 7075 740a 2020 2020 2020 2020   output.        
-00008020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c50: 2020 2020 2020 2020 2020 2020 206f 6e73               ons
+00007c60: 6574 732c 2074 7269 616c 5f65 706f 6368  ets, trial_epoch
+00007c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00007c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c90: 2020 2020 2020 6261 7365 6c69 6e65 5f6d        baseline_m
+00007ca0: 6574 686f 642c 2062 6173 656c 696e 655f  ethod, baseline_
+00007cb0: 6570 6f63 682c 206f 7574 5f6f 665f 626f  epoch, out_of_bo
+00007cc0: 756e 645f 6d65 7468 6f64 293a 0a20 2020  und_method):.   
+00007cd0: 2022 2222 0a20 2020 204c 6f61 6420 6461   """.    Load da
+00007ce0: 7461 2065 706f 6368 7320 746f 2061 206d  ta epochs to a m
+00007cf0: 6174 7269 7820 2866 6f72 6d61 743a 2063  atrix (format: c
+00007d00: 6861 6e6e 656c 2078 2074 7269 616c 732f  hannel x trials/
+00007d10: 6570 6f63 6873 2078 2074 696d 6529 2062  epochs x time) b
+00007d20: 7920 6974 6572 6174 696e 6720 6f76 6572  y iterating over
+00007d30: 2061 6e64 206c 6f61 6469 6e67 2064 6174   and loading dat
+00007d40: 6120 7065 7220 6368 616e 6e65 6c0a 2020  a per channel.  
+00007d50: 2020 616e 6420 7265 7472 6965 7669 6e67    and retrieving
+00007d60: 2074 6865 2074 7269 616c 2d65 706f 6368   the trial-epoch
+00007d70: 730a 0a20 2020 204e 6f74 653a 2020 2053  s..    Note:   S
+00007d80: 696e 6365 2074 6869 7320 6d65 7468 6f64  ince this method
+00007d90: 2072 6574 7269 6576 6573 2074 6865 2064   retrieves the d
+00007da0: 6174 6120 6f66 2061 2073 696e 676c 6520  ata of a single 
+00007db0: 6368 616e 6e65 6c20 6265 666f 7265 2065  channel before e
+00007dc0: 7874 7261 6374 696e 6720 7468 6520 6570  xtracting the ep
+00007dd0: 6f63 6873 2c20 6974 2069 7320 7265 6173  ochs, it is reas
+00007de0: 6f6e 6162 6c79 206d 656d 6f72 790a 2020  onably memory.  
+00007df0: 2020 2020 2020 2020 2020 6566 6669 6369            effici
+00007e00: 656e 742e 2049 7420 6973 2077 656c 6c20  ent. It is well 
+00007e10: 7375 6974 6564 2066 6f72 2045 4644 206f  suited for EFD o
+00007e20: 7220 4272 6169 6e56 6973 696f 6e20 7369  r BrainVision si
+00007e30: 6e63 6520 4d4e 4520 6c6f 6164 7320 7468  nce MNE loads th
+00007e40: 6520 656e 7469 7265 2073 6574 2069 6e20  e entire set in 
+00007e50: 6d65 6d6f 7279 2061 6e79 7761 792e 2048  memory anyway. H
+00007e60: 6f77 6576 6572 2c0a 2020 2020 2020 2020  owever,.        
+00007e70: 2020 2020 7768 656e 2074 6865 204d 4546      when the MEF
+00007e80: 3320 666f 726d 6174 2069 7320 7573 6564  3 format is used
+00007e90: 2c20 6570 6f63 6869 6e67 2063 616e 2062  , epoching can b
+00007ea0: 6520 7065 7266 6f72 6d65 6420 6576 656e  e performed even
+00007eb0: 206d 6f72 6520 6d65 6d6f 7279 2065 6666   more memory eff
+00007ec0: 6963 6965 6e74 2075 7369 6e67 0a20 2020  icient using.   
+00007ed0: 2020 2020 2020 2020 2074 6865 2027 5f5f           the '__
+00007ee0: 6c6f 6164 5f64 6174 615f 6570 6f63 6873  load_data_epochs
+00007ef0: 5f5f 6279 5f74 7269 616c 2720 6d65 7468  __by_trial' meth
+00007f00: 6f64 2028 7768 6963 6820 7368 6f75 6c64  od (which should
+00007f10: 2062 6520 6571 7561 6c6c 7920 6661 7374   be equally fast
+00007f20: 206f 7220 6576 656e 2066 6173 7465 7229   or even faster)
+00007f30: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00007f40: 2020 2020 6461 7461 5f72 6561 6465 7220      data_reader 
+00007f50: 2849 6565 6744 6174 6152 6561 6465 7229  (IeegDataReader)
+00007f60: 3a20 2020 2020 2020 416e 2069 6e73 7461  :       An insta
+00007f70: 6e63 6520 6f66 2074 6865 2049 6565 6744  nce of the IeegD
+00007f80: 6174 6152 6561 6465 7220 746f 2072 6574  ataReader to ret
+00007f90: 7269 6576 6520 6d65 7461 6461 7461 2061  rieve metadata a
+00007fa0: 6e64 2063 6861 6e6e 656c 2064 6174 610a  nd channel data.
+00007fb0: 2020 2020 2020 2020 7265 7472 6965 7665          retrieve
+00007fc0: 5f63 6861 6e6e 656c 7320 286c 6973 7420  _channels (list 
+00007fd0: 6f72 2074 7570 6c65 293a 2020 5468 6520  or tuple):  The 
+00007fe0: 6368 616e 6e65 6c73 2028 6279 206e 616d  channels (by nam
+00007ff0: 6529 206f 6620 7768 6963 6820 7468 6520  e) of which the 
+00008000: 6461 7461 2073 686f 756c 6420 6265 2072  data should be r
+00008010: 6574 7269 6576 6564 2c20 7468 6520 6f75  etrieved, the ou
+00008020: 7470 7574 0a20 2020 2020 2020 2020 2020  tput.           
 00008030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008040: 2020 2020 7769 6c6c 2062 6520 736f 7274      will be sort
-00008050: 6564 2061 6363 6f72 6469 6e67 6c79 0a20  ed accordingly. 
-00008060: 2020 2022 2222 0a0a 2020 2020 2320 6361     """..    # ca
-00008070: 6c63 756c 6174 6520 7468 6520 7369 7a65  lculate the size
-00008080: 206f 6620 7468 6520 7469 6d65 2064 696d   of the time dim
-00008090: 656e 7369 6f6e 2028 696e 2073 616d 706c  ension (in sampl
-000080a0: 6573 290a 2020 2020 7472 6961 6c5f 6e75  es).    trial_nu
-000080b0: 6d5f 7361 6d70 6c65 7320 3d20 696e 7428  m_samples = int(
-000080c0: 726f 756e 6428 6162 7328 7472 6961 6c5f  round(abs(trial_
-000080d0: 6570 6f63 685b 315d 202d 2074 7269 616c  epoch[1] - trial
-000080e0: 5f65 706f 6368 5b30 5d29 202a 2064 6174  _epoch[0]) * dat
-000080f0: 615f 7265 6164 6572 2e73 616d 706c 696e  a_reader.samplin
-00008100: 675f 7261 7465 2929 0a20 2020 2062 6173  g_rate)).    bas
-00008110: 656c 696e 655f 6e75 6d5f 7361 6d70 6c65  eline_num_sample
-00008120: 7320 3d20 696e 7428 726f 756e 6428 6162  s = int(round(ab
-00008130: 7328 6261 7365 6c69 6e65 5f65 706f 6368  s(baseline_epoch
-00008140: 5b31 5d20 2d20 6261 7365 6c69 6e65 5f65  [1] - baseline_e
-00008150: 706f 6368 5b30 5d29 202a 2064 6174 615f  poch[0]) * data_
-00008160: 7265 6164 6572 2e73 616d 706c 696e 675f  reader.sampling_
-00008170: 7261 7465 2929 0a0a 2020 2020 2320 696e  rate))..    # in
-00008180: 6974 6961 6c69 7a65 2061 2064 6174 6120  itialize a data 
-00008190: 6275 6666 6572 2028 6368 616e 6e65 6c20  buffer (channel 
-000081a0: 7820 7472 6961 6c73 2f65 706f 6368 7320  x trials/epochs 
-000081b0: 7820 7469 6d65 290a 2020 2020 7472 793a  x time).    try:
-000081c0: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
-000081d0: 616c 6c6f 6361 7465 5f61 7272 6179 2828  allocate_array((
-000081e0: 6c65 6e28 7265 7472 6965 7665 5f63 6861  len(retrieve_cha
-000081f0: 6e6e 656c 7329 2c20 6c65 6e28 6f6e 7365  nnels), len(onse
-00008200: 7473 292c 2074 7269 616c 5f6e 756d 5f73  ts), trial_num_s
-00008210: 616d 706c 6573 2929 0a20 2020 2065 7863  amples)).    exc
-00008220: 6570 7420 4d65 6d6f 7279 4572 726f 723a  ept MemoryError:
-00008230: 0a20 2020 2020 2020 2072 6169 7365 204d  .        raise M
-00008240: 656d 6f72 7945 7272 6f72 2827 4e6f 7420  emoryError('Not 
-00008250: 656e 6f75 6768 206d 656d 6f72 7920 6372  enough memory cr
-00008260: 6561 7465 2061 2064 6174 6120 6f75 7470  eate a data outp
-00008270: 7574 206d 6174 7269 7827 290a 0a20 2020  ut matrix')..   
-00008280: 2023 206c 6f6f 7020 7468 726f 7567 6820   # loop through 
-00008290: 7468 6520 696e 636c 7564 6564 2063 6861  the included cha
-000082a0: 6e6e 656c 730a 2020 2020 666f 7220 6368  nnels.    for ch
-000082b0: 616e 6e65 6c5f 6964 7820 696e 2072 616e  annel_idx in ran
-000082c0: 6765 286c 656e 2872 6574 7269 6576 655f  ge(len(retrieve_
-000082d0: 6368 616e 6e65 6c73 2929 3a0a 0a20 2020  channels)):..   
-000082e0: 2020 2020 2074 7279 3a0a 0a20 2020 2020       try:..     
-000082f0: 2020 2020 2020 2023 2072 6574 7269 6576         # retriev
-00008300: 6520 7468 6520 6368 616e 6e65 6c20 6461  e the channel da
-00008310: 7461 0a20 2020 2020 2020 2020 2020 2063  ta.            c
-00008320: 6861 6e6e 656c 5f64 6174 6120 3d20 6461  hannel_data = da
-00008330: 7461 5f72 6561 6465 722e 7265 7472 6965  ta_reader.retrie
-00008340: 7665 5f63 6861 6e6e 656c 5f64 6174 6128  ve_channel_data(
-00008350: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
-00008360: 735b 6368 616e 6e65 6c5f 6964 785d 2c20  s[channel_idx], 
-00008370: 4661 6c73 6529 0a0a 2020 2020 2020 2020  False)..        
-00008380: 2020 2020 2320 6570 6f63 6820 7468 6520      # epoch the 
-00008390: 6368 616e 6e65 6c20 6461 7461 0a20 2020  channel data.   
-000083a0: 2020 2020 2020 2020 205f 5f65 706f 6368           __epoch
-000083b0: 5f64 6174 615f 5f66 726f 6d5f 6368 616e  _data__from_chan
-000083c0: 6e65 6c5f 6461 7461 5f5f 6279 5f74 7269  nel_data__by_tri
-000083d0: 616c 7328 6461 7461 2c0a 2020 2020 2020  als(data,.      
-000083e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008050: 2077 696c 6c20 6265 2073 6f72 7465 6420   will be sorted 
+00008060: 6163 636f 7264 696e 676c 790a 2020 2020  accordingly.    
+00008070: 2222 220a 0a20 2020 2023 2063 616c 6375  """..    # calcu
+00008080: 6c61 7465 2074 6865 2073 697a 6520 6f66  late the size of
+00008090: 2074 6865 2074 696d 6520 6469 6d65 6e73   the time dimens
+000080a0: 696f 6e20 2869 6e20 7361 6d70 6c65 7329  ion (in samples)
+000080b0: 0a20 2020 2074 7269 616c 5f6e 756d 5f73  .    trial_num_s
+000080c0: 616d 706c 6573 203d 2069 6e74 2872 6f75  amples = int(rou
+000080d0: 6e64 2861 6273 2874 7269 616c 5f65 706f  nd(abs(trial_epo
+000080e0: 6368 5b31 5d20 2d20 7472 6961 6c5f 6570  ch[1] - trial_ep
+000080f0: 6f63 685b 305d 2920 2a20 6461 7461 5f72  och[0]) * data_r
+00008100: 6561 6465 722e 7361 6d70 6c69 6e67 5f72  eader.sampling_r
+00008110: 6174 6529 290a 2020 2020 6261 7365 6c69  ate)).    baseli
+00008120: 6e65 5f6e 756d 5f73 616d 706c 6573 203d  ne_num_samples =
+00008130: 2069 6e74 2872 6f75 6e64 2861 6273 2862   int(round(abs(b
+00008140: 6173 656c 696e 655f 6570 6f63 685b 315d  aseline_epoch[1]
+00008150: 202d 2062 6173 656c 696e 655f 6570 6f63   - baseline_epoc
+00008160: 685b 305d 2920 2a20 6461 7461 5f72 6561  h[0]) * data_rea
+00008170: 6465 722e 7361 6d70 6c69 6e67 5f72 6174  der.sampling_rat
+00008180: 6529 290a 0a20 2020 2023 2069 6e69 7469  e))..    # initi
+00008190: 616c 697a 6520 6120 6461 7461 2062 7566  alize a data buf
+000081a0: 6665 7220 2863 6861 6e6e 656c 2078 2074  fer (channel x t
+000081b0: 7269 616c 732f 6570 6f63 6873 2078 2074  rials/epochs x t
+000081c0: 696d 6529 0a20 2020 2074 7279 3a0a 2020  ime).    try:.  
+000081d0: 2020 2020 2020 6461 7461 203d 2061 6c6c        data = all
+000081e0: 6f63 6174 655f 6172 7261 7928 286c 656e  ocate_array((len
+000081f0: 2872 6574 7269 6576 655f 6368 616e 6e65  (retrieve_channe
+00008200: 6c73 292c 206c 656e 286f 6e73 6574 7329  ls), len(onsets)
+00008210: 2c20 7472 6961 6c5f 6e75 6d5f 7361 6d70  , trial_num_samp
+00008220: 6c65 7329 290a 2020 2020 6578 6365 7074  les)).    except
+00008230: 204d 656d 6f72 7945 7272 6f72 3a0a 2020   MemoryError:.  
+00008240: 2020 2020 2020 7261 6973 6520 4d65 6d6f        raise Memo
+00008250: 7279 4572 726f 7228 274e 6f74 2065 6e6f  ryError('Not eno
+00008260: 7567 6820 6d65 6d6f 7279 2063 7265 6174  ugh memory creat
+00008270: 6520 6120 6461 7461 206f 7574 7075 7420  e a data output 
+00008280: 6d61 7472 6978 2729 0a0a 2020 2020 2320  matrix')..    # 
+00008290: 6c6f 6f70 2074 6872 6f75 6768 2074 6865  loop through the
+000082a0: 2069 6e63 6c75 6465 6420 6368 616e 6e65   included channe
+000082b0: 6c73 0a20 2020 2066 6f72 2063 6861 6e6e  ls.    for chann
+000082c0: 656c 5f69 6478 2069 6e20 7261 6e67 6528  el_idx in range(
+000082d0: 6c65 6e28 7265 7472 6965 7665 5f63 6861  len(retrieve_cha
+000082e0: 6e6e 656c 7329 293a 0a0a 2020 2020 2020  nnels)):..      
+000082f0: 2020 7472 793a 0a0a 2020 2020 2020 2020    try:..        
+00008300: 2020 2020 2320 7265 7472 6965 7665 2074      # retrieve t
+00008310: 6865 2063 6861 6e6e 656c 2064 6174 610a  he channel data.
+00008320: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00008330: 6e65 6c5f 6461 7461 203d 2064 6174 615f  nel_data = data_
+00008340: 7265 6164 6572 2e72 6574 7269 6576 655f  reader.retrieve_
+00008350: 6368 616e 6e65 6c5f 6461 7461 2872 6574  channel_data(ret
+00008360: 7269 6576 655f 6368 616e 6e65 6c73 5b63  rieve_channels[c
+00008370: 6861 6e6e 656c 5f69 6478 5d2c 2046 616c  hannel_idx], Fal
+00008380: 7365 290a 0a20 2020 2020 2020 2020 2020  se)..           
+00008390: 2023 2065 706f 6368 2074 6865 2063 6861   # epoch the cha
+000083a0: 6e6e 656c 2064 6174 610a 2020 2020 2020  nnel data.      
+000083b0: 2020 2020 2020 5f5f 6570 6f63 685f 6461        __epoch_da
+000083c0: 7461 5f5f 6672 6f6d 5f63 6861 6e6e 656c  ta__from_channel
+000083d0: 5f64 6174 615f 5f62 795f 7472 6961 6c73  _data__by_trials
+000083e0: 2864 6174 612c 0a20 2020 2020 2020 2020  (data,.         
 000083f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008410: 6368 616e 6e65 6c5f 6964 782c 2063 6861  channel_idx, cha
-00008420: 6e6e 656c 5f64 6174 612c 2064 6174 615f  nnel_data, data_
-00008430: 7265 6164 6572 2e73 616d 706c 696e 675f  reader.sampling_
-00008440: 7261 7465 2c0a 2020 2020 2020 2020 2020  rate,.          
-00008450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008410: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+00008420: 6e6e 656c 5f69 6478 2c20 6368 616e 6e65  nnel_idx, channe
+00008430: 6c5f 6461 7461 2c20 6461 7461 5f72 6561  l_data, data_rea
+00008440: 6465 722e 7361 6d70 6c69 6e67 5f72 6174  der.sampling_rat
+00008450: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
 00008460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008470: 2020 2020 2020 2020 2020 2020 6f6e 7365              onse
-00008480: 7473 2c20 7472 6961 6c5f 6e75 6d5f 7361  ts, trial_num_sa
-00008490: 6d70 6c65 732c 2074 7269 616c 5f65 706f  mples, trial_epo
-000084a0: 6368 2c0a 2020 2020 2020 2020 2020 2020  ch,.            
-000084b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008480: 2020 2020 2020 2020 206f 6e73 6574 732c           onsets,
+00008490: 2074 7269 616c 5f6e 756d 5f73 616d 706c   trial_num_sampl
+000084a0: 6573 2c20 7472 6961 6c5f 6570 6f63 682c  es, trial_epoch,
+000084b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 000084c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084d0: 2020 2020 2020 2020 2020 6261 7365 6c69            baseli
-000084e0: 6e65 5f6e 756d 5f73 616d 706c 6573 2c20  ne_num_samples, 
-000084f0: 6261 7365 6c69 6e65 5f6d 6574 686f 642c  baseline_method,
-00008500: 2062 6173 656c 696e 655f 6570 6f63 682c   baseline_epoch,
-00008510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000084d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084e0: 2020 2020 2020 2062 6173 656c 696e 655f         baseline_
+000084f0: 6e75 6d5f 7361 6d70 6c65 732c 2062 6173  num_samples, bas
+00008500: 656c 696e 655f 6d65 7468 6f64 2c20 6261  eline_method, ba
+00008510: 7365 6c69 6e65 5f65 706f 6368 2c0a 2020  seline_epoch,.  
 00008520: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00008530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008540: 2020 2020 2020 206f 7574 5f6f 665f 626f         out_of_bo
-00008550: 756e 645f 6d65 7468 6f64 290a 2020 2020  und_method).    
-00008560: 2020 2020 6578 6365 7074 2052 756e 7469      except Runti
-00008570: 6d65 4572 726f 723a 0a20 2020 2020 2020  meError:.       
-00008580: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
-00008590: 6d65 4572 726f 7228 2745 7272 6f72 2075  meError('Error u
-000085a0: 706f 6e20 6c6f 6164 696e 6720 616e 6420  pon loading and 
-000085b0: 6570 6f63 6869 6e67 2064 6174 6127 290a  epoching data').
-000085c0: 0a20 2020 2020 2020 2023 0a20 2020 2020  .        #.     
-000085d0: 2020 2064 656c 2063 6861 6e6e 656c 5f64     del channel_d
-000085e0: 6174 610a 0a20 2020 2023 2072 6574 7572  ata..    # retur
-000085f0: 6e20 7468 6520 7361 6d70 6c65 2072 6174  n the sample rat
-00008600: 6520 616e 6420 7468 6520 6570 6f63 6865  e and the epoche
-00008610: 6420 6461 7461 0a20 2020 2072 6574 7572  d data.    retur
-00008620: 6e20 6461 7461 5f72 6561 6465 722e 7361  n data_reader.sa
-00008630: 6d70 6c69 6e67 5f72 6174 652c 2064 6174  mpling_rate, dat
-00008640: 610a 0a0a 6465 6620 5f5f 6c6f 6164 5f64  a...def __load_d
-00008650: 6174 615f 6570 6f63 6873 5f5f 6279 5f74  ata_epochs__by_t
-00008660: 7269 616c 2864 6174 615f 7265 6164 6572  rial(data_reader
-00008670: 2c20 7265 7472 6965 7665 5f63 6861 6e6e  , retrieve_chann
-00008680: 656c 732c 0a20 2020 2020 2020 2020 2020  els,.           
-00008690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086a0: 2020 2020 2020 6f6e 7365 7473 2c20 7472        onsets, tr
-000086b0: 6961 6c5f 6570 6f63 682c 0a20 2020 2020  ial_epoch,.     
-000086c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086d0: 2020 2020 2020 2020 2020 2020 6261 7365              base
-000086e0: 6c69 6e65 5f6d 6574 686f 642c 2062 6173  line_method, bas
-000086f0: 656c 696e 655f 6570 6f63 682c 206f 7574  eline_epoch, out
-00008700: 5f6f 665f 626f 756e 645f 6d65 7468 6f64  _of_bound_method
-00008710: 293a 0a20 2020 2022 2222 0a20 2020 204c  ):.    """.    L
-00008720: 6f61 6420 6461 7461 2065 706f 6368 7320  oad data epochs 
-00008730: 746f 2061 206d 6174 7269 7820 2866 6f72  to a matrix (for
-00008740: 6d61 743a 2063 6861 6e6e 656c 2078 2074  mat: channel x t
-00008750: 7269 616c 732f 6570 6f63 6873 2078 2074  rials/epochs x t
-00008760: 696d 6529 2062 7920 6c6f 6f70 696e 6720  ime) by looping 
-00008770: 6f76 6572 2061 6e64 206c 6f61 6469 6e67  over and loading
-00008780: 2064 6174 6120 7065 720a 2020 2020 7472   data per.    tr
-00008790: 6961 6c20 2866 6f72 2061 6c6c 2063 6861  ial (for all cha
-000087a0: 6e6e 656c 7329 2061 6e64 2072 6574 7269  nnels) and retri
-000087b0: 6576 696e 6720 7468 6520 7472 6961 6c20  eving the trial 
-000087c0: 6461 7461 2062 7920 6974 6572 6174 696e  data by iteratin
-000087d0: 6720 6f76 6572 2065 6163 6820 6f66 2074  g over each of t
-000087e0: 6865 2063 6861 6e6e 656c 730a 0a20 2020  he channels..   
-000087f0: 204e 6f74 653a 2020 2045 7370 6563 6961   Note:   Especia
-00008800: 6c6c 7920 666f 7220 7468 6520 4d45 4633  lly for the MEF3
-00008810: 2066 6f72 6d61 7420 7468 6973 2069 7320   format this is 
-00008820: 7468 6520 6d6f 7374 206d 656d 6f72 7920  the most memory 
-00008830: 6566 6669 6369 656e 7420 6265 6361 7573  efficient becaus
-00008840: 6520 6f6e 6c79 2074 6865 206d 696e 696d  e only the minim
-00008850: 756d 2061 6d6f 756e 7420 6f66 2064 6174  um amount of dat
-00008860: 610a 2020 2020 2020 2020 2020 2020 6973  a.            is
-00008870: 206c 6f61 6465 6420 696e 746f 206d 656d   loaded into mem
-00008880: 6f72 792c 2077 6869 6368 2073 686f 756c  ory, which shoul
-00008890: 6420 616c 736f 2062 6520 6661 7374 6572  d also be faster
-000088a0: 2062 6563 6175 7365 206c 6573 7320 6461   because less da
-000088b0: 7461 2069 7320 7265 6164 2066 726f 6d20  ta is read from 
-000088c0: 7468 6520 6469 736b 2e20 466f 7220 4544  the disk. For ED
-000088d0: 4620 616e 640a 2020 2020 2020 2020 2020  F and.          
-000088e0: 2020 4272 6169 6e76 6973 696f 6e20 7468    Brainvision th
-000088f0: 6572 6520 6e6f 2062 656e 6566 6974 2c20  ere no benefit, 
-00008900: 7369 6e63 6520 7468 6573 6520 666f 726d  since these form
-00008910: 6174 7320 6172 6520 6c6f 6164 6564 2077  ats are loaded w
-00008920: 6974 6820 4d4e 452c 2077 6869 6368 206c  ith MNE, which l
-00008930: 6f61 6420 7468 6520 656e 7469 7265 2064  oad the entire d
-00008940: 6174 6173 6574 2069 6e74 6f0a 2020 2020  ataset into.    
-00008950: 2020 2020 2020 2020 6d65 6d6f 7279 2066          memory f
-00008960: 6972 7374 2e0a 0a20 2020 2041 7267 733a  irst...    Args:
-00008970: 0a20 2020 2020 2020 2064 6174 615f 7265  .        data_re
-00008980: 6164 6572 2028 4965 6567 4461 7461 5265  ader (IeegDataRe
-00008990: 6164 6572 293a 2020 2020 2020 2041 6e20  ader):       An 
-000089a0: 696e 7374 616e 6365 206f 6620 7468 6520  instance of the 
-000089b0: 4965 6567 4461 7461 5265 6164 6572 2074  IeegDataReader t
-000089c0: 6f20 7265 7472 6965 7665 206d 6574 6164  o retrieve metad
-000089d0: 6174 6120 616e 6420 6368 616e 6e65 6c20  ata and channel 
-000089e0: 6461 7461 0a20 2020 2020 2020 2072 6574  data.        ret
-000089f0: 7269 6576 655f 6368 616e 6e65 6c73 2028  rieve_channels (
-00008a00: 6c69 7374 206f 7220 7475 706c 6529 3a20  list or tuple): 
-00008a10: 2054 6865 2063 6861 6e6e 656c 7320 2862   The channels (b
-00008a20: 7920 6e61 6d65 2920 6f66 2077 6869 6368  y name) of which
-00008a30: 2074 6865 2064 6174 6120 7368 6f75 6c64   the data should
-00008a40: 2062 6520 7265 7472 6965 7665 642c 2074   be retrieved, t
-00008a50: 6865 206f 7574 7075 740a 2020 2020 2020  he output.      
-00008a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008550: 2020 2020 6f75 745f 6f66 5f62 6f75 6e64      out_of_bound
+00008560: 5f6d 6574 686f 6429 0a20 2020 2020 2020  _method).       
+00008570: 2065 7863 6570 7420 5275 6e74 696d 6545   except RuntimeE
+00008580: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00008590: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+000085a0: 7272 6f72 2827 4572 726f 7220 7570 6f6e  rror('Error upon
+000085b0: 206c 6f61 6469 6e67 2061 6e64 2065 706f   loading and epo
+000085c0: 6368 696e 6720 6461 7461 2729 0a0a 2020  ching data')..  
+000085d0: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+000085e0: 6465 6c20 6368 616e 6e65 6c5f 6461 7461  del channel_data
+000085f0: 0a0a 2020 2020 2320 7265 7475 726e 2074  ..    # return t
+00008600: 6865 2073 616d 706c 6520 7261 7465 2061  he sample rate a
+00008610: 6e64 2074 6865 2065 706f 6368 6564 2064  nd the epoched d
+00008620: 6174 610a 2020 2020 7265 7475 726e 2064  ata.    return d
+00008630: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
+00008640: 696e 675f 7261 7465 2c20 6461 7461 0a0a  ing_rate, data..
+00008650: 0a64 6566 205f 5f6c 6f61 645f 6461 7461  .def __load_data
+00008660: 5f65 706f 6368 735f 5f62 795f 7472 6961  _epochs__by_tria
+00008670: 6c28 6461 7461 5f72 6561 6465 722c 2072  l(data_reader, r
+00008680: 6574 7269 6576 655f 6368 616e 6e65 6c73  etrieve_channels
+00008690: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000086a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086b0: 2020 206f 6e73 6574 732c 2074 7269 616c     onsets, trial
+000086c0: 5f65 706f 6368 2c0a 2020 2020 2020 2020  _epoch,.        
+000086d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000086e0: 2020 2020 2020 2020 2062 6173 656c 696e           baselin
+000086f0: 655f 6d65 7468 6f64 2c20 6261 7365 6c69  e_method, baseli
+00008700: 6e65 5f65 706f 6368 2c20 6f75 745f 6f66  ne_epoch, out_of
+00008710: 5f62 6f75 6e64 5f6d 6574 686f 6429 3a0a  _bound_method):.
+00008720: 2020 2020 2222 220a 2020 2020 4c6f 6164      """.    Load
+00008730: 2064 6174 6120 6570 6f63 6873 2074 6f20   data epochs to 
+00008740: 6120 6d61 7472 6978 2028 666f 726d 6174  a matrix (format
+00008750: 3a20 6368 616e 6e65 6c20 7820 7472 6961  : channel x tria
+00008760: 6c73 2f65 706f 6368 7320 7820 7469 6d65  ls/epochs x time
+00008770: 2920 6279 206c 6f6f 7069 6e67 206f 7665  ) by looping ove
+00008780: 7220 616e 6420 6c6f 6164 696e 6720 6461  r and loading da
+00008790: 7461 2070 6572 0a20 2020 2074 7269 616c  ta per.    trial
+000087a0: 2028 666f 7220 616c 6c20 6368 616e 6e65   (for all channe
+000087b0: 6c73 2920 616e 6420 7265 7472 6965 7669  ls) and retrievi
+000087c0: 6e67 2074 6865 2074 7269 616c 2064 6174  ng the trial dat
+000087d0: 6120 6279 2069 7465 7261 7469 6e67 206f  a by iterating o
+000087e0: 7665 7220 6561 6368 206f 6620 7468 6520  ver each of the 
+000087f0: 6368 616e 6e65 6c73 0a0a 2020 2020 4e6f  channels..    No
+00008800: 7465 3a20 2020 4573 7065 6369 616c 6c79  te:   Especially
+00008810: 2066 6f72 2074 6865 204d 4546 3320 666f   for the MEF3 fo
+00008820: 726d 6174 2074 6869 7320 6973 2074 6865  rmat this is the
+00008830: 206d 6f73 7420 6d65 6d6f 7279 2065 6666   most memory eff
+00008840: 6963 6965 6e74 2062 6563 6175 7365 206f  icient because o
+00008850: 6e6c 7920 7468 6520 6d69 6e69 6d75 6d20  nly the minimum 
+00008860: 616d 6f75 6e74 206f 6620 6461 7461 0a20  amount of data. 
+00008870: 2020 2020 2020 2020 2020 2069 7320 6c6f             is lo
+00008880: 6164 6564 2069 6e74 6f20 6d65 6d6f 7279  aded into memory
+00008890: 2c20 7768 6963 6820 7368 6f75 6c64 2061  , which should a
+000088a0: 6c73 6f20 6265 2066 6173 7465 7220 6265  lso be faster be
+000088b0: 6361 7573 6520 6c65 7373 2064 6174 6120  cause less data 
+000088c0: 6973 2072 6561 6420 6672 6f6d 2074 6865  is read from the
+000088d0: 2064 6973 6b2e 2046 6f72 2045 4446 2061   disk. For EDF a
+000088e0: 6e64 0a20 2020 2020 2020 2020 2020 2042  nd.            B
+000088f0: 7261 696e 7669 7369 6f6e 2074 6865 7265  rainvision there
+00008900: 206e 6f20 6265 6e65 6669 742c 2073 696e   no benefit, sin
+00008910: 6365 2074 6865 7365 2066 6f72 6d61 7473  ce these formats
+00008920: 2061 7265 206c 6f61 6465 6420 7769 7468   are loaded with
+00008930: 204d 4e45 2c20 7768 6963 6820 6c6f 6164   MNE, which load
+00008940: 2074 6865 2065 6e74 6972 6520 6461 7461   the entire data
+00008950: 7365 7420 696e 746f 0a20 2020 2020 2020  set into.       
+00008960: 2020 2020 206d 656d 6f72 7920 6669 7273       memory firs
+00008970: 742e 0a0a 2020 2020 4172 6773 3a0a 2020  t...    Args:.  
+00008980: 2020 2020 2020 6461 7461 5f72 6561 6465        data_reade
+00008990: 7220 2849 6565 6744 6174 6152 6561 6465  r (IeegDataReade
+000089a0: 7229 3a20 2020 2020 2020 416e 2069 6e73  r):       An ins
+000089b0: 7461 6e63 6520 6f66 2074 6865 2049 6565  tance of the Iee
+000089c0: 6744 6174 6152 6561 6465 7220 746f 2072  gDataReader to r
+000089d0: 6574 7269 6576 6520 6d65 7461 6461 7461  etrieve metadata
+000089e0: 2061 6e64 2063 6861 6e6e 656c 2064 6174   and channel dat
+000089f0: 610a 2020 2020 2020 2020 7265 7472 6965  a.        retrie
+00008a00: 7665 5f63 6861 6e6e 656c 7320 286c 6973  ve_channels (lis
+00008a10: 7420 6f72 2074 7570 6c65 293a 2020 5468  t or tuple):  Th
+00008a20: 6520 6368 616e 6e65 6c73 2028 6279 206e  e channels (by n
+00008a30: 616d 6529 206f 6620 7768 6963 6820 7468  ame) of which th
+00008a40: 6520 6461 7461 2073 686f 756c 6420 6265  e data should be
+00008a50: 2072 6574 7269 6576 6564 2c20 7468 6520   retrieved, the 
+00008a60: 6f75 7470 7574 0a20 2020 2020 2020 2020  output.         
 00008a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008a80: 2020 2020 2020 7769 6c6c 2062 6520 736f        will be so
-00008a90: 7274 6564 2061 6363 6f72 6469 6e67 6c79  rted accordingly
-00008aa0: 0a20 2020 2022 2222 0a0a 2020 2020 2320  .    """..    # 
-00008ab0: 6361 6c63 756c 6174 6520 7468 6520 7369  calculate the si
-00008ac0: 7a65 206f 6620 7468 6520 7469 6d65 2064  ze of the time d
-00008ad0: 696d 656e 7369 6f6e 2028 696e 2073 616d  imension (in sam
-00008ae0: 706c 6573 290a 2020 2020 7472 6961 6c5f  ples).    trial_
-00008af0: 6e75 6d5f 7361 6d70 6c65 7320 3d20 696e  num_samples = in
-00008b00: 7428 726f 756e 6428 6162 7328 7472 6961  t(round(abs(tria
-00008b10: 6c5f 6570 6f63 685b 315d 202d 2074 7269  l_epoch[1] - tri
-00008b20: 616c 5f65 706f 6368 5b30 5d29 202a 2064  al_epoch[0]) * d
-00008b30: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
-00008b40: 696e 675f 7261 7465 2929 0a20 2020 2062  ing_rate)).    b
-00008b50: 6173 656c 696e 655f 6e75 6d5f 7361 6d70  aseline_num_samp
-00008b60: 6c65 7320 3d20 696e 7428 726f 756e 6428  les = int(round(
-00008b70: 6162 7328 6261 7365 6c69 6e65 5f65 706f  abs(baseline_epo
-00008b80: 6368 5b31 5d20 2d20 6261 7365 6c69 6e65  ch[1] - baseline
-00008b90: 5f65 706f 6368 5b30 5d29 202a 2064 6174  _epoch[0]) * dat
-00008ba0: 615f 7265 6164 6572 2e73 616d 706c 696e  a_reader.samplin
-00008bb0: 675f 7261 7465 2929 0a0a 2020 2020 2320  g_rate))..    # 
-00008bc0: 696e 6974 6961 6c69 7a65 2061 2064 6174  initialize a dat
-00008bd0: 6120 6275 6666 6572 2028 6368 616e 6e65  a buffer (channe
-00008be0: 6c20 7820 7472 6961 6c73 2f65 706f 6368  l x trials/epoch
-00008bf0: 7320 7820 7469 6d65 290a 2020 2020 7472  s x time).    tr
-00008c00: 793a 0a20 2020 2020 2020 2064 6174 6120  y:.        data 
-00008c10: 3d20 616c 6c6f 6361 7465 5f61 7272 6179  = allocate_array
-00008c20: 2828 6c65 6e28 7265 7472 6965 7665 5f63  ((len(retrieve_c
-00008c30: 6861 6e6e 656c 7329 2c20 6c65 6e28 6f6e  hannels), len(on
-00008c40: 7365 7473 292c 2074 7269 616c 5f6e 756d  sets), trial_num
-00008c50: 5f73 616d 706c 6573 2929 0a20 2020 2065  _samples)).    e
-00008c60: 7863 6570 7420 4d65 6d6f 7279 4572 726f  xcept MemoryErro
-00008c70: 723a 0a20 2020 2020 2020 2072 6169 7365  r:.        raise
-00008c80: 204d 656d 6f72 7945 7272 6f72 2827 4e6f   MemoryError('No
-00008c90: 7420 656e 6f75 6768 206d 656d 6f72 7920  t enough memory 
-00008ca0: 6372 6561 7465 2061 2064 6174 6120 6f75  create a data ou
-00008cb0: 7470 7574 206d 6174 7269 7827 290a 0a20  tput matrix').. 
-00008cc0: 2020 2023 2063 7265 6174 6520 7072 6f67     # create prog
-00008cd0: 7265 7373 2062 6172 0a20 2020 2070 7269  ress bar.    pri
-00008ce0: 6e74 5f70 726f 6772 6573 7362 6172 2830  nt_progressbar(0
-00008cf0: 2c20 6c65 6e28 6f6e 7365 7473 292c 2070  , len(onsets), p
-00008d00: 7265 6669 783d 2750 726f 6772 6573 733a  refix='Progress:
-00008d10: 272c 2073 7566 6669 783d 2743 6f6d 706c  ', suffix='Compl
-00008d20: 6574 6527 2c20 6c65 6e67 7468 3d35 3029  ete', length=50)
-00008d30: 0a0a 2020 2020 2320 6c6f 6f70 2074 6872  ..    # loop thr
-00008d40: 6f75 6768 2074 6865 2074 7269 616c 730a  ough the trials.
-00008d50: 2020 2020 666f 7220 7472 6961 6c5f 6964      for trial_id
-00008d60: 7820 696e 2072 616e 6765 286c 656e 286f  x in range(len(o
-00008d70: 6e73 6574 7329 293a 0a0a 2020 2020 2020  nsets)):..      
-00008d80: 2020 230a 2020 2020 2020 2020 7472 6961    #.        tria
-00008d90: 6c5f 7361 6d70 6c65 5f73 7461 7274 203d  l_sample_start =
-00008da0: 2069 6e74 2872 6f75 6e64 2828 6f6e 7365   int(round((onse
-00008db0: 7473 5b74 7269 616c 5f69 6478 5d20 2b20  ts[trial_idx] + 
-00008dc0: 7472 6961 6c5f 6570 6f63 685b 305d 2920  trial_epoch[0]) 
-00008dd0: 2a20 6461 7461 5f72 6561 6465 722e 7361  * data_reader.sa
-00008de0: 6d70 6c69 6e67 5f72 6174 6529 290a 2020  mpling_rate)).  
-00008df0: 2020 2020 2020 7472 6961 6c5f 7361 6d70        trial_samp
-00008e00: 6c65 5f65 6e64 203d 2074 7269 616c 5f73  le_end = trial_s
-00008e10: 616d 706c 655f 7374 6172 7420 2b20 7472  ample_start + tr
-00008e20: 6961 6c5f 6e75 6d5f 7361 6d70 6c65 730a  ial_num_samples.
-00008e30: 2020 2020 2020 2020 6261 7365 6c69 6e65          baseline
-00008e40: 5f73 7461 7274 5f73 616d 706c 6520 3d20  _start_sample = 
-00008e50: 696e 7428 726f 756e 6428 286f 6e73 6574  int(round((onset
-00008e60: 735b 7472 6961 6c5f 6964 785d 202b 2062  s[trial_idx] + b
-00008e70: 6173 656c 696e 655f 6570 6f63 685b 305d  aseline_epoch[0]
-00008e80: 2920 2a20 6461 7461 5f72 6561 6465 722e  ) * data_reader.
-00008e90: 7361 6d70 6c69 6e67 5f72 6174 6529 2920  sampling_rate)) 
-00008ea0: 2d20 7472 6961 6c5f 7361 6d70 6c65 5f73  - trial_sample_s
-00008eb0: 7461 7274 0a20 2020 2020 2020 2062 6173  tart.        bas
-00008ec0: 656c 696e 655f 656e 645f 7361 6d70 6c65  eline_end_sample
-00008ed0: 203d 2062 6173 656c 696e 655f 7374 6172   = baseline_star
-00008ee0: 745f 7361 6d70 6c65 202b 2062 6173 656c  t_sample + basel
-00008ef0: 696e 655f 6e75 6d5f 7361 6d70 6c65 730a  ine_num_samples.
-00008f00: 2020 2020 2020 2020 6c6f 6361 6c5f 7374          local_st
-00008f10: 6172 7420 3d20 300a 2020 2020 2020 2020  art = 0.        
-00008f20: 6c6f 6361 6c5f 656e 6420 3d20 7472 6961  local_end = tria
-00008f30: 6c5f 6e75 6d5f 7361 6d70 6c65 730a 0a20  l_num_samples.. 
-00008f40: 2020 2020 2020 2023 2063 6865 636b 2077         # check w
-00008f50: 6865 7468 6572 2074 6865 2074 7269 616c  hether the trial
-00008f60: 2065 706f 6368 2069 7320 7769 7468 696e   epoch is within
-00008f70: 2062 6f75 6e64 730a 2020 2020 2020 2020   bounds.        
-00008f80: 6966 2074 7269 616c 5f73 616d 706c 655f  if trial_sample_
-00008f90: 656e 6420 3c20 303a 0a20 2020 2020 2020  end < 0:.       
-00008fa0: 2020 2020 2069 6620 286f 7574 5f6f 665f       if (out_of_
-00008fb0: 626f 756e 645f 6d65 7468 6f64 203d 3d20  bound_method == 
-00008fc0: 3120 616e 6420 7472 6961 6c5f 6964 7820  1 and trial_idx 
-00008fd0: 3d3d 2030 2920 6f72 206f 7574 5f6f 665f  == 0) or out_of_
-00008fe0: 626f 756e 645f 6d65 7468 6f64 203d 3d20  bound_method == 
-00008ff0: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-00009000: 2020 206c 6f67 6769 6e67 2e77 6172 6e69     logging.warni
-00009010: 6e67 2827 4361 6e6e 6f74 2065 7874 7261  ng('Cannot extra
-00009020: 6374 2074 6865 2074 7269 616c 2077 6974  ct the trial wit
-00009030: 6820 6f6e 7365 7420 2720 2b20 7374 7228  h onset ' + str(
-00009040: 6f6e 7365 7473 5b74 7269 616c 5f69 6478  onsets[trial_idx
-00009050: 5d29 202b 2027 2c20 7468 6520 656e 6420  ]) + ', the end 
-00009060: 6f66 2074 6865 2074 7269 616c 2d65 706f  of the trial-epo
-00009070: 6368 206c 6965 7320 6265 666f 7265 2074  ch lies before t
-00009080: 6865 2073 7461 7274 206f 6620 7468 6520  he start of the 
-00009090: 6461 7461 2d73 6574 2e27 290a 2020 2020  data-set.').    
-000090a0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000090b0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-000090c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000090d0: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
-000090e0: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
-000090f0: 7261 6374 2074 6865 2074 7269 616c 2077  ract the trial w
-00009100: 6974 6820 6f6e 7365 7420 2720 2b20 7374  ith onset ' + st
-00009110: 7228 6f6e 7365 7473 5b74 7269 616c 5f69  r(onsets[trial_i
-00009120: 6478 5d29 202b 2027 2c20 7468 6520 656e  dx]) + ', the en
-00009130: 6420 6f66 2074 6865 2074 7269 616c 2d65  d of the trial-e
-00009140: 706f 6368 206c 6965 7320 6265 666f 7265  poch lies before
-00009150: 2074 6865 2073 7461 7274 206f 6620 7468   the start of th
-00009160: 6520 6461 7461 2d73 6574 2e20 5573 6520  e data-set. Use 
-00009170: 6120 6469 6666 6572 656e 7420 6f75 745f  a different out_
-00009180: 6f66 5f62 6f75 6e64 5f68 616e 646c 696e  of_bound_handlin
-00009190: 6720 6172 6775 6d65 6e74 2074 6f20 616c  g argument to al
-000091a0: 6c6f 7720 6f75 742d 6f66 2d62 6f75 6e64  low out-of-bound
-000091b0: 2074 7269 616c 2065 706f 6368 7327 290a   trial epochs').
-000091c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000091d0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-000091e0: 6f72 2827 4361 6e6e 6f74 2065 7874 7261  or('Cannot extra
-000091f0: 6374 2074 7269 616c 2729 0a20 2020 2020  ct trial').     
-00009200: 2020 2069 6620 7472 6961 6c5f 7361 6d70     if trial_samp
-00009210: 6c65 5f73 7461 7274 203c 2030 3a0a 2020  le_start < 0:.  
-00009220: 2020 2020 2020 2020 2020 6966 2028 6f75            if (ou
-00009230: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
-00009240: 6420 3d3d 2031 2061 6e64 2074 7269 616c  d == 1 and trial
-00009250: 5f69 6478 203d 3d20 3029 206f 7220 6f75  _idx == 0) or ou
-00009260: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
-00009270: 6420 3d3d 2032 3a0a 2020 2020 2020 2020  d == 2:.        
-00009280: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-00009290: 7761 726e 696e 6728 2743 616e 6e6f 7420  warning('Cannot 
-000092a0: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
-000092b0: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
-000092c0: 2073 7472 286f 6e73 6574 735b 7472 6961   str(onsets[tria
-000092d0: 6c5f 6964 785d 2920 2b20 272c 2074 6865  l_idx]) + ', the
-000092e0: 2073 7461 7274 206f 6620 7468 6520 7472   start of the tr
-000092f0: 6961 6c2d 6570 6f63 6820 6c69 6573 2062  ial-epoch lies b
-00009300: 6566 6f72 6520 7468 6520 7374 6172 7420  efore the start 
-00009310: 6f66 2074 6865 2064 6174 612d 7365 742e  of the data-set.
-00009320: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00009330: 2020 206c 6f63 616c 5f73 7461 7274 203d     local_start =
-00009340: 2074 7269 616c 5f73 616d 706c 655f 7374   trial_sample_st
-00009350: 6172 7420 2a20 2d31 0a20 2020 2020 2020  art * -1.       
-00009360: 2020 2020 2020 2020 2074 7269 616c 5f73           trial_s
-00009370: 616d 706c 655f 7374 6172 7420 3d20 300a  ample_start = 0.
-00009380: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00009390: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000093a0: 2020 6c6f 6767 696e 672e 6572 726f 7228    logging.error(
-000093b0: 2743 616e 6e6f 7420 6578 7472 6163 7420  'Cannot extract 
-000093c0: 7468 6520 7472 6961 6c20 7769 7468 206f  the trial with o
-000093d0: 6e73 6574 2027 202b 2073 7472 286f 6e73  nset ' + str(ons
-000093e0: 6574 735b 7472 6961 6c5f 6964 785d 2920  ets[trial_idx]) 
-000093f0: 2b20 272c 2074 6865 2073 7461 7274 206f  + ', the start o
-00009400: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
-00009410: 6820 6c69 6573 2062 6566 6f72 6520 7468  h lies before th
-00009420: 6520 7374 6172 7420 6f66 2074 6865 2064  e start of the d
-00009430: 6174 612d 7365 742e 2055 7365 2061 2064  ata-set. Use a d
-00009440: 6966 6665 7265 6e74 206f 7574 5f6f 665f  ifferent out_of_
-00009450: 626f 756e 645f 6861 6e64 6c69 6e67 2061  bound_handling a
-00009460: 7267 756d 656e 7420 746f 2061 6c6c 6f77  rgument to allow
-00009470: 206f 7574 2d6f 662d 626f 756e 6420 7472   out-of-bound tr
-00009480: 6961 6c20 6570 6f63 6873 2729 0a20 2020  ial epochs').   
-00009490: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-000094a0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-000094b0: 2743 616e 6e6f 7420 6578 7472 6163 7420  'Cannot extract 
-000094c0: 7472 6961 6c27 290a 2020 2020 2020 2020  trial').        
-000094d0: 6966 2074 7269 616c 5f73 616d 706c 655f  if trial_sample_
-000094e0: 7374 6172 7420 3e20 6461 7461 5f72 6561  start > data_rea
-000094f0: 6465 722e 6e75 6d5f 7361 6d70 6c65 733a  der.num_samples:
-00009500: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00009510: 286f 7574 5f6f 665f 626f 756e 645f 6d65  (out_of_bound_me
-00009520: 7468 6f64 203d 3d20 3120 616e 6420 7472  thod == 1 and tr
-00009530: 6961 6c5f 6964 7820 3d3d 206c 656e 286f  ial_idx == len(o
-00009540: 6e73 6574 7329 202d 2031 2920 6f72 206f  nsets) - 1) or o
-00009550: 7574 5f6f 665f 626f 756e 645f 6d65 7468  ut_of_bound_meth
-00009560: 6f64 203d 3d20 323a 0a20 2020 2020 2020  od == 2:.       
-00009570: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-00009580: 2e77 6172 6e69 6e67 2827 4361 6e6e 6f74  .warning('Cannot
-00009590: 2065 7874 7261 6374 2074 6865 2074 7269   extract the tri
-000095a0: 616c 2077 6974 6820 6f6e 7365 7420 2720  al with onset ' 
-000095b0: 2b20 7374 7228 6f6e 7365 7473 5b74 7269  + str(onsets[tri
-000095c0: 616c 5f69 6478 5d29 202b 2027 2c20 7468  al_idx]) + ', th
-000095d0: 6520 7374 6172 7420 6f66 2074 6865 2074  e start of the t
-000095e0: 7269 616c 2d65 706f 6368 206c 6965 7320  rial-epoch lies 
-000095f0: 6166 7465 7220 7468 6520 656e 6420 6f66  after the end of
-00009600: 2074 6865 2064 6174 612d 7365 742e 2729   the data-set.')
-00009610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009620: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00009630: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00009640: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00009650: 696e 672e 6572 726f 7228 2743 616e 6e6f  ing.error('Canno
-00009660: 7420 6578 7472 6163 7420 7468 6520 7472  t extract the tr
-00009670: 6961 6c20 7769 7468 206f 6e73 6574 2027  ial with onset '
-00009680: 202b 2073 7472 286f 6e73 6574 735b 7472   + str(onsets[tr
-00009690: 6961 6c5f 6964 785d 2920 2b20 272c 2074  ial_idx]) + ', t
-000096a0: 6865 2073 7461 7274 206f 6620 7468 6520  he start of the 
-000096b0: 7472 6961 6c2d 6570 6f63 6820 6c69 6573  trial-epoch lies
-000096c0: 2061 6674 6572 2074 6865 2065 6e64 206f   after the end o
-000096d0: 6620 7468 6520 6461 7461 2d73 6574 2e20  f the data-set. 
-000096e0: 5573 6520 6120 6469 6666 6572 656e 7420  Use a different 
-000096f0: 6f75 745f 6f66 5f62 6f75 6e64 5f68 616e  out_of_bound_han
-00009700: 646c 696e 6720 6172 6775 6d65 6e74 2074  dling argument t
-00009710: 6f20 616c 6c6f 7720 6f75 742d 6f66 2d62  o allow out-of-b
-00009720: 6f75 6e64 2074 7269 616c 2065 706f 6368  ound trial epoch
-00009730: 7327 290a 2020 2020 2020 2020 2020 2020  s').            
-00009740: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-00009750: 6545 7272 6f72 2827 4361 6e6e 6f74 2065  eError('Cannot e
-00009760: 7874 7261 6374 2074 7269 616c 2729 0a20  xtract trial'). 
-00009770: 2020 2020 2020 2069 6620 7472 6961 6c5f         if trial_
-00009780: 7361 6d70 6c65 5f65 6e64 203e 2064 6174  sample_end > dat
-00009790: 615f 7265 6164 6572 2e6e 756d 5f73 616d  a_reader.num_sam
-000097a0: 706c 6573 3a0a 2020 2020 2020 2020 2020  ples:.          
-000097b0: 2020 6966 2028 6f75 745f 6f66 5f62 6f75    if (out_of_bou
-000097c0: 6e64 5f6d 6574 686f 6420 3d3d 2031 2061  nd_method == 1 a
-000097d0: 6e64 2074 7269 616c 5f69 6478 203d 3d20  nd trial_idx == 
-000097e0: 6c65 6e28 6f6e 7365 7473 2920 2d20 3129  len(onsets) - 1)
-000097f0: 206f 7220 6f75 745f 6f66 5f62 6f75 6e64   or out_of_bound
-00009800: 5f6d 6574 686f 6420 3d3d 2032 3a0a 2020  _method == 2:.  
-00009810: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00009820: 6767 696e 672e 7761 726e 696e 6728 2743  gging.warning('C
-00009830: 616e 6e6f 7420 6578 7472 6163 7420 7468  annot extract th
-00009840: 6520 7472 6961 6c20 7769 7468 206f 6e73  e trial with ons
-00009850: 6574 2027 202b 2073 7472 286f 6e73 6574  et ' + str(onset
-00009860: 735b 7472 6961 6c5f 6964 785d 2920 2b20  s[trial_idx]) + 
-00009870: 272c 2074 6865 2065 6e64 206f 6620 7468  ', the end of th
-00009880: 6520 7472 6961 6c2d 6570 6f63 6820 6c69  e trial-epoch li
-00009890: 6573 2061 6674 6572 2074 6865 2065 6e64  es after the end
-000098a0: 206f 6620 7468 6520 6461 7461 2d73 6574   of the data-set
-000098b0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-000098c0: 2020 2020 6c6f 6361 6c5f 656e 6420 3d20      local_end = 
-000098d0: 7472 6961 6c5f 6e75 6d5f 7361 6d70 6c65  trial_num_sample
-000098e0: 7320 2d20 2874 7269 616c 5f73 616d 706c  s - (trial_sampl
-000098f0: 655f 656e 6420 2d20 6461 7461 5f72 6561  e_end - data_rea
-00009900: 6465 722e 6e75 6d5f 7361 6d70 6c65 7329  der.num_samples)
-00009910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009920: 2074 7269 616c 5f73 616d 706c 655f 656e   trial_sample_en
-00009930: 6420 3d20 6461 7461 5f72 6561 6465 722e  d = data_reader.
-00009940: 6e75 6d5f 7361 6d70 6c65 730a 2020 2020  num_samples.    
-00009950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00009960: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00009970: 6767 696e 672e 6572 726f 7228 2743 616e  gging.error('Can
-00009980: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
-00009990: 7472 6961 6c20 7769 7468 206f 6e73 6574  trial with onset
-000099a0: 2027 202b 2073 7472 286f 6e73 6574 735b   ' + str(onsets[
-000099b0: 7472 6961 6c5f 6964 785d 2920 2b20 272c  trial_idx]) + ',
-000099c0: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
-000099d0: 7472 6961 6c2d 6570 6f63 6820 6c69 6573  trial-epoch lies
-000099e0: 2061 6674 6572 2074 6865 2065 6e64 206f   after the end o
-000099f0: 6620 7468 6520 6461 7461 2d73 6574 2e20  f the data-set. 
-00009a00: 5573 6520 6120 6469 6666 6572 656e 7420  Use a different 
-00009a10: 6f75 745f 6f66 5f62 6f75 6e64 5f68 616e  out_of_bound_han
-00009a20: 646c 696e 6720 6172 6775 6d65 6e74 2074  dling argument t
-00009a30: 6f20 616c 6c6f 7720 6f75 742d 6f66 2d62  o allow out-of-b
-00009a40: 6f75 6e64 2074 7269 616c 2065 706f 6368  ound trial epoch
-00009a50: 7327 290a 2020 2020 2020 2020 2020 2020  s').            
-00009a60: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-00009a70: 6545 7272 6f72 2827 4361 6e6e 6f74 2065  eError('Cannot e
-00009a80: 7874 7261 6374 2074 7269 616c 2729 0a0a  xtract trial')..
-00009a90: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
-00009aa0: 7768 6574 6865 7220 7468 6520 6261 7365  whether the base
-00009ab0: 6c69 6e65 2069 7320 7769 7468 696e 2062  line is within b
-00009ac0: 6f75 6e64 730a 2020 2020 2020 2020 6966  ounds.        if
-00009ad0: 2062 6173 656c 696e 655f 6d65 7468 6f64   baseline_method
-00009ae0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00009af0: 2020 6966 2062 6173 656c 696e 655f 7374    if baseline_st
-00009b00: 6172 745f 7361 6d70 6c65 203c 2030 3a0a  art_sample < 0:.
-00009b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009b20: 6c6f 6767 696e 672e 6572 726f 7228 2743  logging.error('C
-00009b30: 616e 6e6f 7420 6578 7472 6163 7420 7468  annot extract th
-00009b40: 6520 6261 7365 6c69 6e65 2066 6f72 2074  e baseline for t
-00009b50: 6865 2074 7269 616c 2077 6974 6820 6f6e  he trial with on
-00009b60: 7365 7420 2720 2b20 7374 7228 6f6e 7365  set ' + str(onse
-00009b70: 7473 5b74 7269 616c 5f69 6478 5d29 202b  ts[trial_idx]) +
-00009b80: 2027 2c20 7468 6520 7374 6172 7420 6f66   ', the start of
-00009b90: 2074 6865 2062 6173 656c 696e 652d 6570   the baseline-ep
-00009ba0: 6f63 6820 6c69 6573 2062 6566 6f72 6520  och lies before 
-00009bb0: 7468 6520 7374 6172 7420 6f66 2074 6865  the start of the
-00009bc0: 2074 7269 616c 2d65 706f 6368 2729 0a20   trial-epoch'). 
-00009bd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00009be0: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-00009bf0: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
-00009c00: 7420 6261 7365 6c69 6e65 2729 0a20 2020  t baseline').   
-00009c10: 2020 2020 2020 2020 2069 6620 6261 7365           if base
-00009c20: 6c69 6e65 5f65 6e64 5f73 616d 706c 6520  line_end_sample 
-00009c30: 3e20 7472 6961 6c5f 6e75 6d5f 7361 6d70  > trial_num_samp
-00009c40: 6c65 733a 0a20 2020 2020 2020 2020 2020  les:.           
-00009c50: 2020 2020 206c 6f67 6769 6e67 2e65 7272       logging.err
-00009c60: 6f72 2827 4361 6e6e 6f74 2065 7874 7261  or('Cannot extra
-00009c70: 6374 2074 6865 2062 6173 656c 696e 6520  ct the baseline 
-00009c80: 666f 7220 7468 6520 7472 6961 6c20 7769  for the trial wi
-00009c90: 7468 206f 6e73 6574 2027 202b 2073 7472  th onset ' + str
-00009ca0: 286f 6e73 6574 735b 7472 6961 6c5f 6964  (onsets[trial_id
-00009cb0: 785d 2920 2b20 272c 2074 6865 2065 6e64  x]) + ', the end
-00009cc0: 206f 6620 7468 6520 6261 7365 6c69 6e65   of the baseline
-00009cd0: 2d65 706f 6368 206c 6965 7320 6f75 7473  -epoch lies outs
-00009ce0: 6964 6520 6f66 2074 6865 2074 7269 616c  ide of the trial
-00009cf0: 2d65 706f 6368 2729 0a20 2020 2020 2020  -epoch').       
-00009d00: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
-00009d10: 756e 7469 6d65 4572 726f 7228 2743 616e  untimeError('Can
-00009d20: 6e6f 7420 6578 7472 6163 7420 6261 7365  not extract base
-00009d30: 6c69 6e65 2729 0a20 2020 2020 2020 2020  line').         
-00009d40: 2020 2069 6620 6261 7365 6c69 6e65 5f73     if baseline_s
-00009d50: 7461 7274 5f73 616d 706c 6520 3c20 6c6f  tart_sample < lo
-00009d60: 6361 6c5f 7374 6172 7420 6f72 2062 6173  cal_start or bas
-00009d70: 656c 696e 655f 656e 645f 7361 6d70 6c65  eline_end_sample
-00009d80: 203e 206c 6f63 616c 5f65 6e64 3a0a 2020   > local_end:.  
-00009d90: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-00009da0: 6767 696e 672e 6572 726f 7228 2743 616e  gging.error('Can
-00009db0: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
-00009dc0: 6261 7365 6c69 6e65 2066 6f72 2074 6865  baseline for the
-00009dd0: 2074 7269 616c 2077 6974 6820 6f6e 7365   trial with onse
-00009de0: 7420 2720 2b20 7374 7228 6f6e 7365 7473  t ' + str(onsets
-00009df0: 5b74 7269 616c 5f69 6478 5d29 202b 2027  [trial_idx]) + '
-00009e00: 2c20 7468 6520 7261 6e67 6520 666f 7220  , the range for 
-00009e10: 7468 6520 6261 7365 6c69 6e65 206c 6965  the baseline lie
-00009e20: 7320 6f75 7473 6964 6520 6f66 2074 6865  s outside of the
-00009e30: 2074 7269 616c 2d65 706f 6368 2062 6563   trial-epoch bec
-00009e40: 6175 7365 2074 6861 7420 7061 7274 206f  ause that part o
-00009e50: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
-00009e60: 6820 7761 7320 6f75 742d 6f66 2d62 6f75  h was out-of-bou
-00009e70: 6e64 7327 290a 2020 2020 2020 2020 2020  nds').          
-00009e80: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00009e90: 696d 6545 7272 6f72 2827 4361 6e6e 6f74  imeError('Cannot
-00009ea0: 2065 7874 7261 6374 2062 6173 656c 696e   extract baselin
-00009eb0: 6527 290a 0a20 2020 2020 2020 2023 206c  e')..        # l
-00009ec0: 6f61 6420 7468 6520 7472 6961 6c20 6461  oad the trial da
-00009ed0: 7461 0a20 2020 2020 2020 2074 7279 3a0a  ta.        try:.
-00009ee0: 2020 2020 2020 2020 2020 2020 7472 6961              tria
-00009ef0: 6c5f 6461 7461 203d 2064 6174 615f 7265  l_data = data_re
-00009f00: 6164 6572 2e72 6574 7269 6576 655f 7361  ader.retrieve_sa
-00009f10: 6d70 6c65 5f72 616e 6765 5f64 6174 6128  mple_range_data(
-00009f20: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
-00009f30: 732c 2074 7269 616c 5f73 616d 706c 655f  s, trial_sample_
-00009f40: 7374 6172 742c 2074 7269 616c 5f73 616d  start, trial_sam
-00009f50: 706c 655f 656e 642c 2046 616c 7365 290a  ple_end, False).
-00009f60: 2020 2020 2020 2020 6578 6365 7074 2028          except (
-00009f70: 5275 6e74 696d 6545 7272 6f72 2c20 4c6f  RuntimeError, Lo
-00009f80: 6f6b 7570 4572 726f 7229 3a0a 2020 2020  okupError):.    
-00009f90: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
-00009fa0: 6e74 696d 6545 7272 6f72 2827 436f 756c  ntimeError('Coul
-00009fb0: 6420 6e6f 7420 6c6f 6164 2064 6174 6127  d not load data'
-00009fc0: 290a 0a20 2020 2020 2020 2023 206c 6f6f  )..        # loo
-00009fd0: 7020 7468 726f 7567 6820 7468 6520 6368  p through the ch
-00009fe0: 616e 6e65 6c73 0a20 2020 2020 2020 2066  annels.        f
-00009ff0: 6f72 2063 6861 6e6e 656c 5f69 6478 2069  or channel_idx i
-0000a000: 6e20 7261 6e67 6528 6c65 6e28 7265 7472  n range(len(retr
-0000a010: 6965 7665 5f63 6861 6e6e 656c 7329 293a  ieve_channels)):
-0000a020: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0000a030: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
-0000a040: 6c20 6461 7461 2061 6e64 2070 6572 666f  l data and perfo
-0000a050: 726d 2062 6173 656c 696e 6520 6e6f 726d  rm baseline norm
-0000a060: 616c 697a 6174 696f 6e20 6f6e 2074 6865  alization on the
-0000a070: 2074 7269 616c 2069 6620 6e65 6564 6564   trial if needed
-0000a080: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000a090: 6261 7365 6c69 6e65 5f6d 6574 686f 6420  baseline_method 
-0000a0a0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0000a0b0: 2020 2020 2020 2320 4e6f 7465 3a20 7369        # Note: si
-0000a0c0: 6e63 6520 7765 2061 7265 206e 6f74 206d  nce we are not m
-0000a0d0: 616e 6970 756c 6174 696e 6720 7468 6520  anipulating the 
-0000a0e0: 6461 7461 2028 7768 6963 6820 696e 2074  data (which in t
-0000a0f0: 6865 206f 7468 6572 2063 6173 6573 2063  he other cases c
-0000a100: 6f6e 7665 7274 7320 6120 7669 6577 2074  onverts a view t
-0000a110: 6f20 6461 7461 292c 2065 6e73 7572 650a  o data), ensure.
-0000a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a130: 2320 2020 2020 2020 7468 6520 6570 6f63  #       the epoc
-0000a140: 6820 6861 7320 6974 7320 6f77 6e20 6461  h has its own da
-0000a150: 7461 2028 6e6f 7420 6120 7669 6577 292e  ta (not a view).
-0000a160: 2041 766f 6964 696e 6720 7669 6577 7320   Avoiding views 
-0000a170: 7072 6576 656e 7473 2074 726f 7562 6c65  prevents trouble
-0000a180: 2077 6974 6820 6f76 6572 6c61 7070 696e   with overlappin
-0000a190: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
-0000a1a0: 2020 2320 2020 2020 2020 6570 6f63 6873    #       epochs
-0000a1b0: 3b20 696e 2061 6464 6974 696f 6e2c 2061  ; in addition, a
-0000a1c0: 766f 6964 696e 6720 7669 6577 7320 656e  voiding views en
-0000a1d0: 7375 7265 7320 7468 6572 6520 6172 6520  sures there are 
-0000a1e0: 6e6f 2072 656d 6169 6e69 6e67 2072 6566  no remaining ref
-0000a1f0: 6572 656e 6365 7320 746f 2074 6865 2073  erences to the s
-0000a200: 6f75 7263 650a 2020 2020 2020 2020 2020  ource.          
-0000a210: 2020 2020 2020 2320 2020 2020 2020 6e75        #       nu
-0000a220: 6d70 792d 6172 7261 792c 2061 6c6c 6f77  mpy-array, allow
-0000a230: 696e 6720 6974 2074 6f20 6265 2063 6c65  ing it to be cle
-0000a240: 6172 6564 2066 726f 6d20 6d65 6d6f 7279  ared from memory
-0000a250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a260: 2069 6620 7472 6961 6c5f 6461 7461 5b63   if trial_data[c
-0000a270: 6861 6e6e 656c 5f69 6478 5d2e 6261 7365  hannel_idx].base
-0000a280: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0000a290: 2020 2020 2020 2020 2020 2020 2020 6461                da
-0000a2a0: 7461 5b63 6861 6e6e 656c 5f69 6478 2c20  ta[channel_idx, 
-0000a2b0: 7472 6961 6c5f 6964 782c 206c 6f63 616c  trial_idx, local
-0000a2c0: 5f73 7461 7274 3a6c 6f63 616c 5f65 6e64  _start:local_end
-0000a2d0: 5d20 3d20 7472 6961 6c5f 6461 7461 5b63  ] = trial_data[c
-0000a2e0: 6861 6e6e 656c 5f69 6478 5d0a 2020 2020  hannel_idx].    
-0000a2f0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000a300: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a310: 2020 2020 2020 6461 7461 5b63 6861 6e6e        data[chann
-0000a320: 656c 5f69 6478 2c20 7472 6961 6c5f 6964  el_idx, trial_id
-0000a330: 782c 206c 6f63 616c 5f73 7461 7274 3a6c  x, local_start:l
-0000a340: 6f63 616c 5f65 6e64 5d20 3d20 7472 6961  ocal_end] = tria
-0000a350: 6c5f 6461 7461 5b63 6861 6e6e 656c 5f69  l_data[channel_i
-0000a360: 6478 5d2e 636f 7079 2829 0a20 2020 2020  dx].copy().     
-0000a370: 2020 2020 2020 2065 6c69 6620 6261 7365         elif base
-0000a380: 6c69 6e65 5f6d 6574 686f 6420 3d3d 2031  line_method == 1
-0000a390: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a3a0: 2020 6261 7365 6c69 6e65 5f6d 6561 6e20    baseline_mean 
-0000a3b0: 3d20 6e70 2e6e 616e 6d65 616e 2874 7269  = np.nanmean(tri
-0000a3c0: 616c 5f64 6174 615b 6368 616e 6e65 6c5f  al_data[channel_
-0000a3d0: 6964 785d 5b62 6173 656c 696e 655f 7374  idx][baseline_st
-0000a3e0: 6172 745f 7361 6d70 6c65 3a62 6173 656c  art_sample:basel
-0000a3f0: 696e 655f 656e 645f 7361 6d70 6c65 5d29  ine_end_sample])
-0000a400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a410: 2064 6174 615b 6368 616e 6e65 6c5f 6964   data[channel_id
-0000a420: 782c 2074 7269 616c 5f69 6478 2c20 6c6f  x, trial_idx, lo
-0000a430: 6361 6c5f 7374 6172 743a 6c6f 6361 6c5f  cal_start:local_
-0000a440: 656e 645d 203d 2074 7269 616c 5f64 6174  end] = trial_dat
-0000a450: 615b 6368 616e 6e65 6c5f 6964 785d 202d  a[channel_idx] -
-0000a460: 2062 6173 656c 696e 655f 6d65 616e 0a20   baseline_mean. 
-0000a470: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0000a480: 6261 7365 6c69 6e65 5f6d 6574 686f 6420  baseline_method 
-0000a490: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
-0000a4a0: 2020 2020 2020 6261 7365 6c69 6e65 5f6d        baseline_m
-0000a4b0: 6564 6961 6e20 3d20 6e70 2e6e 616e 6d65  edian = np.nanme
-0000a4c0: 6469 616e 2874 7269 616c 5f64 6174 615b  dian(trial_data[
-0000a4d0: 6368 616e 6e65 6c5f 6964 785d 5b62 6173  channel_idx][bas
-0000a4e0: 656c 696e 655f 7374 6172 745f 7361 6d70  eline_start_samp
-0000a4f0: 6c65 3a62 6173 656c 696e 655f 656e 645f  le:baseline_end_
-0000a500: 7361 6d70 6c65 5d29 0a20 2020 2020 2020  sample]).       
-0000a510: 2020 2020 2020 2020 2064 6174 615b 6368           data[ch
-0000a520: 616e 6e65 6c5f 6964 782c 2074 7269 616c  annel_idx, trial
-0000a530: 5f69 6478 2c20 6c6f 6361 6c5f 7374 6172  _idx, local_star
-0000a540: 743a 6c6f 6361 6c5f 656e 645d 203d 2074  t:local_end] = t
-0000a550: 7269 616c 5f64 6174 615b 6368 616e 6e65  rial_data[channe
-0000a560: 6c5f 6964 785d 202d 2062 6173 656c 696e  l_idx] - baselin
-0000a570: 655f 6d65 6469 616e 0a0a 2020 2020 2020  e_median..      
-0000a580: 2020 2320 636c 6561 7220 7465 6d70 2064    # clear temp d
-0000a590: 6174 610a 2020 2020 2020 2020 6465 6c20  ata.        del 
-0000a5a0: 7472 6961 6c5f 6461 7461 0a0a 2020 2020  trial_data..    
-0000a5b0: 2020 2020 2320 7570 6461 7465 2070 726f      # update pro
-0000a5c0: 6772 6573 7320 6261 720a 2020 2020 2020  gress bar.      
-0000a5d0: 2020 7072 696e 745f 7072 6f67 7265 7373    print_progress
-0000a5e0: 6261 7228 7472 6961 6c5f 6964 7820 2b20  bar(trial_idx + 
-0000a5f0: 312c 206c 656e 286f 6e73 6574 7329 2c20  1, len(onsets), 
-0000a600: 7072 6566 6978 3d27 5072 6f67 7265 7373  prefix='Progress
-0000a610: 3a27 2c20 7375 6666 6978 3d27 436f 6d70  :', suffix='Comp
-0000a620: 6c65 7465 272c 206c 656e 6774 683d 3530  lete', length=50
-0000a630: 290a 0a20 2020 2023 2072 6574 7572 6e20  )..    # return 
-0000a640: 7468 6520 7361 6d70 6c65 2072 6174 6520  the sample rate 
-0000a650: 616e 6420 7468 6520 6570 6f63 6865 6420  and the epoched 
-0000a660: 6461 7461 0a20 2020 2072 6574 7572 6e20  data.    return 
-0000a670: 6461 7461 5f72 6561 6465 722e 7361 6d70  data_reader.samp
-0000a680: 6c69 6e67 5f72 6174 652c 2064 6174 610a  ling_rate, data.
-0000a690: 0a0a 6465 6620 5f5f 6c6f 6164 5f64 6174  ..def __load_dat
-0000a6a0: 615f 6570 6f63 685f 6176 6572 6167 6573  a_epoch_averages
-0000a6b0: 5f5f 6279 5f63 6f6e 6469 7469 6f6e 5f74  __by_condition_t
-0000a6c0: 7269 616c 2864 6174 615f 7265 6164 6572  rial(data_reader
-0000a6d0: 2c20 7265 7472 6965 7665 5f63 6861 6e6e  , retrieve_chann
-0000a6e0: 656c 732c 0a20 2020 2020 2020 2020 2020  els,.           
-0000a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a710: 2020 2020 2020 2020 636f 6e64 6974 696f          conditio
-0000a720: 6e73 5f6f 6e73 6574 732c 2074 7269 616c  ns_onsets, trial
-0000a730: 5f65 706f 6368 2c0a 2020 2020 2020 2020  _epoch,.        
-0000a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a90: 2020 2077 696c 6c20 6265 2073 6f72 7465     will be sorte
+00008aa0: 6420 6163 636f 7264 696e 676c 790a 2020  d accordingly.  
+00008ab0: 2020 2222 220a 0a20 2020 2023 2063 616c    """..    # cal
+00008ac0: 6375 6c61 7465 2074 6865 2073 697a 6520  culate the size 
+00008ad0: 6f66 2074 6865 2074 696d 6520 6469 6d65  of the time dime
+00008ae0: 6e73 696f 6e20 2869 6e20 7361 6d70 6c65  nsion (in sample
+00008af0: 7329 0a20 2020 2074 7269 616c 5f6e 756d  s).    trial_num
+00008b00: 5f73 616d 706c 6573 203d 2069 6e74 2872  _samples = int(r
+00008b10: 6f75 6e64 2861 6273 2874 7269 616c 5f65  ound(abs(trial_e
+00008b20: 706f 6368 5b31 5d20 2d20 7472 6961 6c5f  poch[1] - trial_
+00008b30: 6570 6f63 685b 305d 2920 2a20 6461 7461  epoch[0]) * data
+00008b40: 5f72 6561 6465 722e 7361 6d70 6c69 6e67  _reader.sampling
+00008b50: 5f72 6174 6529 290a 2020 2020 6261 7365  _rate)).    base
+00008b60: 6c69 6e65 5f6e 756d 5f73 616d 706c 6573  line_num_samples
+00008b70: 203d 2069 6e74 2872 6f75 6e64 2861 6273   = int(round(abs
+00008b80: 2862 6173 656c 696e 655f 6570 6f63 685b  (baseline_epoch[
+00008b90: 315d 202d 2062 6173 656c 696e 655f 6570  1] - baseline_ep
+00008ba0: 6f63 685b 305d 2920 2a20 6461 7461 5f72  och[0]) * data_r
+00008bb0: 6561 6465 722e 7361 6d70 6c69 6e67 5f72  eader.sampling_r
+00008bc0: 6174 6529 290a 0a20 2020 2023 2069 6e69  ate))..    # ini
+00008bd0: 7469 616c 697a 6520 6120 6461 7461 2062  tialize a data b
+00008be0: 7566 6665 7220 2863 6861 6e6e 656c 2078  uffer (channel x
+00008bf0: 2074 7269 616c 732f 6570 6f63 6873 2078   trials/epochs x
+00008c00: 2074 696d 6529 0a20 2020 2074 7279 3a0a   time).    try:.
+00008c10: 2020 2020 2020 2020 6461 7461 203d 2061          data = a
+00008c20: 6c6c 6f63 6174 655f 6172 7261 7928 286c  llocate_array((l
+00008c30: 656e 2872 6574 7269 6576 655f 6368 616e  en(retrieve_chan
+00008c40: 6e65 6c73 292c 206c 656e 286f 6e73 6574  nels), len(onset
+00008c50: 7329 2c20 7472 6961 6c5f 6e75 6d5f 7361  s), trial_num_sa
+00008c60: 6d70 6c65 7329 290a 2020 2020 6578 6365  mples)).    exce
+00008c70: 7074 204d 656d 6f72 7945 7272 6f72 3a0a  pt MemoryError:.
+00008c80: 2020 2020 2020 2020 7261 6973 6520 4d65          raise Me
+00008c90: 6d6f 7279 4572 726f 7228 274e 6f74 2065  moryError('Not e
+00008ca0: 6e6f 7567 6820 6d65 6d6f 7279 2063 7265  nough memory cre
+00008cb0: 6174 6520 6120 6461 7461 206f 7574 7075  ate a data outpu
+00008cc0: 7420 6d61 7472 6978 2729 0a0a 2020 2020  t matrix')..    
+00008cd0: 2320 6372 6561 7465 2070 726f 6772 6573  # create progres
+00008ce0: 7320 6261 720a 2020 2020 7072 696e 745f  s bar.    print_
+00008cf0: 7072 6f67 7265 7373 6261 7228 302c 206c  progressbar(0, l
+00008d00: 656e 286f 6e73 6574 7329 2c20 7072 6566  en(onsets), pref
+00008d10: 6978 3d27 5072 6f67 7265 7373 3a27 2c20  ix='Progress:', 
+00008d20: 7375 6666 6978 3d27 436f 6d70 6c65 7465  suffix='Complete
+00008d30: 272c 206c 656e 6774 683d 3530 290a 0a20  ', length=50).. 
+00008d40: 2020 2023 206c 6f6f 7020 7468 726f 7567     # loop throug
+00008d50: 6820 7468 6520 7472 6961 6c73 0a20 2020  h the trials.   
+00008d60: 2066 6f72 2074 7269 616c 5f69 6478 2069   for trial_idx i
+00008d70: 6e20 7261 6e67 6528 6c65 6e28 6f6e 7365  n range(len(onse
+00008d80: 7473 2929 3a0a 0a20 2020 2020 2020 2023  ts)):..        #
+00008d90: 0a20 2020 2020 2020 2074 7269 616c 5f73  .        trial_s
+00008da0: 616d 706c 655f 7374 6172 7420 3d20 696e  ample_start = in
+00008db0: 7428 726f 756e 6428 286f 6e73 6574 735b  t(round((onsets[
+00008dc0: 7472 6961 6c5f 6964 785d 202b 2074 7269  trial_idx] + tri
+00008dd0: 616c 5f65 706f 6368 5b30 5d29 202a 2064  al_epoch[0]) * d
+00008de0: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
+00008df0: 696e 675f 7261 7465 2929 0a20 2020 2020  ing_rate)).     
+00008e00: 2020 2074 7269 616c 5f73 616d 706c 655f     trial_sample_
+00008e10: 656e 6420 3d20 7472 6961 6c5f 7361 6d70  end = trial_samp
+00008e20: 6c65 5f73 7461 7274 202b 2074 7269 616c  le_start + trial
+00008e30: 5f6e 756d 5f73 616d 706c 6573 0a20 2020  _num_samples.   
+00008e40: 2020 2020 2062 6173 656c 696e 655f 7374       baseline_st
+00008e50: 6172 745f 7361 6d70 6c65 203d 2069 6e74  art_sample = int
+00008e60: 2872 6f75 6e64 2828 6f6e 7365 7473 5b74  (round((onsets[t
+00008e70: 7269 616c 5f69 6478 5d20 2b20 6261 7365  rial_idx] + base
+00008e80: 6c69 6e65 5f65 706f 6368 5b30 5d29 202a  line_epoch[0]) *
+00008e90: 2064 6174 615f 7265 6164 6572 2e73 616d   data_reader.sam
+00008ea0: 706c 696e 675f 7261 7465 2929 202d 2074  pling_rate)) - t
+00008eb0: 7269 616c 5f73 616d 706c 655f 7374 6172  rial_sample_star
+00008ec0: 740a 2020 2020 2020 2020 6261 7365 6c69  t.        baseli
+00008ed0: 6e65 5f65 6e64 5f73 616d 706c 6520 3d20  ne_end_sample = 
+00008ee0: 6261 7365 6c69 6e65 5f73 7461 7274 5f73  baseline_start_s
+00008ef0: 616d 706c 6520 2b20 6261 7365 6c69 6e65  ample + baseline
+00008f00: 5f6e 756d 5f73 616d 706c 6573 0a20 2020  _num_samples.   
+00008f10: 2020 2020 206c 6f63 616c 5f73 7461 7274       local_start
+00008f20: 203d 2030 0a20 2020 2020 2020 206c 6f63   = 0.        loc
+00008f30: 616c 5f65 6e64 203d 2074 7269 616c 5f6e  al_end = trial_n
+00008f40: 756d 5f73 616d 706c 6573 0a0a 2020 2020  um_samples..    
+00008f50: 2020 2020 2320 6368 6563 6b20 7768 6574      # check whet
+00008f60: 6865 7220 7468 6520 7472 6961 6c20 6570  her the trial ep
+00008f70: 6f63 6820 6973 2077 6974 6869 6e20 626f  och is within bo
+00008f80: 756e 6473 0a20 2020 2020 2020 2069 6620  unds.        if 
+00008f90: 7472 6961 6c5f 7361 6d70 6c65 5f65 6e64  trial_sample_end
+00008fa0: 203c 2030 3a0a 2020 2020 2020 2020 2020   < 0:.          
+00008fb0: 2020 6966 2028 6f75 745f 6f66 5f62 6f75    if (out_of_bou
+00008fc0: 6e64 5f6d 6574 686f 6420 3d3d 2031 2061  nd_method == 1 a
+00008fd0: 6e64 2074 7269 616c 5f69 6478 203d 3d20  nd trial_idx == 
+00008fe0: 3029 206f 7220 6f75 745f 6f66 5f62 6f75  0) or out_of_bou
+00008ff0: 6e64 5f6d 6574 686f 6420 3d3d 2032 3a0a  nd_method == 2:.
+00009000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009010: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
+00009020: 2743 616e 6e6f 7420 6578 7472 6163 7420  'Cannot extract 
+00009030: 7468 6520 7472 6961 6c20 7769 7468 206f  the trial with o
+00009040: 6e73 6574 2027 202b 2073 7472 286f 6e73  nset ' + str(ons
+00009050: 6574 735b 7472 6961 6c5f 6964 785d 2920  ets[trial_idx]) 
+00009060: 2b20 272c 2074 6865 2065 6e64 206f 6620  + ', the end of 
+00009070: 7468 6520 7472 6961 6c2d 6570 6f63 6820  the trial-epoch 
+00009080: 6c69 6573 2062 6566 6f72 6520 7468 6520  lies before the 
+00009090: 7374 6172 7420 6f66 2074 6865 2064 6174  start of the dat
+000090a0: 612d 7365 742e 2729 0a20 2020 2020 2020  a-set.').       
+000090b0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+000090c0: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+000090d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000090e0: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
+000090f0: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
+00009100: 7420 7468 6520 7472 6961 6c20 7769 7468  t the trial with
+00009110: 206f 6e73 6574 2027 202b 2073 7472 286f   onset ' + str(o
+00009120: 6e73 6574 735b 7472 6961 6c5f 6964 785d  nsets[trial_idx]
+00009130: 2920 2b20 272c 2074 6865 2065 6e64 206f  ) + ', the end o
+00009140: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
+00009150: 6820 6c69 6573 2062 6566 6f72 6520 7468  h lies before th
+00009160: 6520 7374 6172 7420 6f66 2074 6865 2064  e start of the d
+00009170: 6174 612d 7365 742e 2055 7365 2061 2064  ata-set. Use a d
+00009180: 6966 6665 7265 6e74 206f 7574 5f6f 665f  ifferent out_of_
+00009190: 626f 756e 645f 6861 6e64 6c69 6e67 2061  bound_handling a
+000091a0: 7267 756d 656e 7420 746f 2061 6c6c 6f77  rgument to allow
+000091b0: 206f 7574 2d6f 662d 626f 756e 6420 7472   out-of-bound tr
+000091c0: 6961 6c20 6570 6f63 6873 2729 0a20 2020  ial epochs').   
+000091d0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+000091e0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+000091f0: 2743 616e 6e6f 7420 6578 7472 6163 7420  'Cannot extract 
+00009200: 7472 6961 6c27 290a 2020 2020 2020 2020  trial').        
+00009210: 6966 2074 7269 616c 5f73 616d 706c 655f  if trial_sample_
+00009220: 7374 6172 7420 3c20 303a 0a20 2020 2020  start < 0:.     
+00009230: 2020 2020 2020 2069 6620 286f 7574 5f6f         if (out_o
+00009240: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
+00009250: 3d20 3120 616e 6420 7472 6961 6c5f 6964  = 1 and trial_id
+00009260: 7820 3d3d 2030 2920 6f72 206f 7574 5f6f  x == 0) or out_o
+00009270: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
+00009280: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
+00009290: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
+000092a0: 6e69 6e67 2827 4361 6e6e 6f74 2065 7874  ning('Cannot ext
+000092b0: 7261 6374 2074 6865 2074 7269 616c 2077  ract the trial w
+000092c0: 6974 6820 6f6e 7365 7420 2720 2b20 7374  ith onset ' + st
+000092d0: 7228 6f6e 7365 7473 5b74 7269 616c 5f69  r(onsets[trial_i
+000092e0: 6478 5d29 202b 2027 2c20 7468 6520 7374  dx]) + ', the st
+000092f0: 6172 7420 6f66 2074 6865 2074 7269 616c  art of the trial
+00009300: 2d65 706f 6368 206c 6965 7320 6265 666f  -epoch lies befo
+00009310: 7265 2074 6865 2073 7461 7274 206f 6620  re the start of 
+00009320: 7468 6520 6461 7461 2d73 6574 2e27 290a  the data-set.').
+00009330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009340: 6c6f 6361 6c5f 7374 6172 7420 3d20 7472  local_start = tr
+00009350: 6961 6c5f 7361 6d70 6c65 5f73 7461 7274  ial_sample_start
+00009360: 202a 202d 310a 2020 2020 2020 2020 2020   * -1.          
+00009370: 2020 2020 2020 7472 6961 6c5f 7361 6d70        trial_samp
+00009380: 6c65 5f73 7461 7274 203d 2030 0a20 2020  le_start = 0.   
+00009390: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000093a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+000093b0: 6f67 6769 6e67 2e65 7272 6f72 2827 4361  ogging.error('Ca
+000093c0: 6e6e 6f74 2065 7874 7261 6374 2074 6865  nnot extract the
+000093d0: 2074 7269 616c 2077 6974 6820 6f6e 7365   trial with onse
+000093e0: 7420 2720 2b20 7374 7228 6f6e 7365 7473  t ' + str(onsets
+000093f0: 5b74 7269 616c 5f69 6478 5d29 202b 2027  [trial_idx]) + '
+00009400: 2c20 7468 6520 7374 6172 7420 6f66 2074  , the start of t
+00009410: 6865 2074 7269 616c 2d65 706f 6368 206c  he trial-epoch l
+00009420: 6965 7320 6265 666f 7265 2074 6865 2073  ies before the s
+00009430: 7461 7274 206f 6620 7468 6520 6461 7461  tart of the data
+00009440: 2d73 6574 2e20 5573 6520 6120 6469 6666  -set. Use a diff
+00009450: 6572 656e 7420 6f75 745f 6f66 5f62 6f75  erent out_of_bou
+00009460: 6e64 5f68 616e 646c 696e 6720 6172 6775  nd_handling argu
+00009470: 6d65 6e74 2074 6f20 616c 6c6f 7720 6f75  ment to allow ou
+00009480: 742d 6f66 2d62 6f75 6e64 2074 7269 616c  t-of-bound trial
+00009490: 2065 706f 6368 7327 290a 2020 2020 2020   epochs').      
+000094a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+000094b0: 5275 6e74 696d 6545 7272 6f72 2827 4361  RuntimeError('Ca
+000094c0: 6e6e 6f74 2065 7874 7261 6374 2074 7269  nnot extract tri
+000094d0: 616c 2729 0a20 2020 2020 2020 2069 6620  al').        if 
+000094e0: 7472 6961 6c5f 7361 6d70 6c65 5f73 7461  trial_sample_sta
+000094f0: 7274 203e 2064 6174 615f 7265 6164 6572  rt > data_reader
+00009500: 2e6e 756d 5f73 616d 706c 6573 3a0a 2020  .num_samples:.  
+00009510: 2020 2020 2020 2020 2020 6966 2028 6f75            if (ou
+00009520: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
+00009530: 6420 3d3d 2031 2061 6e64 2074 7269 616c  d == 1 and trial
+00009540: 5f69 6478 203d 3d20 6c65 6e28 6f6e 7365  _idx == len(onse
+00009550: 7473 2920 2d20 3129 206f 7220 6f75 745f  ts) - 1) or out_
+00009560: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6420  of_bound_method 
+00009570: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
+00009580: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
+00009590: 726e 696e 6728 2743 616e 6e6f 7420 6578  rning('Cannot ex
+000095a0: 7472 6163 7420 7468 6520 7472 6961 6c20  tract the trial 
+000095b0: 7769 7468 206f 6e73 6574 2027 202b 2073  with onset ' + s
+000095c0: 7472 286f 6e73 6574 735b 7472 6961 6c5f  tr(onsets[trial_
+000095d0: 6964 785d 2920 2b20 272c 2074 6865 2073  idx]) + ', the s
+000095e0: 7461 7274 206f 6620 7468 6520 7472 6961  tart of the tria
+000095f0: 6c2d 6570 6f63 6820 6c69 6573 2061 6674  l-epoch lies aft
+00009600: 6572 2074 6865 2065 6e64 206f 6620 7468  er the end of th
+00009610: 6520 6461 7461 2d73 6574 2e27 290a 2020  e data-set.').  
+00009620: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00009630: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
+00009640: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00009650: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+00009660: 2e65 7272 6f72 2827 4361 6e6e 6f74 2065  .error('Cannot e
+00009670: 7874 7261 6374 2074 6865 2074 7269 616c  xtract the trial
+00009680: 2077 6974 6820 6f6e 7365 7420 2720 2b20   with onset ' + 
+00009690: 7374 7228 6f6e 7365 7473 5b74 7269 616c  str(onsets[trial
+000096a0: 5f69 6478 5d29 202b 2027 2c20 7468 6520  _idx]) + ', the 
+000096b0: 7374 6172 7420 6f66 2074 6865 2074 7269  start of the tri
+000096c0: 616c 2d65 706f 6368 206c 6965 7320 6166  al-epoch lies af
+000096d0: 7465 7220 7468 6520 656e 6420 6f66 2074  ter the end of t
+000096e0: 6865 2064 6174 612d 7365 742e 2055 7365  he data-set. Use
+000096f0: 2061 2064 6966 6665 7265 6e74 206f 7574   a different out
+00009700: 5f6f 665f 626f 756e 645f 6861 6e64 6c69  _of_bound_handli
+00009710: 6e67 2061 7267 756d 656e 7420 746f 2061  ng argument to a
+00009720: 6c6c 6f77 206f 7574 2d6f 662d 626f 756e  llow out-of-boun
+00009730: 6420 7472 6961 6c20 6570 6f63 6873 2729  d trial epochs')
+00009740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009750: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+00009760: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+00009770: 6163 7420 7472 6961 6c27 290a 2020 2020  act trial').    
+00009780: 2020 2020 6966 2074 7269 616c 5f73 616d      if trial_sam
+00009790: 706c 655f 656e 6420 3e20 6461 7461 5f72  ple_end > data_r
+000097a0: 6561 6465 722e 6e75 6d5f 7361 6d70 6c65  eader.num_sample
+000097b0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+000097c0: 6620 286f 7574 5f6f 665f 626f 756e 645f  f (out_of_bound_
+000097d0: 6d65 7468 6f64 203d 3d20 3120 616e 6420  method == 1 and 
+000097e0: 7472 6961 6c5f 6964 7820 3d3d 206c 656e  trial_idx == len
+000097f0: 286f 6e73 6574 7329 202d 2031 2920 6f72  (onsets) - 1) or
+00009800: 206f 7574 5f6f 665f 626f 756e 645f 6d65   out_of_bound_me
+00009810: 7468 6f64 203d 3d20 323a 0a20 2020 2020  thod == 2:.     
+00009820: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00009830: 6e67 2e77 6172 6e69 6e67 2827 4361 6e6e  ng.warning('Cann
+00009840: 6f74 2065 7874 7261 6374 2074 6865 2074  ot extract the t
+00009850: 7269 616c 2077 6974 6820 6f6e 7365 7420  rial with onset 
+00009860: 2720 2b20 7374 7228 6f6e 7365 7473 5b74  ' + str(onsets[t
+00009870: 7269 616c 5f69 6478 5d29 202b 2027 2c20  rial_idx]) + ', 
+00009880: 7468 6520 656e 6420 6f66 2074 6865 2074  the end of the t
+00009890: 7269 616c 2d65 706f 6368 206c 6965 7320  rial-epoch lies 
+000098a0: 6166 7465 7220 7468 6520 656e 6420 6f66  after the end of
+000098b0: 2074 6865 2064 6174 612d 7365 742e 2729   the data-set.')
+000098c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000098d0: 206c 6f63 616c 5f65 6e64 203d 2074 7269   local_end = tri
+000098e0: 616c 5f6e 756d 5f73 616d 706c 6573 202d  al_num_samples -
+000098f0: 2028 7472 6961 6c5f 7361 6d70 6c65 5f65   (trial_sample_e
+00009900: 6e64 202d 2064 6174 615f 7265 6164 6572  nd - data_reader
+00009910: 2e6e 756d 5f73 616d 706c 6573 290a 2020  .num_samples).  
+00009920: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00009930: 6961 6c5f 7361 6d70 6c65 5f65 6e64 203d  ial_sample_end =
+00009940: 2064 6174 615f 7265 6164 6572 2e6e 756d   data_reader.num
+00009950: 5f73 616d 706c 6573 0a20 2020 2020 2020  _samples.       
+00009960: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00009970: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00009980: 6e67 2e65 7272 6f72 2827 4361 6e6e 6f74  ng.error('Cannot
+00009990: 2065 7874 7261 6374 2074 6865 2074 7269   extract the tri
+000099a0: 616c 2077 6974 6820 6f6e 7365 7420 2720  al with onset ' 
+000099b0: 2b20 7374 7228 6f6e 7365 7473 5b74 7269  + str(onsets[tri
+000099c0: 616c 5f69 6478 5d29 202b 2027 2c20 7468  al_idx]) + ', th
+000099d0: 6520 656e 6420 6f66 2074 6865 2074 7269  e end of the tri
+000099e0: 616c 2d65 706f 6368 206c 6965 7320 6166  al-epoch lies af
+000099f0: 7465 7220 7468 6520 656e 6420 6f66 2074  ter the end of t
+00009a00: 6865 2064 6174 612d 7365 742e 2055 7365  he data-set. Use
+00009a10: 2061 2064 6966 6665 7265 6e74 206f 7574   a different out
+00009a20: 5f6f 665f 626f 756e 645f 6861 6e64 6c69  _of_bound_handli
+00009a30: 6e67 2061 7267 756d 656e 7420 746f 2061  ng argument to a
+00009a40: 6c6c 6f77 206f 7574 2d6f 662d 626f 756e  llow out-of-boun
+00009a50: 6420 7472 6961 6c20 6570 6f63 6873 2729  d trial epochs')
+00009a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009a70: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+00009a80: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+00009a90: 6163 7420 7472 6961 6c27 290a 0a20 2020  act trial')..   
+00009aa0: 2020 2020 2023 2063 6865 636b 2077 6865       # check whe
+00009ab0: 7468 6572 2074 6865 2062 6173 656c 696e  ther the baselin
+00009ac0: 6520 6973 2077 6974 6869 6e20 626f 756e  e is within boun
+00009ad0: 6473 0a20 2020 2020 2020 2069 6620 6261  ds.        if ba
+00009ae0: 7365 6c69 6e65 5f6d 6574 686f 6420 3e20  seline_method > 
+00009af0: 303a 0a20 2020 2020 2020 2020 2020 2069  0:.            i
+00009b00: 6620 6261 7365 6c69 6e65 5f73 7461 7274  f baseline_start
+00009b10: 5f73 616d 706c 6520 3c20 303a 0a20 2020  _sample < 0:.   
+00009b20: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00009b30: 6769 6e67 2e65 7272 6f72 2827 4361 6e6e  ging.error('Cann
+00009b40: 6f74 2065 7874 7261 6374 2074 6865 2062  ot extract the b
+00009b50: 6173 656c 696e 6520 666f 7220 7468 6520  aseline for the 
+00009b60: 7472 6961 6c20 7769 7468 206f 6e73 6574  trial with onset
+00009b70: 2027 202b 2073 7472 286f 6e73 6574 735b   ' + str(onsets[
+00009b80: 7472 6961 6c5f 6964 785d 2920 2b20 272c  trial_idx]) + ',
+00009b90: 2074 6865 2073 7461 7274 206f 6620 7468   the start of th
+00009ba0: 6520 6261 7365 6c69 6e65 2d65 706f 6368  e baseline-epoch
+00009bb0: 206c 6965 7320 6265 666f 7265 2074 6865   lies before the
+00009bc0: 2073 7461 7274 206f 6620 7468 6520 7472   start of the tr
+00009bd0: 6961 6c2d 6570 6f63 6827 290a 2020 2020  ial-epoch').    
+00009be0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00009bf0: 6520 5275 6e74 696d 6545 7272 6f72 2827  e RuntimeError('
+00009c00: 4361 6e6e 6f74 2065 7874 7261 6374 2062  Cannot extract b
+00009c10: 6173 656c 696e 6527 290a 2020 2020 2020  aseline').      
+00009c20: 2020 2020 2020 6966 2062 6173 656c 696e        if baselin
+00009c30: 655f 656e 645f 7361 6d70 6c65 203e 2074  e_end_sample > t
+00009c40: 7269 616c 5f6e 756d 5f73 616d 706c 6573  rial_num_samples
+00009c50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009c60: 2020 6c6f 6767 696e 672e 6572 726f 7228    logging.error(
+00009c70: 2743 616e 6e6f 7420 6578 7472 6163 7420  'Cannot extract 
+00009c80: 7468 6520 6261 7365 6c69 6e65 2066 6f72  the baseline for
+00009c90: 2074 6865 2074 7269 616c 2077 6974 6820   the trial with 
+00009ca0: 6f6e 7365 7420 2720 2b20 7374 7228 6f6e  onset ' + str(on
+00009cb0: 7365 7473 5b74 7269 616c 5f69 6478 5d29  sets[trial_idx])
+00009cc0: 202b 2027 2c20 7468 6520 656e 6420 6f66   + ', the end of
+00009cd0: 2074 6865 2062 6173 656c 696e 652d 6570   the baseline-ep
+00009ce0: 6f63 6820 6c69 6573 206f 7574 7369 6465  och lies outside
+00009cf0: 206f 6620 7468 6520 7472 6961 6c2d 6570   of the trial-ep
+00009d00: 6f63 6827 290a 2020 2020 2020 2020 2020  och').          
+00009d10: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+00009d20: 696d 6545 7272 6f72 2827 4361 6e6e 6f74  imeError('Cannot
+00009d30: 2065 7874 7261 6374 2062 6173 656c 696e   extract baselin
+00009d40: 6527 290a 2020 2020 2020 2020 2020 2020  e').            
+00009d50: 6966 2062 6173 656c 696e 655f 7374 6172  if baseline_star
+00009d60: 745f 7361 6d70 6c65 203c 206c 6f63 616c  t_sample < local
+00009d70: 5f73 7461 7274 206f 7220 6261 7365 6c69  _start or baseli
+00009d80: 6e65 5f65 6e64 5f73 616d 706c 6520 3e20  ne_end_sample > 
+00009d90: 6c6f 6361 6c5f 656e 643a 0a20 2020 2020  local_end:.     
+00009da0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00009db0: 6e67 2e65 7272 6f72 2827 4361 6e6e 6f74  ng.error('Cannot
+00009dc0: 2065 7874 7261 6374 2074 6865 2062 6173   extract the bas
+00009dd0: 656c 696e 6520 666f 7220 7468 6520 7472  eline for the tr
+00009de0: 6961 6c20 7769 7468 206f 6e73 6574 2027  ial with onset '
+00009df0: 202b 2073 7472 286f 6e73 6574 735b 7472   + str(onsets[tr
+00009e00: 6961 6c5f 6964 785d 2920 2b20 272c 2074  ial_idx]) + ', t
+00009e10: 6865 2072 616e 6765 2066 6f72 2074 6865  he range for the
+00009e20: 2062 6173 656c 696e 6520 6c69 6573 206f   baseline lies o
+00009e30: 7574 7369 6465 206f 6620 7468 6520 7472  utside of the tr
+00009e40: 6961 6c2d 6570 6f63 6820 6265 6361 7573  ial-epoch becaus
+00009e50: 6520 7468 6174 2070 6172 7420 6f66 2074  e that part of t
+00009e60: 6865 2074 7269 616c 2d65 706f 6368 2077  he trial-epoch w
+00009e70: 6173 206f 7574 2d6f 662d 626f 756e 6473  as out-of-bounds
+00009e80: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00009e90: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+00009ea0: 4572 726f 7228 2743 616e 6e6f 7420 6578  Error('Cannot ex
+00009eb0: 7472 6163 7420 6261 7365 6c69 6e65 2729  tract baseline')
+00009ec0: 0a0a 2020 2020 2020 2020 2320 6c6f 6164  ..        # load
+00009ed0: 2074 6865 2074 7269 616c 2064 6174 610a   the trial data.
+00009ee0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00009ef0: 2020 2020 2020 2020 2074 7269 616c 5f64           trial_d
+00009f00: 6174 6120 3d20 6461 7461 5f72 6561 6465  ata = data_reade
+00009f10: 722e 7265 7472 6965 7665 5f73 616d 706c  r.retrieve_sampl
+00009f20: 655f 7261 6e67 655f 6461 7461 2874 7269  e_range_data(tri
+00009f30: 616c 5f73 616d 706c 655f 7374 6172 742c  al_sample_start,
+00009f40: 2074 7269 616c 5f73 616d 706c 655f 656e   trial_sample_en
+00009f50: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+00009f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f90: 2020 2063 6861 6e6e 656c 733d 7265 7472     channels=retr
+00009fa0: 6965 7665 5f63 6861 6e6e 656c 732c 2065  ieve_channels, e
+00009fb0: 6e73 7572 655f 6f77 6e5f 6461 7461 3d46  nsure_own_data=F
+00009fc0: 616c 7365 290a 2020 2020 2020 2020 6578  alse).        ex
+00009fd0: 6365 7074 2028 5275 6e74 696d 6545 7272  cept (RuntimeErr
+00009fe0: 6f72 2c20 4c6f 6f6b 7570 4572 726f 7229  or, LookupError)
+00009ff0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000a000: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+0000a010: 2827 436f 756c 6420 6e6f 7420 6c6f 6164  ('Could not load
+0000a020: 2064 6174 6127 290a 0a20 2020 2020 2020   data')..       
+0000a030: 2023 206c 6f6f 7020 7468 726f 7567 6820   # loop through 
+0000a040: 7468 6520 6368 616e 6e65 6c73 0a20 2020  the channels.   
+0000a050: 2020 2020 2066 6f72 2063 6861 6e6e 656c       for channel
+0000a060: 5f69 6478 2069 6e20 7261 6e67 6528 6c65  _idx in range(le
+0000a070: 6e28 7265 7472 6965 7665 5f63 6861 6e6e  n(retrieve_chann
+0000a080: 656c 7329 293a 0a0a 2020 2020 2020 2020  els)):..        
+0000a090: 2020 2020 2320 6578 7472 6163 7420 7468      # extract th
+0000a0a0: 6520 7472 6961 6c20 6461 7461 2061 6e64  e trial data and
+0000a0b0: 2070 6572 666f 726d 2062 6173 656c 696e   perform baselin
+0000a0c0: 6520 6e6f 726d 616c 697a 6174 696f 6e20  e normalization 
+0000a0d0: 6f6e 2074 6865 2074 7269 616c 2069 6620  on the trial if 
+0000a0e0: 6e65 6564 6564 0a20 2020 2020 2020 2020  needed.         
+0000a0f0: 2020 2069 6620 6261 7365 6c69 6e65 5f6d     if baseline_m
+0000a100: 6574 686f 6420 3d3d 2030 3a0a 2020 2020  ethod == 0:.    
+0000a110: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+0000a120: 7465 3a20 7369 6e63 6520 7765 2061 7265  te: since we are
+0000a130: 206e 6f74 206d 616e 6970 756c 6174 696e   not manipulatin
+0000a140: 6720 7468 6520 6461 7461 2028 7768 6963  g the data (whic
+0000a150: 6820 696e 2074 6865 206f 7468 6572 2063  h in the other c
+0000a160: 6173 6573 2063 6f6e 7665 7274 7320 6120  ases converts a 
+0000a170: 7669 6577 2074 6f20 6461 7461 292c 2065  view to data), e
+0000a180: 6e73 7572 650a 2020 2020 2020 2020 2020  nsure.          
+0000a190: 2020 2020 2020 2320 2020 2020 2020 7468        #       th
+0000a1a0: 6520 6570 6f63 6820 6861 7320 6974 7320  e epoch has its 
+0000a1b0: 6f77 6e20 6461 7461 2028 6e6f 7420 6120  own data (not a 
+0000a1c0: 7669 6577 292e 2041 766f 6964 696e 6720  view). Avoiding 
+0000a1d0: 7669 6577 7320 7072 6576 656e 7473 2074  views prevents t
+0000a1e0: 726f 7562 6c65 2077 6974 6820 6f76 6572  rouble with over
+0000a1f0: 6c61 7070 696e 670a 2020 2020 2020 2020  lapping.        
+0000a200: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+0000a210: 6570 6f63 6873 3b20 696e 2061 6464 6974  epochs; in addit
+0000a220: 696f 6e2c 2061 766f 6964 696e 6720 7669  ion, avoiding vi
+0000a230: 6577 7320 656e 7375 7265 7320 7468 6572  ews ensures ther
+0000a240: 6520 6172 6520 6e6f 2072 656d 6169 6e69  e are no remaini
+0000a250: 6e67 2072 6566 6572 656e 6365 7320 746f  ng references to
+0000a260: 2074 6865 2073 6f75 7263 650a 2020 2020   the source.    
+0000a270: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+0000a280: 2020 2020 6e75 6d70 792d 6172 7261 792c      numpy-array,
+0000a290: 2061 6c6c 6f77 696e 6720 6974 2074 6f20   allowing it to 
+0000a2a0: 6265 2063 6c65 6172 6564 2066 726f 6d20  be cleared from 
+0000a2b0: 6d65 6d6f 7279 0a20 2020 2020 2020 2020  memory.         
+0000a2c0: 2020 2020 2020 2069 6620 7472 6961 6c5f         if trial_
+0000a2d0: 6461 7461 5b63 6861 6e6e 656c 5f69 6478  data[channel_idx
+0000a2e0: 5d2e 6261 7365 2069 7320 4e6f 6e65 3a0a  ].base is None:.
+0000a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a300: 2020 2020 6461 7461 5b63 6861 6e6e 656c      data[channel
+0000a310: 5f69 6478 2c20 7472 6961 6c5f 6964 782c  _idx, trial_idx,
+0000a320: 206c 6f63 616c 5f73 7461 7274 3a6c 6f63   local_start:loc
+0000a330: 616c 5f65 6e64 5d20 3d20 7472 6961 6c5f  al_end] = trial_
+0000a340: 6461 7461 5b63 6861 6e6e 656c 5f69 6478  data[channel_idx
+0000a350: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000a360: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000a370: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0000a380: 5b63 6861 6e6e 656c 5f69 6478 2c20 7472  [channel_idx, tr
+0000a390: 6961 6c5f 6964 782c 206c 6f63 616c 5f73  ial_idx, local_s
+0000a3a0: 7461 7274 3a6c 6f63 616c 5f65 6e64 5d20  tart:local_end] 
+0000a3b0: 3d20 7472 6961 6c5f 6461 7461 5b63 6861  = trial_data[cha
+0000a3c0: 6e6e 656c 5f69 6478 5d2e 636f 7079 2829  nnel_idx].copy()
+0000a3d0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0000a3e0: 6620 6261 7365 6c69 6e65 5f6d 6574 686f  f baseline_metho
+0000a3f0: 6420 3d3d 2031 3a0a 2020 2020 2020 2020  d == 1:.        
+0000a400: 2020 2020 2020 2020 6261 7365 6c69 6e65          baseline
+0000a410: 5f6d 6561 6e20 3d20 6e70 2e6e 616e 6d65  _mean = np.nanme
+0000a420: 616e 2874 7269 616c 5f64 6174 615b 6368  an(trial_data[ch
+0000a430: 616e 6e65 6c5f 6964 785d 5b62 6173 656c  annel_idx][basel
+0000a440: 696e 655f 7374 6172 745f 7361 6d70 6c65  ine_start_sample
+0000a450: 3a62 6173 656c 696e 655f 656e 645f 7361  :baseline_end_sa
+0000a460: 6d70 6c65 5d29 0a20 2020 2020 2020 2020  mple]).         
+0000a470: 2020 2020 2020 2064 6174 615b 6368 616e         data[chan
+0000a480: 6e65 6c5f 6964 782c 2074 7269 616c 5f69  nel_idx, trial_i
+0000a490: 6478 2c20 6c6f 6361 6c5f 7374 6172 743a  dx, local_start:
+0000a4a0: 6c6f 6361 6c5f 656e 645d 203d 2074 7269  local_end] = tri
+0000a4b0: 616c 5f64 6174 615b 6368 616e 6e65 6c5f  al_data[channel_
+0000a4c0: 6964 785d 202d 2062 6173 656c 696e 655f  idx] - baseline_
+0000a4d0: 6d65 616e 0a20 2020 2020 2020 2020 2020  mean.           
+0000a4e0: 2065 6c69 6620 6261 7365 6c69 6e65 5f6d   elif baseline_m
+0000a4f0: 6574 686f 6420 3d3d 2032 3a0a 2020 2020  ethod == 2:.    
+0000a500: 2020 2020 2020 2020 2020 2020 6261 7365              base
+0000a510: 6c69 6e65 5f6d 6564 6961 6e20 3d20 6e70  line_median = np
+0000a520: 2e6e 616e 6d65 6469 616e 2874 7269 616c  .nanmedian(trial
+0000a530: 5f64 6174 615b 6368 616e 6e65 6c5f 6964  _data[channel_id
+0000a540: 785d 5b62 6173 656c 696e 655f 7374 6172  x][baseline_star
+0000a550: 745f 7361 6d70 6c65 3a62 6173 656c 696e  t_sample:baselin
+0000a560: 655f 656e 645f 7361 6d70 6c65 5d29 0a20  e_end_sample]). 
+0000a570: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0000a580: 6174 615b 6368 616e 6e65 6c5f 6964 782c  ata[channel_idx,
+0000a590: 2074 7269 616c 5f69 6478 2c20 6c6f 6361   trial_idx, loca
+0000a5a0: 6c5f 7374 6172 743a 6c6f 6361 6c5f 656e  l_start:local_en
+0000a5b0: 645d 203d 2074 7269 616c 5f64 6174 615b  d] = trial_data[
+0000a5c0: 6368 616e 6e65 6c5f 6964 785d 202d 2062  channel_idx] - b
+0000a5d0: 6173 656c 696e 655f 6d65 6469 616e 0a0a  aseline_median..
+0000a5e0: 2020 2020 2020 2020 2320 636c 6561 7220          # clear 
+0000a5f0: 7465 6d70 2064 6174 610a 2020 2020 2020  temp data.      
+0000a600: 2020 6465 6c20 7472 6961 6c5f 6461 7461    del trial_data
+0000a610: 0a0a 2020 2020 2020 2020 2320 7570 6461  ..        # upda
+0000a620: 7465 2070 726f 6772 6573 7320 6261 720a  te progress bar.
+0000a630: 2020 2020 2020 2020 7072 696e 745f 7072          print_pr
+0000a640: 6f67 7265 7373 6261 7228 7472 6961 6c5f  ogressbar(trial_
+0000a650: 6964 7820 2b20 312c 206c 656e 286f 6e73  idx + 1, len(ons
+0000a660: 6574 7329 2c20 7072 6566 6978 3d27 5072  ets), prefix='Pr
+0000a670: 6f67 7265 7373 3a27 2c20 7375 6666 6978  ogress:', suffix
+0000a680: 3d27 436f 6d70 6c65 7465 272c 206c 656e  ='Complete', len
+0000a690: 6774 683d 3530 290a 0a20 2020 2023 2072  gth=50)..    # r
+0000a6a0: 6574 7572 6e20 7468 6520 7361 6d70 6c65  eturn the sample
+0000a6b0: 2072 6174 6520 616e 6420 7468 6520 6570   rate and the ep
+0000a6c0: 6f63 6865 6420 6461 7461 0a20 2020 2072  oched data.    r
+0000a6d0: 6574 7572 6e20 6461 7461 5f72 6561 6465  eturn data_reade
+0000a6e0: 722e 7361 6d70 6c69 6e67 5f72 6174 652c  r.sampling_rate,
+0000a6f0: 2064 6174 610a 0a0a 6465 6620 5f5f 6c6f   data...def __lo
+0000a700: 6164 5f64 6174 615f 6570 6f63 685f 6176  ad_data_epoch_av
+0000a710: 6572 6167 6573 5f5f 6279 5f63 6f6e 6469  erages__by_condi
+0000a720: 7469 6f6e 5f74 7269 616c 2864 6174 615f  tion_trial(data_
+0000a730: 7265 6164 6572 2c20 7265 7472 6965 7665  reader, retrieve
+0000a740: 5f63 6861 6e6e 656c 732c 0a20 2020 2020  _channels,.     
 0000a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a760: 2020 2020 2020 2020 2020 2062 6173 656c             basel
-0000a770: 696e 655f 6d65 7468 6f64 2c20 6261 7365  ine_method, base
-0000a780: 6c69 6e65 5f65 706f 6368 2c20 6f75 745f  line_epoch, out_
-0000a790: 6f66 5f62 6f75 6e64 5f6d 6574 686f 642c  of_bound_method,
-0000a7a0: 206d 6574 7269 635f 6361 6c6c 6261 636b   metric_callback
-0000a7b0: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
-0000a7c0: 4c6f 6164 2064 6174 6120 6570 6f63 6820  Load data epoch 
-0000a7d0: 6176 6572 6167 6573 2074 6f20 6120 6d61  averages to a ma
-0000a7e0: 7472 6978 2028 666f 726d 6174 3a20 6368  trix (format: ch
-0000a7f0: 616e 6e65 6c20 7820 636f 6e64 6974 696f  annel x conditio
-0000a800: 6e20 7820 7469 6d65 2920 6279 206c 6f6f  n x time) by loo
-0000a810: 7069 6e67 206f 7665 7220 636f 6e64 6974  ping over condit
-0000a820: 696f 6e73 2c20 6c6f 6f70 696e 6720 6f76  ions, looping ov
-0000a830: 6572 0a20 2020 2074 6865 2074 7269 616c  er.    the trial
-0000a840: 7320 7769 7468 696e 2061 2063 6f6e 6469  s within a condi
-0000a850: 7469 6f6e 2061 6e64 2074 6865 6e20 6c6f  tion and then lo
-0000a860: 6164 2074 6865 2064 6174 6120 7065 7220  ad the data per 
-0000a870: 636f 6e64 6974 696f 6e2d 7472 6961 6c20  condition-trial 
-0000a880: 2866 6f72 2061 6c6c 2063 6861 6e6e 656c  (for all channel
-0000a890: 7329 2061 6e64 2070 6572 666f 726d 0a20  s) and perform. 
-0000a8a0: 2020 2061 7665 7261 6769 6e67 2028 616e     averaging (an
-0000a8b0: 6420 6d65 7472 6963 2063 616c 6375 6c61  d metric calcula
-0000a8c0: 7469 6f6e 2920 6279 2069 7465 7261 7469  tion) by iterati
-0000a8d0: 6e67 206f 7665 7220 6561 6368 206f 6620  ng over each of 
-0000a8e0: 7468 6520 6368 616e 6e65 6c73 0a0a 2020  the channels..  
-0000a8f0: 2020 4e6f 7465 3a20 2020 466f 7220 4d45    Note:   For ME
-0000a900: 4633 2074 6869 7320 6973 2074 6865 2066  F3 this is the f
-0000a910: 6173 7465 7374 2073 6f6c 7574 696f 6e20  astest solution 
-0000a920: 7768 696c 6520 7573 696e 6720 6120 736d  while using a sm
-0000a930: 616c 6c20 616d 6f75 6e74 206f 6620 6d65  all amount of me
-0000a940: 6d6f 7279 2028 6265 6361 7573 6520 6f6e  mory (because on
-0000a950: 6c79 2074 6865 2072 6571 7569 7265 6420  ly the required 
-0000a960: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-0000a970: 2069 7320 6c6f 6164 6564 292e 2054 6865   is loaded). The
-0000a980: 2027 5f5f 6c6f 6164 5f64 6174 615f 6570   '__load_data_ep
-0000a990: 6f63 685f 6176 6572 6167 6573 5f5f 6279  och_averages__by
-0000a9a0: 5f63 6861 6e6e 656c 5f63 6f6e 6469 7469  _channel_conditi
-0000a9b0: 6f6e 5f74 7269 616c 2720 6973 2065 7665  on_trial' is eve
-0000a9c0: 6e20 6d6f 7265 206d 656d 6f72 790a 2020  n more memory.  
-0000a9d0: 2020 2020 2020 2020 2020 6566 6669 6369            effici
-0000a9e0: 656e 7420 6275 7420 736c 6f77 6572 2066  ent but slower f
-0000a9f0: 6f72 204d 4546 332e 2046 6f72 2045 4446  or MEF3. For EDF
-0000aa00: 2061 6e64 2042 7261 696e 5669 7369 6f6e   and BrainVision
-0000aa10: 2074 6865 7265 2069 7320 6e6f 7420 6d75   there is not mu
-0000aa20: 6368 2064 6966 6665 7265 6e63 6520 6265  ch difference be
-0000aa30: 6361 7573 6520 4d4e 4520 7072 656c 6f61  cause MNE preloa
-0000aa40: 6473 2074 6865 0a20 2020 2020 2020 2020  ds the.         
-0000aa50: 2020 2077 686f 6c65 2073 6574 2074 6f20     whole set to 
-0000aa60: 6d65 6d6f 7279 2066 6972 7374 2c20 736f  memory first, so
-0000aa70: 206a 7573 7420 6e75 6d70 792d 7669 6577   just numpy-view
-0000aa80: 7320 6172 6520 7265 7475 726e 6564 2061  s are returned a
-0000aa90: 6e64 2075 7365 642e 0a20 2020 204e 6f74  nd used..    Not
-0000aaa0: 6532 3a20 206f 6e6c 7920 616e 206f 7074  e2:  only an opt
-0000aab0: 696f 6e20 7768 656e 2061 7420 6e6f 2070  ion when at no p
-0000aac0: 6f69 6e74 2074 6865 2066 756c 6c20 6368  oint the full ch
-0000aad0: 616e 6e65 6c20 6461 7461 2069 7320 6e65  annel data is ne
-0000aae0: 6564 6564 2028 652e 672e 2063 616e 6e6f  eded (e.g. canno
-0000aaf0: 7420 6265 2075 7365 6420 7768 656e 2068  t be used when h
-0000ab00: 6967 682d 7061 7373 2066 696c 7465 7269  igh-pass filteri
-0000ab10: 6e67 2069 7320 7265 7175 6972 6564 290a  ng is required).
-0000ab20: 2020 2020 2222 220a 0a0a 2020 2020 2320      """...    # 
-0000ab30: 6361 6c63 756c 6174 6520 7468 6520 7369  calculate the si
-0000ab40: 7a65 206f 6620 7468 6520 7469 6d65 2064  ze of the time d
-0000ab50: 696d 656e 7369 6f6e 2028 696e 2073 616d  imension (in sam
-0000ab60: 706c 6573 290a 2020 2020 7472 6961 6c5f  ples).    trial_
-0000ab70: 6e75 6d5f 7361 6d70 6c65 7320 3d20 696e  num_samples = in
-0000ab80: 7428 726f 756e 6428 6162 7328 7472 6961  t(round(abs(tria
-0000ab90: 6c5f 6570 6f63 685b 315d 202d 2074 7269  l_epoch[1] - tri
-0000aba0: 616c 5f65 706f 6368 5b30 5d29 202a 2064  al_epoch[0]) * d
-0000abb0: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
-0000abc0: 696e 675f 7261 7465 2929 0a20 2020 2062  ing_rate)).    b
-0000abd0: 6173 656c 696e 655f 6e75 6d5f 7361 6d70  aseline_num_samp
-0000abe0: 6c65 7320 3d20 696e 7428 726f 756e 6428  les = int(round(
-0000abf0: 6162 7328 6261 7365 6c69 6e65 5f65 706f  abs(baseline_epo
-0000ac00: 6368 5b31 5d20 2d20 6261 7365 6c69 6e65  ch[1] - baseline
-0000ac10: 5f65 706f 6368 5b30 5d29 202a 2064 6174  _epoch[0]) * dat
-0000ac20: 615f 7265 6164 6572 2e73 616d 706c 696e  a_reader.samplin
-0000ac30: 675f 7261 7465 2929 0a0a 2020 2020 2320  g_rate))..    # 
-0000ac40: 696e 6974 6961 6c69 7a65 2061 2064 6174  initialize a dat
-0000ac50: 6120 6275 6666 6572 2028 6368 616e 6e65  a buffer (channe
-0000ac60: 6c20 7820 636f 6e64 6974 696f 6e73 2078  l x conditions x
-0000ac70: 2073 616d 706c 6573 290a 2020 2020 7472   samples).    tr
-0000ac80: 793a 0a20 2020 2020 2020 2064 6174 6120  y:.        data 
-0000ac90: 3d20 616c 6c6f 6361 7465 5f61 7272 6179  = allocate_array
-0000aca0: 2828 6c65 6e28 7265 7472 6965 7665 5f63  ((len(retrieve_c
-0000acb0: 6861 6e6e 656c 7329 2c20 6c65 6e28 636f  hannels), len(co
-0000acc0: 6e64 6974 696f 6e73 5f6f 6e73 6574 7329  nditions_onsets)
-0000acd0: 2c20 7472 6961 6c5f 6e75 6d5f 7361 6d70  , trial_num_samp
-0000ace0: 6c65 7329 290a 2020 2020 6578 6365 7074  les)).    except
-0000acf0: 204d 656d 6f72 7945 7272 6f72 3a0a 2020   MemoryError:.  
-0000ad00: 2020 2020 2020 7261 6973 6520 4d65 6d6f        raise Memo
-0000ad10: 7279 4572 726f 7228 274e 6f74 2065 6e6f  ryError('Not eno
-0000ad20: 7567 6820 6d65 6d6f 7279 2063 7265 6174  ugh memory creat
-0000ad30: 6520 6120 6461 7461 206f 7574 7075 7420  e a data output 
-0000ad40: 6d61 7472 6978 2729 0a0a 2020 2020 2320  matrix')..    # 
-0000ad50: 696e 6974 6961 6c69 7a65 2061 206d 6574  initialize a met
-0000ad60: 7269 6320 6275 6666 6572 2028 6368 616e  ric buffer (chan
-0000ad70: 6e65 6c20 7820 636f 6e64 6974 696f 6e73  nel x conditions
-0000ad80: 2078 206d 6574 7269 6329 0a20 2020 2074   x metric).    t
-0000ad90: 7279 3a0a 2020 2020 2020 2020 6d65 7472  ry:.        metr
-0000ada0: 6963 5f76 616c 7565 7320 3d20 4e6f 6e65  ic_values = None
-0000adb0: 0a20 2020 2020 2020 2069 6620 6d65 7472  .        if metr
-0000adc0: 6963 5f63 616c 6c62 6163 6b73 2069 7320  ic_callbacks is 
-0000add0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000ade0: 2020 2020 2020 6966 2063 616c 6c61 626c        if callabl
-0000adf0: 6528 6d65 7472 6963 5f63 616c 6c62 6163  e(metric_callbac
-0000ae00: 6b73 293a 0a20 2020 2020 2020 2020 2020  ks):.           
-0000ae10: 2020 2020 206d 6574 7269 635f 7661 6c75       metric_valu
-0000ae20: 6573 203d 2061 6c6c 6f63 6174 655f 6172  es = allocate_ar
-0000ae30: 7261 7928 286c 656e 2872 6574 7269 6576  ray((len(retriev
-0000ae40: 655f 6368 616e 6e65 6c73 292c 206c 656e  e_channels), len
-0000ae50: 2863 6f6e 6469 7469 6f6e 735f 6f6e 7365  (conditions_onse
-0000ae60: 7473 2929 290a 2020 2020 2020 2020 2020  ts))).          
-0000ae70: 2020 656c 6966 2074 7970 6528 6d65 7472    elif type(metr
-0000ae80: 6963 5f63 616c 6c62 6163 6b73 2920 6973  ic_callbacks) is
-0000ae90: 2074 7570 6c65 2061 6e64 206c 656e 286d   tuple and len(m
-0000aea0: 6574 7269 635f 6361 6c6c 6261 636b 7329  etric_callbacks)
-0000aeb0: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-0000aec0: 2020 2020 2020 6d65 7472 6963 5f76 616c        metric_val
-0000aed0: 7565 7320 3d20 616c 6c6f 6361 7465 5f61  ues = allocate_a
-0000aee0: 7272 6179 2828 6c65 6e28 7265 7472 6965  rray((len(retrie
-0000aef0: 7665 5f63 6861 6e6e 656c 7329 2c20 6c65  ve_channels), le
-0000af00: 6e28 636f 6e64 6974 696f 6e73 5f6f 6e73  n(conditions_ons
-0000af10: 6574 7329 2c20 6c65 6e28 6d65 7472 6963  ets), len(metric
-0000af20: 5f63 616c 6c62 6163 6b73 2929 290a 2020  _callbacks))).  
-0000af30: 2020 6578 6365 7074 204d 656d 6f72 7945    except MemoryE
-0000af40: 7272 6f72 3a0a 2020 2020 2020 2020 7261  rror:.        ra
-0000af50: 6973 6520 4d65 6d6f 7279 4572 726f 7228  ise MemoryError(
-0000af60: 274e 6f74 2065 6e6f 7567 6820 6d65 6d6f  'Not enough memo
-0000af70: 7279 2063 7265 6174 6520 6d65 7472 6963  ry create metric
-0000af80: 206f 7574 7075 7420 6d61 7472 6978 2729   output matrix')
-0000af90: 0a0a 2020 2020 2320 6372 6561 7465 2070  ..    # create p
-0000afa0: 726f 6772 6573 7320 6261 720a 2020 2020  rogress bar.    
-0000afb0: 7072 696e 745f 7072 6f67 7265 7373 6261  print_progressba
-0000afc0: 7228 302c 206c 656e 2863 6f6e 6469 7469  r(0, len(conditi
-0000afd0: 6f6e 735f 6f6e 7365 7473 292c 2070 7265  ons_onsets), pre
-0000afe0: 6669 783d 2750 726f 6772 6573 733a 272c  fix='Progress:',
-0000aff0: 2073 7566 6669 783d 2743 6f6d 706c 6574   suffix='Complet
-0000b000: 6527 2c20 6c65 6e67 7468 3d35 3029 0a0a  e', length=50)..
-0000b010: 2020 2020 2320 6c6f 6f70 2074 6872 6f75      # loop throu
-0000b020: 6768 2074 6865 2063 6f6e 6469 7469 6f6e  gh the condition
-0000b030: 730a 2020 2020 666f 7220 636f 6e64 6974  s.    for condit
-0000b040: 696f 6e5f 6964 7820 696e 2072 616e 6765  ion_idx in range
-0000b050: 286c 656e 2863 6f6e 6469 7469 6f6e 735f  (len(conditions_
-0000b060: 6f6e 7365 7473 2929 3a0a 0a20 2020 2020  onsets)):..     
-0000b070: 2020 2023 2069 6e69 7469 616c 697a 6520     # initialize 
-0000b080: 6120 6275 6666 6572 2074 6f20 7075 7420  a buffer to put 
-0000b090: 616c 6c20 7468 6520 6461 7461 2066 6f72  all the data for
-0000b0a0: 2074 6869 7320 636f 6e64 6974 696f 6e20   this condition 
-0000b0b0: 696e 2028 6368 616e 6e65 6c73 2078 2074  in (channels x t
-0000b0c0: 7269 616c 7320 7820 7361 6d70 6c65 7329  rials x samples)
-0000b0d0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000b0e0: 2020 2020 2020 2020 2020 636f 6e64 6974            condit
-0000b0f0: 696f 6e5f 6461 7461 203d 2061 6c6c 6f63  ion_data = alloc
-0000b100: 6174 655f 6172 7261 7928 286c 656e 2872  ate_array((len(r
-0000b110: 6574 7269 6576 655f 6368 616e 6e65 6c73  etrieve_channels
-0000b120: 292c 206c 656e 2863 6f6e 6469 7469 6f6e  ), len(condition
-0000b130: 735f 6f6e 7365 7473 5b63 6f6e 6469 7469  s_onsets[conditi
-0000b140: 6f6e 5f69 6478 5d29 2c20 7472 6961 6c5f  on_idx]), trial_
-0000b150: 6e75 6d5f 7361 6d70 6c65 7329 290a 2020  num_samples)).  
-0000b160: 2020 2020 2020 6578 6365 7074 204d 656d        except Mem
-0000b170: 6f72 7945 7272 6f72 3a0a 2020 2020 2020  oryError:.      
-0000b180: 2020 2020 2020 7261 6973 6520 4d65 6d6f        raise Memo
-0000b190: 7279 4572 726f 7228 274e 6f74 2065 6e6f  ryError('Not eno
-0000b1a0: 7567 6820 6d65 6d6f 7279 2063 7265 6174  ugh memory creat
-0000b1b0: 6520 616e 2063 6f6e 6469 7469 6f6e 2d64  e an condition-d
-0000b1c0: 6174 6120 6d61 7472 6978 2729 0a0a 2020  ata matrix')..  
-0000b1d0: 2020 2020 2020 2320 6966 2062 6173 656c        # if basel
-0000b1e0: 696e 6520 6e6f 726d 616c 697a 6174 696f  ine normalizatio
-0000b1f0: 6e20 6973 206e 6565 6465 6420 616e 6420  n is needed and 
-0000b200: 7468 6520 7072 652d 6176 6572 6167 6520  the pre-average 
-0000b210: 6361 6c6c 6261 636b 2066 756e 6374 696f  callback functio
-0000b220: 6e20 6973 2064 6566 696e 6564 2c20 7468  n is defined, th
-0000b230: 656e 2077 6520 6669 7273 7420 6e65 6564  en we first need
-0000b240: 0a20 2020 2020 2020 2023 2074 6f20 6163  .        # to ac
-0000b250: 6375 6d75 6c61 7465 2074 6865 2066 756c  cumulate the ful
-0000b260: 6c20 2869 2e65 2e20 6368 616e 6e65 6c73  l (i.e. channels
-0000b270: 2078 2074 7269 616c 7320 7820 7361 6d70   x trials x samp
-0000b280: 6c65 7329 2075 6e2d 6e6f 726d 616c 697a  les) un-normaliz
-0000b290: 6564 2073 7562 7365 7420 746f 2070 726f  ed subset to pro
-0000b2a0: 7669 6465 2074 6f20 7468 6520 6675 6e63  vide to the func
-0000b2b0: 7469 6f6e 2e0a 2020 2020 2020 2020 2320  tion..        # 
-0000b2c0: 5468 6572 6566 6f72 652c 2077 6520 696e  Therefore, we in
-0000b2d0: 6974 6961 6c69 7a65 2061 6e20 6172 7261  itialize an arra
-0000b2e0: 7920 746f 2073 746f 7265 2074 6865 2062  y to store the b
-0000b2f0: 6173 656c 696e 6520 7661 6c75 6573 2066  aseline values f
-0000b300: 6f72 2065 6163 6820 6368 616e 6e65 6c20  or each channel 
-0000b310: 7820 7472 6961 6c2c 2073 6f20 7765 2063  x trial, so we c
-0000b320: 616e 206e 6f72 6d61 6c69 7a65 0a20 2020  an normalize.   
-0000b330: 2020 2020 2023 2061 6674 6572 2074 6865       # after the
-0000b340: 2063 616c 6c62 6163 6b0a 2020 2020 2020   callback.      
-0000b350: 2020 6261 7365 6c69 6e65 5f64 6174 6120    baseline_data 
-0000b360: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
-0000b370: 6620 6e6f 7420 6261 7365 6c69 6e65 5f6d  f not baseline_m
-0000b380: 6574 686f 6420 3d3d 2030 2061 6e64 206d  ethod == 0 and m
-0000b390: 6574 7269 635f 6361 6c6c 6261 636b 7320  etric_callbacks 
-0000b3a0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0000b3b0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0000b3c0: 2020 2020 2020 2020 2020 2020 2020 6261                ba
-0000b3d0: 7365 6c69 6e65 5f64 6174 6120 3d20 616c  seline_data = al
-0000b3e0: 6c6f 6361 7465 5f61 7272 6179 2828 6c65  locate_array((le
-0000b3f0: 6e28 7265 7472 6965 7665 5f63 6861 6e6e  n(retrieve_chann
-0000b400: 656c 7329 2c20 6c65 6e28 636f 6e64 6974  els), len(condit
-0000b410: 696f 6e73 5f6f 6e73 6574 735b 636f 6e64  ions_onsets[cond
-0000b420: 6974 696f 6e5f 6964 785d 292c 2062 6173  ition_idx]), bas
-0000b430: 656c 696e 655f 6e75 6d5f 7361 6d70 6c65  eline_num_sample
-0000b440: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
-0000b450: 6578 6365 7074 204d 656d 6f72 7945 7272  except MemoryErr
-0000b460: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0000b470: 2020 2020 7261 6973 6520 4d65 6d6f 7279      raise Memory
-0000b480: 4572 726f 7228 274e 6f74 2065 6e6f 7567  Error('Not enoug
-0000b490: 6820 6d65 6d6f 7279 2063 7265 6174 6520  h memory create 
-0000b4a0: 7465 6d70 6f72 6172 7920 6261 7365 6c69  temporary baseli
-0000b4b0: 6e65 2d64 6174 6120 6d61 7472 6978 2729  ne-data matrix')
-0000b4c0: 0a0a 2020 2020 2020 2020 2320 6c6f 6f70  ..        # loop
-0000b4d0: 2074 6872 6f75 6768 2074 6865 2074 7269   through the tri
-0000b4e0: 616c 7320 696e 2074 6865 2063 6f6e 6469  als in the condi
-0000b4f0: 7469 6f6e 0a20 2020 2020 2020 2066 6f72  tion.        for
-0000b500: 2074 7269 616c 5f69 6478 2069 6e20 7261   trial_idx in ra
-0000b510: 6e67 6528 6c65 6e28 636f 6e64 6974 696f  nge(len(conditio
-0000b520: 6e73 5f6f 6e73 6574 735b 636f 6e64 6974  ns_onsets[condit
-0000b530: 696f 6e5f 6964 785d 2929 3a0a 0a20 2020  ion_idx])):..   
-0000b540: 2020 2020 2020 2020 2023 2063 616c 6375           # calcu
-0000b550: 6c61 7465 2074 6865 2073 616d 706c 6520  late the sample 
-0000b560: 696e 6469 6365 730a 2020 2020 2020 2020  indices.        
-0000b570: 2020 2020 7472 6961 6c5f 7361 6d70 6c65      trial_sample
-0000b580: 5f73 7461 7274 203d 2069 6e74 2872 6f75  _start = int(rou
-0000b590: 6e64 2828 636f 6e64 6974 696f 6e73 5f6f  nd((conditions_o
-0000b5a0: 6e73 6574 735b 636f 6e64 6974 696f 6e5f  nsets[condition_
-0000b5b0: 6964 785d 5b74 7269 616c 5f69 6478 5d20  idx][trial_idx] 
-0000b5c0: 2b20 7472 6961 6c5f 6570 6f63 685b 305d  + trial_epoch[0]
-0000b5d0: 2920 2a20 6461 7461 5f72 6561 6465 722e  ) * data_reader.
-0000b5e0: 7361 6d70 6c69 6e67 5f72 6174 6529 290a  sampling_rate)).
-0000b5f0: 2020 2020 2020 2020 2020 2020 7472 6961              tria
-0000b600: 6c5f 7361 6d70 6c65 5f65 6e64 203d 2074  l_sample_end = t
-0000b610: 7269 616c 5f73 616d 706c 655f 7374 6172  rial_sample_star
-0000b620: 7420 2b20 7472 6961 6c5f 6e75 6d5f 7361  t + trial_num_sa
-0000b630: 6d70 6c65 730a 2020 2020 2020 2020 2020  mples.          
-0000b640: 2020 6261 7365 6c69 6e65 5f73 7461 7274    baseline_start
-0000b650: 5f73 616d 706c 6520 3d20 696e 7428 726f  _sample = int(ro
-0000b660: 756e 6428 2863 6f6e 6469 7469 6f6e 735f  und((conditions_
-0000b670: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
-0000b680: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
-0000b690: 202b 2062 6173 656c 696e 655f 6570 6f63   + baseline_epoc
-0000b6a0: 685b 305d 2920 2a20 6461 7461 5f72 6561  h[0]) * data_rea
-0000b6b0: 6465 722e 7361 6d70 6c69 6e67 5f72 6174  der.sampling_rat
-0000b6c0: 6529 2920 2d20 7472 6961 6c5f 7361 6d70  e)) - trial_samp
-0000b6d0: 6c65 5f73 7461 7274 0a20 2020 2020 2020  le_start.       
-0000b6e0: 2020 2020 2062 6173 656c 696e 655f 656e       baseline_en
-0000b6f0: 645f 7361 6d70 6c65 203d 2062 6173 656c  d_sample = basel
-0000b700: 696e 655f 7374 6172 745f 7361 6d70 6c65  ine_start_sample
-0000b710: 202b 2062 6173 656c 696e 655f 6e75 6d5f   + baseline_num_
-0000b720: 7361 6d70 6c65 730a 2020 2020 2020 2020  samples.        
-0000b730: 2020 2020 6c6f 6361 6c5f 7374 6172 7420      local_start 
-0000b740: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-0000b750: 6c6f 6361 6c5f 656e 6420 3d20 7472 6961  local_end = tria
-0000b760: 6c5f 6e75 6d5f 7361 6d70 6c65 730a 0a20  l_num_samples.. 
-0000b770: 2020 2020 2020 2020 2020 2023 2063 6865             # che
-0000b780: 636b 2077 6865 7468 6572 2074 6865 2074  ck whether the t
-0000b790: 7269 616c 2065 706f 6368 2069 7320 7769  rial epoch is wi
-0000b7a0: 7468 696e 2062 6f75 6e64 730a 2020 2020  thin bounds.    
-0000b7b0: 2020 2020 2020 2020 6966 2074 7269 616c          if trial
-0000b7c0: 5f73 616d 706c 655f 656e 6420 3c20 303a  _sample_end < 0:
-0000b7d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000b7e0: 2069 6620 286f 7574 5f6f 665f 626f 756e   if (out_of_boun
-0000b7f0: 645f 6d65 7468 6f64 203d 3d20 3120 616e  d_method == 1 an
-0000b800: 6420 636f 6e64 6974 696f 6e5f 6964 7820  d condition_idx 
-0000b810: 3d3d 2030 2061 6e64 2074 7269 616c 5f69  == 0 and trial_i
-0000b820: 6478 203d 3d20 3029 206f 7220 6f75 745f  dx == 0) or out_
-0000b830: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6420  of_bound_method 
-0000b840: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
-0000b850: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-0000b860: 672e 7761 726e 696e 6728 2743 616e 6e6f  g.warning('Canno
-0000b870: 7420 6578 7472 6163 7420 7468 6520 7472  t extract the tr
-0000b880: 6961 6c20 7769 7468 206f 6e73 6574 2027  ial with onset '
-0000b890: 202b 2073 7472 2863 6f6e 6469 7469 6f6e   + str(condition
-0000b8a0: 735f 6f6e 7365 7473 5b63 6f6e 6469 7469  s_onsets[conditi
-0000b8b0: 6f6e 5f69 6478 5d5b 7472 6961 6c5f 6964  on_idx][trial_id
-0000b8c0: 785d 2920 2b20 272c 2074 6865 2065 6e64  x]) + ', the end
-0000b8d0: 206f 6620 7468 6520 7472 6961 6c2d 6570   of the trial-ep
-0000b8e0: 6f63 6820 6c69 6573 2062 6566 6f72 6520  och lies before 
-0000b8f0: 7468 6520 7374 6172 7420 6f66 2074 6865  the start of the
-0000b900: 2064 6174 612d 7365 742e 2729 0a20 2020   data-set.').   
-0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b920: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0000b930: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b950: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
-0000b960: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
-0000b970: 7420 7468 6520 7472 6961 6c20 7769 7468  t the trial with
-0000b980: 206f 6e73 6574 2027 202b 2073 7472 2863   onset ' + str(c
-0000b990: 6f6e 6469 7469 6f6e 735f 6f6e 7365 7473  onditions_onsets
-0000b9a0: 5b63 6f6e 6469 7469 6f6e 5f69 6478 5d5b  [condition_idx][
-0000b9b0: 7472 6961 6c5f 6964 785d 2920 2b20 272c  trial_idx]) + ',
-0000b9c0: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
-0000b9d0: 7472 6961 6c2d 6570 6f63 6820 6c69 6573  trial-epoch lies
-0000b9e0: 2062 6566 6f72 6520 7468 6520 7374 6172   before the star
-0000b9f0: 7420 6f66 2074 6865 2064 6174 612d 7365  t of the data-se
-0000ba00: 742e 2055 7365 2061 2064 6966 6665 7265  t. Use a differe
-0000ba10: 6e74 206f 7574 5f6f 665f 626f 756e 645f  nt out_of_bound_
-0000ba20: 6861 6e64 6c69 6e67 2061 7267 756d 656e  handling argumen
-0000ba30: 7420 746f 2061 6c6c 6f77 206f 7574 2d6f  t to allow out-o
-0000ba40: 662d 626f 756e 6420 7472 6961 6c20 6570  f-bound trial ep
-0000ba50: 6f63 6873 2729 0a20 2020 2020 2020 2020  ochs').         
-0000ba60: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000ba70: 2052 756e 7469 6d65 4572 726f 7228 2743   RuntimeError('C
-0000ba80: 616e 6e6f 7420 6578 7472 6163 7420 7472  annot extract tr
-0000ba90: 6961 6c27 290a 2020 2020 2020 2020 2020  ial').          
-0000baa0: 2020 6966 2074 7269 616c 5f73 616d 706c    if trial_sampl
-0000bab0: 655f 7374 6172 7420 3c20 303a 0a20 2020  e_start < 0:.   
-0000bac0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000bad0: 286f 7574 5f6f 665f 626f 756e 645f 6d65  (out_of_bound_me
-0000bae0: 7468 6f64 203d 3d20 3120 616e 6420 636f  thod == 1 and co
-0000baf0: 6e64 6974 696f 6e5f 6964 7820 3d3d 2030  ndition_idx == 0
-0000bb00: 2061 6e64 2074 7269 616c 5f69 6478 203d   and trial_idx =
-0000bb10: 3d20 3029 206f 7220 6f75 745f 6f66 5f62  = 0) or out_of_b
-0000bb20: 6f75 6e64 5f6d 6574 686f 6420 3d3d 2032  ound_method == 2
-0000bb30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bb40: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
-0000bb50: 726e 696e 6728 2743 616e 6e6f 7420 6578  rning('Cannot ex
-0000bb60: 7472 6163 7420 7468 6520 7472 6961 6c20  tract the trial 
-0000bb70: 7769 7468 206f 6e73 6574 2027 202b 2073  with onset ' + s
-0000bb80: 7472 2863 6f6e 6469 7469 6f6e 735f 6f6e  tr(conditions_on
-0000bb90: 7365 7473 5b63 6f6e 6469 7469 6f6e 5f69  sets[condition_i
-0000bba0: 6478 5d5b 7472 6961 6c5f 6964 785d 2920  dx][trial_idx]) 
-0000bbb0: 2b20 272c 2074 6865 2073 7461 7274 206f  + ', the start o
-0000bbc0: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
-0000bbd0: 6820 6c69 6573 2062 6566 6f72 6520 7468  h lies before th
-0000bbe0: 6520 7374 6172 7420 6f66 2074 6865 2064  e start of the d
-0000bbf0: 6174 612d 7365 742e 2729 0a20 2020 2020  ata-set.').     
-0000bc00: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000bc10: 6f63 616c 5f73 7461 7274 203d 2074 7269  ocal_start = tri
-0000bc20: 616c 5f73 616d 706c 655f 7374 6172 7420  al_sample_start 
-0000bc30: 2a20 2d31 0a20 2020 2020 2020 2020 2020  * -1.           
-0000bc40: 2020 2020 2020 2020 2074 7269 616c 5f73           trial_s
-0000bc50: 616d 706c 655f 7374 6172 7420 3d20 300a  ample_start = 0.
-0000bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000bc80: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-0000bc90: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
-0000bca0: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
-0000bcb0: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
-0000bcc0: 2073 7472 2863 6f6e 6469 7469 6f6e 735f   str(conditions_
-0000bcd0: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
-0000bce0: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
-0000bcf0: 2920 2b20 272c 2074 6865 2073 7461 7274  ) + ', the start
-0000bd00: 206f 6620 7468 6520 7472 6961 6c2d 6570   of the trial-ep
-0000bd10: 6f63 6820 6c69 6573 2062 6566 6f72 6520  och lies before 
-0000bd20: 7468 6520 7374 6172 7420 6f66 2074 6865  the start of the
-0000bd30: 2064 6174 612d 7365 742e 2055 7365 2061   data-set. Use a
-0000bd40: 2064 6966 6665 7265 6e74 206f 7574 5f6f   different out_o
-0000bd50: 665f 626f 756e 645f 6861 6e64 6c69 6e67  f_bound_handling
-0000bd60: 2061 7267 756d 656e 7420 746f 2061 6c6c   argument to all
-0000bd70: 6f77 206f 7574 2d6f 662d 626f 756e 6420  ow out-of-bound 
-0000bd80: 7472 6961 6c20 6570 6f63 6873 2729 0a20  trial epochs'). 
-0000bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bda0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-0000bdb0: 4572 726f 7228 2743 616e 6e6f 7420 6578  Error('Cannot ex
-0000bdc0: 7472 6163 7420 7472 6961 6c27 290a 2020  tract trial').  
-0000bdd0: 2020 2020 2020 2020 2020 6966 2074 7269            if tri
-0000bde0: 616c 5f73 616d 706c 655f 7374 6172 7420  al_sample_start 
-0000bdf0: 3e20 6461 7461 5f72 6561 6465 722e 6e75  > data_reader.nu
-0000be00: 6d5f 7361 6d70 6c65 733a 0a20 2020 2020  m_samples:.     
-0000be10: 2020 2020 2020 2020 2020 2069 6620 286f             if (o
-0000be20: 7574 5f6f 665f 626f 756e 645f 6d65 7468  ut_of_bound_meth
-0000be30: 6f64 203d 3d20 3120 616e 6420 636f 6e64  od == 1 and cond
-0000be40: 6974 696f 6e5f 6964 7820 3d3d 206c 656e  ition_idx == len
-0000be50: 2863 6f6e 6469 7469 6f6e 735f 6f6e 7365  (conditions_onse
-0000be60: 7473 2920 2d20 3120 616e 6420 7472 6961  ts) - 1 and tria
-0000be70: 6c5f 6964 7820 3d3d 206c 656e 2863 6f6e  l_idx == len(con
-0000be80: 6469 7469 6f6e 735f 6f6e 7365 7473 5b63  ditions_onsets[c
-0000be90: 6f6e 6469 7469 6f6e 5f69 6478 5d29 202d  ondition_idx]) -
-0000bea0: 2031 2920 6f72 206f 7574 5f6f 665f 626f   1) or out_of_bo
-0000beb0: 756e 645f 6d65 7468 6f64 203d 3d20 323a  und_method == 2:
-0000bec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bed0: 2020 2020 206c 6f67 6769 6e67 2e77 6172       logging.war
-0000bee0: 6e69 6e67 2827 4361 6e6e 6f74 2065 7874  ning('Cannot ext
-0000bef0: 7261 6374 2074 6865 2074 7269 616c 2077  ract the trial w
-0000bf00: 6974 6820 6f6e 7365 7420 2720 2b20 7374  ith onset ' + st
-0000bf10: 7228 636f 6e64 6974 696f 6e73 5f6f 6e73  r(conditions_ons
-0000bf20: 6574 735b 636f 6e64 6974 696f 6e5f 6964  ets[condition_id
-0000bf30: 785d 5b74 7269 616c 5f69 6478 5d29 202b  x][trial_idx]) +
-0000bf40: 2027 2c20 7468 6520 7374 6172 7420 6f66   ', the start of
-0000bf50: 2074 6865 2074 7269 616c 2d65 706f 6368   the trial-epoch
-0000bf60: 206c 6965 7320 6166 7465 7220 7468 6520   lies after the 
-0000bf70: 656e 6420 6f66 2074 6865 2064 6174 612d  end of the data-
-0000bf80: 7365 742e 2729 0a20 2020 2020 2020 2020  set.').         
-0000bf90: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0000bfa0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-0000bfb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000bfc0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0000bfd0: 6767 696e 672e 6572 726f 7228 2743 616e  gging.error('Can
-0000bfe0: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
-0000bff0: 7472 6961 6c20 7769 7468 206f 6e73 6574  trial with onset
-0000c000: 2027 202b 2073 7472 2863 6f6e 6469 7469   ' + str(conditi
-0000c010: 6f6e 735f 6f6e 7365 7473 5b63 6f6e 6469  ons_onsets[condi
-0000c020: 7469 6f6e 5f69 6478 5d5b 7472 6961 6c5f  tion_idx][trial_
-0000c030: 6964 785d 2920 2b20 272c 2074 6865 2073  idx]) + ', the s
-0000c040: 7461 7274 206f 6620 7468 6520 7472 6961  tart of the tria
-0000c050: 6c2d 6570 6f63 6820 6c69 6573 2061 6674  l-epoch lies aft
-0000c060: 6572 2074 6865 2065 6e64 206f 6620 7468  er the end of th
-0000c070: 6520 6461 7461 2d73 6574 2e20 5573 6520  e data-set. Use 
-0000c080: 6120 6469 6666 6572 656e 7420 6f75 745f  a different out_
-0000c090: 6f66 5f62 6f75 6e64 5f68 616e 646c 696e  of_bound_handlin
-0000c0a0: 6720 6172 6775 6d65 6e74 2074 6f20 616c  g argument to al
-0000c0b0: 6c6f 7720 6f75 742d 6f66 2d62 6f75 6e64  low out-of-bound
-0000c0c0: 2074 7269 616c 2065 706f 6368 7327 290a   trial epochs').
-0000c0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c0e0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-0000c0f0: 6545 7272 6f72 2827 4361 6e6e 6f74 2065  eError('Cannot e
-0000c100: 7874 7261 6374 2074 7269 616c 2729 0a20  xtract trial'). 
-0000c110: 2020 2020 2020 2020 2020 2069 6620 7472             if tr
-0000c120: 6961 6c5f 7361 6d70 6c65 5f65 6e64 203e  ial_sample_end >
-0000c130: 2064 6174 615f 7265 6164 6572 2e6e 756d   data_reader.num
-0000c140: 5f73 616d 706c 6573 3a0a 2020 2020 2020  _samples:.      
-0000c150: 2020 2020 2020 2020 2020 6966 2028 6f75            if (ou
-0000c160: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
-0000c170: 6420 3d3d 2031 2061 6e64 2063 6f6e 6469  d == 1 and condi
-0000c180: 7469 6f6e 5f69 6478 203d 3d20 6c65 6e28  tion_idx == len(
-0000c190: 636f 6e64 6974 696f 6e73 5f6f 6e73 6574  conditions_onset
-0000c1a0: 7329 202d 2031 2061 6e64 2074 7269 616c  s) - 1 and trial
-0000c1b0: 5f69 6478 203d 3d20 6c65 6e28 636f 6e64  _idx == len(cond
-0000c1c0: 6974 696f 6e73 5f6f 6e73 6574 735b 636f  itions_onsets[co
-0000c1d0: 6e64 6974 696f 6e5f 6964 785d 2920 2d20  ndition_idx]) - 
-0000c1e0: 3129 206f 7220 6f75 745f 6f66 5f62 6f75  1) or out_of_bou
-0000c1f0: 6e64 5f6d 6574 686f 6420 3d3d 2032 3a0a  nd_method == 2:.
-0000c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c210: 2020 2020 6c6f 6767 696e 672e 7761 726e      logging.warn
-0000c220: 696e 6728 2743 616e 6e6f 7420 6578 7472  ing('Cannot extr
-0000c230: 6163 7420 7468 6520 7472 6961 6c20 7769  act the trial wi
-0000c240: 7468 206f 6e73 6574 2027 202b 2073 7472  th onset ' + str
-0000c250: 2863 6f6e 6469 7469 6f6e 735f 6f6e 7365  (conditions_onse
-0000c260: 7473 5b63 6f6e 6469 7469 6f6e 5f69 6478  ts[condition_idx
-0000c270: 5d5b 7472 6961 6c5f 6964 785d 2920 2b20  ][trial_idx]) + 
-0000c280: 272c 2074 6865 2065 6e64 206f 6620 7468  ', the end of th
-0000c290: 6520 7472 6961 6c2d 6570 6f63 6820 6c69  e trial-epoch li
-0000c2a0: 6573 2061 6674 6572 2074 6865 2065 6e64  es after the end
-0000c2b0: 206f 6620 7468 6520 6461 7461 2d73 6574   of the data-set
-0000c2c0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-0000c2d0: 2020 2020 2020 2020 6c6f 6361 6c5f 656e          local_en
-0000c2e0: 6420 3d20 7472 6961 6c5f 6e75 6d5f 7361  d = trial_num_sa
-0000c2f0: 6d70 6c65 7320 2d20 2874 7269 616c 5f73  mples - (trial_s
-0000c300: 616d 706c 655f 656e 6420 2d20 6461 7461  ample_end - data
-0000c310: 5f72 6561 6465 722e 6e75 6d5f 7361 6d70  _reader.num_samp
-0000c320: 6c65 7329 0a20 2020 2020 2020 2020 2020  les).           
-0000c330: 2020 2020 2020 2020 2074 7269 616c 5f73           trial_s
-0000c340: 616d 706c 655f 656e 6420 3d20 6461 7461  ample_end = data
-0000c350: 5f72 6561 6465 722e 6e75 6d5f 7361 6d70  _reader.num_samp
-0000c360: 6c65 730a 2020 2020 2020 2020 2020 2020  les.            
-0000c370: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000c380: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0000c390: 6767 696e 672e 6572 726f 7228 2743 616e  gging.error('Can
-0000c3a0: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
-0000c3b0: 7472 6961 6c20 7769 7468 206f 6e73 6574  trial with onset
-0000c3c0: 2027 202b 2073 7472 2863 6f6e 6469 7469   ' + str(conditi
-0000c3d0: 6f6e 735f 6f6e 7365 7473 5b63 6f6e 6469  ons_onsets[condi
-0000c3e0: 7469 6f6e 5f69 6478 5d5b 7472 6961 6c5f  tion_idx][trial_
-0000c3f0: 6964 785d 2920 2b20 272c 2074 6865 2065  idx]) + ', the e
-0000c400: 6e64 206f 6620 7468 6520 7472 6961 6c2d  nd of the trial-
-0000c410: 6570 6f63 6820 6c69 6573 2061 6674 6572  epoch lies after
-0000c420: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
-0000c430: 6461 7461 2d73 6574 2e20 5573 6520 6120  data-set. Use a 
-0000c440: 6469 6666 6572 656e 7420 6f75 745f 6f66  different out_of
-0000c450: 5f62 6f75 6e64 5f68 616e 646c 696e 6720  _bound_handling 
-0000c460: 6172 6775 6d65 6e74 2074 6f20 616c 6c6f  argument to allo
-0000c470: 7720 6f75 742d 6f66 2d62 6f75 6e64 2074  w out-of-bound t
-0000c480: 7269 616c 2065 706f 6368 7327 290a 2020  rial epochs').  
-0000c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c4a0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
-0000c4b0: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
-0000c4c0: 7261 6374 2074 7269 616c 2729 0a0a 2020  ract trial')..  
-0000c4d0: 2020 2020 2020 2020 2020 2320 6368 6563            # chec
-0000c4e0: 6b20 7768 6574 6865 7220 7468 6520 6261  k whether the ba
-0000c4f0: 7365 6c69 6e65 2069 7320 7769 7468 696e  seline is within
-0000c500: 2062 6f75 6e64 730a 2020 2020 2020 2020   bounds.        
-0000c510: 2020 2020 6966 2062 6173 656c 696e 655f      if baseline_
-0000c520: 6d65 7468 6f64 203e 2030 3a0a 2020 2020  method > 0:.    
-0000c530: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-0000c540: 6173 656c 696e 655f 7374 6172 745f 7361  aseline_start_sa
-0000c550: 6d70 6c65 203c 2030 3a0a 2020 2020 2020  mple < 0:.      
-0000c560: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0000c570: 6767 696e 672e 6572 726f 7228 2743 616e  gging.error('Can
-0000c580: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
-0000c590: 6261 7365 6c69 6e65 2066 6f72 2074 6865  baseline for the
-0000c5a0: 2074 7269 616c 2077 6974 6820 6f6e 7365   trial with onse
-0000c5b0: 7420 2720 2b20 7374 7228 636f 6e64 6974  t ' + str(condit
-0000c5c0: 696f 6e73 5f6f 6e73 6574 735b 636f 6e64  ions_onsets[cond
-0000c5d0: 6974 696f 6e5f 6964 785d 5b74 7269 616c  ition_idx][trial
-0000c5e0: 5f69 6478 5d29 202b 2027 2c20 7468 6520  _idx]) + ', the 
-0000c5f0: 7374 6172 7420 6f66 2074 6865 2062 6173  start of the bas
-0000c600: 656c 696e 652d 6570 6f63 6820 6c69 6573  eline-epoch lies
-0000c610: 2062 6566 6f72 6520 7468 6520 7374 6172   before the star
-0000c620: 7420 6f66 2074 6865 2074 7269 616c 2d65  t of the trial-e
-0000c630: 706f 6368 2729 0a20 2020 2020 2020 2020  poch').         
-0000c640: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000c650: 2052 756e 7469 6d65 4572 726f 7228 2743   RuntimeError('C
-0000c660: 616e 6e6f 7420 6578 7472 6163 7420 6261  annot extract ba
-0000c670: 7365 6c69 6e65 2729 0a20 2020 2020 2020  seline').       
-0000c680: 2020 2020 2020 2020 2069 6620 6261 7365           if base
-0000c690: 6c69 6e65 5f65 6e64 5f73 616d 706c 6520  line_end_sample 
-0000c6a0: 3e20 7472 6961 6c5f 6e75 6d5f 7361 6d70  > trial_num_samp
-0000c6b0: 6c65 733a 0a20 2020 2020 2020 2020 2020  les:.           
-0000c6c0: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-0000c6d0: 2e65 7272 6f72 2827 4361 6e6e 6f74 2065  .error('Cannot e
-0000c6e0: 7874 7261 6374 2074 6865 2062 6173 656c  xtract the basel
-0000c6f0: 696e 6520 666f 7220 7468 6520 7472 6961  ine for the tria
-0000c700: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
-0000c710: 2073 7472 2863 6f6e 6469 7469 6f6e 735f   str(conditions_
-0000c720: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
-0000c730: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
-0000c740: 2920 2b20 272c 2074 6865 2065 6e64 206f  ) + ', the end o
-0000c750: 6620 7468 6520 6261 7365 6c69 6e65 2d65  f the baseline-e
-0000c760: 706f 6368 206c 6965 7320 6f75 7473 6964  poch lies outsid
-0000c770: 6520 6f66 2074 6865 2074 7269 616c 2d65  e of the trial-e
-0000c780: 706f 6368 2729 0a20 2020 2020 2020 2020  poch').         
-0000c790: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000c7a0: 2052 756e 7469 6d65 4572 726f 7228 2743   RuntimeError('C
-0000c7b0: 616e 6e6f 7420 6578 7472 6163 7420 6261  annot extract ba
-0000c7c0: 7365 6c69 6e65 2729 0a20 2020 2020 2020  seline').       
-0000c7d0: 2020 2020 2020 2020 2069 6620 6261 7365           if base
-0000c7e0: 6c69 6e65 5f73 7461 7274 5f73 616d 706c  line_start_sampl
-0000c7f0: 6520 3c20 6c6f 6361 6c5f 7374 6172 7420  e < local_start 
-0000c800: 6f72 2062 6173 656c 696e 655f 656e 645f  or baseline_end_
-0000c810: 7361 6d70 6c65 203e 206c 6f63 616c 5f65  sample > local_e
-0000c820: 6e64 3a0a 2020 2020 2020 2020 2020 2020  nd:.            
-0000c830: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0000c840: 6572 726f 7228 2743 616e 6e6f 7420 6578  error('Cannot ex
-0000c850: 7472 6163 7420 7468 6520 6261 7365 6c69  tract the baseli
-0000c860: 6e65 2066 6f72 2074 6865 2074 7269 616c  ne for the trial
-0000c870: 2077 6974 6820 6f6e 7365 7420 2720 2b20   with onset ' + 
-0000c880: 7374 7228 636f 6e64 6974 696f 6e73 5f6f  str(conditions_o
-0000c890: 6e73 6574 735b 636f 6e64 6974 696f 6e5f  nsets[condition_
-0000c8a0: 6964 785d 5b74 7269 616c 5f69 6478 5d29  idx][trial_idx])
-0000c8b0: 202b 2027 2c20 7468 6520 7261 6e67 6520   + ', the range 
-0000c8c0: 666f 7220 7468 6520 6261 7365 6c69 6e65  for the baseline
-0000c8d0: 206c 6965 7320 6f75 7473 6964 6520 6f66   lies outside of
-0000c8e0: 2074 6865 2074 7269 616c 2d65 706f 6368   the trial-epoch
-0000c8f0: 2062 6563 6175 7365 2074 6861 7420 7061   because that pa
-0000c900: 7274 206f 6620 7468 6520 7472 6961 6c2d  rt of the trial-
-0000c910: 6570 6f63 6820 7761 7320 6f75 742d 6f66  epoch was out-of
-0000c920: 2d62 6f75 6e64 7327 290a 2020 2020 2020  -bounds').      
-0000c930: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000c940: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-0000c950: 2827 4361 6e6e 6f74 2065 7874 7261 6374  ('Cannot extract
-0000c960: 2062 6173 656c 696e 6527 290a 0a20 2020   baseline')..   
-0000c970: 2020 2020 2020 2020 2023 206c 6f61 6420           # load 
-0000c980: 7468 6520 7472 6961 6c20 6461 7461 0a20  the trial data. 
-0000c990: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000c9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c9b0: 7472 6961 6c5f 6461 7461 203d 2064 6174  trial_data = dat
-0000c9c0: 615f 7265 6164 6572 2e72 6574 7269 6576  a_reader.retriev
-0000c9d0: 655f 7361 6d70 6c65 5f72 616e 6765 5f64  e_sample_range_d
-0000c9e0: 6174 6128 7265 7472 6965 7665 5f63 6861  ata(retrieve_cha
-0000c9f0: 6e6e 656c 732c 2074 7269 616c 5f73 616d  nnels, trial_sam
-0000ca00: 706c 655f 7374 6172 742c 2074 7269 616c  ple_start, trial
-0000ca10: 5f73 616d 706c 655f 656e 642c 2046 616c  _sample_end, Fal
-0000ca20: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
-0000ca30: 6578 6365 7074 2028 5275 6e74 696d 6545  except (RuntimeE
-0000ca40: 7272 6f72 2c20 4c6f 6f6b 7570 4572 726f  rror, LookupErro
-0000ca50: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-0000ca60: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
-0000ca70: 6545 7272 6f72 2827 436f 756c 6420 6e6f  eError('Could no
-0000ca80: 7420 6c6f 6164 2064 6174 6127 290a 0a20  t load data').. 
-0000ca90: 2020 2020 2020 2020 2020 2023 206c 6f6f             # loo
-0000caa0: 7020 7468 726f 7567 6820 7468 6520 6368  p through the ch
-0000cab0: 616e 6e65 6c73 0a20 2020 2020 2020 2020  annels.         
-0000cac0: 2020 2066 6f72 2063 6861 6e6e 656c 5f69     for channel_i
-0000cad0: 6478 2069 6e20 7261 6e67 6528 6c65 6e28  dx in range(len(
-0000cae0: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
-0000caf0: 7329 293a 0a0a 2020 2020 2020 2020 2020  s)):..          
-0000cb00: 2020 2020 2020 2320 6578 7472 6163 7420        # extract 
-0000cb10: 7468 6520 7472 6961 6c20 6461 7461 2061  the trial data a
-0000cb20: 6e64 2070 6572 666f 726d 2062 6173 656c  nd perform basel
-0000cb30: 696e 6520 6e6f 726d 616c 697a 6174 696f  ine normalizatio
-0000cb40: 6e20 6f6e 2074 6865 2074 7269 616c 2069  n on the trial i
-0000cb50: 6620 6e65 6564 6564 0a20 2020 2020 2020  f needed.       
-0000cb60: 2020 2020 2020 2020 2023 0a20 2020 2020           #.     
-0000cb70: 2020 2020 2020 2020 2020 2023 2065 7863             # exc
-0000cb80: 6570 7420 7768 656e 2074 6865 7265 2069  ept when there i
-0000cb90: 7320 6120 6675 6e63 7469 6f6e 2063 616c  s a function cal
-0000cba0: 6c62 6163 6b2e 2057 6865 6e20 6120 6361  lback. When a ca
-0000cbb0: 6c6c 6261 636b 2069 7320 7468 656e 2077  llback is then w
-0000cbc0: 6520 6e65 6564 2074 6f20 6669 7273 7420  e need to first 
-0000cbd0: 6163 6375 6d75 6c61 7465 2074 6865 0a20  accumulate the. 
-0000cbe0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000cbf0: 2066 756c 6c20 2869 2e65 2e20 6368 616e   full (i.e. chan
-0000cc00: 6e65 6c73 2078 2074 7269 616c 7320 7820  nels x trials x 
-0000cc10: 6570 6f63 6829 2075 6e2d 6e6f 726d 616c  epoch) un-normal
-0000cc20: 697a 6564 2073 7562 7365 7420 746f 2070  ized subset to p
-0000cc30: 726f 7669 6465 2074 6f20 7468 6520 6675  rovide to the fu
-0000cc40: 6e63 7469 6f6e 2c20 616e 6420 7374 6f72  nction, and stor
-0000cc50: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0000cc60: 2020 2320 7468 6520 6261 7365 6c69 6e65    # the baseline
-0000cc70: 2076 616c 7565 7320 696e 2061 2073 6570   values in a sep
-0000cc80: 6172 6174 6520 6172 7261 792c 2073 6f20  arate array, so 
-0000cc90: 7468 6579 2063 616e 2062 6520 6170 706c  they can be appl
-0000cca0: 6965 6420 6c61 7465 720a 2020 2020 2020  ied later.      
-0000ccb0: 2020 2020 2020 2020 2020 230a 2020 2020            #.    
-0000ccc0: 2020 2020 2020 2020 2020 2020 6966 2062              if b
-0000ccd0: 6173 656c 696e 655f 6d65 7468 6f64 203d  aseline_method =
-0000cce0: 3d20 3020 6f72 206d 6574 7269 635f 6361  = 0 or metric_ca
-0000ccf0: 6c6c 6261 636b 7320 6973 206e 6f74 204e  llbacks is not N
-0000cd00: 6f6e 653a 0a0a 2020 2020 2020 2020 2020  one:..          
-0000cd10: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-0000cd20: 3a20 6e6f 7420 7265 6c65 7661 6e74 2077  : not relevant w
-0000cd30: 6865 7468 6572 2074 6869 7320 6973 2061  hether this is a
-0000cd40: 206e 756d 7079 2d76 6965 7720 6f72 206e   numpy-view or n
-0000cd50: 6f74 2c20 7369 6e63 6520 7765 2077 696c  ot, since we wil
-0000cd60: 6c20 6176 6572 6167 6520 6f76 6572 2074  l average over t
-0000cd70: 6865 2074 7269 616c 730a 2020 2020 2020  he trials.      
-0000cd80: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000cd90: 2020 2020 2020 6c61 7465 722e 2041 7373        later. Ass
-0000cda0: 756d 6520 6d65 7472 6963 5f63 616c 6c62  ume metric_callb
-0000cdb0: 6163 6b20 646f 6573 206e 6f74 206d 616e  ack does not man
-0000cdc0: 6970 756c 6174 6520 7468 6520 6461 7461  ipulate the data
-0000cdd0: 2069 7420 6973 2067 6976 656e 0a20 2020   it is given.   
-0000cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cdf0: 2063 6f6e 6469 7469 6f6e 5f64 6174 615b   condition_data[
-0000ce00: 6368 616e 6e65 6c5f 6964 782c 2074 7269  channel_idx, tri
-0000ce10: 616c 5f69 6478 2c20 6c6f 6361 6c5f 7374  al_idx, local_st
-0000ce20: 6172 743a 6c6f 6361 6c5f 656e 645d 203d  art:local_end] =
-0000ce30: 2074 7269 616c 5f64 6174 615b 6368 616e   trial_data[chan
-0000ce40: 6e65 6c5f 6964 785d 0a0a 2020 2020 2020  nel_idx]..      
-0000ce50: 2020 2020 2020 2020 2020 6966 2062 6173            if bas
-0000ce60: 656c 696e 655f 6d65 7468 6f64 203d 3d20  eline_method == 
-0000ce70: 313a 0a0a 2020 2020 2020 2020 2020 2020  1:..            
-0000ce80: 2020 2020 2020 2020 6966 206d 6574 7269          if metri
-0000ce90: 635f 6361 6c6c 6261 636b 7320 6973 204e  c_callbacks is N
-0000cea0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000ceb0: 2020 2020 2020 2020 2020 2020 2023 206e               # n
-0000cec0: 6f20 6361 6c6c 6261 636b 2c20 6e6f 726d  o callback, norm
-0000ced0: 616c 697a 6520 616e 6420 7374 6f72 6520  alize and store 
-0000cee0: 7468 6520 7472 6961 6c20 6461 7461 2077  the trial data w
-0000cef0: 6974 6820 6261 7365 6c69 6e65 2061 7070  ith baseline app
-0000cf00: 6c69 6564 0a20 2020 2020 2020 2020 2020  lied.           
-0000cf10: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000cf20: 6469 7469 6f6e 5f64 6174 615b 6368 616e  dition_data[chan
-0000cf30: 6e65 6c5f 6964 782c 2074 7269 616c 5f69  nel_idx, trial_i
-0000cf40: 6478 2c20 6c6f 6361 6c5f 7374 6172 743a  dx, local_start:
-0000cf50: 6c6f 6361 6c5f 656e 645d 203d 2074 7269  local_end] = tri
-0000cf60: 616c 5f64 6174 615b 6368 616e 6e65 6c5f  al_data[channel_
-0000cf70: 6964 785d 202d 206e 702e 6e61 6e6d 6561  idx] - np.nanmea
-0000cf80: 6e28 7472 6961 6c5f 6461 7461 5b63 6861  n(trial_data[cha
-0000cf90: 6e6e 656c 5f69 6478 5d5b 6261 7365 6c69  nnel_idx][baseli
-0000cfa0: 6e65 5f73 7461 7274 5f73 616d 706c 653a  ne_start_sample:
-0000cfb0: 6261 7365 6c69 6e65 5f65 6e64 5f73 616d  baseline_end_sam
-0000cfc0: 706c 655d 290a 0a20 2020 2020 2020 2020  ple])..         
-0000cfd0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000cfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cff0: 2020 2020 2020 2020 2023 2063 616c 6c62           # callb
-0000d000: 6163 6b2c 2073 746f 7265 2074 6865 2062  ack, store the b
-0000d010: 6173 656c 696e 6520 7661 6c75 6573 2066  aseline values f
-0000d020: 6f72 206c 6174 6572 2075 7365 0a20 2020  or later use.   
-0000d030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d040: 2020 2020 2023 204e 6f74 653a 206e 6f74       # Note: not
-0000d050: 2072 656c 6576 616e 7420 7768 6574 6865   relevant whethe
-0000d060: 7220 7468 6973 2069 7320 6120 6e75 6d70  r this is a nump
-0000d070: 792d 7669 6577 206f 7220 6e6f 742c 2073  y-view or not, s
-0000d080: 696e 6365 2077 6520 7769 6c6c 2061 7665  ince we will ave
-0000d090: 7261 6765 206f 7665 7220 7468 6520 7472  rage over the tr
-0000d0a0: 6961 6c73 0a20 2020 2020 2020 2020 2020  ials.           
-0000d0b0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0000d0c0: 2020 2020 206c 6174 6572 2e20 4173 7375       later. Assu
-0000d0d0: 6d65 206d 6574 7269 635f 6361 6c6c 6261  me metric_callba
-0000d0e0: 636b 2064 6f65 7320 6e6f 7420 6d61 6e69  ck does not mani
-0000d0f0: 7075 6c61 7465 2074 6865 2064 6174 6120  pulate the data 
-0000d100: 6974 2069 7320 6769 7665 6e0a 2020 2020  it is given.    
-0000d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d120: 2020 2020 6261 7365 6c69 6e65 5f64 6174      baseline_dat
-0000d130: 615b 6368 616e 6e65 6c5f 6964 782c 2074  a[channel_idx, t
-0000d140: 7269 616c 5f69 6478 2c20 3a5d 203d 2074  rial_idx, :] = t
-0000d150: 7269 616c 5f64 6174 615b 6368 616e 6e65  rial_data[channe
-0000d160: 6c5f 6964 785d 5b62 6173 656c 696e 655f  l_idx][baseline_
-0000d170: 7374 6172 745f 7361 6d70 6c65 3a62 6173  start_sample:bas
-0000d180: 656c 696e 655f 656e 645f 7361 6d70 6c65  eline_end_sample
-0000d190: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
-0000d1a0: 2020 2065 6c69 6620 6261 7365 6c69 6e65     elif baseline
-0000d1b0: 5f6d 6574 686f 6420 3d3d 2032 3a0a 0a20  _method == 2:.. 
-0000d1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d1d0: 2020 2069 6620 6d65 7472 6963 5f63 616c     if metric_cal
-0000d1e0: 6c62 6163 6b73 2069 7320 4e6f 6e65 3a0a  lbacks is None:.
-0000d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d200: 2020 2020 2020 2020 2320 6e6f 2063 616c          # no cal
-0000d210: 6c62 6163 6b2c 206e 6f72 6d61 6c69 7a65  lback, normalize
-0000d220: 2061 6e64 2073 746f 7265 2074 6865 2074   and store the t
-0000d230: 7269 616c 2064 6174 6120 7769 7468 2062  rial data with b
-0000d240: 6173 656c 696e 6520 6170 706c 6965 640a  aseline applied.
-0000d250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d260: 2020 2020 2020 2020 636f 6e64 6974 696f          conditio
-0000d270: 6e5f 6461 7461 5b63 6861 6e6e 656c 5f69  n_data[channel_i
-0000d280: 6478 2c20 7472 6961 6c5f 6964 782c 206c  dx, trial_idx, l
-0000d290: 6f63 616c 5f73 7461 7274 3a6c 6f63 616c  ocal_start:local
-0000d2a0: 5f65 6e64 5d20 3d20 7472 6961 6c5f 6461  _end] = trial_da
-0000d2b0: 7461 5b63 6861 6e6e 656c 5f69 6478 5d20  ta[channel_idx] 
-0000d2c0: 2d20 6e70 2e6e 616e 6d65 6469 616e 2874  - np.nanmedian(t
-0000d2d0: 7269 616c 5f64 6174 615b 6368 616e 6e65  rial_data[channe
-0000d2e0: 6c5f 6964 785d 5b62 6173 656c 696e 655f  l_idx][baseline_
-0000d2f0: 7374 6172 745f 7361 6d70 6c65 3a62 6173  start_sample:bas
-0000d300: 656c 696e 655f 656e 645f 7361 6d70 6c65  eline_end_sample
-0000d310: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-0000d320: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000d330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d340: 2020 2020 2020 2320 6361 6c6c 6261 636b        # callback
-0000d350: 2c20 7374 6f72 6520 7468 6520 6261 7365  , store the base
-0000d360: 6c69 6e65 2076 616c 7565 7320 666f 7220  line values for 
-0000d370: 6c61 7465 7220 7573 650a 2020 2020 2020  later use.      
-0000d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d390: 2020 2320 4e6f 7465 3a20 6e6f 7420 7265    # Note: not re
-0000d3a0: 6c65 7661 6e74 2077 6865 7468 6572 2074  levant whether t
-0000d3b0: 6869 7320 6973 2061 206e 756d 7079 2d76  his is a numpy-v
-0000d3c0: 6965 7720 6f72 206e 6f74 2c20 7369 6e63  iew or not, sinc
-0000d3d0: 6520 7765 2077 696c 6c20 6176 6572 6167  e we will averag
-0000d3e0: 6520 6f76 6572 2074 6865 2074 7269 616c  e over the trial
-0000d3f0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0000d400: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-0000d410: 2020 6c61 7465 722e 2041 7373 756d 6520    later. Assume 
-0000d420: 6d65 7472 6963 5f63 616c 6c62 6163 6b20  metric_callback 
-0000d430: 646f 6573 206e 6f74 206d 616e 6970 756c  does not manipul
-0000d440: 6174 6520 7468 6520 6461 7461 2069 7420  ate the data it 
-0000d450: 6973 2067 6976 656e 0a20 2020 2020 2020  is given.       
-0000d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d470: 2062 6173 656c 696e 655f 6461 7461 5b63   baseline_data[c
-0000d480: 6861 6e6e 656c 5f69 6478 2c20 7472 6961  hannel_idx, tria
-0000d490: 6c5f 6964 782c 203a 5d20 3d20 7472 6961  l_idx, :] = tria
-0000d4a0: 6c5f 6461 7461 5b63 6861 6e6e 656c 5f69  l_data[channel_i
-0000d4b0: 6478 5d5b 6261 7365 6c69 6e65 5f73 7461  dx][baseline_sta
-0000d4c0: 7274 5f73 616d 706c 653a 6261 7365 6c69  rt_sample:baseli
-0000d4d0: 6e65 5f65 6e64 5f73 616d 706c 655d 0a0a  ne_end_sample]..
-0000d4e0: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
-0000d4f0: 6966 2061 2070 7265 2d61 7665 7261 6769  if a pre-averagi
-0000d500: 6e67 2063 616c 6c62 6163 6b20 6675 6e63  ng callback func
-0000d510: 7469 6f6e 2069 7320 6465 6669 6e65 640a  tion is defined.
-0000d520: 2020 2020 2020 2020 6d65 7472 6963 203d          metric =
-0000d530: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-0000d540: 206d 6574 7269 635f 6361 6c6c 6261 636b   metric_callback
-0000d550: 7320 6973 206e 6f74 204e 6f6e 653a 0a0a  s is not None:..
-0000d560: 2020 2020 2020 2020 2020 2020 2320 7065              # pe
-0000d570: 7220 6368 616e 6e65 6c2c 2070 6173 7320  r channel, pass 
-0000d580: 7468 6520 7472 6961 6c73 2078 2065 706f  the trials x epo
-0000d590: 6368 2075 6e2d 6e6f 726d 616c 697a 6564  ch un-normalized
-0000d5a0: 2073 7562 7365 7420 746f 2074 6865 2063   subset to the c
-0000d5b0: 616c 6c62 6163 6b20 6675 6e63 7469 6f6e  allback function
-0000d5c0: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-0000d5d0: 6e64 2072 6574 7269 6576 6520 7468 6520  nd retrieve the 
-0000d5e0: 7265 7375 6c74 0a20 2020 2020 2020 2020  result.         
-0000d5f0: 2020 2066 6f72 2063 6861 6e6e 656c 5f69     for channel_i
-0000d600: 6478 2069 6e20 7261 6e67 6528 6c65 6e28  dx in range(len(
-0000d610: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
-0000d620: 7329 293a 0a0a 2020 2020 2020 2020 2020  s)):..          
-0000d630: 2020 2020 2020 6966 2063 616c 6c61 626c        if callabl
-0000d640: 6528 6d65 7472 6963 5f63 616c 6c62 6163  e(metric_callbac
-0000d650: 6b73 293a 0a0a 2020 2020 2020 2020 2020  ks):..          
-0000d660: 2020 2020 2020 2020 2020 2320 7061 7373            # pass
-0000d670: 2074 6865 2074 7269 616c 7320 7820 7469   the trials x ti
-0000d680: 6d65 2075 6e2d 6e6f 726d 616c 697a 6564  me un-normalized
-0000d690: 2073 7562 7365 7420 746f 2074 6865 2063   subset to the c
-0000d6a0: 616c 6c62 6163 6b20 6675 6e63 7469 6f6e  allback function
-0000d6b0: 2873 2920 616e 6420 7374 6f72 6520 7468  (s) and store th
-0000d6c0: 6520 7265 7375 6c74 0a20 2020 2020 2020  e result.       
-0000d6d0: 2020 2020 2020 2020 2020 2020 206d 6574               met
-0000d6e0: 7269 635f 7661 6c75 6520 3d20 6d65 7472  ric_value = metr
-0000d6f0: 6963 5f63 616c 6c62 6163 6b73 2864 6174  ic_callbacks(dat
-0000d700: 615f 7265 6164 6572 2e73 616d 706c 696e  a_reader.samplin
-0000d710: 675f 7261 7465 2c0a 2020 2020 2020 2020  g_rate,.        
-0000d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d740: 2020 2020 2020 2020 2020 2020 636f 6e64              cond
-0000d750: 6974 696f 6e5f 6461 7461 5b63 6861 6e6e  ition_data[chann
-0000d760: 656c 5f69 6478 2c20 3a2c 203a 5d2c 0a20  el_idx, :, :],. 
-0000d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a770: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000a780: 6e64 6974 696f 6e73 5f6f 6e73 6574 732c  nditions_onsets,
+0000a790: 2074 7269 616c 5f65 706f 6368 2c0a 2020   trial_epoch,.  
+0000a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7d0: 2062 6173 656c 696e 655f 6d65 7468 6f64   baseline_method
+0000a7e0: 2c20 6261 7365 6c69 6e65 5f65 706f 6368  , baseline_epoch
+0000a7f0: 2c20 6f75 745f 6f66 5f62 6f75 6e64 5f6d  , out_of_bound_m
+0000a800: 6574 686f 642c 206d 6574 7269 635f 6361  ethod, metric_ca
+0000a810: 6c6c 6261 636b 7329 3a0a 2020 2020 2222  llbacks):.    ""
+0000a820: 220a 2020 2020 4c6f 6164 2064 6174 6120  ".    Load data 
+0000a830: 6570 6f63 6820 6176 6572 6167 6573 2074  epoch averages t
+0000a840: 6f20 6120 6d61 7472 6978 2028 666f 726d  o a matrix (form
+0000a850: 6174 3a20 6368 616e 6e65 6c20 7820 636f  at: channel x co
+0000a860: 6e64 6974 696f 6e20 7820 7469 6d65 2920  ndition x time) 
+0000a870: 6279 206c 6f6f 7069 6e67 206f 7665 7220  by looping over 
+0000a880: 636f 6e64 6974 696f 6e73 2c20 6c6f 6f70  conditions, loop
+0000a890: 696e 6720 6f76 6572 0a20 2020 2074 6865  ing over.    the
+0000a8a0: 2074 7269 616c 7320 7769 7468 696e 2061   trials within a
+0000a8b0: 2063 6f6e 6469 7469 6f6e 2061 6e64 2074   condition and t
+0000a8c0: 6865 6e20 6c6f 6164 2074 6865 2064 6174  hen load the dat
+0000a8d0: 6120 7065 7220 636f 6e64 6974 696f 6e2d  a per condition-
+0000a8e0: 7472 6961 6c20 2866 6f72 2061 6c6c 2063  trial (for all c
+0000a8f0: 6861 6e6e 656c 7329 2061 6e64 2070 6572  hannels) and per
+0000a900: 666f 726d 0a20 2020 2061 7665 7261 6769  form.    averagi
+0000a910: 6e67 2028 616e 6420 6d65 7472 6963 2063  ng (and metric c
+0000a920: 616c 6375 6c61 7469 6f6e 2920 6279 2069  alculation) by i
+0000a930: 7465 7261 7469 6e67 206f 7665 7220 6561  terating over ea
+0000a940: 6368 206f 6620 7468 6520 6368 616e 6e65  ch of the channe
+0000a950: 6c73 0a0a 2020 2020 4e6f 7465 3a20 2020  ls..    Note:   
+0000a960: 466f 7220 4d45 4633 2074 6869 7320 6973  For MEF3 this is
+0000a970: 2074 6865 2066 6173 7465 7374 2073 6f6c   the fastest sol
+0000a980: 7574 696f 6e20 7768 696c 6520 7573 696e  ution while usin
+0000a990: 6720 6120 736d 616c 6c20 616d 6f75 6e74  g a small amount
+0000a9a0: 206f 6620 6d65 6d6f 7279 2028 6265 6361   of memory (beca
+0000a9b0: 7573 6520 6f6e 6c79 2074 6865 2072 6571  use only the req
+0000a9c0: 7569 7265 6420 6461 7461 0a20 2020 2020  uired data.     
+0000a9d0: 2020 2020 2020 2069 7320 6c6f 6164 6564         is loaded
+0000a9e0: 292e 2054 6865 2027 5f5f 6c6f 6164 5f64  ). The '__load_d
+0000a9f0: 6174 615f 6570 6f63 685f 6176 6572 6167  ata_epoch_averag
+0000aa00: 6573 5f5f 6279 5f63 6861 6e6e 656c 5f63  es__by_channel_c
+0000aa10: 6f6e 6469 7469 6f6e 5f74 7269 616c 2720  ondition_trial' 
+0000aa20: 6973 2065 7665 6e20 6d6f 7265 206d 656d  is even more mem
+0000aa30: 6f72 790a 2020 2020 2020 2020 2020 2020  ory.            
+0000aa40: 6566 6669 6369 656e 7420 6275 7420 736c  efficient but sl
+0000aa50: 6f77 6572 2066 6f72 204d 4546 332e 2046  ower for MEF3. F
+0000aa60: 6f72 2045 4446 2061 6e64 2042 7261 696e  or EDF and Brain
+0000aa70: 5669 7369 6f6e 2074 6865 7265 2069 7320  Vision there is 
+0000aa80: 6e6f 7420 6d75 6368 2064 6966 6665 7265  not much differe
+0000aa90: 6e63 6520 6265 6361 7573 6520 4d4e 4520  nce because MNE 
+0000aaa0: 7072 656c 6f61 6473 2074 6865 0a20 2020  preloads the.   
+0000aab0: 2020 2020 2020 2020 2077 686f 6c65 2073           whole s
+0000aac0: 6574 2074 6f20 6d65 6d6f 7279 2066 6972  et to memory fir
+0000aad0: 7374 2c20 736f 206a 7573 7420 6e75 6d70  st, so just nump
+0000aae0: 792d 7669 6577 7320 6172 6520 7265 7475  y-views are retu
+0000aaf0: 726e 6564 2061 6e64 2075 7365 642e 0a20  rned and used.. 
+0000ab00: 2020 204e 6f74 6532 3a20 206f 6e6c 7920     Note2:  only 
+0000ab10: 616e 206f 7074 696f 6e20 7768 656e 2061  an option when a
+0000ab20: 7420 6e6f 2070 6f69 6e74 2074 6865 2066  t no point the f
+0000ab30: 756c 6c20 6368 616e 6e65 6c20 6461 7461  ull channel data
+0000ab40: 2069 7320 6e65 6564 6564 2028 652e 672e   is needed (e.g.
+0000ab50: 2063 616e 6e6f 7420 6265 2075 7365 6420   cannot be used 
+0000ab60: 7768 656e 2068 6967 682d 7061 7373 2066  when high-pass f
+0000ab70: 696c 7465 7269 6e67 2069 7320 7265 7175  iltering is requ
+0000ab80: 6972 6564 290a 2020 2020 2222 220a 0a0a  ired).    """...
+0000ab90: 2020 2020 2320 6361 6c63 756c 6174 6520      # calculate 
+0000aba0: 7468 6520 7369 7a65 206f 6620 7468 6520  the size of the 
+0000abb0: 7469 6d65 2064 696d 656e 7369 6f6e 2028  time dimension (
+0000abc0: 696e 2073 616d 706c 6573 290a 2020 2020  in samples).    
+0000abd0: 7472 6961 6c5f 6e75 6d5f 7361 6d70 6c65  trial_num_sample
+0000abe0: 7320 3d20 696e 7428 726f 756e 6428 6162  s = int(round(ab
+0000abf0: 7328 7472 6961 6c5f 6570 6f63 685b 315d  s(trial_epoch[1]
+0000ac00: 202d 2074 7269 616c 5f65 706f 6368 5b30   - trial_epoch[0
+0000ac10: 5d29 202a 2064 6174 615f 7265 6164 6572  ]) * data_reader
+0000ac20: 2e73 616d 706c 696e 675f 7261 7465 2929  .sampling_rate))
+0000ac30: 0a20 2020 2062 6173 656c 696e 655f 6e75  .    baseline_nu
+0000ac40: 6d5f 7361 6d70 6c65 7320 3d20 696e 7428  m_samples = int(
+0000ac50: 726f 756e 6428 6162 7328 6261 7365 6c69  round(abs(baseli
+0000ac60: 6e65 5f65 706f 6368 5b31 5d20 2d20 6261  ne_epoch[1] - ba
+0000ac70: 7365 6c69 6e65 5f65 706f 6368 5b30 5d29  seline_epoch[0])
+0000ac80: 202a 2064 6174 615f 7265 6164 6572 2e73   * data_reader.s
+0000ac90: 616d 706c 696e 675f 7261 7465 2929 0a0a  ampling_rate))..
+0000aca0: 2020 2020 2320 696e 6974 6961 6c69 7a65      # initialize
+0000acb0: 2061 2064 6174 6120 6275 6666 6572 2028   a data buffer (
+0000acc0: 6368 616e 6e65 6c20 7820 636f 6e64 6974  channel x condit
+0000acd0: 696f 6e73 2078 2073 616d 706c 6573 290a  ions x samples).
+0000ace0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000acf0: 2064 6174 6120 3d20 616c 6c6f 6361 7465   data = allocate
+0000ad00: 5f61 7272 6179 2828 6c65 6e28 7265 7472  _array((len(retr
+0000ad10: 6965 7665 5f63 6861 6e6e 656c 7329 2c20  ieve_channels), 
+0000ad20: 6c65 6e28 636f 6e64 6974 696f 6e73 5f6f  len(conditions_o
+0000ad30: 6e73 6574 7329 2c20 7472 6961 6c5f 6e75  nsets), trial_nu
+0000ad40: 6d5f 7361 6d70 6c65 7329 290a 2020 2020  m_samples)).    
+0000ad50: 6578 6365 7074 204d 656d 6f72 7945 7272  except MemoryErr
+0000ad60: 6f72 3a0a 2020 2020 2020 2020 7261 6973  or:.        rais
+0000ad70: 6520 4d65 6d6f 7279 4572 726f 7228 274e  e MemoryError('N
+0000ad80: 6f74 2065 6e6f 7567 6820 6d65 6d6f 7279  ot enough memory
+0000ad90: 2063 7265 6174 6520 6120 6461 7461 206f   create a data o
+0000ada0: 7574 7075 7420 6d61 7472 6978 2729 0a0a  utput matrix')..
+0000adb0: 2020 2020 2320 696e 6974 6961 6c69 7a65      # initialize
+0000adc0: 2061 206d 6574 7269 6320 6275 6666 6572   a metric buffer
+0000add0: 2028 6368 616e 6e65 6c20 7820 636f 6e64   (channel x cond
+0000ade0: 6974 696f 6e73 2078 206d 6574 7269 6329  itions x metric)
+0000adf0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
+0000ae00: 2020 6d65 7472 6963 5f76 616c 7565 7320    metric_values 
+0000ae10: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
+0000ae20: 6620 6d65 7472 6963 5f63 616c 6c62 6163  f metric_callbac
+0000ae30: 6b73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ks is not None:.
+0000ae40: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0000ae50: 616c 6c61 626c 6528 6d65 7472 6963 5f63  allable(metric_c
+0000ae60: 616c 6c62 6163 6b73 293a 0a20 2020 2020  allbacks):.     
+0000ae70: 2020 2020 2020 2020 2020 206d 6574 7269             metri
+0000ae80: 635f 7661 6c75 6573 203d 2061 6c6c 6f63  c_values = alloc
+0000ae90: 6174 655f 6172 7261 7928 286c 656e 2872  ate_array((len(r
+0000aea0: 6574 7269 6576 655f 6368 616e 6e65 6c73  etrieve_channels
+0000aeb0: 292c 206c 656e 2863 6f6e 6469 7469 6f6e  ), len(condition
+0000aec0: 735f 6f6e 7365 7473 2929 290a 2020 2020  s_onsets))).    
+0000aed0: 2020 2020 2020 2020 656c 6966 2074 7970          elif typ
+0000aee0: 6528 6d65 7472 6963 5f63 616c 6c62 6163  e(metric_callbac
+0000aef0: 6b73 2920 6973 2074 7570 6c65 2061 6e64  ks) is tuple and
+0000af00: 206c 656e 286d 6574 7269 635f 6361 6c6c   len(metric_call
+0000af10: 6261 636b 7329 203e 2030 3a0a 2020 2020  backs) > 0:.    
+0000af20: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
+0000af30: 6963 5f76 616c 7565 7320 3d20 616c 6c6f  ic_values = allo
+0000af40: 6361 7465 5f61 7272 6179 2828 6c65 6e28  cate_array((len(
+0000af50: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
+0000af60: 7329 2c20 6c65 6e28 636f 6e64 6974 696f  s), len(conditio
+0000af70: 6e73 5f6f 6e73 6574 7329 2c20 6c65 6e28  ns_onsets), len(
+0000af80: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
+0000af90: 2929 290a 2020 2020 6578 6365 7074 204d  ))).    except M
+0000afa0: 656d 6f72 7945 7272 6f72 3a0a 2020 2020  emoryError:.    
+0000afb0: 2020 2020 7261 6973 6520 4d65 6d6f 7279      raise Memory
+0000afc0: 4572 726f 7228 274e 6f74 2065 6e6f 7567  Error('Not enoug
+0000afd0: 6820 6d65 6d6f 7279 2063 7265 6174 6520  h memory create 
+0000afe0: 6d65 7472 6963 206f 7574 7075 7420 6d61  metric output ma
+0000aff0: 7472 6978 2729 0a0a 2020 2020 2320 6372  trix')..    # cr
+0000b000: 6561 7465 2070 726f 6772 6573 7320 6261  eate progress ba
+0000b010: 720a 2020 2020 7072 696e 745f 7072 6f67  r.    print_prog
+0000b020: 7265 7373 6261 7228 302c 206c 656e 2863  ressbar(0, len(c
+0000b030: 6f6e 6469 7469 6f6e 735f 6f6e 7365 7473  onditions_onsets
+0000b040: 292c 2070 7265 6669 783d 2750 726f 6772  ), prefix='Progr
+0000b050: 6573 733a 272c 2073 7566 6669 783d 2743  ess:', suffix='C
+0000b060: 6f6d 706c 6574 6527 2c20 6c65 6e67 7468  omplete', length
+0000b070: 3d35 3029 0a0a 2020 2020 2320 6c6f 6f70  =50)..    # loop
+0000b080: 2074 6872 6f75 6768 2074 6865 2063 6f6e   through the con
+0000b090: 6469 7469 6f6e 730a 2020 2020 666f 7220  ditions.    for 
+0000b0a0: 636f 6e64 6974 696f 6e5f 6964 7820 696e  condition_idx in
+0000b0b0: 2072 616e 6765 286c 656e 2863 6f6e 6469   range(len(condi
+0000b0c0: 7469 6f6e 735f 6f6e 7365 7473 2929 3a0a  tions_onsets)):.
+0000b0d0: 0a20 2020 2020 2020 2023 2069 6e69 7469  .        # initi
+0000b0e0: 616c 697a 6520 6120 6275 6666 6572 2074  alize a buffer t
+0000b0f0: 6f20 7075 7420 616c 6c20 7468 6520 6461  o put all the da
+0000b100: 7461 2066 6f72 2074 6869 7320 636f 6e64  ta for this cond
+0000b110: 6974 696f 6e20 696e 2028 6368 616e 6e65  ition in (channe
+0000b120: 6c73 2078 2074 7269 616c 7320 7820 7361  ls x trials x sa
+0000b130: 6d70 6c65 7329 0a20 2020 2020 2020 2074  mples).        t
+0000b140: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000b150: 636f 6e64 6974 696f 6e5f 6461 7461 203d  condition_data =
+0000b160: 2061 6c6c 6f63 6174 655f 6172 7261 7928   allocate_array(
+0000b170: 286c 656e 2872 6574 7269 6576 655f 6368  (len(retrieve_ch
+0000b180: 616e 6e65 6c73 292c 206c 656e 2863 6f6e  annels), len(con
+0000b190: 6469 7469 6f6e 735f 6f6e 7365 7473 5b63  ditions_onsets[c
+0000b1a0: 6f6e 6469 7469 6f6e 5f69 6478 5d29 2c20  ondition_idx]), 
+0000b1b0: 7472 6961 6c5f 6e75 6d5f 7361 6d70 6c65  trial_num_sample
+0000b1c0: 7329 290a 2020 2020 2020 2020 6578 6365  s)).        exce
+0000b1d0: 7074 204d 656d 6f72 7945 7272 6f72 3a0a  pt MemoryError:.
+0000b1e0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000b1f0: 6520 4d65 6d6f 7279 4572 726f 7228 274e  e MemoryError('N
+0000b200: 6f74 2065 6e6f 7567 6820 6d65 6d6f 7279  ot enough memory
+0000b210: 2063 7265 6174 6520 616e 2063 6f6e 6469   create an condi
+0000b220: 7469 6f6e 2d64 6174 6120 6d61 7472 6978  tion-data matrix
+0000b230: 2729 0a0a 2020 2020 2020 2020 2320 6966  ')..        # if
+0000b240: 2062 6173 656c 696e 6520 6e6f 726d 616c   baseline normal
+0000b250: 697a 6174 696f 6e20 6973 206e 6565 6465  ization is neede
+0000b260: 6420 616e 6420 7468 6520 7072 652d 6176  d and the pre-av
+0000b270: 6572 6167 6520 6361 6c6c 6261 636b 2066  erage callback f
+0000b280: 756e 6374 696f 6e20 6973 2064 6566 696e  unction is defin
+0000b290: 6564 2c20 7468 656e 2077 6520 6669 7273  ed, then we firs
+0000b2a0: 7420 6e65 6564 0a20 2020 2020 2020 2023  t need.        #
+0000b2b0: 2074 6f20 6163 6375 6d75 6c61 7465 2074   to accumulate t
+0000b2c0: 6865 2066 756c 6c20 2869 2e65 2e20 6368  he full (i.e. ch
+0000b2d0: 616e 6e65 6c73 2078 2074 7269 616c 7320  annels x trials 
+0000b2e0: 7820 7361 6d70 6c65 7329 2075 6e2d 6e6f  x samples) un-no
+0000b2f0: 726d 616c 697a 6564 2073 7562 7365 7420  rmalized subset 
+0000b300: 746f 2070 726f 7669 6465 2074 6f20 7468  to provide to th
+0000b310: 6520 6675 6e63 7469 6f6e 2e0a 2020 2020  e function..    
+0000b320: 2020 2020 2320 5468 6572 6566 6f72 652c      # Therefore,
+0000b330: 2077 6520 696e 6974 6961 6c69 7a65 2061   we initialize a
+0000b340: 6e20 6172 7261 7920 746f 2073 746f 7265  n array to store
+0000b350: 2074 6865 2062 6173 656c 696e 6520 7661   the baseline va
+0000b360: 6c75 6573 2066 6f72 2065 6163 6820 6368  lues for each ch
+0000b370: 616e 6e65 6c20 7820 7472 6961 6c2c 2073  annel x trial, s
+0000b380: 6f20 7765 2063 616e 206e 6f72 6d61 6c69  o we can normali
+0000b390: 7a65 0a20 2020 2020 2020 2023 2061 6674  ze.        # aft
+0000b3a0: 6572 2074 6865 2063 616c 6c62 6163 6b0a  er the callback.
+0000b3b0: 2020 2020 2020 2020 6261 7365 6c69 6e65          baseline
+0000b3c0: 5f64 6174 6120 3d20 4e6f 6e65 0a20 2020  _data = None.   
+0000b3d0: 2020 2020 2069 6620 6e6f 7420 6261 7365       if not base
+0000b3e0: 6c69 6e65 5f6d 6574 686f 6420 3d3d 2030  line_method == 0
+0000b3f0: 2061 6e64 206d 6574 7269 635f 6361 6c6c   and metric_call
+0000b400: 6261 636b 7320 6973 206e 6f74 204e 6f6e  backs is not Non
+0000b410: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+0000b420: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000b430: 2020 2020 6261 7365 6c69 6e65 5f64 6174      baseline_dat
+0000b440: 6120 3d20 616c 6c6f 6361 7465 5f61 7272  a = allocate_arr
+0000b450: 6179 2828 6c65 6e28 7265 7472 6965 7665  ay((len(retrieve
+0000b460: 5f63 6861 6e6e 656c 7329 2c20 6c65 6e28  _channels), len(
+0000b470: 636f 6e64 6974 696f 6e73 5f6f 6e73 6574  conditions_onset
+0000b480: 735b 636f 6e64 6974 696f 6e5f 6964 785d  s[condition_idx]
+0000b490: 292c 2062 6173 656c 696e 655f 6e75 6d5f  ), baseline_num_
+0000b4a0: 7361 6d70 6c65 7329 290a 2020 2020 2020  samples)).      
+0000b4b0: 2020 2020 2020 6578 6365 7074 204d 656d        except Mem
+0000b4c0: 6f72 7945 7272 6f72 3a0a 2020 2020 2020  oryError:.      
+0000b4d0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000b4e0: 4d65 6d6f 7279 4572 726f 7228 274e 6f74  MemoryError('Not
+0000b4f0: 2065 6e6f 7567 6820 6d65 6d6f 7279 2063   enough memory c
+0000b500: 7265 6174 6520 7465 6d70 6f72 6172 7920  reate temporary 
+0000b510: 6261 7365 6c69 6e65 2d64 6174 6120 6d61  baseline-data ma
+0000b520: 7472 6978 2729 0a0a 2020 2020 2020 2020  trix')..        
+0000b530: 2320 6c6f 6f70 2074 6872 6f75 6768 2074  # loop through t
+0000b540: 6865 2074 7269 616c 7320 696e 2074 6865  he trials in the
+0000b550: 2063 6f6e 6469 7469 6f6e 0a20 2020 2020   condition.     
+0000b560: 2020 2066 6f72 2074 7269 616c 5f69 6478     for trial_idx
+0000b570: 2069 6e20 7261 6e67 6528 6c65 6e28 636f   in range(len(co
+0000b580: 6e64 6974 696f 6e73 5f6f 6e73 6574 735b  nditions_onsets[
+0000b590: 636f 6e64 6974 696f 6e5f 6964 785d 2929  condition_idx]))
+0000b5a0: 3a0a 0a20 2020 2020 2020 2020 2020 2023  :..            #
+0000b5b0: 2063 616c 6375 6c61 7465 2074 6865 2073   calculate the s
+0000b5c0: 616d 706c 6520 696e 6469 6365 730a 2020  ample indices.  
+0000b5d0: 2020 2020 2020 2020 2020 7472 6961 6c5f            trial_
+0000b5e0: 7361 6d70 6c65 5f73 7461 7274 203d 2069  sample_start = i
+0000b5f0: 6e74 2872 6f75 6e64 2828 636f 6e64 6974  nt(round((condit
+0000b600: 696f 6e73 5f6f 6e73 6574 735b 636f 6e64  ions_onsets[cond
+0000b610: 6974 696f 6e5f 6964 785d 5b74 7269 616c  ition_idx][trial
+0000b620: 5f69 6478 5d20 2b20 7472 6961 6c5f 6570  _idx] + trial_ep
+0000b630: 6f63 685b 305d 2920 2a20 6461 7461 5f72  och[0]) * data_r
+0000b640: 6561 6465 722e 7361 6d70 6c69 6e67 5f72  eader.sampling_r
+0000b650: 6174 6529 290a 2020 2020 2020 2020 2020  ate)).          
+0000b660: 2020 7472 6961 6c5f 7361 6d70 6c65 5f65    trial_sample_e
+0000b670: 6e64 203d 2074 7269 616c 5f73 616d 706c  nd = trial_sampl
+0000b680: 655f 7374 6172 7420 2b20 7472 6961 6c5f  e_start + trial_
+0000b690: 6e75 6d5f 7361 6d70 6c65 730a 2020 2020  num_samples.    
+0000b6a0: 2020 2020 2020 2020 6261 7365 6c69 6e65          baseline
+0000b6b0: 5f73 7461 7274 5f73 616d 706c 6520 3d20  _start_sample = 
+0000b6c0: 696e 7428 726f 756e 6428 2863 6f6e 6469  int(round((condi
+0000b6d0: 7469 6f6e 735f 6f6e 7365 7473 5b63 6f6e  tions_onsets[con
+0000b6e0: 6469 7469 6f6e 5f69 6478 5d5b 7472 6961  dition_idx][tria
+0000b6f0: 6c5f 6964 785d 202b 2062 6173 656c 696e  l_idx] + baselin
+0000b700: 655f 6570 6f63 685b 305d 2920 2a20 6461  e_epoch[0]) * da
+0000b710: 7461 5f72 6561 6465 722e 7361 6d70 6c69  ta_reader.sampli
+0000b720: 6e67 5f72 6174 6529 2920 2d20 7472 6961  ng_rate)) - tria
+0000b730: 6c5f 7361 6d70 6c65 5f73 7461 7274 0a20  l_sample_start. 
+0000b740: 2020 2020 2020 2020 2020 2062 6173 656c             basel
+0000b750: 696e 655f 656e 645f 7361 6d70 6c65 203d  ine_end_sample =
+0000b760: 2062 6173 656c 696e 655f 7374 6172 745f   baseline_start_
+0000b770: 7361 6d70 6c65 202b 2062 6173 656c 696e  sample + baselin
+0000b780: 655f 6e75 6d5f 7361 6d70 6c65 730a 2020  e_num_samples.  
+0000b790: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
+0000b7a0: 7374 6172 7420 3d20 300a 2020 2020 2020  start = 0.      
+0000b7b0: 2020 2020 2020 6c6f 6361 6c5f 656e 6420        local_end 
+0000b7c0: 3d20 7472 6961 6c5f 6e75 6d5f 7361 6d70  = trial_num_samp
+0000b7d0: 6c65 730a 0a20 2020 2020 2020 2020 2020  les..           
+0000b7e0: 2023 2063 6865 636b 2077 6865 7468 6572   # check whether
+0000b7f0: 2074 6865 2074 7269 616c 2065 706f 6368   the trial epoch
+0000b800: 2069 7320 7769 7468 696e 2062 6f75 6e64   is within bound
+0000b810: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+0000b820: 2074 7269 616c 5f73 616d 706c 655f 656e   trial_sample_en
+0000b830: 6420 3c20 303a 0a20 2020 2020 2020 2020  d < 0:.         
+0000b840: 2020 2020 2020 2069 6620 286f 7574 5f6f         if (out_o
+0000b850: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
+0000b860: 3d20 3120 616e 6420 636f 6e64 6974 696f  = 1 and conditio
+0000b870: 6e5f 6964 7820 3d3d 2030 2061 6e64 2074  n_idx == 0 and t
+0000b880: 7269 616c 5f69 6478 203d 3d20 3029 206f  rial_idx == 0) o
+0000b890: 7220 6f75 745f 6f66 5f62 6f75 6e64 5f6d  r out_of_bound_m
+0000b8a0: 6574 686f 6420 3d3d 2032 3a0a 2020 2020  ethod == 2:.    
+0000b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b8c0: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
+0000b8d0: 2743 616e 6e6f 7420 6578 7472 6163 7420  'Cannot extract 
+0000b8e0: 7468 6520 7472 6961 6c20 7769 7468 206f  the trial with o
+0000b8f0: 6e73 6574 2027 202b 2073 7472 2863 6f6e  nset ' + str(con
+0000b900: 6469 7469 6f6e 735f 6f6e 7365 7473 5b63  ditions_onsets[c
+0000b910: 6f6e 6469 7469 6f6e 5f69 6478 5d5b 7472  ondition_idx][tr
+0000b920: 6961 6c5f 6964 785d 2920 2b20 272c 2074  ial_idx]) + ', t
+0000b930: 6865 2065 6e64 206f 6620 7468 6520 7472  he end of the tr
+0000b940: 6961 6c2d 6570 6f63 6820 6c69 6573 2062  ial-epoch lies b
+0000b950: 6566 6f72 6520 7468 6520 7374 6172 7420  efore the start 
+0000b960: 6f66 2074 6865 2064 6174 612d 7365 742e  of the data-set.
+0000b970: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0000b980: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0000b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b9a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000b9b0: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+0000b9c0: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
+0000b9d0: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
+0000b9e0: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
+0000b9f0: 2073 7472 2863 6f6e 6469 7469 6f6e 735f   str(conditions_
+0000ba00: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
+0000ba10: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
+0000ba20: 2920 2b20 272c 2074 6865 2065 6e64 206f  ) + ', the end o
+0000ba30: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
+0000ba40: 6820 6c69 6573 2062 6566 6f72 6520 7468  h lies before th
+0000ba50: 6520 7374 6172 7420 6f66 2074 6865 2064  e start of the d
+0000ba60: 6174 612d 7365 742e 2055 7365 2061 2064  ata-set. Use a d
+0000ba70: 6966 6665 7265 6e74 206f 7574 5f6f 665f  ifferent out_of_
+0000ba80: 626f 756e 645f 6861 6e64 6c69 6e67 2061  bound_handling a
+0000ba90: 7267 756d 656e 7420 746f 2061 6c6c 6f77  rgument to allow
+0000baa0: 206f 7574 2d6f 662d 626f 756e 6420 7472   out-of-bound tr
+0000bab0: 6961 6c20 6570 6f63 6873 2729 0a20 2020  ial epochs').   
+0000bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bad0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0000bae0: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+0000baf0: 6163 7420 7472 6961 6c27 290a 2020 2020  act trial').    
+0000bb00: 2020 2020 2020 2020 6966 2074 7269 616c          if trial
+0000bb10: 5f73 616d 706c 655f 7374 6172 7420 3c20  _sample_start < 
+0000bb20: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0000bb30: 2020 2069 6620 286f 7574 5f6f 665f 626f     if (out_of_bo
+0000bb40: 756e 645f 6d65 7468 6f64 203d 3d20 3120  und_method == 1 
+0000bb50: 616e 6420 636f 6e64 6974 696f 6e5f 6964  and condition_id
+0000bb60: 7820 3d3d 2030 2061 6e64 2074 7269 616c  x == 0 and trial
+0000bb70: 5f69 6478 203d 3d20 3029 206f 7220 6f75  _idx == 0) or ou
+0000bb80: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
+0000bb90: 6420 3d3d 2032 3a0a 2020 2020 2020 2020  d == 2:.        
+0000bba0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000bbb0: 696e 672e 7761 726e 696e 6728 2743 616e  ing.warning('Can
+0000bbc0: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
+0000bbd0: 7472 6961 6c20 7769 7468 206f 6e73 6574  trial with onset
+0000bbe0: 2027 202b 2073 7472 2863 6f6e 6469 7469   ' + str(conditi
+0000bbf0: 6f6e 735f 6f6e 7365 7473 5b63 6f6e 6469  ons_onsets[condi
+0000bc00: 7469 6f6e 5f69 6478 5d5b 7472 6961 6c5f  tion_idx][trial_
+0000bc10: 6964 785d 2920 2b20 272c 2074 6865 2073  idx]) + ', the s
+0000bc20: 7461 7274 206f 6620 7468 6520 7472 6961  tart of the tria
+0000bc30: 6c2d 6570 6f63 6820 6c69 6573 2062 6566  l-epoch lies bef
+0000bc40: 6f72 6520 7468 6520 7374 6172 7420 6f66  ore the start of
+0000bc50: 2074 6865 2064 6174 612d 7365 742e 2729   the data-set.')
+0000bc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bc70: 2020 2020 206c 6f63 616c 5f73 7461 7274       local_start
+0000bc80: 203d 2074 7269 616c 5f73 616d 706c 655f   = trial_sample_
+0000bc90: 7374 6172 7420 2a20 2d31 0a20 2020 2020  start * -1.     
+0000bca0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000bcb0: 7269 616c 5f73 616d 706c 655f 7374 6172  rial_sample_star
+0000bcc0: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
+0000bcd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcf0: 6c6f 6767 696e 672e 6572 726f 7228 2743  logging.error('C
+0000bd00: 616e 6e6f 7420 6578 7472 6163 7420 7468  annot extract th
+0000bd10: 6520 7472 6961 6c20 7769 7468 206f 6e73  e trial with ons
+0000bd20: 6574 2027 202b 2073 7472 2863 6f6e 6469  et ' + str(condi
+0000bd30: 7469 6f6e 735f 6f6e 7365 7473 5b63 6f6e  tions_onsets[con
+0000bd40: 6469 7469 6f6e 5f69 6478 5d5b 7472 6961  dition_idx][tria
+0000bd50: 6c5f 6964 785d 2920 2b20 272c 2074 6865  l_idx]) + ', the
+0000bd60: 2073 7461 7274 206f 6620 7468 6520 7472   start of the tr
+0000bd70: 6961 6c2d 6570 6f63 6820 6c69 6573 2062  ial-epoch lies b
+0000bd80: 6566 6f72 6520 7468 6520 7374 6172 7420  efore the start 
+0000bd90: 6f66 2074 6865 2064 6174 612d 7365 742e  of the data-set.
+0000bda0: 2055 7365 2061 2064 6966 6665 7265 6e74   Use a different
+0000bdb0: 206f 7574 5f6f 665f 626f 756e 645f 6861   out_of_bound_ha
+0000bdc0: 6e64 6c69 6e67 2061 7267 756d 656e 7420  ndling argument 
+0000bdd0: 746f 2061 6c6c 6f77 206f 7574 2d6f 662d  to allow out-of-
+0000bde0: 626f 756e 6420 7472 6961 6c20 6570 6f63  bound trial epoc
+0000bdf0: 6873 2729 0a20 2020 2020 2020 2020 2020  hs').           
+0000be00: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+0000be10: 756e 7469 6d65 4572 726f 7228 2743 616e  untimeError('Can
+0000be20: 6e6f 7420 6578 7472 6163 7420 7472 6961  not extract tria
+0000be30: 6c27 290a 2020 2020 2020 2020 2020 2020  l').            
+0000be40: 6966 2074 7269 616c 5f73 616d 706c 655f  if trial_sample_
+0000be50: 7374 6172 7420 3e20 6461 7461 5f72 6561  start > data_rea
+0000be60: 6465 722e 6e75 6d5f 7361 6d70 6c65 733a  der.num_samples:
+0000be70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000be80: 2069 6620 286f 7574 5f6f 665f 626f 756e   if (out_of_boun
+0000be90: 645f 6d65 7468 6f64 203d 3d20 3120 616e  d_method == 1 an
+0000bea0: 6420 636f 6e64 6974 696f 6e5f 6964 7820  d condition_idx 
+0000beb0: 3d3d 206c 656e 2863 6f6e 6469 7469 6f6e  == len(condition
+0000bec0: 735f 6f6e 7365 7473 2920 2d20 3120 616e  s_onsets) - 1 an
+0000bed0: 6420 7472 6961 6c5f 6964 7820 3d3d 206c  d trial_idx == l
+0000bee0: 656e 2863 6f6e 6469 7469 6f6e 735f 6f6e  en(conditions_on
+0000bef0: 7365 7473 5b63 6f6e 6469 7469 6f6e 5f69  sets[condition_i
+0000bf00: 6478 5d29 202d 2031 2920 6f72 206f 7574  dx]) - 1) or out
+0000bf10: 5f6f 665f 626f 756e 645f 6d65 7468 6f64  _of_bound_method
+0000bf20: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+0000bf30: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0000bf40: 6e67 2e77 6172 6e69 6e67 2827 4361 6e6e  ng.warning('Cann
+0000bf50: 6f74 2065 7874 7261 6374 2074 6865 2074  ot extract the t
+0000bf60: 7269 616c 2077 6974 6820 6f6e 7365 7420  rial with onset 
+0000bf70: 2720 2b20 7374 7228 636f 6e64 6974 696f  ' + str(conditio
+0000bf80: 6e73 5f6f 6e73 6574 735b 636f 6e64 6974  ns_onsets[condit
+0000bf90: 696f 6e5f 6964 785d 5b74 7269 616c 5f69  ion_idx][trial_i
+0000bfa0: 6478 5d29 202b 2027 2c20 7468 6520 7374  dx]) + ', the st
+0000bfb0: 6172 7420 6f66 2074 6865 2074 7269 616c  art of the trial
+0000bfc0: 2d65 706f 6368 206c 6965 7320 6166 7465  -epoch lies afte
+0000bfd0: 7220 7468 6520 656e 6420 6f66 2074 6865  r the end of the
+0000bfe0: 2064 6174 612d 7365 742e 2729 0a20 2020   data-set.').   
+0000bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c000: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+0000c010: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c030: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
+0000c040: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
+0000c050: 7420 7468 6520 7472 6961 6c20 7769 7468  t the trial with
+0000c060: 206f 6e73 6574 2027 202b 2073 7472 2863   onset ' + str(c
+0000c070: 6f6e 6469 7469 6f6e 735f 6f6e 7365 7473  onditions_onsets
+0000c080: 5b63 6f6e 6469 7469 6f6e 5f69 6478 5d5b  [condition_idx][
+0000c090: 7472 6961 6c5f 6964 785d 2920 2b20 272c  trial_idx]) + ',
+0000c0a0: 2074 6865 2073 7461 7274 206f 6620 7468   the start of th
+0000c0b0: 6520 7472 6961 6c2d 6570 6f63 6820 6c69  e trial-epoch li
+0000c0c0: 6573 2061 6674 6572 2074 6865 2065 6e64  es after the end
+0000c0d0: 206f 6620 7468 6520 6461 7461 2d73 6574   of the data-set
+0000c0e0: 2e20 5573 6520 6120 6469 6666 6572 656e  . Use a differen
+0000c0f0: 7420 6f75 745f 6f66 5f62 6f75 6e64 5f68  t out_of_bound_h
+0000c100: 616e 646c 696e 6720 6172 6775 6d65 6e74  andling argument
+0000c110: 2074 6f20 616c 6c6f 7720 6f75 742d 6f66   to allow out-of
+0000c120: 2d62 6f75 6e64 2074 7269 616c 2065 706f  -bound trial epo
+0000c130: 6368 7327 290a 2020 2020 2020 2020 2020  chs').          
+0000c140: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0000c150: 5275 6e74 696d 6545 7272 6f72 2827 4361  RuntimeError('Ca
+0000c160: 6e6e 6f74 2065 7874 7261 6374 2074 7269  nnot extract tri
+0000c170: 616c 2729 0a20 2020 2020 2020 2020 2020  al').           
+0000c180: 2069 6620 7472 6961 6c5f 7361 6d70 6c65   if trial_sample
+0000c190: 5f65 6e64 203e 2064 6174 615f 7265 6164  _end > data_read
+0000c1a0: 6572 2e6e 756d 5f73 616d 706c 6573 3a0a  er.num_samples:.
+0000c1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c1c0: 6966 2028 6f75 745f 6f66 5f62 6f75 6e64  if (out_of_bound
+0000c1d0: 5f6d 6574 686f 6420 3d3d 2031 2061 6e64  _method == 1 and
+0000c1e0: 2063 6f6e 6469 7469 6f6e 5f69 6478 203d   condition_idx =
+0000c1f0: 3d20 6c65 6e28 636f 6e64 6974 696f 6e73  = len(conditions
+0000c200: 5f6f 6e73 6574 7329 202d 2031 2061 6e64  _onsets) - 1 and
+0000c210: 2074 7269 616c 5f69 6478 203d 3d20 6c65   trial_idx == le
+0000c220: 6e28 636f 6e64 6974 696f 6e73 5f6f 6e73  n(conditions_ons
+0000c230: 6574 735b 636f 6e64 6974 696f 6e5f 6964  ets[condition_id
+0000c240: 785d 2920 2d20 3129 206f 7220 6f75 745f  x]) - 1) or out_
+0000c250: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6420  of_bound_method 
+0000c260: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
+0000c270: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+0000c280: 672e 7761 726e 696e 6728 2743 616e 6e6f  g.warning('Canno
+0000c290: 7420 6578 7472 6163 7420 7468 6520 7472  t extract the tr
+0000c2a0: 6961 6c20 7769 7468 206f 6e73 6574 2027  ial with onset '
+0000c2b0: 202b 2073 7472 2863 6f6e 6469 7469 6f6e   + str(condition
+0000c2c0: 735f 6f6e 7365 7473 5b63 6f6e 6469 7469  s_onsets[conditi
+0000c2d0: 6f6e 5f69 6478 5d5b 7472 6961 6c5f 6964  on_idx][trial_id
+0000c2e0: 785d 2920 2b20 272c 2074 6865 2065 6e64  x]) + ', the end
+0000c2f0: 206f 6620 7468 6520 7472 6961 6c2d 6570   of the trial-ep
+0000c300: 6f63 6820 6c69 6573 2061 6674 6572 2074  och lies after t
+0000c310: 6865 2065 6e64 206f 6620 7468 6520 6461  he end of the da
+0000c320: 7461 2d73 6574 2e27 290a 2020 2020 2020  ta-set.').      
+0000c330: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0000c340: 6361 6c5f 656e 6420 3d20 7472 6961 6c5f  cal_end = trial_
+0000c350: 6e75 6d5f 7361 6d70 6c65 7320 2d20 2874  num_samples - (t
+0000c360: 7269 616c 5f73 616d 706c 655f 656e 6420  rial_sample_end 
+0000c370: 2d20 6461 7461 5f72 6561 6465 722e 6e75  - data_reader.nu
+0000c380: 6d5f 7361 6d70 6c65 7329 0a20 2020 2020  m_samples).     
+0000c390: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000c3a0: 7269 616c 5f73 616d 706c 655f 656e 6420  rial_sample_end 
+0000c3b0: 3d20 6461 7461 5f72 6561 6465 722e 6e75  = data_reader.nu
+0000c3c0: 6d5f 7361 6d70 6c65 730a 2020 2020 2020  m_samples.      
+0000c3d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c3f0: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
+0000c400: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
+0000c410: 7420 7468 6520 7472 6961 6c20 7769 7468  t the trial with
+0000c420: 206f 6e73 6574 2027 202b 2073 7472 2863   onset ' + str(c
+0000c430: 6f6e 6469 7469 6f6e 735f 6f6e 7365 7473  onditions_onsets
+0000c440: 5b63 6f6e 6469 7469 6f6e 5f69 6478 5d5b  [condition_idx][
+0000c450: 7472 6961 6c5f 6964 785d 2920 2b20 272c  trial_idx]) + ',
+0000c460: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
+0000c470: 7472 6961 6c2d 6570 6f63 6820 6c69 6573  trial-epoch lies
+0000c480: 2061 6674 6572 2074 6865 2065 6e64 206f   after the end o
+0000c490: 6620 7468 6520 6461 7461 2d73 6574 2e20  f the data-set. 
+0000c4a0: 5573 6520 6120 6469 6666 6572 656e 7420  Use a different 
+0000c4b0: 6f75 745f 6f66 5f62 6f75 6e64 5f68 616e  out_of_bound_han
+0000c4c0: 646c 696e 6720 6172 6775 6d65 6e74 2074  dling argument t
+0000c4d0: 6f20 616c 6c6f 7720 6f75 742d 6f66 2d62  o allow out-of-b
+0000c4e0: 6f75 6e64 2074 7269 616c 2065 706f 6368  ound trial epoch
+0000c4f0: 7327 290a 2020 2020 2020 2020 2020 2020  s').            
+0000c500: 2020 2020 2020 2020 7261 6973 6520 5275          raise Ru
+0000c510: 6e74 696d 6545 7272 6f72 2827 4361 6e6e  ntimeError('Cann
+0000c520: 6f74 2065 7874 7261 6374 2074 7269 616c  ot extract trial
+0000c530: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+0000c540: 2320 6368 6563 6b20 7768 6574 6865 7220  # check whether 
+0000c550: 7468 6520 6261 7365 6c69 6e65 2069 7320  the baseline is 
+0000c560: 7769 7468 696e 2062 6f75 6e64 730a 2020  within bounds.  
+0000c570: 2020 2020 2020 2020 2020 6966 2062 6173            if bas
+0000c580: 656c 696e 655f 6d65 7468 6f64 203e 2030  eline_method > 0
+0000c590: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c5a0: 2020 6966 2062 6173 656c 696e 655f 7374    if baseline_st
+0000c5b0: 6172 745f 7361 6d70 6c65 203c 2030 3a0a  art_sample < 0:.
+0000c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5d0: 2020 2020 6c6f 6767 696e 672e 6572 726f      logging.erro
+0000c5e0: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
+0000c5f0: 7420 7468 6520 6261 7365 6c69 6e65 2066  t the baseline f
+0000c600: 6f72 2074 6865 2074 7269 616c 2077 6974  or the trial wit
+0000c610: 6820 6f6e 7365 7420 2720 2b20 7374 7228  h onset ' + str(
+0000c620: 636f 6e64 6974 696f 6e73 5f6f 6e73 6574  conditions_onset
+0000c630: 735b 636f 6e64 6974 696f 6e5f 6964 785d  s[condition_idx]
+0000c640: 5b74 7269 616c 5f69 6478 5d29 202b 2027  [trial_idx]) + '
+0000c650: 2c20 7468 6520 7374 6172 7420 6f66 2074  , the start of t
+0000c660: 6865 2062 6173 656c 696e 652d 6570 6f63  he baseline-epoc
+0000c670: 6820 6c69 6573 2062 6566 6f72 6520 7468  h lies before th
+0000c680: 6520 7374 6172 7420 6f66 2074 6865 2074  e start of the t
+0000c690: 7269 616c 2d65 706f 6368 2729 0a20 2020  rial-epoch').   
+0000c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c6b0: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0000c6c0: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+0000c6d0: 6163 7420 6261 7365 6c69 6e65 2729 0a20  act baseline'). 
+0000c6e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c6f0: 6620 6261 7365 6c69 6e65 5f65 6e64 5f73  f baseline_end_s
+0000c700: 616d 706c 6520 3e20 7472 6961 6c5f 6e75  ample > trial_nu
+0000c710: 6d5f 7361 6d70 6c65 733a 0a20 2020 2020  m_samples:.     
+0000c720: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000c730: 6f67 6769 6e67 2e65 7272 6f72 2827 4361  ogging.error('Ca
+0000c740: 6e6e 6f74 2065 7874 7261 6374 2074 6865  nnot extract the
+0000c750: 2062 6173 656c 696e 6520 666f 7220 7468   baseline for th
+0000c760: 6520 7472 6961 6c20 7769 7468 206f 6e73  e trial with ons
+0000c770: 6574 2027 202b 2073 7472 2863 6f6e 6469  et ' + str(condi
+0000c780: 7469 6f6e 735f 6f6e 7365 7473 5b63 6f6e  tions_onsets[con
+0000c790: 6469 7469 6f6e 5f69 6478 5d5b 7472 6961  dition_idx][tria
+0000c7a0: 6c5f 6964 785d 2920 2b20 272c 2074 6865  l_idx]) + ', the
+0000c7b0: 2065 6e64 206f 6620 7468 6520 6261 7365   end of the base
+0000c7c0: 6c69 6e65 2d65 706f 6368 206c 6965 7320  line-epoch lies 
+0000c7d0: 6f75 7473 6964 6520 6f66 2074 6865 2074  outside of the t
+0000c7e0: 7269 616c 2d65 706f 6368 2729 0a20 2020  rial-epoch').   
+0000c7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c800: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0000c810: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+0000c820: 6163 7420 6261 7365 6c69 6e65 2729 0a20  act baseline'). 
+0000c830: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c840: 6620 6261 7365 6c69 6e65 5f73 7461 7274  f baseline_start
+0000c850: 5f73 616d 706c 6520 3c20 6c6f 6361 6c5f  _sample < local_
+0000c860: 7374 6172 7420 6f72 2062 6173 656c 696e  start or baselin
+0000c870: 655f 656e 645f 7361 6d70 6c65 203e 206c  e_end_sample > l
+0000c880: 6f63 616c 5f65 6e64 3a0a 2020 2020 2020  ocal_end:.      
+0000c890: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+0000c8a0: 6767 696e 672e 6572 726f 7228 2743 616e  gging.error('Can
+0000c8b0: 6e6f 7420 6578 7472 6163 7420 7468 6520  not extract the 
+0000c8c0: 6261 7365 6c69 6e65 2066 6f72 2074 6865  baseline for the
+0000c8d0: 2074 7269 616c 2077 6974 6820 6f6e 7365   trial with onse
+0000c8e0: 7420 2720 2b20 7374 7228 636f 6e64 6974  t ' + str(condit
+0000c8f0: 696f 6e73 5f6f 6e73 6574 735b 636f 6e64  ions_onsets[cond
+0000c900: 6974 696f 6e5f 6964 785d 5b74 7269 616c  ition_idx][trial
+0000c910: 5f69 6478 5d29 202b 2027 2c20 7468 6520  _idx]) + ', the 
+0000c920: 7261 6e67 6520 666f 7220 7468 6520 6261  range for the ba
+0000c930: 7365 6c69 6e65 206c 6965 7320 6f75 7473  seline lies outs
+0000c940: 6964 6520 6f66 2074 6865 2074 7269 616c  ide of the trial
+0000c950: 2d65 706f 6368 2062 6563 6175 7365 2074  -epoch because t
+0000c960: 6861 7420 7061 7274 206f 6620 7468 6520  hat part of the 
+0000c970: 7472 6961 6c2d 6570 6f63 6820 7761 7320  trial-epoch was 
+0000c980: 6f75 742d 6f66 2d62 6f75 6e64 7327 290a  out-of-bounds').
+0000c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c9a0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+0000c9b0: 6545 7272 6f72 2827 4361 6e6e 6f74 2065  eError('Cannot e
+0000c9c0: 7874 7261 6374 2062 6173 656c 696e 6527  xtract baseline'
+0000c9d0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0000c9e0: 206c 6f61 6420 7468 6520 7472 6961 6c20   load the trial 
+0000c9f0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0000ca00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000ca10: 2020 2020 2020 7472 6961 6c5f 6461 7461        trial_data
+0000ca20: 203d 2064 6174 615f 7265 6164 6572 2e72   = data_reader.r
+0000ca30: 6574 7269 6576 655f 7361 6d70 6c65 5f72  etrieve_sample_r
+0000ca40: 616e 6765 5f64 6174 6128 7472 6961 6c5f  ange_data(trial_
+0000ca50: 7361 6d70 6c65 5f73 7461 7274 2c20 7472  sample_start, tr
+0000ca60: 6961 6c5f 7361 6d70 6c65 5f65 6e64 2c0a  ial_sample_end,.
+0000ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ca90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cab0: 2020 2020 6368 616e 6e65 6c73 3d72 6574      channels=ret
+0000cac0: 7269 6576 655f 6368 616e 6e65 6c73 2c20  rieve_channels, 
+0000cad0: 656e 7375 7265 5f6f 776e 5f64 6174 613d  ensure_own_data=
+0000cae0: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
+0000caf0: 2020 2065 7863 6570 7420 2852 756e 7469     except (Runti
+0000cb00: 6d65 4572 726f 722c 204c 6f6f 6b75 7045  meError, LookupE
+0000cb10: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0000cb20: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
+0000cb30: 7469 6d65 4572 726f 7228 2743 6f75 6c64  timeError('Could
+0000cb40: 206e 6f74 206c 6f61 6420 6461 7461 2729   not load data')
+0000cb50: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+0000cb60: 6c6f 6f70 2074 6872 6f75 6768 2074 6865  loop through the
+0000cb70: 2063 6861 6e6e 656c 730a 2020 2020 2020   channels.      
+0000cb80: 2020 2020 2020 666f 7220 6368 616e 6e65        for channe
+0000cb90: 6c5f 6964 7820 696e 2072 616e 6765 286c  l_idx in range(l
+0000cba0: 656e 2872 6574 7269 6576 655f 6368 616e  en(retrieve_chan
+0000cbb0: 6e65 6c73 2929 3a0a 0a20 2020 2020 2020  nels)):..       
+0000cbc0: 2020 2020 2020 2020 2023 2065 7874 7261           # extra
+0000cbd0: 6374 2074 6865 2074 7269 616c 2064 6174  ct the trial dat
+0000cbe0: 6120 616e 6420 7065 7266 6f72 6d20 6261  a and perform ba
+0000cbf0: 7365 6c69 6e65 206e 6f72 6d61 6c69 7a61  seline normaliza
+0000cc00: 7469 6f6e 206f 6e20 7468 6520 7472 6961  tion on the tria
+0000cc10: 6c20 6966 206e 6565 6465 640a 2020 2020  l if needed.    
+0000cc20: 2020 2020 2020 2020 2020 2020 230a 2020              #.  
+0000cc30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0000cc40: 6578 6365 7074 2077 6865 6e20 7468 6572  except when ther
+0000cc50: 6520 6973 2061 2066 756e 6374 696f 6e20  e is a function 
+0000cc60: 6361 6c6c 6261 636b 2e20 5768 656e 2061  callback. When a
+0000cc70: 2063 616c 6c62 6163 6b20 6973 2074 6865   callback is the
+0000cc80: 6e20 7765 206e 6565 6420 746f 2066 6972  n we need to fir
+0000cc90: 7374 2061 6363 756d 756c 6174 6520 7468  st accumulate th
+0000cca0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000ccb0: 2020 2320 6675 6c6c 2028 692e 652e 2063    # full (i.e. c
+0000ccc0: 6861 6e6e 656c 7320 7820 7472 6961 6c73  hannels x trials
+0000ccd0: 2078 2065 706f 6368 2920 756e 2d6e 6f72   x epoch) un-nor
+0000cce0: 6d61 6c69 7a65 6420 7375 6273 6574 2074  malized subset t
+0000ccf0: 6f20 7072 6f76 6964 6520 746f 2074 6865  o provide to the
+0000cd00: 2066 756e 6374 696f 6e2c 2061 6e64 2073   function, and s
+0000cd10: 746f 7265 0a20 2020 2020 2020 2020 2020  tore.           
+0000cd20: 2020 2020 2023 2074 6865 2062 6173 656c       # the basel
+0000cd30: 696e 6520 7661 6c75 6573 2069 6e20 6120  ine values in a 
+0000cd40: 7365 7061 7261 7465 2061 7272 6179 2c20  separate array, 
+0000cd50: 736f 2074 6865 7920 6361 6e20 6265 2061  so they can be a
+0000cd60: 7070 6c69 6564 206c 6174 6572 0a20 2020  pplied later.   
+0000cd70: 2020 2020 2020 2020 2020 2020 2023 0a20               #. 
+0000cd80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000cd90: 6620 6261 7365 6c69 6e65 5f6d 6574 686f  f baseline_metho
+0000cda0: 6420 3d3d 2030 206f 7220 6d65 7472 6963  d == 0 or metric
+0000cdb0: 5f63 616c 6c62 6163 6b73 2069 7320 6e6f  _callbacks is no
+0000cdc0: 7420 4e6f 6e65 3a0a 0a20 2020 2020 2020  t None:..       
+0000cdd0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+0000cde0: 6f74 653a 206e 6f74 2072 656c 6576 616e  ote: not relevan
+0000cdf0: 7420 7768 6574 6865 7220 7468 6973 2069  t whether this i
+0000ce00: 7320 6120 6e75 6d70 792d 7669 6577 206f  s a numpy-view o
+0000ce10: 7220 6e6f 742c 2073 696e 6365 2077 6520  r not, since we 
+0000ce20: 7769 6c6c 2061 7665 7261 6765 206f 7665  will average ove
+0000ce30: 7220 7468 6520 7472 6961 6c73 0a20 2020  r the trials.   
+0000ce40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ce50: 2023 2020 2020 2020 206c 6174 6572 2e20   #       later. 
+0000ce60: 4173 7375 6d65 206d 6574 7269 635f 6361  Assume metric_ca
+0000ce70: 6c6c 6261 636b 2064 6f65 7320 6e6f 7420  llback does not 
+0000ce80: 6d61 6e69 7075 6c61 7465 2074 6865 2064  manipulate the d
+0000ce90: 6174 6120 6974 2069 7320 6769 7665 6e0a  ata it is given.
+0000cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ceb0: 2020 2020 636f 6e64 6974 696f 6e5f 6461      condition_da
+0000cec0: 7461 5b63 6861 6e6e 656c 5f69 6478 2c20  ta[channel_idx, 
+0000ced0: 7472 6961 6c5f 6964 782c 206c 6f63 616c  trial_idx, local
+0000cee0: 5f73 7461 7274 3a6c 6f63 616c 5f65 6e64  _start:local_end
+0000cef0: 5d20 3d20 7472 6961 6c5f 6461 7461 5b63  ] = trial_data[c
+0000cf00: 6861 6e6e 656c 5f69 6478 5d0a 0a20 2020  hannel_idx]..   
+0000cf10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000cf20: 6261 7365 6c69 6e65 5f6d 6574 686f 6420  baseline_method 
+0000cf30: 3d3d 2031 3a0a 0a20 2020 2020 2020 2020  == 1:..         
+0000cf40: 2020 2020 2020 2020 2020 2069 6620 6d65             if me
+0000cf50: 7472 6963 5f63 616c 6c62 6163 6b73 2069  tric_callbacks i
+0000cf60: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cf80: 2320 6e6f 2063 616c 6c62 6163 6b2c 206e  # no callback, n
+0000cf90: 6f72 6d61 6c69 7a65 2061 6e64 2073 746f  ormalize and sto
+0000cfa0: 7265 2074 6865 2074 7269 616c 2064 6174  re the trial dat
+0000cfb0: 6120 7769 7468 2062 6173 656c 696e 6520  a with baseline 
+0000cfc0: 6170 706c 6965 640a 2020 2020 2020 2020  applied.        
+0000cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cfe0: 636f 6e64 6974 696f 6e5f 6461 7461 5b63  condition_data[c
+0000cff0: 6861 6e6e 656c 5f69 6478 2c20 7472 6961  hannel_idx, tria
+0000d000: 6c5f 6964 782c 206c 6f63 616c 5f73 7461  l_idx, local_sta
+0000d010: 7274 3a6c 6f63 616c 5f65 6e64 5d20 3d20  rt:local_end] = 
+0000d020: 7472 6961 6c5f 6461 7461 5b63 6861 6e6e  trial_data[chann
+0000d030: 656c 5f69 6478 5d20 2d20 6e70 2e6e 616e  el_idx] - np.nan
+0000d040: 6d65 616e 2874 7269 616c 5f64 6174 615b  mean(trial_data[
+0000d050: 6368 616e 6e65 6c5f 6964 785d 5b62 6173  channel_idx][bas
+0000d060: 656c 696e 655f 7374 6172 745f 7361 6d70  eline_start_samp
+0000d070: 6c65 3a62 6173 656c 696e 655f 656e 645f  le:baseline_end_
+0000d080: 7361 6d70 6c65 5d29 0a0a 2020 2020 2020  sample])..      
+0000d090: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000d0a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000d0b0: 2020 2020 2020 2020 2020 2020 2320 6361              # ca
+0000d0c0: 6c6c 6261 636b 2c20 7374 6f72 6520 7468  llback, store th
+0000d0d0: 6520 6261 7365 6c69 6e65 2076 616c 7565  e baseline value
+0000d0e0: 7320 666f 7220 6c61 7465 7220 7573 650a  s for later use.
+0000d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d100: 2020 2020 2020 2020 2320 4e6f 7465 3a20          # Note: 
+0000d110: 6e6f 7420 7265 6c65 7661 6e74 2077 6865  not relevant whe
+0000d120: 7468 6572 2074 6869 7320 6973 2061 206e  ther this is a n
+0000d130: 756d 7079 2d76 6965 7720 6f72 206e 6f74  umpy-view or not
+0000d140: 2c20 7369 6e63 6520 7765 2077 696c 6c20  , since we will 
+0000d150: 6176 6572 6167 6520 6f76 6572 2074 6865  average over the
+0000d160: 2074 7269 616c 730a 2020 2020 2020 2020   trials.        
+0000d170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d180: 2320 2020 2020 2020 6c61 7465 722e 2041  #       later. A
+0000d190: 7373 756d 6520 6d65 7472 6963 5f63 616c  ssume metric_cal
+0000d1a0: 6c62 6163 6b20 646f 6573 206e 6f74 206d  lback does not m
+0000d1b0: 616e 6970 756c 6174 6520 7468 6520 6461  anipulate the da
+0000d1c0: 7461 2069 7420 6973 2067 6976 656e 0a20  ta it is given. 
+0000d1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d1e0: 2020 2020 2020 2062 6173 656c 696e 655f         baseline_
+0000d1f0: 6461 7461 5b63 6861 6e6e 656c 5f69 6478  data[channel_idx
+0000d200: 2c20 7472 6961 6c5f 6964 782c 203a 5d20  , trial_idx, :] 
+0000d210: 3d20 7472 6961 6c5f 6461 7461 5b63 6861  = trial_data[cha
+0000d220: 6e6e 656c 5f69 6478 5d5b 6261 7365 6c69  nnel_idx][baseli
+0000d230: 6e65 5f73 7461 7274 5f73 616d 706c 653a  ne_start_sample:
+0000d240: 6261 7365 6c69 6e65 5f65 6e64 5f73 616d  baseline_end_sam
+0000d250: 706c 655d 0a0a 2020 2020 2020 2020 2020  ple]..          
+0000d260: 2020 2020 2020 656c 6966 2062 6173 656c        elif basel
+0000d270: 696e 655f 6d65 7468 6f64 203d 3d20 323a  ine_method == 2:
+0000d280: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000d290: 2020 2020 2020 6966 206d 6574 7269 635f        if metric_
+0000d2a0: 6361 6c6c 6261 636b 7320 6973 204e 6f6e  callbacks is Non
+0000d2b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000d2c0: 2020 2020 2020 2020 2020 2023 206e 6f20             # no 
+0000d2d0: 6361 6c6c 6261 636b 2c20 6e6f 726d 616c  callback, normal
+0000d2e0: 697a 6520 616e 6420 7374 6f72 6520 7468  ize and store th
+0000d2f0: 6520 7472 6961 6c20 6461 7461 2077 6974  e trial data wit
+0000d300: 6820 6261 7365 6c69 6e65 2061 7070 6c69  h baseline appli
+0000d310: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+0000d320: 2020 2020 2020 2020 2020 2063 6f6e 6469             condi
+0000d330: 7469 6f6e 5f64 6174 615b 6368 616e 6e65  tion_data[channe
+0000d340: 6c5f 6964 782c 2074 7269 616c 5f69 6478  l_idx, trial_idx
+0000d350: 2c20 6c6f 6361 6c5f 7374 6172 743a 6c6f  , local_start:lo
+0000d360: 6361 6c5f 656e 645d 203d 2074 7269 616c  cal_end] = trial
+0000d370: 5f64 6174 615b 6368 616e 6e65 6c5f 6964  _data[channel_id
+0000d380: 785d 202d 206e 702e 6e61 6e6d 6564 6961  x] - np.nanmedia
+0000d390: 6e28 7472 6961 6c5f 6461 7461 5b63 6861  n(trial_data[cha
+0000d3a0: 6e6e 656c 5f69 6478 5d5b 6261 7365 6c69  nnel_idx][baseli
+0000d3b0: 6e65 5f73 7461 7274 5f73 616d 706c 653a  ne_start_sample:
+0000d3c0: 6261 7365 6c69 6e65 5f65 6e64 5f73 616d  baseline_end_sam
+0000d3d0: 706c 655d 290a 0a20 2020 2020 2020 2020  ple])..         
+0000d3e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000d3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d400: 2020 2020 2020 2020 2023 2063 616c 6c62           # callb
+0000d410: 6163 6b2c 2073 746f 7265 2074 6865 2062  ack, store the b
+0000d420: 6173 656c 696e 6520 7661 6c75 6573 2066  aseline values f
+0000d430: 6f72 206c 6174 6572 2075 7365 0a20 2020  or later use.   
+0000d440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d450: 2020 2020 2023 204e 6f74 653a 206e 6f74       # Note: not
+0000d460: 2072 656c 6576 616e 7420 7768 6574 6865   relevant whethe
+0000d470: 7220 7468 6973 2069 7320 6120 6e75 6d70  r this is a nump
+0000d480: 792d 7669 6577 206f 7220 6e6f 742c 2073  y-view or not, s
+0000d490: 696e 6365 2077 6520 7769 6c6c 2061 7665  ince we will ave
+0000d4a0: 7261 6765 206f 7665 7220 7468 6520 7472  rage over the tr
+0000d4b0: 6961 6c73 0a20 2020 2020 2020 2020 2020  ials.           
+0000d4c0: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+0000d4d0: 2020 2020 206c 6174 6572 2e20 4173 7375       later. Assu
+0000d4e0: 6d65 206d 6574 7269 635f 6361 6c6c 6261  me metric_callba
+0000d4f0: 636b 2064 6f65 7320 6e6f 7420 6d61 6e69  ck does not mani
+0000d500: 7075 6c61 7465 2074 6865 2064 6174 6120  pulate the data 
+0000d510: 6974 2069 7320 6769 7665 6e0a 2020 2020  it is given.    
+0000d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d530: 2020 2020 6261 7365 6c69 6e65 5f64 6174      baseline_dat
+0000d540: 615b 6368 616e 6e65 6c5f 6964 782c 2074  a[channel_idx, t
+0000d550: 7269 616c 5f69 6478 2c20 3a5d 203d 2074  rial_idx, :] = t
+0000d560: 7269 616c 5f64 6174 615b 6368 616e 6e65  rial_data[channe
+0000d570: 6c5f 6964 785d 5b62 6173 656c 696e 655f  l_idx][baseline_
+0000d580: 7374 6172 745f 7361 6d70 6c65 3a62 6173  start_sample:bas
+0000d590: 656c 696e 655f 656e 645f 7361 6d70 6c65  eline_end_sample
+0000d5a0: 5d0a 0a20 2020 2020 2020 2023 2063 6865  ]..        # che
+0000d5b0: 636b 2069 6620 6120 7072 652d 6176 6572  ck if a pre-aver
+0000d5c0: 6167 696e 6720 6361 6c6c 6261 636b 2066  aging callback f
+0000d5d0: 756e 6374 696f 6e20 6973 2064 6566 696e  unction is defin
+0000d5e0: 6564 0a20 2020 2020 2020 206d 6574 7269  ed.        metri
+0000d5f0: 6320 3d20 4e6f 6e65 0a20 2020 2020 2020  c = None.       
+0000d600: 2069 6620 6d65 7472 6963 5f63 616c 6c62   if metric_callb
+0000d610: 6163 6b73 2069 7320 6e6f 7420 4e6f 6e65  acks is not None
+0000d620: 3a0a 0a20 2020 2020 2020 2020 2020 2023  :..            #
+0000d630: 2070 6572 2063 6861 6e6e 656c 2c20 7061   per channel, pa
+0000d640: 7373 2074 6865 2074 7269 616c 7320 7820  ss the trials x 
+0000d650: 6570 6f63 6820 756e 2d6e 6f72 6d61 6c69  epoch un-normali
+0000d660: 7a65 6420 7375 6273 6574 2074 6f20 7468  zed subset to th
+0000d670: 6520 6361 6c6c 6261 636b 2066 756e 6374  e callback funct
+0000d680: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0000d690: 2320 616e 6420 7265 7472 6965 7665 2074  # and retrieve t
+0000d6a0: 6865 2072 6573 756c 740a 2020 2020 2020  he result.      
+0000d6b0: 2020 2020 2020 666f 7220 6368 616e 6e65        for channe
+0000d6c0: 6c5f 6964 7820 696e 2072 616e 6765 286c  l_idx in range(l
+0000d6d0: 656e 2872 6574 7269 6576 655f 6368 616e  en(retrieve_chan
+0000d6e0: 6e65 6c73 2929 3a0a 0a20 2020 2020 2020  nels)):..       
+0000d6f0: 2020 2020 2020 2020 2069 6620 6361 6c6c           if call
+0000d700: 6162 6c65 286d 6574 7269 635f 6361 6c6c  able(metric_call
+0000d710: 6261 636b 7329 3a0a 0a20 2020 2020 2020  backs):..       
+0000d720: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+0000d730: 6173 7320 7468 6520 7472 6961 6c73 2078  ass the trials x
+0000d740: 2074 696d 6520 756e 2d6e 6f72 6d61 6c69   time un-normali
+0000d750: 7a65 6420 7375 6273 6574 2074 6f20 7468  zed subset to th
+0000d760: 6520 6361 6c6c 6261 636b 2066 756e 6374  e callback funct
+0000d770: 696f 6e28 7329 2061 6e64 2073 746f 7265  ion(s) and store
+0000d780: 2074 6865 2072 6573 756c 740a 2020 2020   the result.    
 0000d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d7a0: 2020 204e 6f6e 6520 6966 2062 6173 656c     None if basel
-0000d7b0: 696e 655f 6461 7461 2069 7320 4e6f 6e65  ine_data is None
-0000d7c0: 2065 6c73 6520 6261 7365 6c69 6e65 5f64   else baseline_d
-0000d7d0: 6174 615b 6368 616e 6e65 6c5f 6964 782c  ata[channel_idx,
-0000d7e0: 203a 2c20 3a5d 290a 0a20 2020 2020 2020   :, :])..       
-0000d7f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000d800: 6d65 7472 6963 5f76 616c 7565 2069 7320  metric_value is 
-0000d810: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d830: 2020 6966 206e 6f74 206e 702e 6973 7363    if not np.issc
-0000d840: 616c 6172 286d 6574 7269 635f 7661 6c75  alar(metric_valu
-0000d850: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0000d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d870: 6c6f 6767 696e 672e 6572 726f 7228 2752  logging.error('R
-0000d880: 6574 7572 6e20 6d65 7472 6963 2069 7320  eturn metric is 
-0000d890: 6e6f 7420 7363 616c 6172 2729 0a20 2020  not scalar').   
-0000d8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d8b0: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
-0000d8c0: 756e 7469 6d65 4572 726f 7228 2752 6574  untimeError('Ret
-0000d8d0: 7572 6e20 6d65 7472 6963 2069 7320 6e6f  urn metric is no
-0000d8e0: 7420 7363 616c 6172 2729 0a20 2020 2020  t scalar').     
-0000d8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d900: 2020 206d 6574 7269 635f 7661 6c75 6573     metric_values
-0000d910: 5b63 6861 6e6e 656c 5f69 6478 2c20 636f  [channel_idx, co
-0000d920: 6e64 6974 696f 6e5f 6964 785d 203d 206d  ndition_idx] = m
-0000d930: 6574 7269 635f 7661 6c75 650a 0a20 2020  etric_value..   
-0000d940: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-0000d950: 6620 7479 7065 286d 6574 7269 635f 6361  f type(metric_ca
-0000d960: 6c6c 6261 636b 7329 2069 7320 7475 706c  llbacks) is tupl
-0000d970: 6520 616e 6420 6c65 6e28 6d65 7472 6963  e and len(metric
-0000d980: 5f63 616c 6c62 6163 6b73 2920 3e20 303a  _callbacks) > 0:
-0000d990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d9a0: 2020 2020 2066 6f72 2069 4361 6c6c 6261       for iCallba
-0000d9b0: 636b 2069 6e20 7261 6e67 6528 6c65 6e28  ck in range(len(
-0000d9c0: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
-0000d9d0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-0000d9e0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0000d9f0: 616c 6c61 626c 6528 6d65 7472 6963 5f63  allable(metric_c
-0000da00: 616c 6c62 6163 6b73 5b69 4361 6c6c 6261  allbacks[iCallba
-0000da10: 636b 5d29 3a0a 0a20 2020 2020 2020 2020  ck]):..         
-0000da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000da30: 2020 2023 2070 6173 7320 7468 6520 7472     # pass the tr
-0000da40: 6961 6c73 2078 2074 696d 6520 756e 2d6e  ials x time un-n
-0000da50: 6f72 6d61 6c69 7a65 6420 7375 6273 6574  ormalized subset
-0000da60: 2074 6f20 7468 6520 6361 6c6c 6261 636b   to the callback
-0000da70: 2066 756e 6374 696f 6e28 7329 2061 6e64   function(s) and
-0000da80: 2073 746f 7265 2074 6865 2072 6573 756c   store the resul
-0000da90: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0000daa0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-0000dab0: 7472 6963 5f76 616c 7565 203d 206d 6574  tric_value = met
-0000dac0: 7269 635f 6361 6c6c 6261 636b 735b 6943  ric_callbacks[iC
-0000dad0: 616c 6c62 6163 6b5d 2864 6174 615f 7265  allback](data_re
-0000dae0: 6164 6572 2e73 616d 706c 696e 675f 7261  ader.sampling_ra
-0000daf0: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
-0000db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db30: 2020 2020 2020 2020 2020 2063 6f6e 6469             condi
-0000db40: 7469 6f6e 5f64 6174 615b 6368 616e 6e65  tion_data[channe
-0000db50: 6c5f 6964 782c 203a 2c20 3a5d 2c0a 2020  l_idx, :, :],.  
+0000d7a0: 6d65 7472 6963 5f76 616c 7565 203d 206d  metric_value = m
+0000d7b0: 6574 7269 635f 6361 6c6c 6261 636b 7328  etric_callbacks(
+0000d7c0: 6461 7461 5f72 6561 6465 722e 7361 6d70  data_reader.samp
+0000d7d0: 6c69 6e67 5f72 6174 652c 0a20 2020 2020  ling_rate,.     
+0000d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d800: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000d810: 6f6e 6469 7469 6f6e 5f64 6174 615b 6368  ondition_data[ch
+0000d820: 616e 6e65 6c5f 6964 782c 203a 2c20 3a5d  annel_idx, :, :]
+0000d830: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000d840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d860: 2020 2020 2020 4e6f 6e65 2069 6620 6261        None if ba
+0000d870: 7365 6c69 6e65 5f64 6174 6120 6973 204e  seline_data is N
+0000d880: 6f6e 6520 656c 7365 2062 6173 656c 696e  one else baselin
+0000d890: 655f 6461 7461 5b63 6861 6e6e 656c 5f69  e_data[channel_i
+0000d8a0: 6478 2c20 3a2c 203a 5d29 0a0a 2020 2020  dx, :, :])..    
+0000d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8c0: 6966 206d 6574 7269 635f 7661 6c75 6520  if metric_value 
+0000d8d0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d8f0: 2020 2020 2069 6620 6e6f 7420 6e70 2e69       if not np.i
+0000d900: 7373 6361 6c61 7228 6d65 7472 6963 5f76  sscalar(metric_v
+0000d910: 616c 7565 293a 0a20 2020 2020 2020 2020  alue):.         
+0000d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d930: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
+0000d940: 2827 5265 7475 726e 206d 6574 7269 6320  ('Return metric 
+0000d950: 6973 206e 6f74 2073 6361 6c61 7227 290a  is not scalar').
+0000d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d970: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+0000d980: 6520 5275 6e74 696d 6545 7272 6f72 2827  e RuntimeError('
+0000d990: 5265 7475 726e 206d 6574 7269 6320 6973  Return metric is
+0000d9a0: 206e 6f74 2073 6361 6c61 7227 290a 2020   not scalar').  
+0000d9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d9c0: 2020 2020 2020 6d65 7472 6963 5f76 616c        metric_val
+0000d9d0: 7565 735b 6368 616e 6e65 6c5f 6964 782c  ues[channel_idx,
+0000d9e0: 2063 6f6e 6469 7469 6f6e 5f69 6478 5d20   condition_idx] 
+0000d9f0: 3d20 6d65 7472 6963 5f76 616c 7565 0a0a  = metric_value..
+0000da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000da10: 656c 6966 2074 7970 6528 6d65 7472 6963  elif type(metric
+0000da20: 5f63 616c 6c62 6163 6b73 2920 6973 2074  _callbacks) is t
+0000da30: 7570 6c65 2061 6e64 206c 656e 286d 6574  uple and len(met
+0000da40: 7269 635f 6361 6c6c 6261 636b 7329 203e  ric_callbacks) >
+0000da50: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0000da60: 2020 2020 2020 2020 666f 7220 6943 616c          for iCal
+0000da70: 6c62 6163 6b20 696e 2072 616e 6765 286c  lback in range(l
+0000da80: 656e 286d 6574 7269 635f 6361 6c6c 6261  en(metric_callba
+0000da90: 636b 7329 293a 0a20 2020 2020 2020 2020  cks)):.         
+0000daa0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000dab0: 6620 6361 6c6c 6162 6c65 286d 6574 7269  f callable(metri
+0000dac0: 635f 6361 6c6c 6261 636b 735b 6943 616c  c_callbacks[iCal
+0000dad0: 6c62 6163 6b5d 293a 0a0a 2020 2020 2020  lback]):..      
+0000dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000daf0: 2020 2020 2020 2320 7061 7373 2074 6865        # pass the
+0000db00: 2074 7269 616c 7320 7820 7469 6d65 2075   trials x time u
+0000db10: 6e2d 6e6f 726d 616c 697a 6564 2073 7562  n-normalized sub
+0000db20: 7365 7420 746f 2074 6865 2063 616c 6c62  set to the callb
+0000db30: 6163 6b20 6675 6e63 7469 6f6e 2873 2920  ack function(s) 
+0000db40: 616e 6420 7374 6f72 6520 7468 6520 7265  and store the re
+0000db50: 7375 6c74 0a20 2020 2020 2020 2020 2020  sult.           
 0000db60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dba0: 2020 2020 204e 6f6e 6520 6966 2062 6173       None if bas
-0000dbb0: 656c 696e 655f 6461 7461 2069 7320 4e6f  eline_data is No
-0000dbc0: 6e65 2065 6c73 6520 6261 7365 6c69 6e65  ne else baseline
-0000dbd0: 5f64 6174 615b 6368 616e 6e65 6c5f 6964  _data[channel_id
-0000dbe0: 782c 203a 2c20 3a5d 290a 2020 2020 2020  x, :, :]).      
-0000dbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc00: 2020 2020 2020 6966 206d 6574 7269 635f        if metric_
-0000dc10: 7661 6c75 6520 6973 206e 6f74 204e 6f6e  value is not Non
-0000dc20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000db70: 206d 6574 7269 635f 7661 6c75 6520 3d20   metric_value = 
+0000db80: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
+0000db90: 5b69 4361 6c6c 6261 636b 5d28 6461 7461  [iCallback](data
+0000dba0: 5f72 6561 6465 722e 7361 6d70 6c69 6e67  _reader.sampling
+0000dbb0: 5f72 6174 652c 0a20 2020 2020 2020 2020  _rate,.         
+0000dbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dbf0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000dc00: 6e64 6974 696f 6e5f 6461 7461 5b63 6861  ndition_data[cha
+0000dc10: 6e6e 656c 5f69 6478 2c20 3a2c 203a 5d2c  nnel_idx, :, :],
+0000dc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 0000dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc40: 2020 2069 6620 6e6f 7420 6e70 2e69 7373     if not np.iss
-0000dc50: 6361 6c61 7228 6d65 7472 6963 5f76 616c  calar(metric_val
-0000dc60: 7565 293a 0a20 2020 2020 2020 2020 2020  ue):.           
-0000dc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc80: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
-0000dc90: 2e65 7272 6f72 2827 5265 7475 726e 206d  .error('Return m
-0000dca0: 6574 7269 6320 6973 206e 6f74 2073 6361  etric is not sca
-0000dcb0: 6c61 7227 290a 2020 2020 2020 2020 2020  lar').          
-0000dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dcd0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000dce0: 5275 6e74 696d 6545 7272 6f72 2827 5265  RuntimeError('Re
-0000dcf0: 7475 726e 206d 6574 7269 6320 6973 206e  turn metric is n
-0000dd00: 6f74 2073 6361 6c61 7227 290a 2020 2020  ot scalar').    
-0000dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dd20: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
-0000dd30: 6963 5f76 616c 7565 735b 6368 616e 6e65  ic_values[channe
-0000dd40: 6c5f 6964 782c 2063 6f6e 6469 7469 6f6e  l_idx, condition
-0000dd50: 5f69 6478 2c20 6943 616c 6c62 6163 6b5d  _idx, iCallback]
-0000dd60: 203d 206d 6574 7269 635f 7661 6c75 650a   = metric_value.
-0000dd70: 0a20 2020 2020 2020 2020 2020 2023 2074  .            # t
-0000dd80: 6865 2063 616c 6c62 6163 6b20 6861 7320  he callback has 
-0000dd90: 6265 656e 206d 6164 652c 2070 6572 666f  been made, perfo
-0000dda0: 726d 202d 6966 206e 6565 6465 642d 2074  rm -if needed- t
-0000ddb0: 6865 2028 706f 7374 706f 6e65 6429 206e  he (postponed) n
-0000ddc0: 6f72 6d61 6c69 7a61 7469 6f6e 2077 6974  ormalization wit
-0000ddd0: 6820 7468 6520 6261 7365 6c69 6e65 2076  h the baseline v
-0000dde0: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
-0000ddf0: 2020 6966 2062 6173 656c 696e 655f 6d65    if baseline_me
-0000de00: 7468 6f64 203d 3d20 313a 0a20 2020 2020  thod == 1:.     
-0000de10: 2020 2020 2020 2020 2020 2063 6f6e 6469             condi
-0000de20: 7469 6f6e 5f64 6174 6120 2d3d 206e 702e  tion_data -= np.
-0000de30: 6e61 6e6d 6561 6e28 6261 7365 6c69 6e65  nanmean(baseline
-0000de40: 5f64 6174 612c 2061 7869 733d 3229 5b3a  _data, axis=2)[:
-0000de50: 2c20 3a2c 204e 6f6e 655d 0a20 2020 2020  , :, None].     
-0000de60: 2020 2020 2020 2065 6c69 6620 6261 7365         elif base
-0000de70: 6c69 6e65 5f6d 6574 686f 6420 3d3d 2032  line_method == 2
-0000de80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000de90: 2020 636f 6e64 6974 696f 6e5f 6461 7461    condition_data
-0000dea0: 202d 3d20 6e70 2e6e 616e 6d65 6469 616e   -= np.nanmedian
-0000deb0: 2862 6173 656c 696e 655f 6461 7461 2c20  (baseline_data, 
-0000dec0: 6178 6973 3d32 295b 3a2c 203a 2c20 4e6f  axis=2)[:, :, No
-0000ded0: 6e65 5d0a 0a20 2020 2020 2020 2023 2061  ne]..        # a
-0000dee0: 7665 7261 6765 2074 6865 2074 7269 616c  verage the trial
-0000def0: 7320 666f 7220 6561 6368 2063 6861 6e6e  s for each chann
-0000df00: 656c 2028 7769 7468 696e 2074 6869 7320  el (within this 
-0000df10: 636f 6e64 6974 696f 6e29 2061 6e64 2073  condition) and s
-0000df20: 746f 7265 2074 6865 2072 6573 756c 7473  tore the results
-0000df30: 0a20 2020 2020 2020 2064 6174 615b 3a2c  .        data[:,
-0000df40: 2063 6f6e 6469 7469 6f6e 5f69 6478 2c20   condition_idx, 
-0000df50: 3a5d 203d 206e 702e 6e61 6e6d 6561 6e28  :] = np.nanmean(
-0000df60: 636f 6e64 6974 696f 6e5f 6461 7461 2c20  condition_data, 
-0000df70: 6178 6973 3d31 290a 0a20 2020 2020 2020  axis=1)..       
-0000df80: 2023 2063 6c65 6172 2072 6566 6572 656e   # clear referen
-0000df90: 6365 2074 6f20 6461 7461 0a20 2020 2020  ce to data.     
-0000dfa0: 2020 2064 656c 2063 6f6e 6469 7469 6f6e     del condition
-0000dfb0: 5f64 6174 612c 2074 7269 616c 5f64 6174  _data, trial_dat
-0000dfc0: 610a 0a20 2020 2020 2020 2023 2075 7064  a..        # upd
-0000dfd0: 6174 6520 7072 6f67 7265 7373 2062 6172  ate progress bar
-0000dfe0: 0a20 2020 2020 2020 2070 7269 6e74 5f70  .        print_p
-0000dff0: 726f 6772 6573 7362 6172 2863 6f6e 6469  rogressbar(condi
-0000e000: 7469 6f6e 5f69 6478 202b 2031 2c20 6c65  tion_idx + 1, le
-0000e010: 6e28 636f 6e64 6974 696f 6e73 5f6f 6e73  n(conditions_ons
-0000e020: 6574 7329 2c20 7072 6566 6978 3d27 5072  ets), prefix='Pr
-0000e030: 6f67 7265 7373 3a27 2c20 7375 6666 6978  ogress:', suffix
-0000e040: 3d27 436f 6d70 6c65 7465 272c 206c 656e  ='Complete', len
-0000e050: 6774 683d 3530 290a 0a20 2020 2023 2072  gth=50)..    # r
-0000e060: 6574 7572 6e20 7468 6520 7361 6d70 6c65  eturn the sample
-0000e070: 2072 6174 652c 2074 6865 2061 7665 7261   rate, the avera
-0000e080: 6765 2065 706f 6368 2061 6e64 2074 6865  ge epoch and the
-0000e090: 206d 6574 7269 6320 7661 6c75 6573 2028   metric values (
-0000e0a0: 4e6f 6e65 2069 6620 6e6f 206d 6574 7269  None if no metri
-0000e0b0: 6373 290a 2020 2020 7265 7475 726e 2064  cs).    return d
-0000e0c0: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
-0000e0d0: 696e 675f 7261 7465 2c20 6461 7461 2c20  ing_rate, data, 
-0000e0e0: 6d65 7472 6963 5f76 616c 7565 730a 0a0a  metric_values...
-0000e0f0: 6465 6620 5f5f 7375 626c 6f61 645f 6461  def __subload_da
-0000e100: 7461 5f65 706f 6368 5f61 7665 7261 6765  ta_epoch_average
-0000e110: 735f 5f66 726f 6d5f 6368 616e 6e65 6c5f  s__from_channel_
-0000e120: 5f62 795f 636f 6e64 6974 696f 6e5f 7472  _by_condition_tr
-0000e130: 6961 6c73 2872 6566 5f64 6174 612c 2072  ials(ref_data, r
-0000e140: 6566 5f6d 6574 7269 635f 7661 6c75 6573  ef_metric_values
-0000e150: 2c20 6461 7461 5f72 6561 6465 722c 2063  , data_reader, c
-0000e160: 6861 6e6e 656c 5f69 6478 2c20 6368 616e  hannel_idx, chan
-0000e170: 6e65 6c5f 6e61 6d65 2c20 6368 616e 6e65  nel_name, channe
-0000e180: 6c5f 6461 7461 2c20 636f 6e64 6974 696f  l_data, conditio
-0000e190: 6e73 5f6f 6e73 6574 732c 0a20 2020 2020  ns_onsets,.     
-0000e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e1e0: 7472 6961 6c5f 6e75 6d5f 7361 6d70 6c65  trial_num_sample
-0000e1f0: 732c 2074 7269 616c 5f65 706f 6368 2c20  s, trial_epoch, 
-0000e200: 6261 7365 6c69 6e65 5f6e 756d 5f73 616d  baseline_num_sam
-0000e210: 706c 6573 2c20 6261 7365 6c69 6e65 5f6d  ples, baseline_m
-0000e220: 6574 686f 642c 0a20 2020 2020 2020 2020  ethod,.         
-0000e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e260: 2020 2020 2020 2020 2020 2020 6261 7365              base
-0000e270: 6c69 6e65 5f65 706f 6368 2c20 6f75 745f  line_epoch, out_
-0000e280: 6f66 5f62 6f75 6e64 5f6d 6574 686f 642c  of_bound_method,
-0000e290: 206d 6574 7269 635f 6361 6c6c 6261 636b   metric_callback
-0000e2a0: 7329 3a0a 2020 2020 2222 220a 2020 2020  s):.    """.    
-0000e2b0: 5374 6172 7469 6e67 2066 726f 6d20 6120  Starting from a 
-0000e2c0: 7370 6563 6966 6963 2063 6861 6e6e 656c  specific channel
-0000e2d0: 2c20 6c6f 6164 2064 6174 6120 6570 6f63  , load data epoc
-0000e2e0: 6820 6176 6572 6167 6573 2074 6f20 616e  h averages to an
-0000e2f0: 2061 6c72 6561 6479 2065 7869 7374 696e   already existin
-0000e300: 672f 696e 6974 6961 6c69 7a65 640a 2020  g/initialized.  
-0000e310: 2020 6d61 7472 6978 2028 666f 726d 6174    matrix (format
-0000e320: 3a20 6368 616e 6e65 6c20 7820 636f 6e64  : channel x cond
-0000e330: 6974 696f 6e20 7820 7469 6d65 2920 6279  ition x time) by
-0000e340: 206c 6f6f 7069 6e67 206f 7665 7220 636f   looping over co
-0000e350: 6e64 6974 696f 6e73 2061 6e64 2074 6865  nditions and the
-0000e360: 6e20 7769 7468 696e 2074 6861 7420 6368  n within that ch
-0000e370: 616e 6e65 6c2d 636f 6e64 6974 696f 6e0a  annel-condition.
-0000e380: 2020 2020 636f 6d62 696e 6174 696f 6e20      combination 
-0000e390: 6c6f 6f70 206f 7665 7220 6561 6368 206f  loop over each o
-0000e3a0: 6620 7468 6520 7472 6961 6c73 2074 6f20  f the trials to 
-0000e3b0: 6c6f 6164 2074 6865 2073 7065 6369 6669  load the specifi
-0000e3c0: 6320 6368 616e 6e65 6c2d 636f 6e64 6974  c channel-condit
-0000e3d0: 696f 6e2d 7472 6961 6c20 6461 7461 2e0a  ion-trial data..
-0000e3e0: 0a20 2020 2072 6566 5f64 6174 6120 3a20  .    ref_data : 
-0000e3f0: 5265 6665 7265 6e63 6520 746f 2074 6865  Reference to the
-0000e400: 206e 756d 7079 206d 6174 7269 7820 7468   numpy matrix th
-0000e410: 6174 2068 6f6c 6473 2061 6c6c 2074 6865  at holds all the
-0000e420: 2065 706f 6368 2061 7665 7261 6765 732e   epoch averages.
-0000e430: 2052 6566 6572 656e 6365 2069 7320 616c   Reference is al
-0000e440: 736f 2072 6574 7572 6e65 6420 6f6e 2073  so returned on s
-0000e450: 7563 6365 7373 0a20 2020 2072 6566 5f6d  uccess.    ref_m
-0000e460: 6574 7269 635f 7661 6c75 6573 3a20 5265  etric_values: Re
-0000e470: 6665 7265 6e63 6520 746f 2074 6865 202e  ference to the .
-0000e480: 2e2e 2074 6861 7420 686f 6c64 7320 616c  .. that holds al
-0000e490: 6c20 7468 6520 6d65 7472 6963 2076 616c  l the metric val
-0000e4a0: 7565 732e 2052 6566 6572 656e 6365 2069  ues. Reference i
-0000e4b0: 7320 616c 736f 2072 6574 7572 6e65 6420  s also returned 
-0000e4c0: 6f6e 2073 7563 6365 7373 0a0a 2020 2020  on success..    
-0000e4d0: 2222 220a 0a20 2020 2069 6620 6368 616e  """..    if chan
-0000e4e0: 6e65 6c5f 6461 7461 2069 7320 4e6f 6e65  nel_data is None
-0000e4f0: 3a0a 2020 2020 2020 2020 6368 616e 6e65  :.        channe
-0000e500: 6c5f 6e75 6d5f 7361 6d70 6c65 7320 3d20  l_num_samples = 
-0000e510: 6461 7461 5f72 6561 6465 722e 6e75 6d5f  data_reader.num_
-0000e520: 7361 6d70 6c65 730a 2020 2020 656c 7365  samples.    else
-0000e530: 3a0a 2020 2020 2020 2020 6368 616e 6e65  :.        channe
-0000e540: 6c5f 6e75 6d5f 7361 6d70 6c65 7320 3d20  l_num_samples = 
-0000e550: 6368 616e 6e65 6c5f 6461 7461 2e73 697a  channel_data.siz
-0000e560: 650a 0a20 2020 2023 206c 6f6f 7020 7468  e..    # loop th
-0000e570: 726f 7567 6820 7468 6520 636f 6e64 6974  rough the condit
-0000e580: 696f 6e73 0a20 2020 2066 6f72 2063 6f6e  ions.    for con
-0000e590: 6469 7469 6f6e 5f69 6478 2069 6e20 7261  dition_idx in ra
-0000e5a0: 6e67 6528 6c65 6e28 636f 6e64 6974 696f  nge(len(conditio
-0000e5b0: 6e73 5f6f 6e73 6574 7329 293a 0a0a 2020  ns_onsets)):..  
-0000e5c0: 2020 2020 2020 2320 696e 6974 6961 6c69        # initiali
-0000e5d0: 7a65 2061 2062 7566 6665 7220 746f 2070  ze a buffer to p
-0000e5e0: 7574 2061 6c6c 2074 6865 2064 6174 6120  ut all the data 
-0000e5f0: 666f 7220 7468 6973 2063 6f6e 6469 7469  for this conditi
-0000e600: 6f6e 2d63 6861 6e6e 656c 2069 6e20 2874  on-channel in (t
-0000e610: 7269 616c 7320 7820 7361 6d70 6c65 7329  rials x samples)
-0000e620: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0000e630: 2020 2020 2020 2020 2020 636f 6e64 6974            condit
-0000e640: 696f 6e5f 6368 616e 6e65 6c5f 6461 7461  ion_channel_data
-0000e650: 203d 2061 6c6c 6f63 6174 655f 6172 7261   = allocate_arra
-0000e660: 7928 286c 656e 2863 6f6e 6469 7469 6f6e  y((len(condition
-0000e670: 735f 6f6e 7365 7473 5b63 6f6e 6469 7469  s_onsets[conditi
-0000e680: 6f6e 5f69 6478 5d29 2c20 7472 6961 6c5f  on_idx]), trial_
-0000e690: 6e75 6d5f 7361 6d70 6c65 7329 290a 2020  num_samples)).  
-0000e6a0: 2020 2020 2020 6578 6365 7074 204d 656d        except Mem
-0000e6b0: 6f72 7945 7272 6f72 3a0a 2020 2020 2020  oryError:.      
-0000e6c0: 2020 2020 2020 7261 6973 6520 4d65 6d6f        raise Memo
-0000e6d0: 7279 4572 726f 7228 274e 6f74 2065 6e6f  ryError('Not eno
-0000e6e0: 7567 6820 6d65 6d6f 7279 2063 7265 6174  ugh memory creat
-0000e6f0: 6520 6120 7465 6d70 6f72 6172 7920 636f  e a temporary co
-0000e700: 6e64 6974 696f 6e2d 6368 616e 6e65 6c20  ndition-channel 
-0000e710: 6461 7461 206d 6174 7269 7827 290a 0a20  data matrix').. 
-0000e720: 2020 2020 2020 2023 2069 6620 6261 7365         # if base
-0000e730: 6c69 6e65 206e 6f72 6d61 6c69 7a61 7469  line normalizati
-0000e740: 6f6e 2069 7320 6e65 6564 6564 2061 6e64  on is needed and
-0000e750: 2074 6865 2070 7265 2d61 7665 7261 6765   the pre-average
-0000e760: 2063 616c 6c62 6163 6b20 6675 6e63 7469   callback functi
-0000e770: 6f6e 2069 7320 6465 6669 6e65 642c 2074  on is defined, t
-0000e780: 6865 6e20 7765 2066 6972 7374 0a20 2020  hen we first.   
-0000e790: 2020 2020 2023 206e 6565 6420 746f 2061       # need to a
-0000e7a0: 6363 756d 756c 6174 6520 7468 6520 6675  ccumulate the fu
-0000e7b0: 6c6c 2028 692e 652e 2063 6861 6e6e 656c  ll (i.e. channel
-0000e7c0: 7320 7820 7472 6961 6c73 2078 2065 706f  s x trials x epo
-0000e7d0: 6368 2920 756e 2d6e 6f72 6d61 6c69 7a65  ch) un-normalize
-0000e7e0: 6420 7375 6273 6574 2074 6f20 7072 6f76  d subset to prov
-0000e7f0: 6964 6520 746f 2074 6865 0a20 2020 2020  ide to the.     
-0000e800: 2020 2023 2066 756e 6374 696f 6e2e 2054     # function. T
-0000e810: 6865 7265 666f 7265 2c20 7765 2069 6e69  herefore, we ini
-0000e820: 7469 616c 697a 6520 616e 2061 7272 6179  tialize an array
-0000e830: 2074 6f20 7374 6f72 6520 7468 6520 6261   to store the ba
-0000e840: 7365 6c69 6e65 2076 616c 7565 7320 666f  seline values fo
-0000e850: 7220 6561 6368 2063 6861 6e6e 656c 2078  r each channel x
-0000e860: 2074 7269 616c 2c20 736f 0a20 2020 2020   trial, so.     
-0000e870: 2020 2023 2077 6520 6361 6e20 6e6f 726d     # we can norm
-0000e880: 616c 697a 6520 6166 7465 7220 7468 6520  alize after the 
-0000e890: 6361 6c6c 6261 636b 0a20 2020 2020 2020  callback.       
-0000e8a0: 2062 6173 656c 696e 655f 6461 7461 203d   baseline_data =
-0000e8b0: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-0000e8c0: 206e 6f74 2062 6173 656c 696e 655f 6d65   not baseline_me
-0000e8d0: 7468 6f64 203d 3d20 3020 616e 6420 6d65  thod == 0 and me
-0000e8e0: 7472 6963 5f63 616c 6c62 6163 6b73 2069  tric_callbacks i
-0000e8f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0000e900: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000e910: 2020 2020 2020 2020 2020 2020 2062 6173               bas
-0000e920: 656c 696e 655f 6461 7461 203d 2061 6c6c  eline_data = all
-0000e930: 6f63 6174 655f 6172 7261 7928 286c 656e  ocate_array((len
-0000e940: 2863 6f6e 6469 7469 6f6e 735f 6f6e 7365  (conditions_onse
-0000e950: 7473 5b63 6f6e 6469 7469 6f6e 5f69 6478  ts[condition_idx
-0000e960: 5d29 2c20 6261 7365 6c69 6e65 5f6e 756d  ]), baseline_num
-0000e970: 5f73 616d 706c 6573 2929 0a20 2020 2020  _samples)).     
-0000e980: 2020 2020 2020 2065 7863 6570 7420 4d65         except Me
-0000e990: 6d6f 7279 4572 726f 723a 0a20 2020 2020  moryError:.     
-0000e9a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0000e9b0: 204d 656d 6f72 7945 7272 6f72 2827 4e6f   MemoryError('No
-0000e9c0: 7420 656e 6f75 6768 206d 656d 6f72 7920  t enough memory 
-0000e9d0: 6372 6561 7465 2061 2074 656d 706f 7261  create a tempora
-0000e9e0: 7279 2063 6f6e 6469 7469 6f6e 2d63 6861  ry condition-cha
-0000e9f0: 6e6e 656c 2062 6173 656c 696e 6520 6461  nnel baseline da
-0000ea00: 7461 206d 6174 7269 7827 290a 0a20 2020  ta matrix')..   
-0000ea10: 2020 2020 2023 206c 6f6f 7020 7468 726f       # loop thro
-0000ea20: 7567 6820 7468 6520 7472 6961 6c73 2069  ugh the trials i
-0000ea30: 6e20 7468 6520 636f 6e64 6974 696f 6e0a  n the condition.
-0000ea40: 2020 2020 2020 2020 666f 7220 7472 6961          for tria
-0000ea50: 6c5f 6964 7820 696e 2072 616e 6765 286c  l_idx in range(l
-0000ea60: 656e 2863 6f6e 6469 7469 6f6e 735f 6f6e  en(conditions_on
-0000ea70: 7365 7473 5b63 6f6e 6469 7469 6f6e 5f69  sets[condition_i
-0000ea80: 6478 5d29 293a 0a0a 2020 2020 2020 2020  dx])):..        
-0000ea90: 2020 2020 2320 6361 6c63 756c 6174 6520      # calculate 
-0000eaa0: 7468 6520 7361 6d70 6c65 2069 6e64 6963  the sample indic
-0000eab0: 6573 0a20 2020 2020 2020 2020 2020 2074  es.            t
-0000eac0: 7269 616c 5f73 616d 706c 655f 7374 6172  rial_sample_star
-0000ead0: 7420 3d20 696e 7428 726f 756e 6428 2863  t = int(round((c
-0000eae0: 6f6e 6469 7469 6f6e 735f 6f6e 7365 7473  onditions_onsets
-0000eaf0: 5b63 6f6e 6469 7469 6f6e 5f69 6478 5d5b  [condition_idx][
-0000eb00: 7472 6961 6c5f 6964 785d 202b 2074 7269  trial_idx] + tri
-0000eb10: 616c 5f65 706f 6368 5b30 5d29 202a 2064  al_epoch[0]) * d
-0000eb20: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
-0000eb30: 696e 675f 7261 7465 2929 0a20 2020 2020  ing_rate)).     
-0000eb40: 2020 2020 2020 2074 7269 616c 5f73 616d         trial_sam
-0000eb50: 706c 655f 656e 6420 3d20 7472 6961 6c5f  ple_end = trial_
-0000eb60: 7361 6d70 6c65 5f73 7461 7274 202b 2074  sample_start + t
-0000eb70: 7269 616c 5f6e 756d 5f73 616d 706c 6573  rial_num_samples
-0000eb80: 0a20 2020 2020 2020 2020 2020 2062 6173  .            bas
-0000eb90: 656c 696e 655f 7374 6172 745f 7361 6d70  eline_start_samp
-0000eba0: 6c65 203d 2069 6e74 2872 6f75 6e64 2828  le = int(round((
-0000ebb0: 636f 6e64 6974 696f 6e73 5f6f 6e73 6574  conditions_onset
-0000ebc0: 735b 636f 6e64 6974 696f 6e5f 6964 785d  s[condition_idx]
-0000ebd0: 5b74 7269 616c 5f69 6478 5d20 2b20 6261  [trial_idx] + ba
-0000ebe0: 7365 6c69 6e65 5f65 706f 6368 5b30 5d29  seline_epoch[0])
-0000ebf0: 202a 2064 6174 615f 7265 6164 6572 2e73   * data_reader.s
-0000ec00: 616d 706c 696e 675f 7261 7465 2929 0a20  ampling_rate)). 
-0000ec10: 2020 2020 2020 2020 2020 2062 6173 656c             basel
-0000ec20: 696e 655f 656e 645f 7361 6d70 6c65 203d  ine_end_sample =
-0000ec30: 2062 6173 656c 696e 655f 7374 6172 745f   baseline_start_
-0000ec40: 7361 6d70 6c65 202b 2062 6173 656c 696e  sample + baselin
-0000ec50: 655f 6e75 6d5f 7361 6d70 6c65 730a 2020  e_num_samples.  
-0000ec60: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
-0000ec70: 7374 6172 7420 3d20 300a 2020 2020 2020  start = 0.      
-0000ec80: 2020 2020 2020 6c6f 6361 6c5f 656e 6420        local_end 
-0000ec90: 3d20 7472 6961 6c5f 6e75 6d5f 7361 6d70  = trial_num_samp
-0000eca0: 6c65 730a 0a20 2020 2020 2020 2020 2020  les..           
-0000ecb0: 2023 2063 6865 636b 2077 6865 7468 6572   # check whether
-0000ecc0: 2074 6865 2074 7269 616c 2065 706f 6368   the trial epoch
-0000ecd0: 2069 7320 7769 7468 696e 2062 6f75 6e64   is within bound
-0000ece0: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-0000ecf0: 2074 7269 616c 5f73 616d 706c 655f 656e   trial_sample_en
-0000ed00: 6420 3c20 303a 0a20 2020 2020 2020 2020  d < 0:.         
-0000ed10: 2020 2020 2020 2069 6620 286f 7574 5f6f         if (out_o
-0000ed20: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
-0000ed30: 3d20 3120 616e 6420 636f 6e64 6974 696f  = 1 and conditio
-0000ed40: 6e5f 6964 7820 3d3d 2030 2061 6e64 2074  n_idx == 0 and t
-0000ed50: 7269 616c 5f69 6478 203d 3d20 3029 206f  rial_idx == 0) o
-0000ed60: 7220 6f75 745f 6f66 5f62 6f75 6e64 5f6d  r out_of_bound_m
-0000ed70: 6574 686f 6420 3d3d 2032 3a0a 2020 2020  ethod == 2:.    
-0000ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ed90: 6966 2063 6861 6e6e 656c 5f69 6478 203d  if channel_idx =
-0000eda0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0000edb0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0000edc0: 6769 6e67 2e77 6172 6e69 6e67 2827 4361  ging.warning('Ca
-0000edd0: 6e6e 6f74 2065 7874 7261 6374 2074 6865  nnot extract the
-0000ede0: 2074 7269 616c 2077 6974 6820 6f6e 7365   trial with onse
-0000edf0: 7420 2720 2b20 7374 7228 636f 6e64 6974  t ' + str(condit
-0000ee00: 696f 6e73 5f6f 6e73 6574 735b 636f 6e64  ions_onsets[cond
-0000ee10: 6974 696f 6e5f 6964 785d 5b74 7269 616c  ition_idx][trial
-0000ee20: 5f69 6478 5d29 202b 2027 2c20 7468 6520  _idx]) + ', the 
-0000ee30: 656e 6420 6f66 2074 6865 2074 7269 616c  end of the trial
-0000ee40: 2d65 706f 6368 206c 6965 7320 6265 666f  -epoch lies befo
-0000ee50: 7265 2074 6865 2073 7461 7274 206f 6620  re the start of 
-0000ee60: 7468 6520 6461 7461 2d73 6574 2e27 290a  the data-set.').
+0000dc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dc60: 2020 2020 2020 2020 4e6f 6e65 2069 6620          None if 
+0000dc70: 6261 7365 6c69 6e65 5f64 6174 6120 6973  baseline_data is
+0000dc80: 204e 6f6e 6520 656c 7365 2062 6173 656c   None else basel
+0000dc90: 696e 655f 6461 7461 5b63 6861 6e6e 656c  ine_data[channel
+0000dca0: 5f69 6478 2c20 3a2c 203a 5d29 0a20 2020  _idx, :, :]).   
+0000dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dcc0: 2020 2020 2020 2020 2069 6620 6d65 7472           if metr
+0000dcd0: 6963 5f76 616c 7565 2069 7320 6e6f 7420  ic_value is not 
+0000dce0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd00: 2020 2020 2020 6966 206e 6f74 206e 702e        if not np.
+0000dd10: 6973 7363 616c 6172 286d 6574 7269 635f  isscalar(metric_
+0000dd20: 7661 6c75 6529 3a0a 2020 2020 2020 2020  value):.        
+0000dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd40: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000dd50: 696e 672e 6572 726f 7228 2752 6574 7572  ing.error('Retur
+0000dd60: 6e20 6d65 7472 6963 2069 7320 6e6f 7420  n metric is not 
+0000dd70: 7363 616c 6172 2729 0a20 2020 2020 2020  scalar').       
+0000dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd90: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+0000dda0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+0000ddb0: 2752 6574 7572 6e20 6d65 7472 6963 2069  'Return metric i
+0000ddc0: 7320 6e6f 7420 7363 616c 6172 2729 0a20  s not scalar'). 
+0000ddd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dde0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000ddf0: 6574 7269 635f 7661 6c75 6573 5b63 6861  etric_values[cha
+0000de00: 6e6e 656c 5f69 6478 2c20 636f 6e64 6974  nnel_idx, condit
+0000de10: 696f 6e5f 6964 782c 2069 4361 6c6c 6261  ion_idx, iCallba
+0000de20: 636b 5d20 3d20 6d65 7472 6963 5f76 616c  ck] = metric_val
+0000de30: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+0000de40: 2320 7468 6520 6361 6c6c 6261 636b 2068  # the callback h
+0000de50: 6173 2062 6565 6e20 6d61 6465 2c20 7065  as been made, pe
+0000de60: 7266 6f72 6d20 2d69 6620 6e65 6564 6564  rform -if needed
+0000de70: 2d20 7468 6520 2870 6f73 7470 6f6e 6564  - the (postponed
+0000de80: 2920 6e6f 726d 616c 697a 6174 696f 6e20  ) normalization 
+0000de90: 7769 7468 2074 6865 2062 6173 656c 696e  with the baselin
+0000dea0: 6520 7661 6c75 6573 0a20 2020 2020 2020  e values.       
+0000deb0: 2020 2020 2069 6620 6261 7365 6c69 6e65       if baseline
+0000dec0: 5f6d 6574 686f 6420 3d3d 2031 3a0a 2020  _method == 1:.  
+0000ded0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000dee0: 6e64 6974 696f 6e5f 6461 7461 202d 3d20  ndition_data -= 
+0000def0: 6e70 2e6e 616e 6d65 616e 2862 6173 656c  np.nanmean(basel
+0000df00: 696e 655f 6461 7461 2c20 6178 6973 3d32  ine_data, axis=2
+0000df10: 295b 3a2c 203a 2c20 4e6f 6e65 5d0a 2020  )[:, :, None].  
+0000df20: 2020 2020 2020 2020 2020 656c 6966 2062            elif b
+0000df30: 6173 656c 696e 655f 6d65 7468 6f64 203d  aseline_method =
+0000df40: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
+0000df50: 2020 2020 2063 6f6e 6469 7469 6f6e 5f64       condition_d
+0000df60: 6174 6120 2d3d 206e 702e 6e61 6e6d 6564  ata -= np.nanmed
+0000df70: 6961 6e28 6261 7365 6c69 6e65 5f64 6174  ian(baseline_dat
+0000df80: 612c 2061 7869 733d 3229 5b3a 2c20 3a2c  a, axis=2)[:, :,
+0000df90: 204e 6f6e 655d 0a0a 2020 2020 2020 2020   None]..        
+0000dfa0: 2320 6176 6572 6167 6520 7468 6520 7472  # average the tr
+0000dfb0: 6961 6c73 2066 6f72 2065 6163 6820 6368  ials for each ch
+0000dfc0: 616e 6e65 6c20 2877 6974 6869 6e20 7468  annel (within th
+0000dfd0: 6973 2063 6f6e 6469 7469 6f6e 2920 616e  is condition) an
+0000dfe0: 6420 7374 6f72 6520 7468 6520 7265 7375  d store the resu
+0000dff0: 6c74 730a 2020 2020 2020 2020 6461 7461  lts.        data
+0000e000: 5b3a 2c20 636f 6e64 6974 696f 6e5f 6964  [:, condition_id
+0000e010: 782c 203a 5d20 3d20 6e70 2e6e 616e 6d65  x, :] = np.nanme
+0000e020: 616e 2863 6f6e 6469 7469 6f6e 5f64 6174  an(condition_dat
+0000e030: 612c 2061 7869 733d 3129 0a0a 2020 2020  a, axis=1)..    
+0000e040: 2020 2020 2320 636c 6561 7220 7265 6665      # clear refe
+0000e050: 7265 6e63 6520 746f 2064 6174 610a 2020  rence to data.  
+0000e060: 2020 2020 2020 6465 6c20 636f 6e64 6974        del condit
+0000e070: 696f 6e5f 6461 7461 2c20 7472 6961 6c5f  ion_data, trial_
+0000e080: 6461 7461 0a0a 2020 2020 2020 2020 2320  data..        # 
+0000e090: 7570 6461 7465 2070 726f 6772 6573 7320  update progress 
+0000e0a0: 6261 720a 2020 2020 2020 2020 7072 696e  bar.        prin
+0000e0b0: 745f 7072 6f67 7265 7373 6261 7228 636f  t_progressbar(co
+0000e0c0: 6e64 6974 696f 6e5f 6964 7820 2b20 312c  ndition_idx + 1,
+0000e0d0: 206c 656e 2863 6f6e 6469 7469 6f6e 735f   len(conditions_
+0000e0e0: 6f6e 7365 7473 292c 2070 7265 6669 783d  onsets), prefix=
+0000e0f0: 2750 726f 6772 6573 733a 272c 2073 7566  'Progress:', suf
+0000e100: 6669 783d 2743 6f6d 706c 6574 6527 2c20  fix='Complete', 
+0000e110: 6c65 6e67 7468 3d35 3029 0a0a 2020 2020  length=50)..    
+0000e120: 2320 7265 7475 726e 2074 6865 2073 616d  # return the sam
+0000e130: 706c 6520 7261 7465 2c20 7468 6520 6176  ple rate, the av
+0000e140: 6572 6167 6520 6570 6f63 6820 616e 6420  erage epoch and 
+0000e150: 7468 6520 6d65 7472 6963 2076 616c 7565  the metric value
+0000e160: 7320 284e 6f6e 6520 6966 206e 6f20 6d65  s (None if no me
+0000e170: 7472 6963 7329 0a20 2020 2072 6574 7572  trics).    retur
+0000e180: 6e20 6461 7461 5f72 6561 6465 722e 7361  n data_reader.sa
+0000e190: 6d70 6c69 6e67 5f72 6174 652c 2064 6174  mpling_rate, dat
+0000e1a0: 612c 206d 6574 7269 635f 7661 6c75 6573  a, metric_values
+0000e1b0: 0a0a 0a64 6566 205f 5f73 7562 6c6f 6164  ...def __subload
+0000e1c0: 5f64 6174 615f 6570 6f63 685f 6176 6572  _data_epoch_aver
+0000e1d0: 6167 6573 5f5f 6672 6f6d 5f63 6861 6e6e  ages__from_chann
+0000e1e0: 656c 5f5f 6279 5f63 6f6e 6469 7469 6f6e  el__by_condition
+0000e1f0: 5f74 7269 616c 7328 7265 665f 6461 7461  _trials(ref_data
+0000e200: 2c20 7265 665f 6d65 7472 6963 5f76 616c  , ref_metric_val
+0000e210: 7565 732c 2064 6174 615f 7265 6164 6572  ues, data_reader
+0000e220: 2c20 6368 616e 6e65 6c5f 6964 782c 2063  , channel_idx, c
+0000e230: 6861 6e6e 656c 5f6e 616d 652c 2063 6861  hannel_name, cha
+0000e240: 6e6e 656c 5f64 6174 612c 2063 6f6e 6469  nnel_data, condi
+0000e250: 7469 6f6e 735f 6f6e 7365 7473 2c0a 2020  tions_onsets,.  
+0000e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e2a0: 2020 2074 7269 616c 5f6e 756d 5f73 616d     trial_num_sam
+0000e2b0: 706c 6573 2c20 7472 6961 6c5f 6570 6f63  ples, trial_epoc
+0000e2c0: 682c 2062 6173 656c 696e 655f 6e75 6d5f  h, baseline_num_
+0000e2d0: 7361 6d70 6c65 732c 2062 6173 656c 696e  samples, baselin
+0000e2e0: 655f 6d65 7468 6f64 2c0a 2020 2020 2020  e_method,.      
+0000e2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e320: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000e330: 6173 656c 696e 655f 6570 6f63 682c 206f  aseline_epoch, o
+0000e340: 7574 5f6f 665f 626f 756e 645f 6d65 7468  ut_of_bound_meth
+0000e350: 6f64 2c20 6d65 7472 6963 5f63 616c 6c62  od, metric_callb
+0000e360: 6163 6b73 293a 0a20 2020 2022 2222 0a20  acks):.    """. 
+0000e370: 2020 2053 7461 7274 696e 6720 6672 6f6d     Starting from
+0000e380: 2061 2073 7065 6369 6669 6320 6368 616e   a specific chan
+0000e390: 6e65 6c2c 206c 6f61 6420 6461 7461 2065  nel, load data e
+0000e3a0: 706f 6368 2061 7665 7261 6765 7320 746f  poch averages to
+0000e3b0: 2061 6e20 616c 7265 6164 7920 6578 6973   an already exis
+0000e3c0: 7469 6e67 2f69 6e69 7469 616c 697a 6564  ting/initialized
+0000e3d0: 0a20 2020 206d 6174 7269 7820 2866 6f72  .    matrix (for
+0000e3e0: 6d61 743a 2063 6861 6e6e 656c 2078 2063  mat: channel x c
+0000e3f0: 6f6e 6469 7469 6f6e 2078 2074 696d 6529  ondition x time)
+0000e400: 2062 7920 6c6f 6f70 696e 6720 6f76 6572   by looping over
+0000e410: 2063 6f6e 6469 7469 6f6e 7320 616e 6420   conditions and 
+0000e420: 7468 656e 2077 6974 6869 6e20 7468 6174  then within that
+0000e430: 2063 6861 6e6e 656c 2d63 6f6e 6469 7469   channel-conditi
+0000e440: 6f6e 0a20 2020 2063 6f6d 6269 6e61 7469  on.    combinati
+0000e450: 6f6e 206c 6f6f 7020 6f76 6572 2065 6163  on loop over eac
+0000e460: 6820 6f66 2074 6865 2074 7269 616c 7320  h of the trials 
+0000e470: 746f 206c 6f61 6420 7468 6520 7370 6563  to load the spec
+0000e480: 6966 6963 2063 6861 6e6e 656c 2d63 6f6e  ific channel-con
+0000e490: 6469 7469 6f6e 2d74 7269 616c 2064 6174  dition-trial dat
+0000e4a0: 612e 0a0a 2020 2020 7265 665f 6461 7461  a...    ref_data
+0000e4b0: 203a 2052 6566 6572 656e 6365 2074 6f20   : Reference to 
+0000e4c0: 7468 6520 6e75 6d70 7920 6d61 7472 6978  the numpy matrix
+0000e4d0: 2074 6861 7420 686f 6c64 7320 616c 6c20   that holds all 
+0000e4e0: 7468 6520 6570 6f63 6820 6176 6572 6167  the epoch averag
+0000e4f0: 6573 2e20 5265 6665 7265 6e63 6520 6973  es. Reference is
+0000e500: 2061 6c73 6f20 7265 7475 726e 6564 206f   also returned o
+0000e510: 6e20 7375 6363 6573 730a 2020 2020 7265  n success.    re
+0000e520: 665f 6d65 7472 6963 5f76 616c 7565 733a  f_metric_values:
+0000e530: 2052 6566 6572 656e 6365 2074 6f20 7468   Reference to th
+0000e540: 6520 2e2e 2e20 7468 6174 2068 6f6c 6473  e ... that holds
+0000e550: 2061 6c6c 2074 6865 206d 6574 7269 6320   all the metric 
+0000e560: 7661 6c75 6573 2e20 5265 6665 7265 6e63  values. Referenc
+0000e570: 6520 6973 2061 6c73 6f20 7265 7475 726e  e is also return
+0000e580: 6564 206f 6e20 7375 6363 6573 730a 0a20  ed on success.. 
+0000e590: 2020 2022 2222 0a0a 2020 2020 6966 2063     """..    if c
+0000e5a0: 6861 6e6e 656c 5f64 6174 6120 6973 204e  hannel_data is N
+0000e5b0: 6f6e 653a 0a20 2020 2020 2020 2063 6861  one:.        cha
+0000e5c0: 6e6e 656c 5f6e 756d 5f73 616d 706c 6573  nnel_num_samples
+0000e5d0: 203d 2064 6174 615f 7265 6164 6572 2e6e   = data_reader.n
+0000e5e0: 756d 5f73 616d 706c 6573 0a20 2020 2065  um_samples.    e
+0000e5f0: 6c73 653a 0a20 2020 2020 2020 2063 6861  lse:.        cha
+0000e600: 6e6e 656c 5f6e 756d 5f73 616d 706c 6573  nnel_num_samples
+0000e610: 203d 2063 6861 6e6e 656c 5f64 6174 612e   = channel_data.
+0000e620: 7369 7a65 0a0a 2020 2020 2320 6c6f 6f70  size..    # loop
+0000e630: 2074 6872 6f75 6768 2074 6865 2063 6f6e   through the con
+0000e640: 6469 7469 6f6e 730a 2020 2020 666f 7220  ditions.    for 
+0000e650: 636f 6e64 6974 696f 6e5f 6964 7820 696e  condition_idx in
+0000e660: 2072 616e 6765 286c 656e 2863 6f6e 6469   range(len(condi
+0000e670: 7469 6f6e 735f 6f6e 7365 7473 2929 3a0a  tions_onsets)):.
+0000e680: 0a20 2020 2020 2020 2023 2069 6e69 7469  .        # initi
+0000e690: 616c 697a 6520 6120 6275 6666 6572 2074  alize a buffer t
+0000e6a0: 6f20 7075 7420 616c 6c20 7468 6520 6461  o put all the da
+0000e6b0: 7461 2066 6f72 2074 6869 7320 636f 6e64  ta for this cond
+0000e6c0: 6974 696f 6e2d 6368 616e 6e65 6c20 696e  ition-channel in
+0000e6d0: 2028 7472 6961 6c73 2078 2073 616d 706c   (trials x sampl
+0000e6e0: 6573 290a 2020 2020 2020 2020 7472 793a  es).        try:
+0000e6f0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+0000e700: 6469 7469 6f6e 5f63 6861 6e6e 656c 5f64  dition_channel_d
+0000e710: 6174 6120 3d20 616c 6c6f 6361 7465 5f61  ata = allocate_a
+0000e720: 7272 6179 2828 6c65 6e28 636f 6e64 6974  rray((len(condit
+0000e730: 696f 6e73 5f6f 6e73 6574 735b 636f 6e64  ions_onsets[cond
+0000e740: 6974 696f 6e5f 6964 785d 292c 2074 7269  ition_idx]), tri
+0000e750: 616c 5f6e 756d 5f73 616d 706c 6573 2929  al_num_samples))
+0000e760: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000e770: 4d65 6d6f 7279 4572 726f 723a 0a20 2020  MemoryError:.   
+0000e780: 2020 2020 2020 2020 2072 6169 7365 204d           raise M
+0000e790: 656d 6f72 7945 7272 6f72 2827 4e6f 7420  emoryError('Not 
+0000e7a0: 656e 6f75 6768 206d 656d 6f72 7920 6372  enough memory cr
+0000e7b0: 6561 7465 2061 2074 656d 706f 7261 7279  eate a temporary
+0000e7c0: 2063 6f6e 6469 7469 6f6e 2d63 6861 6e6e   condition-chann
+0000e7d0: 656c 2064 6174 6120 6d61 7472 6978 2729  el data matrix')
+0000e7e0: 0a0a 2020 2020 2020 2020 2320 6966 2062  ..        # if b
+0000e7f0: 6173 656c 696e 6520 6e6f 726d 616c 697a  aseline normaliz
+0000e800: 6174 696f 6e20 6973 206e 6565 6465 6420  ation is needed 
+0000e810: 616e 6420 7468 6520 7072 652d 6176 6572  and the pre-aver
+0000e820: 6167 6520 6361 6c6c 6261 636b 2066 756e  age callback fun
+0000e830: 6374 696f 6e20 6973 2064 6566 696e 6564  ction is defined
+0000e840: 2c20 7468 656e 2077 6520 6669 7273 740a  , then we first.
+0000e850: 2020 2020 2020 2020 2320 6e65 6564 2074          # need t
+0000e860: 6f20 6163 6375 6d75 6c61 7465 2074 6865  o accumulate the
+0000e870: 2066 756c 6c20 2869 2e65 2e20 6368 616e   full (i.e. chan
+0000e880: 6e65 6c73 2078 2074 7269 616c 7320 7820  nels x trials x 
+0000e890: 6570 6f63 6829 2075 6e2d 6e6f 726d 616c  epoch) un-normal
+0000e8a0: 697a 6564 2073 7562 7365 7420 746f 2070  ized subset to p
+0000e8b0: 726f 7669 6465 2074 6f20 7468 650a 2020  rovide to the.  
+0000e8c0: 2020 2020 2020 2320 6675 6e63 7469 6f6e        # function
+0000e8d0: 2e20 5468 6572 6566 6f72 652c 2077 6520  . Therefore, we 
+0000e8e0: 696e 6974 6961 6c69 7a65 2061 6e20 6172  initialize an ar
+0000e8f0: 7261 7920 746f 2073 746f 7265 2074 6865  ray to store the
+0000e900: 2062 6173 656c 696e 6520 7661 6c75 6573   baseline values
+0000e910: 2066 6f72 2065 6163 6820 6368 616e 6e65   for each channe
+0000e920: 6c20 7820 7472 6961 6c2c 2073 6f0a 2020  l x trial, so.  
+0000e930: 2020 2020 2020 2320 7765 2063 616e 206e        # we can n
+0000e940: 6f72 6d61 6c69 7a65 2061 6674 6572 2074  ormalize after t
+0000e950: 6865 2063 616c 6c62 6163 6b0a 2020 2020  he callback.    
+0000e960: 2020 2020 6261 7365 6c69 6e65 5f64 6174      baseline_dat
+0000e970: 6120 3d20 4e6f 6e65 0a20 2020 2020 2020  a = None.       
+0000e980: 2069 6620 6e6f 7420 6261 7365 6c69 6e65   if not baseline
+0000e990: 5f6d 6574 686f 6420 3d3d 2030 2061 6e64  _method == 0 and
+0000e9a0: 206d 6574 7269 635f 6361 6c6c 6261 636b   metric_callback
+0000e9b0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+0000e9c0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0000e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e9e0: 6261 7365 6c69 6e65 5f64 6174 6120 3d20  baseline_data = 
+0000e9f0: 616c 6c6f 6361 7465 5f61 7272 6179 2828  allocate_array((
+0000ea00: 6c65 6e28 636f 6e64 6974 696f 6e73 5f6f  len(conditions_o
+0000ea10: 6e73 6574 735b 636f 6e64 6974 696f 6e5f  nsets[condition_
+0000ea20: 6964 785d 292c 2062 6173 656c 696e 655f  idx]), baseline_
+0000ea30: 6e75 6d5f 7361 6d70 6c65 7329 290a 2020  num_samples)).  
+0000ea40: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0000ea50: 204d 656d 6f72 7945 7272 6f72 3a0a 2020   MemoryError:.  
+0000ea60: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+0000ea70: 6973 6520 4d65 6d6f 7279 4572 726f 7228  ise MemoryError(
+0000ea80: 274e 6f74 2065 6e6f 7567 6820 6d65 6d6f  'Not enough memo
+0000ea90: 7279 2063 7265 6174 6520 6120 7465 6d70  ry create a temp
+0000eaa0: 6f72 6172 7920 636f 6e64 6974 696f 6e2d  orary condition-
+0000eab0: 6368 616e 6e65 6c20 6261 7365 6c69 6e65  channel baseline
+0000eac0: 2064 6174 6120 6d61 7472 6978 2729 0a0a   data matrix')..
+0000ead0: 2020 2020 2020 2020 2320 6c6f 6f70 2074          # loop t
+0000eae0: 6872 6f75 6768 2074 6865 2074 7269 616c  hrough the trial
+0000eaf0: 7320 696e 2074 6865 2063 6f6e 6469 7469  s in the conditi
+0000eb00: 6f6e 0a20 2020 2020 2020 2066 6f72 2074  on.        for t
+0000eb10: 7269 616c 5f69 6478 2069 6e20 7261 6e67  rial_idx in rang
+0000eb20: 6528 6c65 6e28 636f 6e64 6974 696f 6e73  e(len(conditions
+0000eb30: 5f6f 6e73 6574 735b 636f 6e64 6974 696f  _onsets[conditio
+0000eb40: 6e5f 6964 785d 2929 3a0a 0a20 2020 2020  n_idx])):..     
+0000eb50: 2020 2020 2020 2023 2063 616c 6375 6c61         # calcula
+0000eb60: 7465 2074 6865 2073 616d 706c 6520 696e  te the sample in
+0000eb70: 6469 6365 730a 2020 2020 2020 2020 2020  dices.          
+0000eb80: 2020 7472 6961 6c5f 7361 6d70 6c65 5f73    trial_sample_s
+0000eb90: 7461 7274 203d 2069 6e74 2872 6f75 6e64  tart = int(round
+0000eba0: 2828 636f 6e64 6974 696f 6e73 5f6f 6e73  ((conditions_ons
+0000ebb0: 6574 735b 636f 6e64 6974 696f 6e5f 6964  ets[condition_id
+0000ebc0: 785d 5b74 7269 616c 5f69 6478 5d20 2b20  x][trial_idx] + 
+0000ebd0: 7472 6961 6c5f 6570 6f63 685b 305d 2920  trial_epoch[0]) 
+0000ebe0: 2a20 6461 7461 5f72 6561 6465 722e 7361  * data_reader.sa
+0000ebf0: 6d70 6c69 6e67 5f72 6174 6529 290a 2020  mpling_rate)).  
+0000ec00: 2020 2020 2020 2020 2020 7472 6961 6c5f            trial_
+0000ec10: 7361 6d70 6c65 5f65 6e64 203d 2074 7269  sample_end = tri
+0000ec20: 616c 5f73 616d 706c 655f 7374 6172 7420  al_sample_start 
+0000ec30: 2b20 7472 6961 6c5f 6e75 6d5f 7361 6d70  + trial_num_samp
+0000ec40: 6c65 730a 2020 2020 2020 2020 2020 2020  les.            
+0000ec50: 6261 7365 6c69 6e65 5f73 7461 7274 5f73  baseline_start_s
+0000ec60: 616d 706c 6520 3d20 696e 7428 726f 756e  ample = int(roun
+0000ec70: 6428 2863 6f6e 6469 7469 6f6e 735f 6f6e  d((conditions_on
+0000ec80: 7365 7473 5b63 6f6e 6469 7469 6f6e 5f69  sets[condition_i
+0000ec90: 6478 5d5b 7472 6961 6c5f 6964 785d 202b  dx][trial_idx] +
+0000eca0: 2062 6173 656c 696e 655f 6570 6f63 685b   baseline_epoch[
+0000ecb0: 305d 2920 2a20 6461 7461 5f72 6561 6465  0]) * data_reade
+0000ecc0: 722e 7361 6d70 6c69 6e67 5f72 6174 6529  r.sampling_rate)
+0000ecd0: 290a 2020 2020 2020 2020 2020 2020 6261  ).            ba
+0000ece0: 7365 6c69 6e65 5f65 6e64 5f73 616d 706c  seline_end_sampl
+0000ecf0: 6520 3d20 6261 7365 6c69 6e65 5f73 7461  e = baseline_sta
+0000ed00: 7274 5f73 616d 706c 6520 2b20 6261 7365  rt_sample + base
+0000ed10: 6c69 6e65 5f6e 756d 5f73 616d 706c 6573  line_num_samples
+0000ed20: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
+0000ed30: 616c 5f73 7461 7274 203d 2030 0a20 2020  al_start = 0.   
+0000ed40: 2020 2020 2020 2020 206c 6f63 616c 5f65           local_e
+0000ed50: 6e64 203d 2074 7269 616c 5f6e 756d 5f73  nd = trial_num_s
+0000ed60: 616d 706c 6573 0a0a 2020 2020 2020 2020  amples..        
+0000ed70: 2020 2020 2320 6368 6563 6b20 7768 6574      # check whet
+0000ed80: 6865 7220 7468 6520 7472 6961 6c20 6570  her the trial ep
+0000ed90: 6f63 6820 6973 2077 6974 6869 6e20 626f  och is within bo
+0000eda0: 756e 6473 0a20 2020 2020 2020 2020 2020  unds.           
+0000edb0: 2069 6620 7472 6961 6c5f 7361 6d70 6c65   if trial_sample
+0000edc0: 5f65 6e64 203c 2030 3a0a 2020 2020 2020  _end < 0:.      
+0000edd0: 2020 2020 2020 2020 2020 6966 2028 6f75            if (ou
+0000ede0: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
+0000edf0: 6420 3d3d 2031 2061 6e64 2063 6f6e 6469  d == 1 and condi
+0000ee00: 7469 6f6e 5f69 6478 203d 3d20 3020 616e  tion_idx == 0 an
+0000ee10: 6420 7472 6961 6c5f 6964 7820 3d3d 2030  d trial_idx == 0
+0000ee20: 2920 6f72 206f 7574 5f6f 665f 626f 756e  ) or out_of_boun
+0000ee30: 645f 6d65 7468 6f64 203d 3d20 323a 0a20  d_method == 2:. 
+0000ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ee50: 2020 2069 6620 6368 616e 6e65 6c5f 6964     if channel_id
+0000ee60: 7820 3d3d 2030 3a0a 2020 2020 2020 2020  x == 0:.        
 0000ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee80: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-0000ee90: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000eea0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000eeb0: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
-0000eec0: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
-0000eed0: 7261 6374 2074 6865 2074 7269 616c 2077  ract the trial w
-0000eee0: 6974 6820 6f6e 7365 7420 2720 2b20 7374  ith onset ' + st
-0000eef0: 7228 636f 6e64 6974 696f 6e73 5f6f 6e73  r(conditions_ons
-0000ef00: 6574 735b 636f 6e64 6974 696f 6e5f 6964  ets[condition_id
-0000ef10: 785d 5b74 7269 616c 5f69 6478 5d29 202b  x][trial_idx]) +
-0000ef20: 2027 2c20 7468 6520 656e 6420 6f66 2074   ', the end of t
-0000ef30: 6865 2074 7269 616c 2d65 706f 6368 206c  he trial-epoch l
-0000ef40: 6965 7320 6265 666f 7265 2074 6865 2073  ies before the s
-0000ef50: 7461 7274 206f 6620 7468 6520 6461 7461  tart of the data
-0000ef60: 2d73 6574 2e20 5573 6520 6120 6469 6666  -set. Use a diff
-0000ef70: 6572 656e 7420 6f75 745f 6f66 5f62 6f75  erent out_of_bou
-0000ef80: 6e64 5f68 616e 646c 696e 6720 6172 6775  nd_handling argu
-0000ef90: 6d65 6e74 2074 6f20 616c 6c6f 7720 6f75  ment to allow ou
-0000efa0: 742d 6f66 2d62 6f75 6e64 2074 7269 616c  t-of-bound trial
-0000efb0: 2065 706f 6368 7327 290a 2020 2020 2020   epochs').      
-0000efc0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000efd0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-0000efe0: 2827 4361 6e6e 6f74 2065 7874 7261 6374  ('Cannot extract
-0000eff0: 2074 7269 616c 2729 0a20 2020 2020 2020   trial').       
-0000f000: 2020 2020 2069 6620 7472 6961 6c5f 7361       if trial_sa
-0000f010: 6d70 6c65 5f73 7461 7274 203c 2030 3a0a  mple_start < 0:.
-0000f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f030: 6966 2028 6f75 745f 6f66 5f62 6f75 6e64  if (out_of_bound
-0000f040: 5f6d 6574 686f 6420 3d3d 2031 2061 6e64  _method == 1 and
-0000f050: 2063 6f6e 6469 7469 6f6e 5f69 6478 203d   condition_idx =
-0000f060: 3d20 3020 616e 6420 7472 6961 6c5f 6964  = 0 and trial_id
-0000f070: 7820 3d3d 2030 2920 6f72 206f 7574 5f6f  x == 0) or out_o
-0000f080: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
-0000f090: 3d20 323a 0a20 2020 2020 2020 2020 2020  = 2:.           
-0000f0a0: 2020 2020 2020 2020 2069 6620 6368 616e           if chan
-0000f0b0: 6e65 6c5f 6964 7820 3d3d 2030 3a0a 2020  nel_idx == 0:.  
-0000f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0d0: 2020 2020 2020 6c6f 6767 696e 672e 7761        logging.wa
-0000f0e0: 726e 696e 6728 2743 616e 6e6f 7420 6578  rning('Cannot ex
-0000f0f0: 7472 6163 7420 7468 6520 7472 6961 6c20  tract the trial 
-0000f100: 7769 7468 206f 6e73 6574 2027 202b 2073  with onset ' + s
-0000f110: 7472 2863 6f6e 6469 7469 6f6e 735f 6f6e  tr(conditions_on
-0000f120: 7365 7473 5b63 6f6e 6469 7469 6f6e 5f69  sets[condition_i
-0000f130: 6478 5d5b 7472 6961 6c5f 6964 785d 2920  dx][trial_idx]) 
-0000f140: 2b20 272c 2074 6865 2073 7461 7274 206f  + ', the start o
-0000f150: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
-0000f160: 6820 6c69 6573 2062 6566 6f72 6520 7468  h lies before th
-0000f170: 6520 7374 6172 7420 6f66 2074 6865 2064  e start of the d
-0000f180: 6174 612d 7365 742e 2729 0a20 2020 2020  ata-set.').     
-0000f190: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0000f1a0: 6f63 616c 5f73 7461 7274 203d 2074 7269  ocal_start = tri
-0000f1b0: 616c 5f73 616d 706c 655f 7374 6172 7420  al_sample_start 
-0000f1c0: 2a20 2d31 0a20 2020 2020 2020 2020 2020  * -1.           
-0000f1d0: 2020 2020 2020 2020 2074 7269 616c 5f73           trial_s
-0000f1e0: 616d 706c 655f 7374 6172 7420 3d20 300a  ample_start = 0.
-0000f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f200: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000f210: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-0000f220: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
-0000f230: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
-0000f240: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
-0000f250: 2073 7472 2863 6f6e 6469 7469 6f6e 735f   str(conditions_
-0000f260: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
-0000f270: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
-0000f280: 2920 2b20 272c 2074 6865 2073 7461 7274  ) + ', the start
-0000f290: 206f 6620 7468 6520 7472 6961 6c2d 6570   of the trial-ep
-0000f2a0: 6f63 6820 6c69 6573 2062 6566 6f72 6520  och lies before 
-0000f2b0: 7468 6520 7374 6172 7420 6f66 2074 6865  the start of the
-0000f2c0: 2064 6174 612d 7365 742e 2055 7365 2061   data-set. Use a
-0000f2d0: 2064 6966 6665 7265 6e74 206f 7574 5f6f   different out_o
-0000f2e0: 665f 626f 756e 645f 6861 6e64 6c69 6e67  f_bound_handling
-0000f2f0: 2061 7267 756d 656e 7420 746f 2061 6c6c   argument to all
-0000f300: 6f77 206f 7574 2d6f 662d 626f 756e 6420  ow out-of-bound 
-0000f310: 7472 6961 6c20 6570 6f63 6873 2729 0a20  trial epochs'). 
-0000f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f330: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-0000f340: 4572 726f 7228 2743 616e 6e6f 7420 6578  Error('Cannot ex
-0000f350: 7472 6163 7420 7472 6961 6c27 290a 2020  tract trial').  
-0000f360: 2020 2020 2020 2020 2020 6966 2074 7269            if tri
-0000f370: 616c 5f73 616d 706c 655f 7374 6172 7420  al_sample_start 
-0000f380: 3e20 6368 616e 6e65 6c5f 6e75 6d5f 7361  > channel_num_sa
-0000f390: 6d70 6c65 733a 0a20 2020 2020 2020 2020  mples:.         
-0000f3a0: 2020 2020 2020 2069 6620 286f 7574 5f6f         if (out_o
-0000f3b0: 665f 626f 756e 645f 6d65 7468 6f64 203d  f_bound_method =
-0000f3c0: 3d20 3120 616e 6420 636f 6e64 6974 696f  = 1 and conditio
-0000f3d0: 6e5f 6964 7820 3d3d 206c 656e 2863 6f6e  n_idx == len(con
-0000f3e0: 6469 7469 6f6e 735f 6f6e 7365 7473 2920  ditions_onsets) 
-0000f3f0: 2d20 3120 616e 6420 7472 6961 6c5f 6964  - 1 and trial_id
-0000f400: 7820 3d3d 206c 656e 280a 2020 2020 2020  x == len(.      
-0000f410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f420: 2020 636f 6e64 6974 696f 6e73 5f6f 6e73    conditions_ons
-0000f430: 6574 735b 636f 6e64 6974 696f 6e5f 6964  ets[condition_id
-0000f440: 785d 2920 2d20 3129 206f 7220 6f75 745f  x]) - 1) or out_
-0000f450: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6420  of_bound_method 
-0000f460: 3d3d 2032 3a0a 2020 2020 2020 2020 2020  == 2:.          
-0000f470: 2020 2020 2020 2020 2020 6966 2063 6861            if cha
-0000f480: 6e6e 656c 5f69 6478 203d 3d20 303a 0a20  nnel_idx == 0:. 
-0000f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f4a0: 2020 2020 2020 206c 6f67 6769 6e67 2e77         logging.w
-0000f4b0: 6172 6e69 6e67 2827 4361 6e6e 6f74 2065  arning('Cannot e
-0000f4c0: 7874 7261 6374 2074 6865 2074 7269 616c  xtract the trial
-0000f4d0: 2077 6974 6820 6f6e 7365 7420 2720 2b20   with onset ' + 
-0000f4e0: 7374 7228 636f 6e64 6974 696f 6e73 5f6f  str(conditions_o
-0000f4f0: 6e73 6574 735b 636f 6e64 6974 696f 6e5f  nsets[condition_
-0000f500: 6964 785d 5b74 7269 616c 5f69 6478 5d29  idx][trial_idx])
-0000f510: 202b 2027 2c20 7468 6520 7374 6172 7420   + ', the start 
-0000f520: 6f66 2074 6865 2074 7269 616c 2d65 706f  of the trial-epo
-0000f530: 6368 206c 6965 7320 6166 7465 7220 7468  ch lies after th
-0000f540: 6520 656e 6420 6f66 2074 6865 2064 6174  e end of the dat
-0000f550: 612d 7365 742e 2729 0a20 2020 2020 2020  a-set.').       
-0000f560: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000f570: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-0000f580: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5a0: 6c6f 6767 696e 672e 6572 726f 7228 2743  logging.error('C
-0000f5b0: 616e 6e6f 7420 6578 7472 6163 7420 7468  annot extract th
-0000f5c0: 6520 7472 6961 6c20 7769 7468 206f 6e73  e trial with ons
-0000f5d0: 6574 2027 202b 2073 7472 2863 6f6e 6469  et ' + str(condi
-0000f5e0: 7469 6f6e 735f 6f6e 7365 7473 5b63 6f6e  tions_onsets[con
-0000f5f0: 6469 7469 6f6e 5f69 6478 5d5b 7472 6961  dition_idx][tria
-0000f600: 6c5f 6964 785d 2920 2b20 272c 2074 6865  l_idx]) + ', the
-0000f610: 2073 7461 7274 206f 6620 7468 6520 7472   start of the tr
-0000f620: 6961 6c2d 6570 6f63 6820 6c69 6573 2061  ial-epoch lies a
-0000f630: 6674 6572 2074 6865 2065 6e64 206f 6620  fter the end of 
-0000f640: 7468 6520 6461 7461 2d73 6574 2e20 5573  the data-set. Us
-0000f650: 6520 6120 6469 6666 6572 656e 7420 6f75  e a different ou
-0000f660: 745f 6f66 5f62 6f75 6e64 5f68 616e 646c  t_of_bound_handl
-0000f670: 696e 6720 6172 6775 6d65 6e74 2074 6f20  ing argument to 
-0000f680: 616c 6c6f 7720 6f75 742d 6f66 2d62 6f75  allow out-of-bou
-0000f690: 6e64 2074 7269 616c 2065 706f 6368 7327  nd trial epochs'
-0000f6a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000f6b0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-0000f6c0: 696d 6545 7272 6f72 2827 4361 6e6e 6f74  imeError('Cannot
-0000f6d0: 2065 7874 7261 6374 2074 7269 616c 2729   extract trial')
-0000f6e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000f6f0: 7472 6961 6c5f 7361 6d70 6c65 5f65 6e64  trial_sample_end
-0000f700: 203e 2063 6861 6e6e 656c 5f6e 756d 5f73   > channel_num_s
-0000f710: 616d 706c 6573 3a0a 2020 2020 2020 2020  amples:.        
-0000f720: 2020 2020 2020 2020 6966 2028 6f75 745f          if (out_
-0000f730: 6f66 5f62 6f75 6e64 5f6d 6574 686f 6420  of_bound_method 
-0000f740: 3d3d 2031 2061 6e64 2063 6f6e 6469 7469  == 1 and conditi
-0000f750: 6f6e 5f69 6478 203d 3d20 6c65 6e28 636f  on_idx == len(co
-0000f760: 6e64 6974 696f 6e73 5f6f 6e73 6574 7329  nditions_onsets)
-0000f770: 202d 2031 2061 6e64 2074 7269 616c 5f69   - 1 and trial_i
-0000f780: 6478 203d 3d20 6c65 6e28 0a20 2020 2020  dx == len(.     
-0000f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7a0: 2020 2063 6f6e 6469 7469 6f6e 735f 6f6e     conditions_on
-0000f7b0: 7365 7473 5b63 6f6e 6469 7469 6f6e 5f69  sets[condition_i
-0000f7c0: 6478 5d29 202d 2031 2920 6f72 206f 7574  dx]) - 1) or out
-0000f7d0: 5f6f 665f 626f 756e 645f 6d65 7468 6f64  _of_bound_method
-0000f7e0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-0000f7f0: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
-0000f800: 616e 6e65 6c5f 6964 7820 3d3d 2030 3a0a  annel_idx == 0:.
-0000f810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f820: 2020 2020 2020 2020 6c6f 6767 696e 672e          logging.
-0000f830: 7761 726e 696e 6728 2743 616e 6e6f 7420  warning('Cannot 
-0000f840: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
-0000f850: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
-0000f860: 2073 7472 2863 6f6e 6469 7469 6f6e 735f   str(conditions_
-0000f870: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
-0000f880: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
-0000f890: 2920 2b20 272c 2074 6865 2065 6e64 206f  ) + ', the end o
-0000f8a0: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
-0000f8b0: 6820 6c69 6573 2061 6674 6572 2074 6865  h lies after the
-0000f8c0: 2065 6e64 206f 6620 7468 6520 6461 7461   end of the data
-0000f8d0: 2d73 6574 2e27 290a 2020 2020 2020 2020  -set.').        
-0000f8e0: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
-0000f8f0: 6c5f 656e 6420 3d20 7472 6961 6c5f 6e75  l_end = trial_nu
-0000f900: 6d5f 7361 6d70 6c65 7320 2d20 2874 7269  m_samples - (tri
-0000f910: 616c 5f73 616d 706c 655f 656e 6420 2d20  al_sample_end - 
-0000f920: 6368 616e 6e65 6c5f 6e75 6d5f 7361 6d70  channel_num_samp
-0000f930: 6c65 7329 0a20 2020 2020 2020 2020 2020  les).           
-0000f940: 2020 2020 2020 2020 2074 7269 616c 5f73           trial_s
-0000f950: 616d 706c 655f 656e 6420 3d20 6368 616e  ample_end = chan
-0000f960: 6e65 6c5f 6e75 6d5f 7361 6d70 6c65 730a  nel_num_samples.
-0000f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f980: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0000f990: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
-0000f9a0: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
-0000f9b0: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
-0000f9c0: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
-0000f9d0: 2073 7472 2863 6f6e 6469 7469 6f6e 735f   str(conditions_
-0000f9e0: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
-0000f9f0: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
-0000fa00: 2920 2b20 272c 2074 6865 2065 6e64 206f  ) + ', the end o
-0000fa10: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
-0000fa20: 6820 6c69 6573 2061 6674 6572 2074 6865  h lies after the
-0000fa30: 2065 6e64 206f 6620 7468 6520 6461 7461   end of the data
-0000fa40: 2d73 6574 2e20 5573 6520 6120 6469 6666  -set. Use a diff
-0000fa50: 6572 656e 7420 6f75 745f 6f66 5f62 6f75  erent out_of_bou
-0000fa60: 6e64 5f68 616e 646c 696e 6720 6172 6775  nd_handling argu
-0000fa70: 6d65 6e74 2074 6f20 616c 6c6f 7720 6f75  ment to allow ou
-0000fa80: 742d 6f66 2d62 6f75 6e64 2074 7269 616c  t-of-bound trial
-0000fa90: 2065 706f 6368 7327 290a 2020 2020 2020   epochs').      
-0000faa0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0000fab0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-0000fac0: 2827 4361 6e6e 6f74 2065 7874 7261 6374  ('Cannot extract
-0000fad0: 2074 7269 616c 2729 0a0a 2020 2020 2020   trial')..      
-0000fae0: 2020 2020 2020 2320 6368 6563 6b20 7768        # check wh
-0000faf0: 6574 6865 7220 7468 6520 6261 7365 6c69  ether the baseli
-0000fb00: 6e65 2069 7320 7769 7468 696e 2062 6f75  ne is within bou
-0000fb10: 6e64 730a 2020 2020 2020 2020 2020 2020  nds.            
-0000fb20: 6966 2062 6173 656c 696e 655f 6d65 7468  if baseline_meth
-0000fb30: 6f64 203e 2030 3a0a 2020 2020 2020 2020  od > 0:.        
-0000fb40: 2020 2020 2020 2020 6966 2062 6173 656c          if basel
-0000fb50: 696e 655f 7374 6172 745f 7361 6d70 6c65  ine_start_sample
-0000fb60: 203c 2030 206f 7220 6261 7365 6c69 6e65   < 0 or baseline
-0000fb70: 5f65 6e64 5f73 616d 706c 6520 3e20 6368  _end_sample > ch
-0000fb80: 616e 6e65 6c5f 6e75 6d5f 7361 6d70 6c65  annel_num_sample
-0000fb90: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000fba0: 2020 2020 2020 206c 6f67 6769 6e67 2e65         logging.e
-0000fbb0: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
-0000fbc0: 7261 6374 2074 6865 2062 6173 656c 696e  ract the baselin
-0000fbd0: 6520 666f 7220 7468 6520 7472 6961 6c20  e for the trial 
-0000fbe0: 7769 7468 206f 6e73 6574 2027 202b 2073  with onset ' + s
-0000fbf0: 7472 2863 6f6e 6469 7469 6f6e 735f 6f6e  tr(conditions_on
-0000fc00: 7365 7473 5b63 6f6e 6469 7469 6f6e 5f69  sets[condition_i
-0000fc10: 6478 5d5b 7472 6961 6c5f 6964 785d 2920  dx][trial_idx]) 
-0000fc20: 2b20 272c 2074 6865 2072 616e 6765 2066  + ', the range f
-0000fc30: 6f72 2074 6865 2062 6173 656c 696e 6520  or the baseline 
-0000fc40: 6c69 6573 206f 7574 7369 6465 206f 6620  lies outside of 
-0000fc50: 7468 6520 6461 7461 2729 0a20 2020 2020  the data').     
-0000fc60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000fc70: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
-0000fc80: 7228 2743 616e 6e6f 7420 6578 7472 6163  r('Cannot extrac
-0000fc90: 7420 6261 7365 6c69 6e65 2729 0a0a 2020  t baseline')..  
-0000fca0: 2020 2020 2020 2020 2020 2320 6578 7472            # extr
-0000fcb0: 6163 7420 7468 6520 7472 6961 6c20 6461  act the trial da
-0000fcc0: 7461 0a20 2020 2020 2020 2020 2020 2023  ta.            #
-0000fcd0: 2063 6865 636b 2069 6620 7468 6520 6368   check if the ch
-0000fce0: 616e 6e65 6c20 6461 7461 2069 7320 7061  annel data is pa
-0000fcf0: 7373 6564 206f 7220 6e65 6564 7320 746f  ssed or needs to
-0000fd00: 2062 6520 7265 7472 6965 7665 640a 2020   be retrieved.  
-0000fd10: 2020 2020 2020 2020 2020 6966 2063 6861            if cha
-0000fd20: 6e6e 656c 5f64 6174 6120 6973 204e 6f6e  nnel_data is Non
-0000fd30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000fd40: 2020 2023 2072 6574 7269 6576 6520 7573     # retrieve us
-0000fd50: 696e 6720 7265 6164 6572 0a0a 2020 2020  ing reader..    
-0000fd60: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000fd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fd80: 2020 2020 2074 7269 616c 5f62 6173 656c       trial_basel
-0000fd90: 696e 655f 6461 7461 203d 2064 6174 615f  ine_data = data_
-0000fda0: 7265 6164 6572 2e72 6574 7269 6576 655f  reader.retrieve_
-0000fdb0: 7361 6d70 6c65 5f72 616e 6765 5f64 6174  sample_range_dat
-0000fdc0: 6128 6368 616e 6e65 6c5f 6e61 6d65 2c20  a(channel_name, 
-0000fdd0: 6261 7365 6c69 6e65 5f73 7461 7274 5f73  baseline_start_s
-0000fde0: 616d 706c 652c 2062 6173 656c 696e 655f  ample, baseline_
-0000fdf0: 656e 645f 7361 6d70 6c65 2c20 4661 6c73  end_sample, Fals
-0000fe00: 6529 5b30 5d0a 2020 2020 2020 2020 2020  e)[0].          
-0000fe10: 2020 2020 2020 2020 2020 7472 6961 6c5f            trial_
-0000fe20: 7472 6961 6c5f 6461 7461 203d 2064 6174  trial_data = dat
-0000fe30: 615f 7265 6164 6572 2e72 6574 7269 6576  a_reader.retriev
-0000fe40: 655f 7361 6d70 6c65 5f72 616e 6765 5f64  e_sample_range_d
-0000fe50: 6174 6128 6368 616e 6e65 6c5f 6e61 6d65  ata(channel_name
-0000fe60: 2c20 7472 6961 6c5f 7361 6d70 6c65 5f73  , trial_sample_s
-0000fe70: 7461 7274 2c20 7472 6961 6c5f 7361 6d70  tart, trial_samp
-0000fe80: 6c65 5f65 6e64 2c20 4661 6c73 6529 5b30  le_end, False)[0
-0000fe90: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0000fea0: 2020 6578 6365 7074 2028 5275 6e74 696d    except (Runtim
-0000feb0: 6545 7272 6f72 2c20 4c6f 6f6b 7570 4572  eError, LookupEr
-0000fec0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
-0000fed0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000fee0: 5275 6e74 696d 6545 7272 6f72 2827 436f  RuntimeError('Co
-0000fef0: 756c 6420 6e6f 7420 6c6f 6164 2064 6174  uld not load dat
-0000ff00: 6127 290a 0a20 2020 2020 2020 2020 2020  a')..           
-0000ff10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000ff20: 2020 2020 2020 2023 2072 6574 7269 6576         # retriev
-0000ff30: 6520 6672 6f6d 2070 6173 7365 6420 6368  e from passed ch
-0000ff40: 616e 6e65 6c2d 6461 7461 0a0a 2020 2020  annel-data..    
-0000ff50: 2020 2020 2020 2020 2020 2020 7472 6961              tria
-0000ff60: 6c5f 6261 7365 6c69 6e65 5f64 6174 6120  l_baseline_data 
-0000ff70: 3d20 6368 616e 6e65 6c5f 6461 7461 5b62  = channel_data[b
-0000ff80: 6173 656c 696e 655f 7374 6172 745f 7361  aseline_start_sa
-0000ff90: 6d70 6c65 3a62 6173 656c 696e 655f 656e  mple:baseline_en
-0000ffa0: 645f 7361 6d70 6c65 5d0a 2020 2020 2020  d_sample].      
-0000ffb0: 2020 2020 2020 2020 2020 7472 6961 6c5f            trial_
-0000ffc0: 7472 6961 6c5f 6461 7461 203d 2063 6861  trial_data = cha
-0000ffd0: 6e6e 656c 5f64 6174 615b 7472 6961 6c5f  nnel_data[trial_
-0000ffe0: 7361 6d70 6c65 5f73 7461 7274 3a74 7269  sample_start:tri
-0000fff0: 616c 5f73 616d 706c 655f 656e 645d 0a0a  al_sample_end]..
-00010000: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
-00010010: 6572 666f 726d 2062 6173 656c 696e 6520  erform baseline 
-00010020: 6e6f 726d 616c 697a 6174 696f 6e20 6f6e  normalization on
-00010030: 2074 6865 2074 7269 616c 2069 6620 6e65   the trial if ne
-00010040: 6564 6564 0a20 2020 2020 2020 2020 2020  eded.           
-00010050: 2023 0a20 2020 2020 2020 2020 2020 2023   #.            #
-00010060: 2065 7863 6570 7420 7768 656e 2074 6865   except when the
-00010070: 7265 2069 7320 6120 6675 6e63 7469 6f6e  re is a function
-00010080: 2063 616c 6c62 6163 6b2e 2057 6865 6e20   callback. When 
-00010090: 6120 6361 6c6c 6261 636b 2069 7320 7468  a callback is th
-000100a0: 656e 2077 6520 6e65 6564 2074 6f20 6669  en we need to fi
-000100b0: 7273 7420 6163 6375 6d75 6c61 7465 2074  rst accumulate t
-000100c0: 6865 0a20 2020 2020 2020 2020 2020 2023  he.            #
-000100d0: 2066 756c 6c20 2869 2e65 2e20 6368 616e   full (i.e. chan
-000100e0: 6e65 6c73 2078 2074 7269 616c 7320 7820  nels x trials x 
-000100f0: 6570 6f63 6829 2075 6e2d 6e6f 726d 616c  epoch) un-normal
-00010100: 697a 6564 2073 7562 7365 7420 746f 2070  ized subset to p
-00010110: 726f 7669 6465 2074 6f20 7468 6520 6675  rovide to the fu
-00010120: 6e63 7469 6f6e 2c20 616e 6420 7374 6f72  nction, and stor
-00010130: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-00010140: 7468 6520 6261 7365 6c69 6e65 2076 616c  the baseline val
-00010150: 7565 7320 696e 2061 2073 6570 6172 6174  ues in a separat
-00010160: 6520 6172 7261 792c 2073 6f20 7468 6579  e array, so they
-00010170: 2063 616e 2062 6520 6170 706c 6965 6420   can be applied 
-00010180: 6c61 7465 720a 2020 2020 2020 2020 2020  later.          
-00010190: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
-000101a0: 6966 2062 6173 656c 696e 655f 6d65 7468  if baseline_meth
-000101b0: 6f64 203d 3d20 3020 6f72 206d 6574 7269  od == 0 or metri
-000101c0: 635f 6361 6c6c 6261 636b 7320 6973 206e  c_callbacks is n
-000101d0: 6f74 204e 6f6e 653a 0a0a 2020 2020 2020  ot None:..      
-000101e0: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-000101f0: 3a20 6e6f 7420 7265 6c65 7661 6e74 2077  : not relevant w
-00010200: 6865 7468 6572 2074 6869 7320 6973 2061  hether this is a
-00010210: 206e 756d 7079 2d76 6965 7720 6f72 206e   numpy-view or n
-00010220: 6f74 2c20 7369 6e63 6520 7765 2077 696c  ot, since we wil
-00010230: 6c20 6176 6572 6167 6520 6f76 6572 2074  l average over t
-00010240: 6865 2074 7269 616c 730a 2020 2020 2020  he trials.      
-00010250: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00010260: 2020 6c61 7465 722e 2041 7373 756d 6520    later. Assume 
-00010270: 6d65 7472 6963 5f63 616c 6c62 6163 6b20  metric_callback 
-00010280: 646f 6573 206e 6f74 206d 616e 6970 756c  does not manipul
-00010290: 6174 6520 7468 6520 6461 7461 2069 7420  ate the data it 
-000102a0: 6973 2067 6976 656e 0a20 2020 2020 2020  is given.       
-000102b0: 2020 2020 2020 2020 2063 6f6e 6469 7469           conditi
-000102c0: 6f6e 5f63 6861 6e6e 656c 5f64 6174 615b  on_channel_data[
-000102d0: 7472 6961 6c5f 6964 782c 206c 6f63 616c  trial_idx, local
-000102e0: 5f73 7461 7274 3a6c 6f63 616c 5f65 6e64  _start:local_end
-000102f0: 5d20 3d20 7472 6961 6c5f 7472 6961 6c5f  ] = trial_trial_
-00010300: 6461 7461 0a0a 2020 2020 2020 2020 2020  data..          
-00010310: 2020 6966 2062 6173 656c 696e 655f 6d65    if baseline_me
-00010320: 7468 6f64 203d 3d20 313a 0a0a 2020 2020  thod == 1:..    
-00010330: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-00010340: 6574 7269 635f 6361 6c6c 6261 636b 7320  etric_callbacks 
-00010350: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00010360: 2020 2020 2020 2020 2020 2020 2023 206e               # n
-00010370: 6f20 6361 6c6c 6261 636b 2c20 6e6f 726d  o callback, norm
-00010380: 616c 697a 6520 616e 6420 7374 6f72 6520  alize and store 
-00010390: 7468 6520 7472 6961 6c20 6461 7461 2077  the trial data w
-000103a0: 6974 6820 6261 7365 6c69 6e65 2061 7070  ith baseline app
-000103b0: 6c69 6564 0a20 2020 2020 2020 2020 2020  lied.           
-000103c0: 2020 2020 2020 2020 2063 6f6e 6469 7469           conditi
-000103d0: 6f6e 5f63 6861 6e6e 656c 5f64 6174 615b  on_channel_data[
-000103e0: 7472 6961 6c5f 6964 782c 206c 6f63 616c  trial_idx, local
-000103f0: 5f73 7461 7274 3a6c 6f63 616c 5f65 6e64  _start:local_end
-00010400: 5d20 3d20 7472 6961 6c5f 7472 6961 6c5f  ] = trial_trial_
-00010410: 6461 7461 202d 206e 702e 6e61 6e6d 6561  data - np.nanmea
-00010420: 6e28 7472 6961 6c5f 6261 7365 6c69 6e65  n(trial_baseline
-00010430: 5f64 6174 6129 0a0a 2020 2020 2020 2020  _data)..        
-00010440: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00010450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010460: 2020 2320 6361 6c6c 6261 636b 2c20 7374    # callback, st
-00010470: 6f72 6520 7468 6520 6261 7365 6c69 6e65  ore the baseline
-00010480: 2076 616c 7565 7320 666f 7220 6c61 7465   values for late
-00010490: 7220 7573 650a 2020 2020 2020 2020 2020  r use.          
-000104a0: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-000104b0: 3a20 6e6f 7420 7265 6c65 7661 6e74 2077  : not relevant w
-000104c0: 6865 7468 6572 2074 6869 7320 6973 2061  hether this is a
-000104d0: 206e 756d 7079 2d76 6965 7720 6f72 206e   numpy-view or n
-000104e0: 6f74 2c20 7369 6e63 6520 7765 2077 696c  ot, since we wil
-000104f0: 6c20 6176 6572 6167 6520 6f76 6572 2074  l average over t
-00010500: 6865 2074 7269 616c 730a 2020 2020 2020  he trials.      
-00010510: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010520: 2020 2020 2020 6c61 7465 722e 2041 7373        later. Ass
-00010530: 756d 6520 6d65 7472 6963 5f63 616c 6c62  ume metric_callb
-00010540: 6163 6b20 646f 6573 206e 6f74 206d 616e  ack does not man
-00010550: 6970 756c 6174 6520 7468 6520 6461 7461  ipulate the data
-00010560: 2069 7420 6973 2067 6976 656e 0a20 2020   it is given.   
-00010570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010580: 2062 6173 656c 696e 655f 6461 7461 5b74   baseline_data[t
-00010590: 7269 616c 5f69 6478 2c20 3a5d 203d 2074  rial_idx, :] = t
-000105a0: 7269 616c 5f62 6173 656c 696e 655f 6461  rial_baseline_da
-000105b0: 7461 0a0a 2020 2020 2020 2020 2020 2020  ta..            
-000105c0: 656c 6966 2062 6173 656c 696e 655f 6d65  elif baseline_me
-000105d0: 7468 6f64 203d 3d20 323a 0a0a 2020 2020  thod == 2:..    
-000105e0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-000105f0: 6574 7269 635f 6361 6c6c 6261 636b 7320  etric_callbacks 
-00010600: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00010610: 2020 2020 2020 2020 2020 2020 2023 206e               # n
-00010620: 6f20 6361 6c6c 6261 636b 2c20 6e6f 726d  o callback, norm
-00010630: 616c 697a 6520 616e 6420 7374 6f72 6520  alize and store 
-00010640: 7468 6520 7472 6961 6c20 6461 7461 2077  the trial data w
-00010650: 6974 6820 6261 7365 6c69 6e65 2061 7070  ith baseline app
-00010660: 6c69 6564 0a20 2020 2020 2020 2020 2020  lied.           
-00010670: 2020 2020 2020 2020 2063 6f6e 6469 7469           conditi
-00010680: 6f6e 5f63 6861 6e6e 656c 5f64 6174 615b  on_channel_data[
-00010690: 7472 6961 6c5f 6964 782c 206c 6f63 616c  trial_idx, local
-000106a0: 5f73 7461 7274 3a6c 6f63 616c 5f65 6e64  _start:local_end
-000106b0: 5d20 3d20 7472 6961 6c5f 7472 6961 6c5f  ] = trial_trial_
-000106c0: 6461 7461 202d 206e 702e 6e61 6e6d 6564  data - np.nanmed
-000106d0: 6961 6e28 7472 6961 6c5f 6261 7365 6c69  ian(trial_baseli
-000106e0: 6e65 5f64 6174 6129 0a0a 2020 2020 2020  ne_data)..      
-000106f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00010700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010710: 2020 2020 2320 6361 6c6c 6261 636b 2c20      # callback, 
-00010720: 7374 6f72 6520 7468 6520 6261 7365 6c69  store the baseli
-00010730: 6e65 2076 616c 7565 7320 666f 7220 6c61  ne values for la
-00010740: 7465 7220 7573 650a 2020 2020 2020 2020  ter use.        
-00010750: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-00010760: 7465 3a20 6e6f 7420 7265 6c65 7661 6e74  te: not relevant
-00010770: 2077 6865 7468 6572 2074 6869 7320 6973   whether this is
-00010780: 2061 206e 756d 7079 2d76 6965 7720 6f72   a numpy-view or
-00010790: 206e 6f74 2c20 7369 6e63 6520 7765 2077   not, since we w
-000107a0: 696c 6c20 6176 6572 6167 6520 6f76 6572  ill average over
-000107b0: 2074 6865 2074 7269 616c 730a 2020 2020   the trials.    
-000107c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107d0: 2320 2020 2020 2020 6c61 7465 722e 2041  #       later. A
-000107e0: 7373 756d 6520 6d65 7472 6963 5f63 616c  ssume metric_cal
-000107f0: 6c62 6163 6b20 646f 6573 206e 6f74 206d  lback does not m
-00010800: 616e 6970 756c 6174 6520 7468 6520 6461  anipulate the da
-00010810: 7461 2069 7420 6973 2067 6976 656e 0a20  ta it is given. 
-00010820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010830: 2020 2062 6173 656c 696e 655f 6461 7461     baseline_data
-00010840: 5b74 7269 616c 5f69 6478 2c20 3a5d 203d  [trial_idx, :] =
-00010850: 2074 7269 616c 5f62 6173 656c 696e 655f   trial_baseline_
-00010860: 6461 7461 0a0a 2020 2020 2020 2020 2320  data..        # 
-00010870: 6368 6563 6b20 6966 2061 2070 7265 2d61  check if a pre-a
-00010880: 7665 7261 6769 6e67 2063 616c 6c62 6163  veraging callbac
-00010890: 6b20 6675 6e63 7469 6f6e 2069 7320 6465  k function is de
-000108a0: 6669 6e65 640a 2020 2020 2020 2020 6966  fined.        if
-000108b0: 206d 6574 7269 635f 6361 6c6c 6261 636b   metric_callback
-000108c0: 7320 6973 206e 6f74 204e 6f6e 653a 0a0a  s is not None:..
-000108d0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-000108e0: 616c 6c61 626c 6528 6d65 7472 6963 5f63  allable(metric_c
-000108f0: 616c 6c62 6163 6b73 293a 0a0a 2020 2020  allbacks):..    
-00010900: 2020 2020 2020 2020 2020 2020 2320 7061              # pa
-00010910: 7373 2074 6865 2074 7269 616c 7320 7820  ss the trials x 
-00010920: 6570 6f63 6820 756e 2d6e 6f72 6d61 6c69  epoch un-normali
-00010930: 7a65 6420 7375 6273 6574 2074 6f20 7468  zed subset to th
-00010940: 6520 6361 6c6c 6261 636b 2066 756e 6374  e callback funct
-00010950: 696f 6e28 7329 2061 6e64 2073 746f 7265  ion(s) and store
-00010960: 2074 6865 2072 6573 756c 740a 2020 2020   the result.    
-00010970: 2020 2020 2020 2020 2020 2020 6d65 7472              metr
-00010980: 6963 5f76 616c 7565 203d 206d 6574 7269  ic_value = metri
-00010990: 635f 6361 6c6c 6261 636b 7328 6461 7461  c_callbacks(data
-000109a0: 5f72 6561 6465 722e 7361 6d70 6c69 6e67  _reader.sampling
-000109b0: 5f72 6174 652c 2063 6f6e 6469 7469 6f6e  _rate, condition
-000109c0: 5f63 6861 6e6e 656c 5f64 6174 612c 2062  _channel_data, b
-000109d0: 6173 656c 696e 655f 6461 7461 290a 2020  aseline_data).  
-000109e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000109f0: 206d 6574 7269 635f 7661 6c75 6520 6973   metric_value is
-00010a00: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00010a10: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00010a20: 6566 5f6d 6574 7269 635f 7661 6c75 6573  ef_metric_values
-00010a30: 5b63 6861 6e6e 656c 5f69 6478 2c20 636f  [channel_idx, co
-00010a40: 6e64 6974 696f 6e5f 6964 785d 203d 206d  ndition_idx] = m
-00010a50: 6574 7269 635f 7661 6c75 650a 0a20 2020  etric_value..   
-00010a60: 2020 2020 2020 2020 2065 6c69 6620 7479           elif ty
-00010a70: 7065 286d 6574 7269 635f 6361 6c6c 6261  pe(metric_callba
-00010a80: 636b 7329 2069 7320 7475 706c 6520 616e  cks) is tuple an
-00010a90: 6420 6c65 6e28 6d65 7472 6963 5f63 616c  d len(metric_cal
-00010aa0: 6c62 6163 6b73 2920 3e20 303a 0a20 2020  lbacks) > 0:.   
-00010ab0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00010ac0: 2069 4361 6c6c 6261 636b 2069 6e20 7261   iCallback in ra
-00010ad0: 6e67 6528 6c65 6e28 6d65 7472 6963 5f63  nge(len(metric_c
-00010ae0: 616c 6c62 6163 6b73 2929 3a0a 2020 2020  allbacks)):.    
-00010af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b00: 6966 2063 616c 6c61 626c 6528 6d65 7472  if callable(metr
-00010b10: 6963 5f63 616c 6c62 6163 6b73 5b69 4361  ic_callbacks[iCa
-00010b20: 6c6c 6261 636b 5d29 3a0a 0a20 2020 2020  llback]):..     
-00010b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b40: 2020 2023 2070 6173 7320 7468 6520 7472     # pass the tr
-00010b50: 6961 6c73 2078 2065 706f 6368 2075 6e2d  ials x epoch un-
-00010b60: 6e6f 726d 616c 697a 6564 2073 7562 7365  normalized subse
-00010b70: 7420 746f 2074 6865 2063 616c 6c62 6163  t to the callbac
-00010b80: 6b20 6675 6e63 7469 6f6e 2873 2920 616e  k function(s) an
-00010b90: 6420 7374 6f72 6520 7468 6520 7265 7375  d store the resu
-00010ba0: 6c74 0a20 2020 2020 2020 2020 2020 2020  lt.             
-00010bb0: 2020 2020 2020 2020 2020 206d 6574 7269             metri
-00010bc0: 635f 7661 6c75 6520 3d20 6d65 7472 6963  c_value = metric
-00010bd0: 5f63 616c 6c62 6163 6b73 5b69 4361 6c6c  _callbacks[iCall
-00010be0: 6261 636b 5d28 6461 7461 5f72 6561 6465  back](data_reade
-00010bf0: 722e 7361 6d70 6c69 6e67 5f72 6174 652c  r.sampling_rate,
-00010c00: 2063 6f6e 6469 7469 6f6e 5f63 6861 6e6e   condition_chann
-00010c10: 656c 5f64 6174 612c 2062 6173 656c 696e  el_data, baselin
-00010c20: 655f 6461 7461 290a 2020 2020 2020 2020  e_data).        
-00010c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c40: 6966 206d 6574 7269 635f 7661 6c75 6520  if metric_value 
-00010c50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00010c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c70: 2020 2020 2020 2020 2072 6566 5f6d 6574           ref_met
-00010c80: 7269 635f 7661 6c75 6573 5b63 6861 6e6e  ric_values[chann
-00010c90: 656c 5f69 6478 2c20 636f 6e64 6974 696f  el_idx, conditio
-00010ca0: 6e5f 6964 782c 2069 4361 6c6c 6261 636b  n_idx, iCallback
-00010cb0: 5d20 3d20 6d65 7472 6963 5f76 616c 7565  ] = metric_value
-00010cc0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00010cd0: 7468 6520 6361 6c6c 6261 636b 2068 6173  the callback has
-00010ce0: 2062 6565 6e20 6d61 6465 2c20 6368 6563   been made, chec
-00010cf0: 6b20 6966 2028 706f 7374 706f 6e65 6429  k if (postponed)
-00010d00: 206e 6f72 6d61 6c69 7a61 7469 6f6e 2073   normalization s
-00010d10: 686f 756c 6420 6f63 6375 7220 6261 7365  hould occur base
-00010d20: 6420 6f6e 2074 6865 2062 6173 656c 696e  d on the baselin
-00010d30: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00010d40: 2062 6173 656c 696e 655f 6d65 7468 6f64   baseline_method
-00010d50: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
-00010d60: 2020 2020 2020 2063 6f6e 6469 7469 6f6e         condition
-00010d70: 5f63 6861 6e6e 656c 5f64 6174 6120 2d3d  _channel_data -=
-00010d80: 206e 702e 6e61 6e6d 6561 6e28 6261 7365   np.nanmean(base
-00010d90: 6c69 6e65 5f64 6174 612c 2061 7869 733d  line_data, axis=
-00010da0: 3129 5b3a 2c20 4e6f 6e65 5d0a 2020 2020  1)[:, None].    
-00010db0: 2020 2020 2020 2020 656c 6966 2062 6173          elif bas
-00010dc0: 656c 696e 655f 6d65 7468 6f64 203d 3d20  eline_method == 
-00010dd0: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
-00010de0: 2020 2063 6f6e 6469 7469 6f6e 5f63 6861     condition_cha
-00010df0: 6e6e 656c 5f64 6174 6120 2d3d 206e 702e  nnel_data -= np.
-00010e00: 6e61 6e6d 6564 6961 6e28 6261 7365 6c69  nanmedian(baseli
-00010e10: 6e65 5f64 6174 612c 2061 7869 733d 3129  ne_data, axis=1)
-00010e20: 5b3a 2c20 4e6f 6e65 5d0a 0a20 2020 2020  [:, None]..     
-00010e30: 2020 2023 2061 7665 7261 6765 2074 6865     # average the
-00010e40: 2074 7269 616c 7320 666f 7220 6561 6368   trials for each
-00010e50: 2063 6861 6e6e 656c 2028 7769 7468 696e   channel (within
-00010e60: 2074 6869 7320 636f 6e64 6974 696f 6e29   this condition)
-00010e70: 2061 6e64 2073 746f 7265 2074 6865 2072   and store the r
-00010e80: 6573 756c 7473 0a20 2020 2020 2020 2072  esults.        r
-00010e90: 6566 5f64 6174 615b 6368 616e 6e65 6c5f  ef_data[channel_
-00010ea0: 6964 782c 2063 6f6e 6469 7469 6f6e 5f69  idx, condition_i
-00010eb0: 6478 2c20 3a5d 203d 206e 702e 6e61 6e6d  dx, :] = np.nanm
-00010ec0: 6561 6e28 636f 6e64 6974 696f 6e5f 6368  ean(condition_ch
-00010ed0: 616e 6e65 6c5f 6461 7461 2c20 6178 6973  annel_data, axis
-00010ee0: 3d30 290a 0a20 2020 2020 2020 2023 2063  =0)..        # c
-00010ef0: 6c65 6172 2072 6566 6572 656e 6365 2074  lear reference t
-00010f00: 6f20 6461 7461 0a20 2020 2020 2020 2064  o data.        d
-00010f10: 656c 2063 6f6e 6469 7469 6f6e 5f63 6861  el condition_cha
-00010f20: 6e6e 656c 5f64 6174 610a 0a20 2020 2023  nnel_data..    #
-00010f30: 0a20 2020 2072 6574 7572 6e20 6461 7461  .    return data
-00010f40: 5f72 6561 6465 722e 7361 6d70 6c69 6e67  _reader.sampling
-00010f50: 5f72 6174 652c 2072 6566 5f64 6174 612c  _rate, ref_data,
-00010f60: 2072 6566 5f6d 6574 7269 635f 7661 6c75   ref_metric_valu
-00010f70: 6573 0a0a 0a64 6566 205f 5f6c 6f61 645f  es...def __load_
-00010f80: 6461 7461 5f65 706f 6368 5f61 7665 7261  data_epoch_avera
-00010f90: 6765 735f 5f62 795f 6368 616e 6e65 6c5f  ges__by_channel_
-00010fa0: 636f 6e64 6974 696f 6e5f 7472 6961 6c28  condition_trial(
-00010fb0: 6461 7461 5f72 6561 6465 722c 2063 6861  data_reader, cha
-00010fc0: 6e6e 656c 732c 0a20 2020 2020 2020 2020  nnels,.         
-00010fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011000: 2020 636f 6e64 6974 696f 6e73 5f6f 6e73    conditions_ons
-00011010: 6574 732c 2074 7269 616c 5f65 706f 6368  ets, trial_epoch
-00011020: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00011030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011050: 2020 2020 2020 2020 2020 2020 2062 6173               bas
-00011060: 656c 696e 655f 6d65 7468 6f64 2c20 6261  eline_method, ba
-00011070: 7365 6c69 6e65 5f65 706f 6368 2c20 6f75  seline_epoch, ou
-00011080: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
-00011090: 642c 206d 6574 7269 635f 6361 6c6c 6261  d, metric_callba
-000110a0: 636b 7329 3a0a 2020 2020 2222 220a 2020  cks):.    """.  
-000110b0: 2020 4c6f 6164 2064 6174 6120 6570 6f63    Load data epoc
-000110c0: 6820 6176 6572 6167 6573 2074 6f20 6120  h averages to a 
-000110d0: 6d61 7472 6978 2028 666f 726d 6174 3a20  matrix (format: 
-000110e0: 6368 616e 6e65 6c20 7820 636f 6e64 6974  channel x condit
-000110f0: 696f 6e20 7820 7469 6d65 2920 6279 206c  ion x time) by l
-00011100: 6f6f 7069 6e67 206f 7665 7220 6368 616e  ooping over chan
-00011110: 6e65 6c73 2c20 7468 656e 206f 7665 720a  nels, then over.
-00011120: 2020 2020 636f 6e64 6974 696f 6e73 2061      conditions a
-00011130: 6e64 2074 6865 6e20 7769 7468 696e 2074  nd then within t
-00011140: 6861 7420 6368 616e 6e65 6c2d 636f 6e64  hat channel-cond
-00011150: 6974 696f 6e20 636f 6d62 696e 6174 696f  ition combinatio
-00011160: 6e20 6c6f 6f70 206f 7665 7220 6561 6368  n loop over each
-00011170: 206f 6620 7468 6520 7472 6961 6c73 2074   of the trials t
-00011180: 6f20 6c6f 6164 2074 6865 2073 7065 6369  o load the speci
-00011190: 6669 630a 2020 2020 6368 616e 6e65 6c2d  fic.    channel-
-000111a0: 636f 6e64 6974 696f 6e2d 7472 6961 6c20  condition-trial 
-000111b0: 6461 7461 2e20 5468 6520 6176 6572 6167  data. The averag
-000111c0: 696e 6720 2861 6e64 206d 6574 7269 6320  ing (and metric 
-000111d0: 6361 6c63 756c 6174 696f 6e29 2069 7320  calculation) is 
-000111e0: 7065 7266 6f72 6d65 6420 6f6e 2061 2074  performed on a t
-000111f0: 656d 706f 7261 7279 206d 6174 7269 7820  emporary matrix 
-00011200: 696e 2074 6865 0a20 2020 2063 6861 6e6e  in the.    chann
-00011210: 656c 206c 6f6f 700a 0a20 2020 204e 6f74  el loop..    Not
-00011220: 653a 2020 2020 2054 6869 7320 6675 6e63  e:     This func
-00011230: 7469 6f6e 2069 7320 6576 656e 206d 6f72  tion is even mor
-00011240: 6520 6d65 6d6f 7279 2065 6666 6963 6965  e memory efficie
-00011250: 6e74 2074 6861 6e20 275f 5f6c 6f61 645f  nt than '__load_
-00011260: 6461 7461 5f65 706f 6368 5f61 7665 7261  data_epoch_avera
-00011270: 6765 735f 5f62 795f 636f 6e64 6974 696f  ges__by_conditio
-00011280: 6e5f 7472 6961 6c27 2c20 6275 740a 2020  n_trial', but.  
-00011290: 2020 2020 2020 2020 2020 2020 736c 6f77              slow
-000112a0: 6572 2066 6f72 204d 4546 332e 2046 6f72  er for MEF3. For
-000112b0: 2045 4446 2061 6e64 2042 7261 696e 5669   EDF and BrainVi
-000112c0: 7369 6f6e 2074 6865 7265 2069 7320 6e6f  sion there is no
-000112d0: 7420 6d75 6368 2064 6966 6665 7265 6e63  t much differenc
-000112e0: 6520 6265 6361 7573 6520 4d4e 4520 7072  e because MNE pr
-000112f0: 656c 6f61 6473 2074 6865 0a20 2020 2020  eloads the.     
-00011300: 2020 2020 2020 2020 2077 686f 6c65 2073           whole s
-00011310: 6574 2074 6f20 6d65 6d6f 7279 2066 6972  et to memory fir
-00011320: 7374 2c20 736f 206a 7573 7420 6e75 6d70  st, so just nump
-00011330: 792d 7669 6577 7320 6172 6520 7265 7475  y-views are retu
-00011340: 726e 6564 2061 6e64 2075 7365 642e 0a20  rned and used.. 
-00011350: 2020 2022 2222 0a0a 2020 2020 2320 6361     """..    # ca
-00011360: 6c63 756c 6174 6520 7468 6520 7369 7a65  lculate the size
-00011370: 206f 6620 7468 6520 7469 6d65 2064 696d   of the time dim
-00011380: 656e 7369 6f6e 2028 696e 2073 616d 706c  ension (in sampl
-00011390: 6573 290a 2020 2020 7472 6961 6c5f 6e75  es).    trial_nu
-000113a0: 6d5f 7361 6d70 6c65 7320 3d20 696e 7428  m_samples = int(
-000113b0: 726f 756e 6428 6162 7328 7472 6961 6c5f  round(abs(trial_
-000113c0: 6570 6f63 685b 315d 202d 2074 7269 616c  epoch[1] - trial
-000113d0: 5f65 706f 6368 5b30 5d29 202a 2064 6174  _epoch[0]) * dat
-000113e0: 615f 7265 6164 6572 2e73 616d 706c 696e  a_reader.samplin
-000113f0: 675f 7261 7465 2929 0a20 2020 2062 6173  g_rate)).    bas
-00011400: 656c 696e 655f 6e75 6d5f 7361 6d70 6c65  eline_num_sample
-00011410: 7320 3d20 696e 7428 726f 756e 6428 6162  s = int(round(ab
-00011420: 7328 6261 7365 6c69 6e65 5f65 706f 6368  s(baseline_epoch
-00011430: 5b31 5d20 2d20 6261 7365 6c69 6e65 5f65  [1] - baseline_e
-00011440: 706f 6368 5b30 5d29 202a 2064 6174 615f  poch[0]) * data_
-00011450: 7265 6164 6572 2e73 616d 706c 696e 675f  reader.sampling_
-00011460: 7261 7465 2929 0a0a 2020 2020 2320 696e  rate))..    # in
-00011470: 6974 6961 6c69 7a65 2061 2064 6174 6120  itialize a data 
-00011480: 6275 6666 6572 2028 6368 616e 6e65 6c20  buffer (channel 
-00011490: 7820 636f 6e64 6974 696f 6e73 2078 2073  x conditions x s
-000114a0: 616d 706c 6573 290a 2020 2020 7472 793a  amples).    try:
-000114b0: 0a20 2020 2020 2020 2064 6174 6120 3d20  .        data = 
-000114c0: 616c 6c6f 6361 7465 5f61 7272 6179 2828  allocate_array((
-000114d0: 6c65 6e28 6368 616e 6e65 6c73 292c 206c  len(channels), l
-000114e0: 656e 2863 6f6e 6469 7469 6f6e 735f 6f6e  en(conditions_on
-000114f0: 7365 7473 292c 2074 7269 616c 5f6e 756d  sets), trial_num
-00011500: 5f73 616d 706c 6573 2929 0a20 2020 2065  _samples)).    e
-00011510: 7863 6570 7420 4d65 6d6f 7279 4572 726f  xcept MemoryErro
-00011520: 723a 0a20 2020 2020 2020 2072 6169 7365  r:.        raise
-00011530: 204d 656d 6f72 7945 7272 6f72 2827 4e6f   MemoryError('No
-00011540: 7420 656e 6f75 6768 206d 656d 6f72 7920  t enough memory 
-00011550: 6372 6561 7465 2061 2064 6174 6120 6f75  create a data ou
-00011560: 7470 7574 206d 6174 7269 7827 290a 0a20  tput matrix').. 
-00011570: 2020 2023 2069 6e69 7469 616c 697a 6520     # initialize 
-00011580: 6120 6d65 7472 6963 2062 7566 6665 7220  a metric buffer 
-00011590: 2863 6861 6e6e 656c 2078 2063 6f6e 6469  (channel x condi
-000115a0: 7469 6f6e 7320 7820 6d65 7472 6963 290a  tions x metric).
-000115b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000115c0: 206d 6574 7269 635f 7661 6c75 6573 203d   metric_values =
-000115d0: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-000115e0: 206d 6574 7269 635f 6361 6c6c 6261 636b   metric_callback
-000115f0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00011600: 2020 2020 2020 2020 2020 2069 6620 6361             if ca
-00011610: 6c6c 6162 6c65 286d 6574 7269 635f 6361  llable(metric_ca
-00011620: 6c6c 6261 636b 7329 3a0a 2020 2020 2020  llbacks):.      
-00011630: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
-00011640: 5f76 616c 7565 7320 3d20 616c 6c6f 6361  _values = alloca
-00011650: 7465 5f61 7272 6179 2828 6c65 6e28 6368  te_array((len(ch
-00011660: 616e 6e65 6c73 292c 206c 656e 2863 6f6e  annels), len(con
-00011670: 6469 7469 6f6e 735f 6f6e 7365 7473 2929  ditions_onsets))
-00011680: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00011690: 6966 2074 7970 6528 6d65 7472 6963 5f63  if type(metric_c
-000116a0: 616c 6c62 6163 6b73 2920 6973 2074 7570  allbacks) is tup
-000116b0: 6c65 2061 6e64 206c 656e 286d 6574 7269  le and len(metri
-000116c0: 635f 6361 6c6c 6261 636b 7329 203e 2030  c_callbacks) > 0
-000116d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000116e0: 2020 6d65 7472 6963 5f76 616c 7565 7320    metric_values 
-000116f0: 3d20 616c 6c6f 6361 7465 5f61 7272 6179  = allocate_array
-00011700: 2828 6c65 6e28 6368 616e 6e65 6c73 292c  ((len(channels),
-00011710: 206c 656e 2863 6f6e 6469 7469 6f6e 735f   len(conditions_
-00011720: 6f6e 7365 7473 292c 206c 656e 286d 6574  onsets), len(met
-00011730: 7269 635f 6361 6c6c 6261 636b 7329 2929  ric_callbacks)))
-00011740: 0a20 2020 2065 7863 6570 7420 4d65 6d6f  .    except Memo
-00011750: 7279 4572 726f 723a 0a20 2020 2020 2020  ryError:.       
-00011760: 2072 6169 7365 204d 656d 6f72 7945 7272   raise MemoryErr
-00011770: 6f72 2827 4e6f 7420 656e 6f75 6768 206d  or('Not enough m
-00011780: 656d 6f72 7920 6372 6561 7465 2061 206d  emory create a m
-00011790: 6574 7269 6320 6f75 7470 7574 206d 6174  etric output mat
-000117a0: 7269 7827 290a 0a20 2020 2023 2063 7265  rix')..    # cre
-000117b0: 6174 6520 7072 6f67 7265 7373 2062 6172  ate progress bar
-000117c0: 0a20 2020 2070 7269 6e74 5f70 726f 6772  .    print_progr
-000117d0: 6573 7362 6172 2830 2c20 6c65 6e28 636f  essbar(0, len(co
-000117e0: 6e64 6974 696f 6e73 5f6f 6e73 6574 7329  nditions_onsets)
-000117f0: 2c20 7072 6566 6978 3d27 5072 6f67 7265  , prefix='Progre
-00011800: 7373 3a27 2c20 7375 6666 6978 3d27 436f  ss:', suffix='Co
-00011810: 6d70 6c65 7465 272c 206c 656e 6774 683d  mplete', length=
-00011820: 3530 290a 0a20 2020 2023 206c 6f6f 7020  50)..    # loop 
-00011830: 7468 726f 7567 6820 7468 6520 6368 616e  through the chan
-00011840: 6e65 6c73 0a20 2020 2066 6f72 2063 6861  nels.    for cha
-00011850: 6e6e 656c 5f69 6478 2069 6e20 7261 6e67  nnel_idx in rang
-00011860: 6528 6c65 6e28 6368 616e 6e65 6c73 2929  e(len(channels))
-00011870: 3a0a 0a20 2020 2020 2020 2023 0a20 2020  :..        #.   
-00011880: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00011890: 2020 2020 2020 5f5f 7375 626c 6f61 645f        __subload_
-000118a0: 6461 7461 5f65 706f 6368 5f61 7665 7261  data_epoch_avera
-000118b0: 6765 735f 5f66 726f 6d5f 6368 616e 6e65  ges__from_channe
-000118c0: 6c5f 5f62 795f 636f 6e64 6974 696f 6e5f  l__by_condition_
-000118d0: 7472 6961 6c73 2864 6174 612c 206d 6574  trials(data, met
-000118e0: 7269 635f 7661 6c75 6573 2c0a 2020 2020  ric_values,.    
-000118f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011930: 2020 2020 2020 2020 2064 6174 615f 7265           data_re
-00011940: 6164 6572 2c20 6368 616e 6e65 6c5f 6964  ader, channel_id
-00011950: 782c 2063 6861 6e6e 656c 735b 6368 616e  x, channels[chan
-00011960: 6e65 6c5f 6964 785d 2c20 4e6f 6e65 2c0a  nel_idx], None,.
-00011970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000119a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000119b0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000119c0: 6469 7469 6f6e 735f 6f6e 7365 7473 2c20  ditions_onsets, 
-000119d0: 7472 6961 6c5f 6e75 6d5f 7361 6d70 6c65  trial_num_sample
-000119e0: 732c 2074 7269 616c 5f65 706f 6368 2c0a  s, trial_epoch,.
-000119f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011a30: 2020 2020 2020 2020 2020 2020 2062 6173               bas
-00011a40: 656c 696e 655f 6e75 6d5f 7361 6d70 6c65  eline_num_sample
-00011a50: 732c 2062 6173 656c 696e 655f 6d65 7468  s, baseline_meth
-00011a60: 6f64 2c20 6261 7365 6c69 6e65 5f65 706f  od, baseline_epo
-00011a70: 6368 2c20 6f75 745f 6f66 5f62 6f75 6e64  ch, out_of_bound
-00011a80: 5f6d 6574 686f 642c 0a20 2020 2020 2020  _method,.       
+0000ee80: 6c6f 6767 696e 672e 7761 726e 696e 6728  logging.warning(
+0000ee90: 2743 616e 6e6f 7420 6578 7472 6163 7420  'Cannot extract 
+0000eea0: 7468 6520 7472 6961 6c20 7769 7468 206f  the trial with o
+0000eeb0: 6e73 6574 2027 202b 2073 7472 2863 6f6e  nset ' + str(con
+0000eec0: 6469 7469 6f6e 735f 6f6e 7365 7473 5b63  ditions_onsets[c
+0000eed0: 6f6e 6469 7469 6f6e 5f69 6478 5d5b 7472  ondition_idx][tr
+0000eee0: 6961 6c5f 6964 785d 2920 2b20 272c 2074  ial_idx]) + ', t
+0000eef0: 6865 2065 6e64 206f 6620 7468 6520 7472  he end of the tr
+0000ef00: 6961 6c2d 6570 6f63 6820 6c69 6573 2062  ial-epoch lies b
+0000ef10: 6566 6f72 6520 7468 6520 7374 6172 7420  efore the start 
+0000ef20: 6f66 2074 6865 2064 6174 612d 7365 742e  of the data-set.
+0000ef30: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0000ef40: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0000ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000ef70: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+0000ef80: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
+0000ef90: 6578 7472 6163 7420 7468 6520 7472 6961  extract the tria
+0000efa0: 6c20 7769 7468 206f 6e73 6574 2027 202b  l with onset ' +
+0000efb0: 2073 7472 2863 6f6e 6469 7469 6f6e 735f   str(conditions_
+0000efc0: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
+0000efd0: 5f69 6478 5d5b 7472 6961 6c5f 6964 785d  _idx][trial_idx]
+0000efe0: 2920 2b20 272c 2074 6865 2065 6e64 206f  ) + ', the end o
+0000eff0: 6620 7468 6520 7472 6961 6c2d 6570 6f63  f the trial-epoc
+0000f000: 6820 6c69 6573 2062 6566 6f72 6520 7468  h lies before th
+0000f010: 6520 7374 6172 7420 6f66 2074 6865 2064  e start of the d
+0000f020: 6174 612d 7365 742e 2055 7365 2061 2064  ata-set. Use a d
+0000f030: 6966 6665 7265 6e74 206f 7574 5f6f 665f  ifferent out_of_
+0000f040: 626f 756e 645f 6861 6e64 6c69 6e67 2061  bound_handling a
+0000f050: 7267 756d 656e 7420 746f 2061 6c6c 6f77  rgument to allow
+0000f060: 206f 7574 2d6f 662d 626f 756e 6420 7472   out-of-bound tr
+0000f070: 6961 6c20 6570 6f63 6873 2729 0a20 2020  ial epochs').   
+0000f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f090: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0000f0a0: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+0000f0b0: 6163 7420 7472 6961 6c27 290a 2020 2020  act trial').    
+0000f0c0: 2020 2020 2020 2020 6966 2074 7269 616c          if trial
+0000f0d0: 5f73 616d 706c 655f 7374 6172 7420 3c20  _sample_start < 
+0000f0e0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0000f0f0: 2020 2069 6620 286f 7574 5f6f 665f 626f     if (out_of_bo
+0000f100: 756e 645f 6d65 7468 6f64 203d 3d20 3120  und_method == 1 
+0000f110: 616e 6420 636f 6e64 6974 696f 6e5f 6964  and condition_id
+0000f120: 7820 3d3d 2030 2061 6e64 2074 7269 616c  x == 0 and trial
+0000f130: 5f69 6478 203d 3d20 3029 206f 7220 6f75  _idx == 0) or ou
+0000f140: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
+0000f150: 6420 3d3d 2032 3a0a 2020 2020 2020 2020  d == 2:.        
+0000f160: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0000f170: 6861 6e6e 656c 5f69 6478 203d 3d20 303a  hannel_idx == 0:
+0000f180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f190: 2020 2020 2020 2020 206c 6f67 6769 6e67           logging
+0000f1a0: 2e77 6172 6e69 6e67 2827 4361 6e6e 6f74  .warning('Cannot
+0000f1b0: 2065 7874 7261 6374 2074 6865 2074 7269   extract the tri
+0000f1c0: 616c 2077 6974 6820 6f6e 7365 7420 2720  al with onset ' 
+0000f1d0: 2b20 7374 7228 636f 6e64 6974 696f 6e73  + str(conditions
+0000f1e0: 5f6f 6e73 6574 735b 636f 6e64 6974 696f  _onsets[conditio
+0000f1f0: 6e5f 6964 785d 5b74 7269 616c 5f69 6478  n_idx][trial_idx
+0000f200: 5d29 202b 2027 2c20 7468 6520 7374 6172  ]) + ', the star
+0000f210: 7420 6f66 2074 6865 2074 7269 616c 2d65  t of the trial-e
+0000f220: 706f 6368 206c 6965 7320 6265 666f 7265  poch lies before
+0000f230: 2074 6865 2073 7461 7274 206f 6620 7468   the start of th
+0000f240: 6520 6461 7461 2d73 6574 2e27 290a 2020  e data-set.').  
+0000f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f260: 2020 6c6f 6361 6c5f 7374 6172 7420 3d20    local_start = 
+0000f270: 7472 6961 6c5f 7361 6d70 6c65 5f73 7461  trial_sample_sta
+0000f280: 7274 202a 202d 310a 2020 2020 2020 2020  rt * -1.        
+0000f290: 2020 2020 2020 2020 2020 2020 7472 6961              tria
+0000f2a0: 6c5f 7361 6d70 6c65 5f73 7461 7274 203d  l_sample_start =
+0000f2b0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+0000f2c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000f2d0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0000f2e0: 6769 6e67 2e65 7272 6f72 2827 4361 6e6e  ging.error('Cann
+0000f2f0: 6f74 2065 7874 7261 6374 2074 6865 2074  ot extract the t
+0000f300: 7269 616c 2077 6974 6820 6f6e 7365 7420  rial with onset 
+0000f310: 2720 2b20 7374 7228 636f 6e64 6974 696f  ' + str(conditio
+0000f320: 6e73 5f6f 6e73 6574 735b 636f 6e64 6974  ns_onsets[condit
+0000f330: 696f 6e5f 6964 785d 5b74 7269 616c 5f69  ion_idx][trial_i
+0000f340: 6478 5d29 202b 2027 2c20 7468 6520 7374  dx]) + ', the st
+0000f350: 6172 7420 6f66 2074 6865 2074 7269 616c  art of the trial
+0000f360: 2d65 706f 6368 206c 6965 7320 6265 666f  -epoch lies befo
+0000f370: 7265 2074 6865 2073 7461 7274 206f 6620  re the start of 
+0000f380: 7468 6520 6461 7461 2d73 6574 2e20 5573  the data-set. Us
+0000f390: 6520 6120 6469 6666 6572 656e 7420 6f75  e a different ou
+0000f3a0: 745f 6f66 5f62 6f75 6e64 5f68 616e 646c  t_of_bound_handl
+0000f3b0: 696e 6720 6172 6775 6d65 6e74 2074 6f20  ing argument to 
+0000f3c0: 616c 6c6f 7720 6f75 742d 6f66 2d62 6f75  allow out-of-bou
+0000f3d0: 6e64 2074 7269 616c 2065 706f 6368 7327  nd trial epochs'
+0000f3e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f3f0: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+0000f400: 696d 6545 7272 6f72 2827 4361 6e6e 6f74  imeError('Cannot
+0000f410: 2065 7874 7261 6374 2074 7269 616c 2729   extract trial')
+0000f420: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000f430: 7472 6961 6c5f 7361 6d70 6c65 5f73 7461  trial_sample_sta
+0000f440: 7274 203e 2063 6861 6e6e 656c 5f6e 756d  rt > channel_num
+0000f450: 5f73 616d 706c 6573 3a0a 2020 2020 2020  _samples:.      
+0000f460: 2020 2020 2020 2020 2020 6966 2028 6f75            if (ou
+0000f470: 745f 6f66 5f62 6f75 6e64 5f6d 6574 686f  t_of_bound_metho
+0000f480: 6420 3d3d 2031 2061 6e64 2063 6f6e 6469  d == 1 and condi
+0000f490: 7469 6f6e 5f69 6478 203d 3d20 6c65 6e28  tion_idx == len(
+0000f4a0: 636f 6e64 6974 696f 6e73 5f6f 6e73 6574  conditions_onset
+0000f4b0: 7329 202d 2031 2061 6e64 2074 7269 616c  s) - 1 and trial
+0000f4c0: 5f69 6478 203d 3d20 6c65 6e28 0a20 2020  _idx == len(.   
+0000f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f4e0: 2020 2020 2063 6f6e 6469 7469 6f6e 735f       conditions_
+0000f4f0: 6f6e 7365 7473 5b63 6f6e 6469 7469 6f6e  onsets[condition
+0000f500: 5f69 6478 5d29 202d 2031 2920 6f72 206f  _idx]) - 1) or o
+0000f510: 7574 5f6f 665f 626f 756e 645f 6d65 7468  ut_of_bound_meth
+0000f520: 6f64 203d 3d20 323a 0a20 2020 2020 2020  od == 2:.       
+0000f530: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000f540: 6368 616e 6e65 6c5f 6964 7820 3d3d 2030  channel_idx == 0
+0000f550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f560: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+0000f570: 672e 7761 726e 696e 6728 2743 616e 6e6f  g.warning('Canno
+0000f580: 7420 6578 7472 6163 7420 7468 6520 7472  t extract the tr
+0000f590: 6961 6c20 7769 7468 206f 6e73 6574 2027  ial with onset '
+0000f5a0: 202b 2073 7472 2863 6f6e 6469 7469 6f6e   + str(condition
+0000f5b0: 735f 6f6e 7365 7473 5b63 6f6e 6469 7469  s_onsets[conditi
+0000f5c0: 6f6e 5f69 6478 5d5b 7472 6961 6c5f 6964  on_idx][trial_id
+0000f5d0: 785d 2920 2b20 272c 2074 6865 2073 7461  x]) + ', the sta
+0000f5e0: 7274 206f 6620 7468 6520 7472 6961 6c2d  rt of the trial-
+0000f5f0: 6570 6f63 6820 6c69 6573 2061 6674 6572  epoch lies after
+0000f600: 2074 6865 2065 6e64 206f 6620 7468 6520   the end of the 
+0000f610: 6461 7461 2d73 6574 2e27 290a 2020 2020  data-set.').    
+0000f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f630: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
+0000f640: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f660: 2020 206c 6f67 6769 6e67 2e65 7272 6f72     logging.error
+0000f670: 2827 4361 6e6e 6f74 2065 7874 7261 6374  ('Cannot extract
+0000f680: 2074 6865 2074 7269 616c 2077 6974 6820   the trial with 
+0000f690: 6f6e 7365 7420 2720 2b20 7374 7228 636f  onset ' + str(co
+0000f6a0: 6e64 6974 696f 6e73 5f6f 6e73 6574 735b  nditions_onsets[
+0000f6b0: 636f 6e64 6974 696f 6e5f 6964 785d 5b74  condition_idx][t
+0000f6c0: 7269 616c 5f69 6478 5d29 202b 2027 2c20  rial_idx]) + ', 
+0000f6d0: 7468 6520 7374 6172 7420 6f66 2074 6865  the start of the
+0000f6e0: 2074 7269 616c 2d65 706f 6368 206c 6965   trial-epoch lie
+0000f6f0: 7320 6166 7465 7220 7468 6520 656e 6420  s after the end 
+0000f700: 6f66 2074 6865 2064 6174 612d 7365 742e  of the data-set.
+0000f710: 2055 7365 2061 2064 6966 6665 7265 6e74   Use a different
+0000f720: 206f 7574 5f6f 665f 626f 756e 645f 6861   out_of_bound_ha
+0000f730: 6e64 6c69 6e67 2061 7267 756d 656e 7420  ndling argument 
+0000f740: 746f 2061 6c6c 6f77 206f 7574 2d6f 662d  to allow out-of-
+0000f750: 626f 756e 6420 7472 6961 6c20 6570 6f63  bound trial epoc
+0000f760: 6873 2729 0a20 2020 2020 2020 2020 2020  hs').           
+0000f770: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+0000f780: 756e 7469 6d65 4572 726f 7228 2743 616e  untimeError('Can
+0000f790: 6e6f 7420 6578 7472 6163 7420 7472 6961  not extract tria
+0000f7a0: 6c27 290a 2020 2020 2020 2020 2020 2020  l').            
+0000f7b0: 6966 2074 7269 616c 5f73 616d 706c 655f  if trial_sample_
+0000f7c0: 656e 6420 3e20 6368 616e 6e65 6c5f 6e75  end > channel_nu
+0000f7d0: 6d5f 7361 6d70 6c65 733a 0a20 2020 2020  m_samples:.     
+0000f7e0: 2020 2020 2020 2020 2020 2069 6620 286f             if (o
+0000f7f0: 7574 5f6f 665f 626f 756e 645f 6d65 7468  ut_of_bound_meth
+0000f800: 6f64 203d 3d20 3120 616e 6420 636f 6e64  od == 1 and cond
+0000f810: 6974 696f 6e5f 6964 7820 3d3d 206c 656e  ition_idx == len
+0000f820: 2863 6f6e 6469 7469 6f6e 735f 6f6e 7365  (conditions_onse
+0000f830: 7473 2920 2d20 3120 616e 6420 7472 6961  ts) - 1 and tria
+0000f840: 6c5f 6964 7820 3d3d 206c 656e 280a 2020  l_idx == len(.  
+0000f850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f860: 2020 2020 2020 636f 6e64 6974 696f 6e73        conditions
+0000f870: 5f6f 6e73 6574 735b 636f 6e64 6974 696f  _onsets[conditio
+0000f880: 6e5f 6964 785d 2920 2d20 3129 206f 7220  n_idx]) - 1) or 
+0000f890: 6f75 745f 6f66 5f62 6f75 6e64 5f6d 6574  out_of_bound_met
+0000f8a0: 686f 6420 3d3d 2032 3a0a 2020 2020 2020  hod == 2:.      
+0000f8b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000f8c0: 2063 6861 6e6e 656c 5f69 6478 203d 3d20   channel_idx == 
+0000f8d0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0000f8e0: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+0000f8f0: 6e67 2e77 6172 6e69 6e67 2827 4361 6e6e  ng.warning('Cann
+0000f900: 6f74 2065 7874 7261 6374 2074 6865 2074  ot extract the t
+0000f910: 7269 616c 2077 6974 6820 6f6e 7365 7420  rial with onset 
+0000f920: 2720 2b20 7374 7228 636f 6e64 6974 696f  ' + str(conditio
+0000f930: 6e73 5f6f 6e73 6574 735b 636f 6e64 6974  ns_onsets[condit
+0000f940: 696f 6e5f 6964 785d 5b74 7269 616c 5f69  ion_idx][trial_i
+0000f950: 6478 5d29 202b 2027 2c20 7468 6520 656e  dx]) + ', the en
+0000f960: 6420 6f66 2074 6865 2074 7269 616c 2d65  d of the trial-e
+0000f970: 706f 6368 206c 6965 7320 6166 7465 7220  poch lies after 
+0000f980: 7468 6520 656e 6420 6f66 2074 6865 2064  the end of the d
+0000f990: 6174 612d 7365 742e 2729 0a20 2020 2020  ata-set.').     
+0000f9a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0000f9b0: 6f63 616c 5f65 6e64 203d 2074 7269 616c  ocal_end = trial
+0000f9c0: 5f6e 756d 5f73 616d 706c 6573 202d 2028  _num_samples - (
+0000f9d0: 7472 6961 6c5f 7361 6d70 6c65 5f65 6e64  trial_sample_end
+0000f9e0: 202d 2063 6861 6e6e 656c 5f6e 756d 5f73   - channel_num_s
+0000f9f0: 616d 706c 6573 290a 2020 2020 2020 2020  amples).        
+0000fa00: 2020 2020 2020 2020 2020 2020 7472 6961              tria
+0000fa10: 6c5f 7361 6d70 6c65 5f65 6e64 203d 2063  l_sample_end = c
+0000fa20: 6861 6e6e 656c 5f6e 756d 5f73 616d 706c  hannel_num_sampl
+0000fa30: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0000fa40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000fa50: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0000fa60: 6769 6e67 2e65 7272 6f72 2827 4361 6e6e  ging.error('Cann
+0000fa70: 6f74 2065 7874 7261 6374 2074 6865 2074  ot extract the t
+0000fa80: 7269 616c 2077 6974 6820 6f6e 7365 7420  rial with onset 
+0000fa90: 2720 2b20 7374 7228 636f 6e64 6974 696f  ' + str(conditio
+0000faa0: 6e73 5f6f 6e73 6574 735b 636f 6e64 6974  ns_onsets[condit
+0000fab0: 696f 6e5f 6964 785d 5b74 7269 616c 5f69  ion_idx][trial_i
+0000fac0: 6478 5d29 202b 2027 2c20 7468 6520 656e  dx]) + ', the en
+0000fad0: 6420 6f66 2074 6865 2074 7269 616c 2d65  d of the trial-e
+0000fae0: 706f 6368 206c 6965 7320 6166 7465 7220  poch lies after 
+0000faf0: 7468 6520 656e 6420 6f66 2074 6865 2064  the end of the d
+0000fb00: 6174 612d 7365 742e 2055 7365 2061 2064  ata-set. Use a d
+0000fb10: 6966 6665 7265 6e74 206f 7574 5f6f 665f  ifferent out_of_
+0000fb20: 626f 756e 645f 6861 6e64 6c69 6e67 2061  bound_handling a
+0000fb30: 7267 756d 656e 7420 746f 2061 6c6c 6f77  rgument to allow
+0000fb40: 206f 7574 2d6f 662d 626f 756e 6420 7472   out-of-bound tr
+0000fb50: 6961 6c20 6570 6f63 6873 2729 0a20 2020  ial epochs').   
+0000fb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb70: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
+0000fb80: 726f 7228 2743 616e 6e6f 7420 6578 7472  ror('Cannot extr
+0000fb90: 6163 7420 7472 6961 6c27 290a 0a20 2020  act trial')..   
+0000fba0: 2020 2020 2020 2020 2023 2063 6865 636b           # check
+0000fbb0: 2077 6865 7468 6572 2074 6865 2062 6173   whether the bas
+0000fbc0: 656c 696e 6520 6973 2077 6974 6869 6e20  eline is within 
+0000fbd0: 626f 756e 6473 0a20 2020 2020 2020 2020  bounds.         
+0000fbe0: 2020 2069 6620 6261 7365 6c69 6e65 5f6d     if baseline_m
+0000fbf0: 6574 686f 6420 3e20 303a 0a20 2020 2020  ethod > 0:.     
+0000fc00: 2020 2020 2020 2020 2020 2069 6620 6261             if ba
+0000fc10: 7365 6c69 6e65 5f73 7461 7274 5f73 616d  seline_start_sam
+0000fc20: 706c 6520 3c20 3020 6f72 2062 6173 656c  ple < 0 or basel
+0000fc30: 696e 655f 656e 645f 7361 6d70 6c65 203e  ine_end_sample >
+0000fc40: 2063 6861 6e6e 656c 5f6e 756d 5f73 616d   channel_num_sam
+0000fc50: 706c 6573 3a0a 2020 2020 2020 2020 2020  ples:.          
+0000fc60: 2020 2020 2020 2020 2020 6c6f 6767 696e            loggin
+0000fc70: 672e 6572 726f 7228 2743 616e 6e6f 7420  g.error('Cannot 
+0000fc80: 6578 7472 6163 7420 7468 6520 6261 7365  extract the base
+0000fc90: 6c69 6e65 2066 6f72 2074 6865 2074 7269  line for the tri
+0000fca0: 616c 2077 6974 6820 6f6e 7365 7420 2720  al with onset ' 
+0000fcb0: 2b20 7374 7228 636f 6e64 6974 696f 6e73  + str(conditions
+0000fcc0: 5f6f 6e73 6574 735b 636f 6e64 6974 696f  _onsets[conditio
+0000fcd0: 6e5f 6964 785d 5b74 7269 616c 5f69 6478  n_idx][trial_idx
+0000fce0: 5d29 202b 2027 2c20 7468 6520 7261 6e67  ]) + ', the rang
+0000fcf0: 6520 666f 7220 7468 6520 6261 7365 6c69  e for the baseli
+0000fd00: 6e65 206c 6965 7320 6f75 7473 6964 6520  ne lies outside 
+0000fd10: 6f66 2074 6865 2064 6174 6127 290a 2020  of the data').  
+0000fd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fd30: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+0000fd40: 7272 6f72 2827 4361 6e6e 6f74 2065 7874  rror('Cannot ext
+0000fd50: 7261 6374 2062 6173 656c 696e 6527 290a  ract baseline').
+0000fd60: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
+0000fd70: 7874 7261 6374 2074 6865 2074 7269 616c  xtract the trial
+0000fd80: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+0000fd90: 2020 2320 6368 6563 6b20 6966 2074 6865    # check if the
+0000fda0: 2063 6861 6e6e 656c 2064 6174 6120 6973   channel data is
+0000fdb0: 2070 6173 7365 6420 6f72 206e 6565 6473   passed or needs
+0000fdc0: 2074 6f20 6265 2072 6574 7269 6576 6564   to be retrieved
+0000fdd0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000fde0: 6368 616e 6e65 6c5f 6461 7461 2069 7320  channel_data is 
+0000fdf0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000fe00: 2020 2020 2020 2320 7265 7472 6965 7665        # retrieve
+0000fe10: 2075 7369 6e67 2072 6561 6465 720a 0a20   using reader.. 
+0000fe20: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000fe30: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000fe40: 2020 2020 2020 2020 7472 6961 6c5f 6261          trial_ba
+0000fe50: 7365 6c69 6e65 5f64 6174 6120 3d20 6461  seline_data = da
+0000fe60: 7461 5f72 6561 6465 722e 7265 7472 6965  ta_reader.retrie
+0000fe70: 7665 5f73 616d 706c 655f 7261 6e67 655f  ve_sample_range_
+0000fe80: 6461 7461 2862 6173 656c 696e 655f 7374  data(baseline_st
+0000fe90: 6172 745f 7361 6d70 6c65 2c20 6261 7365  art_sample, base
+0000fea0: 6c69 6e65 5f65 6e64 5f73 616d 706c 652c  line_end_sample,
+0000feb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ff00: 2020 6368 616e 6e65 6c73 3d63 6861 6e6e    channels=chann
+0000ff10: 656c 5f6e 616d 652c 2065 6e73 7572 655f  el_name, ensure_
+0000ff20: 6f77 6e5f 6461 7461 3d46 616c 7365 295b  own_data=False)[
+0000ff30: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+0000ff40: 2020 2020 2020 2074 7269 616c 5f74 7269         trial_tri
+0000ff50: 616c 5f64 6174 6120 3d20 6461 7461 5f72  al_data = data_r
+0000ff60: 6561 6465 722e 7265 7472 6965 7665 5f73  eader.retrieve_s
+0000ff70: 616d 706c 655f 7261 6e67 655f 6461 7461  ample_range_data
+0000ff80: 2874 7269 616c 5f73 616d 706c 655f 7374  (trial_sample_st
+0000ff90: 6172 742c 2074 7269 616c 5f73 616d 706c  art, trial_sampl
+0000ffa0: 655f 656e 642c 0a20 2020 2020 2020 2020  e_end,.         
+0000ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fff0: 2020 2020 2063 6861 6e6e 656c 733d 6368       channels=ch
+00010000: 616e 6e65 6c5f 6e61 6d65 2c20 656e 7375  annel_name, ensu
+00010010: 7265 5f6f 776e 5f64 6174 613d 4661 6c73  re_own_data=Fals
+00010020: 6529 5b30 5d0a 2020 2020 2020 2020 2020  e)[0].          
+00010030: 2020 2020 2020 6578 6365 7074 2028 5275        except (Ru
+00010040: 6e74 696d 6545 7272 6f72 2c20 4c6f 6f6b  ntimeError, Look
+00010050: 7570 4572 726f 7229 3a0a 2020 2020 2020  upError):.      
+00010060: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00010070: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+00010080: 2827 436f 756c 6420 6e6f 7420 6c6f 6164  ('Could not load
+00010090: 2064 6174 6127 290a 0a20 2020 2020 2020   data')..       
+000100a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000100b0: 2020 2020 2020 2020 2020 2023 2072 6574             # ret
+000100c0: 7269 6576 6520 6672 6f6d 2070 6173 7365  rieve from passe
+000100d0: 6420 6368 616e 6e65 6c2d 6461 7461 0a0a  d channel-data..
+000100e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000100f0: 7472 6961 6c5f 6261 7365 6c69 6e65 5f64  trial_baseline_d
+00010100: 6174 6120 3d20 6368 616e 6e65 6c5f 6461  ata = channel_da
+00010110: 7461 5b62 6173 656c 696e 655f 7374 6172  ta[baseline_star
+00010120: 745f 7361 6d70 6c65 3a62 6173 656c 696e  t_sample:baselin
+00010130: 655f 656e 645f 7361 6d70 6c65 5d0a 2020  e_end_sample].  
+00010140: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00010150: 6961 6c5f 7472 6961 6c5f 6461 7461 203d  ial_trial_data =
+00010160: 2063 6861 6e6e 656c 5f64 6174 615b 7472   channel_data[tr
+00010170: 6961 6c5f 7361 6d70 6c65 5f73 7461 7274  ial_sample_start
+00010180: 3a74 7269 616c 5f73 616d 706c 655f 656e  :trial_sample_en
+00010190: 645d 0a0a 0a20 2020 2020 2020 2020 2020  d]...           
+000101a0: 2023 2070 6572 666f 726d 2062 6173 656c   # perform basel
+000101b0: 696e 6520 6e6f 726d 616c 697a 6174 696f  ine normalizatio
+000101c0: 6e20 6f6e 2074 6865 2074 7269 616c 2069  n on the trial i
+000101d0: 6620 6e65 6564 6564 0a20 2020 2020 2020  f needed.       
+000101e0: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
+000101f0: 2020 2023 2065 7863 6570 7420 7768 656e     # except when
+00010200: 2074 6865 7265 2069 7320 6120 6675 6e63   there is a func
+00010210: 7469 6f6e 2063 616c 6c62 6163 6b2e 2057  tion callback. W
+00010220: 6865 6e20 6120 6361 6c6c 6261 636b 2069  hen a callback i
+00010230: 7320 7468 656e 2077 6520 6e65 6564 2074  s then we need t
+00010240: 6f20 6669 7273 7420 6163 6375 6d75 6c61  o first accumula
+00010250: 7465 2074 6865 0a20 2020 2020 2020 2020  te the.         
+00010260: 2020 2023 2066 756c 6c20 2869 2e65 2e20     # full (i.e. 
+00010270: 6368 616e 6e65 6c73 2078 2074 7269 616c  channels x trial
+00010280: 7320 7820 6570 6f63 6829 2075 6e2d 6e6f  s x epoch) un-no
+00010290: 726d 616c 697a 6564 2073 7562 7365 7420  rmalized subset 
+000102a0: 746f 2070 726f 7669 6465 2074 6f20 7468  to provide to th
+000102b0: 6520 6675 6e63 7469 6f6e 2c20 616e 6420  e function, and 
+000102c0: 7374 6f72 650a 2020 2020 2020 2020 2020  store.          
+000102d0: 2020 2320 7468 6520 6261 7365 6c69 6e65    # the baseline
+000102e0: 2076 616c 7565 7320 696e 2061 2073 6570   values in a sep
+000102f0: 6172 6174 6520 6172 7261 792c 2073 6f20  arate array, so 
+00010300: 7468 6579 2063 616e 2062 6520 6170 706c  they can be appl
+00010310: 6965 6420 6c61 7465 720a 2020 2020 2020  ied later.      
+00010320: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+00010330: 2020 2020 6966 2062 6173 656c 696e 655f      if baseline_
+00010340: 6d65 7468 6f64 203d 3d20 3020 6f72 206d  method == 0 or m
+00010350: 6574 7269 635f 6361 6c6c 6261 636b 7320  etric_callbacks 
+00010360: 6973 206e 6f74 204e 6f6e 653a 0a0a 2020  is not None:..  
+00010370: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00010380: 4e6f 7465 3a20 6e6f 7420 7265 6c65 7661  Note: not releva
+00010390: 6e74 2077 6865 7468 6572 2074 6869 7320  nt whether this 
+000103a0: 6973 2061 206e 756d 7079 2d76 6965 7720  is a numpy-view 
+000103b0: 6f72 206e 6f74 2c20 7369 6e63 6520 7765  or not, since we
+000103c0: 2077 696c 6c20 6176 6572 6167 6520 6f76   will average ov
+000103d0: 6572 2074 6865 2074 7269 616c 730a 2020  er the trials.  
+000103e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000103f0: 2020 2020 2020 6c61 7465 722e 2041 7373        later. Ass
+00010400: 756d 6520 6d65 7472 6963 5f63 616c 6c62  ume metric_callb
+00010410: 6163 6b20 646f 6573 206e 6f74 206d 616e  ack does not man
+00010420: 6970 756c 6174 6520 7468 6520 6461 7461  ipulate the data
+00010430: 2069 7420 6973 2067 6976 656e 0a20 2020   it is given.   
+00010440: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00010450: 6469 7469 6f6e 5f63 6861 6e6e 656c 5f64  dition_channel_d
+00010460: 6174 615b 7472 6961 6c5f 6964 782c 206c  ata[trial_idx, l
+00010470: 6f63 616c 5f73 7461 7274 3a6c 6f63 616c  ocal_start:local
+00010480: 5f65 6e64 5d20 3d20 7472 6961 6c5f 7472  _end] = trial_tr
+00010490: 6961 6c5f 6461 7461 0a0a 2020 2020 2020  ial_data..      
+000104a0: 2020 2020 2020 6966 2062 6173 656c 696e        if baselin
+000104b0: 655f 6d65 7468 6f64 203d 3d20 313a 0a0a  e_method == 1:..
+000104c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104d0: 6966 206d 6574 7269 635f 6361 6c6c 6261  if metric_callba
+000104e0: 636b 7320 6973 204e 6f6e 653a 0a20 2020  cks is None:.   
+000104f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010500: 2023 206e 6f20 6361 6c6c 6261 636b 2c20   # no callback, 
+00010510: 6e6f 726d 616c 697a 6520 616e 6420 7374  normalize and st
+00010520: 6f72 6520 7468 6520 7472 6961 6c20 6461  ore the trial da
+00010530: 7461 2077 6974 6820 6261 7365 6c69 6e65  ta with baseline
+00010540: 2061 7070 6c69 6564 0a20 2020 2020 2020   applied.       
+00010550: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00010560: 6469 7469 6f6e 5f63 6861 6e6e 656c 5f64  dition_channel_d
+00010570: 6174 615b 7472 6961 6c5f 6964 782c 206c  ata[trial_idx, l
+00010580: 6f63 616c 5f73 7461 7274 3a6c 6f63 616c  ocal_start:local
+00010590: 5f65 6e64 5d20 3d20 7472 6961 6c5f 7472  _end] = trial_tr
+000105a0: 6961 6c5f 6461 7461 202d 206e 702e 6e61  ial_data - np.na
+000105b0: 6e6d 6561 6e28 7472 6961 6c5f 6261 7365  nmean(trial_base
+000105c0: 6c69 6e65 5f64 6174 6129 0a0a 2020 2020  line_data)..    
+000105d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000105e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000105f0: 2020 2020 2020 2320 6361 6c6c 6261 636b        # callback
+00010600: 2c20 7374 6f72 6520 7468 6520 6261 7365  , store the base
+00010610: 6c69 6e65 2076 616c 7565 7320 666f 7220  line values for 
+00010620: 6c61 7465 7220 7573 650a 2020 2020 2020  later use.      
+00010630: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00010640: 4e6f 7465 3a20 6e6f 7420 7265 6c65 7661  Note: not releva
+00010650: 6e74 2077 6865 7468 6572 2074 6869 7320  nt whether this 
+00010660: 6973 2061 206e 756d 7079 2d76 6965 7720  is a numpy-view 
+00010670: 6f72 206e 6f74 2c20 7369 6e63 6520 7765  or not, since we
+00010680: 2077 696c 6c20 6176 6572 6167 6520 6f76   will average ov
+00010690: 6572 2074 6865 2074 7269 616c 730a 2020  er the trials.  
+000106a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000106b0: 2020 2320 2020 2020 2020 6c61 7465 722e    #       later.
+000106c0: 2041 7373 756d 6520 6d65 7472 6963 5f63   Assume metric_c
+000106d0: 616c 6c62 6163 6b20 646f 6573 206e 6f74  allback does not
+000106e0: 206d 616e 6970 756c 6174 6520 7468 6520   manipulate the 
+000106f0: 6461 7461 2069 7420 6973 2067 6976 656e  data it is given
+00010700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010710: 2020 2020 2062 6173 656c 696e 655f 6461       baseline_da
+00010720: 7461 5b74 7269 616c 5f69 6478 2c20 3a5d  ta[trial_idx, :]
+00010730: 203d 2074 7269 616c 5f62 6173 656c 696e   = trial_baselin
+00010740: 655f 6461 7461 0a0a 2020 2020 2020 2020  e_data..        
+00010750: 2020 2020 656c 6966 2062 6173 656c 696e      elif baselin
+00010760: 655f 6d65 7468 6f64 203d 3d20 323a 0a0a  e_method == 2:..
+00010770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010780: 6966 206d 6574 7269 635f 6361 6c6c 6261  if metric_callba
+00010790: 636b 7320 6973 204e 6f6e 653a 0a20 2020  cks is None:.   
+000107a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107b0: 2023 206e 6f20 6361 6c6c 6261 636b 2c20   # no callback, 
+000107c0: 6e6f 726d 616c 697a 6520 616e 6420 7374  normalize and st
+000107d0: 6f72 6520 7468 6520 7472 6961 6c20 6461  ore the trial da
+000107e0: 7461 2077 6974 6820 6261 7365 6c69 6e65  ta with baseline
+000107f0: 2061 7070 6c69 6564 0a20 2020 2020 2020   applied.       
+00010800: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00010810: 6469 7469 6f6e 5f63 6861 6e6e 656c 5f64  dition_channel_d
+00010820: 6174 615b 7472 6961 6c5f 6964 782c 206c  ata[trial_idx, l
+00010830: 6f63 616c 5f73 7461 7274 3a6c 6f63 616c  ocal_start:local
+00010840: 5f65 6e64 5d20 3d20 7472 6961 6c5f 7472  _end] = trial_tr
+00010850: 6961 6c5f 6461 7461 202d 206e 702e 6e61  ial_data - np.na
+00010860: 6e6d 6564 6961 6e28 7472 6961 6c5f 6261  nmedian(trial_ba
+00010870: 7365 6c69 6e65 5f64 6174 6129 0a0a 2020  seline_data)..  
+00010880: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00010890: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000108a0: 2020 2020 2020 2020 2320 6361 6c6c 6261          # callba
+000108b0: 636b 2c20 7374 6f72 6520 7468 6520 6261  ck, store the ba
+000108c0: 7365 6c69 6e65 2076 616c 7565 7320 666f  seline values fo
+000108d0: 7220 6c61 7465 7220 7573 650a 2020 2020  r later use.    
+000108e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108f0: 2320 4e6f 7465 3a20 6e6f 7420 7265 6c65  # Note: not rele
+00010900: 7661 6e74 2077 6865 7468 6572 2074 6869  vant whether thi
+00010910: 7320 6973 2061 206e 756d 7079 2d76 6965  s is a numpy-vie
+00010920: 7720 6f72 206e 6f74 2c20 7369 6e63 6520  w or not, since 
+00010930: 7765 2077 696c 6c20 6176 6572 6167 6520  we will average 
+00010940: 6f76 6572 2074 6865 2074 7269 616c 730a  over the trials.
+00010950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010960: 2020 2020 2320 2020 2020 2020 6c61 7465      #       late
+00010970: 722e 2041 7373 756d 6520 6d65 7472 6963  r. Assume metric
+00010980: 5f63 616c 6c62 6163 6b20 646f 6573 206e  _callback does n
+00010990: 6f74 206d 616e 6970 756c 6174 6520 7468  ot manipulate th
+000109a0: 6520 6461 7461 2069 7420 6973 2067 6976  e data it is giv
+000109b0: 656e 0a20 2020 2020 2020 2020 2020 2020  en.             
+000109c0: 2020 2020 2020 2062 6173 656c 696e 655f         baseline_
+000109d0: 6461 7461 5b74 7269 616c 5f69 6478 2c20  data[trial_idx, 
+000109e0: 3a5d 203d 2074 7269 616c 5f62 6173 656c  :] = trial_basel
+000109f0: 696e 655f 6461 7461 0a0a 2020 2020 2020  ine_data..      
+00010a00: 2020 2320 6368 6563 6b20 6966 2061 2070    # check if a p
+00010a10: 7265 2d61 7665 7261 6769 6e67 2063 616c  re-averaging cal
+00010a20: 6c62 6163 6b20 6675 6e63 7469 6f6e 2069  lback function i
+00010a30: 7320 6465 6669 6e65 640a 2020 2020 2020  s defined.      
+00010a40: 2020 6966 206d 6574 7269 635f 6361 6c6c    if metric_call
+00010a50: 6261 636b 7320 6973 206e 6f74 204e 6f6e  backs is not Non
+00010a60: 653a 0a0a 2020 2020 2020 2020 2020 2020  e:..            
+00010a70: 6966 2063 616c 6c61 626c 6528 6d65 7472  if callable(metr
+00010a80: 6963 5f63 616c 6c62 6163 6b73 293a 0a0a  ic_callbacks):..
+00010a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010aa0: 2320 7061 7373 2074 6865 2074 7269 616c  # pass the trial
+00010ab0: 7320 7820 6570 6f63 6820 756e 2d6e 6f72  s x epoch un-nor
+00010ac0: 6d61 6c69 7a65 6420 7375 6273 6574 2074  malized subset t
+00010ad0: 6f20 7468 6520 6361 6c6c 6261 636b 2066  o the callback f
+00010ae0: 756e 6374 696f 6e28 7329 2061 6e64 2073  unction(s) and s
+00010af0: 746f 7265 2074 6865 2072 6573 756c 740a  tore the result.
+00010b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b10: 6d65 7472 6963 5f76 616c 7565 203d 206d  metric_value = m
+00010b20: 6574 7269 635f 6361 6c6c 6261 636b 7328  etric_callbacks(
+00010b30: 6461 7461 5f72 6561 6465 722e 7361 6d70  data_reader.samp
+00010b40: 6c69 6e67 5f72 6174 652c 2063 6f6e 6469  ling_rate, condi
+00010b50: 7469 6f6e 5f63 6861 6e6e 656c 5f64 6174  tion_channel_dat
+00010b60: 612c 2062 6173 656c 696e 655f 6461 7461  a, baseline_data
+00010b70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010b80: 2020 6966 206d 6574 7269 635f 7661 6c75    if metric_valu
+00010b90: 6520 6973 206e 6f74 204e 6f6e 653a 0a20  e is not None:. 
+00010ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bb0: 2020 2072 6566 5f6d 6574 7269 635f 7661     ref_metric_va
+00010bc0: 6c75 6573 5b63 6861 6e6e 656c 5f69 6478  lues[channel_idx
+00010bd0: 2c20 636f 6e64 6974 696f 6e5f 6964 785d  , condition_idx]
+00010be0: 203d 206d 6574 7269 635f 7661 6c75 650a   = metric_value.
+00010bf0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00010c00: 6620 7479 7065 286d 6574 7269 635f 6361  f type(metric_ca
+00010c10: 6c6c 6261 636b 7329 2069 7320 7475 706c  llbacks) is tupl
+00010c20: 6520 616e 6420 6c65 6e28 6d65 7472 6963  e and len(metric
+00010c30: 5f63 616c 6c62 6163 6b73 2920 3e20 303a  _callbacks) > 0:
+00010c40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010c50: 2066 6f72 2069 4361 6c6c 6261 636b 2069   for iCallback i
+00010c60: 6e20 7261 6e67 6528 6c65 6e28 6d65 7472  n range(len(metr
+00010c70: 6963 5f63 616c 6c62 6163 6b73 2929 3a0a  ic_callbacks)):.
+00010c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c90: 2020 2020 6966 2063 616c 6c61 626c 6528      if callable(
+00010ca0: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
+00010cb0: 5b69 4361 6c6c 6261 636b 5d29 3a0a 0a20  [iCallback]):.. 
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cd0: 2020 2020 2020 2023 2070 6173 7320 7468         # pass th
+00010ce0: 6520 7472 6961 6c73 2078 2065 706f 6368  e trials x epoch
+00010cf0: 2075 6e2d 6e6f 726d 616c 697a 6564 2073   un-normalized s
+00010d00: 7562 7365 7420 746f 2074 6865 2063 616c  ubset to the cal
+00010d10: 6c62 6163 6b20 6675 6e63 7469 6f6e 2873  lback function(s
+00010d20: 2920 616e 6420 7374 6f72 6520 7468 6520  ) and store the 
+00010d30: 7265 7375 6c74 0a20 2020 2020 2020 2020  result.         
+00010d40: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00010d50: 6574 7269 635f 7661 6c75 6520 3d20 6d65  etric_value = me
+00010d60: 7472 6963 5f63 616c 6c62 6163 6b73 5b69  tric_callbacks[i
+00010d70: 4361 6c6c 6261 636b 5d28 6461 7461 5f72  Callback](data_r
+00010d80: 6561 6465 722e 7361 6d70 6c69 6e67 5f72  eader.sampling_r
+00010d90: 6174 652c 2063 6f6e 6469 7469 6f6e 5f63  ate, condition_c
+00010da0: 6861 6e6e 656c 5f64 6174 612c 2062 6173  hannel_data, bas
+00010db0: 656c 696e 655f 6461 7461 290a 2020 2020  eline_data).    
+00010dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010dd0: 2020 2020 6966 206d 6574 7269 635f 7661      if metric_va
+00010de0: 6c75 6520 6973 206e 6f74 204e 6f6e 653a  lue is not None:
+00010df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010e00: 2020 2020 2020 2020 2020 2020 2072 6566               ref
+00010e10: 5f6d 6574 7269 635f 7661 6c75 6573 5b63  _metric_values[c
+00010e20: 6861 6e6e 656c 5f69 6478 2c20 636f 6e64  hannel_idx, cond
+00010e30: 6974 696f 6e5f 6964 782c 2069 4361 6c6c  ition_idx, iCall
+00010e40: 6261 636b 5d20 3d20 6d65 7472 6963 5f76  back] = metric_v
+00010e50: 616c 7565 0a0a 2020 2020 2020 2020 2020  alue..          
+00010e60: 2020 2320 7468 6520 6361 6c6c 6261 636b    # the callback
+00010e70: 2068 6173 2062 6565 6e20 6d61 6465 2c20   has been made, 
+00010e80: 6368 6563 6b20 6966 2028 706f 7374 706f  check if (postpo
+00010e90: 6e65 6429 206e 6f72 6d61 6c69 7a61 7469  ned) normalizati
+00010ea0: 6f6e 2073 686f 756c 6420 6f63 6375 7220  on should occur 
+00010eb0: 6261 7365 6420 6f6e 2074 6865 2062 6173  based on the bas
+00010ec0: 656c 696e 650a 2020 2020 2020 2020 2020  eline.          
+00010ed0: 2020 6966 2062 6173 656c 696e 655f 6d65    if baseline_me
+00010ee0: 7468 6f64 203d 3d20 313a 0a20 2020 2020  thod == 1:.     
+00010ef0: 2020 2020 2020 2020 2020 2063 6f6e 6469             condi
+00010f00: 7469 6f6e 5f63 6861 6e6e 656c 5f64 6174  tion_channel_dat
+00010f10: 6120 2d3d 206e 702e 6e61 6e6d 6561 6e28  a -= np.nanmean(
+00010f20: 6261 7365 6c69 6e65 5f64 6174 612c 2061  baseline_data, a
+00010f30: 7869 733d 3129 5b3a 2c20 4e6f 6e65 5d0a  xis=1)[:, None].
+00010f40: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00010f50: 2062 6173 656c 696e 655f 6d65 7468 6f64   baseline_method
+00010f60: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+00010f70: 2020 2020 2020 2063 6f6e 6469 7469 6f6e         condition
+00010f80: 5f63 6861 6e6e 656c 5f64 6174 6120 2d3d  _channel_data -=
+00010f90: 206e 702e 6e61 6e6d 6564 6961 6e28 6261   np.nanmedian(ba
+00010fa0: 7365 6c69 6e65 5f64 6174 612c 2061 7869  seline_data, axi
+00010fb0: 733d 3129 5b3a 2c20 4e6f 6e65 5d0a 0a20  s=1)[:, None].. 
+00010fc0: 2020 2020 2020 2023 2061 7665 7261 6765         # average
+00010fd0: 2074 6865 2074 7269 616c 7320 666f 7220   the trials for 
+00010fe0: 6561 6368 2063 6861 6e6e 656c 2028 7769  each channel (wi
+00010ff0: 7468 696e 2074 6869 7320 636f 6e64 6974  thin this condit
+00011000: 696f 6e29 2061 6e64 2073 746f 7265 2074  ion) and store t
+00011010: 6865 2072 6573 756c 7473 0a20 2020 2020  he results.     
+00011020: 2020 2072 6566 5f64 6174 615b 6368 616e     ref_data[chan
+00011030: 6e65 6c5f 6964 782c 2063 6f6e 6469 7469  nel_idx, conditi
+00011040: 6f6e 5f69 6478 2c20 3a5d 203d 206e 702e  on_idx, :] = np.
+00011050: 6e61 6e6d 6561 6e28 636f 6e64 6974 696f  nanmean(conditio
+00011060: 6e5f 6368 616e 6e65 6c5f 6461 7461 2c20  n_channel_data, 
+00011070: 6178 6973 3d30 290a 0a20 2020 2020 2020  axis=0)..       
+00011080: 2023 2063 6c65 6172 2072 6566 6572 656e   # clear referen
+00011090: 6365 2074 6f20 6461 7461 0a20 2020 2020  ce to data.     
+000110a0: 2020 2064 656c 2063 6f6e 6469 7469 6f6e     del condition
+000110b0: 5f63 6861 6e6e 656c 5f64 6174 610a 0a20  _channel_data.. 
+000110c0: 2020 2023 0a20 2020 2072 6574 7572 6e20     #.    return 
+000110d0: 6461 7461 5f72 6561 6465 722e 7361 6d70  data_reader.samp
+000110e0: 6c69 6e67 5f72 6174 652c 2072 6566 5f64  ling_rate, ref_d
+000110f0: 6174 612c 2072 6566 5f6d 6574 7269 635f  ata, ref_metric_
+00011100: 7661 6c75 6573 0a0a 0a64 6566 205f 5f6c  values...def __l
+00011110: 6f61 645f 6461 7461 5f65 706f 6368 5f61  oad_data_epoch_a
+00011120: 7665 7261 6765 735f 5f62 795f 6368 616e  verages__by_chan
+00011130: 6e65 6c5f 636f 6e64 6974 696f 6e5f 7472  nel_condition_tr
+00011140: 6961 6c28 6461 7461 5f72 6561 6465 722c  ial(data_reader,
+00011150: 2063 6861 6e6e 656c 732c 0a20 2020 2020   channels,.     
+00011160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011190: 2020 2020 2020 636f 6e64 6974 696f 6e73        conditions
+000111a0: 5f6f 6e73 6574 732c 2074 7269 616c 5f65  _onsets, trial_e
+000111b0: 706f 6368 2c0a 2020 2020 2020 2020 2020  poch,.          
+000111c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111f0: 2062 6173 656c 696e 655f 6d65 7468 6f64   baseline_method
+00011200: 2c20 6261 7365 6c69 6e65 5f65 706f 6368  , baseline_epoch
+00011210: 2c20 6f75 745f 6f66 5f62 6f75 6e64 5f6d  , out_of_bound_m
+00011220: 6574 686f 642c 206d 6574 7269 635f 6361  ethod, metric_ca
+00011230: 6c6c 6261 636b 7329 3a0a 2020 2020 2222  llbacks):.    ""
+00011240: 220a 2020 2020 4c6f 6164 2064 6174 6120  ".    Load data 
+00011250: 6570 6f63 6820 6176 6572 6167 6573 2074  epoch averages t
+00011260: 6f20 6120 6d61 7472 6978 2028 666f 726d  o a matrix (form
+00011270: 6174 3a20 6368 616e 6e65 6c20 7820 636f  at: channel x co
+00011280: 6e64 6974 696f 6e20 7820 7469 6d65 2920  ndition x time) 
+00011290: 6279 206c 6f6f 7069 6e67 206f 7665 7220  by looping over 
+000112a0: 6368 616e 6e65 6c73 2c20 7468 656e 206f  channels, then o
+000112b0: 7665 720a 2020 2020 636f 6e64 6974 696f  ver.    conditio
+000112c0: 6e73 2061 6e64 2074 6865 6e20 7769 7468  ns and then with
+000112d0: 696e 2074 6861 7420 6368 616e 6e65 6c2d  in that channel-
+000112e0: 636f 6e64 6974 696f 6e20 636f 6d62 696e  condition combin
+000112f0: 6174 696f 6e20 6c6f 6f70 206f 7665 7220  ation loop over 
+00011300: 6561 6368 206f 6620 7468 6520 7472 6961  each of the tria
+00011310: 6c73 2074 6f20 6c6f 6164 2074 6865 2073  ls to load the s
+00011320: 7065 6369 6669 630a 2020 2020 6368 616e  pecific.    chan
+00011330: 6e65 6c2d 636f 6e64 6974 696f 6e2d 7472  nel-condition-tr
+00011340: 6961 6c20 6461 7461 2e20 5468 6520 6176  ial data. The av
+00011350: 6572 6167 696e 6720 2861 6e64 206d 6574  eraging (and met
+00011360: 7269 6320 6361 6c63 756c 6174 696f 6e29  ric calculation)
+00011370: 2069 7320 7065 7266 6f72 6d65 6420 6f6e   is performed on
+00011380: 2061 2074 656d 706f 7261 7279 206d 6174   a temporary mat
+00011390: 7269 7820 696e 2074 6865 0a20 2020 2063  rix in the.    c
+000113a0: 6861 6e6e 656c 206c 6f6f 700a 0a20 2020  hannel loop..   
+000113b0: 204e 6f74 653a 2020 2020 2054 6869 7320   Note:     This 
+000113c0: 6675 6e63 7469 6f6e 2069 7320 6576 656e  function is even
+000113d0: 206d 6f72 6520 6d65 6d6f 7279 2065 6666   more memory eff
+000113e0: 6963 6965 6e74 2074 6861 6e20 275f 5f6c  icient than '__l
+000113f0: 6f61 645f 6461 7461 5f65 706f 6368 5f61  oad_data_epoch_a
+00011400: 7665 7261 6765 735f 5f62 795f 636f 6e64  verages__by_cond
+00011410: 6974 696f 6e5f 7472 6961 6c27 2c20 6275  ition_trial', bu
+00011420: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00011430: 736c 6f77 6572 2066 6f72 204d 4546 332e  slower for MEF3.
+00011440: 2046 6f72 2045 4446 2061 6e64 2042 7261   For EDF and Bra
+00011450: 696e 5669 7369 6f6e 2074 6865 7265 2069  inVision there i
+00011460: 7320 6e6f 7420 6d75 6368 2064 6966 6665  s not much diffe
+00011470: 7265 6e63 6520 6265 6361 7573 6520 4d4e  rence because MN
+00011480: 4520 7072 656c 6f61 6473 2074 6865 0a20  E preloads the. 
+00011490: 2020 2020 2020 2020 2020 2020 2077 686f               who
+000114a0: 6c65 2073 6574 2074 6f20 6d65 6d6f 7279  le set to memory
+000114b0: 2066 6972 7374 2c20 736f 206a 7573 7420   first, so just 
+000114c0: 6e75 6d70 792d 7669 6577 7320 6172 6520  numpy-views are 
+000114d0: 7265 7475 726e 6564 2061 6e64 2075 7365  returned and use
+000114e0: 642e 0a20 2020 2022 2222 0a0a 2020 2020  d..    """..    
+000114f0: 2320 6361 6c63 756c 6174 6520 7468 6520  # calculate the 
+00011500: 7369 7a65 206f 6620 7468 6520 7469 6d65  size of the time
+00011510: 2064 696d 656e 7369 6f6e 2028 696e 2073   dimension (in s
+00011520: 616d 706c 6573 290a 2020 2020 7472 6961  amples).    tria
+00011530: 6c5f 6e75 6d5f 7361 6d70 6c65 7320 3d20  l_num_samples = 
+00011540: 696e 7428 726f 756e 6428 6162 7328 7472  int(round(abs(tr
+00011550: 6961 6c5f 6570 6f63 685b 315d 202d 2074  ial_epoch[1] - t
+00011560: 7269 616c 5f65 706f 6368 5b30 5d29 202a  rial_epoch[0]) *
+00011570: 2064 6174 615f 7265 6164 6572 2e73 616d   data_reader.sam
+00011580: 706c 696e 675f 7261 7465 2929 0a20 2020  pling_rate)).   
+00011590: 2062 6173 656c 696e 655f 6e75 6d5f 7361   baseline_num_sa
+000115a0: 6d70 6c65 7320 3d20 696e 7428 726f 756e  mples = int(roun
+000115b0: 6428 6162 7328 6261 7365 6c69 6e65 5f65  d(abs(baseline_e
+000115c0: 706f 6368 5b31 5d20 2d20 6261 7365 6c69  poch[1] - baseli
+000115d0: 6e65 5f65 706f 6368 5b30 5d29 202a 2064  ne_epoch[0]) * d
+000115e0: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
+000115f0: 696e 675f 7261 7465 2929 0a0a 2020 2020  ing_rate))..    
+00011600: 2320 696e 6974 6961 6c69 7a65 2061 2064  # initialize a d
+00011610: 6174 6120 6275 6666 6572 2028 6368 616e  ata buffer (chan
+00011620: 6e65 6c20 7820 636f 6e64 6974 696f 6e73  nel x conditions
+00011630: 2078 2073 616d 706c 6573 290a 2020 2020   x samples).    
+00011640: 7472 793a 0a20 2020 2020 2020 2064 6174  try:.        dat
+00011650: 6120 3d20 616c 6c6f 6361 7465 5f61 7272  a = allocate_arr
+00011660: 6179 2828 6c65 6e28 6368 616e 6e65 6c73  ay((len(channels
+00011670: 292c 206c 656e 2863 6f6e 6469 7469 6f6e  ), len(condition
+00011680: 735f 6f6e 7365 7473 292c 2074 7269 616c  s_onsets), trial
+00011690: 5f6e 756d 5f73 616d 706c 6573 2929 0a20  _num_samples)). 
+000116a0: 2020 2065 7863 6570 7420 4d65 6d6f 7279     except Memory
+000116b0: 4572 726f 723a 0a20 2020 2020 2020 2072  Error:.        r
+000116c0: 6169 7365 204d 656d 6f72 7945 7272 6f72  aise MemoryError
+000116d0: 2827 4e6f 7420 656e 6f75 6768 206d 656d  ('Not enough mem
+000116e0: 6f72 7920 6372 6561 7465 2061 2064 6174  ory create a dat
+000116f0: 6120 6f75 7470 7574 206d 6174 7269 7827  a output matrix'
+00011700: 290a 0a20 2020 2023 2069 6e69 7469 616c  )..    # initial
+00011710: 697a 6520 6120 6d65 7472 6963 2062 7566  ize a metric buf
+00011720: 6665 7220 2863 6861 6e6e 656c 2078 2063  fer (channel x c
+00011730: 6f6e 6469 7469 6f6e 7320 7820 6d65 7472  onditions x metr
+00011740: 6963 290a 2020 2020 7472 793a 0a20 2020  ic).    try:.   
+00011750: 2020 2020 206d 6574 7269 635f 7661 6c75       metric_valu
+00011760: 6573 203d 204e 6f6e 650a 2020 2020 2020  es = None.      
+00011770: 2020 6966 206d 6574 7269 635f 6361 6c6c    if metric_call
+00011780: 6261 636b 7320 6973 206e 6f74 204e 6f6e  backs is not Non
+00011790: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+000117a0: 6620 6361 6c6c 6162 6c65 286d 6574 7269  f callable(metri
+000117b0: 635f 6361 6c6c 6261 636b 7329 3a0a 2020  c_callbacks):.  
+000117c0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+000117d0: 7472 6963 5f76 616c 7565 7320 3d20 616c  tric_values = al
+000117e0: 6c6f 6361 7465 5f61 7272 6179 2828 6c65  locate_array((le
+000117f0: 6e28 6368 616e 6e65 6c73 292c 206c 656e  n(channels), len
+00011800: 2863 6f6e 6469 7469 6f6e 735f 6f6e 7365  (conditions_onse
+00011810: 7473 2929 290a 2020 2020 2020 2020 2020  ts))).          
+00011820: 2020 656c 6966 2074 7970 6528 6d65 7472    elif type(metr
+00011830: 6963 5f63 616c 6c62 6163 6b73 2920 6973  ic_callbacks) is
+00011840: 2074 7570 6c65 2061 6e64 206c 656e 286d   tuple and len(m
+00011850: 6574 7269 635f 6361 6c6c 6261 636b 7329  etric_callbacks)
+00011860: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
+00011870: 2020 2020 2020 6d65 7472 6963 5f76 616c        metric_val
+00011880: 7565 7320 3d20 616c 6c6f 6361 7465 5f61  ues = allocate_a
+00011890: 7272 6179 2828 6c65 6e28 6368 616e 6e65  rray((len(channe
+000118a0: 6c73 292c 206c 656e 2863 6f6e 6469 7469  ls), len(conditi
+000118b0: 6f6e 735f 6f6e 7365 7473 292c 206c 656e  ons_onsets), len
+000118c0: 286d 6574 7269 635f 6361 6c6c 6261 636b  (metric_callback
+000118d0: 7329 2929 0a20 2020 2065 7863 6570 7420  s))).    except 
+000118e0: 4d65 6d6f 7279 4572 726f 723a 0a20 2020  MemoryError:.   
+000118f0: 2020 2020 2072 6169 7365 204d 656d 6f72       raise Memor
+00011900: 7945 7272 6f72 2827 4e6f 7420 656e 6f75  yError('Not enou
+00011910: 6768 206d 656d 6f72 7920 6372 6561 7465  gh memory create
+00011920: 2061 206d 6574 7269 6320 6f75 7470 7574   a metric output
+00011930: 206d 6174 7269 7827 290a 0a20 2020 2023   matrix')..    #
+00011940: 2063 7265 6174 6520 7072 6f67 7265 7373   create progress
+00011950: 2062 6172 0a20 2020 2070 7269 6e74 5f70   bar.    print_p
+00011960: 726f 6772 6573 7362 6172 2830 2c20 6c65  rogressbar(0, le
+00011970: 6e28 636f 6e64 6974 696f 6e73 5f6f 6e73  n(conditions_ons
+00011980: 6574 7329 2c20 7072 6566 6978 3d27 5072  ets), prefix='Pr
+00011990: 6f67 7265 7373 3a27 2c20 7375 6666 6978  ogress:', suffix
+000119a0: 3d27 436f 6d70 6c65 7465 272c 206c 656e  ='Complete', len
+000119b0: 6774 683d 3530 290a 0a20 2020 2023 206c  gth=50)..    # l
+000119c0: 6f6f 7020 7468 726f 7567 6820 7468 6520  oop through the 
+000119d0: 6368 616e 6e65 6c73 0a20 2020 2066 6f72  channels.    for
+000119e0: 2063 6861 6e6e 656c 5f69 6478 2069 6e20   channel_idx in 
+000119f0: 7261 6e67 6528 6c65 6e28 6368 616e 6e65  range(len(channe
+00011a00: 6c73 2929 3a0a 0a20 2020 2020 2020 2023  ls)):..        #
+00011a10: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00011a20: 2020 2020 2020 2020 2020 5f5f 7375 626c            __subl
+00011a30: 6f61 645f 6461 7461 5f65 706f 6368 5f61  oad_data_epoch_a
+00011a40: 7665 7261 6765 735f 5f66 726f 6d5f 6368  verages__from_ch
+00011a50: 616e 6e65 6c5f 5f62 795f 636f 6e64 6974  annel__by_condit
+00011a60: 696f 6e5f 7472 6961 6c73 2864 6174 612c  ion_trials(data,
+00011a70: 206d 6574 7269 635f 7661 6c75 6573 2c0a   metric_values,.
+00011a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00011ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ad0: 2020 2020 2020 6d65 7472 6963 5f63 616c        metric_cal
-00011ae0: 6c62 6163 6b73 290a 2020 2020 2020 2020  lbacks).        
-00011af0: 6578 6365 7074 2028 4d65 6d6f 7279 4572  except (MemoryEr
-00011b00: 726f 722c 2052 756e 7469 6d65 4572 726f  ror, RuntimeErro
-00011b10: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00011b20: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-00011b30: 6f72 2827 4572 726f 7220 7570 6f6e 206c  or('Error upon l
-00011b40: 6f61 6469 6e67 2c20 6570 6f63 6869 6e67  oading, epoching
-00011b50: 2061 6e64 2061 7665 7261 6769 6e67 2064   and averaging d
-00011b60: 6174 6127 290a 0a20 2020 2020 2020 2023  ata')..        #
-00011b70: 2075 7064 6174 6520 7072 6f67 7265 7373   update progress
-00011b80: 2062 6172 0a20 2020 2020 2020 2070 7269   bar.        pri
-00011b90: 6e74 5f70 726f 6772 6573 7362 6172 2863  nt_progressbar(c
-00011ba0: 6861 6e6e 656c 5f69 6478 202b 2031 2c20  hannel_idx + 1, 
-00011bb0: 6c65 6e28 6368 616e 6e65 6c73 292c 2070  len(channels), p
-00011bc0: 7265 6669 783d 2750 726f 6772 6573 733a  refix='Progress:
-00011bd0: 272c 2073 7566 6669 783d 2743 6f6d 706c  ', suffix='Compl
-00011be0: 6574 6527 2c20 6c65 6e67 7468 3d35 3029  ete', length=50)
-00011bf0: 0a0a 2020 2020 2320 7265 7475 726e 2074  ..    # return t
-00011c00: 6865 2073 616d 706c 6520 7261 7465 2c20  he sample rate, 
-00011c10: 7468 6520 6176 6572 6167 6520 6570 6f63  the average epoc
-00011c20: 6820 616e 6420 7468 6520 6d65 7472 6963  h and the metric
-00011c30: 2076 616c 7565 7320 284e 6f6e 6520 6966   values (None if
-00011c40: 206e 6f20 6d65 7472 6963 7329 0a20 2020   no metrics).   
-00011c50: 2072 6574 7572 6e20 6461 7461 5f72 6561   return data_rea
-00011c60: 6465 722e 7361 6d70 6c69 6e67 5f72 6174  der.sampling_rat
-00011c70: 652c 2064 6174 612c 206d 6574 7269 635f  e, data, metric_
-00011c80: 7661 6c75 6573 0a0a 0a64 6566 205f 5f6c  values...def __l
-00011c90: 6f61 645f 6461 7461 5f65 706f 6368 735f  oad_data_epochs_
-00011ca0: 5f62 795f 6368 616e 6e65 6c73 5f5f 7769  _by_channels__wi
-00011cb0: 7468 5072 6570 2861 7665 7261 6765 2c20  thPrep(average, 
-00011cc0: 6461 7461 5f72 6561 6465 722c 2072 6574  data_reader, ret
-00011cd0: 7269 6576 655f 6368 616e 6e65 6c73 2c20  rieve_channels, 
-00011ce0: 6f6e 7365 7473 2c0a 2020 2020 2020 2020  onsets,.        
-00011cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d10: 2020 2020 2020 7472 6961 6c5f 6570 6f63        trial_epoc
-00011d20: 682c 2062 6173 656c 696e 655f 6d65 7468  h, baseline_meth
-00011d30: 6f64 2c20 6261 7365 6c69 6e65 5f65 706f  od, baseline_epo
-00011d40: 6368 2c0a 2020 2020 2020 2020 2020 2020  ch,.            
-00011d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011d70: 2020 6f75 745f 6f66 5f62 6f75 6e64 5f6d    out_of_bound_m
-00011d80: 6574 686f 642c 206d 6574 7269 635f 6361  ethod, metric_ca
-00011d90: 6c6c 6261 636b 732c 0a20 2020 2020 2020  llbacks,.       
-00011da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011dc0: 2020 2020 2020 2068 6967 685f 7061 7373         high_pass
-00011dd0: 2c20 6561 726c 795f 7265 7265 662c 206c  , early_reref, l
-00011de0: 696e 655f 6e6f 6973 655f 7265 6d6f 7661  ine_noise_remova
-00011df0: 6c2c 206c 6174 655f 7265 7265 662c 2070  l, late_reref, p
-00011e00: 7269 6f72 6974 7929 3a0a 2020 2020 2222  riority):.    ""
-00011e10: 220a 2020 2020 4c6f 6164 2074 6865 2064  ".    Load the d
-00011e20: 6174 612c 2070 7265 7072 6f63 6573 7320  ata, preprocess 
-00011e30: 616e 6420 6569 7468 6572 2065 706f 6368  and either epoch
-00011e40: 206f 7220 286f 7074 696f 6e61 6c6c 7929   or (optionally)
-00011e50: 2063 616c 6375 6c61 7465 206d 6574 7269   calculate metri
-00011e60: 6373 2061 6e64 2065 706f 6368 2d61 7665  cs and epoch-ave
-00011e70: 7261 6765 2074 6f20 6120 6d61 7472 6978  rage to a matrix
-00011e80: 2e0a 2020 2020 5468 6973 2066 756e 6374  ..    This funct
-00011e90: 696f 6e20 7072 6f63 6573 7365 7320 6461  ion processes da
-00011ea0: 7461 2070 6572 2063 6861 6e6e 656c 2069  ta per channel i
-00011eb0: 6e20 6f72 6465 7220 746f 206d 696e 696d  n order to minim
-00011ec0: 697a 6520 6d65 6d6f 7279 2075 7361 6765  ize memory usage
-00011ed0: 2062 7574 2073 7469 6c6c 2062 6520 6162   but still be ab
-00011ee0: 6c65 2074 6f20 6170 706c 7920 7072 6570  le to apply prep
-00011ef0: 726f 6365 7373 696e 670a 2020 2020 7374  rocessing.    st
-00011f00: 6570 7320 286f 7074 696f 6e61 6c6c 793a  eps (optionally:
-00011f10: 2068 6967 682d 7061 7373 2066 696c 7465   high-pass filte
-00011f20: 7269 6e67 2c20 6561 726c 7920 7265 2d72  ring, early re-r
-00011f30: 6566 6572 656e 6369 6e67 2c20 6c69 6e65  eferencing, line
-00011f40: 2d6e 6f69 7365 2072 656d 6f76 616c 2061  -noise removal a
-00011f50: 6e64 206c 6174 6520 7265 2d72 6566 6572  nd late re-refer
-00011f60: 656e 6369 6e67 292e 0a20 2020 2041 6674  encing)..    Aft
-00011f70: 6572 2070 7265 7072 6f63 6573 7369 6e67  er preprocessing
-00011f80: 2c20 7468 6520 6368 616e 6e65 6c20 6461  , the channel da
-00011f90: 7461 2069 7320 6569 7468 6572 2065 706f  ta is either epo
-00011fa0: 6368 6564 2061 6e64 2072 6574 7572 6e65  ched and returne
-00011fb0: 6420 696e 2061 206d 6174 7269 7820 2866  d in a matrix (f
-00011fc0: 6f72 6d61 743a 2063 6861 6e6e 656c 2078  ormat: channel x
-00011fd0: 2074 7269 616c 732f 6570 6f63 6873 2078   trials/epochs x
-00011fe0: 2074 696d 6529 2c0a 2020 2020 6f72 2028   time),.    or (
-00011ff0: 6f70 7469 6f6e 616c 6c79 2920 6d65 7472  optionally) metr
-00012000: 6963 7320 6172 6520 6361 6c63 756c 6174  ics are calculat
-00012010: 6564 2061 6e64 2074 6865 2065 706f 6368  ed and the epoch
-00012020: 2d61 7665 7261 6765 2069 7320 696e 2061  -average is in a
-00012030: 206d 6174 7269 7820 2866 6f72 6d61 743a   matrix (format:
-00012040: 2063 6861 6e6e 656c 2078 2063 6f6e 6469   channel x condi
-00012050: 7469 6f6e 2078 2074 696d 6529 2e0a 2020  tion x time)..  
-00012060: 2020 496e 2061 6464 6974 696f 6e2c 2061    In addition, a
-00012070: 6e20 6f70 7469 6d69 7a65 6420 7061 7261  n optimized para
-00012080: 6d65 7465 7220 6361 6e20 6265 2073 6574  meter can be set
-00012090: 2074 6f20 6569 7468 6572 2027 6d65 6d27   to either 'mem'
-000120a0: 206f 7220 2773 7065 6564 273b 2027 6d65   or 'speed'; 'me
-000120b0: 6d27 2077 696c 6c20 756e 6c6f 6164 2074  m' will unload t
-000120c0: 6865 2063 6861 6e6e 656c 2069 6e62 6574  he channel inbet
-000120d0: 7765 656e 0a20 2020 2070 726f 6365 7373  ween.    process
-000120e0: 696e 6720 7374 6570 732c 206d 616b 696e  ing steps, makin
-000120f0: 6720 7468 6520 7072 6f63 6573 7320 736c  g the process sl
-00012100: 6f77 6572 2062 7574 206d 6f73 7420 6d65  ower but most me
-00012110: 6d6f 7279 2065 6666 6963 6965 6e74 3b20  mory efficient; 
-00012120: 2773 7065 6564 2720 7769 6c6c 206b 6565  'speed' will kee
-00012130: 7020 7468 6520 6368 616e 6e65 6c20 6461  p the channel da
-00012140: 7461 2069 6e20 6d65 6d6f 7279 0a20 2020  ta in memory.   
-00012150: 2074 6872 6f75 6768 6f75 7420 7468 6520   throughout the 
-00012160: 7072 6f63 6573 7369 6e67 2c20 616c 6c6f  processing, allo
-00012170: 7769 6e67 2066 6f72 206d 6f72 6520 7370  wing for more sp
-00012180: 6565 6420 6275 7420 616c 736f 2072 6571  eed but also req
-00012190: 7569 7269 6e67 206d 6f72 6520 6d65 6d6f  uiring more memo
-000121a0: 7279 2e0a 0a0a 2020 2020 4e6f 7465 3a20  ry....    Note: 
-000121b0: 2020 4e6f 7465 2074 6861 7420 666f 7220    Note that for 
-000121c0: 7072 6570 726f 6365 7373 696e 6720 7468  preprocessing th
-000121d0: 6520 4544 4620 6f72 2042 7261 696e 5669  e EDF or BrainVi
-000121e0: 7369 6f6e 2066 6f72 6d61 7420 616c 7265  sion format alre
-000121f0: 6164 7920 6c6f 6164 2074 6865 2065 6e74  ady load the ent
-00012200: 6972 6520 7365 7420 696e 206d 656d 6f72  ire set in memor
-00012210: 792e 2050 7265 7072 6f63 6573 7369 6e67  y. Preprocessing
-00012220: 0a20 2020 2020 2020 2020 2020 2077 696c  .            wil
-00012230: 6c20 7265 7175 6972 6520 6120 636f 7079  l require a copy
-00012240: 206f 6620 7468 6520 6368 616e 6e65 6c20   of the channel 
-00012250: 6461 7461 2066 6f72 206d 616e 6970 756c  data for manipul
-00012260: 6174 696f 6e2c 2073 6f20 7468 6572 6520  ation, so there 
-00012270: 6973 206e 6f20 6d65 6d6f 7279 2062 656e  is no memory ben
-00012280: 6566 6974 2069 6e20 7468 6520 6661 6374  efit in the fact
-00012290: 2074 6861 740a 2020 2020 2020 2020 2020   that.          
-000122a0: 2020 4d4e 4520 616c 7265 6164 7920 6c6f    MNE already lo
-000122b0: 6164 7320 7468 6520 656e 7469 7265 2064  ads the entire d
-000122c0: 6174 6173 6574 2069 6e74 6f20 6d65 6d6f  ataset into memo
-000122d0: 7279 2e0a 0a20 2020 2041 7267 733a 0a20  ry...    Args:. 
-000122e0: 2020 2020 2020 2061 7665 7261 6765 2028         average (
-000122f0: 626f 6f6c 6561 6e29 3a20 2020 2020 2020  boolean):       
-00012300: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
-00012310: 6572 2c20 6166 7465 7220 7072 6570 726f  er, after prepro
-00012320: 6365 7373 696e 672c 206f 6e6c 7920 6570  cessing, only ep
-00012330: 6f63 6873 2028 4661 6c73 6529 2073 686f  ochs (False) sho
-00012340: 756c 6420 6265 2065 7874 7261 6374 6564  uld be extracted
-00012350: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
-00012360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012380: 2072 6574 7572 6e65 642c 206f 7220 7768   returned, or wh
-00012390: 6574 6865 7220 286f 7074 696f 6e61 6c6c  ether (optionall
-000123a0: 7929 206d 6574 7269 6373 2073 686f 756c  y) metrics shoul
-000123b0: 6420 6265 2063 616c 6375 6c61 7465 6420  d be calculated 
-000123c0: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
-000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000123f0: 6570 6f63 682d 6176 6572 6167 6573 2073  epoch-averages s
-00012400: 686f 756c 6420 6265 2072 6574 7572 6e65  hould be returne
-00012410: 6420 2854 7275 6529 0a20 2020 2020 2020  d (True).       
-00012420: 2064 6174 615f 7265 6164 6572 2028 4965   data_reader (Ie
-00012430: 6567 4461 7461 5265 6164 6572 293a 2020  egDataReader):  
-00012440: 2020 2020 2041 6e20 696e 7374 616e 6365       An instance
-00012450: 206f 6620 7468 6520 4965 6567 4461 7461   of the IeegData
-00012460: 5265 6164 6572 2074 6f20 7265 7472 6965  Reader to retrie
-00012470: 7665 206d 6574 6164 6174 6120 616e 6420  ve metadata and 
-00012480: 6368 616e 6e65 6c20 6461 7461 0a20 2020  channel data.   
-00012490: 2020 2020 2072 6574 7269 6576 655f 6368       retrieve_ch
-000124a0: 616e 6e65 6c73 2028 6c69 7374 206f 7220  annels (list or 
-000124b0: 7475 706c 6529 3a20 2054 6865 2063 6861  tuple):  The cha
-000124c0: 6e6e 656c 7320 2862 7920 6e61 6d65 2920  nnels (by name) 
-000124d0: 6f66 2077 6869 6368 2074 6865 2064 6174  of which the dat
-000124e0: 6120 7368 6f75 6c64 2062 6520 7265 7472  a should be retr
-000124f0: 6965 7665 642c 2074 6865 206f 7574 7075  ieved, the outpu
-00012500: 7420 7769 6c6c 2062 6520 736f 7274 6564  t will be sorted
-00012510: 2061 6363 6f72 6469 6e67 6c79 0a20 2020   accordingly.   
-00012520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012540: 2020 2020 2020 2020 204e 6f74 653a 2074           Note: t
-00012550: 6861 7420 7468 6973 2064 6f65 7320 6e6f  hat this does no
-00012560: 7420 6861 7665 2074 6f20 696e 636c 7564  t have to includ
-00012570: 6520 7468 6520 6368 616e 6e65 6c73 2074  e the channels t
-00012580: 6861 7420 6172 6520 7265 7175 6972 6564  hat are required
-00012590: 2066 6f72 2072 652d 7265 6665 7265 6e63   for re-referenc
-000125a0: 696e 670a 0a20 2020 2020 2020 206f 6e73  ing..        ons
-000125b0: 6574 7320 2831 642f 3264 206c 6973 7420  ets (1d/2d list 
-000125c0: 6f72 2074 7570 6c65 293a 2020 2020 2020  or tuple):      
-000125d0: 2049 6620 6f6e 6c79 2074 6865 2065 706f   If only the epo
-000125e0: 6368 7320 6e65 6564 2074 6f20 6265 2065  chs need to be e
-000125f0: 7874 7261 6374 6564 2061 6e64 2072 6574  xtracted and ret
-00012600: 7572 6e65 6420 2861 7665 7261 6765 3d46  urned (average=F
-00012610: 616c 7365 2920 7468 656e 2074 6869 730a  alse) then this.
-00012620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012640: 2020 2020 2020 2020 2020 2020 6172 6775              argu
-00012650: 6d65 6e74 2073 686f 756c 6420 6265 2061  ment should be a
-00012660: 2031 6420 6c69 7374 206f 7220 7475 706c   1d list or tupl
-00012670: 6520 7468 6174 2068 6f6c 6473 2074 6865  e that holds the
-00012680: 206f 6e73 6574 7320 6f66 2074 6865 2074   onsets of the t
-00012690: 7269 616c 7320 6172 6f75 6e64 0a20 2020  rials around.   
-000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126c0: 2020 2020 2020 2020 2077 6869 6368 2074           which t
-000126d0: 6f20 6570 6f63 6820 7468 6520 6461 7461  o epoch the data
-000126e0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000126f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012700: 2020 2020 2020 2020 2020 2020 2020 4966                If
-00012710: 206d 6574 7269 6320 616e 6420 6176 6572   metric and aver
-00012720: 6167 652d 6570 6f63 6873 206e 6565 6420  age-epochs need 
-00012730: 746f 2062 6520 6361 6c63 756c 6174 6564  to be calculated
-00012740: 2061 6e64 2072 6574 7572 6e65 6420 2841   and returned (A
-00012750: 7665 7261 6765 3d54 7275 6529 2074 6865  verage=True) the
-00012760: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00012770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012780: 2020 2020 2020 2020 2020 2020 2020 7468                th
-00012790: 6973 2061 7267 756d 656e 7420 7368 6f75  is argument shou
-000127a0: 6c64 2062 6520 6120 3264 206c 6973 7420  ld be a 2d list 
-000127b0: 6f72 2074 7570 6c65 2074 6861 7420 696e  or tuple that in
-000127c0: 6469 6361 7465 7320 7468 6520 636f 6e64  dicates the cond
-000127d0: 6974 696f 6e73 2c20 616e 640a 2020 2020  itions, and.    
-000127e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012800: 2020 2020 2020 2020 7468 6520 6f6e 7365          the onse
-00012810: 7473 206f 6620 7468 6520 7472 6961 6c73  ts of the trials
-00012820: 2074 6861 7420 6265 6c6f 6e67 2074 6f20   that belong to 
-00012830: 6561 6368 2063 6f6e 6469 7469 6f6e 2e20  each condition. 
-00012840: 2866 6f72 6d61 743a 2063 6f6e 6469 7469  (format: conditi
-00012850: 6f6e 7320 7820 636f 6e64 6974 696f 6e20  ons x condition 
-00012860: 6f6e 7365 7473 290a 2020 2020 2222 220a  onsets).    """.
-00012870: 0a20 2020 2023 2063 616c 6375 6c61 7465  .    # calculate
-00012880: 2074 6865 2073 697a 6520 6f66 2074 6865   the size of the
-00012890: 2074 696d 6520 6469 6d65 6e73 696f 6e20   time dimension 
-000128a0: 2869 6e20 7361 6d70 6c65 7329 0a20 2020  (in samples).   
-000128b0: 2074 7269 616c 5f6e 756d 5f73 616d 706c   trial_num_sampl
-000128c0: 6573 203d 2069 6e74 2872 6f75 6e64 2861  es = int(round(a
-000128d0: 6273 2874 7269 616c 5f65 706f 6368 5b31  bs(trial_epoch[1
-000128e0: 5d20 2d20 7472 6961 6c5f 6570 6f63 685b  ] - trial_epoch[
-000128f0: 305d 2920 2a20 6461 7461 5f72 6561 6465  0]) * data_reade
-00012900: 722e 7361 6d70 6c69 6e67 5f72 6174 6529  r.sampling_rate)
-00012910: 290a 2020 2020 6261 7365 6c69 6e65 5f6e  ).    baseline_n
-00012920: 756d 5f73 616d 706c 6573 203d 2069 6e74  um_samples = int
-00012930: 2872 6f75 6e64 2861 6273 2862 6173 656c  (round(abs(basel
-00012940: 696e 655f 6570 6f63 685b 315d 202d 2062  ine_epoch[1] - b
-00012950: 6173 656c 696e 655f 6570 6f63 685b 305d  aseline_epoch[0]
-00012960: 2920 2a20 6461 7461 5f72 6561 6465 722e  ) * data_reader.
-00012970: 7361 6d70 6c69 6e67 5f72 6174 6529 290a  sampling_rate)).
-00012980: 0a20 2020 2023 2069 6e69 7469 616c 697a  .    # initializ
-00012990: 6520 6120 6461 7461 2062 7566 6665 7220  e a data buffer 
-000129a0: 2863 6861 6e6e 656c 2078 2074 7269 616c  (channel x trial
-000129b0: 732f 6570 6f63 6873 2078 2074 696d 6529  s/epochs x time)
-000129c0: 0a20 2020 2074 7279 3a0a 2020 2020 2020  .    try:.      
-000129d0: 2020 6461 7461 203d 2061 6c6c 6f63 6174    data = allocat
-000129e0: 655f 6172 7261 7928 286c 656e 2872 6574  e_array((len(ret
-000129f0: 7269 6576 655f 6368 616e 6e65 6c73 292c  rieve_channels),
-00012a00: 206c 656e 286f 6e73 6574 7329 2c20 7472   len(onsets), tr
-00012a10: 6961 6c5f 6e75 6d5f 7361 6d70 6c65 7329  ial_num_samples)
-00012a20: 290a 2020 2020 6578 6365 7074 204d 656d  ).    except Mem
-00012a30: 6f72 7945 7272 6f72 3a0a 2020 2020 2020  oryError:.      
-00012a40: 2020 7261 6973 6520 4d65 6d6f 7279 4572    raise MemoryEr
-00012a50: 726f 7228 274e 6f74 2065 6e6f 7567 6820  ror('Not enough 
-00012a60: 6d65 6d6f 7279 2063 7265 6174 6520 6120  memory create a 
-00012a70: 6461 7461 206f 7574 7075 7420 6d61 7472  data output matr
-00012a80: 6978 2729 0a0a 2020 2020 2320 696e 6974  ix')..    # init
-00012a90: 6961 6c69 7a65 2061 206d 6574 7269 6320  ialize a metric 
-00012aa0: 6275 6666 6572 2028 6368 616e 6e65 6c20  buffer (channel 
-00012ab0: 7820 636f 6e64 6974 696f 6e73 2078 206d  x conditions x m
-00012ac0: 6574 7269 6329 0a20 2020 2069 6620 6176  etric).    if av
-00012ad0: 6572 6167 653a 0a20 2020 2020 2020 2074  erage:.        t
-00012ae0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00012af0: 6d65 7472 6963 5f76 616c 7565 7320 3d20  metric_values = 
-00012b00: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00012b10: 2069 6620 6d65 7472 6963 5f63 616c 6c62   if metric_callb
-00012b20: 6163 6b73 2069 7320 6e6f 7420 4e6f 6e65  acks is not None
-00012b30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012b40: 2020 6966 2063 616c 6c61 626c 6528 6d65    if callable(me
-00012b50: 7472 6963 5f63 616c 6c62 6163 6b73 293a  tric_callbacks):
-00012b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012b70: 2020 2020 206d 6574 7269 635f 7661 6c75       metric_valu
-00012b80: 6573 203d 2061 6c6c 6f63 6174 655f 6172  es = allocate_ar
-00012b90: 7261 7928 286c 656e 2872 6574 7269 6576  ray((len(retriev
-00012ba0: 655f 6368 616e 6e65 6c73 292c 206c 656e  e_channels), len
-00012bb0: 286f 6e73 6574 7329 2929 0a20 2020 2020  (onsets))).     
-00012bc0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00012bd0: 7479 7065 286d 6574 7269 635f 6361 6c6c  type(metric_call
-00012be0: 6261 636b 7329 2069 7320 7475 706c 6520  backs) is tuple 
-00012bf0: 616e 6420 6c65 6e28 6d65 7472 6963 5f63  and len(metric_c
-00012c00: 616c 6c62 6163 6b73 2920 3e20 303a 0a20  allbacks) > 0:. 
-00012c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c20: 2020 206d 6574 7269 635f 7661 6c75 6573     metric_values
-00012c30: 203d 2061 6c6c 6f63 6174 655f 6172 7261   = allocate_arra
-00012c40: 7928 286c 656e 2872 6574 7269 6576 655f  y((len(retrieve_
-00012c50: 6368 616e 6e65 6c73 292c 206c 656e 286f  channels), len(o
-00012c60: 6e73 6574 7329 2c20 6c65 6e28 6d65 7472  nsets), len(metr
-00012c70: 6963 5f63 616c 6c62 6163 6b73 2929 290a  ic_callbacks))).
-00012c80: 2020 2020 2020 2020 6578 6365 7074 204d          except M
-00012c90: 656d 6f72 7945 7272 6f72 3a0a 2020 2020  emoryError:.    
-00012ca0: 2020 2020 2020 2020 7261 6973 6520 4d65          raise Me
-00012cb0: 6d6f 7279 4572 726f 7228 274e 6f74 2065  moryError('Not e
-00012cc0: 6e6f 7567 6820 6d65 6d6f 7279 2063 7265  nough memory cre
-00012cd0: 6174 6520 6120 6d65 7472 6963 206f 7574  ate a metric out
-00012ce0: 7075 7420 6d61 7472 6978 2729 0a0a 2020  put matrix')..  
-00012cf0: 2020 2320 6372 6561 7465 2061 206c 6973    # create a lis
-00012d00: 7420 6f66 2061 6c6c 2063 6861 6e6e 656c  t of all channel
-00012d10: 7320 7468 6174 2077 6520 6e65 6564 2c20  s that we need, 
-00012d20: 6d6f 7374 2077 6974 6820 7468 6520 7075  most with the pu
-00012d30: 7270 6f73 6520 6f66 2072 6561 6469 6e67  rpose of reading
-00012d40: 2061 6e64 2072 6574 7572 6e69 6e67 2028   and returning (
-00012d50: 652e 672e 206f 6e6c 7920 4543 6f47 2920  e.g. only ECoG) 
-00012d60: 6275 7420 736f 6d65 206f 6e6c 7920 746f  but some only to
-00012d70: 2062 6520 7573 6564 2066 6f72 2072 652d   be used for re-
-00012d80: 7265 6665 7265 6e63 696e 6720 2865 2e67  referencing (e.g
-00012d90: 2e20 626f 7468 2045 436f 4720 616e 6420  . both ECoG and 
-00012da0: 5345 4547 290a 2020 2020 616c 6c5f 6368  SEEG).    all_ch
-00012db0: 616e 6e65 6c73 203d 2072 6574 7269 6576  annels = retriev
-00012dc0: 655f 6368 616e 6e65 6c73 2e63 6f70 7928  e_channels.copy(
-00012dd0: 290a 2020 2020 7472 793a 0a20 2020 2020  ).    try:.     
-00012de0: 2020 2069 6620 6561 726c 795f 7265 7265     if early_rere
-00012df0: 6620 6973 206e 6f74 204e 6f6e 653a 0a20  f is not None:. 
-00012e00: 2020 2020 2020 2020 2020 2065 6172 6c79             early
-00012e10: 5f72 6571 5f63 6861 6e6e 656c 7320 3d20  _req_channels = 
-00012e20: 6561 726c 795f 7265 7265 662e 6765 745f  early_reref.get_
-00012e30: 7265 7175 6972 6564 5f63 6861 6e6e 656c  required_channel
-00012e40: 7328 7265 7472 6965 7665 5f63 6861 6e6e  s(retrieve_chann
-00012e50: 656c 7329 0a20 2020 2020 2020 2020 2020  els).           
-00012e60: 2065 6172 6c79 5f72 6571 5f67 726f 7570   early_req_group
-00012e70: 7320 3d20 6561 726c 795f 7265 7265 662e  s = early_reref.
-00012e80: 6765 745f 7265 7175 6972 6564 5f67 726f  get_required_gro
-00012e90: 7570 7328 7265 7472 6965 7665 5f63 6861  ups(retrieve_cha
-00012ea0: 6e6e 656c 7329 0a20 2020 2020 2020 2020  nnels).         
-00012eb0: 2020 2066 6f72 2063 6861 6e6e 656c 2069     for channel i
-00012ec0: 6e20 6561 726c 795f 7265 715f 6368 616e  n early_req_chan
-00012ed0: 6e65 6c73 3a0a 2020 2020 2020 2020 2020  nels:.          
-00012ee0: 2020 2020 2020 6966 2063 6861 6e6e 656c        if channel
-00012ef0: 206e 6f74 2069 6e20 616c 6c5f 6368 616e   not in all_chan
-00012f00: 6e65 6c73 3a0a 2020 2020 2020 2020 2020  nels:.          
-00012f10: 2020 2020 2020 2020 2020 616c 6c5f 6368            all_ch
-00012f20: 616e 6e65 6c73 2e61 7070 656e 6428 6368  annels.append(ch
-00012f30: 616e 6e65 6c29 0a20 2020 2020 2020 2069  annel).        i
-00012f40: 6620 6c61 7465 5f72 6572 6566 2069 7320  f late_reref is 
-00012f50: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00012f60: 2020 2020 2020 6c61 7465 5f72 6571 5f63        late_req_c
-00012f70: 6861 6e6e 656c 7320 3d20 6c61 7465 5f72  hannels = late_r
-00012f80: 6572 6566 2e67 6574 5f72 6571 7569 7265  eref.get_require
-00012f90: 645f 6368 616e 6e65 6c73 2872 6574 7269  d_channels(retri
-00012fa0: 6576 655f 6368 616e 6e65 6c73 290a 2020  eve_channels).  
-00012fb0: 2020 2020 2020 2020 2020 6c61 7465 5f72            late_r
-00012fc0: 6571 5f67 726f 7570 7320 3d20 6c61 7465  eq_groups = late
-00012fd0: 5f72 6572 6566 2e67 6574 5f72 6571 7569  _reref.get_requi
-00012fe0: 7265 645f 6772 6f75 7073 2872 6574 7269  red_groups(retri
-00012ff0: 6576 655f 6368 616e 6e65 6c73 290a 2020  eve_channels).  
-00013000: 2020 2020 2020 2020 2020 666f 7220 6368            for ch
-00013010: 616e 6e65 6c20 696e 206c 6174 655f 7265  annel in late_re
-00013020: 715f 6368 616e 6e65 6c73 3a0a 2020 2020  q_channels:.    
-00013030: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00013040: 6861 6e6e 656c 206e 6f74 2069 6e20 616c  hannel not in al
-00013050: 6c5f 6368 616e 6e65 6c73 3a0a 2020 2020  l_channels:.    
-00013060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013070: 616c 6c5f 6368 616e 6e65 6c73 2e61 7070  all_channels.app
-00013080: 656e 6428 6368 616e 6e65 6c29 0a20 2020  end(channel).   
-00013090: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
-000130a0: 6f72 3a0a 2020 2020 2020 2020 6c6f 6767  or:.        logg
-000130b0: 696e 672e 6572 726f 7228 2743 6f75 6c64  ing.error('Could
-000130c0: 206e 6f74 2066 696e 6420 6120 6368 616e   not find a chan
-000130d0: 6e65 6c20 7468 6174 2069 7320 746f 2062  nel that is to b
-000130e0: 6520 7573 6564 2066 6f72 2065 6172 6c79  e used for early
-000130f0: 206f 7220 6c61 7465 2072 652d 7265 6665   or late re-refe
-00013100: 7265 6e63 696e 6720 696e 2074 6865 2072  rencing in the r
-00013110: 6572 6566 2073 7472 7563 7427 290a 2020  eref struct').  
-00013120: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00013130: 6545 7272 6f72 2827 436f 756c 6420 6e6f  eError('Could no
-00013140: 7420 6669 6e64 2061 2063 6861 6e6e 656c  t find a channel
-00013150: 2074 6861 7420 6973 2074 6f20 7265 7472   that is to retr
-00013160: 6965 7665 6420 696e 2074 6865 2072 6572  ieved in the rer
-00013170: 6566 2073 7472 7563 7427 290a 0a0a 2020  ef struct')...  
-00013180: 2020 230a 2020 2020 2320 496e 6974 6961    #.    # Initia
-00013190: 6c69 7a65 2076 6172 6961 626c 6520 7468  lize variable th
-000131a0: 6174 2074 7261 636b 2070 726f 6365 7373  at track process
-000131b0: 696e 670a 2020 2020 230a 0a20 2020 2063  ing.    #..    c
-000131c0: 6861 6e6e 656c 5f65 706f 6368 6564 203d  hannel_epoched =
-000131d0: 2064 6963 7428 2920 2020 2020 2020 2020   dict()         
-000131e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000131f0: 2074 7261 636b 7320 666f 7220 6561 6368   tracks for each
-00013200: 2063 6861 6e6e 656c 2077 6865 7468 6572   channel whether
-00013210: 2069 7420 6861 7320 6265 656e 2065 706f   it has been epo
-00013220: 6368 6564 2028 6675 6c6c 7920 7072 6f63  ched (fully proc
-00013230: 6573 7365 6429 0a20 2020 2066 6f72 2063  essed).    for c
-00013240: 6861 6e6e 656c 2069 6e20 7265 7472 6965  hannel in retrie
-00013250: 7665 5f63 6861 6e6e 656c 733a 0a20 2020  ve_channels:.   
-00013260: 2020 2020 2063 6861 6e6e 656c 5f65 706f       channel_epo
-00013270: 6368 6564 5b63 6861 6e6e 656c 5d20 3d20  ched[channel] = 
-00013280: 4661 6c73 650a 0a20 2020 2069 6620 6561  False..    if ea
-00013290: 726c 795f 7265 7265 6620 6973 206e 6f74  rly_reref is not
-000132a0: 204e 6f6e 653a 0a20 2020 2020 2020 2063   None:.        c
-000132b0: 6861 6e6e 656c 5f65 6172 6c79 5f72 6572  hannel_early_rer
-000132c0: 6566 5f63 6f6c 6c65 6374 6564 203d 2064  ef_collected = d
-000132d0: 6963 7428 2920 2020 2020 2020 2020 2023  ict()          #
-000132e0: 2074 7261 636b 7320 666f 7220 6561 6368   tracks for each
-000132f0: 2063 6861 6e6e 656c 2069 6620 7468 6520   channel if the 
-00013300: 6368 616e 6e65 6c2d 6461 7461 2069 7320  channel-data is 
-00013310: 6164 6465 6420 746f 2074 6865 2065 6172  added to the ear
-00013320: 6c79 2072 652d 7265 6620 6772 6f75 7020  ly re-ref group 
-00013330: 6176 6572 6167 6573 0a20 2020 2020 2020  averages.       
-00013340: 2066 6f72 2063 6861 6e6e 656c 2069 6e20   for channel in 
-00013350: 6561 726c 795f 7265 715f 6368 616e 6e65  early_req_channe
-00013360: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-00013370: 6368 616e 6e65 6c5f 6561 726c 795f 7265  channel_early_re
-00013380: 7265 665f 636f 6c6c 6563 7465 645b 6368  ref_collected[ch
-00013390: 616e 6e65 6c5d 203d 2046 616c 7365 0a0a  annel] = False..
-000133a0: 2020 2020 2020 2020 6561 726c 795f 6772          early_gr
-000133b0: 6f75 705f 6461 7461 203d 2064 6963 7428  oup_data = dict(
-000133c0: 2920 2020 2020 2020 2020 2020 2020 2020  )               
-000133d0: 2020 2020 2020 2020 2320 666f 7220 6561          # for ea
-000133e0: 6368 2065 6172 6c79 2072 652d 7265 6620  ch early re-ref 
-000133f0: 6772 6f75 7020 7374 6f72 6573 2074 6865  group stores the
-00013400: 2028 746f 7461 6c2f 6176 6572 6167 6529   (total/average)
-00013410: 2064 6174 610a 2020 2020 2020 2020 6561   data.        ea
-00013420: 726c 795f 6772 6f75 705f 6e75 6d64 6174  rly_group_numdat
-00013430: 6120 3d20 6469 6374 2829 2020 2020 2020  a = dict()      
-00013440: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00013450: 666f 7220 6561 6368 2065 6172 6c79 2072  for each early r
-00013460: 652d 7265 6620 6772 6f75 7020 7374 6f72  e-ref group stor
-00013470: 6573 2074 6865 206e 756d 206f 6620 7361  es the num of sa
-00013480: 6d70 6c65 7320 666f 7220 6561 6368 2064  mples for each d
-00013490: 6174 6170 6f69 6e74 2069 6e20 7468 6520  atapoint in the 
-000134a0: 2874 6f74 616c 2920 6461 7461 0a20 2020  (total) data.   
-000134b0: 2020 2020 2065 6172 6c79 5f67 726f 7570       early_group
-000134c0: 5f63 6861 6e6e 656c 735f 636f 6c6c 6563  _channels_collec
-000134d0: 7465 6420 3d20 6469 6374 2829 2020 2020  ted = dict()    
-000134e0: 2020 2020 2023 2074 7261 636b 7320 666f       # tracks fo
-000134f0: 7220 6561 6368 2065 6172 6c79 2072 652d  r each early re-
-00013500: 7265 6620 6772 6f75 7020 616c 6c20 7468  ref group all th
-00013510: 6520 6368 616e 6e65 6c73 2074 6861 7420  e channels that 
-00013520: 6e65 6564 2074 6f20 6265 2063 6f6c 6c65  need to be colle
-00013530: 6374 6564 0a20 2020 2020 2020 2066 6f72  cted.        for
-00013540: 2067 726f 7570 2069 6e20 6561 726c 795f   group in early_
-00013550: 7265 715f 6772 6f75 7073 3a0a 2020 2020  req_groups:.    
-00013560: 2020 2020 2020 2020 6561 726c 795f 6772          early_gr
-00013570: 6f75 705f 6461 7461 5b73 7472 2867 726f  oup_data[str(gro
-00013580: 7570 295d 203d 204e 6f6e 650a 2020 2020  up)] = None.    
-00013590: 2020 2020 2020 2020 6561 726c 795f 6772          early_gr
-000135a0: 6f75 705f 6e75 6d64 6174 615b 7374 7228  oup_numdata[str(
-000135b0: 6772 6f75 7029 5d20 3d20 4e6f 6e65 0a20  group)] = None. 
-000135c0: 2020 2020 2020 2020 2020 2065 6172 6c79             early
-000135d0: 5f67 726f 7570 5f63 6861 6e6e 656c 735f  _group_channels_
-000135e0: 636f 6c6c 6563 7465 645b 7374 7228 6772  collected[str(gr
-000135f0: 6f75 7029 5d20 3d20 6469 6374 2829 0a20  oup)] = dict(). 
-00013600: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-00013610: 6861 6e6e 656c 2069 6e20 6561 726c 795f  hannel in early_
-00013620: 7265 7265 662e 6772 6f75 7073 5b67 726f  reref.groups[gro
-00013630: 7570 5d3a 0a20 2020 2020 2020 2020 2020  up]:.           
-00013640: 2020 2020 2065 6172 6c79 5f67 726f 7570       early_group
-00013650: 5f63 6861 6e6e 656c 735f 636f 6c6c 6563  _channels_collec
-00013660: 7465 645b 7374 7228 6772 6f75 7029 5d5b  ted[str(group)][
-00013670: 6368 616e 6e65 6c5d 203d 2046 616c 7365  channel] = False
-00013680: 0a0a 2020 2020 6966 206c 6174 655f 7265  ..    if late_re
-00013690: 7265 6620 6973 206e 6f74 204e 6f6e 653a  ref is not None:
-000136a0: 0a20 2020 2020 2020 2063 6861 6e6e 656c  .        channel
-000136b0: 5f6c 6174 655f 7265 7265 665f 636f 6c6c  _late_reref_coll
-000136c0: 6563 7465 6420 3d20 6469 6374 2829 2020  ected = dict()  
-000136d0: 2020 2020 2020 2020 2320 7472 6163 6b73          # tracks
-000136e0: 2066 6f72 2065 6163 6820 6368 616e 6e65   for each channe
-000136f0: 6c20 6966 2074 6865 2063 6861 6e6e 656c  l if the channel
-00013700: 2d64 6174 6120 6973 2061 6464 6564 2074  -data is added t
-00013710: 6f20 7468 6520 6c61 7465 2072 652d 7265  o the late re-re
-00013720: 6620 6772 6f75 7020 6176 6572 6167 6573  f group averages
-00013730: 0a20 2020 2020 2020 2066 6f72 2063 6861  .        for cha
-00013740: 6e6e 656c 2069 6e20 6c61 7465 5f72 6571  nnel in late_req
-00013750: 5f63 6861 6e6e 656c 733a 0a20 2020 2020  _channels:.     
-00013760: 2020 2020 2020 2063 6861 6e6e 656c 5f6c         channel_l
-00013770: 6174 655f 7265 7265 665f 636f 6c6c 6563  ate_reref_collec
-00013780: 7465 645b 6368 616e 6e65 6c5d 203d 2046  ted[channel] = F
-00013790: 616c 7365 0a0a 2020 2020 2020 2020 6c61  alse..        la
-000137a0: 7465 5f67 726f 7570 5f64 6174 6120 3d20  te_group_data = 
-000137b0: 6469 6374 2829 2020 2020 2020 2020 2020  dict()          
-000137c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000137d0: 666f 7220 6561 6368 206c 6174 6520 7265  for each late re
-000137e0: 2d72 6566 2067 726f 7570 2073 746f 7265  -ref group store
-000137f0: 7320 7468 6520 2874 6f74 616c 2f61 7665  s the (total/ave
-00013800: 7261 6765 2920 6461 7461 0a20 2020 2020  rage) data.     
-00013810: 2020 206c 6174 655f 6772 6f75 705f 6e75     late_group_nu
-00013820: 6d64 6174 6120 3d20 6469 6374 2829 2020  mdata = dict()  
-00013830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013840: 2020 2023 2066 6f72 2065 6163 6820 6c61     # for each la
-00013850: 7465 2072 652d 7265 6620 6772 6f75 7020  te re-ref group 
-00013860: 7374 6f72 6573 2074 6865 206e 756d 206f  stores the num o
-00013870: 6620 7361 6d70 6c65 7320 666f 7220 6561  f samples for ea
-00013880: 6368 2064 6174 6170 6f69 6e74 2069 6e20  ch datapoint in 
-00013890: 7468 6520 2874 6f74 616c 2920 6461 7461  the (total) data
-000138a0: 0a20 2020 2020 2020 206c 6174 655f 6772  .        late_gr
-000138b0: 6f75 705f 6368 616e 6e65 6c73 5f63 6f6c  oup_channels_col
-000138c0: 6c65 6374 6564 203d 2064 6963 7428 2920  lected = dict() 
-000138d0: 2020 2020 2020 2020 2023 2074 7261 636b           # track
-000138e0: 7320 666f 7220 6561 6368 206c 6174 6520  s for each late 
-000138f0: 7265 2d72 6566 2067 726f 7570 2061 6c6c  re-ref group all
-00013900: 2074 6865 2063 6861 6e6e 656c 7320 7468   the channels th
-00013910: 6174 206e 6565 6420 746f 2062 6520 636f  at need to be co
-00013920: 6c6c 6563 7465 640a 2020 2020 2020 2020  llected.        
-00013930: 666f 7220 6772 6f75 7020 696e 206c 6174  for group in lat
-00013940: 655f 7265 715f 6772 6f75 7073 3a0a 2020  e_req_groups:.  
-00013950: 2020 2020 2020 2020 2020 6c61 7465 5f67            late_g
-00013960: 726f 7570 5f64 6174 615b 7374 7228 6772  roup_data[str(gr
-00013970: 6f75 7029 5d20 3d20 4e6f 6e65 0a20 2020  oup)] = None.   
-00013980: 2020 2020 2020 2020 206c 6174 655f 6772           late_gr
-00013990: 6f75 705f 6e75 6d64 6174 615b 7374 7228  oup_numdata[str(
-000139a0: 6772 6f75 7029 5d20 3d20 4e6f 6e65 0a20  group)] = None. 
-000139b0: 2020 2020 2020 2020 2020 206c 6174 655f             late_
-000139c0: 6772 6f75 705f 6368 616e 6e65 6c73 5f63  group_channels_c
-000139d0: 6f6c 6c65 6374 6564 5b73 7472 2867 726f  ollected[str(gro
-000139e0: 7570 295d 203d 2064 6963 7428 290a 2020  up)] = dict().  
-000139f0: 2020 2020 2020 2020 2020 666f 7220 6368            for ch
-00013a00: 616e 6e65 6c20 696e 206c 6174 655f 7265  annel in late_re
-00013a10: 7265 662e 6772 6f75 7073 5b67 726f 7570  ref.groups[group
-00013a20: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
-00013a30: 2020 206c 6174 655f 6772 6f75 705f 6368     late_group_ch
-00013a40: 616e 6e65 6c73 5f63 6f6c 6c65 6374 6564  annels_collected
-00013a50: 5b73 7472 2867 726f 7570 295d 5b63 6861  [str(group)][cha
-00013a60: 6e6e 656c 5d20 3d20 4661 6c73 650a 0a20  nnel] = False.. 
-00013a70: 2020 2063 6861 6e6e 656c 5f64 6174 6120     channel_data 
-00013a80: 3d20 6469 6374 2829 0a20 2020 2063 6861  = dict().    cha
-00013a90: 6e6e 656c 5f68 705f 6170 706c 6965 6420  nnel_hp_applied 
-00013aa0: 3d20 6469 6374 2829 2020 2020 2020 2020  = dict()        
-00013ab0: 2020 2020 2020 2320 7472 6163 6b73 2066        # tracks f
-00013ac0: 6f72 2065 6163 6820 6368 616e 6e65 6c20  or each channel 
-00013ad0: 696e 2074 6865 2063 6861 6e6e 656c 2d64  in the channel-d
-00013ae0: 6174 6120 6d61 7472 6978 2069 6620 6869  ata matrix if hi
-00013af0: 6768 2d70 6173 7320 6669 6c74 6572 696e  gh-pass filterin
-00013b00: 6720 6973 2061 7070 6c69 6564 0a20 2020  g is applied.   
-00013b10: 2063 6861 6e6e 656c 5f65 6172 6c79 5f61   channel_early_a
-00013b20: 7070 6c69 6564 203d 2064 6963 7428 2920  pplied = dict() 
-00013b30: 2020 2020 2020 2020 2020 2320 7472 6163            # trac
-00013b40: 6b73 2066 6f72 2065 6163 6820 6368 616e  ks for each chan
-00013b50: 6e65 6c20 696e 2074 6865 2063 6861 6e6e  nel in the chann
-00013b60: 656c 2d64 6174 6120 6d61 7472 6978 2069  el-data matrix i
-00013b70: 6620 6561 726c 7920 7265 2d72 6566 2069  f early re-ref i
-00013b80: 7320 6170 706c 6965 640a 2020 2020 6368  s applied.    ch
-00013b90: 616e 6e65 6c5f 6c6e 725f 6170 706c 6965  annel_lnr_applie
-00013ba0: 6420 3d20 6469 6374 2829 2020 2020 2020  d = dict()      
-00013bb0: 2020 2020 2020 2023 2074 7261 636b 7320         # tracks 
-00013bc0: 666f 7220 6561 6368 2063 6861 6e6e 656c  for each channel
-00013bd0: 2069 6e20 7468 6520 6368 616e 6e65 6c2d   in the channel-
-00013be0: 6461 7461 206d 6174 7269 7820 6966 206c  data matrix if l
-00013bf0: 696e 652d 6e6f 6973 6520 7265 6d6f 7661  ine-noise remova
-00013c00: 6c20 6973 2061 7070 6c69 6564 0a20 2020  l is applied.   
-00013c10: 2066 6f72 2063 6861 6e6e 656c 2069 6e20   for channel in 
-00013c20: 616c 6c5f 6368 616e 6e65 6c73 3a0a 2020  all_channels:.  
-00013c30: 2020 2020 2020 6368 616e 6e65 6c5f 6461        channel_da
-00013c40: 7461 5b63 6861 6e6e 656c 5d20 3d20 4e6f  ta[channel] = No
-00013c50: 6e65 0a20 2020 2020 2020 2063 6861 6e6e  ne.        chann
-00013c60: 656c 5f68 705f 6170 706c 6965 645b 6368  el_hp_applied[ch
-00013c70: 616e 6e65 6c5d 203d 2046 616c 7365 0a20  annel] = False. 
-00013c80: 2020 2020 2020 2063 6861 6e6e 656c 5f65         channel_e
-00013c90: 6172 6c79 5f61 7070 6c69 6564 5b63 6861  arly_applied[cha
-00013ca0: 6e6e 656c 5d20 3d20 4661 6c73 650a 2020  nnel] = False.  
-00013cb0: 2020 2020 2020 6368 616e 6e65 6c5f 6c6e        channel_ln
-00013cc0: 725f 6170 706c 6965 645b 6368 616e 6e65  r_applied[channe
-00013cd0: 6c5d 203d 2046 616c 7365 0a0a 0a20 2020  l] = False...   
-00013ce0: 2023 0a20 2020 2023 2050 7265 7061 7265   #.    # Prepare
-00013cf0: 2066 696c 7465 7273 0a20 2020 2023 0a0a   filters.    #..
-00013d00: 2020 2020 6966 2068 6967 685f 7061 7373      if high_pass
-00013d10: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 0a20   is not None:.. 
-00013d20: 2020 2020 2020 206f 7264 6572 203d 2032         order = 2
-00013d30: 0a20 2020 2020 2020 2066 7320 3d20 6461  .        fs = da
-00013d40: 7461 5f72 6561 6465 722e 7361 6d70 6c69  ta_reader.sampli
-00013d50: 6e67 5f72 6174 650a 2020 2020 2020 2020  ng_rate.        
-00013d60: 7061 7373 5f66 7265 7120 3d20 302e 3530  pass_freq = 0.50
-00013d70: 2020 2020 2023 2048 7a20 3c3c 3c3c 0a20       # Hz <<<<. 
-00013d80: 2020 2020 2020 2073 746f 705f 6672 6571         stop_freq
-00013d90: 203d 2030 2e30 3520 2020 2020 2320 487a   = 0.05     # Hz
-00013da0: 0a20 2020 2020 2020 2070 6173 735f 7269  .        pass_ri
-00013db0: 7070 6c65 203d 2033 2020 2020 2020 2320  pple = 3      # 
-00013dc0: 6442 0a20 2020 2020 2020 2073 746f 705f  dB.        stop_
-00013dd0: 6174 7465 6e20 3d20 3330 2020 2020 2020  atten = 30      
-00013de0: 2320 6442 0a0a 2020 2020 2020 2020 2320  # dB..        # 
-00013df0: 544f 444f 3a20 6d61 746c 6162 2061 6c73  TODO: matlab als
-00013e00: 6f20 616c 6c6f 7773 2070 6173 7369 6e67  o allows passing
-00013e10: 206f 6620 7374 6f70 6261 6e64 2028 6275   of stopband (bu
-00013e20: 7474 6f72 6429 2c20 686f 7765 7665 7220  ttord), however 
-00013e30: 6765 7474 696e 6720 7468 6520 7361 6d65  getting the same
-00013e40: 2076 616c 7565 7320 6f75 7420 6f66 2070   values out of p
-00013e50: 7974 686f 6e20 6275 7474 6f72 6420 6973  ython buttord is
-00013e60: 2064 6966 6669 6375 6c74 0a20 2020 2020   difficult.     
-00013e70: 2020 2023 2020 2020 2020 2073 6574 746c     #       settl
-00013e80: 696e 6720 666f 7220 7374 616e 6461 7264  ing for standard
-00013e90: 2070 7974 686f 6e20 7761 7973 2066 6f72   python ways for
-00013ea0: 206e 6f77 2028 6469 7265 6374 2075 7365   now (direct use
-00013eb0: 206f 6620 6275 7474 6572 290a 2020 2020   of butter).    
-00013ec0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00013ed0: 2320 6e6f 726d 616c 697a 6520 7468 6520  # normalize the 
-00013ee0: 7061 7373 6261 6e64 2061 6e64 2073 746f  passband and sto
-00013ef0: 7062 616e 6420 746f 2074 6865 204e 7971  pband to the Nyq
-00013f00: 7569 7374 2066 7265 7175 656e 6379 0a20  uist frequency. 
-00013f10: 2020 2020 2020 206e 6f72 6d5f 7061 7373         norm_pass
-00013f20: 5f66 7265 7120 3d20 7061 7373 5f66 7265  _freq = pass_fre
-00013f30: 7120 2f20 2866 7320 2f20 3229 2020 2320  q / (fs / 2)  # 
-00013f40: 7061 7373 2062 616e 6420 6672 6571 2069  pass band freq i
-00013f50: 6e20 7261 6469 616e 0a20 2020 2020 2020  n radian.       
-00013f60: 206e 6f72 6d5f 7374 6f70 5f66 7265 7120   norm_stop_freq 
-00013f70: 3d20 7374 6f70 5f66 7265 7120 2f20 2866  = stop_freq / (f
-00013f80: 7320 2f20 3229 2020 2320 7374 6f70 2062  s / 2)  # stop b
-00013f90: 616e 6420 6672 6571 2069 6e20 7261 6469  and freq in radi
-00013fa0: 616e 0a20 2020 200a 2020 2020 2020 2020  an.    .        
-00013fb0: 6669 6c74 4f72 6465 722c 2063 7574 5f66  filtOrder, cut_f
-00013fc0: 7265 7120 3d20 7369 676e 616c 2e62 7574  req = signal.but
-00013fd0: 746f 7264 286e 6f72 6d5f 7061 7373 5f66  tord(norm_pass_f
-00013fe0: 7265 712c 206e 6f72 6d5f 7374 6f70 5f66  req, norm_stop_f
-00013ff0: 7265 712c 2070 6173 735f 7269 7070 6c65  req, pass_ripple
-00014000: 2c20 7374 6f70 5f61 7474 656e 2c20 5472  , stop_atten, Tr
-00014010: 7565 290a 2020 2020 0a20 2020 2020 2020  ue).    .       
-00014020: 2023 2073 6f73 203d 2073 6967 6e61 6c2e   # sos = signal.
-00014030: 6275 7474 6572 286f 7264 6572 2c20 6e6f  butter(order, no
-00014040: 726d 616c 5f63 7574 6f66 662c 2062 7479  rmal_cutoff, bty
-00014050: 7065 3d27 6869 6768 7061 7373 272c 2061  pe='highpass', a
-00014060: 6e61 6c6f 673d 4661 6c73 652c 206f 7574  nalog=False, out
-00014070: 7075 743d 2773 6f73 272c 2066 733d 6673  put='sos', fs=fs
-00014080: 290a 2020 2020 2020 2020 235b 6669 6c74  ).        #[filt
-00014090: 5a65 726f 732c 2066 696c 7450 6f6c 6573  Zeros, filtPoles
-000140a0: 2c20 6669 6c74 4761 696e 735d 203d 2073  , filtGains] = s
-000140b0: 6967 6e61 6c2e 6275 7474 6572 2832 2c20  ignal.butter(2, 
-000140c0: 322e 3734 3531 3230 3337 3737 3637 3733  2.74512037776773
-000140d0: 3265 2d30 342c 2027 6869 6768 272c 206f  2e-04, 'high', o
-000140e0: 7574 7075 743d 277a 706b 2729 0a20 2020  utput='zpk').   
-000140f0: 2020 2020 205b 6669 6c74 5a65 726f 732c       [filtZeros,
-00014100: 2066 696c 7450 6f6c 6573 2c20 6669 6c74   filtPoles, filt
-00014110: 4761 696e 735d 203d 2073 6967 6e61 6c2e  Gains] = signal.
-00014120: 6275 7474 6572 2832 2c20 322e 3734 3531  butter(2, 2.7451
-00014130: 3230 3337 3737 3637 3733 3265 2d30 342c  20377767732e-04,
-00014140: 2027 6869 6768 272c 206f 7574 7075 743d   'high', output=
-00014150: 277a 706b 272c 2066 733d 6673 290a 2020  'zpk', fs=fs).  
-00014160: 2020 2020 2020 0a20 2020 2020 2020 205b        .        [
-00014170: 6669 6c74 536f 735d 203d 2073 6967 6e61  filtSos] = signa
-00014180: 6c2e 7a70 6b32 736f 7328 6669 6c74 5a65  l.zpk2sos(filtZe
-00014190: 726f 732c 2066 696c 7450 6f6c 6573 2c20  ros, filtPoles, 
-000141a0: 6669 6c74 4761 696e 7329 0a20 2020 2020  filtGains).     
-000141b0: 2020 2067 6169 6e20 3d20 6669 6c74 4761     gain = filtGa
-000141c0: 696e 730a 2020 2020 2020 2020 2222 220a  ins.        """.
-000141d0: 0a20 2020 2020 2020 2023 206e 6f72 6d61  .        # norma
-000141e0: 6c69 7a65 2074 6865 2068 6967 682d 7061  lize the high-pa
-000141f0: 7373 2063 7574 2d6f 6666 2066 7265 7175  ss cut-off frequ
-00014200: 656e 6379 2075 7369 6e67 2074 6865 206e  ency using the n
-00014210: 7971 7569 7374 2066 7265 7175 656e 6379  yquist frequency
-00014220: 2028 7372 6174 6520 2f20 3229 0a20 2020   (srate / 2).   
-00014230: 2020 2020 2063 7574 5f66 7265 7120 3d20       cut_freq = 
-00014240: 7061 7373 5f66 7265 7120 2f20 2864 6174  pass_freq / (dat
-00014250: 615f 7265 6164 6572 2e73 616d 706c 696e  a_reader.samplin
-00014260: 675f 7261 7465 202f 2032 290a 0a20 2020  g_rate / 2)..   
-00014270: 2020 2020 2023 2064 6573 6967 6e20 6120       # design a 
-00014280: 6275 7474 6572 776f 7274 6820 6669 6c74  butterworth filt
-00014290: 6572 2061 6e64 2067 6574 2074 6865 2066  er and get the f
-000142a0: 696c 7465 7220 636f 6566 6669 6369 656e  ilter coefficien
-000142b0: 7473 2028 6e75 6d65 7261 746f 7220 2f20  ts (numerator / 
-000142c0: 6465 6e6f 6d69 6e61 746f 7220 28e2 8098  denominator (...
-000142d0: 6261 e280 9929 0a20 2020 2020 2020 2068  ba...).        h
-000142e0: 705f 6e75 6d65 7261 746f 722c 2068 705f  p_numerator, hp_
-000142f0: 6465 6e6f 6d69 6e61 746f 7220 3d20 7369  denominator = si
-00014300: 676e 616c 2e62 7574 7465 7228 6f72 6465  gnal.butter(orde
-00014310: 722c 2063 7574 5f66 7265 712c 2062 7479  r, cut_freq, bty
-00014320: 7065 3d27 6869 6768 7061 7373 272c 2061  pe='highpass', a
-00014330: 6e61 6c6f 673d 4661 6c73 652c 206f 7574  nalog=False, out
-00014340: 7075 743d 2762 6127 2c20 6673 3d66 7329  put='ba', fs=fs)
-00014350: 0a20 2020 2020 2020 2023 2054 4f44 4f3a  .        # TODO:
-00014360: 2074 6865 2027 6261 2720 6f72 2027 736f   the 'ba' or 'so
-00014370: 7327 2072 6574 7572 6e65 6420 6279 2062  s' returned by b
-00014380: 7574 7465 7220 6469 6666 6572 2066 726f  utter differ fro
-00014390: 6d20 7768 6174 206d 6174 6c61 6220 6769  m what matlab gi
-000143a0: 7665 730a 0a20 2020 2020 2020 2023 736f  ves..        #so
-000143b0: 7320 3d20 7369 676e 616c 2e62 7574 7465  s = signal.butte
-000143c0: 7228 6f72 6465 722c 206e 6f72 6d61 6c5f  r(order, normal_
-000143d0: 6375 746f 6666 2c20 6274 7970 653d 2768  cutoff, btype='h
-000143e0: 6967 6870 6173 7327 2c20 616e 616c 6f67  ighpass', analog
-000143f0: 3d46 616c 7365 2c20 6f75 7470 7574 3d27  =False, output='
-00014400: 736f 7327 2c20 6673 3d66 7329 0a20 2020  sos', fs=fs).   
-00014410: 2020 2020 2023 736f 7332 203d 205b 5b31       #sos2 = [[1
-00014420: 2c20 2d32 2c20 312c 2031 2c20 2d31 2e39  , -2, 1, 1, -1.9
-00014430: 3938 3738 3033 3735 3330 3230 3835 2c20  98780375302085, 
-00014440: 302e 3939 3837 3831 3131 3835 3931 3135  0.99878111859115
-00014450: 395d 5d20 2023 2074 616b 656e 2066 726f  9]]  # taken fro
-00014460: 6d20 6d61 746c 6162 0a20 2020 2020 2020  m matlab.       
-00014470: 2023 7072 696e 7428 736f 7329 0a0a 0a20   #print(sos)... 
-00014480: 2020 2069 6620 6c69 6e65 5f6e 6f69 7365     if line_noise
-00014490: 5f72 656d 6f76 616c 2069 7320 6e6f 7420  _removal is not 
-000144a0: 4e6f 6e65 3a0a 0a20 2020 2020 2020 2023  None:..        #
-000144b0: 2064 6573 6967 6e20 6120 6e6f 7463 6820   design a notch 
-000144c0: 6669 6c74 6572 2061 6e64 2067 6574 2074  filter and get t
-000144d0: 6865 2066 696c 7465 7220 636f 6566 6669  he filter coeffi
-000144e0: 6369 656e 7473 2028 6e75 6d65 7261 746f  cients (numerato
-000144f0: 7220 2f20 6465 6e6f 6d69 6e61 746f 7220  r / denominator 
-00014500: 28e2 8098 6261 e280 9929 0a20 2020 2020  (...ba...).     
-00014510: 2020 206c 6e72 5f6e 756d 6572 6174 6f72     lnr_numerator
-00014520: 2c20 6c6e 725f 6465 6e6f 6d69 6e61 746f  , lnr_denominato
-00014530: 7220 3d20 7369 676e 616c 2e69 6972 6e6f  r = signal.iirno
-00014540: 7463 6828 6c69 6e65 5f6e 6f69 7365 5f72  tch(line_noise_r
-00014550: 656d 6f76 616c 2c20 3330 2e30 2c20 6461  emoval, 30.0, da
-00014560: 7461 5f72 6561 6465 722e 7361 6d70 6c69  ta_reader.sampli
-00014570: 6e67 5f72 6174 6529 0a0a 0a20 2020 2023  ng_rate)...    #
-00014580: 0a20 2020 2023 2050 726f 6772 6573 7320  .    # Progress 
-00014590: 6261 7220 7375 6273 6372 6970 740a 2020  bar subscript.  
-000145a0: 2020 230a 0a20 2020 2064 6566 2075 7064    #..    def upd
-000145b0: 6174 655f 7072 6f67 7265 7373 6261 7228  ate_progressbar(
-000145c0: 293a 0a0a 2020 2020 2020 2020 2320 7365  ):..        # se
-000145d0: 7420 686f 7720 6d75 6368 2065 6163 6820  t how much each 
-000145e0: 7374 6570 2063 6f6e 7472 6962 7574 6573  step contributes
-000145f0: 2074 6f20 7468 6520 746f 7461 6c20 7072   to the total pr
-00014600: 6f67 7265 7373 0a20 2020 2020 2020 2070  ogress.        p
-00014610: 726f 705f 6561 726c 795f 636f 6c6c 6563  rop_early_collec
-00014620: 7465 6420 3d20 300a 2020 2020 2020 2020  ted = 0.        
-00014630: 7072 6f70 5f6c 6174 655f 636f 6c6c 6563  prop_late_collec
-00014640: 7465 6420 3d20 300a 2020 2020 2020 2020  ted = 0.        
-00014650: 6966 2065 6172 6c79 5f72 6572 6566 2069  if early_reref i
-00014660: 7320 4e6f 6e65 2061 6e64 206c 6174 655f  s None and late_
-00014670: 7265 7265 6620 6973 204e 6f6e 653a 0a20  reref is None:. 
-00014680: 2020 2020 2020 2020 2020 2070 726f 705f             prop_
-00014690: 6368 616e 6e65 6c5f 6570 6f63 6865 6420  channel_epoched 
-000146a0: 3d20 310a 0a20 2020 2020 2020 2065 6c73  = 1..        els
-000146b0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-000146c0: 726f 705f 6368 616e 6e65 6c5f 6570 6f63  rop_channel_epoc
-000146d0: 6865 6420 3d20 2e34 0a0a 2020 2020 2020  hed = .4..      
-000146e0: 2020 2020 2020 6966 2065 6172 6c79 5f72        if early_r
-000146f0: 6572 6566 2069 7320 6e6f 7420 4e6f 6e65  eref is not None
-00014700: 2061 6e64 206c 6174 655f 7265 7265 6620   and late_reref 
-00014710: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00014720: 2020 2020 2020 2020 2070 726f 705f 6561           prop_ea
-00014730: 726c 795f 636f 6c6c 6563 7465 6420 3d20  rly_collected = 
-00014740: 2e36 0a0a 2020 2020 2020 2020 2020 2020  .6..            
-00014750: 656c 6966 2065 6172 6c79 5f72 6572 6566  elif early_reref
-00014760: 2069 7320 4e6f 6e65 2061 6e64 206c 6174   is None and lat
-00014770: 655f 7265 7265 6620 6973 206e 6f74 204e  e_reref is not N
-00014780: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00014790: 2020 2020 2070 726f 705f 6c61 7465 5f63       prop_late_c
-000147a0: 6f6c 6c65 6374 6564 203d 202e 360a 0a20  ollected = .6.. 
-000147b0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000147c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000147d0: 2069 6620 7072 696f 7269 7479 203d 3d20   if priority == 
-000147e0: 276d 656d 273a 0a20 2020 2020 2020 2020  'mem':.         
-000147f0: 2020 2020 2020 2020 2020 2070 726f 705f             prop_
-00014800: 6561 726c 795f 636f 6c6c 6563 7465 6420  early_collected 
-00014810: 3d20 2e33 0a20 2020 2020 2020 2020 2020  = .3.           
-00014820: 2020 2020 2020 2020 2070 726f 705f 6c61           prop_la
-00014830: 7465 5f63 6f6c 6c65 6374 6564 203d 202e  te_collected = .
-00014840: 330a 2020 2020 2020 2020 2020 2020 2020  3.              
-00014850: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00014860: 2020 2020 2020 2020 2020 2020 7072 6f70              prop
-00014870: 5f65 6172 6c79 5f63 6f6c 6c65 6374 6564  _early_collected
-00014880: 203d 202e 350a 2020 2020 2020 2020 2020   = .5.          
-00014890: 2020 2020 2020 2020 2020 7072 6f70 5f6c            prop_l
-000148a0: 6174 655f 636f 6c6c 6563 7465 6420 3d20  ate_collected = 
-000148b0: 2e31 0a0a 2020 2020 2020 2020 2320 7265  .1..        # re
-000148c0: 7472 6965 7665 2070 726f 706f 7274 696f  trieve proportio
-000148d0: 6e73 0a20 2020 2020 2020 2070 726f 6772  ns.        progr
-000148e0: 6573 7369 6f6e 5f63 6861 6e6e 656c 5f65  ession_channel_e
-000148f0: 706f 6368 6564 203d 2073 756d 2863 6861  poched = sum(cha
-00014900: 6e6e 656c 5f65 706f 6368 6564 2e76 616c  nnel_epoched.val
-00014910: 7565 7328 2929 202f 206c 656e 2863 6861  ues()) / len(cha
-00014920: 6e6e 656c 5f65 706f 6368 6564 290a 2020  nnel_epoched).  
-00014930: 2020 2020 2020 7072 6f67 7265 7373 696f        progressio
-00014940: 6e5f 6561 726c 795f 636f 6c6c 6563 7465  n_early_collecte
-00014950: 6420 3d20 300a 2020 2020 2020 2020 7072  d = 0.        pr
-00014960: 6f67 7265 7373 696f 6e5f 6c61 7465 5f63  ogression_late_c
-00014970: 6f6c 6c65 6374 6564 203d 2030 0a20 2020  ollected = 0.   
-00014980: 2020 2020 2069 6620 6561 726c 795f 7265       if early_re
-00014990: 7265 6620 6973 206e 6f74 204e 6f6e 653a  ref is not None:
-000149a0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-000149b0: 6772 6573 7369 6f6e 5f65 6172 6c79 5f63  gression_early_c
-000149c0: 6f6c 6c65 6374 6564 203d 2073 756d 285b  ollected = sum([
-000149d0: 7375 6d28 762e 7661 6c75 6573 2829 2920  sum(v.values()) 
-000149e0: 666f 7220 7620 696e 2065 6172 6c79 5f67  for v in early_g
-000149f0: 726f 7570 5f63 6861 6e6e 656c 735f 636f  roup_channels_co
-00014a00: 6c6c 6563 7465 642e 7661 6c75 6573 2829  llected.values()
-00014a10: 5d29 202f 2073 756d 285b 6c65 6e28 7629  ]) / sum([len(v)
-00014a20: 2066 6f72 2076 2069 6e20 6561 726c 795f   for v in early_
-00014a30: 6772 6f75 705f 6368 616e 6e65 6c73 5f63  group_channels_c
-00014a40: 6f6c 6c65 6374 6564 2e76 616c 7565 7328  ollected.values(
-00014a50: 295d 290a 2020 2020 2020 2020 6966 206c  )]).        if l
-00014a60: 6174 655f 7265 7265 6620 6973 206e 6f74  ate_reref is not
-00014a70: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00014a80: 2020 2070 726f 6772 6573 7369 6f6e 5f6c     progression_l
-00014a90: 6174 655f 636f 6c6c 6563 7465 6420 3d20  ate_collected = 
-00014aa0: 7375 6d28 5b73 756d 2876 2e76 616c 7565  sum([sum(v.value
-00014ab0: 7328 2929 2066 6f72 2076 2069 6e20 6c61  s()) for v in la
-00014ac0: 7465 5f67 726f 7570 5f63 6861 6e6e 656c  te_group_channel
-00014ad0: 735f 636f 6c6c 6563 7465 642e 7661 6c75  s_collected.valu
-00014ae0: 6573 2829 5d29 202f 2073 756d 285b 6c65  es()]) / sum([le
-00014af0: 6e28 7629 2066 6f72 2076 2069 6e20 6c61  n(v) for v in la
-00014b00: 7465 5f67 726f 7570 5f63 6861 6e6e 656c  te_group_channel
-00014b10: 735f 636f 6c6c 6563 7465 642e 7661 6c75  s_collected.valu
-00014b20: 6573 2829 5d29 0a0a 2020 2020 2020 2020  es()])..        
-00014b30: 2320 7570 6461 7465 2074 6865 2070 726f  # update the pro
-00014b40: 6772 6573 7320 6261 720a 2020 2020 2020  gress bar.      
-00014b50: 2020 7072 6f70 203d 2070 726f 705f 6368    prop = prop_ch
-00014b60: 616e 6e65 6c5f 6570 6f63 6865 6420 2a20  annel_epoched * 
-00014b70: 7072 6f67 7265 7373 696f 6e5f 6368 616e  progression_chan
-00014b80: 6e65 6c5f 6570 6f63 6865 6420 2b20 7072  nel_epoched + pr
-00014b90: 6f70 5f65 6172 6c79 5f63 6f6c 6c65 6374  op_early_collect
-00014ba0: 6564 202a 2070 726f 6772 6573 7369 6f6e  ed * progression
-00014bb0: 5f65 6172 6c79 5f63 6f6c 6c65 6374 6564  _early_collected
-00014bc0: 202b 2070 726f 705f 6c61 7465 5f63 6f6c   + prop_late_col
-00014bd0: 6c65 6374 6564 202a 2070 726f 6772 6573  lected * progres
-00014be0: 7369 6f6e 5f6c 6174 655f 636f 6c6c 6563  sion_late_collec
-00014bf0: 7465 640a 2020 2020 2020 2020 7072 696e  ted.        prin
-00014c00: 745f 7072 6f67 7265 7373 6261 7228 7072  t_progressbar(pr
-00014c10: 6f70 2c20 312c 2070 7265 6669 783d 2750  op, 1, prefix='P
-00014c20: 726f 6772 6573 733a 272c 2073 7566 6669  rogress:', suffi
-00014c30: 783d 2743 6f6d 706c 6574 6527 2c20 6c65  x='Complete', le
-00014c40: 6e67 7468 3d35 3029 0a0a 2020 2020 2320  ngth=50)..    # 
-00014c50: 6372 6561 7465 2070 726f 6772 6573 7320  create progress 
-00014c60: 6261 720a 2020 2020 7570 6461 7465 5f70  bar.    update_p
-00014c70: 726f 6772 6573 7362 6172 2829 0a0a 0a20  rogressbar()... 
-00014c80: 2020 2023 0a20 2020 2023 2050 726f 6365     #.    # Proce
-00014c90: 7373 0a20 2020 2023 0a0a 2020 2020 2320  ss.    #..    # 
-00014ca0: 756e 7469 6c20 616c 6c20 6368 616e 6e65  until all channe
-00014cb0: 6c73 2061 7265 2065 706f 6368 2d65 6420  ls are epoch-ed 
-00014cc0: 2866 756c 6c79 2070 726f 6365 7373 6564  (fully processed
-00014cd0: 290a 2020 2020 7768 696c 6520 6e6f 7420  ).    while not 
-00014ce0: 616c 6c28 6368 616e 6e65 6c5f 6570 6f63  all(channel_epoc
-00014cf0: 6865 642e 7661 6c75 6573 2829 293a 0a0a  hed.values()):..
-00014d00: 2020 2020 2020 2020 2320 6c6f 6f70 206f          # loop o
-00014d10: 7665 7220 616c 6c20 7468 6520 7265 7175  ver all the requ
-00014d20: 6972 6564 2063 6861 6e6e 656c 730a 2020  ired channels.  
-00014d30: 2020 2020 2020 2320 4e6f 7465 3a20 706f        # Note: po
-00014d40: 7465 6e74 6961 6c6c 7920 6576 656e 206f  tentially even o
-00014d50: 7665 7220 7468 6520 6f6e 6573 2074 6861  ver the ones tha
-00014d60: 7420 646f 206e 6f74 206e 6565 6420 746f  t do not need to
-00014d70: 2062 6520 7265 7472 6965 7665 6420 6275   be retrieved bu
-00014d80: 7420 6172 6520 7374 696c 6c20 6e65 6564  t are still need
-00014d90: 6564 2066 6f72 2072 652d 7265 6665 7265  ed for re-refere
-00014da0: 6e63 696e 670a 2020 2020 2020 2020 666f  ncing.        fo
-00014db0: 7220 6368 616e 6e65 6c20 696e 2061 6c6c  r channel in all
-00014dc0: 5f63 6861 6e6e 656c 733a 0a0a 2020 2020  _channels:..    
-00014dd0: 2020 2020 2020 2020 2320 6368 6563 6b20          # check 
-00014de0: 6966 2077 6520 6e65 6564 2074 6869 7320  if we need this 
-00014df0: 6368 616e 6e65 6c2c 2077 6869 6368 2069  channel, which i
-00014e00: 7320 7468 6520 6361 7365 2077 6865 6e3a  s the case when:
-00014e10: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00014e20: 202d 2069 7420 7374 696c 6c20 6e65 6564   - it still need
-00014e30: 7320 746f 2062 6520 6570 6f63 682d 6564  s to be epoch-ed
-00014e40: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
-00014e50: 202d 2077 6865 6e20 6974 2069 7320 6e65   - when it is ne
-00014e60: 6564 6564 2066 6f72 2065 6172 6c79 2072  eded for early r
-00014e70: 652d 7265 6620 6275 7420 6e6f 7420 636f  e-ref but not co
-00014e80: 6c6c 6563 7465 640a 2020 2020 2020 2020  llected.        
-00014e90: 2020 2020 2320 2020 2d20 7768 656e 2069      #   - when i
-00014ea0: 7420 6973 206e 6565 6465 6420 666f 7220  t is needed for 
-00014eb0: 6c61 7465 2072 652d 7265 6620 6275 7420  late re-ref but 
-00014ec0: 6e6f 7420 636f 6c6c 6563 7465 640a 2020  not collected.  
-00014ed0: 2020 2020 2020 2020 2020 6966 2028 6368            if (ch
-00014ee0: 616e 6e65 6c20 696e 2063 6861 6e6e 656c  annel in channel
-00014ef0: 5f65 706f 6368 6564 2e6b 6579 7328 2920  _epoched.keys() 
-00014f00: 616e 6420 6e6f 7420 6368 616e 6e65 6c5f  and not channel_
-00014f10: 6570 6f63 6865 645b 6368 616e 6e65 6c5d  epoched[channel]
-00014f20: 2920 6f72 205c 0a20 2020 2020 2020 2020  ) or \.         
-00014f30: 2020 2020 2020 2865 6172 6c79 5f72 6572        (early_rer
-00014f40: 6566 2069 7320 6e6f 7420 4e6f 6e65 2061  ef is not None a
-00014f50: 6e64 2063 6861 6e6e 656c 2069 6e20 6561  nd channel in ea
-00014f60: 726c 795f 7265 715f 6368 616e 6e65 6c73  rly_req_channels
-00014f70: 2061 6e64 206e 6f74 2063 6861 6e6e 656c   and not channel
-00014f80: 5f65 6172 6c79 5f72 6572 6566 5f63 6f6c  _early_reref_col
-00014f90: 6c65 6374 6564 5b63 6861 6e6e 656c 5d29  lected[channel])
-00014fa0: 206f 7220 5c0a 2020 2020 2020 2020 2020   or \.          
-00014fb0: 2020 2020 2028 6c61 7465 5f72 6572 6566       (late_reref
-00014fc0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-00014fd0: 2063 6861 6e6e 656c 2069 6e20 6c61 7465   channel in late
-00014fe0: 5f72 6571 5f63 6861 6e6e 656c 7320 616e  _req_channels an
-00014ff0: 6420 6e6f 7420 6368 616e 6e65 6c5f 6c61  d not channel_la
-00015000: 7465 5f72 6572 6566 5f63 6f6c 6c65 6374  te_reref_collect
-00015010: 6564 5b63 6861 6e6e 656c 5d29 3a0a 2020  ed[channel]):.  
-00015020: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00015030: 6e65 6564 6564 2c20 7072 6f63 6573 7320  needed, process 
-00015040: 6368 616e 6e65 6c0a 0a20 2020 2020 2020  channel..       
-00015050: 2020 2020 2020 2020 2023 2063 6865 636b           # check
-00015060: 2069 6620 6368 616e 6e65 6c20 6461 7461   if channel data
-00015070: 2069 7320 6176 6169 6c61 626c 650a 2020   is available.  
-00015080: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00015090: 4e6f 7465 3a20 6475 7269 6e67 2073 7065  Note: during spe
-000150a0: 6564 206f 7074 696f 6e20 7468 6520 6368  ed option the ch
-000150b0: 616e 6e65 6c20 6461 7461 2069 7320 6b65  annel data is ke
-000150c0: 7074 2069 6e20 6d65 6d6f 7279 2c20 736f  pt in memory, so
-000150d0: 206e 6f20 7265 6c6f 6164 696e 6720 6973   no reloading is
-000150e0: 2072 6571 7569 7265 6420 7768 656e 2073   required when s
-000150f0: 7469 6c6c 2069 6e20 6d65 6d6f 7279 0a20  till in memory. 
-00015100: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015110: 6620 6368 616e 6e65 6c5f 6461 7461 5b63  f channel_data[c
-00015120: 6861 6e6e 656c 5d20 6973 204e 6f6e 653a  hannel] is None:
-00015130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015140: 2020 2020 2023 7072 696e 7428 6368 616e       #print(chan
-00015150: 6e65 6c20 2b20 223a 206c 6f61 6422 290a  nel + ": load").
-00015160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015170: 2020 2020 2023 2072 6574 7269 6576 6520       # retrieve 
-00015180: 7468 6520 6368 616e 6e65 6c20 6461 7461  the channel data
-00015190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000151a0: 2020 2020 2023 2054 4f44 4f3a 2063 6f6e       # TODO: con
-000151b0: 7369 6465 7220 6461 7461 2074 7970 650a  sider data type.
-000151c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151d0: 2020 2020 2320 2020 2020 2020 2d20 5079      #       - Py
-000151e0: 4d45 4620 7769 6c6c 2061 6c77 6179 7320  MEF will always 
-000151f0: 7265 7475 726e 2066 6c6f 6174 3634 0a20  return float64. 
-00015200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015210: 2020 2023 2020 2020 2020 2020 2028 6f72     #         (or
-00015220: 6967 696e 616c 2064 6174 6120 666f 726d  iginal data form
-00015230: 6174 2069 7320 3332 2d62 6974 2069 6e74  at is 32-bit int
-00015240: 6567 6572 2c20 6275 7420 6f75 7470 7574  eger, but output
-00015250: 7469 6e67 2066 6c6f 6174 3634 2061 6c6c  ting float64 all
-00015260: 6f77 7320 4e61 4e73 2066 6f72 2064 6973  ows NaNs for dis
-00015270: 636f 6e74 696e 7569 7469 6573 2069 6e20  continuities in 
-00015280: 7468 6520 7469 6d65 2d73 6572 6965 7320  the time-series 
-00015290: 616e 6420 7374 696c 6c20 7265 7461 696e  and still retain
-000152a0: 7320 3533 2d62 6974 2073 6967 6e69 6669  s 53-bit signifi
-000152b0: 6361 6e64 2070 7265 6369 7369 6f6e 2074  cand precision t
-000152c0: 6f20 686f 6c64 2074 6865 2065 7861 6374  o hold the exact
-000152d0: 2033 322d 6269 7420 7661 6c75 6529 0a20   32-bit value). 
-000152e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152f0: 2020 2023 2020 2020 2020 202d 2042 7261     #       - Bra
-00015300: 696e 7669 7369 6f6e 2063 616e 2062 6520  invision can be 
-00015310: 3136 2d62 6974 2069 6e74 6567 6572 2c20  16-bit integer, 
-00015320: 3332 2d62 6974 2069 6e74 6567 6572 206f  32-bit integer o
-00015330: 7220 3332 2d62 6974 2066 6c6f 6174 2e20  r 32-bit float. 
-00015340: 486f 7765 7665 722c 2074 6865 2072 6573  However, the res
-00015350: 6f6c 7574 696f 6e20 696e 2074 6865 2063  olution in the c
-00015360: 6861 6e6e 656c 2061 6374 7320 6173 206d  hannel acts as m
-00015370: 756c 7469 706c 6963 6174 696f 6e20 6661  ultiplication fa
-00015380: 6374 6f72 0a20 2020 2020 2020 2020 2020  ctor.           
-00015390: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-000153a0: 2020 2041 7320 7375 6368 2c20 6966 2074     As such, if t
-000153b0: 6865 206d 756c 7469 706c 6963 6174 696f  he multiplicatio
-000153c0: 6e20 6661 6374 6f72 2069 7320 3120 286f  n factor is 1 (o
-000153d0: 7220 656d 7074 7929 2074 6865 6e20 7468  r empty) then th
-000153e0: 6520 6f75 7470 7574 2077 696c 6c20 616c  e output will al
-000153f0: 7761 7973 2062 6520 696e 2033 322d 6269  ways be in 32-bi
-00015400: 7420 666c 6f61 7473 2028 6e6f 7420 3634  t floats (not 64
-00015410: 2d62 6974 2074 6f20 7361 7665 206d 656d  -bit to save mem
-00015420: 6f72 7929 2e0a 2020 2020 2020 2020 2020  ory)..          
-00015430: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00015440: 2020 2020 486f 7765 7665 722c 2069 6620      However, if 
-00015450: 6120 6d75 6c74 6970 6c69 6361 7469 6f6e  a multiplication
-00015460: 2066 6163 746f 720a 2020 2020 2020 2020   factor.        
-00015470: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-00015480: 7465 3a20 656e 7375 7265 2069 7420 6973  te: ensure it is
-00015490: 206e 6f74 2061 2076 6965 772c 2065 6c73   not a view, els
-000154a0: 6577 6973 6520 6d61 6e69 7075 6c61 7469  ewise manipulati
-000154b0: 6f6e 7320 6675 7274 6865 7220 6f6e 206d  ons further on m
-000154c0: 6967 6874 2061 646a 7573 7420 7468 6520  ight adjust the 
-000154d0: 736f 7572 6365 2064 6174 610a 2020 2020  source data.    
-000154e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00015500: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-00015510: 6e6e 656c 5f64 6174 615b 6368 616e 6e65  nnel_data[channe
-00015520: 6c5d 203d 2064 6174 615f 7265 6164 6572  l] = data_reader
-00015530: 2e72 6574 7269 6576 655f 6368 616e 6e65  .retrieve_channe
-00015540: 6c5f 6461 7461 2863 6861 6e6e 656c 2c20  l_data(channel, 
-00015550: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-00015560: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00015570: 2052 756e 7469 6d65 4572 726f 723a 0a20   RuntimeError:. 
-00015580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015590: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-000155a0: 7469 6d65 4572 726f 7228 2745 7272 6f72  timeError('Error
-000155b0: 2075 706f 6e20 7265 7472 6965 7669 6e67   upon retrieving
-000155c0: 2064 6174 6127 290a 0a20 2020 2020 2020   data')..       
-000155d0: 2020 2020 2020 2020 2023 0a20 2020 2020           #.     
-000155e0: 2020 2020 2020 2020 2020 2023 2048 6967             # Hig
-000155f0: 682d 7061 7373 2066 696c 7465 7269 6e67  h-pass filtering
-00015600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015610: 2023 0a20 2020 2020 2020 2020 2020 2020   #.             
-00015620: 2020 2069 6620 6869 6768 5f70 6173 7320     if high_pass 
-00015630: 616e 6420 6e6f 7420 6368 616e 6e65 6c5f  and not channel_
-00015640: 6870 5f61 7070 6c69 6564 5b63 6861 6e6e  hp_applied[chann
-00015650: 656c 5d3a 0a20 2020 2020 2020 2020 2020  el]:.           
-00015660: 2020 2020 2020 2020 2023 7072 696e 7428           #print(
-00015670: 6368 616e 6e65 6c20 2b20 223a 2048 5022  channel + ": HP"
-00015680: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00015690: 2020 2020 2020 2023 2046 696c 7465 7220         # Filter 
-000156a0: 7468 6520 6461 7461 0a20 2020 2020 2020  the data.       
-000156b0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-000156c0: 6e6e 656c 5f64 6174 615b 6368 616e 6e65  nnel_data[channe
-000156d0: 6c5d 203d 2073 6967 6e61 6c2e 6669 6c74  l] = signal.filt
-000156e0: 6669 6c74 2868 705f 6e75 6d65 7261 746f  filt(hp_numerato
-000156f0: 722c 2068 705f 6465 6e6f 6d69 6e61 746f  r, hp_denominato
-00015700: 722c 2063 6861 6e6e 656c 5f64 6174 615b  r, channel_data[
-00015710: 6368 616e 6e65 6c5d 2c20 7061 6474 7970  channel], padtyp
-00015720: 653d 276f 6464 272c 2070 6164 6c65 6e3d  e='odd', padlen=
-00015730: 3320 2a20 286d 6178 286c 656e 2868 705f  3 * (max(len(hp_
-00015740: 6e75 6d65 7261 746f 7229 2c20 6c65 6e28  numerator), len(
-00015750: 6870 5f64 656e 6f6d 696e 6174 6f72 2929  hp_denominator))
-00015760: 202d 2031 2929 0a0a 2020 2020 2020 2020   - 1))..        
-00015770: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-00015780: 444f 3a20 6d6f 7265 2065 7861 6374 2074  DO: more exact t
-00015790: 7261 6e73 6c61 7469 6f6e 2066 726f 6d20  ranslation from 
-000157a0: 6d61 746c 6162 0a20 2020 2020 2020 2020  matlab.         
-000157b0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-000157c0: 2020 2073 6f73 6669 6c74 6669 6c74 2028     sosfiltfilt (
-000157d0: 736f 2077 6974 6820 736f 7329 2072 6574  so with sos) ret
-000157e0: 7572 6e73 2064 6966 6665 7265 6e74 2076  urns different v
-000157f0: 616c 7565 7320 6f6e 2074 6865 2073 616d  alues on the sam
-00015800: 6520 6461 7461 0a20 2020 2020 2020 2020  e data.         
-00015810: 2020 2020 2020 2020 2020 2023 7920 3d20             #y = 
-00015820: 7369 676e 616c 2e66 696c 7466 696c 7428  signal.filtfilt(
-00015830: 736f 732c 2067 6169 6e2c 2063 6861 6e6e  sos, gain, chann
-00015840: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
-00015850: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015860: 2020 2020 2020 2379 203d 2073 6967 6e61        #y = signa
-00015870: 6c2e 6669 6c74 6669 6c74 2868 705f 6e75  l.filtfilt(hp_nu
-00015880: 6d65 7261 746f 722c 2068 705f 6465 6e6f  merator, hp_deno
-00015890: 6d69 6e61 746f 722c 2063 6861 6e6e 656c  minator, channel
-000158a0: 5f64 6174 615b 6368 616e 6e65 6c5d 290a  _data[channel]).
-000158b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000158c0: 2020 2020 2379 203d 2073 6967 6e61 6c2e      #y = signal.
-000158d0: 6669 6c74 6669 6c74 2868 705f 6e75 6d65  filtfilt(hp_nume
-000158e0: 7261 746f 722c 2068 705f 6465 6e6f 6d69  rator, hp_denomi
-000158f0: 6e61 746f 722c 2063 6861 6e6e 656c 5f64  nator, channel_d
-00015900: 6174 615b 6368 616e 6e65 6c5d 2c20 7061  ata[channel], pa
-00015910: 6474 7970 653d 276f 6464 272c 2070 6164  dtype='odd', pad
-00015920: 6c65 6e3d 3320 2a20 286d 6178 286c 656e  len=3 * (max(len
-00015930: 2862 292c 206c 656e 2861 2929 202d 2031  (b), len(a)) - 1
-00015940: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00015950: 2020 2020 2020 2023 7932 203d 2073 6967         #y2 = sig
-00015960: 6e61 6c2e 736f 7366 696c 7466 696c 7428  nal.sosfiltfilt(
-00015970: 736f 7332 2c20 6368 616e 6e65 6c5f 6461  sos2, channel_da
-00015980: 7461 5b63 6861 6e6e 656c 5d2c 2070 6164  ta[channel], pad
-00015990: 7479 7065 3d4e 6f6e 6529 0a20 2020 2020  type=None).     
+00011ac0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00011ad0: 615f 7265 6164 6572 2c20 6368 616e 6e65  a_reader, channe
+00011ae0: 6c5f 6964 782c 2063 6861 6e6e 656c 735b  l_idx, channels[
+00011af0: 6368 616e 6e65 6c5f 6964 785d 2c20 4e6f  channel_idx], No
+00011b00: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00011b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011b50: 2063 6f6e 6469 7469 6f6e 735f 6f6e 7365   conditions_onse
+00011b60: 7473 2c20 7472 6961 6c5f 6e75 6d5f 7361  ts, trial_num_sa
+00011b70: 6d70 6c65 732c 2074 7269 616c 5f65 706f  mples, trial_epo
+00011b80: 6368 2c0a 2020 2020 2020 2020 2020 2020  ch,.            
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011bd0: 2062 6173 656c 696e 655f 6e75 6d5f 7361   baseline_num_sa
+00011be0: 6d70 6c65 732c 2062 6173 656c 696e 655f  mples, baseline_
+00011bf0: 6d65 7468 6f64 2c20 6261 7365 6c69 6e65  method, baseline
+00011c00: 5f65 706f 6368 2c20 6f75 745f 6f66 5f62  _epoch, out_of_b
+00011c10: 6f75 6e64 5f6d 6574 686f 642c 0a20 2020  ound_method,.   
+00011c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c60: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
+00011c70: 5f63 616c 6c62 6163 6b73 290a 2020 2020  _callbacks).    
+00011c80: 2020 2020 6578 6365 7074 2028 4d65 6d6f      except (Memo
+00011c90: 7279 4572 726f 722c 2052 756e 7469 6d65  ryError, Runtime
+00011ca0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
+00011cb0: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00011cc0: 6545 7272 6f72 2827 4572 726f 7220 7570  eError('Error up
+00011cd0: 6f6e 206c 6f61 6469 6e67 2c20 6570 6f63  on loading, epoc
+00011ce0: 6869 6e67 2061 6e64 2061 7665 7261 6769  hing and averagi
+00011cf0: 6e67 2064 6174 6127 290a 0a20 2020 2020  ng data')..     
+00011d00: 2020 2023 2075 7064 6174 6520 7072 6f67     # update prog
+00011d10: 7265 7373 2062 6172 0a20 2020 2020 2020  ress bar.       
+00011d20: 2070 7269 6e74 5f70 726f 6772 6573 7362   print_progressb
+00011d30: 6172 2863 6861 6e6e 656c 5f69 6478 202b  ar(channel_idx +
+00011d40: 2031 2c20 6c65 6e28 6368 616e 6e65 6c73   1, len(channels
+00011d50: 292c 2070 7265 6669 783d 2750 726f 6772  ), prefix='Progr
+00011d60: 6573 733a 272c 2073 7566 6669 783d 2743  ess:', suffix='C
+00011d70: 6f6d 706c 6574 6527 2c20 6c65 6e67 7468  omplete', length
+00011d80: 3d35 3029 0a0a 2020 2020 2320 7265 7475  =50)..    # retu
+00011d90: 726e 2074 6865 2073 616d 706c 6520 7261  rn the sample ra
+00011da0: 7465 2c20 7468 6520 6176 6572 6167 6520  te, the average 
+00011db0: 6570 6f63 6820 616e 6420 7468 6520 6d65  epoch and the me
+00011dc0: 7472 6963 2076 616c 7565 7320 284e 6f6e  tric values (Non
+00011dd0: 6520 6966 206e 6f20 6d65 7472 6963 7329  e if no metrics)
+00011de0: 0a20 2020 2072 6574 7572 6e20 6461 7461  .    return data
+00011df0: 5f72 6561 6465 722e 7361 6d70 6c69 6e67  _reader.sampling
+00011e00: 5f72 6174 652c 2064 6174 612c 206d 6574  _rate, data, met
+00011e10: 7269 635f 7661 6c75 6573 0a0a 0a64 6566  ric_values...def
+00011e20: 205f 5f6c 6f61 645f 6461 7461 5f65 706f   __load_data_epo
+00011e30: 6368 735f 5f62 795f 6368 616e 6e65 6c73  chs__by_channels
+00011e40: 5f5f 7769 7468 5072 6570 2861 7665 7261  __withPrep(avera
+00011e50: 6765 2c20 6461 7461 5f72 6561 6465 722c  ge, data_reader,
+00011e60: 2072 6574 7269 6576 655f 6368 616e 6e65   retrieve_channe
+00011e70: 6c73 2c20 6f6e 7365 7473 2c0a 2020 2020  ls, onsets,.    
+00011e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ea0: 2020 2020 2020 2020 2020 7472 6961 6c5f            trial_
+00011eb0: 6570 6f63 682c 2062 6173 656c 696e 655f  epoch, baseline_
+00011ec0: 6d65 7468 6f64 2c20 6261 7365 6c69 6e65  method, baseline
+00011ed0: 5f65 706f 6368 2c0a 2020 2020 2020 2020  _epoch,.        
+00011ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f00: 2020 2020 2020 6f75 745f 6f66 5f62 6f75        out_of_bou
+00011f10: 6e64 5f6d 6574 686f 642c 206d 6574 7269  nd_method, metri
+00011f20: 635f 6361 6c6c 6261 636b 732c 0a20 2020  c_callbacks,.   
+00011f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f50: 2020 2020 2020 2020 2020 2068 6967 685f             high_
+00011f60: 7061 7373 2c20 6561 726c 795f 7265 7265  pass, early_rere
+00011f70: 662c 206c 696e 655f 6e6f 6973 655f 7265  f, line_noise_re
+00011f80: 6d6f 7661 6c2c 206c 6174 655f 7265 7265  moval, late_rere
+00011f90: 662c 2070 7269 6f72 6974 7929 3a0a 2020  f, priority):.  
+00011fa0: 2020 2222 220a 2020 2020 4c6f 6164 2074    """.    Load t
+00011fb0: 6865 2064 6174 612c 2070 7265 7072 6f63  he data, preproc
+00011fc0: 6573 7320 616e 6420 6569 7468 6572 2065  ess and either e
+00011fd0: 706f 6368 206f 7220 286f 7074 696f 6e61  poch or (optiona
+00011fe0: 6c6c 7929 2063 616c 6375 6c61 7465 206d  lly) calculate m
+00011ff0: 6574 7269 6373 2061 6e64 2065 706f 6368  etrics and epoch
+00012000: 2d61 7665 7261 6765 2074 6f20 6120 6d61  -average to a ma
+00012010: 7472 6978 2e0a 2020 2020 5468 6973 2066  trix..    This f
+00012020: 756e 6374 696f 6e20 7072 6f63 6573 7365  unction processe
+00012030: 7320 6461 7461 2070 6572 2063 6861 6e6e  s data per chann
+00012040: 656c 2069 6e20 6f72 6465 7220 746f 206d  el in order to m
+00012050: 696e 696d 697a 6520 6d65 6d6f 7279 2075  inimize memory u
+00012060: 7361 6765 2062 7574 2073 7469 6c6c 2062  sage but still b
+00012070: 6520 6162 6c65 2074 6f20 6170 706c 7920  e able to apply 
+00012080: 7072 6570 726f 6365 7373 696e 670a 2020  preprocessing.  
+00012090: 2020 7374 6570 7320 286f 7074 696f 6e61    steps (optiona
+000120a0: 6c6c 793a 2068 6967 682d 7061 7373 2066  lly: high-pass f
+000120b0: 696c 7465 7269 6e67 2c20 6561 726c 7920  iltering, early 
+000120c0: 7265 2d72 6566 6572 656e 6369 6e67 2c20  re-referencing, 
+000120d0: 6c69 6e65 2d6e 6f69 7365 2072 656d 6f76  line-noise remov
+000120e0: 616c 2061 6e64 206c 6174 6520 7265 2d72  al and late re-r
+000120f0: 6566 6572 656e 6369 6e67 292e 0a20 2020  eferencing)..   
+00012100: 2041 6674 6572 2070 7265 7072 6f63 6573   After preproces
+00012110: 7369 6e67 2c20 7468 6520 6368 616e 6e65  sing, the channe
+00012120: 6c20 6461 7461 2069 7320 6569 7468 6572  l data is either
+00012130: 2065 706f 6368 6564 2061 6e64 2072 6574   epoched and ret
+00012140: 7572 6e65 6420 696e 2061 206d 6174 7269  urned in a matri
+00012150: 7820 2866 6f72 6d61 743a 2063 6861 6e6e  x (format: chann
+00012160: 656c 2078 2074 7269 616c 732f 6570 6f63  el x trials/epoc
+00012170: 6873 2078 2074 696d 6529 2c0a 2020 2020  hs x time),.    
+00012180: 6f72 2028 6f70 7469 6f6e 616c 6c79 2920  or (optionally) 
+00012190: 6d65 7472 6963 7320 6172 6520 6361 6c63  metrics are calc
+000121a0: 756c 6174 6564 2061 6e64 2074 6865 2065  ulated and the e
+000121b0: 706f 6368 2d61 7665 7261 6765 2069 7320  poch-average is 
+000121c0: 696e 2061 206d 6174 7269 7820 2866 6f72  in a matrix (for
+000121d0: 6d61 743a 2063 6861 6e6e 656c 2078 2063  mat: channel x c
+000121e0: 6f6e 6469 7469 6f6e 2078 2074 696d 6529  ondition x time)
+000121f0: 2e0a 2020 2020 496e 2061 6464 6974 696f  ..    In additio
+00012200: 6e2c 2061 6e20 6f70 7469 6d69 7a65 6420  n, an optimized 
+00012210: 7061 7261 6d65 7465 7220 6361 6e20 6265  parameter can be
+00012220: 2073 6574 2074 6f20 6569 7468 6572 2027   set to either '
+00012230: 6d65 6d27 206f 7220 2773 7065 6564 273b  mem' or 'speed';
+00012240: 2027 6d65 6d27 2077 696c 6c20 756e 6c6f   'mem' will unlo
+00012250: 6164 2074 6865 2063 6861 6e6e 656c 2069  ad the channel i
+00012260: 6e62 6574 7765 656e 0a20 2020 2070 726f  nbetween.    pro
+00012270: 6365 7373 696e 6720 7374 6570 732c 206d  cessing steps, m
+00012280: 616b 696e 6720 7468 6520 7072 6f63 6573  aking the proces
+00012290: 7320 736c 6f77 6572 2062 7574 206d 6f73  s slower but mos
+000122a0: 7420 6d65 6d6f 7279 2065 6666 6963 6965  t memory efficie
+000122b0: 6e74 3b20 2773 7065 6564 2720 7769 6c6c  nt; 'speed' will
+000122c0: 206b 6565 7020 7468 6520 6368 616e 6e65   keep the channe
+000122d0: 6c20 6461 7461 2069 6e20 6d65 6d6f 7279  l data in memory
+000122e0: 0a20 2020 2074 6872 6f75 6768 6f75 7420  .    throughout 
+000122f0: 7468 6520 7072 6f63 6573 7369 6e67 2c20  the processing, 
+00012300: 616c 6c6f 7769 6e67 2066 6f72 206d 6f72  allowing for mor
+00012310: 6520 7370 6565 6420 6275 7420 616c 736f  e speed but also
+00012320: 2072 6571 7569 7269 6e67 206d 6f72 6520   requiring more 
+00012330: 6d65 6d6f 7279 2e0a 0a0a 2020 2020 4e6f  memory....    No
+00012340: 7465 3a20 2020 4e6f 7465 2074 6861 7420  te:   Note that 
+00012350: 666f 7220 7072 6570 726f 6365 7373 696e  for preprocessin
+00012360: 6720 7468 6520 4544 4620 6f72 2042 7261  g the EDF or Bra
+00012370: 696e 5669 7369 6f6e 2066 6f72 6d61 7420  inVision format 
+00012380: 616c 7265 6164 7920 6c6f 6164 2074 6865  already load the
+00012390: 2065 6e74 6972 6520 7365 7420 696e 206d   entire set in m
+000123a0: 656d 6f72 792e 2050 7265 7072 6f63 6573  emory. Preproces
+000123b0: 7369 6e67 0a20 2020 2020 2020 2020 2020  sing.           
+000123c0: 2077 696c 6c20 7265 7175 6972 6520 6120   will require a 
+000123d0: 636f 7079 206f 6620 7468 6520 6368 616e  copy of the chan
+000123e0: 6e65 6c20 6461 7461 2066 6f72 206d 616e  nel data for man
+000123f0: 6970 756c 6174 696f 6e2c 2073 6f20 7468  ipulation, so th
+00012400: 6572 6520 6973 206e 6f20 6d65 6d6f 7279  ere is no memory
+00012410: 2062 656e 6566 6974 2069 6e20 7468 6520   benefit in the 
+00012420: 6661 6374 2074 6861 740a 2020 2020 2020  fact that.      
+00012430: 2020 2020 2020 4d4e 4520 616c 7265 6164        MNE alread
+00012440: 7920 6c6f 6164 7320 7468 6520 656e 7469  y loads the enti
+00012450: 7265 2064 6174 6173 6574 2069 6e74 6f20  re dataset into 
+00012460: 6d65 6d6f 7279 2e0a 0a20 2020 2041 7267  memory...    Arg
+00012470: 733a 0a20 2020 2020 2020 2061 7665 7261  s:.        avera
+00012480: 6765 2028 626f 6f6c 6561 6e29 3a20 2020  ge (boolean):   
+00012490: 2020 2020 2020 2020 2020 2020 2020 2057                 W
+000124a0: 6865 7468 6572 2c20 6166 7465 7220 7072  hether, after pr
+000124b0: 6570 726f 6365 7373 696e 672c 206f 6e6c  eprocessing, onl
+000124c0: 7920 6570 6f63 6873 2028 4661 6c73 6529  y epochs (False)
+000124d0: 2073 686f 756c 6420 6265 2065 7874 7261   should be extra
+000124e0: 6374 6564 2061 6e64 0a20 2020 2020 2020  cted and.       
+000124f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012510: 2020 2020 2072 6574 7572 6e65 642c 206f       returned, o
+00012520: 7220 7768 6574 6865 7220 286f 7074 696f  r whether (optio
+00012530: 6e61 6c6c 7929 206d 6574 7269 6373 2073  nally) metrics s
+00012540: 686f 756c 6420 6265 2063 616c 6375 6c61  hould be calcula
+00012550: 7465 6420 616e 640a 2020 2020 2020 2020  ted and.        
+00012560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012580: 2020 2020 6570 6f63 682d 6176 6572 6167      epoch-averag
+00012590: 6573 2073 686f 756c 6420 6265 2072 6574  es should be ret
+000125a0: 7572 6e65 6420 2854 7275 6529 0a20 2020  urned (True).   
+000125b0: 2020 2020 2064 6174 615f 7265 6164 6572       data_reader
+000125c0: 2028 4965 6567 4461 7461 5265 6164 6572   (IeegDataReader
+000125d0: 293a 2020 2020 2020 2041 6e20 696e 7374  ):       An inst
+000125e0: 616e 6365 206f 6620 7468 6520 4965 6567  ance of the Ieeg
+000125f0: 4461 7461 5265 6164 6572 2074 6f20 7265  DataReader to re
+00012600: 7472 6965 7665 206d 6574 6164 6174 6120  trieve metadata 
+00012610: 616e 6420 6368 616e 6e65 6c20 6461 7461  and channel data
+00012620: 0a20 2020 2020 2020 2072 6574 7269 6576  .        retriev
+00012630: 655f 6368 616e 6e65 6c73 2028 6c69 7374  e_channels (list
+00012640: 206f 7220 7475 706c 6529 3a20 2054 6865   or tuple):  The
+00012650: 2063 6861 6e6e 656c 7320 2862 7920 6e61   channels (by na
+00012660: 6d65 2920 6f66 2077 6869 6368 2074 6865  me) of which the
+00012670: 2064 6174 6120 7368 6f75 6c64 2062 6520   data should be 
+00012680: 7265 7472 6965 7665 642c 2074 6865 206f  retrieved, the o
+00012690: 7574 7075 7420 7769 6c6c 2062 6520 736f  utput will be so
+000126a0: 7274 6564 2061 6363 6f72 6469 6e67 6c79  rted accordingly
+000126b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126d0: 2020 2020 2020 2020 2020 2020 204e 6f74               Not
+000126e0: 653a 2074 6861 7420 7468 6973 2064 6f65  e: that this doe
+000126f0: 7320 6e6f 7420 6861 7665 2074 6f20 696e  s not have to in
+00012700: 636c 7564 6520 7468 6520 6368 616e 6e65  clude the channe
+00012710: 6c73 2074 6861 7420 6172 6520 7265 7175  ls that are requ
+00012720: 6972 6564 2066 6f72 2072 652d 7265 6665  ired for re-refe
+00012730: 7265 6e63 696e 670a 0a20 2020 2020 2020  rencing..       
+00012740: 206f 6e73 6574 7320 2831 642f 3264 206c   onsets (1d/2d l
+00012750: 6973 7420 6f72 2074 7570 6c65 293a 2020  ist or tuple):  
+00012760: 2020 2020 2049 6620 6f6e 6c79 2074 6865       If only the
+00012770: 2065 706f 6368 7320 6e65 6564 2074 6f20   epochs need to 
+00012780: 6265 2065 7874 7261 6374 6564 2061 6e64  be extracted and
+00012790: 2072 6574 7572 6e65 6420 2861 7665 7261   returned (avera
+000127a0: 6765 3d46 616c 7365 2920 7468 656e 2074  ge=False) then t
+000127b0: 6869 730a 2020 2020 2020 2020 2020 2020  his.            
+000127c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127e0: 6172 6775 6d65 6e74 2073 686f 756c 6420  argument should 
+000127f0: 6265 2061 2031 6420 6c69 7374 206f 7220  be a 1d list or 
+00012800: 7475 706c 6520 7468 6174 2068 6f6c 6473  tuple that holds
+00012810: 2074 6865 206f 6e73 6574 7320 6f66 2074   the onsets of t
+00012820: 6865 2074 7269 616c 7320 6172 6f75 6e64  he trials around
+00012830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012850: 2020 2020 2020 2020 2020 2020 2077 6869               whi
+00012860: 6368 2074 6f20 6570 6f63 6820 7468 6520  ch to epoch the 
+00012870: 6461 7461 2e0a 2020 2020 2020 2020 2020  data..          
+00012880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128a0: 2020 4966 206d 6574 7269 6320 616e 6420    If metric and 
+000128b0: 6176 6572 6167 652d 6570 6f63 6873 206e  average-epochs n
+000128c0: 6565 6420 746f 2062 6520 6361 6c63 756c  eed to be calcul
+000128d0: 6174 6564 2061 6e64 2072 6574 7572 6e65  ated and returne
+000128e0: 6420 2841 7665 7261 6765 3d54 7275 6529  d (Average=True)
+000128f0: 2074 6865 6e0a 2020 2020 2020 2020 2020   then.          
+00012900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012920: 2020 7468 6973 2061 7267 756d 656e 7420    this argument 
+00012930: 7368 6f75 6c64 2062 6520 6120 3264 206c  should be a 2d l
+00012940: 6973 7420 6f72 2074 7570 6c65 2074 6861  ist or tuple tha
+00012950: 7420 696e 6469 6361 7465 7320 7468 6520  t indicates the 
+00012960: 636f 6e64 6974 696f 6e73 2c20 616e 640a  conditions, and.
+00012970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012990: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+000129a0: 6f6e 7365 7473 206f 6620 7468 6520 7472  onsets of the tr
+000129b0: 6961 6c73 2074 6861 7420 6265 6c6f 6e67  ials that belong
+000129c0: 2074 6f20 6561 6368 2063 6f6e 6469 7469   to each conditi
+000129d0: 6f6e 2e20 2866 6f72 6d61 743a 2063 6f6e  on. (format: con
+000129e0: 6469 7469 6f6e 7320 7820 636f 6e64 6974  ditions x condit
+000129f0: 696f 6e20 6f6e 7365 7473 290a 2020 2020  ion onsets).    
+00012a00: 2222 220a 0a20 2020 2023 2063 616c 6375  """..    # calcu
+00012a10: 6c61 7465 2074 6865 2073 697a 6520 6f66  late the size of
+00012a20: 2074 6865 2074 696d 6520 6469 6d65 6e73   the time dimens
+00012a30: 696f 6e20 2869 6e20 7361 6d70 6c65 7329  ion (in samples)
+00012a40: 0a20 2020 2074 7269 616c 5f6e 756d 5f73  .    trial_num_s
+00012a50: 616d 706c 6573 203d 2069 6e74 2872 6f75  amples = int(rou
+00012a60: 6e64 2861 6273 2874 7269 616c 5f65 706f  nd(abs(trial_epo
+00012a70: 6368 5b31 5d20 2d20 7472 6961 6c5f 6570  ch[1] - trial_ep
+00012a80: 6f63 685b 305d 2920 2a20 6461 7461 5f72  och[0]) * data_r
+00012a90: 6561 6465 722e 7361 6d70 6c69 6e67 5f72  eader.sampling_r
+00012aa0: 6174 6529 290a 2020 2020 6261 7365 6c69  ate)).    baseli
+00012ab0: 6e65 5f6e 756d 5f73 616d 706c 6573 203d  ne_num_samples =
+00012ac0: 2069 6e74 2872 6f75 6e64 2861 6273 2862   int(round(abs(b
+00012ad0: 6173 656c 696e 655f 6570 6f63 685b 315d  aseline_epoch[1]
+00012ae0: 202d 2062 6173 656c 696e 655f 6570 6f63   - baseline_epoc
+00012af0: 685b 305d 2920 2a20 6461 7461 5f72 6561  h[0]) * data_rea
+00012b00: 6465 722e 7361 6d70 6c69 6e67 5f72 6174  der.sampling_rat
+00012b10: 6529 290a 0a20 2020 2023 2069 6e69 7469  e))..    # initi
+00012b20: 616c 697a 6520 6120 6461 7461 2062 7566  alize a data buf
+00012b30: 6665 7220 2863 6861 6e6e 656c 2078 2074  fer (channel x t
+00012b40: 7269 616c 732f 6570 6f63 6873 2078 2074  rials/epochs x t
+00012b50: 696d 6529 0a20 2020 2074 7279 3a0a 2020  ime).    try:.  
+00012b60: 2020 2020 2020 6461 7461 203d 2061 6c6c        data = all
+00012b70: 6f63 6174 655f 6172 7261 7928 286c 656e  ocate_array((len
+00012b80: 2872 6574 7269 6576 655f 6368 616e 6e65  (retrieve_channe
+00012b90: 6c73 292c 206c 656e 286f 6e73 6574 7329  ls), len(onsets)
+00012ba0: 2c20 7472 6961 6c5f 6e75 6d5f 7361 6d70  , trial_num_samp
+00012bb0: 6c65 7329 290a 2020 2020 6578 6365 7074  les)).    except
+00012bc0: 204d 656d 6f72 7945 7272 6f72 3a0a 2020   MemoryError:.  
+00012bd0: 2020 2020 2020 7261 6973 6520 4d65 6d6f        raise Memo
+00012be0: 7279 4572 726f 7228 274e 6f74 2065 6e6f  ryError('Not eno
+00012bf0: 7567 6820 6d65 6d6f 7279 2063 7265 6174  ugh memory creat
+00012c00: 6520 6120 6461 7461 206f 7574 7075 7420  e a data output 
+00012c10: 6d61 7472 6978 2729 0a0a 2020 2020 2320  matrix')..    # 
+00012c20: 696e 6974 6961 6c69 7a65 2061 206d 6574  initialize a met
+00012c30: 7269 6320 6275 6666 6572 2028 6368 616e  ric buffer (chan
+00012c40: 6e65 6c20 7820 636f 6e64 6974 696f 6e73  nel x conditions
+00012c50: 2078 206d 6574 7269 6329 0a20 2020 2069   x metric).    i
+00012c60: 6620 6176 6572 6167 653a 0a20 2020 2020  f average:.     
+00012c70: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00012c80: 2020 2020 6d65 7472 6963 5f76 616c 7565      metric_value
+00012c90: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
+00012ca0: 2020 2020 2069 6620 6d65 7472 6963 5f63       if metric_c
+00012cb0: 616c 6c62 6163 6b73 2069 7320 6e6f 7420  allbacks is not 
+00012cc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00012cd0: 2020 2020 2020 6966 2063 616c 6c61 626c        if callabl
+00012ce0: 6528 6d65 7472 6963 5f63 616c 6c62 6163  e(metric_callbac
+00012cf0: 6b73 293a 0a20 2020 2020 2020 2020 2020  ks):.           
+00012d00: 2020 2020 2020 2020 206d 6574 7269 635f           metric_
+00012d10: 7661 6c75 6573 203d 2061 6c6c 6f63 6174  values = allocat
+00012d20: 655f 6172 7261 7928 286c 656e 2872 6574  e_array((len(ret
+00012d30: 7269 6576 655f 6368 616e 6e65 6c73 292c  rieve_channels),
+00012d40: 206c 656e 286f 6e73 6574 7329 2929 0a20   len(onsets))). 
+00012d50: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00012d60: 6c69 6620 7479 7065 286d 6574 7269 635f  lif type(metric_
+00012d70: 6361 6c6c 6261 636b 7329 2069 7320 7475  callbacks) is tu
+00012d80: 706c 6520 616e 6420 6c65 6e28 6d65 7472  ple and len(metr
+00012d90: 6963 5f63 616c 6c62 6163 6b73 2920 3e20  ic_callbacks) > 
+00012da0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00012db0: 2020 2020 2020 206d 6574 7269 635f 7661         metric_va
+00012dc0: 6c75 6573 203d 2061 6c6c 6f63 6174 655f  lues = allocate_
+00012dd0: 6172 7261 7928 286c 656e 2872 6574 7269  array((len(retri
+00012de0: 6576 655f 6368 616e 6e65 6c73 292c 206c  eve_channels), l
+00012df0: 656e 286f 6e73 6574 7329 2c20 6c65 6e28  en(onsets), len(
+00012e00: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
+00012e10: 2929 290a 2020 2020 2020 2020 6578 6365  ))).        exce
+00012e20: 7074 204d 656d 6f72 7945 7272 6f72 3a0a  pt MemoryError:.
+00012e30: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00012e40: 6520 4d65 6d6f 7279 4572 726f 7228 274e  e MemoryError('N
+00012e50: 6f74 2065 6e6f 7567 6820 6d65 6d6f 7279  ot enough memory
+00012e60: 2063 7265 6174 6520 6120 6d65 7472 6963   create a metric
+00012e70: 206f 7574 7075 7420 6d61 7472 6978 2729   output matrix')
+00012e80: 0a0a 2020 2020 2320 6372 6561 7465 2061  ..    # create a
+00012e90: 206c 6973 7420 6f66 2061 6c6c 2063 6861   list of all cha
+00012ea0: 6e6e 656c 7320 7468 6174 2077 6520 6e65  nnels that we ne
+00012eb0: 6564 2c20 6d6f 7374 2077 6974 6820 7468  ed, most with th
+00012ec0: 6520 7075 7270 6f73 6520 6f66 2072 6561  e purpose of rea
+00012ed0: 6469 6e67 2061 6e64 2072 6574 7572 6e69  ding and returni
+00012ee0: 6e67 2028 652e 672e 206f 6e6c 7920 4543  ng (e.g. only EC
+00012ef0: 6f47 2920 6275 7420 736f 6d65 206f 6e6c  oG) but some onl
+00012f00: 7920 746f 2062 6520 7573 6564 2066 6f72  y to be used for
+00012f10: 2072 652d 7265 6665 7265 6e63 696e 6720   re-referencing 
+00012f20: 2865 2e67 2e20 626f 7468 2045 436f 4720  (e.g. both ECoG 
+00012f30: 616e 6420 5345 4547 290a 2020 2020 616c  and SEEG).    al
+00012f40: 6c5f 6368 616e 6e65 6c73 203d 2072 6574  l_channels = ret
+00012f50: 7269 6576 655f 6368 616e 6e65 6c73 2e63  rieve_channels.c
+00012f60: 6f70 7928 290a 2020 2020 7472 793a 0a20  opy().    try:. 
+00012f70: 2020 2020 2020 2069 6620 6561 726c 795f         if early_
+00012f80: 7265 7265 6620 6973 206e 6f74 204e 6f6e  reref is not Non
+00012f90: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+00012fa0: 6172 6c79 5f72 6571 5f63 6861 6e6e 656c  arly_req_channel
+00012fb0: 7320 3d20 6561 726c 795f 7265 7265 662e  s = early_reref.
+00012fc0: 6765 745f 7265 7175 6972 6564 5f63 6861  get_required_cha
+00012fd0: 6e6e 656c 7328 7265 7472 6965 7665 5f63  nnels(retrieve_c
+00012fe0: 6861 6e6e 656c 7329 0a20 2020 2020 2020  hannels).       
+00012ff0: 2020 2020 2065 6172 6c79 5f72 6571 5f67       early_req_g
+00013000: 726f 7570 7320 3d20 6561 726c 795f 7265  roups = early_re
+00013010: 7265 662e 6765 745f 7265 7175 6972 6564  ref.get_required
+00013020: 5f67 726f 7570 7328 7265 7472 6965 7665  _groups(retrieve
+00013030: 5f63 6861 6e6e 656c 7329 0a20 2020 2020  _channels).     
+00013040: 2020 2020 2020 2066 6f72 2063 6861 6e6e         for chann
+00013050: 656c 2069 6e20 6561 726c 795f 7265 715f  el in early_req_
+00013060: 6368 616e 6e65 6c73 3a0a 2020 2020 2020  channels:.      
+00013070: 2020 2020 2020 2020 2020 6966 2063 6861            if cha
+00013080: 6e6e 656c 206e 6f74 2069 6e20 616c 6c5f  nnel not in all_
+00013090: 6368 616e 6e65 6c73 3a0a 2020 2020 2020  channels:.      
+000130a0: 2020 2020 2020 2020 2020 2020 2020 616c                al
+000130b0: 6c5f 6368 616e 6e65 6c73 2e61 7070 656e  l_channels.appen
+000130c0: 6428 6368 616e 6e65 6c29 0a20 2020 2020  d(channel).     
+000130d0: 2020 2069 6620 6c61 7465 5f72 6572 6566     if late_reref
+000130e0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000130f0: 2020 2020 2020 2020 2020 6c61 7465 5f72            late_r
+00013100: 6571 5f63 6861 6e6e 656c 7320 3d20 6c61  eq_channels = la
+00013110: 7465 5f72 6572 6566 2e67 6574 5f72 6571  te_reref.get_req
+00013120: 7569 7265 645f 6368 616e 6e65 6c73 2872  uired_channels(r
+00013130: 6574 7269 6576 655f 6368 616e 6e65 6c73  etrieve_channels
+00013140: 290a 2020 2020 2020 2020 2020 2020 6c61  ).            la
+00013150: 7465 5f72 6571 5f67 726f 7570 7320 3d20  te_req_groups = 
+00013160: 6c61 7465 5f72 6572 6566 2e67 6574 5f72  late_reref.get_r
+00013170: 6571 7569 7265 645f 6772 6f75 7073 2872  equired_groups(r
+00013180: 6574 7269 6576 655f 6368 616e 6e65 6c73  etrieve_channels
+00013190: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+000131a0: 7220 6368 616e 6e65 6c20 696e 206c 6174  r channel in lat
+000131b0: 655f 7265 715f 6368 616e 6e65 6c73 3a0a  e_req_channels:.
+000131c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000131d0: 6966 2063 6861 6e6e 656c 206e 6f74 2069  if channel not i
+000131e0: 6e20 616c 6c5f 6368 616e 6e65 6c73 3a0a  n all_channels:.
+000131f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013200: 2020 2020 616c 6c5f 6368 616e 6e65 6c73      all_channels
+00013210: 2e61 7070 656e 6428 6368 616e 6e65 6c29  .append(channel)
+00013220: 0a20 2020 2065 7863 6570 7420 5661 6c75  .    except Valu
+00013230: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+00013240: 6c6f 6767 696e 672e 6572 726f 7228 2743  logging.error('C
+00013250: 6f75 6c64 206e 6f74 2066 696e 6420 6120  ould not find a 
+00013260: 6368 616e 6e65 6c20 7468 6174 2069 7320  channel that is 
+00013270: 746f 2062 6520 7573 6564 2066 6f72 2065  to be used for e
+00013280: 6172 6c79 206f 7220 6c61 7465 2072 652d  arly or late re-
+00013290: 7265 6665 7265 6e63 696e 6720 696e 2074  referencing in t
+000132a0: 6865 2072 6572 6566 2073 7472 7563 7427  he reref struct'
+000132b0: 290a 2020 2020 2020 2020 7261 6973 6520  ).        raise 
+000132c0: 5661 6c75 6545 7272 6f72 2827 436f 756c  ValueError('Coul
+000132d0: 6420 6e6f 7420 6669 6e64 2061 2063 6861  d not find a cha
+000132e0: 6e6e 656c 2074 6861 7420 6973 2074 6f20  nnel that is to 
+000132f0: 7265 7472 6965 7665 6420 696e 2074 6865  retrieved in the
+00013300: 2072 6572 6566 2073 7472 7563 7427 290a   reref struct').
+00013310: 0a0a 2020 2020 230a 2020 2020 2320 496e  ..    #.    # In
+00013320: 6974 6961 6c69 7a65 2076 6172 6961 626c  itialize variabl
+00013330: 6520 7468 6174 2074 7261 636b 2070 726f  e that track pro
+00013340: 6365 7373 696e 670a 2020 2020 230a 0a20  cessing.    #.. 
+00013350: 2020 2063 6861 6e6e 656c 5f65 706f 6368     channel_epoch
+00013360: 6564 203d 2064 6963 7428 2920 2020 2020  ed = dict()     
+00013370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013380: 2020 2023 2074 7261 636b 7320 666f 7220     # tracks for 
+00013390: 6561 6368 2063 6861 6e6e 656c 2077 6865  each channel whe
+000133a0: 7468 6572 2069 7420 6861 7320 6265 656e  ther it has been
+000133b0: 2065 706f 6368 6564 2028 6675 6c6c 7920   epoched (fully 
+000133c0: 7072 6f63 6573 7365 6429 0a20 2020 2066  processed).    f
+000133d0: 6f72 2063 6861 6e6e 656c 2069 6e20 7265  or channel in re
+000133e0: 7472 6965 7665 5f63 6861 6e6e 656c 733a  trieve_channels:
+000133f0: 0a20 2020 2020 2020 2063 6861 6e6e 656c  .        channel
+00013400: 5f65 706f 6368 6564 5b63 6861 6e6e 656c  _epoched[channel
+00013410: 5d20 3d20 4661 6c73 650a 0a20 2020 2069  ] = False..    i
+00013420: 6620 6561 726c 795f 7265 7265 6620 6973  f early_reref is
+00013430: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00013440: 2020 2063 6861 6e6e 656c 5f65 6172 6c79     channel_early
+00013450: 5f72 6572 6566 5f63 6f6c 6c65 6374 6564  _reref_collected
+00013460: 203d 2064 6963 7428 2920 2020 2020 2020   = dict()       
+00013470: 2020 2023 2074 7261 636b 7320 666f 7220     # tracks for 
+00013480: 6561 6368 2063 6861 6e6e 656c 2069 6620  each channel if 
+00013490: 7468 6520 6368 616e 6e65 6c2d 6461 7461  the channel-data
+000134a0: 2069 7320 6164 6465 6420 746f 2074 6865   is added to the
+000134b0: 2065 6172 6c79 2072 652d 7265 6620 6772   early re-ref gr
+000134c0: 6f75 7020 6176 6572 6167 6573 0a20 2020  oup averages.   
+000134d0: 2020 2020 2066 6f72 2063 6861 6e6e 656c       for channel
+000134e0: 2069 6e20 6561 726c 795f 7265 715f 6368   in early_req_ch
+000134f0: 616e 6e65 6c73 3a0a 2020 2020 2020 2020  annels:.        
+00013500: 2020 2020 6368 616e 6e65 6c5f 6561 726c      channel_earl
+00013510: 795f 7265 7265 665f 636f 6c6c 6563 7465  y_reref_collecte
+00013520: 645b 6368 616e 6e65 6c5d 203d 2046 616c  d[channel] = Fal
+00013530: 7365 0a0a 2020 2020 2020 2020 6561 726c  se..        earl
+00013540: 795f 6772 6f75 705f 6461 7461 203d 2064  y_group_data = d
+00013550: 6963 7428 2920 2020 2020 2020 2020 2020  ict()           
+00013560: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
+00013570: 7220 6561 6368 2065 6172 6c79 2072 652d  r each early re-
+00013580: 7265 6620 6772 6f75 7020 7374 6f72 6573  ref group stores
+00013590: 2074 6865 2028 746f 7461 6c2f 6176 6572   the (total/aver
+000135a0: 6167 6529 2064 6174 610a 2020 2020 2020  age) data.      
+000135b0: 2020 6561 726c 795f 6772 6f75 705f 6e75    early_group_nu
+000135c0: 6d64 6174 6120 3d20 6469 6374 2829 2020  mdata = dict()  
+000135d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000135e0: 2020 2320 666f 7220 6561 6368 2065 6172    # for each ear
+000135f0: 6c79 2072 652d 7265 6620 6772 6f75 7020  ly re-ref group 
+00013600: 7374 6f72 6573 2074 6865 206e 756d 206f  stores the num o
+00013610: 6620 7361 6d70 6c65 7320 666f 7220 6561  f samples for ea
+00013620: 6368 2064 6174 6170 6f69 6e74 2069 6e20  ch datapoint in 
+00013630: 7468 6520 2874 6f74 616c 2920 6461 7461  the (total) data
+00013640: 0a20 2020 2020 2020 2065 6172 6c79 5f67  .        early_g
+00013650: 726f 7570 5f63 6861 6e6e 656c 735f 636f  roup_channels_co
+00013660: 6c6c 6563 7465 6420 3d20 6469 6374 2829  llected = dict()
+00013670: 2020 2020 2020 2020 2023 2074 7261 636b           # track
+00013680: 7320 666f 7220 6561 6368 2065 6172 6c79  s for each early
+00013690: 2072 652d 7265 6620 6772 6f75 7020 616c   re-ref group al
+000136a0: 6c20 7468 6520 6368 616e 6e65 6c73 2074  l the channels t
+000136b0: 6861 7420 6e65 6564 2074 6f20 6265 2063  hat need to be c
+000136c0: 6f6c 6c65 6374 6564 0a20 2020 2020 2020  ollected.       
+000136d0: 2066 6f72 2067 726f 7570 2069 6e20 6561   for group in ea
+000136e0: 726c 795f 7265 715f 6772 6f75 7073 3a0a  rly_req_groups:.
+000136f0: 2020 2020 2020 2020 2020 2020 6561 726c              earl
+00013700: 795f 6772 6f75 705f 6461 7461 5b73 7472  y_group_data[str
+00013710: 2867 726f 7570 295d 203d 204e 6f6e 650a  (group)] = None.
+00013720: 2020 2020 2020 2020 2020 2020 6561 726c              earl
+00013730: 795f 6772 6f75 705f 6e75 6d64 6174 615b  y_group_numdata[
+00013740: 7374 7228 6772 6f75 7029 5d20 3d20 4e6f  str(group)] = No
+00013750: 6e65 0a20 2020 2020 2020 2020 2020 2065  ne.            e
+00013760: 6172 6c79 5f67 726f 7570 5f63 6861 6e6e  arly_group_chann
+00013770: 656c 735f 636f 6c6c 6563 7465 645b 7374  els_collected[st
+00013780: 7228 6772 6f75 7029 5d20 3d20 6469 6374  r(group)] = dict
+00013790: 2829 0a20 2020 2020 2020 2020 2020 2066  ().            f
+000137a0: 6f72 2063 6861 6e6e 656c 2069 6e20 6561  or channel in ea
+000137b0: 726c 795f 7265 7265 662e 6772 6f75 7073  rly_reref.groups
+000137c0: 5b67 726f 7570 5d3a 0a20 2020 2020 2020  [group]:.       
+000137d0: 2020 2020 2020 2020 2065 6172 6c79 5f67           early_g
+000137e0: 726f 7570 5f63 6861 6e6e 656c 735f 636f  roup_channels_co
+000137f0: 6c6c 6563 7465 645b 7374 7228 6772 6f75  llected[str(grou
+00013800: 7029 5d5b 6368 616e 6e65 6c5d 203d 2046  p)][channel] = F
+00013810: 616c 7365 0a0a 2020 2020 6966 206c 6174  alse..    if lat
+00013820: 655f 7265 7265 6620 6973 206e 6f74 204e  e_reref is not N
+00013830: 6f6e 653a 0a20 2020 2020 2020 2063 6861  one:.        cha
+00013840: 6e6e 656c 5f6c 6174 655f 7265 7265 665f  nnel_late_reref_
+00013850: 636f 6c6c 6563 7465 6420 3d20 6469 6374  collected = dict
+00013860: 2829 2020 2020 2020 2020 2020 2320 7472  ()          # tr
+00013870: 6163 6b73 2066 6f72 2065 6163 6820 6368  acks for each ch
+00013880: 616e 6e65 6c20 6966 2074 6865 2063 6861  annel if the cha
+00013890: 6e6e 656c 2d64 6174 6120 6973 2061 6464  nnel-data is add
+000138a0: 6564 2074 6f20 7468 6520 6c61 7465 2072  ed to the late r
+000138b0: 652d 7265 6620 6772 6f75 7020 6176 6572  e-ref group aver
+000138c0: 6167 6573 0a20 2020 2020 2020 2066 6f72  ages.        for
+000138d0: 2063 6861 6e6e 656c 2069 6e20 6c61 7465   channel in late
+000138e0: 5f72 6571 5f63 6861 6e6e 656c 733a 0a20  _req_channels:. 
+000138f0: 2020 2020 2020 2020 2020 2063 6861 6e6e             chann
+00013900: 656c 5f6c 6174 655f 7265 7265 665f 636f  el_late_reref_co
+00013910: 6c6c 6563 7465 645b 6368 616e 6e65 6c5d  llected[channel]
+00013920: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+00013930: 2020 6c61 7465 5f67 726f 7570 5f64 6174    late_group_dat
+00013940: 6120 3d20 6469 6374 2829 2020 2020 2020  a = dict()      
+00013950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013960: 2020 2320 666f 7220 6561 6368 206c 6174    # for each lat
+00013970: 6520 7265 2d72 6566 2067 726f 7570 2073  e re-ref group s
+00013980: 746f 7265 7320 7468 6520 2874 6f74 616c  tores the (total
+00013990: 2f61 7665 7261 6765 2920 6461 7461 0a20  /average) data. 
+000139a0: 2020 2020 2020 206c 6174 655f 6772 6f75         late_grou
+000139b0: 705f 6e75 6d64 6174 6120 3d20 6469 6374  p_numdata = dict
+000139c0: 2829 2020 2020 2020 2020 2020 2020 2020  ()              
+000139d0: 2020 2020 2020 2023 2066 6f72 2065 6163         # for eac
+000139e0: 6820 6c61 7465 2072 652d 7265 6620 6772  h late re-ref gr
+000139f0: 6f75 7020 7374 6f72 6573 2074 6865 206e  oup stores the n
+00013a00: 756d 206f 6620 7361 6d70 6c65 7320 666f  um of samples fo
+00013a10: 7220 6561 6368 2064 6174 6170 6f69 6e74  r each datapoint
+00013a20: 2069 6e20 7468 6520 2874 6f74 616c 2920   in the (total) 
+00013a30: 6461 7461 0a20 2020 2020 2020 206c 6174  data.        lat
+00013a40: 655f 6772 6f75 705f 6368 616e 6e65 6c73  e_group_channels
+00013a50: 5f63 6f6c 6c65 6374 6564 203d 2064 6963  _collected = dic
+00013a60: 7428 2920 2020 2020 2020 2020 2023 2074  t()          # t
+00013a70: 7261 636b 7320 666f 7220 6561 6368 206c  racks for each l
+00013a80: 6174 6520 7265 2d72 6566 2067 726f 7570  ate re-ref group
+00013a90: 2061 6c6c 2074 6865 2063 6861 6e6e 656c   all the channel
+00013aa0: 7320 7468 6174 206e 6565 6420 746f 2062  s that need to b
+00013ab0: 6520 636f 6c6c 6563 7465 640a 2020 2020  e collected.    
+00013ac0: 2020 2020 666f 7220 6772 6f75 7020 696e      for group in
+00013ad0: 206c 6174 655f 7265 715f 6772 6f75 7073   late_req_groups
+00013ae0: 3a0a 2020 2020 2020 2020 2020 2020 6c61  :.            la
+00013af0: 7465 5f67 726f 7570 5f64 6174 615b 7374  te_group_data[st
+00013b00: 7228 6772 6f75 7029 5d20 3d20 4e6f 6e65  r(group)] = None
+00013b10: 0a20 2020 2020 2020 2020 2020 206c 6174  .            lat
+00013b20: 655f 6772 6f75 705f 6e75 6d64 6174 615b  e_group_numdata[
+00013b30: 7374 7228 6772 6f75 7029 5d20 3d20 4e6f  str(group)] = No
+00013b40: 6e65 0a20 2020 2020 2020 2020 2020 206c  ne.            l
+00013b50: 6174 655f 6772 6f75 705f 6368 616e 6e65  ate_group_channe
+00013b60: 6c73 5f63 6f6c 6c65 6374 6564 5b73 7472  ls_collected[str
+00013b70: 2867 726f 7570 295d 203d 2064 6963 7428  (group)] = dict(
+00013b80: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00013b90: 7220 6368 616e 6e65 6c20 696e 206c 6174  r channel in lat
+00013ba0: 655f 7265 7265 662e 6772 6f75 7073 5b67  e_reref.groups[g
+00013bb0: 726f 7570 5d3a 0a20 2020 2020 2020 2020  roup]:.         
+00013bc0: 2020 2020 2020 206c 6174 655f 6772 6f75         late_grou
+00013bd0: 705f 6368 616e 6e65 6c73 5f63 6f6c 6c65  p_channels_colle
+00013be0: 6374 6564 5b73 7472 2867 726f 7570 295d  cted[str(group)]
+00013bf0: 5b63 6861 6e6e 656c 5d20 3d20 4661 6c73  [channel] = Fals
+00013c00: 650a 0a20 2020 2063 6861 6e6e 656c 5f64  e..    channel_d
+00013c10: 6174 6120 3d20 6469 6374 2829 0a20 2020  ata = dict().   
+00013c20: 2063 6861 6e6e 656c 5f68 705f 6170 706c   channel_hp_appl
+00013c30: 6965 6420 3d20 6469 6374 2829 2020 2020  ied = dict()    
+00013c40: 2020 2020 2020 2020 2020 2320 7472 6163            # trac
+00013c50: 6b73 2066 6f72 2065 6163 6820 6368 616e  ks for each chan
+00013c60: 6e65 6c20 696e 2074 6865 2063 6861 6e6e  nel in the chann
+00013c70: 656c 2d64 6174 6120 6d61 7472 6978 2069  el-data matrix i
+00013c80: 6620 6869 6768 2d70 6173 7320 6669 6c74  f high-pass filt
+00013c90: 6572 696e 6720 6973 2061 7070 6c69 6564  ering is applied
+00013ca0: 0a20 2020 2063 6861 6e6e 656c 5f65 6172  .    channel_ear
+00013cb0: 6c79 5f61 7070 6c69 6564 203d 2064 6963  ly_applied = dic
+00013cc0: 7428 2920 2020 2020 2020 2020 2020 2320  t()           # 
+00013cd0: 7472 6163 6b73 2066 6f72 2065 6163 6820  tracks for each 
+00013ce0: 6368 616e 6e65 6c20 696e 2074 6865 2063  channel in the c
+00013cf0: 6861 6e6e 656c 2d64 6174 6120 6d61 7472  hannel-data matr
+00013d00: 6978 2069 6620 6561 726c 7920 7265 2d72  ix if early re-r
+00013d10: 6566 2069 7320 6170 706c 6965 640a 2020  ef is applied.  
+00013d20: 2020 6368 616e 6e65 6c5f 6c6e 725f 6170    channel_lnr_ap
+00013d30: 706c 6965 6420 3d20 6469 6374 2829 2020  plied = dict()  
+00013d40: 2020 2020 2020 2020 2020 2023 2074 7261             # tra
+00013d50: 636b 7320 666f 7220 6561 6368 2063 6861  cks for each cha
+00013d60: 6e6e 656c 2069 6e20 7468 6520 6368 616e  nnel in the chan
+00013d70: 6e65 6c2d 6461 7461 206d 6174 7269 7820  nel-data matrix 
+00013d80: 6966 206c 696e 652d 6e6f 6973 6520 7265  if line-noise re
+00013d90: 6d6f 7661 6c20 6973 2061 7070 6c69 6564  moval is applied
+00013da0: 0a20 2020 2066 6f72 2063 6861 6e6e 656c  .    for channel
+00013db0: 2069 6e20 616c 6c5f 6368 616e 6e65 6c73   in all_channels
+00013dc0: 3a0a 2020 2020 2020 2020 6368 616e 6e65  :.        channe
+00013dd0: 6c5f 6461 7461 5b63 6861 6e6e 656c 5d20  l_data[channel] 
+00013de0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2063  = None.        c
+00013df0: 6861 6e6e 656c 5f68 705f 6170 706c 6965  hannel_hp_applie
+00013e00: 645b 6368 616e 6e65 6c5d 203d 2046 616c  d[channel] = Fal
+00013e10: 7365 0a20 2020 2020 2020 2063 6861 6e6e  se.        chann
+00013e20: 656c 5f65 6172 6c79 5f61 7070 6c69 6564  el_early_applied
+00013e30: 5b63 6861 6e6e 656c 5d20 3d20 4661 6c73  [channel] = Fals
+00013e40: 650a 2020 2020 2020 2020 6368 616e 6e65  e.        channe
+00013e50: 6c5f 6c6e 725f 6170 706c 6965 645b 6368  l_lnr_applied[ch
+00013e60: 616e 6e65 6c5d 203d 2046 616c 7365 0a0a  annel] = False..
+00013e70: 0a20 2020 2023 0a20 2020 2023 2050 7265  .    #.    # Pre
+00013e80: 7061 7265 2066 696c 7465 7273 0a20 2020  pare filters.   
+00013e90: 2023 0a0a 2020 2020 6966 2068 6967 685f   #..    if high_
+00013ea0: 7061 7373 2069 7320 6e6f 7420 4e6f 6e65  pass is not None
+00013eb0: 3a0a 0a20 2020 2020 2020 206f 7264 6572  :..        order
+00013ec0: 203d 2032 0a20 2020 2020 2020 2066 7320   = 2.        fs 
+00013ed0: 3d20 6461 7461 5f72 6561 6465 722e 7361  = data_reader.sa
+00013ee0: 6d70 6c69 6e67 5f72 6174 650a 2020 2020  mpling_rate.    
+00013ef0: 2020 2020 7061 7373 5f66 7265 7120 3d20      pass_freq = 
+00013f00: 302e 3530 2020 2020 2023 2048 7a20 3c3c  0.50     # Hz <<
+00013f10: 3c3c 0a20 2020 2020 2020 2073 746f 705f  <<.        stop_
+00013f20: 6672 6571 203d 2030 2e30 3520 2020 2020  freq = 0.05     
+00013f30: 2320 487a 0a20 2020 2020 2020 2070 6173  # Hz.        pas
+00013f40: 735f 7269 7070 6c65 203d 2033 2020 2020  s_ripple = 3    
+00013f50: 2020 2320 6442 0a20 2020 2020 2020 2073    # dB.        s
+00013f60: 746f 705f 6174 7465 6e20 3d20 3330 2020  top_atten = 30  
+00013f70: 2020 2020 2320 6442 0a0a 2020 2020 2020      # dB..      
+00013f80: 2020 2320 544f 444f 3a20 6d61 746c 6162    # TODO: matlab
+00013f90: 2061 6c73 6f20 616c 6c6f 7773 2070 6173   also allows pas
+00013fa0: 7369 6e67 206f 6620 7374 6f70 6261 6e64  sing of stopband
+00013fb0: 2028 6275 7474 6f72 6429 2c20 686f 7765   (buttord), howe
+00013fc0: 7665 7220 6765 7474 696e 6720 7468 6520  ver getting the 
+00013fd0: 7361 6d65 2076 616c 7565 7320 6f75 7420  same values out 
+00013fe0: 6f66 2070 7974 686f 6e20 6275 7474 6f72  of python buttor
+00013ff0: 6420 6973 2064 6966 6669 6375 6c74 0a20  d is difficult. 
+00014000: 2020 2020 2020 2023 2020 2020 2020 2073         #       s
+00014010: 6574 746c 696e 6720 666f 7220 7374 616e  ettling for stan
+00014020: 6461 7264 2070 7974 686f 6e20 7761 7973  dard python ways
+00014030: 2066 6f72 206e 6f77 2028 6469 7265 6374   for now (direct
+00014040: 2075 7365 206f 6620 6275 7474 6572 290a   use of butter).
+00014050: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00014060: 2020 2020 2320 6e6f 726d 616c 697a 6520      # normalize 
+00014070: 7468 6520 7061 7373 6261 6e64 2061 6e64  the passband and
+00014080: 2073 746f 7062 616e 6420 746f 2074 6865   stopband to the
+00014090: 204e 7971 7569 7374 2066 7265 7175 656e   Nyquist frequen
+000140a0: 6379 0a20 2020 2020 2020 206e 6f72 6d5f  cy.        norm_
+000140b0: 7061 7373 5f66 7265 7120 3d20 7061 7373  pass_freq = pass
+000140c0: 5f66 7265 7120 2f20 2866 7320 2f20 3229  _freq / (fs / 2)
+000140d0: 2020 2320 7061 7373 2062 616e 6420 6672    # pass band fr
+000140e0: 6571 2069 6e20 7261 6469 616e 0a20 2020  eq in radian.   
+000140f0: 2020 2020 206e 6f72 6d5f 7374 6f70 5f66       norm_stop_f
+00014100: 7265 7120 3d20 7374 6f70 5f66 7265 7120  req = stop_freq 
+00014110: 2f20 2866 7320 2f20 3229 2020 2320 7374  / (fs / 2)  # st
+00014120: 6f70 2062 616e 6420 6672 6571 2069 6e20  op band freq in 
+00014130: 7261 6469 616e 0a20 2020 200a 2020 2020  radian.    .    
+00014140: 2020 2020 6669 6c74 4f72 6465 722c 2063      filtOrder, c
+00014150: 7574 5f66 7265 7120 3d20 7369 676e 616c  ut_freq = signal
+00014160: 2e62 7574 746f 7264 286e 6f72 6d5f 7061  .buttord(norm_pa
+00014170: 7373 5f66 7265 712c 206e 6f72 6d5f 7374  ss_freq, norm_st
+00014180: 6f70 5f66 7265 712c 2070 6173 735f 7269  op_freq, pass_ri
+00014190: 7070 6c65 2c20 7374 6f70 5f61 7474 656e  pple, stop_atten
+000141a0: 2c20 5472 7565 290a 2020 2020 0a20 2020  , True).    .   
+000141b0: 2020 2020 2023 2073 6f73 203d 2073 6967       # sos = sig
+000141c0: 6e61 6c2e 6275 7474 6572 286f 7264 6572  nal.butter(order
+000141d0: 2c20 6e6f 726d 616c 5f63 7574 6f66 662c  , normal_cutoff,
+000141e0: 2062 7479 7065 3d27 6869 6768 7061 7373   btype='highpass
+000141f0: 272c 2061 6e61 6c6f 673d 4661 6c73 652c  ', analog=False,
+00014200: 206f 7574 7075 743d 2773 6f73 272c 2066   output='sos', f
+00014210: 733d 6673 290a 2020 2020 2020 2020 235b  s=fs).        #[
+00014220: 6669 6c74 5a65 726f 732c 2066 696c 7450  filtZeros, filtP
+00014230: 6f6c 6573 2c20 6669 6c74 4761 696e 735d  oles, filtGains]
+00014240: 203d 2073 6967 6e61 6c2e 6275 7474 6572   = signal.butter
+00014250: 2832 2c20 322e 3734 3531 3230 3337 3737  (2, 2.7451203777
+00014260: 3637 3733 3265 2d30 342c 2027 6869 6768  67732e-04, 'high
+00014270: 272c 206f 7574 7075 743d 277a 706b 2729  ', output='zpk')
+00014280: 0a20 2020 2020 2020 205b 6669 6c74 5a65  .        [filtZe
+00014290: 726f 732c 2066 696c 7450 6f6c 6573 2c20  ros, filtPoles, 
+000142a0: 6669 6c74 4761 696e 735d 203d 2073 6967  filtGains] = sig
+000142b0: 6e61 6c2e 6275 7474 6572 2832 2c20 322e  nal.butter(2, 2.
+000142c0: 3734 3531 3230 3337 3737 3637 3733 3265  745120377767732e
+000142d0: 2d30 342c 2027 6869 6768 272c 206f 7574  -04, 'high', out
+000142e0: 7075 743d 277a 706b 272c 2066 733d 6673  put='zpk', fs=fs
+000142f0: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
+00014300: 2020 205b 6669 6c74 536f 735d 203d 2073     [filtSos] = s
+00014310: 6967 6e61 6c2e 7a70 6b32 736f 7328 6669  ignal.zpk2sos(fi
+00014320: 6c74 5a65 726f 732c 2066 696c 7450 6f6c  ltZeros, filtPol
+00014330: 6573 2c20 6669 6c74 4761 696e 7329 0a20  es, filtGains). 
+00014340: 2020 2020 2020 2067 6169 6e20 3d20 6669         gain = fi
+00014350: 6c74 4761 696e 730a 2020 2020 2020 2020  ltGains.        
+00014360: 2222 220a 0a20 2020 2020 2020 2023 206e  """..        # n
+00014370: 6f72 6d61 6c69 7a65 2074 6865 2068 6967  ormalize the hig
+00014380: 682d 7061 7373 2063 7574 2d6f 6666 2066  h-pass cut-off f
+00014390: 7265 7175 656e 6379 2075 7369 6e67 2074  requency using t
+000143a0: 6865 206e 7971 7569 7374 2066 7265 7175  he nyquist frequ
+000143b0: 656e 6379 2028 7372 6174 6520 2f20 3229  ency (srate / 2)
+000143c0: 0a20 2020 2020 2020 2063 7574 5f66 7265  .        cut_fre
+000143d0: 7120 3d20 7061 7373 5f66 7265 7120 2f20  q = pass_freq / 
+000143e0: 2864 6174 615f 7265 6164 6572 2e73 616d  (data_reader.sam
+000143f0: 706c 696e 675f 7261 7465 202f 2032 290a  pling_rate / 2).
+00014400: 0a20 2020 2020 2020 2023 2064 6573 6967  .        # desig
+00014410: 6e20 6120 6275 7474 6572 776f 7274 6820  n a butterworth 
+00014420: 6669 6c74 6572 2061 6e64 2067 6574 2074  filter and get t
+00014430: 6865 2066 696c 7465 7220 636f 6566 6669  he filter coeffi
+00014440: 6369 656e 7473 2028 6e75 6d65 7261 746f  cients (numerato
+00014450: 7220 2f20 6465 6e6f 6d69 6e61 746f 7220  r / denominator 
+00014460: 28e2 8098 6261 e280 9929 0a20 2020 2020  (...ba...).     
+00014470: 2020 2068 705f 6e75 6d65 7261 746f 722c     hp_numerator,
+00014480: 2068 705f 6465 6e6f 6d69 6e61 746f 7220   hp_denominator 
+00014490: 3d20 7369 676e 616c 2e62 7574 7465 7228  = signal.butter(
+000144a0: 6f72 6465 722c 2063 7574 5f66 7265 712c  order, cut_freq,
+000144b0: 2062 7479 7065 3d27 6869 6768 7061 7373   btype='highpass
+000144c0: 272c 2061 6e61 6c6f 673d 4661 6c73 652c  ', analog=False,
+000144d0: 206f 7574 7075 743d 2762 6127 2c20 6673   output='ba', fs
+000144e0: 3d66 7329 0a20 2020 2020 2020 2023 2054  =fs).        # T
+000144f0: 4f44 4f3a 2074 6865 2027 6261 2720 6f72  ODO: the 'ba' or
+00014500: 2027 736f 7327 2072 6574 7572 6e65 6420   'sos' returned 
+00014510: 6279 2062 7574 7465 7220 6469 6666 6572  by butter differ
+00014520: 2066 726f 6d20 7768 6174 206d 6174 6c61   from what matla
+00014530: 6220 6769 7665 730a 0a20 2020 2020 2020  b gives..       
+00014540: 2023 736f 7320 3d20 7369 676e 616c 2e62   #sos = signal.b
+00014550: 7574 7465 7228 6f72 6465 722c 206e 6f72  utter(order, nor
+00014560: 6d61 6c5f 6375 746f 6666 2c20 6274 7970  mal_cutoff, btyp
+00014570: 653d 2768 6967 6870 6173 7327 2c20 616e  e='highpass', an
+00014580: 616c 6f67 3d46 616c 7365 2c20 6f75 7470  alog=False, outp
+00014590: 7574 3d27 736f 7327 2c20 6673 3d66 7329  ut='sos', fs=fs)
+000145a0: 0a20 2020 2020 2020 2023 736f 7332 203d  .        #sos2 =
+000145b0: 205b 5b31 2c20 2d32 2c20 312c 2031 2c20   [[1, -2, 1, 1, 
+000145c0: 2d31 2e39 3938 3738 3033 3735 3330 3230  -1.9987803753020
+000145d0: 3835 2c20 302e 3939 3837 3831 3131 3835  85, 0.9987811185
+000145e0: 3931 3135 395d 5d20 2023 2074 616b 656e  91159]]  # taken
+000145f0: 2066 726f 6d20 6d61 746c 6162 0a20 2020   from matlab.   
+00014600: 2020 2020 2023 7072 696e 7428 736f 7329       #print(sos)
+00014610: 0a0a 0a20 2020 2069 6620 6c69 6e65 5f6e  ...    if line_n
+00014620: 6f69 7365 5f72 656d 6f76 616c 2069 7320  oise_removal is 
+00014630: 6e6f 7420 4e6f 6e65 3a0a 0a20 2020 2020  not None:..     
+00014640: 2020 2023 2064 6573 6967 6e20 6120 6e6f     # design a no
+00014650: 7463 6820 6669 6c74 6572 2061 6e64 2067  tch filter and g
+00014660: 6574 2074 6865 2066 696c 7465 7220 636f  et the filter co
+00014670: 6566 6669 6369 656e 7473 2028 6e75 6d65  efficients (nume
+00014680: 7261 746f 7220 2f20 6465 6e6f 6d69 6e61  rator / denomina
+00014690: 746f 7220 28e2 8098 6261 e280 9929 0a20  tor (...ba...). 
+000146a0: 2020 2020 2020 206c 6e72 5f6e 756d 6572         lnr_numer
+000146b0: 6174 6f72 2c20 6c6e 725f 6465 6e6f 6d69  ator, lnr_denomi
+000146c0: 6e61 746f 7220 3d20 7369 676e 616c 2e69  nator = signal.i
+000146d0: 6972 6e6f 7463 6828 6c69 6e65 5f6e 6f69  irnotch(line_noi
+000146e0: 7365 5f72 656d 6f76 616c 2c20 3330 2e30  se_removal, 30.0
+000146f0: 2c20 6461 7461 5f72 6561 6465 722e 7361  , data_reader.sa
+00014700: 6d70 6c69 6e67 5f72 6174 6529 0a0a 0a20  mpling_rate)... 
+00014710: 2020 2023 0a20 2020 2023 2050 726f 6772     #.    # Progr
+00014720: 6573 7320 6261 7220 7375 6273 6372 6970  ess bar subscrip
+00014730: 740a 2020 2020 230a 0a20 2020 2064 6566  t.    #..    def
+00014740: 2075 7064 6174 655f 7072 6f67 7265 7373   update_progress
+00014750: 6261 7228 293a 0a0a 2020 2020 2020 2020  bar():..        
+00014760: 2320 7365 7420 686f 7720 6d75 6368 2065  # set how much e
+00014770: 6163 6820 7374 6570 2063 6f6e 7472 6962  ach step contrib
+00014780: 7574 6573 2074 6f20 7468 6520 746f 7461  utes to the tota
+00014790: 6c20 7072 6f67 7265 7373 0a20 2020 2020  l progress.     
+000147a0: 2020 2070 726f 705f 6561 726c 795f 636f     prop_early_co
+000147b0: 6c6c 6563 7465 6420 3d20 300a 2020 2020  llected = 0.    
+000147c0: 2020 2020 7072 6f70 5f6c 6174 655f 636f      prop_late_co
+000147d0: 6c6c 6563 7465 6420 3d20 300a 2020 2020  llected = 0.    
+000147e0: 2020 2020 6966 2065 6172 6c79 5f72 6572      if early_rer
+000147f0: 6566 2069 7320 4e6f 6e65 2061 6e64 206c  ef is None and l
+00014800: 6174 655f 7265 7265 6620 6973 204e 6f6e  ate_reref is Non
+00014810: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00014820: 726f 705f 6368 616e 6e65 6c5f 6570 6f63  rop_channel_epoc
+00014830: 6865 6420 3d20 310a 0a20 2020 2020 2020  hed = 1..       
+00014840: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014850: 2020 2070 726f 705f 6368 616e 6e65 6c5f     prop_channel_
+00014860: 6570 6f63 6865 6420 3d20 2e34 0a0a 2020  epoched = .4..  
+00014870: 2020 2020 2020 2020 2020 6966 2065 6172            if ear
+00014880: 6c79 5f72 6572 6566 2069 7320 6e6f 7420  ly_reref is not 
+00014890: 4e6f 6e65 2061 6e64 206c 6174 655f 7265  None and late_re
+000148a0: 7265 6620 6973 204e 6f6e 653a 0a20 2020  ref is None:.   
+000148b0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+000148c0: 705f 6561 726c 795f 636f 6c6c 6563 7465  p_early_collecte
+000148d0: 6420 3d20 2e36 0a0a 2020 2020 2020 2020  d = .6..        
+000148e0: 2020 2020 656c 6966 2065 6172 6c79 5f72      elif early_r
+000148f0: 6572 6566 2069 7320 4e6f 6e65 2061 6e64  eref is None and
+00014900: 206c 6174 655f 7265 7265 6620 6973 206e   late_reref is n
+00014910: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00014920: 2020 2020 2020 2020 2070 726f 705f 6c61           prop_la
+00014930: 7465 5f63 6f6c 6c65 6374 6564 203d 202e  te_collected = .
+00014940: 360a 0a20 2020 2020 2020 2020 2020 2065  6..            e
+00014950: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00014960: 2020 2020 2069 6620 7072 696f 7269 7479       if priority
+00014970: 203d 3d20 276d 656d 273a 0a20 2020 2020   == 'mem':.     
+00014980: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00014990: 726f 705f 6561 726c 795f 636f 6c6c 6563  rop_early_collec
+000149a0: 7465 6420 3d20 2e33 0a20 2020 2020 2020  ted = .3.       
+000149b0: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+000149c0: 705f 6c61 7465 5f63 6f6c 6c65 6374 6564  p_late_collected
+000149d0: 203d 202e 330a 2020 2020 2020 2020 2020   = .3.          
+000149e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000149f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a00: 7072 6f70 5f65 6172 6c79 5f63 6f6c 6c65  prop_early_colle
+00014a10: 6374 6564 203d 202e 350a 2020 2020 2020  cted = .5.      
+00014a20: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00014a30: 6f70 5f6c 6174 655f 636f 6c6c 6563 7465  op_late_collecte
+00014a40: 6420 3d20 2e31 0a0a 2020 2020 2020 2020  d = .1..        
+00014a50: 2320 7265 7472 6965 7665 2070 726f 706f  # retrieve propo
+00014a60: 7274 696f 6e73 0a20 2020 2020 2020 2070  rtions.        p
+00014a70: 726f 6772 6573 7369 6f6e 5f63 6861 6e6e  rogression_chann
+00014a80: 656c 5f65 706f 6368 6564 203d 2073 756d  el_epoched = sum
+00014a90: 2863 6861 6e6e 656c 5f65 706f 6368 6564  (channel_epoched
+00014aa0: 2e76 616c 7565 7328 2929 202f 206c 656e  .values()) / len
+00014ab0: 2863 6861 6e6e 656c 5f65 706f 6368 6564  (channel_epoched
+00014ac0: 290a 2020 2020 2020 2020 7072 6f67 7265  ).        progre
+00014ad0: 7373 696f 6e5f 6561 726c 795f 636f 6c6c  ssion_early_coll
+00014ae0: 6563 7465 6420 3d20 300a 2020 2020 2020  ected = 0.      
+00014af0: 2020 7072 6f67 7265 7373 696f 6e5f 6c61    progression_la
+00014b00: 7465 5f63 6f6c 6c65 6374 6564 203d 2030  te_collected = 0
+00014b10: 0a20 2020 2020 2020 2069 6620 6561 726c  .        if earl
+00014b20: 795f 7265 7265 6620 6973 206e 6f74 204e  y_reref is not N
+00014b30: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00014b40: 2070 726f 6772 6573 7369 6f6e 5f65 6172   progression_ear
+00014b50: 6c79 5f63 6f6c 6c65 6374 6564 203d 2073  ly_collected = s
+00014b60: 756d 285b 7375 6d28 762e 7661 6c75 6573  um([sum(v.values
+00014b70: 2829 2920 666f 7220 7620 696e 2065 6172  ()) for v in ear
+00014b80: 6c79 5f67 726f 7570 5f63 6861 6e6e 656c  ly_group_channel
+00014b90: 735f 636f 6c6c 6563 7465 642e 7661 6c75  s_collected.valu
+00014ba0: 6573 2829 5d29 202f 2073 756d 285b 6c65  es()]) / sum([le
+00014bb0: 6e28 7629 2066 6f72 2076 2069 6e20 6561  n(v) for v in ea
+00014bc0: 726c 795f 6772 6f75 705f 6368 616e 6e65  rly_group_channe
+00014bd0: 6c73 5f63 6f6c 6c65 6374 6564 2e76 616c  ls_collected.val
+00014be0: 7565 7328 295d 290a 2020 2020 2020 2020  ues()]).        
+00014bf0: 6966 206c 6174 655f 7265 7265 6620 6973  if late_reref is
+00014c00: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00014c10: 2020 2020 2020 2070 726f 6772 6573 7369         progressi
+00014c20: 6f6e 5f6c 6174 655f 636f 6c6c 6563 7465  on_late_collecte
+00014c30: 6420 3d20 7375 6d28 5b73 756d 2876 2e76  d = sum([sum(v.v
+00014c40: 616c 7565 7328 2929 2066 6f72 2076 2069  alues()) for v i
+00014c50: 6e20 6c61 7465 5f67 726f 7570 5f63 6861  n late_group_cha
+00014c60: 6e6e 656c 735f 636f 6c6c 6563 7465 642e  nnels_collected.
+00014c70: 7661 6c75 6573 2829 5d29 202f 2073 756d  values()]) / sum
+00014c80: 285b 6c65 6e28 7629 2066 6f72 2076 2069  ([len(v) for v i
+00014c90: 6e20 6c61 7465 5f67 726f 7570 5f63 6861  n late_group_cha
+00014ca0: 6e6e 656c 735f 636f 6c6c 6563 7465 642e  nnels_collected.
+00014cb0: 7661 6c75 6573 2829 5d29 0a0a 2020 2020  values()])..    
+00014cc0: 2020 2020 2320 7570 6461 7465 2074 6865      # update the
+00014cd0: 2070 726f 6772 6573 7320 6261 720a 2020   progress bar.  
+00014ce0: 2020 2020 2020 7072 6f70 203d 2070 726f        prop = pro
+00014cf0: 705f 6368 616e 6e65 6c5f 6570 6f63 6865  p_channel_epoche
+00014d00: 6420 2a20 7072 6f67 7265 7373 696f 6e5f  d * progression_
+00014d10: 6368 616e 6e65 6c5f 6570 6f63 6865 6420  channel_epoched 
+00014d20: 2b20 7072 6f70 5f65 6172 6c79 5f63 6f6c  + prop_early_col
+00014d30: 6c65 6374 6564 202a 2070 726f 6772 6573  lected * progres
+00014d40: 7369 6f6e 5f65 6172 6c79 5f63 6f6c 6c65  sion_early_colle
+00014d50: 6374 6564 202b 2070 726f 705f 6c61 7465  cted + prop_late
+00014d60: 5f63 6f6c 6c65 6374 6564 202a 2070 726f  _collected * pro
+00014d70: 6772 6573 7369 6f6e 5f6c 6174 655f 636f  gression_late_co
+00014d80: 6c6c 6563 7465 640a 2020 2020 2020 2020  llected.        
+00014d90: 7072 696e 745f 7072 6f67 7265 7373 6261  print_progressba
+00014da0: 7228 7072 6f70 2c20 312c 2070 7265 6669  r(prop, 1, prefi
+00014db0: 783d 2750 726f 6772 6573 733a 272c 2073  x='Progress:', s
+00014dc0: 7566 6669 783d 2743 6f6d 706c 6574 6527  uffix='Complete'
+00014dd0: 2c20 6c65 6e67 7468 3d35 3029 0a0a 2020  , length=50)..  
+00014de0: 2020 2320 6372 6561 7465 2070 726f 6772    # create progr
+00014df0: 6573 7320 6261 720a 2020 2020 7570 6461  ess bar.    upda
+00014e00: 7465 5f70 726f 6772 6573 7362 6172 2829  te_progressbar()
+00014e10: 0a0a 0a20 2020 2023 0a20 2020 2023 2050  ...    #.    # P
+00014e20: 726f 6365 7373 0a20 2020 2023 0a0a 2020  rocess.    #..  
+00014e30: 2020 2320 756e 7469 6c20 616c 6c20 6368    # until all ch
+00014e40: 616e 6e65 6c73 2061 7265 2065 706f 6368  annels are epoch
+00014e50: 2d65 6420 2866 756c 6c79 2070 726f 6365  -ed (fully proce
+00014e60: 7373 6564 290a 2020 2020 7768 696c 6520  ssed).    while 
+00014e70: 6e6f 7420 616c 6c28 6368 616e 6e65 6c5f  not all(channel_
+00014e80: 6570 6f63 6865 642e 7661 6c75 6573 2829  epoched.values()
+00014e90: 293a 0a0a 2020 2020 2020 2020 2320 6c6f  ):..        # lo
+00014ea0: 6f70 206f 7665 7220 616c 6c20 7468 6520  op over all the 
+00014eb0: 7265 7175 6972 6564 2063 6861 6e6e 656c  required channel
+00014ec0: 730a 2020 2020 2020 2020 2320 4e6f 7465  s.        # Note
+00014ed0: 3a20 706f 7465 6e74 6961 6c6c 7920 6576  : potentially ev
+00014ee0: 656e 206f 7665 7220 7468 6520 6f6e 6573  en over the ones
+00014ef0: 2074 6861 7420 646f 206e 6f74 206e 6565   that do not nee
+00014f00: 6420 746f 2062 6520 7265 7472 6965 7665  d to be retrieve
+00014f10: 6420 6275 7420 6172 6520 7374 696c 6c20  d but are still 
+00014f20: 6e65 6564 6564 2066 6f72 2072 652d 7265  needed for re-re
+00014f30: 6665 7265 6e63 696e 670a 2020 2020 2020  ferencing.      
+00014f40: 2020 666f 7220 6368 616e 6e65 6c20 696e    for channel in
+00014f50: 2061 6c6c 5f63 6861 6e6e 656c 733a 0a0a   all_channels:..
+00014f60: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
+00014f70: 6563 6b20 6966 2077 6520 6e65 6564 2074  eck if we need t
+00014f80: 6869 7320 6368 616e 6e65 6c2c 2077 6869  his channel, whi
+00014f90: 6368 2069 7320 7468 6520 6361 7365 2077  ch is the case w
+00014fa0: 6865 6e3a 0a20 2020 2020 2020 2020 2020  hen:.           
+00014fb0: 2023 2020 202d 2069 7420 7374 696c 6c20   #   - it still 
+00014fc0: 6e65 6564 7320 746f 2062 6520 6570 6f63  needs to be epoc
+00014fd0: 682d 6564 0a20 2020 2020 2020 2020 2020  h-ed.           
+00014fe0: 2023 2020 202d 2077 6865 6e20 6974 2069   #   - when it i
+00014ff0: 7320 6e65 6564 6564 2066 6f72 2065 6172  s needed for ear
+00015000: 6c79 2072 652d 7265 6620 6275 7420 6e6f  ly re-ref but no
+00015010: 7420 636f 6c6c 6563 7465 640a 2020 2020  t collected.    
+00015020: 2020 2020 2020 2020 2320 2020 2d20 7768          #   - wh
+00015030: 656e 2069 7420 6973 206e 6565 6465 6420  en it is needed 
+00015040: 666f 7220 6c61 7465 2072 652d 7265 6620  for late re-ref 
+00015050: 6275 7420 6e6f 7420 636f 6c6c 6563 7465  but not collecte
+00015060: 640a 2020 2020 2020 2020 2020 2020 6966  d.            if
+00015070: 2028 6368 616e 6e65 6c20 696e 2063 6861   (channel in cha
+00015080: 6e6e 656c 5f65 706f 6368 6564 2e6b 6579  nnel_epoched.key
+00015090: 7328 2920 616e 6420 6e6f 7420 6368 616e  s() and not chan
+000150a0: 6e65 6c5f 6570 6f63 6865 645b 6368 616e  nel_epoched[chan
+000150b0: 6e65 6c5d 2920 6f72 205c 0a20 2020 2020  nel]) or \.     
+000150c0: 2020 2020 2020 2020 2020 2865 6172 6c79            (early
+000150d0: 5f72 6572 6566 2069 7320 6e6f 7420 4e6f  _reref is not No
+000150e0: 6e65 2061 6e64 2063 6861 6e6e 656c 2069  ne and channel i
+000150f0: 6e20 6561 726c 795f 7265 715f 6368 616e  n early_req_chan
+00015100: 6e65 6c73 2061 6e64 206e 6f74 2063 6861  nels and not cha
+00015110: 6e6e 656c 5f65 6172 6c79 5f72 6572 6566  nnel_early_reref
+00015120: 5f63 6f6c 6c65 6374 6564 5b63 6861 6e6e  _collected[chann
+00015130: 656c 5d29 206f 7220 5c0a 2020 2020 2020  el]) or \.      
+00015140: 2020 2020 2020 2020 2028 6c61 7465 5f72           (late_r
+00015150: 6572 6566 2069 7320 6e6f 7420 4e6f 6e65  eref is not None
+00015160: 2061 6e64 2063 6861 6e6e 656c 2069 6e20   and channel in 
+00015170: 6c61 7465 5f72 6571 5f63 6861 6e6e 656c  late_req_channel
+00015180: 7320 616e 6420 6e6f 7420 6368 616e 6e65  s and not channe
+00015190: 6c5f 6c61 7465 5f72 6572 6566 5f63 6f6c  l_late_reref_col
+000151a0: 6c65 6374 6564 5b63 6861 6e6e 656c 5d29  lected[channel])
+000151b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000151c0: 2020 2320 6e65 6564 6564 2c20 7072 6f63    # needed, proc
+000151d0: 6573 7320 6368 616e 6e65 6c0a 0a20 2020  ess channel..   
+000151e0: 2020 2020 2020 2020 2020 2020 2023 2063               # c
+000151f0: 6865 636b 2069 6620 6368 616e 6e65 6c20  heck if channel 
+00015200: 6461 7461 2069 7320 6176 6169 6c61 626c  data is availabl
+00015210: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00015220: 2020 2320 4e6f 7465 3a20 6475 7269 6e67    # Note: during
+00015230: 2073 7065 6564 206f 7074 696f 6e20 7468   speed option th
+00015240: 6520 6368 616e 6e65 6c20 6461 7461 2069  e channel data i
+00015250: 7320 6b65 7074 2069 6e20 6d65 6d6f 7279  s kept in memory
+00015260: 2c20 736f 206e 6f20 7265 6c6f 6164 696e  , so no reloadin
+00015270: 6720 6973 2072 6571 7569 7265 6420 7768  g is required wh
+00015280: 656e 2073 7469 6c6c 2069 6e20 6d65 6d6f  en still in memo
+00015290: 7279 0a20 2020 2020 2020 2020 2020 2020  ry.             
+000152a0: 2020 2069 6620 6368 616e 6e65 6c5f 6461     if channel_da
+000152b0: 7461 5b63 6861 6e6e 656c 5d20 6973 204e  ta[channel] is N
+000152c0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000152d0: 2020 2020 2020 2020 2023 7072 696e 7428           #print(
+000152e0: 6368 616e 6e65 6c20 2b20 223a 206c 6f61  channel + ": loa
+000152f0: 6422 290a 0a20 2020 2020 2020 2020 2020  d")..           
+00015300: 2020 2020 2020 2020 2023 2072 6574 7269           # retri
+00015310: 6576 6520 7468 6520 6368 616e 6e65 6c20  eve the channel 
+00015320: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+00015330: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
+00015340: 2063 6f6e 7369 6465 7220 6461 7461 2074   consider data t
+00015350: 7970 650a 2020 2020 2020 2020 2020 2020  ype.            
+00015360: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00015370: 2d20 5079 4d45 4620 7769 6c6c 2061 6c77  - PyMEF will alw
+00015380: 6179 7320 7265 7475 726e 2066 6c6f 6174  ays return float
+00015390: 3634 0a20 2020 2020 2020 2020 2020 2020  64.             
+000153a0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+000153b0: 2028 6f72 6967 696e 616c 2064 6174 6120   (original data 
+000153c0: 666f 726d 6174 2069 7320 3332 2d62 6974  format is 32-bit
+000153d0: 2069 6e74 6567 6572 2c20 6275 7420 6f75   integer, but ou
+000153e0: 7470 7574 7469 6e67 2066 6c6f 6174 3634  tputting float64
+000153f0: 2061 6c6c 6f77 7320 4e61 4e73 2066 6f72   allows NaNs for
+00015400: 2064 6973 636f 6e74 696e 7569 7469 6573   discontinuities
+00015410: 2069 6e20 7468 6520 7469 6d65 2d73 6572   in the time-ser
+00015420: 6965 7320 616e 6420 7374 696c 6c20 7265  ies and still re
+00015430: 7461 696e 7320 3533 2d62 6974 2073 6967  tains 53-bit sig
+00015440: 6e69 6669 6361 6e64 2070 7265 6369 7369  nificand precisi
+00015450: 6f6e 2074 6f20 686f 6c64 2074 6865 2065  on to hold the e
+00015460: 7861 6374 2033 322d 6269 7420 7661 6c75  xact 32-bit valu
+00015470: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00015480: 2020 2020 2020 2023 2020 2020 2020 202d         #       -
+00015490: 2042 7261 696e 7669 7369 6f6e 2063 616e   Brainvision can
+000154a0: 2062 6520 3136 2d62 6974 2069 6e74 6567   be 16-bit integ
+000154b0: 6572 2c20 3332 2d62 6974 2069 6e74 6567  er, 32-bit integ
+000154c0: 6572 206f 7220 3332 2d62 6974 2066 6c6f  er or 32-bit flo
+000154d0: 6174 2e20 486f 7765 7665 722c 2074 6865  at. However, the
+000154e0: 2072 6573 6f6c 7574 696f 6e20 696e 2074   resolution in t
+000154f0: 6865 2063 6861 6e6e 656c 2061 6374 7320  he channel acts 
+00015500: 6173 206d 756c 7469 706c 6963 6174 696f  as multiplicatio
+00015510: 6e20 6661 6374 6f72 0a20 2020 2020 2020  n factor.       
+00015520: 2020 2020 2020 2020 2020 2020 2023 2020               #  
+00015530: 2020 2020 2020 2041 7320 7375 6368 2c20         As such, 
+00015540: 6966 2074 6865 206d 756c 7469 706c 6963  if the multiplic
+00015550: 6174 696f 6e20 6661 6374 6f72 2069 7320  ation factor is 
+00015560: 3120 286f 7220 656d 7074 7929 2074 6865  1 (or empty) the
+00015570: 6e20 7468 6520 6f75 7470 7574 2077 696c  n the output wil
+00015580: 6c20 616c 7761 7973 2062 6520 696e 2033  l always be in 3
+00015590: 322d 6269 7420 666c 6f61 7473 2028 6e6f  2-bit floats (no
+000155a0: 7420 3634 2d62 6974 2074 6f20 7361 7665  t 64-bit to save
+000155b0: 206d 656d 6f72 7929 2e0a 2020 2020 2020   memory)..      
+000155c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000155d0: 2020 2020 2020 2020 486f 7765 7665 722c          However,
+000155e0: 2069 6620 6120 6d75 6c74 6970 6c69 6361   if a multiplica
+000155f0: 7469 6f6e 2066 6163 746f 720a 2020 2020  tion factor.    
+00015600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015610: 2320 4e6f 7465 3a20 656e 7375 7265 2069  # Note: ensure i
+00015620: 7420 6973 206e 6f74 2061 2076 6965 772c  t is not a view,
+00015630: 2065 6c73 6577 6973 6520 6d61 6e69 7075   elsewise manipu
+00015640: 6c61 7469 6f6e 7320 6675 7274 6865 7220  lations further 
+00015650: 6f6e 206d 6967 6874 2061 646a 7573 7420  on might adjust 
+00015660: 7468 6520 736f 7572 6365 2064 6174 610a  the source data.
+00015670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015680: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00015690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000156a0: 2063 6861 6e6e 656c 5f64 6174 615b 6368   channel_data[ch
+000156b0: 616e 6e65 6c5d 203d 2064 6174 615f 7265  annel] = data_re
+000156c0: 6164 6572 2e72 6574 7269 6576 655f 6368  ader.retrieve_ch
+000156d0: 616e 6e65 6c5f 6461 7461 2863 6861 6e6e  annel_data(chann
+000156e0: 656c 2c20 5472 7565 290a 2020 2020 2020  el, True).      
+000156f0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00015700: 6365 7074 2052 756e 7469 6d65 4572 726f  cept RuntimeErro
+00015710: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00015720: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00015730: 2052 756e 7469 6d65 4572 726f 7228 2745   RuntimeError('E
+00015740: 7272 6f72 2075 706f 6e20 7265 7472 6965  rror upon retrie
+00015750: 7669 6e67 2064 6174 6127 290a 0a20 2020  ving data')..   
+00015760: 2020 2020 2020 2020 2020 2020 2023 0a20               #. 
+00015770: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00015780: 2048 6967 682d 7061 7373 2066 696c 7465   High-pass filte
+00015790: 7269 6e67 0a20 2020 2020 2020 2020 2020  ring.           
+000157a0: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
+000157b0: 2020 2020 2020 2069 6620 6869 6768 5f70         if high_p
+000157c0: 6173 7320 616e 6420 6e6f 7420 6368 616e  ass and not chan
+000157d0: 6e65 6c5f 6870 5f61 7070 6c69 6564 5b63  nel_hp_applied[c
+000157e0: 6861 6e6e 656c 5d3a 0a20 2020 2020 2020  hannel]:.       
+000157f0: 2020 2020 2020 2020 2020 2020 2023 7072               #pr
+00015800: 696e 7428 6368 616e 6e65 6c20 2b20 223a  int(channel + ":
+00015810: 2048 5022 290a 0a20 2020 2020 2020 2020   HP")..         
+00015820: 2020 2020 2020 2020 2020 2023 2046 696c             # Fil
+00015830: 7465 7220 7468 6520 6461 7461 0a20 2020  ter the data.   
+00015840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015850: 2063 6861 6e6e 656c 5f64 6174 615b 6368   channel_data[ch
+00015860: 616e 6e65 6c5d 203d 2073 6967 6e61 6c2e  annel] = signal.
+00015870: 6669 6c74 6669 6c74 2868 705f 6e75 6d65  filtfilt(hp_nume
+00015880: 7261 746f 722c 2068 705f 6465 6e6f 6d69  rator, hp_denomi
+00015890: 6e61 746f 722c 2063 6861 6e6e 656c 5f64  nator, channel_d
+000158a0: 6174 615b 6368 616e 6e65 6c5d 2c20 7061  ata[channel], pa
+000158b0: 6474 7970 653d 276f 6464 272c 2070 6164  dtype='odd', pad
+000158c0: 6c65 6e3d 3320 2a20 286d 6178 286c 656e  len=3 * (max(len
+000158d0: 2868 705f 6e75 6d65 7261 746f 7229 2c20  (hp_numerator), 
+000158e0: 6c65 6e28 6870 5f64 656e 6f6d 696e 6174  len(hp_denominat
+000158f0: 6f72 2929 202d 2031 2929 0a0a 2020 2020  or)) - 1))..    
+00015900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015910: 2320 544f 444f 3a20 6d6f 7265 2065 7861  # TODO: more exa
+00015920: 6374 2074 7261 6e73 6c61 7469 6f6e 2066  ct translation f
+00015930: 726f 6d20 6d61 746c 6162 0a20 2020 2020  rom matlab.     
+00015940: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00015950: 2020 2020 2020 2073 6f73 6669 6c74 6669         sosfiltfi
+00015960: 6c74 2028 736f 2077 6974 6820 736f 7329  lt (so with sos)
+00015970: 2072 6574 7572 6e73 2064 6966 6665 7265   returns differe
+00015980: 6e74 2076 616c 7565 7320 6f6e 2074 6865  nt values on the
+00015990: 2073 616d 6520 6461 7461 0a20 2020 2020   same data.     
 000159a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000159b0: 7079 7468 6f6e 2070 6164 6c65 6e67 7468  python padlength
-000159c0: 203d 2033 202a 2028 3220 2a20 6c65 6e28   = 3 * (2 * len(
-000159d0: 736f 7329 202b 2031 202d 206d 696e 2828  sos) + 1 - min((
-000159e0: 736f 735b 3a2c 2032 5d20 3d3d 2030 292e  sos[:, 2] == 0).
-000159f0: 7375 6d28 292c 2028 736f 735b 3a2c 2035  sum(), (sos[:, 5
-00015a00: 5d20 3d3d 2030 292e 7375 6d28 2929 290a  ] == 0).sum())).
-00015a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015a20: 2020 2020 2370 7269 6e74 2879 5b31 3a31      #print(y[1:1
-00015a30: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
-00015a40: 2020 2020 2020 2020 2370 7269 6e74 2879          #print(y
-00015a50: 325b 313a 3130 5d29 0a0a 2020 2020 2020  2[1:10])..      
-00015a60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00015a70: 7365 7420 6869 6768 2070 6173 7369 6e67  set high passing
-00015a80: 2061 7320 746f 2062 6565 6e20 6170 706c   as to been appl
-00015a90: 6965 6420 746f 2074 6865 2063 6861 6e6e  ied to the chann
-00015aa0: 656c 2d64 6174 6120 696e 206d 656d 6f72  el-data in memor
-00015ab0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-00015ac0: 2020 2020 2020 6368 616e 6e65 6c5f 6870        channel_hp
-00015ad0: 5f61 7070 6c69 6564 5b63 6861 6e6e 656c  _applied[channel
-00015ae0: 5d20 3d20 5472 7565 0a0a 2020 2020 2020  ] = True..      
-00015af0: 2020 2020 2020 2020 2020 2320 6368 6563            # chec
-00015b00: 6b20 6966 2076 6172 6961 6e63 6520 6e65  k if variance ne
-00015b10: 6564 7320 746f 2062 6520 6b6e 6f77 2062  eds to be know b
-00015b20: 6566 6f72 6520 6561 726c 7920 7265 2d72  efore early re-r
-00015b30: 6566 6572 656e 6369 6e67 0a20 2020 2020  eferencing.     
-00015b40: 2020 2020 2020 2020 2020 2023 2069 6e20             # in 
-00015b50: 7468 6520 7369 7475 6174 696f 6e20 6f66  the situation of
-00015b60: 2072 6572 6566 2077 6869 6c65 2074 616b   reref while tak
-00015b70: 696e 6720 696e 746f 2061 6363 6f75 6e74  ing into account
-00015b80: 2069 7427 7320 7661 7269 6174 696f 6e0a   it's variation.
-00015b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ba0: 2320 202d 2069 6620 6170 706c 6965 6420  #  - if applied 
-00015bb0: 6f6e 2065 6172 6c79 2072 652d 7265 662c  on early re-ref,
-00015bc0: 2074 6865 7265 2069 7320 6e6f 206f 7468   there is no oth
-00015bd0: 6572 206f 7074 696f 6e20 6275 7420 6c6f  er option but lo
-00015be0: 6164 2074 6865 2063 6861 6e6e 656c 2062  ad the channel b
-00015bf0: 6566 6f72 650a 2020 2020 2020 2020 2020  efore.          
-00015c00: 2020 2020 2020 2320 2069 660a 0a0a 2020        #  if...  
-00015c10: 2020 2020 2020 2020 2020 2020 2020 230a                #.
-00015c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c30: 2320 4561 726c 7920 7265 2d72 6566 6572  # Early re-refer
-00015c40: 656e 6369 6e67 0a20 2020 2020 2020 2020  encing.         
-00015c50: 2020 2020 2020 2023 0a0a 2020 2020 2020         #..      
-00015c60: 2020 2020 2020 2020 2020 2320 6368 6563            # chec
-00015c70: 6b20 6966 2065 6172 6c79 2072 652d 7265  k if early re-re
-00015c80: 6665 7265 6e63 696e 6720 6e65 6564 6564  ferencing needed
-00015c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ca0: 2069 6620 6561 726c 795f 7265 7265 6620   if early_reref 
-00015cb0: 6973 206e 6f74 204e 6f6e 653a 0a0a 2020  is not None:..  
-00015cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015cd0: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
-00015ce0: 2020 2020 2020 2020 2320 4561 726c 7920          # Early 
-00015cf0: 7265 2d72 6566 6572 656e 6369 6e67 2063  re-referencing c
-00015d00: 6f6c 6c65 6374 0a20 2020 2020 2020 2020  ollect.         
-00015d10: 2020 2020 2020 2020 2020 2023 0a0a 2020             #..  
-00015d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d30: 2020 2320 6368 6563 6b20 6966 2074 6865    # check if the
-00015d40: 2064 6174 6120 6f66 2074 6869 7320 6368   data of this ch
-00015d50: 616e 6e65 6c20 2861 7420 7468 6973 2070  annel (at this p
-00015d60: 6f69 6e74 2920 6973 2061 6c72 6561 6479  oint) is already
-00015d70: 2063 6f6c 6c65 6374 6564 2066 6f72 2074   collected for t
-00015d80: 6865 2065 6172 6c79 2072 652d 7265 6665  he early re-refe
-00015d90: 7265 6e63 6520 6772 6f75 7073 0a20 2020  rence groups.   
-00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015db0: 2069 6620 6e6f 7420 6368 616e 6e65 6c5f   if not channel_
-00015dc0: 6561 726c 795f 7265 7265 665f 636f 6c6c  early_reref_coll
-00015dd0: 6563 7465 645b 6368 616e 6e65 6c5d 3a0a  ected[channel]:.
-00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015df0: 2020 2020 2020 2020 2320 6561 726c 7920          # early 
-00015e00: 6e6f 7420 636f 6c6c 6563 7465 640a 2020  not collected.  
-00015e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e20: 2020 2020 2020 2370 7269 6e74 2863 6861        #print(cha
-00015e30: 6e6e 656c 202b 2022 3a20 436f 6c6c 6563  nnel + ": Collec
-00015e40: 7469 6e67 2065 6172 6c79 2072 6572 6566  ting early reref
-00015e50: 2076 616c 7565 7320 6672 6f6d 2063 6861   values from cha
-00015e60: 6e6e 656c 2229 0a0a 2020 2020 2020 2020  nnel")..        
-00015e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e80: 2320 6c6f 6f70 206f 7665 7220 7468 6520  # loop over the 
-00015e90: 6561 726c 792d 7265 7265 6620 6772 6f75  early-reref grou
-00015ea0: 7073 0a20 2020 2020 2020 2020 2020 2020  ps.             
-00015eb0: 2020 2020 2020 2020 2020 2066 6f72 2067             for g
-00015ec0: 726f 7570 2069 6e20 6561 726c 795f 7265  roup in early_re
-00015ed0: 715f 6772 6f75 7073 3a0a 0a20 2020 2020  q_groups:..     
-00015ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ef0: 2020 2020 2020 2023 2063 6865 636b 2069         # check i
-00015f00: 6620 7468 6973 2067 726f 7570 2072 6571  f this group req
-00015f10: 7569 7265 7320 7468 6973 2063 6861 6e6e  uires this chann
-00015f20: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
-00015f30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00015f40: 6620 6368 616e 6e65 6c20 696e 2065 6172  f channel in ear
-00015f50: 6c79 5f67 726f 7570 5f63 6861 6e6e 656c  ly_group_channel
-00015f60: 735f 636f 6c6c 6563 7465 645b 7374 7228  s_collected[str(
-00015f70: 6772 6f75 7029 5d2e 6b65 7973 2829 3a0a  group)].keys():.
-00015f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015fa0: 2023 2063 7265 6174 6520 6172 7261 7973   # create arrays
-00015fb0: 2074 6f20 686f 6c64 2074 6865 2067 726f   to hold the gro
-00015fc0: 7570 2064 6174 6120 6966 206e 6f74 2079  up data if not y
-00015fd0: 6574 2069 6e69 7469 616c 697a 6564 0a20  et initialized. 
-00015fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015ff0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00016000: 6620 6561 726c 795f 6772 6f75 705f 6461  f early_group_da
-00016010: 7461 5b73 7472 2867 726f 7570 295d 2069  ta[str(group)] i
-00016020: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00016030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016040: 2020 2020 2020 2020 2020 2020 6561 726c              earl
-00016050: 795f 6772 6f75 705f 6461 7461 5b73 7472  y_group_data[str
-00016060: 2867 726f 7570 295d 203d 206e 702e 7a65  (group)] = np.ze
-00016070: 726f 7328 286c 656e 2863 6861 6e6e 656c  ros((len(channel
-00016080: 5f64 6174 615b 6368 616e 6e65 6c5d 292c  _data[channel]),
-00016090: 292c 2064 7479 7065 3d6e 702e 666c 6f61  ), dtype=np.floa
-000160a0: 7436 3429 0a20 2020 2020 2020 2020 2020  t64).           
-000160b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160c0: 2020 2020 2020 2020 2069 6620 6561 726c           if earl
-000160d0: 795f 7265 7265 662e 6368 616e 6e65 6c5f  y_reref.channel_
-000160e0: 6578 636c 7564 655f 6570 6f63 6873 2069  exclude_epochs i
-000160f0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00016100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016120: 2020 2020 6561 726c 795f 6772 6f75 705f      early_group_
-00016130: 6e75 6d64 6174 615b 7374 7228 6772 6f75  numdata[str(grou
-00016140: 7029 5d20 3d20 6e70 2e7a 6572 6f73 2828  p)] = np.zeros((
-00016150: 6c65 6e28 6368 616e 6e65 6c5f 6461 7461  len(channel_data
-00016160: 5b63 6861 6e6e 656c 5d29 2c29 2c20 6474  [channel]),), dt
-00016170: 7970 653d 6e70 2e75 696e 7431 3629 0a0a  ype=np.uint16)..
+000159b0: 7920 3d20 7369 676e 616c 2e66 696c 7466  y = signal.filtf
+000159c0: 696c 7428 736f 732c 2067 6169 6e2c 2063  ilt(sos, gain, c
+000159d0: 6861 6e6e 656c 5f64 6174 615b 6368 616e  hannel_data[chan
+000159e0: 6e65 6c5d 290a 2020 2020 2020 2020 2020  nel]).          
+000159f0: 2020 2020 2020 2020 2020 2379 203d 2073            #y = s
+00015a00: 6967 6e61 6c2e 6669 6c74 6669 6c74 2868  ignal.filtfilt(h
+00015a10: 705f 6e75 6d65 7261 746f 722c 2068 705f  p_numerator, hp_
+00015a20: 6465 6e6f 6d69 6e61 746f 722c 2063 6861  denominator, cha
+00015a30: 6e6e 656c 5f64 6174 615b 6368 616e 6e65  nnel_data[channe
+00015a40: 6c5d 290a 2020 2020 2020 2020 2020 2020  l]).            
+00015a50: 2020 2020 2020 2020 2379 203d 2073 6967          #y = sig
+00015a60: 6e61 6c2e 6669 6c74 6669 6c74 2868 705f  nal.filtfilt(hp_
+00015a70: 6e75 6d65 7261 746f 722c 2068 705f 6465  numerator, hp_de
+00015a80: 6e6f 6d69 6e61 746f 722c 2063 6861 6e6e  nominator, chann
+00015a90: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
+00015aa0: 2c20 7061 6474 7970 653d 276f 6464 272c  , padtype='odd',
+00015ab0: 2070 6164 6c65 6e3d 3320 2a20 286d 6178   padlen=3 * (max
+00015ac0: 286c 656e 2862 292c 206c 656e 2861 2929  (len(b), len(a))
+00015ad0: 202d 2031 2929 0a20 2020 2020 2020 2020   - 1)).         
+00015ae0: 2020 2020 2020 2020 2020 2023 7932 203d             #y2 =
+00015af0: 2073 6967 6e61 6c2e 736f 7366 696c 7466   signal.sosfiltf
+00015b00: 696c 7428 736f 7332 2c20 6368 616e 6e65  ilt(sos2, channe
+00015b10: 6c5f 6461 7461 5b63 6861 6e6e 656c 5d2c  l_data[channel],
+00015b20: 2070 6164 7479 7065 3d4e 6f6e 6529 0a20   padtype=None). 
+00015b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015b40: 2020 2023 7079 7468 6f6e 2070 6164 6c65     #python padle
+00015b50: 6e67 7468 203d 2033 202a 2028 3220 2a20  ngth = 3 * (2 * 
+00015b60: 6c65 6e28 736f 7329 202b 2031 202d 206d  len(sos) + 1 - m
+00015b70: 696e 2828 736f 735b 3a2c 2032 5d20 3d3d  in((sos[:, 2] ==
+00015b80: 2030 292e 7375 6d28 292c 2028 736f 735b   0).sum(), (sos[
+00015b90: 3a2c 2035 5d20 3d3d 2030 292e 7375 6d28  :, 5] == 0).sum(
+00015ba0: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
+00015bb0: 2020 2020 2020 2020 2370 7269 6e74 2879          #print(y
+00015bc0: 5b31 3a31 305d 290a 2020 2020 2020 2020  [1:10]).        
+00015bd0: 2020 2020 2020 2020 2020 2020 2370 7269              #pri
+00015be0: 6e74 2879 325b 313a 3130 5d29 0a0a 2020  nt(y2[1:10])..  
+00015bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c00: 2020 2320 7365 7420 6869 6768 2070 6173    # set high pas
+00015c10: 7369 6e67 2061 7320 746f 2062 6565 6e20  sing as to been 
+00015c20: 6170 706c 6965 6420 746f 2074 6865 2063  applied to the c
+00015c30: 6861 6e6e 656c 2d64 6174 6120 696e 206d  hannel-data in m
+00015c40: 656d 6f72 790a 2020 2020 2020 2020 2020  emory.          
+00015c50: 2020 2020 2020 2020 2020 6368 616e 6e65            channe
+00015c60: 6c5f 6870 5f61 7070 6c69 6564 5b63 6861  l_hp_applied[cha
+00015c70: 6e6e 656c 5d20 3d20 5472 7565 0a0a 2020  nnel] = True..  
+00015c80: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00015c90: 6368 6563 6b20 6966 2076 6172 6961 6e63  check if varianc
+00015ca0: 6520 6e65 6564 7320 746f 2062 6520 6b6e  e needs to be kn
+00015cb0: 6f77 2062 6566 6f72 6520 6561 726c 7920  ow before early 
+00015cc0: 7265 2d72 6566 6572 656e 6369 6e67 0a20  re-referencing. 
+00015cd0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00015ce0: 2069 6e20 7468 6520 7369 7475 6174 696f   in the situatio
+00015cf0: 6e20 6f66 2072 6572 6566 2077 6869 6c65  n of reref while
+00015d00: 2074 616b 696e 6720 696e 746f 2061 6363   taking into acc
+00015d10: 6f75 6e74 2069 7427 7320 7661 7269 6174  ount it's variat
+00015d20: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+00015d30: 2020 2020 2320 202d 2069 6620 6170 706c      #  - if appl
+00015d40: 6965 6420 6f6e 2065 6172 6c79 2072 652d  ied on early re-
+00015d50: 7265 662c 2074 6865 7265 2069 7320 6e6f  ref, there is no
+00015d60: 206f 7468 6572 206f 7074 696f 6e20 6275   other option bu
+00015d70: 7420 6c6f 6164 2074 6865 2063 6861 6e6e  t load the chann
+00015d80: 656c 2062 6566 6f72 650a 2020 2020 2020  el before.      
+00015d90: 2020 2020 2020 2020 2020 2320 2069 660a            #  if.
+00015da0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00015db0: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
+00015dc0: 2020 2020 2320 4561 726c 7920 7265 2d72      # Early re-r
+00015dd0: 6566 6572 656e 6369 6e67 0a20 2020 2020  eferencing.     
+00015de0: 2020 2020 2020 2020 2020 2023 0a0a 2020             #..  
+00015df0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00015e00: 6368 6563 6b20 6966 2065 6172 6c79 2072  check if early r
+00015e10: 652d 7265 6665 7265 6e63 696e 6720 6e65  e-referencing ne
+00015e20: 6564 6564 0a20 2020 2020 2020 2020 2020  eded.           
+00015e30: 2020 2020 2069 6620 6561 726c 795f 7265       if early_re
+00015e40: 7265 6620 6973 206e 6f74 204e 6f6e 653a  ref is not None:
+00015e50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00015e60: 2020 2020 2020 230a 2020 2020 2020 2020        #.        
+00015e70: 2020 2020 2020 2020 2020 2020 2320 4561              # Ea
+00015e80: 726c 7920 7265 2d72 6566 6572 656e 6369  rly re-referenci
+00015e90: 6e67 2063 6f6c 6c65 6374 0a20 2020 2020  ng collect.     
+00015ea0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00015eb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00015ec0: 2020 2020 2020 2320 6368 6563 6b20 6966        # check if
+00015ed0: 2074 6865 2064 6174 6120 6f66 2074 6869   the data of thi
+00015ee0: 7320 6368 616e 6e65 6c20 2861 7420 7468  s channel (at th
+00015ef0: 6973 2070 6f69 6e74 2920 6973 2061 6c72  is point) is alr
+00015f00: 6561 6479 2063 6f6c 6c65 6374 6564 2066  eady collected f
+00015f10: 6f72 2074 6865 2065 6172 6c79 2072 652d  or the early re-
+00015f20: 7265 6665 7265 6e63 6520 6772 6f75 7073  reference groups
+00015f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015f40: 2020 2020 2069 6620 6e6f 7420 6368 616e       if not chan
+00015f50: 6e65 6c5f 6561 726c 795f 7265 7265 665f  nel_early_reref_
+00015f60: 636f 6c6c 6563 7465 645b 6368 616e 6e65  collected[channe
+00015f70: 6c5d 3a0a 2020 2020 2020 2020 2020 2020  l]:.            
+00015f80: 2020 2020 2020 2020 2020 2020 2320 6561              # ea
+00015f90: 726c 7920 6e6f 7420 636f 6c6c 6563 7465  rly not collecte
+00015fa0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00015fb0: 2020 2020 2020 2020 2020 2370 7269 6e74            #print
+00015fc0: 2863 6861 6e6e 656c 202b 2022 3a20 436f  (channel + ": Co
+00015fd0: 6c6c 6563 7469 6e67 2065 6172 6c79 2072  llecting early r
+00015fe0: 6572 6566 2076 616c 7565 7320 6672 6f6d  eref values from
+00015ff0: 2063 6861 6e6e 656c 2229 0a0a 2020 2020   channel")..    
+00016000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016010: 2020 2020 2320 6c6f 6f70 206f 7665 7220      # loop over 
+00016020: 7468 6520 6561 726c 792d 7265 7265 6620  the early-reref 
+00016030: 6772 6f75 7073 0a20 2020 2020 2020 2020  groups.         
+00016040: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00016050: 6f72 2067 726f 7570 2069 6e20 6561 726c  or group in earl
+00016060: 795f 7265 715f 6772 6f75 7073 3a0a 0a20  y_req_groups:.. 
+00016070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016080: 2020 2020 2020 2020 2020 2023 2063 6865             # che
+00016090: 636b 2069 6620 7468 6973 2067 726f 7570  ck if this group
+000160a0: 2072 6571 7569 7265 7320 7468 6973 2063   requires this c
+000160b0: 6861 6e6e 656c 0a20 2020 2020 2020 2020  hannel.         
+000160c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160d0: 2020 2069 6620 6368 616e 6e65 6c20 696e     if channel in
+000160e0: 2065 6172 6c79 5f67 726f 7570 5f63 6861   early_group_cha
+000160f0: 6e6e 656c 735f 636f 6c6c 6563 7465 645b  nnels_collected[
+00016100: 7374 7228 6772 6f75 7029 5d2e 6b65 7973  str(group)].keys
+00016110: 2829 3a0a 0a20 2020 2020 2020 2020 2020  ():..           
+00016120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016130: 2020 2020 2023 2063 7265 6174 6520 6172       # create ar
+00016140: 7261 7973 2074 6f20 686f 6c64 2074 6865  rays to hold the
+00016150: 2067 726f 7570 2064 6174 6120 6966 206e   group data if n
+00016160: 6f74 2079 6574 2069 6e69 7469 616c 697a  ot yet initializ
+00016170: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
 00016180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161a0: 2320 6164 6420 746f 2067 726f 7570 2064  # add to group d
-000161b0: 6174 610a 2020 2020 2020 2020 2020 2020  ata.            
+00016190: 2020 2069 6620 6561 726c 795f 6772 6f75     if early_grou
+000161a0: 705f 6461 7461 5b73 7472 2867 726f 7570  p_data[str(group
+000161b0: 295d 2069 7320 4e6f 6e65 3a0a 2020 2020  )] is None:.    
 000161c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161d0: 2020 2020 6966 2065 6172 6c79 5f72 6572      if early_rer
-000161e0: 6566 2e63 6861 6e6e 656c 5f65 7863 6c75  ef.channel_exclu
-000161f0: 6465 5f65 706f 6368 7320 6973 204e 6f6e  de_epochs is Non
-00016200: 6520 6f72 2063 6861 6e6e 656c 206e 6f74  e or channel not
-00016210: 2069 6e20 6561 726c 795f 7265 7265 662e   in early_reref.
-00016220: 6368 616e 6e65 6c5f 6578 636c 7564 655f  channel_exclude_
-00016230: 6570 6f63 6873 3a0a 0a20 2020 2020 2020  epochs:..       
+000161d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161e0: 6561 726c 795f 6772 6f75 705f 6461 7461  early_group_data
+000161f0: 5b73 7472 2867 726f 7570 295d 203d 206e  [str(group)] = n
+00016200: 702e 7a65 726f 7328 286c 656e 2863 6861  p.zeros((len(cha
+00016210: 6e6e 656c 5f64 6174 615b 6368 616e 6e65  nnel_data[channe
+00016220: 6c5d 292c 292c 2064 7479 7065 3d6e 702e  l]),), dtype=np.
+00016230: 666c 6f61 7436 3429 0a20 2020 2020 2020  float64).       
 00016240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016250: 2020 2020 2020 2020 2020 2020 2023 206e               # n
-00016260: 6f20 6578 636c 7573 696f 6e20 6570 6f63  o exclusion epoc
-00016270: 6873 2c20 6a75 7374 2061 6464 2074 6865  hs, just add the
-00016280: 2077 686f 6c65 2063 6861 6e6e 656c 0a20   whole channel. 
+00016250: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00016260: 6561 726c 795f 7265 7265 662e 6368 616e  early_reref.chan
+00016270: 6e65 6c5f 6578 636c 7564 655f 6570 6f63  nel_exclude_epoc
+00016280: 6873 2069 7320 6e6f 7420 4e6f 6e65 3a0a  hs is not None:.
 00016290: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000162a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162b0: 2020 2065 6172 6c79 5f67 726f 7570 5f64     early_group_d
-000162c0: 6174 615b 7374 7228 6772 6f75 7029 5d20  ata[str(group)] 
-000162d0: 2b3d 2063 6861 6e6e 656c 5f64 6174 615b  += channel_data[
-000162e0: 6368 616e 6e65 6c5d 0a0a 2020 2020 2020  channel]..      
-000162f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016300: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00016310: 636f 756e 7420 7468 6520 6e75 6d62 6572  count the number
-00016320: 206f 6620 7361 6d70 6c65 7320 6164 6465   of samples adde
-00016330: 6420 746f 2074 6865 2074 6f74 616c 2069  d to the total i
-00016340: 6620 6e65 6564 6564 0a20 2020 2020 2020  f needed.       
+000162b0: 2020 2020 2020 2020 6561 726c 795f 6772          early_gr
+000162c0: 6f75 705f 6e75 6d64 6174 615b 7374 7228  oup_numdata[str(
+000162d0: 6772 6f75 7029 5d20 3d20 6e70 2e7a 6572  group)] = np.zer
+000162e0: 6f73 2828 6c65 6e28 6368 616e 6e65 6c5f  os((len(channel_
+000162f0: 6461 7461 5b63 6861 6e6e 656c 5d29 2c29  data[channel]),)
+00016300: 2c20 6474 7970 653d 6e70 2e75 696e 7431  , dtype=np.uint1
+00016310: 3629 0a0a 2020 2020 2020 2020 2020 2020  6)..            
+00016320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016330: 2020 2020 2320 6164 6420 746f 2067 726f      # add to gro
+00016340: 7570 2064 6174 610a 2020 2020 2020 2020  up data.        
 00016350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016360: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00016370: 6561 726c 795f 7265 7265 662e 6368 616e  early_reref.chan
-00016380: 6e65 6c5f 6578 636c 7564 655f 6570 6f63  nel_exclude_epoc
-00016390: 6873 2069 7320 6e6f 7420 4e6f 6e65 3a0a  hs is not None:.
-000163a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000163c0: 2020 2020 2020 2020 6561 726c 795f 6772          early_gr
-000163d0: 6f75 705f 6e75 6d64 6174 615b 7374 7228  oup_numdata[str(
-000163e0: 6772 6f75 7029 5d20 2b3d 2031 0a0a 2020  group)] += 1..  
-000163f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016400: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00016410: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00016420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016430: 2020 2020 2020 2020 2320 6368 616e 6e65          # channe
-00016440: 6c20 6861 7320 6578 636c 7573 696f 6e20  l has exclusion 
-00016450: 6570 6f63 6873 0a0a 2020 2020 2020 2020  epochs..        
-00016460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016470: 2020 2020 2020 2020 2020 2020 2320 6372              # cr
-00016480: 6561 7465 2061 2062 696e 6172 7920 6e75  eate a binary nu
-00016490: 6d70 7920 7665 6374 6f72 206f 6620 7468  mpy vector of th
-000164a0: 6520 7361 6d70 6c65 2074 6f20 696e 636c  e sample to incl
-000164b0: 7564 650a 2020 2020 2020 2020 2020 2020  ude.            
-000164c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164d0: 2020 2020 2020 2020 6368 616e 6e65 6c5f          channel_
-000164e0: 696e 636c 7564 6573 203d 206e 702e 6f6e  includes = np.on
-000164f0: 6573 2828 6c65 6e28 6368 616e 6e65 6c5f  es((len(channel_
-00016500: 6461 7461 5b63 6861 6e6e 656c 5d29 2c29  data[channel]),)
-00016510: 2c20 6474 7970 653d 6e70 2e62 6f6f 6c29  , dtype=np.bool)
-00016520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016540: 2020 2020 2066 6f72 2063 6861 6e6e 656c       for channel
-00016550: 5f65 7863 6c75 6465 5f65 706f 6368 2069  _exclude_epoch i
-00016560: 6e20 6561 726c 795f 7265 7265 662e 6368  n early_reref.ch
-00016570: 616e 6e65 6c5f 6578 636c 7564 655f 6570  annel_exclude_ep
-00016580: 6f63 6873 5b63 6861 6e6e 656c 5d3a 0a20  ochs[channel]:. 
+00016360: 2020 2020 2020 2020 6966 2065 6172 6c79          if early
+00016370: 5f72 6572 6566 2e63 6861 6e6e 656c 5f65  _reref.channel_e
+00016380: 7863 6c75 6465 5f65 706f 6368 7320 6973  xclude_epochs is
+00016390: 204e 6f6e 6520 6f72 2063 6861 6e6e 656c   None or channel
+000163a0: 206e 6f74 2069 6e20 6561 726c 795f 7265   not in early_re
+000163b0: 7265 662e 6368 616e 6e65 6c5f 6578 636c  ref.channel_excl
+000163c0: 7564 655f 6570 6f63 6873 3a0a 0a20 2020  ude_epochs:..   
+000163d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000163f0: 2023 206e 6f20 6578 636c 7573 696f 6e20   # no exclusion 
+00016400: 6570 6f63 6873 2c20 6a75 7374 2061 6464  epochs, just add
+00016410: 2074 6865 2077 686f 6c65 2063 6861 6e6e   the whole chann
+00016420: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
+00016430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016440: 2020 2020 2020 2065 6172 6c79 5f67 726f         early_gro
+00016450: 7570 5f64 6174 615b 7374 7228 6772 6f75  up_data[str(grou
+00016460: 7029 5d20 2b3d 2063 6861 6e6e 656c 5f64  p)] += channel_d
+00016470: 6174 615b 6368 616e 6e65 6c5d 0a0a 2020  ata[channel]..  
+00016480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000164a0: 2020 2320 636f 756e 7420 7468 6520 6e75    # count the nu
+000164b0: 6d62 6572 206f 6620 7361 6d70 6c65 7320  mber of samples 
+000164c0: 6164 6465 6420 746f 2074 6865 2074 6f74  added to the tot
+000164d0: 616c 2069 6620 6e65 6564 6564 0a20 2020  al if needed.   
+000164e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000164f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016500: 2069 6620 6561 726c 795f 7265 7265 662e   if early_reref.
+00016510: 6368 616e 6e65 6c5f 6578 636c 7564 655f  channel_exclude_
+00016520: 6570 6f63 6873 2069 7320 6e6f 7420 4e6f  epochs is not No
+00016530: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00016540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016550: 2020 2020 2020 2020 2020 2020 6561 726c              earl
+00016560: 795f 6772 6f75 705f 6e75 6d64 6174 615b  y_group_numdata[
+00016570: 7374 7228 6772 6f75 7029 5d20 2b3d 2031  str(group)] += 1
+00016580: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
 00016590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165b0: 2020 2020 2020 2065 7863 6c75 6465 5f73         exclude_s
-000165c0: 616d 706c 655f 7374 6172 7420 3d20 696e  ample_start = in
-000165d0: 7428 726f 756e 6428 6368 616e 6e65 6c5f  t(round(channel_
-000165e0: 6578 636c 7564 655f 6570 6f63 685b 305d  exclude_epoch[0]
-000165f0: 202a 2064 6174 615f 7265 6164 6572 2e73   * data_reader.s
-00016600: 616d 706c 696e 675f 7261 7465 2929 0a20  ampling_rate)). 
-00016610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016630: 2020 2020 2020 2065 7863 6c75 6465 5f73         exclude_s
-00016640: 616d 706c 655f 656e 6420 3d20 696e 7428  ample_end = int(
-00016650: 726f 756e 6428 6368 616e 6e65 6c5f 6578  round(channel_ex
-00016660: 636c 7564 655f 6570 6f63 685b 315d 202a  clude_epoch[1] *
-00016670: 2064 6174 615f 7265 6164 6572 2e73 616d   data_reader.sam
-00016680: 706c 696e 675f 7261 7465 2929 0a20 2020  pling_rate)).   
-00016690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166b0: 2020 2020 2063 6861 6e6e 656c 5f69 6e63       channel_inc
-000166c0: 6c75 6465 735b 6578 636c 7564 655f 7361  ludes[exclude_sa
-000166d0: 6d70 6c65 5f73 7461 7274 3a65 7863 6c75  mple_start:exclu
-000166e0: 6465 5f73 616d 706c 655f 656e 645d 203d  de_sample_end] =
-000166f0: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
-00016700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016710: 2020 2020 2020 2020 2320 6164 6420 7468          # add th
-00016720: 6520 6368 616e 6e65 6c20 2874 616b 696e  e channel (takin
-00016730: 6720 696e 746f 2061 6363 6f75 6e74 206f  g into account o
-00016740: 6e20 7468 6520 696e 636c 7573 696f 6e20  n the inclusion 
-00016750: 7665 6374 6f72 290a 2020 2020 2020 2020  vector).        
-00016760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016770: 2020 2020 2020 2020 2020 2020 6561 726c              earl
-00016780: 795f 6772 6f75 705f 6461 7461 5b73 7472  y_group_data[str
-00016790: 2867 726f 7570 295d 202b 3d20 2863 6861  (group)] += (cha
-000167a0: 6e6e 656c 5f64 6174 615b 6368 616e 6e65  nnel_data[channe
-000167b0: 6c5d 202a 2063 6861 6e6e 656c 5f69 6e63  l] * channel_inc
-000167c0: 6c75 6465 7329 0a20 2020 2020 2020 2020  ludes).         
-000167d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167e0: 2020 2020 2020 2020 2020 2065 6172 6c79             early
-000167f0: 5f67 726f 7570 5f6e 756d 6461 7461 5b73  _group_numdata[s
-00016800: 7472 2867 726f 7570 295d 202b 3d20 6368  tr(group)] += ch
-00016810: 616e 6e65 6c5f 696e 636c 7564 6573 0a20  annel_includes. 
+000165a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000165b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165c0: 2020 2020 2020 2020 2020 2020 2320 6368              # ch
+000165d0: 616e 6e65 6c20 6861 7320 6578 636c 7573  annel has exclus
+000165e0: 696f 6e20 6570 6f63 6873 0a0a 2020 2020  ion epochs..    
+000165f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016610: 2320 6372 6561 7465 2061 2062 696e 6172  # create a binar
+00016620: 7920 6e75 6d70 7920 7665 6374 6f72 206f  y numpy vector o
+00016630: 6620 7468 6520 7361 6d70 6c65 2074 6f20  f the sample to 
+00016640: 696e 636c 7564 650a 2020 2020 2020 2020  include.        
+00016650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016660: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00016670: 6e65 6c5f 696e 636c 7564 6573 203d 206e  nel_includes = n
+00016680: 702e 6f6e 6573 2828 6c65 6e28 6368 616e  p.ones((len(chan
+00016690: 6e65 6c5f 6461 7461 5b63 6861 6e6e 656c  nel_data[channel
+000166a0: 5d29 2c29 2c20 6474 7970 653d 626f 6f6c  ]),), dtype=bool
+000166b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000166c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000166d0: 2020 2020 2020 666f 7220 6368 616e 6e65        for channe
+000166e0: 6c5f 6578 636c 7564 655f 6570 6f63 6820  l_exclude_epoch 
+000166f0: 696e 2065 6172 6c79 5f72 6572 6566 2e63  in early_reref.c
+00016700: 6861 6e6e 656c 5f65 7863 6c75 6465 5f65  hannel_exclude_e
+00016710: 706f 6368 735b 6368 616e 6e65 6c5d 3a0a  pochs[channel]:.
+00016720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016740: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
+00016750: 7361 6d70 6c65 5f73 7461 7274 203d 2069  sample_start = i
+00016760: 6e74 2872 6f75 6e64 2863 6861 6e6e 656c  nt(round(channel
+00016770: 5f65 7863 6c75 6465 5f65 706f 6368 5b30  _exclude_epoch[0
+00016780: 5d20 2a20 6461 7461 5f72 6561 6465 722e  ] * data_reader.
+00016790: 7361 6d70 6c69 6e67 5f72 6174 6529 290a  sampling_rate)).
+000167a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000167c0: 2020 2020 2020 2020 6578 636c 7564 655f          exclude_
+000167d0: 7361 6d70 6c65 5f65 6e64 203d 2069 6e74  sample_end = int
+000167e0: 2872 6f75 6e64 2863 6861 6e6e 656c 5f65  (round(channel_e
+000167f0: 7863 6c75 6465 5f65 706f 6368 5b31 5d20  xclude_epoch[1] 
+00016800: 2a20 6461 7461 5f72 6561 6465 722e 7361  * data_reader.sa
+00016810: 6d70 6c69 6e67 5f72 6174 6529 290a 2020  mpling_rate)).  
 00016820: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00016830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016840: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
-00016850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016860: 2020 2020 2020 2020 2023 2066 6c61 6720           # flag 
-00016870: 6368 616e 6e65 6c20 7769 7468 696e 2074  channel within t
-00016880: 6865 2067 726f 7570 2061 7320 636f 6c6c  he group as coll
-00016890: 6563 7465 640a 2020 2020 2020 2020 2020  ected.          
-000168a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168b0: 2020 2020 2020 6561 726c 795f 6772 6f75        early_grou
-000168c0: 705f 6368 616e 6e65 6c73 5f63 6f6c 6c65  p_channels_colle
-000168d0: 6374 6564 5b73 7472 2867 726f 7570 295d  cted[str(group)]
-000168e0: 5b63 6861 6e6e 656c 5d20 3d20 5472 7565  [channel] = True
-000168f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016910: 2020 2320 6368 6563 6b20 7768 6574 6865    # check whethe
-00016920: 7220 616c 6c20 7468 6520 6368 616e 6e65  r all the channe
-00016930: 6c73 2069 6e20 7468 6520 6772 6f75 7020  ls in the group 
-00016940: 6172 6520 636f 6c6c 6563 7465 640a 2020  are collected.  
-00016950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016960: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00016970: 2061 6c6c 2865 6172 6c79 5f67 726f 7570   all(early_group
-00016980: 5f63 6861 6e6e 656c 735f 636f 6c6c 6563  _channels_collec
-00016990: 7465 645b 7374 7228 6772 6f75 7029 5d2e  ted[str(group)].
-000169a0: 7661 6c75 6573 2829 293a 0a0a 2020 2020  values()):..    
+00016840: 2020 2020 2020 6368 616e 6e65 6c5f 696e        channel_in
+00016850: 636c 7564 6573 5b65 7863 6c75 6465 5f73  cludes[exclude_s
+00016860: 616d 706c 655f 7374 6172 743a 6578 636c  ample_start:excl
+00016870: 7564 655f 7361 6d70 6c65 5f65 6e64 5d20  ude_sample_end] 
+00016880: 3d20 300a 0a20 2020 2020 2020 2020 2020  = 0..           
+00016890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000168a0: 2020 2020 2020 2020 2023 2061 6464 2074           # add t
+000168b0: 6865 2063 6861 6e6e 656c 2028 7461 6b69  he channel (taki
+000168c0: 6e67 2069 6e74 6f20 6163 636f 756e 7420  ng into account 
+000168d0: 6f6e 2074 6865 2069 6e63 6c75 7369 6f6e  on the inclusion
+000168e0: 2076 6563 746f 7229 0a20 2020 2020 2020   vector).       
+000168f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016900: 2020 2020 2020 2020 2020 2020 2065 6172               ear
+00016910: 6c79 5f67 726f 7570 5f64 6174 615b 7374  ly_group_data[st
+00016920: 7228 6772 6f75 7029 5d20 2b3d 2028 6368  r(group)] += (ch
+00016930: 616e 6e65 6c5f 6461 7461 5b63 6861 6e6e  annel_data[chann
+00016940: 656c 5d20 2a20 6368 616e 6e65 6c5f 696e  el] * channel_in
+00016950: 636c 7564 6573 290a 2020 2020 2020 2020  cludes).        
+00016960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016970: 2020 2020 2020 2020 2020 2020 6561 726c              earl
+00016980: 795f 6772 6f75 705f 6e75 6d64 6174 615b  y_group_numdata[
+00016990: 7374 7228 6772 6f75 7029 5d20 2b3d 2063  str(group)] += c
+000169a0: 6861 6e6e 656c 5f69 6e63 6c75 6465 730a  hannel_includes.
 000169b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 000169c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169d0: 2320 7461 6b65 2074 6865 2061 7665 7261  # take the avera
-000169e0: 6765 206f 7665 7220 7468 6520 746f 7461  ge over the tota
-000169f0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-00016a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a10: 2020 2020 2020 2320 2869 6620 7370 6563        # (if spec
-00016a20: 6966 6963 2065 706f 6368 7320 7765 7265  ific epochs were
-00016a30: 2065 7863 6c75 6465 642c 2065 6163 6820   excluded, each 
-00016a40: 7361 6d70 6c65 2073 686f 756c 6420 6265  sample should be
-00016a50: 2064 6976 6964 6564 2062 7920 6974 7320   divided by its 
-00016a60: 6f77 6e20 6e75 6d62 6572 290a 2020 2020  own number).    
-00016a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a90: 6966 2065 6172 6c79 5f72 6572 6566 2e63  if early_reref.c
-00016aa0: 6861 6e6e 656c 5f65 7863 6c75 6465 5f65  hannel_exclude_e
-00016ab0: 706f 6368 7320 6973 206e 6f74 204e 6f6e  pochs is not Non
-00016ac0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00016ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ae0: 2020 2020 2020 2020 2020 2065 6172 6c79             early
-00016af0: 5f67 726f 7570 5f64 6174 615b 7374 7228  _group_data[str(
-00016b00: 6772 6f75 7029 5d20 2f3d 2065 6172 6c79  group)] /= early
-00016b10: 5f67 726f 7570 5f6e 756d 6461 7461 5b73  _group_numdata[s
-00016b20: 7472 2867 726f 7570 295d 0a0a 2020 2020  tr(group)]..    
-00016b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169d0: 2020 2020 7061 7373 0a0a 2020 2020 2020      pass..      
+000169e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169f0: 2020 2020 2020 2020 2020 2320 666c 6167            # flag
+00016a00: 2063 6861 6e6e 656c 2077 6974 6869 6e20   channel within 
+00016a10: 7468 6520 6772 6f75 7020 6173 2063 6f6c  the group as col
+00016a20: 6c65 6374 6564 0a20 2020 2020 2020 2020  lected.         
+00016a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016a40: 2020 2020 2020 2065 6172 6c79 5f67 726f         early_gro
+00016a50: 7570 5f63 6861 6e6e 656c 735f 636f 6c6c  up_channels_coll
+00016a60: 6563 7465 645b 7374 7228 6772 6f75 7029  ected[str(group)
+00016a70: 5d5b 6368 616e 6e65 6c5d 203d 2054 7275  ][channel] = Tru
+00016a80: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+00016a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016aa0: 2020 2023 2063 6865 636b 2077 6865 7468     # check wheth
+00016ab0: 6572 2061 6c6c 2074 6865 2063 6861 6e6e  er all the chann
+00016ac0: 656c 7320 696e 2074 6865 2067 726f 7570  els in the group
+00016ad0: 2061 7265 2063 6f6c 6c65 6374 6564 0a20   are collected. 
+00016ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016af0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00016b00: 6620 616c 6c28 6561 726c 795f 6772 6f75  f all(early_grou
+00016b10: 705f 6368 616e 6e65 6c73 5f63 6f6c 6c65  p_channels_colle
+00016b20: 6374 6564 5b73 7472 2867 726f 7570 295d  cted[str(group)]
+00016b30: 2e76 616c 7565 7328 2929 3a0a 0a20 2020  .values()):..   
 00016b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b50: 2020 2020 2320 636c 6561 7220 7468 6520      # clear the 
-00016b60: 6172 7261 7920 7761 7320 7573 6564 2066  array was used f
-00016b70: 6f72 2064 6976 6973 696f 6e0a 2020 2020  or division.    
-00016b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b60: 2023 2074 616b 6520 7468 6520 6176 6572   # take the aver
+00016b70: 6167 6520 6f76 6572 2074 6865 2074 6f74  age over the tot
+00016b80: 616c 0a20 2020 2020 2020 2020 2020 2020  al.             
 00016b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ba0: 2020 2020 6465 6c20 6561 726c 795f 6772      del early_gr
-00016bb0: 6f75 705f 6e75 6d64 6174 615b 7374 7228  oup_numdata[str(
-00016bc0: 6772 6f75 7029 5d0a 0a20 2020 2020 2020  group)]..       
-00016bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016be0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00016bf0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00016ba0: 2020 2020 2020 2023 2028 6966 2073 7065         # (if spe
+00016bb0: 6369 6669 6320 6570 6f63 6873 2077 6572  cific epochs wer
+00016bc0: 6520 6578 636c 7564 6564 2c20 6561 6368  e excluded, each
+00016bd0: 2073 616d 706c 6520 7368 6f75 6c64 2062   sample should b
+00016be0: 6520 6469 7669 6465 6420 6279 2069 7473  e divided by its
+00016bf0: 206f 776e 206e 756d 6265 7229 0a20 2020   own number).   
 00016c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c10: 2020 2020 2020 2020 2020 2065 6172 6c79             early
-00016c20: 5f67 726f 7570 5f64 6174 615b 7374 7228  _group_data[str(
-00016c30: 6772 6f75 7029 5d20 2f3d 206c 656e 2865  group)] /= len(e
-00016c40: 6172 6c79 5f67 726f 7570 5f63 6861 6e6e  arly_group_chann
-00016c50: 656c 735f 636f 6c6c 6563 7465 645b 7374  els_collected[st
-00016c60: 7228 6772 6f75 7029 5d29 0a0a 2020 2020  r(group)])..    
-00016c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c80: 2020 2020 2320 666c 6167 2074 6861 7420      # flag that 
-00016c90: 666f 7220 7468 6973 2063 6861 6e6e 656c  for this channel
-00016ca0: 2074 6865 2072 652d 7265 6620 7661 6c75   the re-ref valu
-00016cb0: 6573 2068 6176 6520 6265 656e 2063 6f6c  es have been col
-00016cc0: 6c65 6374 6564 0a20 2020 2020 2020 2020  lected.         
-00016cd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00016ce0: 6861 6e6e 656c 5f65 6172 6c79 5f72 6572  hannel_early_rer
-00016cf0: 6566 5f63 6f6c 6c65 6374 6564 5b63 6861  ef_collected[cha
-00016d00: 6e6e 656c 5d20 3d20 5472 7565 0a0a 2020  nnel] = True..  
+00016c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c20: 2069 6620 6561 726c 795f 7265 7265 662e   if early_reref.
+00016c30: 6368 616e 6e65 6c5f 6578 636c 7564 655f  channel_exclude_
+00016c40: 6570 6f63 6873 2069 7320 6e6f 7420 4e6f  epochs is not No
+00016c50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00016c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016c70: 2020 2020 2020 2020 2020 2020 6561 726c              earl
+00016c80: 795f 6772 6f75 705f 6461 7461 5b73 7472  y_group_data[str
+00016c90: 2867 726f 7570 295d 202f 3d20 6561 726c  (group)] /= earl
+00016ca0: 795f 6772 6f75 705f 6e75 6d64 6174 615b  y_group_numdata[
+00016cb0: 7374 7228 6772 6f75 7029 5d0a 0a20 2020  str(group)]..   
+00016cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016ce0: 2020 2020 2023 2063 6c65 6172 2074 6865       # clear the
+00016cf0: 2061 7272 6179 2077 6173 2075 7365 6420   array was used 
+00016d00: 666f 7220 6469 7669 7369 6f6e 0a20 2020  for division.   
 00016d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d20: 2020 2020 2020 2320 7570 6461 7465 2074        # update t
-00016d30: 6865 2070 726f 6772 6573 7320 6261 720a  he progress bar.
-00016d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d50: 2020 2020 2020 2020 7570 6461 7465 5f70          update_p
-00016d60: 726f 6772 6573 7362 6172 2829 0a0a 2020  rogressbar()..  
-00016d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d80: 2020 2020 2020 2320 6368 6563 6b20 6966        # check if
-00016d90: 2063 6861 6e6e 656c 2069 7320 6e6f 206c   channel is no l
-00016da0: 6f6e 6765 7220 6e65 6564 6564 2061 6674  onger needed aft
-00016db0: 6572 2074 6869 7320 2866 6f72 2065 706f  er this (for epo
-00016dc0: 6368 2d69 6e67 206f 7220 666f 7220 6c61  ch-ing or for la
-00016dd0: 7465 2072 652d 7265 6629 0a20 2020 2020  te re-ref).     
-00016de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016df0: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
-00016e00: 616c 736f 206d 6561 6e73 2074 6865 2063  also means the c
-00016e10: 6861 6e6e 656c 2077 6173 206f 6e6c 7920  hannel was only 
-00016e20: 6c6f 6164 6564 2066 6f72 2065 6172 6c79  loaded for early
-00016e30: 2072 652d 7265 6665 7265 6e63 696e 670a   re-referencing.
-00016e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e50: 2020 2020 2020 2020 6966 2063 6861 6e6e          if chann
-00016e60: 656c 206e 6f74 2069 6e20 6368 616e 6e65  el not in channe
-00016e70: 6c5f 6570 6f63 6865 642e 6b65 7973 2829  l_epoched.keys()
-00016e80: 2061 6e64 2028 6c61 7465 5f72 6572 6566   and (late_reref
-00016e90: 2069 7320 4e6f 6e65 206f 7220 6368 616e   is None or chan
-00016ea0: 6e65 6c20 6e6f 7420 696e 2063 6861 6e6e  nel not in chann
-00016eb0: 656c 5f6c 6174 655f 7265 7265 665f 636f  el_late_reref_co
-00016ec0: 6c6c 6563 7465 6429 3a0a 2020 2020 2020  llected):.      
-00016ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ee0: 2020 2020 2020 2320 6368 616e 6e65 6c2d        # channel-
-00016ef0: 6461 7461 2069 7320 6e6f 206c 6f6e 6765  data is no longe
-00016f00: 7220 6e65 6564 6564 2061 7420 616c 6c0a  r needed at all.
-00016f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016f20: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-00016f30: 656d 6f76 6520 7468 6520 7265 6665 7265  emove the refere
-00016f40: 6e63 6520 746f 2074 6865 206e 756d 7079  nce to the numpy
-00016f50: 2061 7272 6179 2c20 7468 6973 2077 6179   array, this way
-00016f60: 2074 6865 206d 656d 6f72 7920 7368 6f75   the memory shou
-00016f70: 6c64 2062 6520 6176 6169 6c61 626c 6520  ld be available 
-00016f80: 666f 7220 636f 6c6c 6563 7469 6f6e 0a20  for collection. 
-00016f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fa0: 2020 2020 2020 2020 2020 2063 6861 6e6e             chann
-00016fb0: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
-00016fc0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00016fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fe0: 2020 2020 6763 2e63 6f6c 6c65 6374 2829      gc.collect()
-00016ff0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00017000: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017010: 736b 6970 2074 6f20 6e65 7874 2063 6861  skip to next cha
-00017020: 6e6e 656c 0a20 2020 2020 2020 2020 2020  nnel.           
-00017030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017040: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
-00017050: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00017060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017070: 2020 2020 2023 2045 6172 6c79 2072 652d       # Early re-
-00017080: 7265 6665 7265 6e63 696e 6720 6170 706c  referencing appl
-00017090: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
-000170a0: 2020 2020 2020 230a 0a20 2020 2020 2020        #..       
-000170b0: 2020 2020 2020 2020 2020 2020 2023 2063               # c
-000170c0: 6865 636b 2069 6620 6561 726c 7920 7265  heck if early re
-000170d0: 2d72 6566 6572 656e 6369 6e67 2069 7320  -referencing is 
-000170e0: 6e6f 7420 6170 706c 6965 6420 746f 2074  not applied to t
-000170f0: 6869 7320 6368 616e 6e65 6c0a 2020 2020  his channel.    
-00017100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017110: 6966 206e 6f74 2063 6861 6e6e 656c 5f65  if not channel_e
-00017120: 6172 6c79 5f61 7070 6c69 6564 5b63 6861  arly_applied[cha
-00017130: 6e6e 656c 5d3a 0a0a 2020 2020 2020 2020  nnel]:..        
-00017140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017150: 2320 7265 7472 6965 7665 2074 6865 2065  # retrieve the e
-00017160: 6172 6c79 2072 652d 7265 6620 6772 6f75  arly re-ref grou
-00017170: 7020 666f 7220 7468 6973 2063 6861 6e6e  p for this chann
-00017180: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
-00017190: 2020 2020 2020 2020 2020 2067 726f 7570             group
-000171a0: 203d 2065 6172 6c79 5f72 6572 6566 2e63   = early_reref.c
-000171b0: 6861 6e6e 656c 5f67 726f 7570 5b63 6861  hannel_group[cha
-000171c0: 6e6e 656c 5d0a 0a20 2020 2020 2020 2020  nnel]..         
-000171d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000171e0: 2063 6865 636b 2069 6620 616c 6c20 7468   check if all th
-000171f0: 6520 6561 726c 7920 7265 2d72 6566 6572  e early re-refer
-00017200: 656e 6369 6e67 2069 6e66 6f72 6d61 7469  encing informati
-00017210: 6f6e 2069 7320 6176 6169 6c61 626c 6520  on is available 
-00017220: 7965 7420 2865 6172 6c79 2061 7665 7261  yet (early avera
-00017230: 6765 2066 6f72 2074 6869 7320 6772 6f75  ge for this grou
-00017240: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
-00017250: 2020 2020 2020 2020 2020 2069 6620 616c             if al
-00017260: 6c28 6561 726c 795f 6772 6f75 705f 6368  l(early_group_ch
-00017270: 616e 6e65 6c73 5f63 6f6c 6c65 6374 6564  annels_collected
-00017280: 5b73 7472 2867 726f 7570 295d 2e76 616c  [str(group)].val
-00017290: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
-000172a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000172b0: 2020 2020 2320 616c 6c20 7265 7175 6972      # all requir
-000172c0: 6564 2069 6e66 6f72 6d61 7469 6f6e 2069  ed information i
-000172d0: 7320 6176 6169 6c61 626c 652c 2070 6572  s available, per
-000172e0: 666f 726d 2065 6172 6c79 2072 652d 7265  form early re-re
-000172f0: 6665 7265 6e63 696e 6720 6f6e 2074 6865  ferencing on the
-00017300: 2063 6861 6e6e 656c 0a0a 2020 2020 2020   channel..      
-00017310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017320: 2020 2020 2020 2370 7269 6e74 2863 6861        #print(cha
-00017330: 6e6e 656c 202b 2022 3a20 7065 7266 6f72  nnel + ": perfor
-00017340: 6d69 6e67 2065 6172 6c79 2072 6572 6566  ming early reref
-00017350: 206f 6e20 6368 616e 6e65 6c22 290a 0a20   on channel").. 
+00016d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d30: 2020 2020 2064 656c 2065 6172 6c79 5f67       del early_g
+00016d40: 726f 7570 5f6e 756d 6461 7461 5b73 7472  roup_numdata[str
+00016d50: 2867 726f 7570 295d 0a0a 2020 2020 2020  (group)]..      
+00016d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016d70: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00016d80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00016d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016da0: 2020 2020 2020 2020 2020 2020 6561 726c              earl
+00016db0: 795f 6772 6f75 705f 6461 7461 5b73 7472  y_group_data[str
+00016dc0: 2867 726f 7570 295d 202f 3d20 6c65 6e28  (group)] /= len(
+00016dd0: 6561 726c 795f 6772 6f75 705f 6368 616e  early_group_chan
+00016de0: 6e65 6c73 5f63 6f6c 6c65 6374 6564 5b73  nels_collected[s
+00016df0: 7472 2867 726f 7570 295d 290a 0a20 2020  tr(group)])..   
+00016e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e10: 2020 2020 2023 2066 6c61 6720 7468 6174       # flag that
+00016e20: 2066 6f72 2074 6869 7320 6368 616e 6e65   for this channe
+00016e30: 6c20 7468 6520 7265 2d72 6566 2076 616c  l the re-ref val
+00016e40: 7565 7320 6861 7665 2062 6565 6e20 636f  ues have been co
+00016e50: 6c6c 6563 7465 640a 2020 2020 2020 2020  llected.        
+00016e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e70: 6368 616e 6e65 6c5f 6561 726c 795f 7265  channel_early_re
+00016e80: 7265 665f 636f 6c6c 6563 7465 645b 6368  ref_collected[ch
+00016e90: 616e 6e65 6c5d 203d 2054 7275 650a 0a20  annel] = True.. 
+00016ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016eb0: 2020 2020 2020 2023 2075 7064 6174 6520         # update 
+00016ec0: 7468 6520 7072 6f67 7265 7373 2062 6172  the progress bar
+00016ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016ee0: 2020 2020 2020 2020 2075 7064 6174 655f           update_
+00016ef0: 7072 6f67 7265 7373 6261 7228 290a 0a20  progressbar().. 
+00016f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f10: 2020 2020 2020 2023 2063 6865 636b 2069         # check i
+00016f20: 6620 6368 616e 6e65 6c20 6973 206e 6f20  f channel is no 
+00016f30: 6c6f 6e67 6572 206e 6565 6465 6420 6166  longer needed af
+00016f40: 7465 7220 7468 6973 2028 666f 7220 6570  ter this (for ep
+00016f50: 6f63 682d 696e 6720 6f72 2066 6f72 206c  och-ing or for l
+00016f60: 6174 6520 7265 2d72 6566 290a 2020 2020  ate re-ref).    
+00016f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016f80: 2020 2020 2320 4e6f 7465 3a20 7468 6973      # Note: this
+00016f90: 2061 6c73 6f20 6d65 616e 7320 7468 6520   also means the 
+00016fa0: 6368 616e 6e65 6c20 7761 7320 6f6e 6c79  channel was only
+00016fb0: 206c 6f61 6465 6420 666f 7220 6561 726c   loaded for earl
+00016fc0: 7920 7265 2d72 6566 6572 656e 6369 6e67  y re-referencing
+00016fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016fe0: 2020 2020 2020 2020 2069 6620 6368 616e           if chan
+00016ff0: 6e65 6c20 6e6f 7420 696e 2063 6861 6e6e  nel not in chann
+00017000: 656c 5f65 706f 6368 6564 2e6b 6579 7328  el_epoched.keys(
+00017010: 2920 616e 6420 286c 6174 655f 7265 7265  ) and (late_rere
+00017020: 6620 6973 204e 6f6e 6520 6f72 2063 6861  f is None or cha
+00017030: 6e6e 656c 206e 6f74 2069 6e20 6368 616e  nnel not in chan
+00017040: 6e65 6c5f 6c61 7465 5f72 6572 6566 5f63  nel_late_reref_c
+00017050: 6f6c 6c65 6374 6564 293a 0a20 2020 2020  ollected):.     
+00017060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017070: 2020 2020 2020 2023 2063 6861 6e6e 656c         # channel
+00017080: 2d64 6174 6120 6973 206e 6f20 6c6f 6e67  -data is no long
+00017090: 6572 206e 6565 6465 6420 6174 2061 6c6c  er needed at all
+000170a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000170b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000170c0: 7265 6d6f 7665 2074 6865 2072 6566 6572  remove the refer
+000170d0: 656e 6365 2074 6f20 7468 6520 6e75 6d70  ence to the nump
+000170e0: 7920 6172 7261 792c 2074 6869 7320 7761  y array, this wa
+000170f0: 7920 7468 6520 6d65 6d6f 7279 2073 686f  y the memory sho
+00017100: 756c 6420 6265 2061 7661 696c 6162 6c65  uld be available
+00017110: 2066 6f72 2063 6f6c 6c65 6374 696f 6e0a   for collection.
+00017120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017130: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00017140: 6e65 6c5f 6461 7461 5b63 6861 6e6e 656c  nel_data[channel
+00017150: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
+00017160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017170: 2020 2020 2067 632e 636f 6c6c 6563 7428       gc.collect(
+00017180: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00017190: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000171a0: 2073 6b69 7020 746f 206e 6578 7420 6368   skip to next ch
+000171b0: 616e 6e65 6c0a 2020 2020 2020 2020 2020  annel.          
+000171c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171d0: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+000171e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171f0: 230a 2020 2020 2020 2020 2020 2020 2020  #.              
+00017200: 2020 2020 2020 2320 4561 726c 7920 7265        # Early re
+00017210: 2d72 6566 6572 656e 6369 6e67 2061 7070  -referencing app
+00017220: 6c79 0a20 2020 2020 2020 2020 2020 2020  ly.             
+00017230: 2020 2020 2020 2023 0a0a 2020 2020 2020         #..      
+00017240: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00017250: 6368 6563 6b20 6966 2065 6172 6c79 2072  check if early r
+00017260: 652d 7265 6665 7265 6e63 696e 6720 6973  e-referencing is
+00017270: 206e 6f74 2061 7070 6c69 6564 2074 6f20   not applied to 
+00017280: 7468 6973 2063 6861 6e6e 656c 0a20 2020  this channel.   
+00017290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172a0: 2069 6620 6e6f 7420 6368 616e 6e65 6c5f   if not channel_
+000172b0: 6561 726c 795f 6170 706c 6965 645b 6368  early_applied[ch
+000172c0: 616e 6e65 6c5d 3a0a 0a20 2020 2020 2020  annel]:..       
+000172d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172e0: 2023 2072 6574 7269 6576 6520 7468 6520   # retrieve the 
+000172f0: 6561 726c 7920 7265 2d72 6566 2067 726f  early re-ref gro
+00017300: 7570 2066 6f72 2074 6869 7320 6368 616e  up for this chan
+00017310: 6e65 6c0a 2020 2020 2020 2020 2020 2020  nel.            
+00017320: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+00017330: 7020 3d20 6561 726c 795f 7265 7265 662e  p = early_reref.
+00017340: 6368 616e 6e65 6c5f 6772 6f75 705b 6368  channel_group[ch
+00017350: 616e 6e65 6c5d 0a0a 2020 2020 2020 2020  annel]..        
 00017360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017370: 2020 2020 2020 2020 2020 2023 2070 6572             # per
-00017380: 666f 726d 2065 6172 6c79 2072 652d 7265  form early re-re
-00017390: 6620 7573 696e 6720 7265 7265 665f 7661  f using reref_va
-000173a0: 6c75 6573 0a20 2020 2020 2020 2020 2020  lues.           
-000173b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000173c0: 2063 6861 6e6e 656c 5f64 6174 615b 6368   channel_data[ch
-000173d0: 616e 6e65 6c5d 202d 3d20 6561 726c 795f  annel] -= early_
-000173e0: 6772 6f75 705f 6461 7461 5b73 7472 2867  group_data[str(g
-000173f0: 726f 7570 295d 0a0a 2020 2020 2020 2020  roup)]..        
-00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017410: 2020 2020 2320 7365 7420 6561 726c 7920      # set early 
-00017420: 7265 2d72 6566 6572 656e 6369 6e67 2061  re-referencing a
-00017430: 7320 746f 2068 6176 6520 6265 656e 2061  s to have been a
-00017440: 7070 6c69 6564 2074 6f20 7468 6520 6368  pplied to the ch
-00017450: 616e 6e65 6c2d 6461 7461 2069 6e20 6d65  annel-data in me
-00017460: 6d6f 7279 0a20 2020 2020 2020 2020 2020  mory.           
-00017470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017480: 2063 6861 6e6e 656c 5f65 6172 6c79 5f61   channel_early_a
-00017490: 7070 6c69 6564 5b63 6861 6e6e 656c 5d20  pplied[channel] 
-000174a0: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-000174b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174c0: 2020 2020 2320 544f 444f 3a20 6966 2074      # TODO: if t
-000174d0: 6869 7320 6973 2074 6865 206c 6174 6573  his is the lates
-000174e0: 7420 6368 616e 6e65 6c20 746f 2075 7365  t channel to use
-000174f0: 2074 6865 2065 6172 6c79 2067 726f 7570   the early group
-00017500: 2061 7665 7261 6765 2c20 7365 6520 6966   average, see if
-00017510: 2077 6520 6361 6e20 7361 6665 6c79 2063   we can safely c
-00017520: 6c65 6172 2074 6865 2067 726f 7570 2061  lear the group a
-00017530: 7665 7261 6765 2061 7272 6179 0a20 2020  verage array.   
+00017370: 2320 6368 6563 6b20 6966 2061 6c6c 2074  # check if all t
+00017380: 6865 2065 6172 6c79 2072 652d 7265 6665  he early re-refe
+00017390: 7265 6e63 696e 6720 696e 666f 726d 6174  rencing informat
+000173a0: 696f 6e20 6973 2061 7661 696c 6162 6c65  ion is available
+000173b0: 2079 6574 2028 6561 726c 7920 6176 6572   yet (early aver
+000173c0: 6167 6520 666f 7220 7468 6973 2067 726f  age for this gro
+000173d0: 7570 290a 2020 2020 2020 2020 2020 2020  up).            
+000173e0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+000173f0: 6c6c 2865 6172 6c79 5f67 726f 7570 5f63  ll(early_group_c
+00017400: 6861 6e6e 656c 735f 636f 6c6c 6563 7465  hannels_collecte
+00017410: 645b 7374 7228 6772 6f75 7029 5d2e 7661  d[str(group)].va
+00017420: 6c75 6573 2829 293a 0a20 2020 2020 2020  lues()):.       
+00017430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017440: 2020 2020 2023 2061 6c6c 2072 6571 7569       # all requi
+00017450: 7265 6420 696e 666f 726d 6174 696f 6e20  red information 
+00017460: 6973 2061 7661 696c 6162 6c65 2c20 7065  is available, pe
+00017470: 7266 6f72 6d20 6561 726c 7920 7265 2d72  rform early re-r
+00017480: 6566 6572 656e 6369 6e67 206f 6e20 7468  eferencing on th
+00017490: 6520 6368 616e 6e65 6c0a 0a20 2020 2020  e channel..     
+000174a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174b0: 2020 2020 2020 2023 7072 696e 7428 6368         #print(ch
+000174c0: 616e 6e65 6c20 2b20 223a 2070 6572 666f  annel + ": perfo
+000174d0: 726d 696e 6720 6561 726c 7920 7265 7265  rming early rere
+000174e0: 6620 6f6e 2063 6861 6e6e 656c 2229 0a0a  f on channel")..
+000174f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017500: 2020 2020 2020 2020 2020 2020 2320 7065              # pe
+00017510: 7266 6f72 6d20 6561 726c 7920 7265 2d72  rform early re-r
+00017520: 6566 2075 7369 6e67 2072 6572 6566 5f76  ef using reref_v
+00017530: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
 00017540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017550: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00017560: 206e 6f74 6520 7468 6174 2065 6172 6c79   note that early
-00017570: 2072 652d 7265 6620 6461 7461 2073 7469   re-ref data sti
-00017580: 6c6c 206d 6967 6874 2062 6520 6e65 6564  ll might be need
-00017590: 6564 2061 7420 6c61 7465 2072 652d 7265  ed at late re-re
-000175a0: 660a 0a0a 2020 2020 2020 2020 2020 2020  f...            
-000175b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000175c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000175d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000175e0: 6e6f 7420 616c 6c20 7265 7175 6972 6564  not all required
-000175f0: 2069 6e66 6f72 6d61 7469 6f6e 2066 6f72   information for
-00017600: 2065 6172 6c79 2072 652d 7265 6620 6973   early re-ref is
-00017610: 2061 7661 696c 6162 6c65 2c20 7765 2077   available, we w
-00017620: 696c 6c20 6861 7665 2074 6f20 7761 6974  ill have to wait
-00017630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017640: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-00017650: 6e20 6974 6572 6174 696f 6e20 286f 7665  n iteration (ove
-00017660: 7220 7468 6520 7265 7374 206f 6620 7468  r the rest of th
-00017670: 6520 6368 616e 6e65 6c73 2920 666f 7220  e channels) for 
-00017680: 7468 6520 696e 666f 726d 6174 696f 6e20  the information 
-00017690: 746f 2062 6563 6f6d 6520 6176 6169 6c61  to become availa
-000176a0: 626c 650a 0a20 2020 2020 2020 2020 2020  ble..           
-000176b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176c0: 2023 2063 6865 636b 2077 6865 7468 6572   # check whether
-000176d0: 2069 7420 6973 206f 7074 696d 697a 6564   it is optimized
-000176e0: 2066 6f72 206d 656d 6f72 792c 2069 6620   for memory, if 
-000176f0: 736f 2c20 636c 6561 720a 2020 2020 2020  so, clear.      
-00017700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017710: 2020 2020 2020 6966 2070 7269 6f72 6974        if priorit
-00017720: 7920 3d3d 2027 6d65 6d27 3a0a 0a20 2020  y == 'mem':..   
-00017730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017740: 2020 2020 2020 2020 2020 2020 2023 7072               #pr
-00017750: 696e 7428 6368 616e 6e65 6c20 2b20 223a  int(channel + ":
-00017760: 2063 6c65 6172 696e 6720 6368 616e 6e65   clearing channe
-00017770: 6c20 6672 6f6d 206d 656d 2229 0a0a 2020  l from mem")..  
-00017780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017790: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000177a0: 7265 6d6f 7665 2074 6865 2072 6566 6572  remove the refer
-000177b0: 656e 6365 2074 6f20 7468 6520 6e75 6d70  ence to the nump
-000177c0: 7920 6172 7261 792c 2074 6869 7320 7761  y array, this wa
-000177d0: 7920 7468 6520 6d65 6d6f 7279 2073 686f  y the memory sho
-000177e0: 756c 6420 6265 2061 7661 696c 6162 6c65  uld be available
-000177f0: 2066 6f72 2063 6f6c 6c65 6374 696f 6e0a   for collection.
-00017800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017820: 6368 616e 6e65 6c5f 6461 7461 5b63 6861  channel_data[cha
-00017830: 6e6e 656c 5d20 3d20 4e6f 6e65 0a20 2020  nnel] = None.   
+00017550: 2020 6368 616e 6e65 6c5f 6461 7461 5b63    channel_data[c
+00017560: 6861 6e6e 656c 5d20 2d3d 2065 6172 6c79  hannel] -= early
+00017570: 5f67 726f 7570 5f64 6174 615b 7374 7228  _group_data[str(
+00017580: 6772 6f75 7029 5d0a 0a20 2020 2020 2020  group)]..       
+00017590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175a0: 2020 2020 2023 2073 6574 2065 6172 6c79       # set early
+000175b0: 2072 652d 7265 6665 7265 6e63 696e 6720   re-referencing 
+000175c0: 6173 2074 6f20 6861 7665 2062 6565 6e20  as to have been 
+000175d0: 6170 706c 6965 6420 746f 2074 6865 2063  applied to the c
+000175e0: 6861 6e6e 656c 2d64 6174 6120 696e 206d  hannel-data in m
+000175f0: 656d 6f72 790a 2020 2020 2020 2020 2020  emory.          
+00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017610: 2020 6368 616e 6e65 6c5f 6561 726c 795f    channel_early_
+00017620: 6170 706c 6965 645b 6368 616e 6e65 6c5d  applied[channel]
+00017630: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
+00017640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017650: 2020 2020 2023 2054 4f44 4f3a 2069 6620       # TODO: if 
+00017660: 7468 6973 2069 7320 7468 6520 6c61 7465  this is the late
+00017670: 7374 2063 6861 6e6e 656c 2074 6f20 7573  st channel to us
+00017680: 6520 7468 6520 6561 726c 7920 6772 6f75  e the early grou
+00017690: 7020 6176 6572 6167 652c 2073 6565 2069  p average, see i
+000176a0: 6620 7765 2063 616e 2073 6166 656c 7920  f we can safely 
+000176b0: 636c 6561 7220 7468 6520 6772 6f75 7020  clear the group 
+000176c0: 6176 6572 6167 6520 6172 7261 790a 2020  average array.  
+000176d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176e0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+000176f0: 2020 6e6f 7465 2074 6861 7420 6561 726c    note that earl
+00017700: 7920 7265 2d72 6566 2064 6174 6120 7374  y re-ref data st
+00017710: 696c 6c20 6d69 6768 7420 6265 206e 6565  ill might be nee
+00017720: 6465 6420 6174 206c 6174 6520 7265 2d72  ded at late re-r
+00017730: 6566 0a0a 0a20 2020 2020 2020 2020 2020  ef...           
+00017740: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00017750: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00017760: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017770: 206e 6f74 2061 6c6c 2072 6571 7569 7265   not all require
+00017780: 6420 696e 666f 726d 6174 696f 6e20 666f  d information fo
+00017790: 7220 6561 726c 7920 7265 2d72 6566 2069  r early re-ref i
+000177a0: 7320 6176 6169 6c61 626c 652c 2077 6520  s available, we 
+000177b0: 7769 6c6c 2068 6176 6520 746f 2077 6169  will have to wai
+000177c0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+000177d0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000177e0: 616e 2069 7465 7261 7469 6f6e 2028 6f76  an iteration (ov
+000177f0: 6572 2074 6865 2072 6573 7420 6f66 2074  er the rest of t
+00017800: 6865 2063 6861 6e6e 656c 7329 2066 6f72  he channels) for
+00017810: 2074 6865 2069 6e66 6f72 6d61 7469 6f6e   the information
+00017820: 2074 6f20 6265 636f 6d65 2061 7661 696c   to become avail
+00017830: 6162 6c65 0a0a 2020 2020 2020 2020 2020  able..          
 00017840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017850: 2020 2020 2020 2020 2020 2020 2067 632e               gc.
-00017860: 636f 6c6c 6563 7428 290a 0a20 2020 2020  collect()..     
-00017870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017880: 2020 2020 2020 2020 2020 2023 2073 696e             # sin
-00017890: 6365 2077 6520 6e65 6564 2074 6f20 7265  ce we need to re
-000178a0: 6c6f 6164 2074 6865 2063 6861 6e6e 656c  load the channel
-000178b0: 2074 6865 206e 6578 7420 6974 6572 6174   the next iterat
-000178c0: 696f 6e2c 2077 6520 7769 6c6c 2061 6c73  ion, we will als
-000178d0: 6f20 6861 7665 2074 6f20 6869 6768 2d70  o have to high-p
-000178e0: 6173 7320 6974 2061 6761 696e 0a20 2020  ass it again.   
-000178f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017900: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-00017910: 6e6e 656c 5f68 705f 6170 706c 6965 645b  nnel_hp_applied[
-00017920: 6368 616e 6e65 6c5d 203d 2046 616c 7365  channel] = False
-00017930: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00017940: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017950: 636f 6e74 696e 7565 2074 6f20 7468 6520  continue to the 
-00017960: 6e65 7874 2063 6861 6e6e 656c 0a20 2020  next channel.   
-00017970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017980: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00017990: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-000179a0: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
-000179b0: 2020 2020 2023 204c 696e 6520 6e6f 6973       # Line nois
-000179c0: 6520 7265 6d6f 7661 6c0a 2020 2020 2020  e removal.      
-000179d0: 2020 2020 2020 2020 2020 230a 2020 2020            #.    
-000179e0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-000179f0: 696e 655f 6e6f 6973 655f 7265 6d6f 7661  ine_noise_remova
-00017a00: 6c20 6973 206e 6f74 204e 6f6e 6520 616e  l is not None an
-00017a10: 6420 6e6f 7420 6368 616e 6e65 6c5f 6c6e  d not channel_ln
-00017a20: 725f 6170 706c 6965 645b 6368 616e 6e65  r_applied[channe
-00017a30: 6c5d 3a0a 0a20 2020 2020 2020 2020 2020  l]:..           
-00017a40: 2020 2020 2020 2020 2023 7072 696e 7428           #print(
-00017a50: 6368 616e 6e65 6c20 2b20 223a 204c 4e52  channel + ": LNR
-00017a60: 202d 2022 202b 2073 7472 286c 696e 655f   - " + str(line_
-00017a70: 6e6f 6973 655f 7265 6d6f 7661 6c29 290a  noise_removal)).
-00017a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017a90: 2020 2020 2023 2046 696c 7465 7220 7468       # Filter th
-00017aa0: 6520 6461 7461 0a20 2020 2020 2020 2020  e data.         
-00017ab0: 2020 2020 2020 2020 2020 2063 6861 6e6e             chann
-00017ac0: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
-00017ad0: 203d 2073 6967 6e61 6c2e 6669 6c74 6669   = signal.filtfi
-00017ae0: 6c74 286c 6e72 5f6e 756d 6572 6174 6f72  lt(lnr_numerator
-00017af0: 2c20 6c6e 725f 6465 6e6f 6d69 6e61 746f  , lnr_denominato
-00017b00: 722c 2063 6861 6e6e 656c 5f64 6174 615b  r, channel_data[
-00017b10: 6368 616e 6e65 6c5d 2c20 7061 6474 7970  channel], padtyp
-00017b20: 653d 276f 6464 272c 2070 6164 6c65 6e3d  e='odd', padlen=
-00017b30: 3320 2a20 286d 6178 286c 656e 286c 6e72  3 * (max(len(lnr
-00017b40: 5f6e 756d 6572 6174 6f72 292c 206c 656e  _numerator), len
-00017b50: 286c 6e72 5f64 656e 6f6d 696e 6174 6f72  (lnr_denominator
-00017b60: 2929 202d 2031 2929 0a0a 2020 2020 2020  )) - 1))..      
-00017b70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017b80: 7365 7420 6c69 6e65 206e 6f69 7365 2072  set line noise r
-00017b90: 656d 6f76 616c 2074 6f20 6861 7665 2062  emoval to have b
-00017ba0: 6565 6e20 6170 706c 6965 6420 746f 2074  een applied to t
-00017bb0: 6865 2063 6861 6e6e 656c 2d64 6174 6120  he channel-data 
-00017bc0: 696e 206d 656d 6f72 790a 2020 2020 2020  in memory.      
-00017bd0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00017be0: 616e 6e65 6c5f 6c6e 725f 6170 706c 6965  annel_lnr_applie
-00017bf0: 645b 6368 616e 6e65 6c5d 203d 2054 7275  d[channel] = Tru
-00017c00: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-00017c10: 2020 2023 0a20 2020 2020 2020 2020 2020     #.           
-00017c20: 2020 2020 2023 204c 6174 6520 7265 2d72       # Late re-r
-00017c30: 6566 6572 656e 6369 6e67 0a20 2020 2020  eferencing.     
-00017c40: 2020 2020 2020 2020 2020 2023 0a0a 2020             #..  
-00017c50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00017c60: 6368 6563 6b20 6966 206c 6174 6520 7265  check if late re
-00017c70: 2d72 6566 6572 656e 6369 6e67 206e 6565  -referencing nee
-00017c80: 6465 640a 2020 2020 2020 2020 2020 2020  ded.            
-00017c90: 2020 2020 6966 206c 6174 655f 7265 7265      if late_rere
-00017ca0: 6620 6973 206e 6f74 204e 6f6e 653a 0a0a  f is not None:..
-00017cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017cc0: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
-00017cd0: 2020 2020 2020 2020 2020 2320 4c61 7465            # Late
-00017ce0: 2072 652d 7265 6665 7265 6e63 696e 6720   re-referencing 
-00017cf0: 636f 6c6c 6563 740a 2020 2020 2020 2020  collect.        
-00017d00: 2020 2020 2020 2020 2020 2020 230a 0a20              #.. 
-00017d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017d20: 2020 2023 2063 6865 636b 2069 6620 7468     # check if th
-00017d30: 6520 6461 7461 206f 6620 7468 6973 2063  e data of this c
-00017d40: 6861 6e6e 656c 2028 6174 2074 6869 7320  hannel (at this 
-00017d50: 706f 696e 7429 2069 7320 616c 7265 6164  point) is alread
-00017d60: 7920 636f 6c6c 6563 7465 6420 666f 7220  y collected for 
-00017d70: 7468 6520 6c61 7465 2072 652d 7265 6665  the late re-refe
-00017d80: 7265 6e63 6520 6772 6f75 7073 0a20 2020  rence groups.   
-00017d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017da0: 2069 6620 6e6f 7420 6368 616e 6e65 6c5f   if not channel_
-00017db0: 6c61 7465 5f72 6572 6566 5f63 6f6c 6c65  late_reref_colle
-00017dc0: 6374 6564 5b63 6861 6e6e 656c 5d3a 0a20  cted[channel]:. 
-00017dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017de0: 2020 2020 2020 2023 206c 6174 6520 6e6f         # late no
-00017df0: 7420 636f 6c6c 6563 7465 640a 2020 2020  t collected.    
-00017e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e10: 2020 2020 2370 7269 6e74 2863 6861 6e6e      #print(chann
-00017e20: 656c 202b 2022 3a20 436f 6c6c 6563 7469  el + ": Collecti
-00017e30: 6e67 206c 6174 6520 7265 7265 6620 7661  ng late reref va
-00017e40: 6c75 6573 2066 726f 6d20 6368 616e 6e65  lues from channe
-00017e50: 6c22 290a 0a20 2020 2020 2020 2020 2020  l")..           
-00017e60: 2020 2020 2020 2020 2020 2020 2023 206c               # l
-00017e70: 6f6f 7020 6f76 6572 2074 6865 206c 6174  oop over the lat
-00017e80: 652d 7265 7265 6620 6772 6f75 7073 0a20  e-reref groups. 
-00017e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ea0: 2020 2020 2020 2066 6f72 2067 726f 7570         for group
-00017eb0: 2069 6e20 6c61 7465 5f72 6571 5f67 726f   in late_req_gro
-00017ec0: 7570 733a 0a0a 2020 2020 2020 2020 2020  ups:..          
-00017ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017ee0: 2020 2320 6368 6563 6b20 6966 2074 6869    # check if thi
-00017ef0: 7320 6772 6f75 7020 7265 7175 6972 6573  s group requires
-00017f00: 2074 6869 7320 6368 616e 6e65 6c0a 2020   this channel.  
-00017f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f20: 2020 2020 2020 2020 2020 6966 2063 6861            if cha
-00017f30: 6e6e 656c 2069 6e20 6c61 7465 5f67 726f  nnel in late_gro
-00017f40: 7570 5f63 6861 6e6e 656c 735f 636f 6c6c  up_channels_coll
-00017f50: 6563 7465 645b 7374 7228 6772 6f75 7029  ected[str(group)
-00017f60: 5d2e 6b65 7973 2829 3a0a 0a20 2020 2020  ].keys():..     
-00017f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f80: 2020 2020 2020 2020 2020 2023 2063 7265             # cre
-00017f90: 6174 6520 6172 7261 7973 2074 6f20 686f  ate arrays to ho
-00017fa0: 6c64 2074 6865 2067 726f 7570 2064 6174  ld the group dat
-00017fb0: 6120 6966 206e 6f74 2079 6574 2069 6e69  a if not yet ini
-00017fc0: 7469 616c 697a 6564 0a20 2020 2020 2020  tialized.       
-00017fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017fe0: 2020 2020 2020 2020 2069 6620 6c61 7465           if late
-00017ff0: 5f67 726f 7570 5f64 6174 615b 7374 7228  _group_data[str(
-00018000: 6772 6f75 7029 5d20 6973 204e 6f6e 653a  group)] is None:
-00018010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017850: 2020 2320 6368 6563 6b20 7768 6574 6865    # check whethe
+00017860: 7220 6974 2069 7320 6f70 7469 6d69 7a65  r it is optimize
+00017870: 6420 666f 7220 6d65 6d6f 7279 2c20 6966  d for memory, if
+00017880: 2073 6f2c 2063 6c65 6172 0a20 2020 2020   so, clear.     
+00017890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178a0: 2020 2020 2020 2069 6620 7072 696f 7269         if priori
+000178b0: 7479 203d 3d20 276d 656d 273a 0a0a 2020  ty == 'mem':..  
+000178c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000178d0: 2020 2020 2020 2020 2020 2020 2020 2370                #p
+000178e0: 7269 6e74 2863 6861 6e6e 656c 202b 2022  rint(channel + "
+000178f0: 3a20 636c 6561 7269 6e67 2063 6861 6e6e  : clearing chann
+00017900: 656c 2066 726f 6d20 6d65 6d22 290a 0a20  el from mem").. 
+00017910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017920: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017930: 2072 656d 6f76 6520 7468 6520 7265 6665   remove the refe
+00017940: 7265 6e63 6520 746f 2074 6865 206e 756d  rence to the num
+00017950: 7079 2061 7272 6179 2c20 7468 6973 2077  py array, this w
+00017960: 6179 2074 6865 206d 656d 6f72 7920 7368  ay the memory sh
+00017970: 6f75 6c64 2062 6520 6176 6169 6c61 626c  ould be availabl
+00017980: 6520 666f 7220 636f 6c6c 6563 7469 6f6e  e for collection
+00017990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000179a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179b0: 2063 6861 6e6e 656c 5f64 6174 615b 6368   channel_data[ch
+000179c0: 616e 6e65 6c5d 203d 204e 6f6e 650a 2020  annel] = None.  
+000179d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179e0: 2020 2020 2020 2020 2020 2020 2020 6763                gc
+000179f0: 2e63 6f6c 6c65 6374 2829 0a0a 2020 2020  .collect()..    
+00017a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a10: 2020 2020 2020 2020 2020 2020 2320 7369              # si
+00017a20: 6e63 6520 7765 206e 6565 6420 746f 2072  nce we need to r
+00017a30: 656c 6f61 6420 7468 6520 6368 616e 6e65  eload the channe
+00017a40: 6c20 7468 6520 6e65 7874 2069 7465 7261  l the next itera
+00017a50: 7469 6f6e 2c20 7765 2077 696c 6c20 616c  tion, we will al
+00017a60: 736f 2068 6176 6520 746f 2068 6967 682d  so have to high-
+00017a70: 7061 7373 2069 7420 6167 6169 6e0a 2020  pass it again.  
+00017a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a90: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00017aa0: 616e 6e65 6c5f 6870 5f61 7070 6c69 6564  annel_hp_applied
+00017ab0: 5b63 6861 6e6e 656c 5d20 3d20 4661 6c73  [channel] = Fals
+00017ac0: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+00017ad0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017ae0: 2063 6f6e 7469 6e75 6520 746f 2074 6865   continue to the
+00017af0: 206e 6578 7420 6368 616e 6e65 6c0a 2020   next channel.  
+00017b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017b10: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00017b20: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00017b30: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
+00017b40: 2020 2020 2020 2320 4c69 6e65 206e 6f69        # Line noi
+00017b50: 7365 2072 656d 6f76 616c 0a20 2020 2020  se removal.     
+00017b60: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+00017b70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00017b80: 6c69 6e65 5f6e 6f69 7365 5f72 656d 6f76  line_noise_remov
+00017b90: 616c 2069 7320 6e6f 7420 4e6f 6e65 2061  al is not None a
+00017ba0: 6e64 206e 6f74 2063 6861 6e6e 656c 5f6c  nd not channel_l
+00017bb0: 6e72 5f61 7070 6c69 6564 5b63 6861 6e6e  nr_applied[chann
+00017bc0: 656c 5d3a 0a0a 2020 2020 2020 2020 2020  el]:..          
+00017bd0: 2020 2020 2020 2020 2020 2370 7269 6e74            #print
+00017be0: 2863 6861 6e6e 656c 202b 2022 3a20 4c4e  (channel + ": LN
+00017bf0: 5220 2d20 2220 2b20 7374 7228 6c69 6e65  R - " + str(line
+00017c00: 5f6e 6f69 7365 5f72 656d 6f76 616c 2929  _noise_removal))
+00017c10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00017c20: 2020 2020 2020 2320 4669 6c74 6572 2074        # Filter t
+00017c30: 6865 2064 6174 610a 2020 2020 2020 2020  he data.        
+00017c40: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00017c50: 6e65 6c5f 6461 7461 5b63 6861 6e6e 656c  nel_data[channel
+00017c60: 5d20 3d20 7369 676e 616c 2e66 696c 7466  ] = signal.filtf
+00017c70: 696c 7428 6c6e 725f 6e75 6d65 7261 746f  ilt(lnr_numerato
+00017c80: 722c 206c 6e72 5f64 656e 6f6d 696e 6174  r, lnr_denominat
+00017c90: 6f72 2c20 6368 616e 6e65 6c5f 6461 7461  or, channel_data
+00017ca0: 5b63 6861 6e6e 656c 5d2c 2070 6164 7479  [channel], padty
+00017cb0: 7065 3d27 6f64 6427 2c20 7061 646c 656e  pe='odd', padlen
+00017cc0: 3d33 202a 2028 6d61 7828 6c65 6e28 6c6e  =3 * (max(len(ln
+00017cd0: 725f 6e75 6d65 7261 746f 7229 2c20 6c65  r_numerator), le
+00017ce0: 6e28 6c6e 725f 6465 6e6f 6d69 6e61 746f  n(lnr_denominato
+00017cf0: 7229 2920 2d20 3129 290a 0a20 2020 2020  r)) - 1))..     
+00017d00: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017d10: 2073 6574 206c 696e 6520 6e6f 6973 6520   set line noise 
+00017d20: 7265 6d6f 7661 6c20 746f 2068 6176 6520  removal to have 
+00017d30: 6265 656e 2061 7070 6c69 6564 2074 6f20  been applied to 
+00017d40: 7468 6520 6368 616e 6e65 6c2d 6461 7461  the channel-data
+00017d50: 2069 6e20 6d65 6d6f 7279 0a20 2020 2020   in memory.     
+00017d60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00017d70: 6861 6e6e 656c 5f6c 6e72 5f61 7070 6c69  hannel_lnr_appli
+00017d80: 6564 5b63 6861 6e6e 656c 5d20 3d20 5472  ed[channel] = Tr
+00017d90: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00017da0: 2020 2020 230a 2020 2020 2020 2020 2020      #.          
+00017db0: 2020 2020 2020 2320 4c61 7465 2072 652d        # Late re-
+00017dc0: 7265 6665 7265 6e63 696e 670a 2020 2020  referencing.    
+00017dd0: 2020 2020 2020 2020 2020 2020 230a 0a20              #.. 
+00017de0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017df0: 2063 6865 636b 2069 6620 6c61 7465 2072   check if late r
+00017e00: 652d 7265 6665 7265 6e63 696e 6720 6e65  e-referencing ne
+00017e10: 6564 6564 0a20 2020 2020 2020 2020 2020  eded.           
+00017e20: 2020 2020 2069 6620 6c61 7465 5f72 6572       if late_rer
+00017e30: 6566 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ef is not None:.
+00017e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017e50: 2020 2020 2023 0a20 2020 2020 2020 2020       #.         
+00017e60: 2020 2020 2020 2020 2020 2023 204c 6174             # Lat
+00017e70: 6520 7265 2d72 6566 6572 656e 6369 6e67  e re-referencing
+00017e80: 2063 6f6c 6c65 6374 0a20 2020 2020 2020   collect.       
+00017e90: 2020 2020 2020 2020 2020 2020 2023 0a0a               #..
+00017ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017eb0: 2020 2020 2320 6368 6563 6b20 6966 2074      # check if t
+00017ec0: 6865 2064 6174 6120 6f66 2074 6869 7320  he data of this 
+00017ed0: 6368 616e 6e65 6c20 2861 7420 7468 6973  channel (at this
+00017ee0: 2070 6f69 6e74 2920 6973 2061 6c72 6561   point) is alrea
+00017ef0: 6479 2063 6f6c 6c65 6374 6564 2066 6f72  dy collected for
+00017f00: 2074 6865 206c 6174 6520 7265 2d72 6566   the late re-ref
+00017f10: 6572 656e 6365 2067 726f 7570 730a 2020  erence groups.  
+00017f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f30: 2020 6966 206e 6f74 2063 6861 6e6e 656c    if not channel
+00017f40: 5f6c 6174 655f 7265 7265 665f 636f 6c6c  _late_reref_coll
+00017f50: 6563 7465 645b 6368 616e 6e65 6c5d 3a0a  ected[channel]:.
+00017f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f70: 2020 2020 2020 2020 2320 6c61 7465 206e          # late n
+00017f80: 6f74 2063 6f6c 6c65 6374 6564 0a20 2020  ot collected.   
+00017f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fa0: 2020 2020 2023 7072 696e 7428 6368 616e       #print(chan
+00017fb0: 6e65 6c20 2b20 223a 2043 6f6c 6c65 6374  nel + ": Collect
+00017fc0: 696e 6720 6c61 7465 2072 6572 6566 2076  ing late reref v
+00017fd0: 616c 7565 7320 6672 6f6d 2063 6861 6e6e  alues from chann
+00017fe0: 656c 2229 0a0a 2020 2020 2020 2020 2020  el")..          
+00017ff0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00018000: 6c6f 6f70 206f 7665 7220 7468 6520 6c61  loop over the la
+00018010: 7465 2d72 6572 6566 2067 726f 7570 730a  te-reref groups.
 00018020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018030: 2020 2020 206c 6174 655f 6772 6f75 705f       late_group_
-00018040: 6461 7461 5b73 7472 2867 726f 7570 295d  data[str(group)]
-00018050: 203d 206e 702e 7a65 726f 7328 286c 656e   = np.zeros((len
-00018060: 2863 6861 6e6e 656c 5f64 6174 615b 6368  (channel_data[ch
-00018070: 616e 6e65 6c5d 292c 292c 2064 7479 7065  annel]),), dtype
-00018080: 3d6e 702e 666c 6f61 7436 3429 0a20 2020  =np.float64).   
-00018090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018030: 2020 2020 2020 2020 666f 7220 6772 6f75          for grou
+00018040: 7020 696e 206c 6174 655f 7265 715f 6772  p in late_req_gr
+00018050: 6f75 7073 3a0a 0a20 2020 2020 2020 2020  oups:..         
+00018060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018070: 2020 2023 2063 6865 636b 2069 6620 7468     # check if th
+00018080: 6973 2067 726f 7570 2072 6571 7569 7265  is group require
+00018090: 7320 7468 6973 2063 6861 6e6e 656c 0a20  s this channel. 
 000180a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000180b0: 2069 6620 6c61 7465 5f72 6572 6566 2e63   if late_reref.c
-000180c0: 6861 6e6e 656c 5f65 7863 6c75 6465 5f65  hannel_exclude_e
-000180d0: 706f 6368 7320 6973 206e 6f74 204e 6f6e  pochs is not Non
-000180e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000180f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018100: 2020 2020 2020 2020 2020 206c 6174 655f             late_
-00018110: 6772 6f75 705f 6e75 6d64 6174 615b 7374  group_numdata[st
-00018120: 7228 6772 6f75 7029 5d20 3d20 6e70 2e7a  r(group)] = np.z
-00018130: 6572 6f73 2828 6c65 6e28 6368 616e 6e65  eros((len(channe
-00018140: 6c5f 6461 7461 5b63 6861 6e6e 656c 5d29  l_data[channel])
-00018150: 2c29 2c20 6474 7970 653d 6e70 2e75 696e  ,), dtype=np.uin
-00018160: 7431 3629 0a0a 2020 2020 2020 2020 2020  t16)..          
-00018170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018180: 2020 2020 2020 2320 6164 6420 746f 2067        # add to g
-00018190: 726f 7570 2064 6174 610a 2020 2020 2020  roup data.      
-000181a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000181b0: 2020 2020 2020 2020 2020 6966 206c 6174            if lat
-000181c0: 655f 7265 7265 662e 6368 616e 6e65 6c5f  e_reref.channel_
-000181d0: 6578 636c 7564 655f 6570 6f63 6873 2069  exclude_epochs i
-000181e0: 7320 4e6f 6e65 206f 7220 6368 616e 6e65  s None or channe
-000181f0: 6c20 6e6f 7420 696e 206c 6174 655f 7265  l not in late_re
-00018200: 7265 662e 6368 616e 6e65 6c5f 6578 636c  ref.channel_excl
-00018210: 7564 655f 6570 6f63 6873 3a0a 0a20 2020  ude_epochs:..   
+000180b0: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
+000180c0: 616e 6e65 6c20 696e 206c 6174 655f 6772  annel in late_gr
+000180d0: 6f75 705f 6368 616e 6e65 6c73 5f63 6f6c  oup_channels_col
+000180e0: 6c65 6374 6564 5b73 7472 2867 726f 7570  lected[str(group
+000180f0: 295d 2e6b 6579 7328 293a 0a0a 2020 2020  )].keys():..    
+00018100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018110: 2020 2020 2020 2020 2020 2020 2320 6372              # cr
+00018120: 6561 7465 2061 7272 6179 7320 746f 2068  eate arrays to h
+00018130: 6f6c 6420 7468 6520 6772 6f75 7020 6461  old the group da
+00018140: 7461 2069 6620 6e6f 7420 7965 7420 696e  ta if not yet in
+00018150: 6974 6961 6c69 7a65 640a 2020 2020 2020  itialized.      
+00018160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018170: 2020 2020 2020 2020 2020 6966 206c 6174            if lat
+00018180: 655f 6772 6f75 705f 6461 7461 5b73 7472  e_group_data[str
+00018190: 2867 726f 7570 295d 2069 7320 4e6f 6e65  (group)] is None
+000181a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000181b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181c0: 2020 2020 2020 6c61 7465 5f67 726f 7570        late_group
+000181d0: 5f64 6174 615b 7374 7228 6772 6f75 7029  _data[str(group)
+000181e0: 5d20 3d20 6e70 2e7a 6572 6f73 2828 6c65  ] = np.zeros((le
+000181f0: 6e28 6368 616e 6e65 6c5f 6461 7461 5b63  n(channel_data[c
+00018200: 6861 6e6e 656c 5d29 2c29 2c20 6474 7970  hannel]),), dtyp
+00018210: 653d 6e70 2e66 6c6f 6174 3634 290a 2020  e=np.float64).  
 00018220: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018240: 2023 206e 6f20 6578 636c 7573 696f 6e20   # no exclusion 
-00018250: 6570 6f63 6873 2c20 6a75 7374 2061 6464  epochs, just add
-00018260: 2074 6865 2077 686f 6c65 2063 6861 6e6e   the whole chann
-00018270: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
+00018240: 2020 6966 206c 6174 655f 7265 7265 662e    if late_reref.
+00018250: 6368 616e 6e65 6c5f 6578 636c 7564 655f  channel_exclude_
+00018260: 6570 6f63 6873 2069 7320 6e6f 7420 4e6f  epochs is not No
+00018270: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
 00018280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018290: 2020 2020 2020 206c 6174 655f 6772 6f75         late_grou
-000182a0: 705f 6461 7461 5b73 7472 2867 726f 7570  p_data[str(group
-000182b0: 295d 202b 3d20 6368 616e 6e65 6c5f 6461  )] += channel_da
-000182c0: 7461 5b63 6861 6e6e 656c 5d0a 0a20 2020  ta[channel]..   
-000182d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000182f0: 2023 2063 6f75 6e74 2074 6865 206e 756d   # count the num
-00018300: 6265 7220 6f66 2073 616d 706c 6573 2061  ber of samples a
-00018310: 6464 6564 2074 6f20 7468 6520 746f 7461  dded to the tota
-00018320: 6c20 6966 206e 6565 6465 640a 2020 2020  l if needed.    
+00018290: 2020 2020 2020 2020 2020 2020 6c61 7465              late
+000182a0: 5f67 726f 7570 5f6e 756d 6461 7461 5b73  _group_numdata[s
+000182b0: 7472 2867 726f 7570 295d 203d 206e 702e  tr(group)] = np.
+000182c0: 7a65 726f 7328 286c 656e 2863 6861 6e6e  zeros((len(chann
+000182d0: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
+000182e0: 292c 292c 2064 7479 7065 3d6e 702e 7569  ),), dtype=np.ui
+000182f0: 6e74 3136 290a 0a20 2020 2020 2020 2020  nt16)..         
+00018300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018310: 2020 2020 2020 2023 2061 6464 2074 6f20         # add to 
+00018320: 6772 6f75 7020 6461 7461 0a20 2020 2020  group data.     
 00018330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018350: 6966 206c 6174 655f 7265 7265 662e 6368  if late_reref.ch
-00018360: 616e 6e65 6c5f 6578 636c 7564 655f 6570  annel_exclude_ep
-00018370: 6f63 6873 2069 7320 6e6f 7420 4e6f 6e65  ochs is not None
-00018380: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183a0: 2020 2020 2020 2020 2020 6c61 7465 5f67            late_g
-000183b0: 726f 7570 5f6e 756d 6461 7461 5b73 7472  roup_numdata[str
-000183c0: 2867 726f 7570 295d 202b 3d20 310a 0a20  (group)] += 1.. 
-000183d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000183e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000183f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018410: 2020 2020 2020 2020 2023 2063 6861 6e6e           # chann
-00018420: 656c 2068 6173 2065 7863 6c75 7369 6f6e  el has exclusion
-00018430: 2065 706f 6368 730a 0a20 2020 2020 2020   epochs..       
-00018440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018450: 2020 2020 2020 2020 2020 2020 2023 2063               # c
-00018460: 7265 6174 6520 6120 6269 6e61 7279 206e  reate a binary n
-00018470: 756d 7079 2076 6563 746f 7220 6f66 2074  umpy vector of t
-00018480: 6865 2073 616d 706c 6520 746f 2069 6e63  he sample to inc
-00018490: 6c75 6465 0a20 2020 2020 2020 2020 2020  lude.           
-000184a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184b0: 2020 2020 2020 2020 2063 6861 6e6e 656c           channel
-000184c0: 5f69 6e63 6c75 6465 7320 3d20 6e70 2e6f  _includes = np.o
-000184d0: 6e65 7328 286c 656e 2863 6861 6e6e 656c  nes((len(channel
-000184e0: 5f64 6174 615b 6368 616e 6e65 6c5d 292c  _data[channel]),
-000184f0: 292c 2064 7479 7065 3d6e 702e 626f 6f6c  ), dtype=np.bool
-00018500: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00018510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018520: 2020 2020 2020 666f 7220 6368 616e 6e65        for channe
-00018530: 6c5f 6578 636c 7564 655f 6570 6f63 6820  l_exclude_epoch 
-00018540: 696e 206c 6174 655f 7265 7265 662e 6368  in late_reref.ch
-00018550: 616e 6e65 6c5f 6578 636c 7564 655f 6570  annel_exclude_ep
-00018560: 6f63 6873 5b63 6861 6e6e 656c 5d3a 0a20  ochs[channel]:. 
+00018340: 2020 2020 2020 2020 2020 2069 6620 6c61             if la
+00018350: 7465 5f72 6572 6566 2e63 6861 6e6e 656c  te_reref.channel
+00018360: 5f65 7863 6c75 6465 5f65 706f 6368 7320  _exclude_epochs 
+00018370: 6973 204e 6f6e 6520 6f72 2063 6861 6e6e  is None or chann
+00018380: 656c 206e 6f74 2069 6e20 6c61 7465 5f72  el not in late_r
+00018390: 6572 6566 2e63 6861 6e6e 656c 5f65 7863  eref.channel_exc
+000183a0: 6c75 6465 5f65 706f 6368 733a 0a0a 2020  lude_epochs:..  
+000183b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000183c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000183d0: 2020 2320 6e6f 2065 7863 6c75 7369 6f6e    # no exclusion
+000183e0: 2065 706f 6368 732c 206a 7573 7420 6164   epochs, just ad
+000183f0: 6420 7468 6520 7768 6f6c 6520 6368 616e  d the whole chan
+00018400: 6e65 6c0a 2020 2020 2020 2020 2020 2020  nel.            
+00018410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018420: 2020 2020 2020 2020 6c61 7465 5f67 726f          late_gro
+00018430: 7570 5f64 6174 615b 7374 7228 6772 6f75  up_data[str(grou
+00018440: 7029 5d20 2b3d 2063 6861 6e6e 656c 5f64  p)] += channel_d
+00018450: 6174 615b 6368 616e 6e65 6c5d 0a0a 2020  ata[channel]..  
+00018460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018480: 2020 2320 636f 756e 7420 7468 6520 6e75    # count the nu
+00018490: 6d62 6572 206f 6620 7361 6d70 6c65 7320  mber of samples 
+000184a0: 6164 6465 6420 746f 2074 6865 2074 6f74  added to the tot
+000184b0: 616c 2069 6620 6e65 6564 6564 0a20 2020  al if needed.   
+000184c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184e0: 2069 6620 6c61 7465 5f72 6572 6566 2e63   if late_reref.c
+000184f0: 6861 6e6e 656c 5f65 7863 6c75 6465 5f65  hannel_exclude_e
+00018500: 706f 6368 7320 6973 206e 6f74 204e 6f6e  pochs is not Non
+00018510: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00018520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018530: 2020 2020 2020 2020 2020 206c 6174 655f             late_
+00018540: 6772 6f75 705f 6e75 6d64 6174 615b 7374  group_numdata[st
+00018550: 7228 6772 6f75 7029 5d20 2b3d 2031 0a0a  r(group)] += 1..
+00018560: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018590: 2020 2020 2020 2065 7863 6c75 6465 5f73         exclude_s
-000185a0: 616d 706c 655f 7374 6172 7420 3d20 696e  ample_start = in
-000185b0: 7428 726f 756e 6428 6368 616e 6e65 6c5f  t(round(channel_
-000185c0: 6578 636c 7564 655f 6570 6f63 685b 305d  exclude_epoch[0]
-000185d0: 202a 2064 6174 615f 7265 6164 6572 2e73   * data_reader.s
-000185e0: 616d 706c 696e 675f 7261 7465 2929 0a20  ampling_rate)). 
-000185f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018610: 2020 2020 2020 2065 7863 6c75 6465 5f73         exclude_s
-00018620: 616d 706c 655f 656e 6420 3d20 696e 7428  ample_end = int(
-00018630: 726f 756e 6428 6368 616e 6e65 6c5f 6578  round(channel_ex
-00018640: 636c 7564 655f 6570 6f63 685b 315d 202a  clude_epoch[1] *
-00018650: 2064 6174 615f 7265 6164 6572 2e73 616d   data_reader.sam
-00018660: 706c 696e 675f 7261 7465 2929 0a20 2020  pling_rate)).   
-00018670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018690: 2020 2020 2063 6861 6e6e 656c 5f69 6e63       channel_inc
-000186a0: 6c75 6465 735b 6578 636c 7564 655f 7361  ludes[exclude_sa
-000186b0: 6d70 6c65 5f73 7461 7274 3a65 7863 6c75  mple_start:exclu
-000186c0: 6465 5f73 616d 706c 655f 656e 645d 203d  de_sample_end] =
-000186d0: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
-000186e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186f0: 2020 2020 2020 2020 2320 6164 6420 7468          # add th
-00018700: 6520 6368 616e 6e65 6c20 2874 616b 696e  e channel (takin
-00018710: 6720 696e 746f 2061 6363 6f75 6e74 206f  g into account o
-00018720: 6e20 7468 6520 696e 636c 7573 696f 6e20  n the inclusion 
-00018730: 7665 6374 6f72 290a 2020 2020 2020 2020  vector).        
-00018740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018750: 2020 2020 2020 2020 2020 2020 6c61 7465              late
-00018760: 5f67 726f 7570 5f64 6174 615b 7374 7228  _group_data[str(
-00018770: 6772 6f75 7029 5d20 2b3d 2028 6368 616e  group)] += (chan
-00018780: 6e65 6c5f 6461 7461 5b63 6861 6e6e 656c  nel_data[channel
-00018790: 5d20 2a20 6368 616e 6e65 6c5f 696e 636c  ] * channel_incl
-000187a0: 7564 6573 290a 2020 2020 2020 2020 2020  udes).          
-000187b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000187c0: 2020 2020 2020 2020 2020 6c61 7465 5f67            late_g
-000187d0: 726f 7570 5f6e 756d 6461 7461 5b73 7472  roup_numdata[str
-000187e0: 2867 726f 7570 295d 202b 3d20 6368 616e  (group)] += chan
-000187f0: 6e65 6c5f 696e 636c 7564 6573 0a20 2020  nel_includes.   
+00018580: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00018590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185a0: 2020 2020 2020 2020 2020 2320 6368 616e            # chan
+000185b0: 6e65 6c20 6861 7320 6578 636c 7573 696f  nel has exclusio
+000185c0: 6e20 6570 6f63 6873 0a0a 2020 2020 2020  n epochs..      
+000185d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000185f0: 6372 6561 7465 2061 2062 696e 6172 7920  create a binary 
+00018600: 6e75 6d70 7920 7665 6374 6f72 206f 6620  numpy vector of 
+00018610: 7468 6520 7361 6d70 6c65 2074 6f20 696e  the sample to in
+00018620: 636c 7564 650a 2020 2020 2020 2020 2020  clude.          
+00018630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018640: 2020 2020 2020 2020 2020 6368 616e 6e65            channe
+00018650: 6c5f 696e 636c 7564 6573 203d 206e 702e  l_includes = np.
+00018660: 6f6e 6573 2828 6c65 6e28 6368 616e 6e65  ones((len(channe
+00018670: 6c5f 6461 7461 5b63 6861 6e6e 656c 5d29  l_data[channel])
+00018680: 2c29 2c20 6474 7970 653d 626f 6f6c 290a  ,), dtype=bool).
+00018690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186b0: 2020 2020 666f 7220 6368 616e 6e65 6c5f      for channel_
+000186c0: 6578 636c 7564 655f 6570 6f63 6820 696e  exclude_epoch in
+000186d0: 206c 6174 655f 7265 7265 662e 6368 616e   late_reref.chan
+000186e0: 6e65 6c5f 6578 636c 7564 655f 6570 6f63  nel_exclude_epoc
+000186f0: 6873 5b63 6861 6e6e 656c 5d3a 0a20 2020  hs[channel]:.   
+00018700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018720: 2020 2020 2065 7863 6c75 6465 5f73 616d       exclude_sam
+00018730: 706c 655f 7374 6172 7420 3d20 696e 7428  ple_start = int(
+00018740: 726f 756e 6428 6368 616e 6e65 6c5f 6578  round(channel_ex
+00018750: 636c 7564 655f 6570 6f63 685b 305d 202a  clude_epoch[0] *
+00018760: 2064 6174 615f 7265 6164 6572 2e73 616d   data_reader.sam
+00018770: 706c 696e 675f 7261 7465 2929 0a20 2020  pling_rate)).   
+00018780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000187a0: 2020 2020 2065 7863 6c75 6465 5f73 616d       exclude_sam
+000187b0: 706c 655f 656e 6420 3d20 696e 7428 726f  ple_end = int(ro
+000187c0: 756e 6428 6368 616e 6e65 6c5f 6578 636c  und(channel_excl
+000187d0: 7564 655f 6570 6f63 685b 315d 202a 2064  ude_epoch[1] * d
+000187e0: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
+000187f0: 696e 675f 7261 7465 2929 0a20 2020 2020  ing_rate)).     
 00018800: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018820: 2070 6173 730a 0a20 2020 2020 2020 2020   pass..         
-00018830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018840: 2020 2020 2020 2023 2066 6c61 6720 6368         # flag ch
-00018850: 616e 6e65 6c20 7769 7468 696e 2074 6865  annel within the
-00018860: 2067 726f 7570 2061 7320 636f 6c6c 6563   group as collec
-00018870: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
-00018880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018890: 2020 2020 6c61 7465 5f67 726f 7570 5f63      late_group_c
-000188a0: 6861 6e6e 656c 735f 636f 6c6c 6563 7465  hannels_collecte
-000188b0: 645b 7374 7228 6772 6f75 7029 5d5b 6368  d[str(group)][ch
-000188c0: 616e 6e65 6c5d 203d 2054 7275 650a 0a20  annel] = True.. 
+00018820: 2020 2063 6861 6e6e 656c 5f69 6e63 6c75     channel_inclu
+00018830: 6465 735b 6578 636c 7564 655f 7361 6d70  des[exclude_samp
+00018840: 6c65 5f73 7461 7274 3a65 7863 6c75 6465  le_start:exclude
+00018850: 5f73 616d 706c 655f 656e 645d 203d 2030  _sample_end] = 0
+00018860: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00018870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018880: 2020 2020 2020 2320 6164 6420 7468 6520        # add the 
+00018890: 6368 616e 6e65 6c20 2874 616b 696e 6720  channel (taking 
+000188a0: 696e 746f 2061 6363 6f75 6e74 206f 6e20  into account on 
+000188b0: 7468 6520 696e 636c 7573 696f 6e20 7665  the inclusion ve
+000188c0: 6374 6f72 290a 2020 2020 2020 2020 2020  ctor).          
 000188d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000188e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000188f0: 2063 6865 636b 2077 6865 7468 6572 2061   check whether a
-00018900: 6c6c 2074 6865 2063 6861 6e6e 656c 7320  ll the channels 
-00018910: 696e 2074 6865 2067 726f 7570 2061 7265  in the group are
-00018920: 2063 6f6c 6c65 6374 6564 0a20 2020 2020   collected.     
-00018930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018940: 2020 2020 2020 2020 2020 2069 6620 616c             if al
-00018950: 6c28 6c61 7465 5f67 726f 7570 5f63 6861  l(late_group_cha
-00018960: 6e6e 656c 735f 636f 6c6c 6563 7465 645b  nnels_collected[
-00018970: 7374 7228 6772 6f75 7029 5d2e 7661 6c75  str(group)].valu
-00018980: 6573 2829 293a 0a0a 2020 2020 2020 2020  es()):..        
+000188e0: 2020 2020 2020 2020 2020 6c61 7465 5f67            late_g
+000188f0: 726f 7570 5f64 6174 615b 7374 7228 6772  roup_data[str(gr
+00018900: 6f75 7029 5d20 2b3d 2028 6368 616e 6e65  oup)] += (channe
+00018910: 6c5f 6461 7461 5b63 6861 6e6e 656c 5d20  l_data[channel] 
+00018920: 2a20 6368 616e 6e65 6c5f 696e 636c 7564  * channel_includ
+00018930: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00018940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018950: 2020 2020 2020 2020 6c61 7465 5f67 726f          late_gro
+00018960: 7570 5f6e 756d 6461 7461 5b73 7472 2867  up_numdata[str(g
+00018970: 726f 7570 295d 202b 3d20 6368 616e 6e65  roup)] += channe
+00018980: 6c5f 696e 636c 7564 6573 0a20 2020 2020  l_includes.     
 00018990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189a0: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
-000189b0: 6b65 2074 6865 2061 7665 7261 6765 206f  ke the average o
-000189c0: 7665 7220 7468 6520 746f 7461 6c0a 2020  ver the total.  
-000189d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189f0: 2020 2320 2869 6620 7370 6563 6966 6963    # (if specific
-00018a00: 2065 706f 6368 7320 7765 7265 2065 7863   epochs were exc
-00018a10: 6c75 6465 642c 2065 6163 6820 7361 6d70  luded, each samp
-00018a20: 6c65 2073 686f 756c 6420 6265 2064 6976  le should be div
-00018a30: 6964 6564 2062 7920 6974 7320 6f77 6e20  ided by its own 
-00018a40: 6e75 6d62 6572 290a 2020 2020 2020 2020  number).        
-00018a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a60: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00018a70: 6174 655f 7265 7265 662e 6368 616e 6e65  ate_reref.channe
-00018a80: 6c5f 6578 636c 7564 655f 6570 6f63 6873  l_exclude_epochs
-00018a90: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00018aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018ac0: 2020 2020 2020 6c61 7465 5f67 726f 7570        late_group
-00018ad0: 5f64 6174 615b 7374 7228 6772 6f75 7029  _data[str(group)
-00018ae0: 5d20 2f3d 206c 6174 655f 6772 6f75 705f  ] /= late_group_
-00018af0: 6e75 6d64 6174 615b 7374 7228 6772 6f75  numdata[str(grou
-00018b00: 7029 5d0a 0a20 2020 2020 2020 2020 2020  p)]..           
-00018b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b20: 2020 2020 2020 2020 2020 2020 2023 2063               # c
-00018b30: 6c65 6172 2074 6865 2061 7272 6179 2077  lear the array w
-00018b40: 6173 2075 7365 6420 6469 7669 6465 2074  as used divide t
-00018b50: 6865 2074 6f74 616c 2074 6f0a 2020 2020  he total to.    
+000189a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000189b0: 6173 730a 0a20 2020 2020 2020 2020 2020  ass..           
+000189c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189d0: 2020 2020 2023 2066 6c61 6720 6368 616e       # flag chan
+000189e0: 6e65 6c20 7769 7468 696e 2074 6865 2067  nel within the g
+000189f0: 726f 7570 2061 7320 636f 6c6c 6563 7465  roup as collecte
+00018a00: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00018a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a20: 2020 6c61 7465 5f67 726f 7570 5f63 6861    late_group_cha
+00018a30: 6e6e 656c 735f 636f 6c6c 6563 7465 645b  nnels_collected[
+00018a40: 7374 7228 6772 6f75 7029 5d5b 6368 616e  str(group)][chan
+00018a50: 6e65 6c5d 203d 2054 7275 650a 0a20 2020  nel] = True..   
+00018a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a70: 2020 2020 2020 2020 2020 2020 2023 2063               # c
+00018a80: 6865 636b 2077 6865 7468 6572 2061 6c6c  heck whether all
+00018a90: 2074 6865 2063 6861 6e6e 656c 7320 696e   the channels in
+00018aa0: 2074 6865 2067 726f 7570 2061 7265 2063   the group are c
+00018ab0: 6f6c 6c65 6374 6564 0a20 2020 2020 2020  ollected.       
+00018ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ad0: 2020 2020 2020 2020 2069 6620 616c 6c28           if all(
+00018ae0: 6c61 7465 5f67 726f 7570 5f63 6861 6e6e  late_group_chann
+00018af0: 656c 735f 636f 6c6c 6563 7465 645b 7374  els_collected[st
+00018b00: 7228 6772 6f75 7029 5d2e 7661 6c75 6573  r(group)].values
+00018b10: 2829 293a 0a0a 2020 2020 2020 2020 2020  ()):..          
+00018b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b30: 2020 2020 2020 2020 2020 2320 7461 6b65            # take
+00018b40: 2074 6865 2061 7665 7261 6765 206f 7665   the average ove
+00018b50: 7220 7468 6520 746f 7461 6c0a 2020 2020  r the total.    
 00018b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00018b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018b80: 2020 2020 6465 6c20 6c61 7465 5f67 726f      del late_gro
-00018b90: 7570 5f6e 756d 6461 7461 5b73 7472 2867  up_numdata[str(g
-00018ba0: 726f 7570 295d 0a0a 2020 2020 2020 2020  roup)]..        
-00018bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018bc0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00018bd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018b80: 2320 2869 6620 7370 6563 6966 6963 2065  # (if specific e
+00018b90: 706f 6368 7320 7765 7265 2065 7863 6c75  pochs were exclu
+00018ba0: 6465 642c 2065 6163 6820 7361 6d70 6c65  ded, each sample
+00018bb0: 2073 686f 756c 6420 6265 2064 6976 6964   should be divid
+00018bc0: 6564 2062 7920 6974 7320 6f77 6e20 6e75  ed by its own nu
+00018bd0: 6d62 6572 290a 2020 2020 2020 2020 2020  mber).          
 00018be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018bf0: 2020 2020 2020 2020 2020 6c61 7465 5f67            late_g
-00018c00: 726f 7570 5f64 6174 615b 7374 7228 6772  roup_data[str(gr
-00018c10: 6f75 7029 5d20 2f3d 206c 656e 286c 6174  oup)] /= len(lat
-00018c20: 655f 6772 6f75 705f 6368 616e 6e65 6c73  e_group_channels
-00018c30: 5f63 6f6c 6c65 6374 6564 5b73 7472 2867  _collected[str(g
-00018c40: 726f 7570 295d 290a 0a20 2020 2020 2020  roup)])..       
-00018c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018c60: 2023 2066 6c61 6720 7468 6174 2066 6f72   # flag that for
-00018c70: 2074 6869 7320 6368 616e 6e65 6c20 7468   this channel th
-00018c80: 6520 6c61 7465 2072 652d 7265 6620 7661  e late re-ref va
-00018c90: 6c75 6573 2068 6176 6520 6265 656e 2063  lues have been c
-00018ca0: 6f6c 6c65 6374 6564 0a20 2020 2020 2020  ollected.       
-00018cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018cc0: 2063 6861 6e6e 656c 5f6c 6174 655f 7265   channel_late_re
-00018cd0: 7265 665f 636f 6c6c 6563 7465 645b 6368  ref_collected[ch
-00018ce0: 616e 6e65 6c5d 203d 2054 7275 650a 0a20  annel] = True.. 
+00018bf0: 2020 2020 2020 2020 2020 6966 206c 6174            if lat
+00018c00: 655f 7265 7265 662e 6368 616e 6e65 6c5f  e_reref.channel_
+00018c10: 6578 636c 7564 655f 6570 6f63 6873 2069  exclude_epochs i
+00018c20: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00018c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c50: 2020 2020 6c61 7465 5f67 726f 7570 5f64      late_group_d
+00018c60: 6174 615b 7374 7228 6772 6f75 7029 5d20  ata[str(group)] 
+00018c70: 2f3d 206c 6174 655f 6772 6f75 705f 6e75  /= late_group_nu
+00018c80: 6d64 6174 615b 7374 7228 6772 6f75 7029  mdata[str(group)
+00018c90: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00018ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018cb0: 2020 2020 2020 2020 2020 2023 2063 6c65             # cle
+00018cc0: 6172 2074 6865 2061 7272 6179 2077 6173  ar the array was
+00018cd0: 2075 7365 6420 6469 7669 6465 2074 6865   used divide the
+00018ce0: 2074 6f74 616c 2074 6f0a 2020 2020 2020   total to.      
 00018cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d00: 2020 2020 2020 2023 2075 7064 6174 6520         # update 
-00018d10: 7468 6520 7072 6f67 7265 7373 2062 6172  the progress bar
-00018d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018d30: 2020 2020 2020 2020 2075 7064 6174 655f           update_
-00018d40: 7072 6f67 7265 7373 6261 7228 290a 0a20  progressbar().. 
-00018d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018d60: 2020 2020 2020 2023 2063 6865 636b 2069         # check i
-00018d70: 6620 6368 616e 6e65 6c20 6973 206e 6f20  f channel is no 
-00018d80: 6c6f 6e67 6572 206e 6565 6465 6420 6166  longer needed af
-00018d90: 7465 7220 7468 6973 2028 666f 7220 6570  ter this (for ep
-00018da0: 6f63 6869 6e67 290a 2020 2020 2020 2020  oching).        
-00018db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018dc0: 2320 4e6f 7465 3a20 7468 6973 2061 6c73  # Note: this als
-00018dd0: 6f20 6d65 616e 7320 7468 6520 6368 616e  o means the chan
-00018de0: 6e65 6c20 7761 7320 6f6e 6c79 206c 6f61  nel was only loa
-00018df0: 6465 6420 666f 7220 6561 726c 7920 6f72  ded for early or
-00018e00: 206c 6174 6520 7265 2d72 6566 6572 656e   late re-referen
-00018e10: 6369 6e67 0a20 2020 2020 2020 2020 2020  cing.           
-00018e20: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00018e30: 6368 616e 6e65 6c20 6e6f 7420 696e 2063  channel not in c
-00018e40: 6861 6e6e 656c 5f65 706f 6368 6564 2e6b  hannel_epoched.k
-00018e50: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-00018e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e70: 2020 2023 2063 6861 6e6e 656c 2d64 6174     # channel-dat
-00018e80: 6120 6973 206e 6f20 6c6f 6e67 6572 206e  a is no longer n
-00018e90: 6565 6465 6420 6174 2061 6c6c 0a0a 2020  eeded at all..  
-00018ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018eb0: 2020 2020 2020 2020 2020 2320 7265 6d6f            # remo
-00018ec0: 7665 2074 6865 2072 6566 6572 656e 6365  ve the reference
-00018ed0: 2074 6f20 7468 6520 6e75 6d70 7920 6172   to the numpy ar
-00018ee0: 7261 792c 2074 6869 7320 7761 7920 7468  ray, this way th
-00018ef0: 6520 6d65 6d6f 7279 2073 686f 756c 6420  e memory should 
-00018f00: 6265 2061 7661 696c 6162 6c65 2066 6f72  be available for
-00018f10: 2063 6f6c 6c65 6374 696f 6e0a 2020 2020   collection.    
-00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f30: 2020 2020 2020 2020 6368 616e 6e65 6c5f          channel_
-00018f40: 6461 7461 5b63 6861 6e6e 656c 5d20 3d20  data[channel] = 
-00018f50: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00018f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f70: 2067 632e 636f 6c6c 6563 7428 290a 0a20   gc.collect().. 
-00018f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f90: 2020 2020 2020 2020 2020 2023 2073 6b69             # ski
-00018fa0: 7020 746f 206e 6578 7420 6368 616e 6e65  p to next channe
-00018fb0: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
-00018fc0: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00018fd0: 6e74 696e 7565 0a0a 0a20 2020 2020 2020  ntinue...       
-00018fe0: 2020 2020 2020 2020 2020 2020 2023 0a20               #. 
+00018d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d10: 2020 6465 6c20 6c61 7465 5f67 726f 7570    del late_group
+00018d20: 5f6e 756d 6461 7461 5b73 7472 2867 726f  _numdata[str(gro
+00018d30: 7570 295d 0a0a 2020 2020 2020 2020 2020  up)]..          
+00018d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d50: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00018d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018d80: 2020 2020 2020 2020 6c61 7465 5f67 726f          late_gro
+00018d90: 7570 5f64 6174 615b 7374 7228 6772 6f75  up_data[str(grou
+00018da0: 7029 5d20 2f3d 206c 656e 286c 6174 655f  p)] /= len(late_
+00018db0: 6772 6f75 705f 6368 616e 6e65 6c73 5f63  group_channels_c
+00018dc0: 6f6c 6c65 6374 6564 5b73 7472 2867 726f  ollected[str(gro
+00018dd0: 7570 295d 290a 0a20 2020 2020 2020 2020  up)])..         
+00018de0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018df0: 2066 6c61 6720 7468 6174 2066 6f72 2074   flag that for t
+00018e00: 6869 7320 6368 616e 6e65 6c20 7468 6520  his channel the 
+00018e10: 6c61 7465 2072 652d 7265 6620 7661 6c75  late re-ref valu
+00018e20: 6573 2068 6176 6520 6265 656e 2063 6f6c  es have been col
+00018e30: 6c65 6374 6564 0a20 2020 2020 2020 2020  lected.         
+00018e40: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018e50: 6861 6e6e 656c 5f6c 6174 655f 7265 7265  hannel_late_rere
+00018e60: 665f 636f 6c6c 6563 7465 645b 6368 616e  f_collected[chan
+00018e70: 6e65 6c5d 203d 2054 7275 650a 0a20 2020  nel] = True..   
+00018e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e90: 2020 2020 2023 2075 7064 6174 6520 7468       # update th
+00018ea0: 6520 7072 6f67 7265 7373 2062 6172 0a20  e progress bar. 
+00018eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ec0: 2020 2020 2020 2075 7064 6174 655f 7072         update_pr
+00018ed0: 6f67 7265 7373 6261 7228 290a 0a20 2020  ogressbar()..   
+00018ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ef0: 2020 2020 2023 2063 6865 636b 2069 6620       # check if 
+00018f00: 6368 616e 6e65 6c20 6973 206e 6f20 6c6f  channel is no lo
+00018f10: 6e67 6572 206e 6565 6465 6420 6166 7465  nger needed afte
+00018f20: 7220 7468 6973 2028 666f 7220 6570 6f63  r this (for epoc
+00018f30: 6869 6e67 290a 2020 2020 2020 2020 2020  hing).          
+00018f40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00018f50: 4e6f 7465 3a20 7468 6973 2061 6c73 6f20  Note: this also 
+00018f60: 6d65 616e 7320 7468 6520 6368 616e 6e65  means the channe
+00018f70: 6c20 7761 7320 6f6e 6c79 206c 6f61 6465  l was only loade
+00018f80: 6420 666f 7220 6561 726c 7920 6f72 206c  d for early or l
+00018f90: 6174 6520 7265 2d72 6566 6572 656e 6369  ate re-referenci
+00018fa0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
+00018fb0: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
+00018fc0: 616e 6e65 6c20 6e6f 7420 696e 2063 6861  annel not in cha
+00018fd0: 6e6e 656c 5f65 706f 6368 6564 2e6b 6579  nnel_epoched.key
+00018fe0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
 00018ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019000: 2020 2023 204c 6174 6520 7265 2d72 6566     # Late re-ref
-00019010: 6572 656e 6369 6e67 2061 7070 6c79 0a20  erencing apply. 
-00019020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019030: 2020 2023 0a0a 2020 2020 2020 2020 2020     #..          
-00019040: 2020 2020 2020 2020 2020 2320 7369 6e63            # sinc
-00019050: 6520 6c61 7465 2072 652d 7265 6665 7265  e late re-refere
-00019060: 6e63 696e 6720 616e 6420 6570 6f63 6869  ncing and epochi
-00019070: 6e67 2061 7265 2074 6865 206c 6173 7420  ng are the last 
-00019080: 7374 6570 732c 2074 6865 7265 2069 7320  steps, there is 
-00019090: 6e6f 2073 746f 7269 6e67 206f 6620 7468  no storing of th
-000190a0: 6520 6368 616e 6e65 6c20 6461 7461 0a20  e channel data. 
+00019000: 2023 2063 6861 6e6e 656c 2d64 6174 6120   # channel-data 
+00019010: 6973 206e 6f20 6c6f 6e67 6572 206e 6565  is no longer nee
+00019020: 6465 6420 6174 2061 6c6c 0a0a 2020 2020  ded at all..    
+00019030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019040: 2020 2020 2020 2020 2320 7265 6d6f 7665          # remove
+00019050: 2074 6865 2072 6566 6572 656e 6365 2074   the reference t
+00019060: 6f20 7468 6520 6e75 6d70 7920 6172 7261  o the numpy arra
+00019070: 792c 2074 6869 7320 7761 7920 7468 6520  y, this way the 
+00019080: 6d65 6d6f 7279 2073 686f 756c 6420 6265  memory should be
+00019090: 2061 7661 696c 6162 6c65 2066 6f72 2063   available for c
+000190a0: 6f6c 6c65 6374 696f 6e0a 2020 2020 2020  ollection.      
 000190b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000190c0: 2020 2023 2077 6974 6820 6c61 7465 2072     # with late r
-000190d0: 652d 7265 6665 7265 6e63 696e 6720 6170  e-referencing ap
-000190e0: 706c 6965 642e 2054 6865 2063 6861 6e6e  plied. The chann
-000190f0: 656c 2064 6174 6120 6569 7468 6572 2073  el data either s
-00019100: 7461 7973 2061 7320 6974 2061 7272 6976  tays as it arriv
-00019110: 6564 2061 7420 7468 6973 2070 6f69 6e74  ed at this point
-00019120: 2028 7768 656e 0a20 2020 2020 2020 2020   (when.         
-00019130: 2020 2020 2020 2020 2020 2023 206f 7074             # opt
-00019140: 696d 697a 6564 2066 6f72 2073 7065 6564  imized for speed
-00019150: 3b20 7761 6974 696e 6720 666f 7220 6265  ; waiting for be
-00019160: 696e 6720 6162 6c65 2074 6f20 7065 7266  ing able to perf
-00019170: 6f72 6d20 7468 6520 6c61 7465 2072 652d  orm the late re-
-00019180: 7265 6629 206f 7220 6973 2072 6570 726f  ref) or is repro
-00019190: 6365 7373 6564 2066 726f 6d20 7468 6520  cessed from the 
-000191a0: 7374 6172 740a 2020 2020 2020 2020 2020  start.          
-000191b0: 2020 2020 2020 2020 2020 2320 746f 2074            # to t
-000191c0: 6865 2073 616d 6520 7374 6174 6520 2877  he same state (w
-000191d0: 6865 6e20 6f70 7469 6d69 7a65 6420 666f  hen optimized fo
-000191e0: 7220 6d65 6d6f 7279 2c20 7468 656e 2074  r memory, then t
-000191f0: 6865 206c 6174 6520 7265 2d72 6566 2077  he late re-ref w
-00019200: 696c 6c20 6265 2061 7070 6c69 6564 2920  ill be applied) 
-00019210: 6f72 2069 7420 6973 2069 6d6d 6564 6961  or it is immedia
-00019220: 7465 6c79 0a20 2020 2020 2020 2020 2020  tely.           
-00019230: 2020 2020 2020 2020 2023 206c 6174 6520           # late 
-00019240: 7265 2d72 6566 6572 656e 6365 6420 616e  re-referenced an
-00019250: 6420 6570 6f63 6865 6420 2861 6e64 2074  d epoched (and t
-00019260: 6865 2063 6861 6e6e 656c 2d64 6174 6120  he channel-data 
-00019270: 636c 6561 7265 6429 0a0a 2020 2020 2020  cleared)..      
-00019280: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00019290: 7265 7472 6965 7665 2074 6865 206c 6174  retrieve the lat
-000192a0: 6520 7265 2d72 6566 2067 726f 7570 2066  e re-ref group f
-000192b0: 6f72 2074 6869 7320 6368 616e 6e65 6c0a  or this channel.
-000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192d0: 2020 2020 6772 6f75 7020 3d20 6c61 7465      group = late
-000192e0: 5f72 6572 6566 2e63 6861 6e6e 656c 5f67  _reref.channel_g
-000192f0: 726f 7570 5b63 6861 6e6e 656c 5d0a 0a20  roup[channel].. 
-00019300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019310: 2020 2023 2063 6865 636b 2069 6620 616c     # check if al
-00019320: 6c20 7468 6520 6c61 7465 2072 652d 7265  l the late re-re
-00019330: 6665 7265 6e63 696e 6720 696e 666f 726d  ferencing inform
-00019340: 6174 696f 6e20 6973 2061 7661 696c 6162  ation is availab
-00019350: 6c65 2079 6574 2028 6c61 7465 2061 7665  le yet (late ave
-00019360: 7261 6765 2066 6f72 2074 6869 7320 6772  rage for this gr
-00019370: 6f75 7029 0a20 2020 2020 2020 2020 2020  oup).           
-00019380: 2020 2020 2020 2020 2069 6620 616c 6c28           if all(
-00019390: 6c61 7465 5f67 726f 7570 5f63 6861 6e6e  late_group_chann
-000193a0: 656c 735f 636f 6c6c 6563 7465 645b 7374  els_collected[st
-000193b0: 7228 6772 6f75 7029 5d2e 7661 6c75 6573  r(group)].values
-000193c0: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-000193d0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-000193e0: 6c6c 2072 6571 7569 7265 6420 696e 666f  ll required info
-000193f0: 726d 6174 696f 6e20 6973 2061 7661 696c  rmation is avail
-00019400: 6162 6c65 2c20 7065 7266 6f72 6d20 6c61  able, perform la
-00019410: 7465 2072 652d 7265 6665 7265 6e63 696e  te re-referencin
-00019420: 6720 6f6e 2074 6865 2063 6861 6e6e 656c  g on the channel
-00019430: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00019440: 2020 2020 2020 2020 2020 2370 7269 6e74            #print
-00019450: 2863 6861 6e6e 656c 202b 2022 3a20 7065  (channel + ": pe
-00019460: 7266 6f72 6d69 6e67 206c 6174 6520 7265  rforming late re
-00019470: 7265 6620 6f6e 2063 6861 6e6e 656c 2229  ref on channel")
-00019480: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00019490: 2020 2020 2020 2020 2020 2320 7065 7266            # perf
-000194a0: 6f72 6d20 6c61 7465 2072 652d 7265 6620  orm late re-ref 
-000194b0: 7573 696e 6720 7265 7265 665f 7661 6c75  using reref_valu
-000194c0: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-000194d0: 2020 2020 2020 2020 2020 2063 6861 6e6e             chann
-000194e0: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
-000194f0: 202d 3d20 6c61 7465 5f67 726f 7570 5f64   -= late_group_d
-00019500: 6174 615b 7374 7228 6772 6f75 7029 5d0a  ata[str(group)].
-00019510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019520: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
-00019530: 2069 6620 7468 6973 2069 7320 7468 6520   if this is the 
-00019540: 6c61 7465 7374 2063 6861 6e6e 656c 2074  latest channel t
-00019550: 6f20 7573 6520 7468 6520 6c61 7465 2067  o use the late g
-00019560: 726f 7570 2061 7665 7261 6765 2c20 7365  roup average, se
-00019570: 6520 6966 2077 6520 6361 6e20 7361 6665  e if we can safe
-00019580: 6c79 2063 6c65 6172 2074 6865 2067 726f  ly clear the gro
-00019590: 7570 2061 7665 7261 6765 2061 7272 6179  up average array
-000195a0: 0a0a 0a20 2020 2020 2020 2020 2020 2020  ...             
-000195b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000190c0: 2020 2020 2020 6368 616e 6e65 6c5f 6461        channel_da
+000190d0: 7461 5b63 6861 6e6e 656c 5d20 3d20 4e6f  ta[channel] = No
+000190e0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+000190f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00019100: 632e 636f 6c6c 6563 7428 290a 0a20 2020  c.collect()..   
+00019110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019120: 2020 2020 2020 2020 2023 2073 6b69 7020           # skip 
+00019130: 746f 206e 6578 7420 6368 616e 6e65 6c0a  to next channel.
+00019140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019150: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00019160: 696e 7565 0a0a 0a20 2020 2020 2020 2020  inue...         
+00019170: 2020 2020 2020 2020 2020 2023 0a20 2020             #.   
+00019180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019190: 2023 204c 6174 6520 7265 2d72 6566 6572   # Late re-refer
+000191a0: 656e 6369 6e67 2061 7070 6c79 0a20 2020  encing apply.   
+000191b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000191c0: 2023 0a0a 2020 2020 2020 2020 2020 2020   #..            
+000191d0: 2020 2020 2020 2020 2320 7369 6e63 6520          # since 
+000191e0: 6c61 7465 2072 652d 7265 6665 7265 6e63  late re-referenc
+000191f0: 696e 6720 616e 6420 6570 6f63 6869 6e67  ing and epoching
+00019200: 2061 7265 2074 6865 206c 6173 7420 7374   are the last st
+00019210: 6570 732c 2074 6865 7265 2069 7320 6e6f  eps, there is no
+00019220: 2073 746f 7269 6e67 206f 6620 7468 6520   storing of the 
+00019230: 6368 616e 6e65 6c20 6461 7461 0a20 2020  channel data.   
+00019240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019250: 2023 2077 6974 6820 6c61 7465 2072 652d   # with late re-
+00019260: 7265 6665 7265 6e63 696e 6720 6170 706c  referencing appl
+00019270: 6965 642e 2054 6865 2063 6861 6e6e 656c  ied. The channel
+00019280: 2064 6174 6120 6569 7468 6572 2073 7461   data either sta
+00019290: 7973 2061 7320 6974 2061 7272 6976 6564  ys as it arrived
+000192a0: 2061 7420 7468 6973 2070 6f69 6e74 2028   at this point (
+000192b0: 7768 656e 0a20 2020 2020 2020 2020 2020  when.           
+000192c0: 2020 2020 2020 2020 2023 206f 7074 696d           # optim
+000192d0: 697a 6564 2066 6f72 2073 7065 6564 3b20  ized for speed; 
+000192e0: 7761 6974 696e 6720 666f 7220 6265 696e  waiting for bein
+000192f0: 6720 6162 6c65 2074 6f20 7065 7266 6f72  g able to perfor
+00019300: 6d20 7468 6520 6c61 7465 2072 652d 7265  m the late re-re
+00019310: 6629 206f 7220 6973 2072 6570 726f 6365  f) or is reproce
+00019320: 7373 6564 2066 726f 6d20 7468 6520 7374  ssed from the st
+00019330: 6172 740a 2020 2020 2020 2020 2020 2020  art.            
+00019340: 2020 2020 2020 2020 2320 746f 2074 6865          # to the
+00019350: 2073 616d 6520 7374 6174 6520 2877 6865   same state (whe
+00019360: 6e20 6f70 7469 6d69 7a65 6420 666f 7220  n optimized for 
+00019370: 6d65 6d6f 7279 2c20 7468 656e 2074 6865  memory, then the
+00019380: 206c 6174 6520 7265 2d72 6566 2077 696c   late re-ref wil
+00019390: 6c20 6265 2061 7070 6c69 6564 2920 6f72  l be applied) or
+000193a0: 2069 7420 6973 2069 6d6d 6564 6961 7465   it is immediate
+000193b0: 6c79 0a20 2020 2020 2020 2020 2020 2020  ly.             
+000193c0: 2020 2020 2020 2023 206c 6174 6520 7265         # late re
+000193d0: 2d72 6566 6572 656e 6365 6420 616e 6420  -referenced and 
+000193e0: 6570 6f63 6865 6420 2861 6e64 2074 6865  epoched (and the
+000193f0: 2063 6861 6e6e 656c 2d64 6174 6120 636c   channel-data cl
+00019400: 6561 7265 6429 0a0a 2020 2020 2020 2020  eared)..        
+00019410: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00019420: 7472 6965 7665 2074 6865 206c 6174 6520  trieve the late 
+00019430: 7265 2d72 6566 2067 726f 7570 2066 6f72  re-ref group for
+00019440: 2074 6869 7320 6368 616e 6e65 6c0a 2020   this channel.  
+00019450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019460: 2020 6772 6f75 7020 3d20 6c61 7465 5f72    group = late_r
+00019470: 6572 6566 2e63 6861 6e6e 656c 5f67 726f  eref.channel_gro
+00019480: 7570 5b63 6861 6e6e 656c 5d0a 0a20 2020  up[channel]..   
+00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194a0: 2023 2063 6865 636b 2069 6620 616c 6c20   # check if all 
+000194b0: 7468 6520 6c61 7465 2072 652d 7265 6665  the late re-refe
+000194c0: 7265 6e63 696e 6720 696e 666f 726d 6174  rencing informat
+000194d0: 696f 6e20 6973 2061 7661 696c 6162 6c65  ion is available
+000194e0: 2079 6574 2028 6c61 7465 2061 7665 7261   yet (late avera
+000194f0: 6765 2066 6f72 2074 6869 7320 6772 6f75  ge for this grou
+00019500: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
+00019510: 2020 2020 2020 2069 6620 616c 6c28 6c61         if all(la
+00019520: 7465 5f67 726f 7570 5f63 6861 6e6e 656c  te_group_channel
+00019530: 735f 636f 6c6c 6563 7465 645b 7374 7228  s_collected[str(
+00019540: 6772 6f75 7029 5d2e 7661 6c75 6573 2829  group)].values()
+00019550: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00019560: 2020 2020 2020 2020 2020 2023 2061 6c6c             # all
+00019570: 2072 6571 7569 7265 6420 696e 666f 726d   required inform
+00019580: 6174 696f 6e20 6973 2061 7661 696c 6162  ation is availab
+00019590: 6c65 2c20 7065 7266 6f72 6d20 6c61 7465  le, perform late
+000195a0: 2072 652d 7265 6665 7265 6e63 696e 6720   re-referencing 
+000195b0: 6f6e 2074 6865 2063 6861 6e6e 656c 0a0a  on the channel..
 000195c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195d0: 2020 2020 2023 206e 6f74 2061 6c6c 2072       # not all r
-000195e0: 6571 7569 7265 6420 696e 666f 726d 6174  equired informat
-000195f0: 696f 6e20 666f 7220 6c61 7465 2072 652d  ion for late re-
-00019600: 7265 6620 6973 2061 7661 696c 6162 6c65  ref is available
-00019610: 2c20 7765 2077 696c 6c20 6861 7665 2074  , we will have t
-00019620: 6f20 7761 6974 0a20 2020 2020 2020 2020  o wait.         
-00019630: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00019640: 2061 6e20 6974 6572 6174 696f 6e20 286f   an iteration (o
-00019650: 7665 7220 7468 6520 7265 7374 206f 6620  ver the rest of 
-00019660: 7468 6520 6368 616e 6e65 6c73 2920 666f  the channels) fo
-00019670: 7220 7468 6520 696e 666f 726d 6174 696f  r the informatio
-00019680: 6e20 746f 2062 6563 6f6d 6520 6176 6169  n to become avai
-00019690: 6c61 626c 650a 0a20 2020 2020 2020 2020  lable..         
-000196a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000196b0: 2063 6865 636b 2077 6865 7468 6572 2069   check whether i
-000196c0: 7420 6973 206f 7074 696d 697a 6564 2066  t is optimized f
-000196d0: 6f72 206d 656d 6f72 792c 2069 6620 736f  or memory, if so
-000196e0: 2c20 636c 6561 720a 2020 2020 2020 2020  , clear.        
-000196f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019700: 6966 2070 7269 6f72 6974 7920 3d3d 2027  if priority == '
-00019710: 6d65 6d27 3a0a 0a20 2020 2020 2020 2020  mem':..         
-00019720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019730: 2020 2023 7072 696e 7428 6368 616e 6e65     #print(channe
-00019740: 6c20 2b20 223a 2063 6c65 6172 696e 6720  l + ": clearing 
-00019750: 6368 616e 6e65 6c20 6672 6f6d 206d 656d  channel from mem
-00019760: 2229 0a0a 2020 2020 2020 2020 2020 2020  ")..            
-00019770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019780: 2320 7265 6d6f 7665 2074 6865 2072 6566  # remove the ref
-00019790: 6572 656e 6365 2074 6f20 7468 6520 6e75  erence to the nu
-000197a0: 6d70 7920 6172 7261 792c 2074 6869 7320  mpy array, this 
-000197b0: 7761 7920 7468 6520 6d65 6d6f 7279 2073  way the memory s
-000197c0: 686f 756c 6420 6265 2061 7661 696c 6162  hould be availab
-000197d0: 6c65 2066 6f72 2063 6f6c 6c65 6374 696f  le for collectio
-000197e0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-000197f0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00019800: 616e 6e65 6c5f 6461 7461 5b63 6861 6e6e  annel_data[chann
-00019810: 656c 5d20 3d20 4e6f 6e65 0a20 2020 2020  el] = None.     
-00019820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019830: 2020 2020 2020 2067 632e 636f 6c6c 6563         gc.collec
-00019840: 7428 290a 0a20 2020 2020 2020 2020 2020  t()..           
-00019850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019860: 2023 2073 696e 6365 2077 6520 6e65 6564   # since we need
-00019870: 2074 6f20 7265 6c6f 6164 2074 6865 2063   to reload the c
-00019880: 6861 6e6e 656c 2074 6865 206e 6578 7420  hannel the next 
-00019890: 6974 6572 6174 696f 6e2c 2077 6520 7769  iteration, we wi
-000198a0: 6c6c 2061 6c73 6f20 6861 7665 2074 6f20  ll also have to 
-000198b0: 6869 6768 2d70 6173 732c 2065 6172 6c79  high-pass, early
-000198c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000198d0: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-000198e0: 652d 7265 6620 616e 6420 7265 6d6f 7665  e-ref and remove
-000198f0: 206c 696e 652d 6e6f 6973 6520 6167 6169   line-noise agai
-00019900: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00019910: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00019920: 616e 6e65 6c5f 6870 5f61 7070 6c69 6564  annel_hp_applied
-00019930: 5b63 6861 6e6e 656c 5d20 3d20 4661 6c73  [channel] = Fals
-00019940: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00019950: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00019960: 616e 6e65 6c5f 6561 726c 795f 6170 706c  annel_early_appl
-00019970: 6965 645b 6368 616e 6e65 6c5d 203d 2046  ied[channel] = F
-00019980: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-00019990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000199a0: 2063 6861 6e6e 656c 5f6c 6e72 5f61 7070   channel_lnr_app
-000199b0: 6c69 6564 5b63 6861 6e6e 656c 5d20 3d20  lied[channel] = 
-000199c0: 4661 6c73 650a 0a20 2020 2020 2020 2020  False..         
-000199d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000199e0: 2063 6f6e 7469 6e75 6520 746f 2074 6865   continue to the
-000199f0: 206e 6578 7420 6368 616e 6e65 6c0a 2020   next channel.  
-00019a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a10: 2020 2020 2020 636f 6e74 696e 7565 0a0a        continue..
-00019a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a30: 230a 2020 2020 2020 2020 2020 2020 2020  #.              
-00019a40: 2020 2320 4570 6f63 682d 696e 670a 2020    # Epoch-ing.  
-00019a50: 2020 2020 2020 2020 2020 2020 2020 230a                #.
-00019a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019a70: 2023 2065 706f 6368 2074 6865 2063 6861   # epoch the cha
-00019a80: 6e6e 656c 2064 6174 610a 2020 2020 2020  nnel data.      
-00019a90: 2020 2020 2020 2020 2020 2370 7269 6e74            #print
-00019aa0: 2863 6861 6e6e 656c 202b 2022 3a20 6570  (channel + ": ep
-00019ab0: 6f63 6822 290a 2020 2020 2020 2020 2020  och").          
-00019ac0: 2020 2020 2020 7472 793a 0a0a 2020 2020        try:..    
+000195d0: 2020 2020 2020 2020 2370 7269 6e74 2863          #print(c
+000195e0: 6861 6e6e 656c 202b 2022 3a20 7065 7266  hannel + ": perf
+000195f0: 6f72 6d69 6e67 206c 6174 6520 7265 7265  orming late rere
+00019600: 6620 6f6e 2063 6861 6e6e 656c 2229 0a0a  f on channel")..
+00019610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019620: 2020 2020 2020 2020 2320 7065 7266 6f72          # perfor
+00019630: 6d20 6c61 7465 2072 652d 7265 6620 7573  m late re-ref us
+00019640: 696e 6720 7265 7265 665f 7661 6c75 6573  ing reref_values
+00019650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019660: 2020 2020 2020 2020 2063 6861 6e6e 656c           channel
+00019670: 5f64 6174 615b 6368 616e 6e65 6c5d 202d  _data[channel] -
+00019680: 3d20 6c61 7465 5f67 726f 7570 5f64 6174  = late_group_dat
+00019690: 615b 7374 7228 6772 6f75 7029 5d0a 0a20  a[str(group)].. 
+000196a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196b0: 2020 2020 2020 2023 2054 4f44 4f3a 2069         # TODO: i
+000196c0: 6620 7468 6973 2069 7320 7468 6520 6c61  f this is the la
+000196d0: 7465 7374 2063 6861 6e6e 656c 2074 6f20  test channel to 
+000196e0: 7573 6520 7468 6520 6c61 7465 2067 726f  use the late gro
+000196f0: 7570 2061 7665 7261 6765 2c20 7365 6520  up average, see 
+00019700: 6966 2077 6520 6361 6e20 7361 6665 6c79  if we can safely
+00019710: 2063 6c65 6172 2074 6865 2067 726f 7570   clear the group
+00019720: 2061 7665 7261 6765 2061 7272 6179 0a0a   average array..
+00019730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019740: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00019750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019760: 2020 2023 206e 6f74 2061 6c6c 2072 6571     # not all req
+00019770: 7569 7265 6420 696e 666f 726d 6174 696f  uired informatio
+00019780: 6e20 666f 7220 6c61 7465 2072 652d 7265  n for late re-re
+00019790: 6620 6973 2061 7661 696c 6162 6c65 2c20  f is available, 
+000197a0: 7765 2077 696c 6c20 6861 7665 2074 6f20  we will have to 
+000197b0: 7761 6974 0a20 2020 2020 2020 2020 2020  wait.           
+000197c0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
+000197d0: 6e20 6974 6572 6174 696f 6e20 286f 7665  n iteration (ove
+000197e0: 7220 7468 6520 7265 7374 206f 6620 7468  r the rest of th
+000197f0: 6520 6368 616e 6e65 6c73 2920 666f 7220  e channels) for 
+00019800: 7468 6520 696e 666f 726d 6174 696f 6e20  the information 
+00019810: 746f 2062 6563 6f6d 6520 6176 6169 6c61  to become availa
+00019820: 626c 650a 0a20 2020 2020 2020 2020 2020  ble..           
+00019830: 2020 2020 2020 2020 2020 2020 2023 2063               # c
+00019840: 6865 636b 2077 6865 7468 6572 2069 7420  heck whether it 
+00019850: 6973 206f 7074 696d 697a 6564 2066 6f72  is optimized for
+00019860: 206d 656d 6f72 792c 2069 6620 736f 2c20   memory, if so, 
+00019870: 636c 6561 720a 2020 2020 2020 2020 2020  clear.          
+00019880: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019890: 2070 7269 6f72 6974 7920 3d3d 2027 6d65   priority == 'me
+000198a0: 6d27 3a0a 0a20 2020 2020 2020 2020 2020  m':..           
+000198b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000198c0: 2023 7072 696e 7428 6368 616e 6e65 6c20   #print(channel 
+000198d0: 2b20 223a 2063 6c65 6172 696e 6720 6368  + ": clearing ch
+000198e0: 616e 6e65 6c20 6672 6f6d 206d 656d 2229  annel from mem")
+000198f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00019900: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019910: 7265 6d6f 7665 2074 6865 2072 6566 6572  remove the refer
+00019920: 656e 6365 2074 6f20 7468 6520 6e75 6d70  ence to the nump
+00019930: 7920 6172 7261 792c 2074 6869 7320 7761  y array, this wa
+00019940: 7920 7468 6520 6d65 6d6f 7279 2073 686f  y the memory sho
+00019950: 756c 6420 6265 2061 7661 696c 6162 6c65  uld be available
+00019960: 2066 6f72 2063 6f6c 6c65 6374 696f 6e0a   for collection.
+00019970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019980: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00019990: 6e65 6c5f 6461 7461 5b63 6861 6e6e 656c  nel_data[channel
+000199a0: 5d20 3d20 4e6f 6e65 0a20 2020 2020 2020  ] = None.       
+000199b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000199c0: 2020 2020 2067 632e 636f 6c6c 6563 7428       gc.collect(
+000199d0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000199e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000199f0: 2073 696e 6365 2077 6520 6e65 6564 2074   since we need t
+00019a00: 6f20 7265 6c6f 6164 2074 6865 2063 6861  o reload the cha
+00019a10: 6e6e 656c 2074 6865 206e 6578 7420 6974  nnel the next it
+00019a20: 6572 6174 696f 6e2c 2077 6520 7769 6c6c  eration, we will
+00019a30: 2061 6c73 6f20 6861 7665 2074 6f20 6869   also have to hi
+00019a40: 6768 2d70 6173 732c 2065 6172 6c79 0a20  gh-pass, early. 
+00019a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019a60: 2020 2020 2020 2020 2020 2023 2072 652d             # re-
+00019a70: 7265 6620 616e 6420 7265 6d6f 7665 206c  ref and remove l
+00019a80: 696e 652d 6e6f 6973 6520 6167 6169 6e0a  ine-noise again.
+00019a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019aa0: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00019ab0: 6e65 6c5f 6870 5f61 7070 6c69 6564 5b63  nel_hp_applied[c
+00019ac0: 6861 6e6e 656c 5d20 3d20 4661 6c73 650a  hannel] = False.
 00019ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ae0: 2320 7265 7472 6965 7665 2074 6865 2069  # retrieve the i
-00019af0: 6e64 6578 206f 6620 7468 6520 6368 616e  ndex of the chan
-00019b00: 6e65 6c20 696e 2074 6865 2072 6571 7565  nel in the reque
-00019b10: 7374 6564 206c 6973 7420 2873 6f20 6974  sted list (so it
-00019b20: 2063 616e 2062 6520 706c 6163 6564 2069   can be placed i
-00019b30: 6e20 7468 6520 636f 7272 6563 7420 7370  n the correct sp
-00019b40: 6f74 206f 6620 7468 6520 7265 7475 726e  ot of the return
-00019b50: 206d 6174 7269 7829 0a20 2020 2020 2020   matrix).       
-00019b60: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-00019b70: 6f74 653a 2043 6861 6e6e 656c 7320 7468  ote: Channels th
-00019b80: 6174 2061 7265 206e 6565 6465 6420 666f  at are needed fo
-00019b90: 7220 7265 2d72 6566 6572 656e 6369 6e67  r re-referencing
-00019ba0: 2062 7574 206e 6f74 2066 6f72 2065 706f   but not for epo
-00019bb0: 6368 2d69 6e67 2073 686f 756c 6420 6e6f  ch-ing should no
-00019bc0: 7420 6765 7420 7468 6973 2066 6172 2064  t get this far d
-00019bd0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-00019be0: 2020 2020 2020 2023 2020 2020 2020 2074         #       t
-00019bf0: 6f20 7468 6520 6368 6563 6b2f 636f 6e74  o the check/cont
-00019c00: 696e 7565 2073 7461 7465 6d65 6e74 7320  inue statements 
-00019c10: 696e 2074 6865 2072 652d 7265 6665 7265  in the re-refere
-00019c20: 6e63 696e 6720 636f 6c6c 6563 7473 2073  ncing collects s
-00019c30: 6563 7469 6f6e 7320 6162 6f76 650a 2020  ections above.  
-00019c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c50: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00019c60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00019c70: 6861 6e6e 656c 5f69 6478 203d 2072 6574  hannel_idx = ret
-00019c80: 7269 6576 655f 6368 616e 6e65 6c73 2e69  rieve_channels.i
-00019c90: 6e64 6578 2863 6861 6e6e 656c 290a 2020  ndex(channel).  
-00019ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019cb0: 2020 6578 6365 7074 2056 616c 7565 4572    except ValueEr
-00019cc0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00019cd0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00019ce0: 6769 6e67 2e65 7272 6f72 2827 436f 756c  ging.error('Coul
-00019cf0: 6420 6e6f 7420 6669 6e64 2065 706f 6368  d not find epoch
-00019d00: 2063 6861 6e6e 656c 2027 202b 2063 6861   channel ' + cha
-00019d10: 6e6e 656c 202b 2027 2069 6e20 7468 6520  nnel + ' in the 
-00019d20: 6c69 7374 206f 6620 6368 616e 6e65 6c73  list of channels
-00019d30: 2074 6f20 7265 7472 6965 7665 2729 0a20   to retrieve'). 
-00019d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d50: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
-00019d60: 7469 6d65 4572 726f 7228 2743 6f75 6c64  timeError('Could
-00019d70: 206e 6f74 2066 696e 6420 6570 6f63 6820   not find epoch 
-00019d80: 6368 616e 6e65 6c20 696e 2072 6574 7269  channel in retri
-00019d90: 6576 6520 6c69 7374 2729 0a0a 2020 2020  eve list')..    
-00019da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019db0: 6966 2061 7665 7261 6765 3a0a 2020 2020  if average:.    
-00019dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019dd0: 2020 2020 2320 6570 6f63 6820 616e 6420      # epoch and 
-00019de0: 6176 6572 6167 650a 0a20 2020 2020 2020  average..       
-00019df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e00: 205f 5f73 7562 6c6f 6164 5f64 6174 615f   __subload_data_
-00019e10: 6570 6f63 685f 6176 6572 6167 6573 5f5f  epoch_averages__
-00019e20: 6672 6f6d 5f63 6861 6e6e 656c 5f5f 6279  from_channel__by
-00019e30: 5f63 6f6e 6469 7469 6f6e 5f74 7269 616c  _condition_trial
-00019e40: 7328 6461 7461 2c20 6d65 7472 6963 5f76  s(data, metric_v
-00019e50: 616c 7565 732c 0a20 2020 2020 2020 2020  alues,.         
-00019e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019eb0: 6461 7461 5f72 6561 6465 722c 2063 6861  data_reader, cha
-00019ec0: 6e6e 656c 5f69 6478 2c20 6368 616e 6e65  nnel_idx, channe
-00019ed0: 6c2c 2063 6861 6e6e 656c 5f64 6174 615b  l, channel_data[
-00019ee0: 6368 616e 6e65 6c5d 2c0a 2020 2020 2020  channel],.      
-00019ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f40: 2020 206f 6e73 6574 732c 2074 7269 616c     onsets, trial
-00019f50: 5f6e 756d 5f73 616d 706c 6573 2c20 7472  _num_samples, tr
-00019f60: 6961 6c5f 6570 6f63 682c 0a20 2020 2020  ial_epoch,.     
-00019f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019fc0: 2020 2020 6261 7365 6c69 6e65 5f6e 756d      baseline_num
-00019fd0: 5f73 616d 706c 6573 2c20 6261 7365 6c69  _samples, baseli
-00019fe0: 6e65 5f6d 6574 686f 642c 2062 6173 656c  ne_method, basel
-00019ff0: 696e 655f 6570 6f63 682c 0a20 2020 2020  ine_epoch,.     
+00019ae0: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00019af0: 6e65 6c5f 6561 726c 795f 6170 706c 6965  nel_early_applie
+00019b00: 645b 6368 616e 6e65 6c5d 203d 2046 616c  d[channel] = Fal
+00019b10: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+00019b20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00019b30: 6861 6e6e 656c 5f6c 6e72 5f61 7070 6c69  hannel_lnr_appli
+00019b40: 6564 5b63 6861 6e6e 656c 5d20 3d20 4661  ed[channel] = Fa
+00019b50: 6c73 650a 0a20 2020 2020 2020 2020 2020  lse..           
+00019b60: 2020 2020 2020 2020 2020 2020 2023 2063               # c
+00019b70: 6f6e 7469 6e75 6520 746f 2074 6865 206e  ontinue to the n
+00019b80: 6578 7420 6368 616e 6e65 6c0a 2020 2020  ext channel.    
+00019b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ba0: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00019bb0: 2020 2020 2020 2020 2020 2020 2020 230a                #.
+00019bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019bd0: 2320 4570 6f63 682d 696e 670a 2020 2020  # Epoch-ing.    
+00019be0: 2020 2020 2020 2020 2020 2020 230a 0a20              #.. 
+00019bf0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00019c00: 2065 706f 6368 2074 6865 2063 6861 6e6e   epoch the chann
+00019c10: 656c 2064 6174 610a 2020 2020 2020 2020  el data.        
+00019c20: 2020 2020 2020 2020 2370 7269 6e74 2863          #print(c
+00019c30: 6861 6e6e 656c 202b 2022 3a20 6570 6f63  hannel + ": epoc
+00019c40: 6822 290a 2020 2020 2020 2020 2020 2020  h").            
+00019c50: 2020 2020 7472 793a 0a0a 2020 2020 2020      try:..      
+00019c60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00019c70: 7265 7472 6965 7665 2074 6865 2069 6e64  retrieve the ind
+00019c80: 6578 206f 6620 7468 6520 6368 616e 6e65  ex of the channe
+00019c90: 6c20 696e 2074 6865 2072 6571 7565 7374  l in the request
+00019ca0: 6564 206c 6973 7420 2873 6f20 6974 2063  ed list (so it c
+00019cb0: 616e 2062 6520 706c 6163 6564 2069 6e20  an be placed in 
+00019cc0: 7468 6520 636f 7272 6563 7420 7370 6f74  the correct spot
+00019cd0: 206f 6620 7468 6520 7265 7475 726e 206d   of the return m
+00019ce0: 6174 7269 7829 0a20 2020 2020 2020 2020  atrix).         
+00019cf0: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
+00019d00: 653a 2043 6861 6e6e 656c 7320 7468 6174  e: Channels that
+00019d10: 2061 7265 206e 6565 6465 6420 666f 7220   are needed for 
+00019d20: 7265 2d72 6566 6572 656e 6369 6e67 2062  re-referencing b
+00019d30: 7574 206e 6f74 2066 6f72 2065 706f 6368  ut not for epoch
+00019d40: 2d69 6e67 2073 686f 756c 6420 6e6f 7420  -ing should not 
+00019d50: 6765 7420 7468 6973 2066 6172 2064 7565  get this far due
+00019d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019d70: 2020 2020 2023 2020 2020 2020 2074 6f20       #       to 
+00019d80: 7468 6520 6368 6563 6b2f 636f 6e74 696e  the check/contin
+00019d90: 7565 2073 7461 7465 6d65 6e74 7320 696e  ue statements in
+00019da0: 2074 6865 2072 652d 7265 6665 7265 6e63   the re-referenc
+00019db0: 696e 6720 636f 6c6c 6563 7473 2073 6563  ing collects sec
+00019dc0: 7469 6f6e 7320 6162 6f76 650a 2020 2020  tions above.    
+00019dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019de0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00019df0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
+00019e00: 6e6e 656c 5f69 6478 203d 2072 6574 7269  nnel_idx = retri
+00019e10: 6576 655f 6368 616e 6e65 6c73 2e69 6e64  eve_channels.ind
+00019e20: 6578 2863 6861 6e6e 656c 290a 2020 2020  ex(channel).    
+00019e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019e40: 6578 6365 7074 2056 616c 7565 4572 726f  except ValueErro
+00019e50: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00019e60: 2020 2020 2020 2020 2020 206c 6f67 6769             loggi
+00019e70: 6e67 2e65 7272 6f72 2827 436f 756c 6420  ng.error('Could 
+00019e80: 6e6f 7420 6669 6e64 2065 706f 6368 2063  not find epoch c
+00019e90: 6861 6e6e 656c 2027 202b 2063 6861 6e6e  hannel ' + chann
+00019ea0: 656c 202b 2027 2069 6e20 7468 6520 6c69  el + ' in the li
+00019eb0: 7374 206f 6620 6368 616e 6e65 6c73 2074  st of channels t
+00019ec0: 6f20 7265 7472 6965 7665 2729 0a20 2020  o retrieve').   
+00019ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ee0: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00019ef0: 6d65 4572 726f 7228 2743 6f75 6c64 206e  meError('Could n
+00019f00: 6f74 2066 696e 6420 6570 6f63 6820 6368  ot find epoch ch
+00019f10: 616e 6e65 6c20 696e 2072 6574 7269 6576  annel in retriev
+00019f20: 6520 6c69 7374 2729 0a0a 2020 2020 2020  e list')..      
+00019f30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019f40: 2061 7665 7261 6765 3a0a 2020 2020 2020   average:.      
+00019f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f60: 2020 2320 6570 6f63 6820 616e 6420 6176    # epoch and av
+00019f70: 6572 6167 650a 0a20 2020 2020 2020 2020  erage..         
+00019f80: 2020 2020 2020 2020 2020 2020 2020 205f                 _
+00019f90: 5f73 7562 6c6f 6164 5f64 6174 615f 6570  _subload_data_ep
+00019fa0: 6f63 685f 6176 6572 6167 6573 5f5f 6672  och_averages__fr
+00019fb0: 6f6d 5f63 6861 6e6e 656c 5f5f 6279 5f63  om_channel__by_c
+00019fc0: 6f6e 6469 7469 6f6e 5f74 7269 616c 7328  ondition_trials(
+00019fd0: 6461 7461 2c20 6d65 7472 6963 5f76 616c  data, metric_val
+00019fe0: 7565 732c 0a20 2020 2020 2020 2020 2020  ues,.           
+00019ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a050: 2020 2020 6f75 745f 6f66 5f62 6f75 6e64      out_of_bound
-0001a060: 5f6d 6574 686f 642c 0a20 2020 2020 2020  _method,.       
-0001a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a030: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0001a040: 7461 5f72 6561 6465 722c 2063 6861 6e6e  ta_reader, chann
+0001a050: 656c 5f69 6478 2c20 6368 616e 6e65 6c2c  el_idx, channel,
+0001a060: 2063 6861 6e6e 656c 5f64 6174 615b 6368   channel_data[ch
+0001a070: 616e 6e65 6c5d 2c0a 2020 2020 2020 2020  annel],.        
 0001a080: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a090: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a0c0: 2020 6d65 7472 6963 5f63 616c 6c62 6163    metric_callbac
-0001a0d0: 6b73 290a 0a20 2020 2020 2020 2020 2020  ks)..           
-0001a0e0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a100: 2020 2020 2020 2023 2065 706f 6368 206f         # epoch o
-0001a110: 6e6c 790a 2020 2020 2020 2020 2020 2020  nly.            
-0001a120: 2020 2020 2020 2020 2020 2020 5f5f 6570              __ep
-0001a130: 6f63 685f 6461 7461 5f5f 6672 6f6d 5f63  och_data__from_c
-0001a140: 6861 6e6e 656c 5f64 6174 615f 5f62 795f  hannel_data__by_
-0001a150: 7472 6961 6c73 2864 6174 612c 0a20 2020  trials(data,.   
-0001a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a0d0: 206f 6e73 6574 732c 2074 7269 616c 5f6e   onsets, trial_n
+0001a0e0: 756d 5f73 616d 706c 6573 2c20 7472 6961  um_samples, tria
+0001a0f0: 6c5f 6570 6f63 682c 0a20 2020 2020 2020  l_epoch,.       
+0001a100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a150: 2020 6261 7365 6c69 6e65 5f6e 756d 5f73    baseline_num_s
+0001a160: 616d 706c 6573 2c20 6261 7365 6c69 6e65  amples, baseline
+0001a170: 5f6d 6574 686f 642c 2062 6173 656c 696e  _method, baselin
+0001a180: 655f 6570 6f63 682c 0a20 2020 2020 2020  e_epoch,.       
 0001a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1a0: 6368 616e 6e65 6c5f 6964 782c 2063 6861  channel_idx, cha
-0001a1b0: 6e6e 656c 5f64 6174 615b 6368 616e 6e65  nnel_data[channe
-0001a1c0: 6c5d 2c0a 2020 2020 2020 2020 2020 2020  l],.            
+0001a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a200: 2020 2020 2020 2064 6174 615f 7265 6164         data_read
-0001a210: 6572 2e73 616d 706c 696e 675f 7261 7465  er.sampling_rate
-0001a220: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a1e0: 2020 6f75 745f 6f66 5f62 6f75 6e64 5f6d    out_of_bound_m
+0001a1f0: 6574 686f 642c 0a20 2020 2020 2020 2020  ethod,.         
+0001a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a230: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a260: 2020 2020 206f 6e73 6574 732c 2074 7269       onsets, tri
-0001a270: 616c 5f6e 756d 5f73 616d 706c 6573 2c20  al_num_samples, 
-0001a280: 7472 6961 6c5f 6570 6f63 682c 0a20 2020  trial_epoch,.   
-0001a290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2d0: 6261 7365 6c69 6e65 5f6e 756d 5f73 616d  baseline_num_sam
-0001a2e0: 706c 6573 2c20 6261 7365 6c69 6e65 5f6d  ples, baseline_m
-0001a2f0: 6574 686f 642c 0a20 2020 2020 2020 2020  ethod,.         
+0001a250: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
+0001a260: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001a270: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001a280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a290: 2020 2020 2023 2065 706f 6368 206f 6e6c       # epoch onl
+0001a2a0: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+0001a2b0: 2020 2020 2020 2020 2020 5f5f 6570 6f63            __epoc
+0001a2c0: 685f 6461 7461 5f5f 6672 6f6d 5f63 6861  h_data__from_cha
+0001a2d0: 6e6e 656c 5f64 6174 615f 5f62 795f 7472  nnel_data__by_tr
+0001a2e0: 6961 6c73 2864 6174 612c 0a20 2020 2020  ials(data,.     
+0001a2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a330: 2020 2020 2020 2020 2020 6261 7365 6c69            baseli
-0001a340: 6e65 5f65 706f 6368 2c0a 2020 2020 2020  ne_epoch,.      
-0001a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a320: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+0001a330: 616e 6e65 6c5f 6964 782c 2063 6861 6e6e  annel_idx, chann
+0001a340: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
+0001a350: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0001a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a380: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0001a390: 5f6f 665f 626f 756e 645f 6d65 7468 6f64  _of_bound_method
-0001a3a0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0001a3b0: 2020 2065 7863 6570 7420 284d 656d 6f72     except (Memor
-0001a3c0: 7945 7272 6f72 2c20 5275 6e74 696d 6545  yError, RuntimeE
-0001a3d0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-0001a3e0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001a3f0: 2052 756e 7469 6d65 4572 726f 7228 2745   RuntimeError('E
-0001a400: 7272 6f72 2075 706f 6e20 6c6f 6164 696e  rror upon loadin
-0001a410: 6720 616e 6420 6570 6f63 6869 6e67 2064  g and epoching d
-0001a420: 6174 6127 290a 0a20 2020 2020 2020 2020  ata')..         
-0001a430: 2020 2020 2020 2023 7072 696e 7428 6368         #print(ch
-0001a440: 616e 6e65 6c20 2b20 223a 2063 6c65 6172  annel + ": clear
-0001a450: 696e 6720 6368 616e 6e65 6c20 6672 6f6d  ing channel from
-0001a460: 206d 656d 2229 0a0a 2020 2020 2020 2020   mem")..        
-0001a470: 2020 2020 2020 2020 2320 636c 6561 7220          # clear 
-0001a480: 6368 616e 6e65 6c20 6461 7461 2066 726f  channel data fro
-0001a490: 6d20 7468 6520 6368 616e 6e65 6c2d 6461  m the channel-da
-0001a4a0: 7461 206d 6174 7269 780a 2020 2020 2020  ta matrix.      
-0001a4b0: 2020 2020 2020 2020 2020 2320 2861 6c6c            # (all
-0001a4c0: 2077 6520 6e65 6564 6564 2066 726f 6d20   we needed from 
-0001a4d0: 7468 6973 2063 6861 6e6e 656c 2069 7320  this channel is 
-0001a4e0: 6569 7468 6572 2069 6e20 7468 6520 7265  either in the re
-0001a4f0: 2d72 6566 2061 7665 7261 6765 2061 7272  -ref average arr
-0001a500: 6179 7320 6f72 2069 6e20 7468 6520 6570  ays or in the ep
-0001a510: 6f63 6820 6461 7461 2d6d 6174 7269 7820  och data-matrix 
-0001a520: 6e6f 7729 0a20 2020 2020 2020 2020 2020  now).           
-0001a530: 2020 2020 2063 6861 6e6e 656c 5f64 6174       channel_dat
-0001a540: 615b 6368 616e 6e65 6c5d 203d 204e 6f6e  a[channel] = Non
-0001a550: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001a560: 2020 6763 2e63 6f6c 6c65 6374 2829 0a0a    gc.collect()..
-0001a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a580: 2320 6d61 726b 2063 6861 6e6e 656c 2061  # mark channel a
-0001a590: 7320 6570 6f63 682d 6564 2028 6675 6c6c  s epoch-ed (full
-0001a5a0: 7920 7072 6f63 6573 7365 6429 0a20 2020  y processed).   
-0001a5b0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-0001a5c0: 6e6e 656c 5f65 706f 6368 6564 5b63 6861  nnel_epoched[cha
-0001a5d0: 6e6e 656c 5d20 3d20 5472 7565 0a0a 2020  nnel] = True..  
-0001a5e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001a5f0: 7570 6461 7465 2074 6865 2070 726f 6772  update the progr
-0001a600: 6573 7320 6261 720a 2020 2020 2020 2020  ess bar.        
-0001a610: 2020 2020 2020 2020 7570 6461 7465 5f70          update_p
-0001a620: 726f 6772 6573 7362 6172 2829 0a0a 2020  rogressbar()..  
-0001a630: 2020 230a 2020 2020 6966 2061 7665 7261    #.    if avera
-0001a640: 6765 3a0a 2020 2020 2020 2020 7265 7475  ge:.        retu
-0001a650: 726e 2064 6174 615f 7265 6164 6572 2e73  rn data_reader.s
-0001a660: 616d 706c 696e 675f 7261 7465 2c20 6461  ampling_rate, da
-0001a670: 7461 2c20 6d65 7472 6963 5f76 616c 7565  ta, metric_value
-0001a680: 730a 2020 2020 656c 7365 3a0a 2020 2020  s.    else:.    
-0001a690: 2020 2020 7265 7475 726e 2064 6174 615f      return data_
-0001a6a0: 7265 6164 6572 2e73 616d 706c 696e 675f  reader.sampling_
-0001a6b0: 7261 7465 2c20 6461 7461 0a0a            rate, data..
+0001a380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a390: 2020 2020 2064 6174 615f 7265 6164 6572       data_reader
+0001a3a0: 2e73 616d 706c 696e 675f 7261 7465 2c0a  .sampling_rate,.
+0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a3f0: 2020 206f 6e73 6574 732c 2074 7269 616c     onsets, trial
+0001a400: 5f6e 756d 5f73 616d 706c 6573 2c20 7472  _num_samples, tr
+0001a410: 6961 6c5f 6570 6f63 682c 0a20 2020 2020  ial_epoch,.     
+0001a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a450: 2020 2020 2020 2020 2020 2020 2020 6261                ba
+0001a460: 7365 6c69 6e65 5f6e 756d 5f73 616d 706c  seline_num_sampl
+0001a470: 6573 2c20 6261 7365 6c69 6e65 5f6d 6574  es, baseline_met
+0001a480: 686f 642c 0a20 2020 2020 2020 2020 2020  hod,.           
+0001a490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4c0: 2020 2020 2020 2020 6261 7365 6c69 6e65          baseline
+0001a4d0: 5f65 706f 6368 2c0a 2020 2020 2020 2020  _epoch,.        
+0001a4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a510: 2020 2020 2020 2020 2020 206f 7574 5f6f             out_o
+0001a520: 665f 626f 756e 645f 6d65 7468 6f64 290a  f_bound_method).
+0001a530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a540: 2065 7863 6570 7420 284d 656d 6f72 7945   except (MemoryE
+0001a550: 7272 6f72 2c20 5275 6e74 696d 6545 7272  rror, RuntimeErr
+0001a560: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
+0001a570: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+0001a580: 756e 7469 6d65 4572 726f 7228 2745 7272  untimeError('Err
+0001a590: 6f72 2075 706f 6e20 6c6f 6164 696e 6720  or upon loading 
+0001a5a0: 616e 6420 6570 6f63 6869 6e67 2064 6174  and epoching dat
+0001a5b0: 6127 290a 0a20 2020 2020 2020 2020 2020  a')..           
+0001a5c0: 2020 2020 2023 7072 696e 7428 6368 616e       #print(chan
+0001a5d0: 6e65 6c20 2b20 223a 2063 6c65 6172 696e  nel + ": clearin
+0001a5e0: 6720 6368 616e 6e65 6c20 6672 6f6d 206d  g channel from m
+0001a5f0: 656d 2229 0a0a 2020 2020 2020 2020 2020  em")..          
+0001a600: 2020 2020 2020 2320 636c 6561 7220 6368        # clear ch
+0001a610: 616e 6e65 6c20 6461 7461 2066 726f 6d20  annel data from 
+0001a620: 7468 6520 6368 616e 6e65 6c2d 6461 7461  the channel-data
+0001a630: 206d 6174 7269 780a 2020 2020 2020 2020   matrix.        
+0001a640: 2020 2020 2020 2020 2320 2861 6c6c 2077          # (all w
+0001a650: 6520 6e65 6564 6564 2066 726f 6d20 7468  e needed from th
+0001a660: 6973 2063 6861 6e6e 656c 2069 7320 6569  is channel is ei
+0001a670: 7468 6572 2069 6e20 7468 6520 7265 2d72  ther in the re-r
+0001a680: 6566 2061 7665 7261 6765 2061 7272 6179  ef average array
+0001a690: 7320 6f72 2069 6e20 7468 6520 6570 6f63  s or in the epoc
+0001a6a0: 6820 6461 7461 2d6d 6174 7269 7820 6e6f  h data-matrix no
+0001a6b0: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
+0001a6c0: 2020 2063 6861 6e6e 656c 5f64 6174 615b     channel_data[
+0001a6d0: 6368 616e 6e65 6c5d 203d 204e 6f6e 650a  channel] = None.
+0001a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6f0: 6763 2e63 6f6c 6c65 6374 2829 0a0a 2020  gc.collect()..  
+0001a700: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001a710: 6d61 726b 2063 6861 6e6e 656c 2061 7320  mark channel as 
+0001a720: 6570 6f63 682d 6564 2028 6675 6c6c 7920  epoch-ed (fully 
+0001a730: 7072 6f63 6573 7365 6429 0a20 2020 2020  processed).     
+0001a740: 2020 2020 2020 2020 2020 2063 6861 6e6e             chann
+0001a750: 656c 5f65 706f 6368 6564 5b63 6861 6e6e  el_epoched[chann
+0001a760: 656c 5d20 3d20 5472 7565 0a0a 2020 2020  el] = True..    
+0001a770: 2020 2020 2020 2020 2020 2020 2320 7570              # up
+0001a780: 6461 7465 2074 6865 2070 726f 6772 6573  date the progres
+0001a790: 7320 6261 720a 2020 2020 2020 2020 2020  s bar.          
+0001a7a0: 2020 2020 2020 7570 6461 7465 5f70 726f        update_pro
+0001a7b0: 6772 6573 7362 6172 2829 0a0a 2020 2020  gressbar()..    
+0001a7c0: 230a 2020 2020 6966 2061 7665 7261 6765  #.    if average
+0001a7d0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0001a7e0: 2064 6174 615f 7265 6164 6572 2e73 616d   data_reader.sam
+0001a7f0: 706c 696e 675f 7261 7465 2c20 6461 7461  pling_rate, data
+0001a800: 2c20 6d65 7472 6963 5f76 616c 7565 730a  , metric_values.
+0001a810: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001a820: 2020 7265 7475 726e 2064 6174 615f 7265    return data_re
+0001a830: 6164 6572 2e73 616d 706c 696e 675f 7261  ader.sampling_ra
+0001a840: 7465 2c20 6461 7461 0a0a 0a0a 0a22 2222  te, data....."""
+0001a850: 0a64 6566 205f 5f6c 6f61 645f 6461 7461  .def __load_data
+0001a860: 5f65 706f 6368 735f 5f62 795f 6368 616e  _epochs__by_chan
+0001a870: 6e65 6c73 5f5f 7769 7468 5072 6570 5f65  nels__withPrep_e
+0001a880: 6172 6c79 4570 6f63 6828 6176 6572 6167  arlyEpoch(averag
+0001a890: 652c 2064 6174 615f 7265 6164 6572 2c20  e, data_reader, 
+0001a8a0: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
+0001a8b0: 732c 206f 6e73 6574 732c 0a20 2020 2020  s, onsets,.     
+0001a8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a8f0: 2020 2020 7472 6961 6c5f 6570 6f63 682c      trial_epoch,
+0001a900: 2062 6173 656c 696e 655f 6d65 7468 6f64   baseline_method
+0001a910: 2c20 6261 7365 6c69 6e65 5f65 706f 6368  , baseline_epoch
+0001a920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a950: 2020 2020 2020 2020 2020 206f 7574 5f6f             out_o
+0001a960: 665f 626f 756e 645f 6d65 7468 6f64 2c20  f_bound_method, 
+0001a970: 6d65 7472 6963 5f63 616c 6c62 6163 6b73  metric_callbacks
+0001a980: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9b0: 2020 2020 2020 2020 2020 2068 6967 685f             high_
+0001a9c0: 7061 7373 2c20 6561 726c 795f 7265 7265  pass, early_rere
+0001a9d0: 662c 206c 696e 655f 6e6f 6973 655f 7265  f, line_noise_re
+0001a9e0: 6d6f 7661 6c2c 206c 6174 655f 7265 7265  moval, late_rere
+0001a9f0: 662c 2070 7269 6f72 6974 7929 3a0a 0a20  f, priority):.. 
+0001aa00: 2020 2023 2063 616c 6375 6c61 7465 2074     # calculate t
+0001aa10: 6865 2073 697a 6520 6f66 2074 6865 2074  he size of the t
+0001aa20: 696d 6520 6469 6d65 6e73 696f 6e20 2869  ime dimension (i
+0001aa30: 6e20 7361 6d70 6c65 7329 0a20 2020 2074  n samples).    t
+0001aa40: 7269 616c 5f6e 756d 5f73 616d 706c 6573  rial_num_samples
+0001aa50: 203d 2069 6e74 2872 6f75 6e64 2861 6273   = int(round(abs
+0001aa60: 2874 7269 616c 5f65 706f 6368 5b31 5d20  (trial_epoch[1] 
+0001aa70: 2d20 7472 6961 6c5f 6570 6f63 685b 305d  - trial_epoch[0]
+0001aa80: 2920 2a20 6461 7461 5f72 6561 6465 722e  ) * data_reader.
+0001aa90: 7361 6d70 6c69 6e67 5f72 6174 6529 290a  sampling_rate)).
+0001aaa0: 2020 2020 6261 7365 6c69 6e65 5f6e 756d      baseline_num
+0001aab0: 5f73 616d 706c 6573 203d 2069 6e74 2872  _samples = int(r
+0001aac0: 6f75 6e64 2861 6273 2862 6173 656c 696e  ound(abs(baselin
+0001aad0: 655f 6570 6f63 685b 315d 202d 2062 6173  e_epoch[1] - bas
+0001aae0: 656c 696e 655f 6570 6f63 685b 305d 2920  eline_epoch[0]) 
+0001aaf0: 2a20 6461 7461 5f72 6561 6465 722e 7361  * data_reader.sa
+0001ab00: 6d70 6c69 6e67 5f72 6174 6529 290a 0a20  mpling_rate)).. 
+0001ab10: 2020 2023 2069 6e69 7469 616c 697a 6520     # initialize 
+0001ab20: 6120 6461 7461 2062 7566 6665 7220 2863  a data buffer (c
+0001ab30: 6861 6e6e 656c 2078 2074 7269 616c 732f  hannel x trials/
+0001ab40: 6570 6f63 6873 2078 2074 696d 6529 0a20  epochs x time). 
+0001ab50: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001ab60: 6461 7461 203d 2061 6c6c 6f63 6174 655f  data = allocate_
+0001ab70: 6172 7261 7928 286c 656e 2872 6574 7269  array((len(retri
+0001ab80: 6576 655f 6368 616e 6e65 6c73 292c 206c  eve_channels), l
+0001ab90: 656e 286f 6e73 6574 7329 2c20 7472 6961  en(onsets), tria
+0001aba0: 6c5f 6e75 6d5f 7361 6d70 6c65 7329 290a  l_num_samples)).
+0001abb0: 2020 2020 6578 6365 7074 204d 656d 6f72      except Memor
+0001abc0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+0001abd0: 7261 6973 6520 4d65 6d6f 7279 4572 726f  raise MemoryErro
+0001abe0: 7228 274e 6f74 2065 6e6f 7567 6820 6d65  r('Not enough me
+0001abf0: 6d6f 7279 2063 7265 6174 6520 6120 6461  mory create a da
+0001ac00: 7461 206f 7574 7075 7420 6d61 7472 6978  ta output matrix
+0001ac10: 2729 0a0a 2020 2020 2320 696e 6974 6961  ')..    # initia
+0001ac20: 6c69 7a65 2061 206d 6574 7269 6320 6275  lize a metric bu
+0001ac30: 6666 6572 2028 6368 616e 6e65 6c20 7820  ffer (channel x 
+0001ac40: 636f 6e64 6974 696f 6e73 2078 206d 6574  conditions x met
+0001ac50: 7269 6329 0a20 2020 2069 6620 6176 6572  ric).    if aver
+0001ac60: 6167 653a 0a20 2020 2020 2020 2074 7279  age:.        try
+0001ac70: 3a0a 2020 2020 2020 2020 2020 2020 6d65  :.            me
+0001ac80: 7472 6963 5f76 616c 7565 7320 3d20 4e6f  tric_values = No
+0001ac90: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
+0001aca0: 6620 6d65 7472 6963 5f63 616c 6c62 6163  f metric_callbac
+0001acb0: 6b73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ks is not None:.
+0001acc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001acd0: 6966 2063 616c 6c61 626c 6528 6d65 7472  if callable(metr
+0001ace0: 6963 5f63 616c 6c62 6163 6b73 293a 0a20  ic_callbacks):. 
+0001acf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ad00: 2020 206d 6574 7269 635f 7661 6c75 6573     metric_values
+0001ad10: 203d 2061 6c6c 6f63 6174 655f 6172 7261   = allocate_arra
+0001ad20: 7928 286c 656e 2872 6574 7269 6576 655f  y((len(retrieve_
+0001ad30: 6368 616e 6e65 6c73 292c 206c 656e 286f  channels), len(o
+0001ad40: 6e73 6574 7329 2929 0a20 2020 2020 2020  nsets))).       
+0001ad50: 2020 2020 2020 2020 2065 6c69 6620 7479           elif ty
+0001ad60: 7065 286d 6574 7269 635f 6361 6c6c 6261  pe(metric_callba
+0001ad70: 636b 7329 2069 7320 7475 706c 6520 616e  cks) is tuple an
+0001ad80: 6420 6c65 6e28 6d65 7472 6963 5f63 616c  d len(metric_cal
+0001ad90: 6c62 6163 6b73 2920 3e20 303a 0a20 2020  lbacks) > 0:.   
+0001ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adb0: 206d 6574 7269 635f 7661 6c75 6573 203d   metric_values =
+0001adc0: 2061 6c6c 6f63 6174 655f 6172 7261 7928   allocate_array(
+0001add0: 286c 656e 2872 6574 7269 6576 655f 6368  (len(retrieve_ch
+0001ade0: 616e 6e65 6c73 292c 206c 656e 286f 6e73  annels), len(ons
+0001adf0: 6574 7329 2c20 6c65 6e28 6d65 7472 6963  ets), len(metric
+0001ae00: 5f63 616c 6c62 6163 6b73 2929 290a 2020  _callbacks))).  
+0001ae10: 2020 2020 2020 6578 6365 7074 204d 656d        except Mem
+0001ae20: 6f72 7945 7272 6f72 3a0a 2020 2020 2020  oryError:.      
+0001ae30: 2020 2020 2020 7261 6973 6520 4d65 6d6f        raise Memo
+0001ae40: 7279 4572 726f 7228 274e 6f74 2065 6e6f  ryError('Not eno
+0001ae50: 7567 6820 6d65 6d6f 7279 2063 7265 6174  ugh memory creat
+0001ae60: 6520 6120 6d65 7472 6963 206f 7574 7075  e a metric outpu
+0001ae70: 7420 6d61 7472 6978 2729 0a0a 2020 2020  t matrix')..    
+0001ae80: 2320 6372 6561 7465 2061 206c 6973 7420  # create a list 
+0001ae90: 6f66 2061 6c6c 2063 6861 6e6e 656c 7320  of all channels 
+0001aea0: 7468 6174 2077 6520 6e65 6564 2c20 6d6f  that we need, mo
+0001aeb0: 7374 2077 6974 6820 7468 6520 7075 7270  st with the purp
+0001aec0: 6f73 6520 6f66 2072 6561 6469 6e67 2061  ose of reading a
+0001aed0: 6e64 2072 6574 7572 6e69 6e67 2028 652e  nd returning (e.
+0001aee0: 672e 206f 6e6c 7920 4543 6f47 2920 6275  g. only ECoG) bu
+0001aef0: 7420 736f 6d65 206f 6e6c 7920 746f 2062  t some only to b
+0001af00: 6520 7573 6564 2066 6f72 2072 652d 7265  e used for re-re
+0001af10: 6665 7265 6e63 696e 6720 2865 2e67 2e20  ferencing (e.g. 
+0001af20: 626f 7468 2045 436f 4720 616e 6420 5345  both ECoG and SE
+0001af30: 4547 290a 2020 2020 616c 6c5f 6368 616e  EG).    all_chan
+0001af40: 6e65 6c73 203d 2072 6574 7269 6576 655f  nels = retrieve_
+0001af50: 6368 616e 6e65 6c73 2e63 6f70 7928 290a  channels.copy().
+0001af60: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001af70: 2069 6620 6561 726c 795f 7265 7265 6620   if early_reref 
+0001af80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001af90: 2020 2020 2020 2020 2065 6172 6c79 5f72           early_r
+0001afa0: 6571 5f63 6861 6e6e 656c 7320 3d20 6561  eq_channels = ea
+0001afb0: 726c 795f 7265 7265 662e 6765 745f 7265  rly_reref.get_re
+0001afc0: 7175 6972 6564 5f63 6861 6e6e 656c 7328  quired_channels(
+0001afd0: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
+0001afe0: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
+0001aff0: 6172 6c79 5f72 6571 5f67 726f 7570 7320  arly_req_groups 
+0001b000: 3d20 6561 726c 795f 7265 7265 662e 6765  = early_reref.ge
+0001b010: 745f 7265 7175 6972 6564 5f67 726f 7570  t_required_group
+0001b020: 7328 7265 7472 6965 7665 5f63 6861 6e6e  s(retrieve_chann
+0001b030: 656c 7329 0a20 2020 2020 2020 2020 2020  els).           
+0001b040: 2066 6f72 2063 6861 6e6e 656c 2069 6e20   for channel in 
+0001b050: 6561 726c 795f 7265 715f 6368 616e 6e65  early_req_channe
+0001b060: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+0001b070: 2020 2020 6966 2063 6861 6e6e 656c 206e      if channel n
+0001b080: 6f74 2069 6e20 616c 6c5f 6368 616e 6e65  ot in all_channe
+0001b090: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
+0001b0a0: 2020 2020 2020 2020 616c 6c5f 6368 616e          all_chan
+0001b0b0: 6e65 6c73 2e61 7070 656e 6428 6368 616e  nels.append(chan
+0001b0c0: 6e65 6c29 0a20 2020 2020 2020 2069 6620  nel).        if 
+0001b0d0: 6c61 7465 5f72 6572 6566 2069 7320 6e6f  late_reref is no
+0001b0e0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001b0f0: 2020 2020 6c61 7465 5f72 6571 5f63 6861      late_req_cha
+0001b100: 6e6e 656c 7320 3d20 6c61 7465 5f72 6572  nnels = late_rer
+0001b110: 6566 2e67 6574 5f72 6571 7569 7265 645f  ef.get_required_
+0001b120: 6368 616e 6e65 6c73 2872 6574 7269 6576  channels(retriev
+0001b130: 655f 6368 616e 6e65 6c73 290a 2020 2020  e_channels).    
+0001b140: 2020 2020 2020 2020 6c61 7465 5f72 6571          late_req
+0001b150: 5f67 726f 7570 7320 3d20 6c61 7465 5f72  _groups = late_r
+0001b160: 6572 6566 2e67 6574 5f72 6571 7569 7265  eref.get_require
+0001b170: 645f 6772 6f75 7073 2872 6574 7269 6576  d_groups(retriev
+0001b180: 655f 6368 616e 6e65 6c73 290a 2020 2020  e_channels).    
+0001b190: 2020 2020 2020 2020 666f 7220 6368 616e          for chan
+0001b1a0: 6e65 6c20 696e 206c 6174 655f 7265 715f  nel in late_req_
+0001b1b0: 6368 616e 6e65 6c73 3a0a 2020 2020 2020  channels:.      
+0001b1c0: 2020 2020 2020 2020 2020 6966 2063 6861            if cha
+0001b1d0: 6e6e 656c 206e 6f74 2069 6e20 616c 6c5f  nnel not in all_
+0001b1e0: 6368 616e 6e65 6c73 3a0a 2020 2020 2020  channels:.      
+0001b1f0: 2020 2020 2020 2020 2020 2020 2020 616c                al
+0001b200: 6c5f 6368 616e 6e65 6c73 2e61 7070 656e  l_channels.appen
+0001b210: 6428 6368 616e 6e65 6c29 0a20 2020 2065  d(channel).    e
+0001b220: 7863 6570 7420 5661 6c75 6545 7272 6f72  xcept ValueError
+0001b230: 3a0a 2020 2020 2020 2020 6c6f 6767 696e  :.        loggin
+0001b240: 672e 6572 726f 7228 2743 6f75 6c64 206e  g.error('Could n
+0001b250: 6f74 2066 696e 6420 6120 6368 616e 6e65  ot find a channe
+0001b260: 6c20 7468 6174 2069 7320 746f 2062 6520  l that is to be 
+0001b270: 7573 6564 2066 6f72 2065 6172 6c79 206f  used for early o
+0001b280: 7220 6c61 7465 2072 652d 7265 6665 7265  r late re-refere
+0001b290: 6e63 696e 6720 696e 2074 6865 2072 6572  ncing in the rer
+0001b2a0: 6566 2073 7472 7563 7427 290a 2020 2020  ef struct').    
+0001b2b0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+0001b2c0: 7272 6f72 2827 436f 756c 6420 6e6f 7420  rror('Could not 
+0001b2d0: 6669 6e64 2061 2063 6861 6e6e 656c 2074  find a channel t
+0001b2e0: 6861 7420 6973 2074 6f20 7265 7472 6965  hat is to retrie
+0001b2f0: 7665 6420 696e 2074 6865 2072 6572 6566  ved in the reref
+0001b300: 2073 7472 7563 7427 290a 0a0a 2020 2020   struct')...    
+0001b310: 230a 2020 2020 2320 496e 6974 6961 6c69  #.    # Initiali
+0001b320: 7a65 2076 6172 6961 626c 6520 7468 6174  ze variable that
+0001b330: 2074 7261 636b 2070 726f 6365 7373 696e   track processin
+0001b340: 670a 2020 2020 230a 0a20 2020 2063 6861  g.    #..    cha
+0001b350: 6e6e 656c 5f65 706f 6368 5f70 726f 6365  nnel_epoch_proce
+0001b360: 7373 6564 203d 2064 6963 7428 2920 2020  ssed = dict()   
+0001b370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b380: 2020 2020 2023 2074 7261 636b 7320 666f       # tracks fo
+0001b390: 7220 6561 6368 2063 6861 6e6e 656c 2077  r each channel w
+0001b3a0: 6865 7468 6572 2069 7420 6861 7320 6265  hether it has be
+0001b3b0: 656e 2065 706f 6368 6564 2028 6675 6c6c  en epoched (full
+0001b3c0: 7920 7072 6f63 6573 7365 6429 0a20 2020  y processed).   
+0001b3d0: 2066 6f72 2063 6861 6e6e 656c 2069 6e20   for channel in 
+0001b3e0: 7265 7472 6965 7665 5f63 6861 6e6e 656c  retrieve_channel
+0001b3f0: 733a 0a20 2020 2020 2020 2063 6861 6e6e  s:.        chann
+0001b400: 656c 5f65 706f 6368 5f70 726f 6365 7373  el_epoch_process
+0001b410: 6564 5b63 6861 6e6e 656c 5d20 3d20 5b46  ed[channel] = [F
+0001b420: 616c 7365 5d20 2a20 6c65 6e28 6f6e 7365  alse] * len(onse
+0001b430: 7473 290a 0a20 2020 2069 6620 6561 726c  ts)..    if earl
+0001b440: 795f 7265 7265 6620 6973 206e 6f74 204e  y_reref is not N
+0001b450: 6f6e 653a 0a20 2020 2020 2020 2023 6368  one:.        #ch
+0001b460: 616e 6e65 6c5f 6561 726c 795f 7265 7265  annel_early_rere
+0001b470: 665f 636f 6c6c 6563 7465 6420 3d20 6469  f_collected = di
+0001b480: 6374 2829 2020 2020 2020 2020 2020 2320  ct()          # 
+0001b490: 7472 6163 6b73 2066 6f72 2065 6163 6820  tracks for each 
+0001b4a0: 6368 616e 6e65 6c20 6966 2074 6865 2063  channel if the c
+0001b4b0: 6861 6e6e 656c 2d64 6174 6120 6973 2061  hannel-data is a
+0001b4c0: 6464 6564 2074 6f20 7468 6520 6561 726c  dded to the earl
+0001b4d0: 7920 7265 2d72 6566 2067 726f 7570 2061  y re-ref group a
+0001b4e0: 7665 7261 6765 730a 2020 2020 2020 2020  verages.        
+0001b4f0: 2366 6f72 2063 6861 6e6e 656c 2069 6e20  #for channel in 
+0001b500: 6561 726c 795f 7265 715f 6368 616e 6e65  early_req_channe
+0001b510: 6c73 3a0a 2020 2020 2020 2020 2320 2020  ls:.        #   
+0001b520: 2063 6861 6e6e 656c 5f65 6172 6c79 5f72   channel_early_r
+0001b530: 6572 6566 5f63 6f6c 6c65 6374 6564 5b63  eref_collected[c
+0001b540: 6861 6e6e 656c 5d20 3d20 4661 6c73 650a  hannel] = False.
+0001b550: 0a20 2020 2020 2020 2065 6172 6c79 5f67  .        early_g
+0001b560: 726f 7570 5f64 6174 6120 3d20 6469 6374  roup_data = dict
+0001b570: 2829 2020 2020 2020 2020 2020 2020 2020  ()              
+0001b580: 2020 2020 2020 2020 2023 2066 6f72 2065           # for e
+0001b590: 6163 6820 6561 726c 7920 7265 2d72 6566  ach early re-ref
+0001b5a0: 2067 726f 7570 2073 746f 7265 7320 7468   group stores th
+0001b5b0: 6520 2874 6f74 616c 2f61 7665 7261 6765  e (total/average
+0001b5c0: 2920 6461 7461 0a20 2020 2020 2020 2065  ) data.        e
+0001b5d0: 6172 6c79 5f67 726f 7570 5f6e 756d 6461  arly_group_numda
+0001b5e0: 7461 203d 2064 6963 7428 2920 2020 2020  ta = dict()     
+0001b5f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001b600: 2066 6f72 2065 6163 6820 6561 726c 7920   for each early 
+0001b610: 7265 2d72 6566 2067 726f 7570 2073 746f  re-ref group sto
+0001b620: 7265 7320 7468 6520 6e75 6d20 6f66 2073  res the num of s
+0001b630: 616d 706c 6573 2066 6f72 2065 6163 6820  amples for each 
+0001b640: 6461 7461 706f 696e 7420 696e 2074 6865  datapoint in the
+0001b650: 2028 746f 7461 6c29 2064 6174 610a 2020   (total) data.  
+0001b660: 2020 2020 2020 6561 726c 795f 6772 6f75        early_grou
+0001b670: 705f 6368 616e 6e65 6c73 5f63 6f6c 6c65  p_channels_colle
+0001b680: 6374 6564 203d 2064 6963 7428 2920 2020  cted = dict()   
+0001b690: 2020 2020 2020 2320 7472 6163 6b73 2066        # tracks f
+0001b6a0: 6f72 2065 6163 6820 6561 726c 7920 7265  or each early re
+0001b6b0: 2d72 6566 2067 726f 7570 2061 6c6c 2074  -ref group all t
+0001b6c0: 6865 2063 6861 6e6e 656c 7320 7468 6174  he channels that
+0001b6d0: 206e 6565 6420 746f 2062 6520 636f 6c6c   need to be coll
+0001b6e0: 6563 7465 640a 2020 2020 2020 2020 666f  ected.        fo
+0001b6f0: 7220 6772 6f75 7020 696e 2065 6172 6c79  r group in early
+0001b700: 5f72 6571 5f67 726f 7570 733a 0a20 2020  _req_groups:.   
+0001b710: 2020 2020 2020 2020 2065 6172 6c79 5f67           early_g
+0001b720: 726f 7570 5f64 6174 615b 7374 7228 6772  roup_data[str(gr
+0001b730: 6f75 7029 5d20 3d20 4e6f 6e65 0a20 2020  oup)] = None.   
+0001b740: 2020 2020 2020 2020 2065 6172 6c79 5f67           early_g
+0001b750: 726f 7570 5f6e 756d 6461 7461 5b73 7472  roup_numdata[str
+0001b760: 2867 726f 7570 295d 203d 204e 6f6e 650a  (group)] = None.
+0001b770: 2020 2020 2020 2020 2020 2020 6561 726c              earl
+0001b780: 795f 6772 6f75 705f 6368 616e 6e65 6c73  y_group_channels
+0001b790: 5f63 6f6c 6c65 6374 6564 5b73 7472 2867  _collected[str(g
+0001b7a0: 726f 7570 295d 203d 2064 6963 7428 290a  roup)] = dict().
+0001b7b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001b7c0: 6368 616e 6e65 6c20 696e 2065 6172 6c79  channel in early
+0001b7d0: 5f72 6572 6566 2e67 726f 7570 735b 6772  _reref.groups[gr
+0001b7e0: 6f75 705d 3a0a 2020 2020 2020 2020 2020  oup]:.          
+0001b7f0: 2020 2020 2020 6561 726c 795f 6772 6f75        early_grou
+0001b800: 705f 6368 616e 6e65 6c73 5f63 6f6c 6c65  p_channels_colle
+0001b810: 6374 6564 5b73 7472 2867 726f 7570 295d  cted[str(group)]
+0001b820: 5b63 6861 6e6e 656c 5d20 3d20 4661 6c73  [channel] = Fals
+0001b830: 650a 0a20 2020 2069 6620 6c61 7465 5f72  e..    if late_r
+0001b840: 6572 6566 2069 7320 6e6f 7420 4e6f 6e65  eref is not None
+0001b850: 3a0a 2020 2020 2020 2020 2363 6861 6e6e  :.        #chann
+0001b860: 656c 5f6c 6174 655f 7265 7265 665f 636f  el_late_reref_co
+0001b870: 6c6c 6563 7465 6420 3d20 6469 6374 2829  llected = dict()
+0001b880: 2020 2020 2020 2020 2020 2320 7472 6163            # trac
+0001b890: 6b73 2066 6f72 2065 6163 6820 6368 616e  ks for each chan
+0001b8a0: 6e65 6c20 6966 2074 6865 2063 6861 6e6e  nel if the chann
+0001b8b0: 656c 2d64 6174 6120 6973 2061 6464 6564  el-data is added
+0001b8c0: 2074 6f20 7468 6520 6c61 7465 2072 652d   to the late re-
+0001b8d0: 7265 6620 6772 6f75 7020 6176 6572 6167  ref group averag
+0001b8e0: 6573 0a20 2020 2020 2020 2023 666f 7220  es.        #for 
+0001b8f0: 6368 616e 6e65 6c20 696e 206c 6174 655f  channel in late_
+0001b900: 7265 715f 6368 616e 6e65 6c73 3a0a 2020  req_channels:.  
+0001b910: 2020 2020 2020 2320 2020 2063 6861 6e6e        #    chann
+0001b920: 656c 5f6c 6174 655f 7265 7265 665f 636f  el_late_reref_co
+0001b930: 6c6c 6563 7465 645b 6368 616e 6e65 6c5d  llected[channel]
+0001b940: 203d 2046 616c 7365 0a0a 2020 2020 2020   = False..      
+0001b950: 2020 6c61 7465 5f67 726f 7570 5f64 6174    late_group_dat
+0001b960: 6120 3d20 6469 6374 2829 2020 2020 2020  a = dict()      
+0001b970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b980: 2020 2320 666f 7220 6561 6368 206c 6174    # for each lat
+0001b990: 6520 7265 2d72 6566 2067 726f 7570 2073  e re-ref group s
+0001b9a0: 746f 7265 7320 7468 6520 2874 6f74 616c  tores the (total
+0001b9b0: 2f61 7665 7261 6765 2920 6461 7461 0a20  /average) data. 
+0001b9c0: 2020 2020 2020 206c 6174 655f 6772 6f75         late_grou
+0001b9d0: 705f 6e75 6d64 6174 6120 3d20 6469 6374  p_numdata = dict
+0001b9e0: 2829 2020 2020 2020 2020 2020 2020 2020  ()              
+0001b9f0: 2020 2020 2020 2023 2066 6f72 2065 6163         # for eac
+0001ba00: 6820 6c61 7465 2072 652d 7265 6620 6772  h late re-ref gr
+0001ba10: 6f75 7020 7374 6f72 6573 2074 6865 206e  oup stores the n
+0001ba20: 756d 206f 6620 7361 6d70 6c65 7320 666f  um of samples fo
+0001ba30: 7220 6561 6368 2064 6174 6170 6f69 6e74  r each datapoint
+0001ba40: 2069 6e20 7468 6520 2874 6f74 616c 2920   in the (total) 
+0001ba50: 6461 7461 0a20 2020 2020 2020 206c 6174  data.        lat
+0001ba60: 655f 6772 6f75 705f 6368 616e 6e65 6c73  e_group_channels
+0001ba70: 5f63 6f6c 6c65 6374 6564 203d 2064 6963  _collected = dic
+0001ba80: 7428 2920 2020 2020 2020 2020 2023 2074  t()          # t
+0001ba90: 7261 636b 7320 666f 7220 6561 6368 206c  racks for each l
+0001baa0: 6174 6520 7265 2d72 6566 2067 726f 7570  ate re-ref group
+0001bab0: 2061 6c6c 2074 6865 2063 6861 6e6e 656c   all the channel
+0001bac0: 7320 7468 6174 206e 6565 6420 746f 2062  s that need to b
+0001bad0: 6520 636f 6c6c 6563 7465 640a 2020 2020  e collected.    
+0001bae0: 2020 2020 666f 7220 6772 6f75 7020 696e      for group in
+0001baf0: 206c 6174 655f 7265 715f 6772 6f75 7073   late_req_groups
+0001bb00: 3a0a 2020 2020 2020 2020 2020 2020 6c61  :.            la
+0001bb10: 7465 5f67 726f 7570 5f64 6174 615b 7374  te_group_data[st
+0001bb20: 7228 6772 6f75 7029 5d20 3d20 4e6f 6e65  r(group)] = None
+0001bb30: 0a20 2020 2020 2020 2020 2020 206c 6174  .            lat
+0001bb40: 655f 6772 6f75 705f 6e75 6d64 6174 615b  e_group_numdata[
+0001bb50: 7374 7228 6772 6f75 7029 5d20 3d20 4e6f  str(group)] = No
+0001bb60: 6e65 0a20 2020 2020 2020 2020 2020 206c  ne.            l
+0001bb70: 6174 655f 6772 6f75 705f 6368 616e 6e65  ate_group_channe
+0001bb80: 6c73 5f63 6f6c 6c65 6374 6564 5b73 7472  ls_collected[str
+0001bb90: 2867 726f 7570 295d 203d 2064 6963 7428  (group)] = dict(
+0001bba0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0001bbb0: 7220 6368 616e 6e65 6c20 696e 206c 6174  r channel in lat
+0001bbc0: 655f 7265 7265 662e 6772 6f75 7073 5b67  e_reref.groups[g
+0001bbd0: 726f 7570 5d3a 0a20 2020 2020 2020 2020  roup]:.         
+0001bbe0: 2020 2020 2020 206c 6174 655f 6772 6f75         late_grou
+0001bbf0: 705f 6368 616e 6e65 6c73 5f63 6f6c 6c65  p_channels_colle
+0001bc00: 6374 6564 5b73 7472 2867 726f 7570 295d  cted[str(group)]
+0001bc10: 5b63 6861 6e6e 656c 5d20 3d20 4661 6c73  [channel] = Fals
+0001bc20: 650a 0a20 2020 2063 6861 6e6e 656c 5f64  e..    channel_d
+0001bc30: 6174 6120 3d20 6469 6374 2829 0a20 2020  ata = dict().   
+0001bc40: 2063 6861 6e6e 656c 5f68 705f 6170 706c   channel_hp_appl
+0001bc50: 6965 6420 3d20 6469 6374 2829 2020 2020  ied = dict()    
+0001bc60: 2020 2020 2020 2020 2020 2320 7472 6163            # trac
+0001bc70: 6b73 2066 6f72 2065 6163 6820 6368 616e  ks for each chan
+0001bc80: 6e65 6c20 696e 2074 6865 2063 6861 6e6e  nel in the chann
+0001bc90: 656c 2d64 6174 6120 6d61 7472 6978 2069  el-data matrix i
+0001bca0: 6620 6869 6768 2d70 6173 7320 6669 6c74  f high-pass filt
+0001bcb0: 6572 696e 6720 6973 2061 7070 6c69 6564  ering is applied
+0001bcc0: 0a20 2020 2023 6368 616e 6e65 6c5f 6561  .    #channel_ea
+0001bcd0: 726c 795f 6170 706c 6965 6420 3d20 6469  rly_applied = di
+0001bce0: 6374 2829 2020 2020 2020 2020 2020 2023  ct()           #
+0001bcf0: 2074 7261 636b 7320 666f 7220 6561 6368   tracks for each
+0001bd00: 2063 6861 6e6e 656c 2069 6e20 7468 6520   channel in the 
+0001bd10: 6368 616e 6e65 6c2d 6461 7461 206d 6174  channel-data mat
+0001bd20: 7269 7820 6966 2065 6172 6c79 2072 652d  rix if early re-
+0001bd30: 7265 6620 6973 2061 7070 6c69 6564 0a20  ref is applied. 
+0001bd40: 2020 2063 6861 6e6e 656c 5f6c 6e72 5f61     channel_lnr_a
+0001bd50: 7070 6c69 6564 203d 2064 6963 7428 2920  pplied = dict() 
+0001bd60: 2020 2020 2020 2020 2020 2020 2320 7472              # tr
+0001bd70: 6163 6b73 2066 6f72 2065 6163 6820 6368  acks for each ch
+0001bd80: 616e 6e65 6c20 696e 2074 6865 2063 6861  annel in the cha
+0001bd90: 6e6e 656c 2d64 6174 6120 6d61 7472 6978  nnel-data matrix
+0001bda0: 2069 6620 6c69 6e65 2d6e 6f69 7365 2072   if line-noise r
+0001bdb0: 656d 6f76 616c 2069 7320 6170 706c 6965  emoval is applie
+0001bdc0: 640a 2020 2020 666f 7220 6368 616e 6e65  d.    for channe
+0001bdd0: 6c20 696e 2061 6c6c 5f63 6861 6e6e 656c  l in all_channel
+0001bde0: 733a 0a20 2020 2020 2020 2063 6861 6e6e  s:.        chann
+0001bdf0: 656c 5f64 6174 615b 6368 616e 6e65 6c5d  el_data[channel]
+0001be00: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0001be10: 6368 616e 6e65 6c5f 6870 5f61 7070 6c69  channel_hp_appli
+0001be20: 6564 5b63 6861 6e6e 656c 5d20 3d20 4661  ed[channel] = Fa
+0001be30: 6c73 650a 2020 2020 2020 2020 2363 6861  lse.        #cha
+0001be40: 6e6e 656c 5f65 6172 6c79 5f61 7070 6c69  nnel_early_appli
+0001be50: 6564 5b63 6861 6e6e 656c 5d20 3d20 4661  ed[channel] = Fa
+0001be60: 6c73 650a 2020 2020 2020 2020 6368 616e  lse.        chan
+0001be70: 6e65 6c5f 6c6e 725f 6170 706c 6965 645b  nel_lnr_applied[
+0001be80: 6368 616e 6e65 6c5d 203d 2046 616c 7365  channel] = False
+0001be90: 0a0a 0a20 2020 2023 0a20 2020 2023 2050  ...    #.    # P
+0001bea0: 7265 7061 7265 2066 696c 7465 7273 0a20  repare filters. 
+0001beb0: 2020 2023 0a0a 2020 2020 6966 2068 6967     #..    if hig
+0001bec0: 685f 7061 7373 2069 7320 6e6f 7420 4e6f  h_pass is not No
+0001bed0: 6e65 3a0a 0a20 2020 2020 2020 206f 7264  ne:..        ord
+0001bee0: 6572 203d 2032 0a20 2020 2020 2020 2066  er = 2.        f
+0001bef0: 7320 3d20 6461 7461 5f72 6561 6465 722e  s = data_reader.
+0001bf00: 7361 6d70 6c69 6e67 5f72 6174 650a 2020  sampling_rate.  
+0001bf10: 2020 2020 2020 7061 7373 5f66 7265 7120        pass_freq 
+0001bf20: 3d20 302e 3530 2020 2020 2023 2048 7a20  = 0.50     # Hz 
+0001bf30: 3c3c 3c3c 0a20 2020 2020 2020 2073 746f  <<<<.        sto
+0001bf40: 705f 6672 6571 203d 2030 2e30 3520 2020  p_freq = 0.05   
+0001bf50: 2020 2320 487a 0a20 2020 2020 2020 2070    # Hz.        p
+0001bf60: 6173 735f 7269 7070 6c65 203d 2033 2020  ass_ripple = 3  
+0001bf70: 2020 2020 2320 6442 0a20 2020 2020 2020      # dB.       
+0001bf80: 2073 746f 705f 6174 7465 6e20 3d20 3330   stop_atten = 30
+0001bf90: 2020 2020 2020 2320 6442 0a0a 2020 2020        # dB..    
+0001bfa0: 2020 2020 2320 544f 444f 3a20 6d61 746c      # TODO: matl
+0001bfb0: 6162 2061 6c73 6f20 616c 6c6f 7773 2070  ab also allows p
+0001bfc0: 6173 7369 6e67 206f 6620 7374 6f70 6261  assing of stopba
+0001bfd0: 6e64 2028 6275 7474 6f72 6429 2c20 686f  nd (buttord), ho
+0001bfe0: 7765 7665 7220 6765 7474 696e 6720 7468  wever getting th
+0001bff0: 6520 7361 6d65 2076 616c 7565 7320 6f75  e same values ou
+0001c000: 7420 6f66 2070 7974 686f 6e20 6275 7474  t of python butt
+0001c010: 6f72 6420 6973 2064 6966 6669 6375 6c74  ord is difficult
+0001c020: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+0001c030: 2073 6574 746c 696e 6720 666f 7220 7374   settling for st
+0001c040: 616e 6461 7264 2070 7974 686f 6e20 7761  andard python wa
+0001c050: 7973 2066 6f72 206e 6f77 2028 6469 7265  ys for now (dire
+0001c060: 6374 2075 7365 206f 6620 6275 7474 6572  ct use of butter
+0001c070: 290a 0a20 2020 2020 2020 2023 206e 6f72  )..        # nor
+0001c080: 6d61 6c69 7a65 2074 6865 2068 6967 682d  malize the high-
+0001c090: 7061 7373 2063 7574 2d6f 6666 2066 7265  pass cut-off fre
+0001c0a0: 7175 656e 6379 2075 7369 6e67 2074 6865  quency using the
+0001c0b0: 206e 7971 7569 7374 2066 7265 7175 656e   nyquist frequen
+0001c0c0: 6379 2028 7372 6174 6520 2f20 3229 0a20  cy (srate / 2). 
+0001c0d0: 2020 2020 2020 2063 7574 5f66 7265 7120         cut_freq 
+0001c0e0: 3d20 7061 7373 5f66 7265 7120 2f20 2864  = pass_freq / (d
+0001c0f0: 6174 615f 7265 6164 6572 2e73 616d 706c  ata_reader.sampl
+0001c100: 696e 675f 7261 7465 202f 2032 290a 0a20  ing_rate / 2).. 
+0001c110: 2020 2020 2020 2023 2064 6573 6967 6e20         # design 
+0001c120: 6120 6275 7474 6572 776f 7274 6820 6669  a butterworth fi
+0001c130: 6c74 6572 2061 6e64 2067 6574 2074 6865  lter and get the
+0001c140: 2066 696c 7465 7220 636f 6566 6669 6369   filter coeffici
+0001c150: 656e 7473 2028 6e75 6d65 7261 746f 7220  ents (numerator 
+0001c160: 2f20 6465 6e6f 6d69 6e61 746f 7220 28e2  / denominator (.
+0001c170: 8098 6261 e280 9929 0a20 2020 2020 2020  ..ba...).       
+0001c180: 2068 705f 6e75 6d65 7261 746f 722c 2068   hp_numerator, h
+0001c190: 705f 6465 6e6f 6d69 6e61 746f 7220 3d20  p_denominator = 
+0001c1a0: 7369 676e 616c 2e62 7574 7465 7228 6f72  signal.butter(or
+0001c1b0: 6465 722c 2063 7574 5f66 7265 712c 2062  der, cut_freq, b
+0001c1c0: 7479 7065 3d27 6869 6768 7061 7373 272c  type='highpass',
+0001c1d0: 2061 6e61 6c6f 673d 4661 6c73 652c 206f   analog=False, o
+0001c1e0: 7574 7075 743d 2762 6127 2c20 6673 3d66  utput='ba', fs=f
+0001c1f0: 7329 0a20 2020 2020 2020 2023 2054 4f44  s).        # TOD
+0001c200: 4f3a 2074 6865 2027 6261 2720 6f72 2027  O: the 'ba' or '
+0001c210: 736f 7327 2072 6574 7572 6e65 6420 6279  sos' returned by
+0001c220: 2062 7574 7465 7220 6469 6666 6572 2066   butter differ f
+0001c230: 726f 6d20 7768 6174 206d 6174 6c61 6220  rom what matlab 
+0001c240: 6769 7665 730a 0a20 2020 2020 2020 2023  gives..        #
+0001c250: 736f 7320 3d20 7369 676e 616c 2e62 7574  sos = signal.but
+0001c260: 7465 7228 6f72 6465 722c 206e 6f72 6d61  ter(order, norma
+0001c270: 6c5f 6375 746f 6666 2c20 6274 7970 653d  l_cutoff, btype=
+0001c280: 2768 6967 6870 6173 7327 2c20 616e 616c  'highpass', anal
+0001c290: 6f67 3d46 616c 7365 2c20 6f75 7470 7574  og=False, output
+0001c2a0: 3d27 736f 7327 2c20 6673 3d66 7329 0a20  ='sos', fs=fs). 
+0001c2b0: 2020 2020 2020 2023 736f 7332 203d 205b         #sos2 = [
+0001c2c0: 5b31 2c20 2d32 2c20 312c 2031 2c20 2d31  [1, -2, 1, 1, -1
+0001c2d0: 2e39 3938 3738 3033 3735 3330 3230 3835  .998780375302085
+0001c2e0: 2c20 302e 3939 3837 3831 3131 3835 3931  , 0.998781118591
+0001c2f0: 3135 395d 5d20 2023 2074 616b 656e 2066  159]]  # taken f
+0001c300: 726f 6d20 6d61 746c 6162 0a20 2020 2020  rom matlab.     
+0001c310: 2020 2023 7072 696e 7428 736f 7329 0a0a     #print(sos)..
+0001c320: 0a20 2020 2069 6620 6c69 6e65 5f6e 6f69  .    if line_noi
+0001c330: 7365 5f72 656d 6f76 616c 2069 7320 6e6f  se_removal is no
+0001c340: 7420 4e6f 6e65 3a0a 0a20 2020 2020 2020  t None:..       
+0001c350: 2023 2064 6573 6967 6e20 6120 6e6f 7463   # design a notc
+0001c360: 6820 6669 6c74 6572 2061 6e64 2067 6574  h filter and get
+0001c370: 2074 6865 2066 696c 7465 7220 636f 6566   the filter coef
+0001c380: 6669 6369 656e 7473 2028 6e75 6d65 7261  ficients (numera
+0001c390: 746f 7220 2f20 6465 6e6f 6d69 6e61 746f  tor / denominato
+0001c3a0: 7220 28e2 8098 6261 e280 9929 0a20 2020  r (...ba...).   
+0001c3b0: 2020 2020 206c 6e72 5f6e 756d 6572 6174       lnr_numerat
+0001c3c0: 6f72 2c20 6c6e 725f 6465 6e6f 6d69 6e61  or, lnr_denomina
+0001c3d0: 746f 7220 3d20 7369 676e 616c 2e69 6972  tor = signal.iir
+0001c3e0: 6e6f 7463 6828 6c69 6e65 5f6e 6f69 7365  notch(line_noise
+0001c3f0: 5f72 656d 6f76 616c 2c20 3330 2e30 2c20  _removal, 30.0, 
+0001c400: 6461 7461 5f72 6561 6465 722e 7361 6d70  data_reader.samp
+0001c410: 6c69 6e67 5f72 6174 6529 0a0a 0a0a 2020  ling_rate)....  
+0001c420: 2020 230a 2020 2020 2320 5072 6f63 6573    #.    # Proces
+0001c430: 730a 2020 2020 230a 0a20 2020 2023 2075  s.    #..    # u
+0001c440: 6e74 696c 2061 6c6c 2063 6861 6e6e 656c  ntil all channel
+0001c450: 7320 6172 6520 6570 6f63 682d 6564 2028  s are epoch-ed (
+0001c460: 6675 6c6c 7920 7072 6f63 6573 7365 6429  fully processed)
+0001c470: 0a20 2020 2023 2073 686f 756c 6420 6265  .    # should be
+0001c480: 636f 6d65 2075 6e74 696c 2061 6c6c 2063  come until all c
+0001c490: 6861 6e6e 656c 732f 6570 6f63 6873 2061  hannels/epochs a
+0001c4a0: 7265 2066 756c 6c79 2070 726f 6365 7373  re fully process
+0001c4b0: 6564 3f0a 2020 2020 7768 696c 6520 6e6f  ed?.    while no
+0001c4c0: 7420 616c 6c28 6368 616e 6e65 6c5f 6570  t all(channel_ep
+0001c4d0: 6f63 6865 642e 7661 6c75 6573 2829 293a  oched.values()):
+0001c4e0: 0a0a 2020 2020 2020 2020 2320 6c6f 6f70  ..        # loop
+0001c4f0: 206f 7665 7220 616c 6c20 7468 6520 7265   over all the re
+0001c500: 7175 6972 6564 2063 6861 6e6e 656c 730a  quired channels.
+0001c510: 2020 2020 2020 2020 2320 4e6f 7465 3a20          # Note: 
+0001c520: 706f 7465 6e74 6961 6c6c 7920 6576 656e  potentially even
+0001c530: 206f 7665 7220 7468 6520 6f6e 6573 2074   over the ones t
+0001c540: 6861 7420 646f 206e 6f74 206e 6565 6420  hat do not need 
+0001c550: 746f 2062 6520 7265 7472 6965 7665 6420  to be retrieved 
+0001c560: 6275 7420 6172 6520 7374 696c 6c20 6e65  but are still ne
+0001c570: 6564 6564 2066 6f72 2072 652d 7265 6665  eded for re-refe
+0001c580: 7265 6e63 696e 670a 2020 2020 2020 2020  rencing.        
+0001c590: 666f 7220 6368 616e 6e65 6c20 696e 2061  for channel in a
+0001c5a0: 6c6c 5f63 6861 6e6e 656c 733a 0a0a 2020  ll_channels:..  
+0001c5b0: 2020 2020 2020 2020 2020 7061 7373 0a22            pass."
+0001c5c0: 2222 0a                                  "".
```

### Comparing `ieegprep-1.1.0/ieegprep/bids/data_structure.py` & `ieegprep-1.2.0/ieegprep/bids/data_structure.py`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/ieegprep/bids/rereferencing.py` & `ieegprep-1.2.0/ieegprep/bids/rereferencing.py`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/ieegprep/bids/sidecars.py` & `ieegprep-1.2.0/ieegprep/bids/sidecars.py`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/ieegprep/fileio/BrainVisionReader.py` & `ieegprep-1.2.0/ieegprep/fileio/BrainVisionReader.py`

 * *Files 8% similar despite different names*

```diff
@@ -16,14 +16,16 @@
 import os
 import logging
 import numpy as np
 from configparser import ConfigParser
 from .IeegDataReader import IeegDataReader
 from ieegprep.utils.misc import allocate_array
 
+DEFAULT_CHUNK_SIZE_MB = 10          # the default chunk size (in MB)
+
 
 class BrainVisionReader(IeegDataReader):
 
     bv_hdr = None                   # header
     bv_data = None                  # data (only used on preload)
 
     def __init__(self, data_path, data_preload=False):
@@ -100,23 +102,23 @@
             # return the channel data
             if ensure_own_data:
                 return self.bv_data[channel_index, :].copy()
             else:
                 return self.bv_data[channel_index, :]
 
 
-    def retrieve_sample_range_data(self, channels, sample_start, sample_end, ensure_own_data=True):
+    def retrieve_sample_range_data(self, sample_start, sample_end, channels=None, ensure_own_data=True):
         """
         Retrieve a specific range of BrainVision data for the requested channels
 
         Args:
-            channels (str, list or tuple):  The channel(s) for which to retrieve the data.
-                                            If empty, all channels will be retrieved
             sample_start (int):             The start-point in time (in samples) to start reading from (0-based)
             sample_end (int):               The sample to end the reading at (0-based)
+            channels (str, list or tuple):  The channel(s) for which to retrieve the data.
+                                            If empty, all channels will be retrieved
             ensure_own_data (bool):         Should ensure the return a numpy array has it's own data (is not a view)
 
         Returns:
             data                            A float data matrix containing the signal data (of the requested channels)
                                             formatted as <channels> x <samples/time>
 
         Raises:
@@ -406,15 +408,15 @@
         # TODO: more information like annotations, coordinates etc
 
         # return the header information
         return hdr
 
 
     @staticmethod
-    def bv_read_data(filepath, hdr=None, channels=None, start_sample=0, end_sample=-1, unit='uV', use_memmap=True, chunked_read=False) -> tuple:
+    def bv_read_data(filepath, hdr=None, channels=None, start_sample=0, end_sample=-1, unit='uV', use_memmap=False, chunked_read=True):
         """
         Read data from a BrainVision (.eeg) file
 
         Args:
             filepath (str):                 The path to the BrainVision data file
             hdr (dict):                     Optionally pass the header dictionary as provided by 'bv_read_header'. If this
                                             argument is not set, the header file will be parsed before retrieving the data.
@@ -445,17 +447,18 @@
             unit (str):                     The unit in which the data should be return ('uV' returns microVolts, 'mV' returns
                                             microVolts and 'V' returns Volts)
             use_memmap (bool):              Whether to use numpy's memmap (which wraps around mmap) while reading the data.
                                             If true, the data file is first loaded/cached into virtual memory (pagefile) to
                                             speed up (repetitive) reading. If false, the standard system read operations
                                             will be used (slightly slower for repetitive reading from the file but does not
                                             explicitly require virtual memory).
-            chunked_read (bool):            Whether to read or transfer the data in chunks. If true, then reads from
-                                            disk (stdIO) or transfers from virtual memory (memmap) are split up in xxMB
-                                            chunks. If false, then often all data is read or transferred in one big block.
+            chunked_read (bool/int):        Whether to read or transfer data in chunks of a certain size or as one block.
+                                            If true then chunked reading is enabled (with a default size of 10MB). Passing
+                                            false, 0 or None disables chunked reading. Passing an integer of 1 or higher
+                                            will enable chunked reading in iterations of the size of that integer (in MB).
 
         Returns:
             hdr                             A dictionary with header information
             data                            A float data matrix containing the signal data (of the requested channels). When
                                             a single time-series is requested (one value as start_sample and one value as
                                             end_sample argument) then the matrix will be formatted as <channels> x <samples/time>,
                                             with the first dimension (rows) representing the channels (ordered based on
@@ -479,14 +482,31 @@
         """
 
         # check unit argument
         if unit.lower() not in ('uv', 'mv', 'v'):
             logging.error('Invalid unit ' + unit + ' to retrieve the data in. Only options are uV, mV or V')
             raise RuntimeError('Invalid unit')
 
+        # check chunked read argument
+        if chunked_read is None:
+            chunked_read = 0
+        elif isinstance(chunked_read, bool):
+            chunked_read = DEFAULT_CHUNK_SIZE_MB if chunked_read else 0
+        elif isinstance(chunked_read, int):
+            if chunked_read != 0 and chunked_read < 1:
+                logging.error('Invalid number for chunked_read argument (' + str(chunked_read) + ').\n'
+                              'Pass 0, False or None to disable chunked reading, or pass an integer with a value of 1 or higher to enable chunked reading with a specific chunk size\n'
+                              'Default is chunking enabled with a size of ' + str(DEFAULT_CHUNK_SIZE_MB) + ' MB\n\n')
+                raise TypeError('Invalid chunked_read argument')
+        else:
+            logging.error('Unknown chunked_read argument.\n'
+                          'Pass 0, False or None to disable chunked reading, or pass an integer with a value of 1 or higher to enable chunked reading with a specific chunk size.\n'
+                          'Default is chunking enabled with a size of ' + str(DEFAULT_CHUNK_SIZE_MB) + ' MB\n\n')
+            raise TypeError('Invalid chunked_read argument')
+
         # check file existence
         if not os.path.exists(filepath):
             logging.error('Data file \'' + filepath + '\' could not be found')
             raise FileNotFoundError('No such file or directory: \'' + filepath + '\'')
 
         # check whether to load the header
         if hdr is None:
@@ -634,35 +654,35 @@
                 #
                 # - after caching:
                 #   - chunked reading always faster than not chunked reading, and smaller chunk sizes are faster
                 #   - memmap is faster than fromfile
 
                 # prevent per sample reading (due to reading non-chunked, standard IO and picking channels) because
                 # it is notoriously slow, switch to chunked instead
-                if not chunked_read and not use_memmap and not (channel_indices == list(range(0, num_channels_in_file))):
+                if chunked_read == 0 and not use_memmap and not (channel_indices == list(range(0, num_channels_in_file))):
                     logging.warning('The current read settings (non-chunked, standard IO and picking channels will result in per sample reading, this is highly discouraged and exists for testing purposes only. Switching to chunked reading instead')
-                    chunked_read = True
+                    chunked_read = DEFAULT_CHUNK_SIZE_MB
 
                 #
-                if chunked_read:
+                if chunked_read > 0:
                     # chunked reading
                     #print('multiplexed - chunked - memmap = ' + str(use_memmap))
 
                     if use_memmap:
                         amem = np.memmap(data_file, dtype=sample_type, mode='r', offset=0, order='C')
                     else:
                         try:
                             fid_data = open(data_file, "rb")
                         except IOError:
                             logging.error('Error while opening data file \'' + data_file + '\'')
                             raise IOError('Error while opening data file')
 
                     # determine the size (in samples) chucks assuming ~10mb per read
                     # rounded down to the number of channels
-                    chunk_size = ((int(10e6) // sample_size) // num_channels_in_file) * num_channels_in_file
+                    chunk_size = ((int(chunked_read * 1e6) // sample_size) // num_channels_in_file) * num_channels_in_file
                     assert (chunk_size != 0)
 
                     def read_binary_chunked(rb_chunk_size, rb_range_index, rb_start, rb_length):
 
                         # determine where to start reading from
                         if not use_memmap:
                             fid_data.seek(rb_start * num_channels_in_file * sample_size, os.SEEK_SET)
@@ -837,21 +857,21 @@
                 else:
                     try:
                         fid_data = open(data_file, "rb")
                     except IOError:
                         logging.error('Error while opening data file \'' + data_file + '\'')
                         raise IOError('Error while opening data file')
 
-                if chunked_read:
+                if chunked_read > 0:
                     # chunked reading
                     #print('vectorized - chunked - memmap = ' + str(use_memmap))
 
                     # determine the size (in samples) chucks assuming ~10mb per read
                     # rounded down to the number of channels (also here because than we ensure that we assign in chunks as a multiple of the channel dimension)
-                    chunk_size = ((int(10e6) // sample_size))
+                    chunk_size = (int(chunked_read * 1e6) // sample_size)
                     assert(chunk_size != 0)
 
                     # read function
                     def read_binary_chunked(rb_chunk_size, rb_range_index, rb_start, rb_length):
 
                         # Note: reading each channel in chunks (since there is no guarantee that the requested channels are consecutive)
                         #       the chunk can be shortened depending on the number of samples in the channel or the requested range
```

### Comparing `ieegprep-1.1.0/ieegprep/fileio/EdfReader.py` & `ieegprep-1.2.0/ieegprep/fileio/EdfReader.py`

 * *Files 4% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 """
 Functions to read European Data Format (EDF) files
 
 
 =====================================================
-Copyright 2022, Max van den Boom (Multimodal Neuroimaging Lab, Mayo Clinic, Rochester MN)
+Copyright 2023, Max van den Boom (Multimodal Neuroimaging Lab, Mayo Clinic, Rochester MN)
 
 Adapted from Fieldtrip (by Robert Robert Oostenveld) while replicating some additional header logic from the MNE
 package (Teon Brooks, Martin Billinger, Nicolas Barascud, Stefan Appelhoff, Joan Massich, Clemens Brunner, Jeroen Van Der Donckt)
 
 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 You should have received a copy of the GNU General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.
@@ -15,14 +15,16 @@
 import sys
 import os
 import math
 import logging
 import numpy as np
 from .IeegDataReader import IeegDataReader
 
+DEFAULT_CHUNK_SIZE_MB = 10          # the default chunk size (in MB)
+
 
 class EdfReader(IeegDataReader):
 
     edf_hdr = None                   # EDF header
     edf_data = None                  # EDF data (only used on preload)
 
     def __init__(self, data_path, data_preload=False):
@@ -97,23 +99,23 @@
             # return the channel data
             if ensure_own_data:
                 return self.edf_data[channel_index, :].copy()
             else:
                 return self.edf_data[channel_index, :]
 
 
-    def retrieve_sample_range_data(self, channels, sample_start, sample_end, ensure_own_data=True):
+    def retrieve_sample_range_data(self, sample_start, sample_end, channels=None, ensure_own_data=True):
         """
         Retrieve a specific range of EDF data for the requested channels
 
         Args:
-            channels (str, list or tuple):  The channel(s) for which to retrieve the data.
-                                            If empty, all channels will be retrieved
             sample_start (int):             The start-point in time (in samples) to start reading from (0-based)
             sample_end (int):               The sample to end the reading at (0-based)
+            channels (str, list or tuple):  The channel(s) for which to retrieve the data.
+                                            If empty, all channels will be retrieved
             ensure_own_data (bool):         Should ensure the return a numpy array has it's own data (is not a view)
 
         Returns:
             data                            A float data matrix containing the signal data (of the requested channels)
                                             formatted as <channels> x <samples/time>
 
         Raises:
@@ -432,15 +434,15 @@
             logging.error('Multiple channels have different sampling rates, please provide which channels to retrieve (with the same sampling rate')
             raise RuntimeError('Multiple channels have different sampling rates')
 
         return channel_names, channel_indices
 
 
     @staticmethod
-    def edf_read_data(filepath, hdr=None, channels=None, start_sample=0, end_sample=-1, unit='uV', use_memmap=True, chunked_read=True):
+    def edf_read_data(filepath, hdr=None, channels=None, start_sample=0, end_sample=-1, unit='uV', use_memmap=False, chunked_read=True):
         """
         Read data from a European Data Format (.edf) file
 
         Args:
             filepath (str):                 The path to the EDF file
             hdr (dict):                     Optionally pass the header dictionary as provided by 'edf_read_header'. If this
                                             argument is not set, the header file will be parsed before retrieving the data.
@@ -470,15 +472,19 @@
                                             of values represents the latest sample of the time-series (as indicated by the header)
             unit (str):                     The unit in which the data should be return ('uV' returns microVolts, 'mV' returns
                                             microVolts and 'V' returns Volts)
             use_memmap (bool):              Whether to use numpy's memmap (which wraps around mmap) while reading the data.
                                             If true, the data file is first loaded/cached into virtual memory (pagefile) to
                                             speed up (repetitive) reading. If false, the standard system read operations
                                             will be used (slightly slower for repetitive reading from the file but does not
-                                            explicitly require virtual memory).
+                                            explicitly invoke virtual memory).
+            chunked_read (bool/int):        Whether to read or transfer data in chunks of a certain size or as one block.
+                                            If true then chunked reading is enabled (with a default size of 10MB). Passing
+                                            false, 0 or None disables chunked reading. Passing an integer of 1 or higher
+                                            will enable chunked reading in iterations of the size of that integer (in MB).
 
         Returns:
             hdr                             A dictionary with header information
             data                            A float data matrix containing the signal data (of the requested channels). When
                                             a single time-series is requested (one value as start_sample and one value as
                                             end_sample argument) then the matrix will be formatted as <channels> x <samples/time>,
                                             with the first dimension (rows) representing the channels (ordered based on
@@ -501,15 +507,32 @@
             hdr, data = edf_read_data('~/dataset.edf', start_sample=1000, end_sample=2000)
             hdr, data = edf_read_data('~/dataset.edf', start_sample=(1000, 6000), end_sample=(2000, 7000))
         """
 
         # check unit argument
         if unit.lower() not in ('uv', 'mv', 'v'):
             logging.error('Invalid unit ' + unit + ' to retrieve the data in. Only options are uV, mV or V')
-            raise RuntimeError('Invalid unit')
+            raise TypeError('Invalid unit')
+
+        # check chunked read argument
+        if chunked_read is None:
+            chunked_read = 0
+        elif isinstance(chunked_read, bool):
+            chunked_read = DEFAULT_CHUNK_SIZE_MB if chunked_read else 0
+        elif isinstance(chunked_read, int):
+            if chunked_read != 0 and chunked_read < 1:
+                logging.error('Invalid number for chunked_read argument (' + str(chunked_read) + ').\n'
+                              'Pass 0, False or None to disable chunked reading, or pass an integer with a value of 1 or higher to enable chunked reading with a specific chunk size\n'
+                              'Default is chunking enabled with a size of ' + str(DEFAULT_CHUNK_SIZE_MB) + ' MB\n\n')
+                raise TypeError('Invalid chunked_read argument')
+        else:
+            logging.error('Unknown chunked_read argument.\n'
+                          'Pass 0, False or None to disable chunked reading, or pass an integer with a value of 1 or higher to enable chunked reading with a specific chunk size.\n'
+                          'Default is chunking enabled with a size of ' + str(DEFAULT_CHUNK_SIZE_MB) + ' MB\n\n')
+            raise TypeError('Invalid chunked_read argument')
 
         # check file existence
         if not os.path.exists(filepath):
             logging.error('Data file \'' + filepath + '\' could not be found')
             raise FileNotFoundError('No such file or directory: \'' + filepath + '\'')
 
         # check whether to load the header
@@ -528,14 +551,16 @@
 
         # check whether there are samples
         if hdr['number_of_samples'] == 0:
             logging.error('no samples in the data file according to the header')
             raise RuntimeError('no samples in the data')
 
 
+
+
         #
         # check/prepare channel input(s)
         #
 
         if isinstance(channels, str):
             channels = (channels,)
 
@@ -620,41 +645,47 @@
         # determine the sample length
         range_length = output_dimensions[1]
 
         # int16 data could be cast to float32 (using less memory than a float64) but EDF will very often
         # have an offset, cal or unit gain value. So default to float64 to accommodate more precision
         data = np.empty(output_dimensions, dtype=np.float64)
 
-        # determine whether to read chunked
+
+        #TODO: test whether this holds true for multiple OSs/versions
         #if use_memmap:
-        #    chunked_read = True
+        #    chunked_read = 10
         #else:
             # Note: the consideration here depends on how the number of channels to be retrieved compares to the
             #       number of channels (in a record), see tipping point 4/149 and 10/149 channel benchmark.
             #       More testing is needed. However, often just a single channel is loaded, in this case non-chunked
             #       is faster; else wise chunked read.
+            #if len(channel_indices) == 1:
+            #    chunked_read = 0
+            #else:
+            #    chunked_read = 10
         #    chunked_read = len(channel_indices) != 1
 
+
         #
-        if chunked_read:
+        if chunked_read > 0:
             # chunked reading
             #print('chunked - memmap = ' + str(use_memmap))
 
             if use_memmap:
                 amem = np.memmap(filepath, dtype="<i2", mode='r', offset=hdr['header_length'], order='C')
             else:
                 try:
                     fid_data = open(filepath, "rb")
                 except IOError:
                     logging.error('Error while opening data file \'' + filepath + '\'')
                     raise IOError('Error while opening data file')
 
-            # determine how many record there are in each chunk (samplesize is 2 bytes for EDF), assuming chunks of ~10mb
-            # rounded down to the number of channels
-            record_chunk_size = ((int(10e6) // 2) // hdr['recordblock_length_in_samples'])
+            # determine how many record there are in each chunk (samplesize is 2 bytes for EDF), assuming
+            # chunks of <chunked_read>MB rounded down to the number of channels
+            record_chunk_size = ((int(chunked_read * 1e6) // 2) // hdr['recordblock_length_in_samples'])
             if record_chunk_size < 1:
                 record_chunk_size = 1
 
             # define read function for reading binary in chunks
             def read_binary_chunked(rb_range_index, rb_start, rb_length):
 
                 # determine
```

### Comparing `ieegprep-1.1.0/ieegprep/fileio/IeegDataReader.py` & `ieegprep-1.2.0/ieegprep/fileio/IeegDataReader.py`

 * *Files 0% similar despite different names*

```diff
@@ -62,15 +62,15 @@
     @abstractmethod
     def close(self): pass
 
     @abstractmethod
     def retrieve_channel_data(self, channel_name, ensure_own_data=True): pass
 
     @abstractmethod
-    def retrieve_sample_range_data(self, channels, sample_start, sample_end, ensure_own_data=True): pass
+    def retrieve_sample_range_data(self, sample_start, sample_end, channels=None, ensure_own_data=True): pass
 
     @staticmethod
     def check_sample_arguments(start_sample, end_sample, number_of_samples, number_of_channels):
         """
         Helper function to check the start_sample and end_sample arguments
 
         Args:
```

### Comparing `ieegprep-1.1.0/ieegprep/fileio/Mef3Reader.py` & `ieegprep-1.2.0/ieegprep/fileio/Mef3Reader.py`

 * *Files 0% similar despite different names*

```diff
@@ -147,23 +147,23 @@
             # return the channel data
             if ensure_own_data:
                 return self.mef_data[channel_index].copy()
             else:
                 return self.mef_data[channel_index]
 
 
-    def retrieve_sample_range_data(self, channels, sample_start, sample_end, ensure_own_data=True):
+    def retrieve_sample_range_data(self, sample_start, sample_end, channels=None, ensure_own_data=True):
         """
         Retrieve a specific range of MEF3 data for the requested channels
 
         Args:
-            channels (str, list or tuple):  The channel(s) for which to retrieve the data.
-                                            If empty, all channels will be retrieved
             sample_start (int):             The start-point in time (in samples) to start reading from (0-based)
             sample_end (int):               The sample to end the reading at (0-based)
+            channels (str, list or tuple):  The channel(s) for which to retrieve the data.
+                                            If empty, all channels will be retrieved
             ensure_own_data (bool):         Should ensure the return a numpy array has it's own data (is not a view)
 
         Returns:
             data                            A float data matrix containing the signal data (of the requested channels)
                                             formatted as <channels> x <samples/time>
 
         Raises:
@@ -209,17 +209,17 @@
 
             # create a list with the numpy arrays
             sample_data = [None] * len(channels)
 
             # loop over the channels to retrieve
             for counter in range(len(channels)):
 
-                # retrieve the index of the channel
+                # retrieve the index by channel name
                 try:
-                    channel_index = IeegDataReader.__retrieve_channel_metadata_mef(self.mef_session, self.channel_names.index(channels[counter]))
+                    channel_index = self.channel_names.index(channels[counter])
                 except ValueError:
                     raise LookupError('Could not find channel')
 
                 # pick the slice
                 if ensure_own_data:
                     sample_data[counter] = self.mef_data[channel_index][sample_start:sample_end].copy()
                 else:
```

### Comparing `ieegprep-1.1.0/ieegprep/utils/console.py` & `ieegprep-1.2.0/ieegprep/utils/console.py`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/ieegprep/utils/misc.py` & `ieegprep-1.2.0/ieegprep/utils/misc.py`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/ieegprep.egg-info/PKG-INFO` & `ieegprep-1.2.0/ieegprep.egg-info/PKG-INFO`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: ieegprep
-Version: 1.1.0
+Version: 1.2.0
 Summary: A package to read and pre-process Intracranial Electroencephalography (iEEG) data that is structured according to the Brain Imaging Data Structure (BIDS)
 Author-email: Max van den Boom <m.a.vandenboom84@gmail.com>
 License: GPLv3
 Project-URL: homepage, https://github.com/MultimodalNeuroimagingLab/ieegprep
 Project-URL: documentation, https://github.com/MultimodalNeuroimagingLab/ieegprep
 Project-URL: repository, https://github.com/MultimodalNeuroimagingLab/ieegprep
 Keywords: intracranial,electroencephalography,ieeg,BIDS
```

### Comparing `ieegprep-1.1.0/ieegprep.egg-info/SOURCES.txt` & `ieegprep-1.2.0/ieegprep.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/pyproject.toml` & `ieegprep-1.2.0/pyproject.toml`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/tests/test_epoch_by_channels_bv_perf.py` & `ieegprep-1.2.0/tests/test_epoch_by_channels_bv_perf.py`

 * *Files identical despite different names*

### Comparing `ieegprep-1.1.0/tests/test_fileio_bv_data.py` & `ieegprep-1.2.0/tests/test_fileio_bv_data.py`

 * *Files 0% similar despite different names*

```diff
@@ -16,14 +16,15 @@
 =====================================================
 Copyright 2023, Max van den Boom (Multimodal Neuroimaging Lab, Mayo Clinic, Rochester MN)
 
 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 You should have received a copy of the GNU General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.
 """
+import os
 import unittest
 from ieegprep.utils.console import ConsoleColors
 
 
 class TestFileIOBVData(unittest.TestCase):
     """
     Validate the BrainVision reader output values against the Matlab (fieldtrip) and MNE reader output values
```

### Comparing `ieegprep-1.1.0/tests/test_fileio_bv_perf.py` & `ieegprep-1.2.0/tests/test_fileio_bv_perf.py`

 * *Files 0% similar despite different names*

```diff
@@ -14,14 +14,15 @@
 =====================================================
 Copyright 2023, Max van den Boom (Multimodal Neuroimaging Lab, Mayo Clinic, Rochester MN)
 
 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 You should have received a copy of the GNU General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.
 """
+import os
 import unittest
 import pickle
 import numpy as np
 from datetime import datetime
 from ieegprep.utils.console import ConsoleColors
 from ieegprep.utils.misc import clear_virtual_cache
 from ieegprep.fileio.BrainVisionReader import BrainVisionReader
```

### Comparing `ieegprep-1.1.0/tests/test_fileio_edf_data.py` & `ieegprep-1.2.0/tests/test_fileio_edf_data.py`

 * *Files 0% similar despite different names*

```diff
@@ -16,14 +16,15 @@
 =====================================================
 Copyright 2023, Max van den Boom (Multimodal Neuroimaging Lab, Mayo Clinic, Rochester MN)
 
 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 You should have received a copy of the GNU General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.
 """
+import os
 import unittest
 from ieegprep.utils.console import ConsoleColors
 
 
 class TestFileIOEDFData(unittest.TestCase):
     """
     Validate the EDF (European Data Format) reader output values against the Matlab (fieldtrip) and MNE reader output values
```

### Comparing `ieegprep-1.1.0/tests/test_fileio_edf_perf.py` & `ieegprep-1.2.0/tests/test_fileio_edf_perf.py`

 * *Files 0% similar despite different names*

```diff
@@ -14,14 +14,15 @@
 =====================================================
 Copyright 2023, Max van den Boom (Multimodal Neuroimaging Lab, Mayo Clinic, Rochester MN)
 
 This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
 This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 You should have received a copy of the GNU General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.
 """
+import os
 import unittest
 import pickle
 import numpy as np
 from datetime import datetime
 from ieegprep.utils.console import ConsoleColors
 from ieegprep.utils.misc import clear_virtual_cache
 from ieegprep.fileio.EdfReader import EdfReader
```

